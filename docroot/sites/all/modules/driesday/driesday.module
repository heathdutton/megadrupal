<?php

/**
 * @file
 * Celebrate Driesday on your site.
 *
 * Implements a block that will display a special message
 * on November 19th of any year.
 */

// Dries Buytaert's birthday.
define('DRIESDAY', '11-19');
define('DRIESDAY_PLEDGE_URL', 'http://topshelfmodules.com/Dries-Day-Pledge');

/**
 * Implements hook_block_info().
 */
function driesday_block_info() {
  $blocks['dries'] = array(
    'info' => 'Driesday',
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function driesday_block_view($delta = '') {
  if ($delta == 'dries') {
    $block['subject'] = date('n-j') == DRIESDAY ? t('Merry Driesday!') : t("It's coming...");
    $block['content'] = theme('driesday_get_dries');
    return $block;
  }
}

/**
 * Implements hook_block_configure().
 */
function driesday_block_configure($delta = '') {
  if ($delta == 'dries') {
    $form['driesday_show_pledge'] = array(
      '#type' => 'checkbox',
      '#title' => t('Display a link to the <a href="!url">Driesday pledge form</a> on topshelfmodules.com',
        array('!url' => DRIESDAY_PLEDGE_URL)),
      '#default_value' => variable_get('driesday_show_pledge', TRUE),
    );
  }
  return $form;
}

/**
 * Implements hook_block_save().
 */
function driesday_block_save($delta = '', $edit = array()) {
  if ($delta == 'dries') {
    variable_set('driesday_show_pledge', $edit['driesday_show_pledge']);
  }
}

/**
 * Implements hook_theme().
 */
function driesday_theme($existing, $type, $theme, $path) {
  return array('driesday_get_dries' => array('arguments' => array()));
}

/**
 * Callback for Driesday block content.
 */
function theme_driesday_get_dries() {
  $output = theme('image', array(
    'path' => drupal_get_path('module', 'driesday') . '/dries.jpg',
    'title' => t('Dries Buytaert'),
    'alt' => t('Picture of Dries Buytaert'),
  ));

  $output .= t('November 19 is International Driesday!') . ' ';

  $output .= t('Celebrate by <a href="!url">helping Drupal</a> become better.', array('!url' => 'http://drupal.org/community-initiatives'));

  if (variable_get('driesday_show_pledge', TRUE)) {
    $output .= ' ' . l(t('Pledge to Participate!'), DRIESDAY_PLEDGE_URL);
  }

  return $output;
}
