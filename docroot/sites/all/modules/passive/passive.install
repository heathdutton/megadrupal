<?php

/**
 * Implements hook_schema().
 */
function passive_schema() {
  $tables['passive_queue'] = array(
    'description' => 'Passive request queue.',
    'fields' => array(
      // Renamed from 'index'.
      'item_index' => array(
        'description' => 'The request unique index.',
        'type' => 'varchar',
        'length' => 255,
        'not null' => TRUE,
      ),
      'created' => array(
        'description' => 'The Unix timestamp when the node was created.',
        'type' => 'int',
        'not null' => TRUE,
        'default' => 0,
      ),
      'request' => array(
        'description' => 'The request object.',
        'type' => 'blob',
        'not null' => TRUE,
        'serialize' => TRUE,
      ),
    ),
    'primary key' => array('item_index'),
  );
  return $tables;
}

/**
 * Implements hook_install().
 */
function passive_install() {
  variable_set('passive_queue_runtime', 900);

  // Initialize salt variables for dynamically setting.
  variable_set('passive_signature_salt', '');
  variable_set('passive_signature_salt_updated', 0);
}

/**
 * Implements hook_uninstall().
 */
function passive_uninstall() {
  variable_del('passive_queue_runtime');
  variable_del('passive_signature_salt');
  variable_del('passive_signature_salt_updated');
}

/**
 * Creates queue table.
 */
function passive_update_7001() {
  $schema = passive_schema();
  db_create_table('passive_queue', $schema['passive_queue']);
}

/**
 * Renames queued request index column.
 */
function passive_update_7002() {
  $schema = passive_schema();
  if (db_field_exists('passive_queue', '"index"')) {
    // Rename the 'index' column to a non-reserved name, then db_change_field().
    db_drop_primary_key('passive_queue');
    try {
      db_query('ALTER TABLE {passive_queue} RENAME COLUMN "index" TO "index2"');
    }
    catch (PDOException $ex) {
      db_query('ALTER TABLE {passive_queue} CHANGE COLUMN "index" "index2" VARCHAR(255)');
    }
    db_change_field('passive_queue', 'index2', 'item_index', $schema['passive_queue']['fields']['item_index']);
    db_add_primary_key('passive_queue', array('item_index'));
  }
}
