<?php
/**
 * @file
 * The main virtual module called ces does not have any features.
 *
 * ces.module is used as a container for the other modules and contains
 * several general purpose files.
 */

/**
 * @defgroup ices ICES
 * @{
 * The main virtual module called ces does not have any features.
 */

/**
 * Implements hook_help().
 */
function ices_help($path, $arg) {
  if ($path == 'admin/help#ices') {
    $output = '';
    $output .= '<h3>' . t('About') . '</h3>';
    $output .= '<p>' . t('Integral CES is a suite of Drupal modules featuring social currencies management for communities. See <a href="@integralces">integralces.net</a> for more documentation and <a href="@demo">demo.integralces.net</a> for a demonstration site.', array('@integralces' => 'http://www.integralces.net', '@demo' => url('http://demo.integralces.net'))) . '</p>';
    $output .= '<h3>' . t('Initializing an exchange group') . '</h3>';
    $output .= '<dl>';
    $output .= '<dt>' . t('Enable the sub-modules you need') . '</dt>';
    $output .= '<dd>' . t("<em>CES Bank</em> is needed to run Integral CES, is about management of exchange groups, users accounts, transactions between accounts, etc... <em>CES Notifications</em> is the messaging system of Integral CES. <em>CES Offers and Wants</em> allows users to publish their offers and wants in the exchange group. <em>CES user profile</em> extends Drupal user profile with fields about Integral CES. <em>CES Summary Block</em> enables a block with information about the user's account, and a switcher between accounts, if the user owns several. <em>CES exchange blog</em> enables a blog for every exchange group and the exchange administrator can publish entries. <em>CES Statistics</em> produces some statistics of the exchange groups.") . '</dd>';
    $output .= '<dt>' . t('Create new exchange group') . '</dt>';
    $output .= '<dd>' . t('Visit <a href="@newexchange">new exchange form</a> and initialize the first exchange group. You must fill in the Administrator section with the user that will be the exchange administrator (It cannot be the current drupal admin).', array('@newexchange' => url('ces/bank/exchange/new'))) . '<br />';
    $output .= t('Visit <a href="@activateexchange">admin exchanges page</a>, click on the new exchange and activate it.', array('@activateexchange' => url('ces/admin/ces'))) . '<br />';
    $output .= t('Login as exchange administrator and write some welcome blog posts.', array('@activateexchange' => url('ces/admin/ces'))) . '</dd>';

    $output .= '<dt>' . t('Invite the users to create an account') . '</dt>';
    $output .= '<dd>' . t('Users can sing up and create a new account visiting <em>user/register/exchange_name</em>, where exchange_name is the short name of the new exchange group (Four numbers or uppercase letters)') . '</dd>';
    $output .= '</dl>';
    $output .= '<dt>' . t('Publish some offers and wants, blog entries... And have fun!') . '</dt>';
    return $output;
  }
}


/**
 * Implements template_preprocess_page().
 */
function ices_preprocess_page(&$variables, $hook) {
  if (!module_exists('ces_bank')) {
    drupal_set_message(t('Module CES Bank required'), 'error');
    return;
  }
  global $user;
  require_once drupal_get_path('module', 'ces_bank') . '/ces_bank.module';
  $variables['account'] = ces_bank_get_current_account();
  if ($variables['account'] !== FALSE) {
    $exchange = ces_bank_get_current_exchange();
    $variables['site_name'] = $exchange['name'];
    $variables['site_slogan'] = t('Integral Community Exchange System');
    $items = field_get_items('user', $user, 'ces_firstname');
    $userfullname = '';
    if (!empty($items)) {
      $item = reset($items);
      $userfullname = $item['safe_value'] . ' ';
    }
    $items = field_get_items('user', $user, 'ces_surname');
    if (!empty($items)) {
      $item = reset($items);
      $userfullname .= $item['safe_value'];
    }
    if (!empty($userfullname)) {
      $user->name = $userfullname;
    }
  }
  else {
    $variables['site_name'] = variable_get('site_name');
    $variables['site_slogan'] = variable_get('site_slogan');
  }
  if ($variables['is_front']) {
    $variables['title'] = '';
  }
}
/** @} */
