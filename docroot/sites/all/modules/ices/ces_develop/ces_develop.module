<?php
/**
 * @file
 * Implements the drupal hooks for this module.
 */

include_once DRUPAL_ROOT . '/includes/install.inc';
require_once drupal_get_path('module', 'ces_bank') . '/ces_bank.install';
require_once drupal_get_path('module', 'ces_offerswants') . '/ces_offerswants.module';
/**
 * Implements hook_menu().
 */
function ces_develop_menu() {
  $menu['ces/develop/script/%'] = array(
    'title' => 'Run script',
    'description' => 'Run script',
    'page callback' => 'ces_develop_run_script',
    'page arguments' => array(3),
    'access callback' => 'user_access',
    'access arguments' => array('administer users'),
  );
  return $menu;
}
/**
 * Run the given script.
 */
function ces_develop_run_script($file) {
  $path = drupal_get_path('module', 'ces_develop');
  ob_start();
  include $path . '/' . $file . '.php';
  $output = ob_get_clean();
  return $output;
}

/**
 * Utility functions
 */

/**
 * Create a blog post.
 */
function ces_develop_post_blog($subject, $body, $exchange, $user) {
  $node = new stdClass();
  $node->title = $subject;
  $node->type = 'ces_blog';
  node_object_prepare($node);
  $node->language = LANGUAGE_NONE;
  $node->uid = $user->uid;
  $node->status = 1;
  $node->promote = 0;
  $node->comment = 2;
  $node->ces_blog_exchange[LANGUAGE_NONE][0]['value'] = $exchange['id'];
  $node->body[LANGUAGE_NONE][0] = array(
    'summary' => '',
    'value' => $body,
    'format' => 'filtered_html',
  );
  $node = node_submit($node);
  node_save($node);
}

/**
 * Clean drupal and reinstall ces module.
 */
function ces_develop_clean() {
  // Reset users.
  $query = db_query('SELECT uid FROM {users}');
  $users = $query->fetchAllAssoc('uid');
  foreach ($users as $user) {
    if (((int) ($user->uid)) > 1) {
      user_delete($user->uid);
    }
  }
  $query = db_query('SELECT nid FROM {node} WHERE type = \'ces_blog\'');
  $posts = $query->fetchAllAssoc('nid');
  foreach ($posts as $post) {
    node_delete($post->nid);
  }
  // Reset CES.
  db_delete('ces_account')->execute();
  db_delete('ces_accountuser')->execute();
  db_delete('ces_exchange')->execute();
  db_delete('ces_limit')->execute();
  db_delete('ces_limitchain')->execute();
  db_delete('ces_message')->execute();
  db_delete('ces_permission')->execute();
  db_delete('ces_transaction')->execute();
  if (db_table_exists('ces_offerwant')) {
    db_delete('ces_offerwant')->execute();
  }
  if (db_table_exists('ces_category')) {
    db_delete('ces_category')->execute();
  }
  ces_bank_install();
}
/**
 * Create new user.
 */
function ces_develop_register_user($name) {
  // Register a new user.
  if (!user_load_by_name($name)) {
    $form_state = array();
    $form_state['values']['name'] = $name;
    $form_state['values']['mail'] = strtolower($name) . '@integralces.net';
    $form_state['values']['pass']['pass1'] = 'integralces';
    $form_state['values']['pass']['pass2'] = 'integralces';
    $form_state['values']['ces_firstname'][LANGUAGE_NONE][0]['value'] = $name;
    $form_state['values']['ces_town'][LANGUAGE_NONE][0]['value'] = 'Somewhere';
    $form_state['values']['ces_postcode'][LANGUAGE_NONE][0]['value'] = '12345';
    $form_state['values']['ces_phonemobile'][LANGUAGE_NONE]['0']['value'] = '123456789';
    $form_state['values']['op'] = t('Create new account');
    drupal_form_submit('user_register_form', $form_state);
  }
  return user_load_by_name($name);
}
/**
 * Create new bank account.
 */
function ces_develop_register_account($user, $exchange, $i) {
  $bank = new CesBank();
  $limit = $bank->getDefaultLimitChain($exchange['id']);
  $account = array(
    'exchange' => $exchange['id'],
    'name' => $exchange['code'] . sprintf('%04d', $i),
    'limitchain' => $limit['id'],
    'kind' => CesBankLocalAccount::TYPE_INDIVIDUAL,
    'state' => CesBankLocalAccount::STATE_HIDDEN,
    'users' => array(
      array(
        'user' => $user->uid,
        'role' => CesBankAccountUser::ROLE_ACCOUNT_ADMINISTRATOR,
      ),
    ),
  );
  $bank->createAccount($account);
  $bank->activateAccount($account);
}
