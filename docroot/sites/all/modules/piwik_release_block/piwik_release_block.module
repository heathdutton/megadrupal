<?php

/**
 * @file
 * Piwik release block
 *
 * Block to show last releases for Piwik
 */

define('PIWIK_RELEASE_BLOCK_LATEST_URL', 'http://builds.piwik.org/LATEST');
define('PIWIK_RELEASE_BLOCK_LATEST_BETA_URL', 'http://builds.piwik.org/LATEST_BETA');

function piwik_release_block_theme($existing, $type, $theme, $path) {
  return array(
    'piwik_release_block' => array(
      'arguments' => array('release' => NULL),
      'template' => 'piwik-release-block',
    ),
  );
}
function piwik_release_block_block_info() {
  return array(
    'piwik_release' => array(
      'info' => t('Piwik releases'),
    ),
  );
}

function piwik_release_block_block_configure($delta = '') {
  $form = array();
  if ($delta == 'piwik_release') {
    $form['versions'] = array(
      '#type' => 'radios',
      '#title' => t('Versions to show'),
      '#default_value' => variable_get('piwik_release_block_versions', 4),
      '#options' => array(1 => t('Only stable'), 2 => t('Only beta'), 4 => t('Both')),
    );
  }
  return $form;
}

function piwik_release_block_block_save($delta = '', $edit = array()) {
  if ($delta == 'piwik_release') {
    variable_set('piwik_release_block_versions', $edit['versions']);
  }
}

function piwik_release_block_block_view($delta = '') {
  $block = array();
  if ($delta == 'piwik_release') {
    drupal_add_css(drupal_get_path('module', 'piwik_release_block') . '/piwik-release-block.css');
    $block['subject'] = t('Piwik releases');
    $block['content'] = piwik_release_block_content();
  }
  return $block;
}

/**
 * Get block content
 */
function piwik_release_block_content() {
  $data = array();
  $versions = variable_get('piwik_release_block_versions', 4);
  if ($versions == 1 || $versions == 4) {
    $http_result = drupal_http_request(PIWIK_RELEASE_BLOCK_LATEST_URL);
    if ($http_result->code == 200) {
      $data['latest'] = trim($http_result->data);
      $data['latest_date'] = _piwik_release_block_date($http_result->headers['last-modified']);
      $data['latest_link'] = l('Download Piwik ' . $data['latest'], 'http://builds.piwik.org/piwik-' . $data['latest'] . '.tar.gz');
    }
  }
  if ($versions == 2 || $versions == 4) {
    $http_result = drupal_http_request(PIWIK_RELEASE_BLOCK_LATEST_BETA_URL);
    if ($http_result->code == 200) {
      $data['latest_beta'] = trim($http_result->data);
      $data['latest_beta_date'] = _piwik_release_block_date($http_result->headers['last-modified']);
      $data['latest_beta_link'] = l('Download Piwik ' . $data['latest_beta'], 'http://builds.piwik.org/piwik-' . $data['latest_beta'] . '.tar.gz');
    }
  }
  return theme('piwik_release_block', array('release' => $data));
}

function _piwik_release_block_date($last_mod) {
  $date = date_parse_from_format("D, d M Y H:i:s", drupal_substr($last_mod, 0, -3));
  return format_date(mktime($date['hour'], $date['minute'], $date['second'], $date['month'], $date['day'], $date['year']), 'short');
}
