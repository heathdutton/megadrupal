<?php

/**
 * @file
 * Defines plugin for Argentina address.
 */

/**
 * Implements hook_ctools_plugin_directory().
 */
function addressfield_ar_ctools_plugin_directory($module, $plugin) {
  if ($module == 'addressfield') {
    return 'plugins/' . $plugin;
  }
}

/**
 * Implements hook_field_attach_presave().
 *
 * Saves the extra fields as additional data for each addressfield.
 */
function addressfield_ar_field_attach_presave($entity_type, $entity) {
  $fields = addressfield_ar_find_fields($entity_type, $entity);

  foreach ($fields as $field_name) {
    // Retrieve all field values of the given name from the entity.
    $field_items = field_get_items($entity_type, $entity, $field_name);
    $field_lang  = field_language($entity_type, $entity, $field_name);

    // Skip the field if no values given.
    if (empty($field_items)) {
      continue;
    }

    foreach ($field_items as $delta => $field_item) {
      $field =& $entity->{$field_name}[$field_lang][$delta];
      $data = isset($field['data']) ? $field['data'] : array();
      if (is_string($data)) {
        $data = unserialize($data);
      }
      $values = addressfield_ar_get_values($field);
      $data = array_merge($data, $values);
      $field['data'] = serialize($data);
      if ($values['thoroughfare_name'] && $values['thoroughfare_number']) {
        $field['thoroughfare'] = $values['thoroughfare_name'] . ' ' . $values['thoroughfare_number'];
      }
      $premise = array();
      if ($values['premise_name']) {
        $premise[] = t('@building', array('@building' => $values['premise_name']));
      }
      if ($values['premise_number']) {
        $premise[] = t('@premise_number floor', array('@premise_number' => $values['premise_number']));
      }
      if ($values['sub_premise_number']) {
        $premise[] = t('apartment @sub_premise_number', array('@sub_premise_number' => $values['sub_premise_number']));
      }
      $field['premise'] = implode(', ', $premise);
    }
  }
}

/**
 * Implements hook_field_attach_load().
 *
 * Load and set additional addressfield field values from serialized data
 * column.
 */
function addressfield_ar_field_attach_load($entity_type, $entities, $age, $options) {
  foreach ($entities as $entity) {
    $fields = addressfield_ar_find_fields($entity_type, $entity);

    foreach ($fields as $field_name) {
      // Retrieve all field values of the given name from the entity.
      $field_items = field_get_items($entity_type, $entity, $field_name);
      $field_lang  = field_language($entity_type, $entity, $field_name);

      // Skip the field if no values given.
      if (empty($field_items)) {
        continue;
      }

      foreach ($field_items as $delta => $field_item) {
        $field =& $entity->{$field_name}[$field_lang][$delta];
        $data = isset($field['data']) ? $field['data'] : array();
        if (is_string($data)) {
          $data = unserialize($data);
        }
        $defaults = addressfield_ar_get_values();
        foreach ($defaults as $subfield => $value) {
          if (empty($field[$subfield])) {
            $field[$subfield] = !empty($data[$subfield]) ? $data[$subfield] : '';
          }
        }
      }
    }
  }
}

/**
 * Get all addressfield_ar enabled addressfield instances on a given entity.
 *
 * @see addressfield_latlng_find_fields
 */
function addressfield_ar_find_fields($entity_type, $entity) {
  $addressfields = array();
  $field_infos = field_info_instances($entity_type);

  foreach ($field_infos as $fields) {
    foreach ($fields as $field_name => $field_value) {
      $field_info = field_info_field($field_name);
      if ('addressfield' === $field_info['type']) {
        $field_instance = field_info_instance($entity_type, $field_name, $entity->type);
        $format_handlers = $field_instance['widget']['settings']['format_handlers'];
        if (!empty($format_handlers['addressfield_ar'])) {
          $addressfields[$field_name] = $field_name;
        }
      }
    }
  }

  return $addressfields;
}

/**
 * Returns an array with our custom fields values.
 */
function addressfield_ar_get_values($field = array()) {
  $values = array(
    'thoroughfare_name' => NULL,
    'thoroughfare_number' => NULL,
    'premise_name' => NULL,
    'premise_number' => NULL,
    'sub_premise_number' => NULL,
  );

  foreach ($values as $key => $value) {
    if (isset($field[$key])) {
      $values[$key] = trim($field[$key]);
    }
  }

  return $values;
}
