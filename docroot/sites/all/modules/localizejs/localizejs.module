<?php

/**
 * @file
 * Drupal Module: Localizejs
 *
 * Adds the required Javascript to all your Drupal pages to use the translation
 * service of Localizejs <https://localizejs.com>
 *
 * @author: Eleonel Basili <http://drupal.org/u/eleonel>
 */

/**
 * Implements hook_help().
 */
function localizejs_help($path, $arg) {
  switch ($path) {
    case 'admin/config/system/localizejs':
      return t('<a href="@lojs_url">Localize</a> automatically detects the content on your website, loads it in to your dashboard, and provides an easy workflow for getting your content translated and deployed.', array('@lojs_url' => 'https://localizejs.com'));
  }
}

/**
 * Implements hook_permission().
 */
function localizejs_permission() {
  return array(
    'administer localizejs' => array(
      'title' => t('Administer Localizejs'),
      'description' => t('Perform maintenance tasks for localizejs'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function localizejs_menu() {
  $items['admin/config/system/localizejs'] = array(
    'title' => 'Localizejs',
    'description' => 'Configure your project key to integrate Localize js into your Drupal site.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('localizejs_admin_settings_form'),
    'access arguments' => array('administer localizejs'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'localizejs.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_page_alter() to insert JavaScript to the appropriate scope/region of the page.
 */
function localizejs_page_alter(&$page) {
  $project_key = variable_get('localizejs_account', '');

  // Build localizejs code.
  // Add localize script
  $script = '!function(a){if(!a.Localize){a.Localize={};for(var e=["translate",'
          . '"untranslate","phrase","initialize","translatePage","setLanguage",'
          . '"getLanguage","detectLanguage","getAvailableLanguages",'
          . '"untranslatePage", "bootstrap","prefetch","on","off"],t=0;'
          . 't<e.length;t++)a.Localize[e[t]]=function(){}}}(window);';
  
  // Add project key
  $script_key = "Localize.initialize({"
          . "key:'" . $project_key . "',"
          . "rememberLanguage: true});";
  
  drupal_add_js('https://cdn.localizejs.com/localize.js', 'external');
  drupal_add_js($script, array('scope' => 'header', 'type' => 'inline'));
  drupal_add_js($script_key, array('scope' => 'header', 'type' => 'inline'));
}
