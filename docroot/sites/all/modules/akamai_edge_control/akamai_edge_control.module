<?php
/**
 * @file
 * Modules hooks for the akamai_edge_control module.
 */

/**
 * Implements hook_init().
 *
 * @see drupal_serve_page_from_cache()
 * @see akamai_edge_control_install()
 */
function akamai_edge_control_init() {

  if (drupal_page_is_cacheable() || _akamai_edge_control_is_cachable()) {
    $max_age = !isset($_COOKIE[session_name()]) ||
      isset($hook_boot_headers['vary']) ?
      variable_get('akamai_edge_control_maximum_age', 0) : 0;

    $alter = array('max-age' => $max_age);

    drupal_alter('akamai_edge_control_max_age', $alter);

    $alter['max-age'] = 3600;

    drupal_add_http_header('Edge-control', 'public, max-age=' . $alter['max-age']);
  }
  else {
    drupal_add_http_header('Edge-control', 'no-cache, no-store');
  }

}

/**
 * Check if the current page is cachable despite a user being authenticated.
 */
function _akamai_edge_control_is_cachable() {

  global $user;

  if ($user->uid == 1) {
    return FALSE;
  }

  // @TODO: Allow for configuration of roles to ignore for Akamai caching purposes.
  if (!in_array('authenticated user', $user->roles) || count($user->roles) > 1) {
    return FALSE;
  }

  $node = menu_get_object('node');

  if ($node && arg(2) == NULL) {
    return variable_get('akamai_edge_control_auth_cache_node_' . $node->type, FALSE);
  }

  return FALSE;
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function akamai_edge_control_form_system_performance_settings_alter(&$form, &$form_state, $form_id) {
  $period = drupal_map_assoc(
    array(
      0, 60, 180, 300,
      600, 900, 1800, 2700, 3600,
      10800, 21600, 32400, 43200, 86400,
    ),
    'format_interval'
  );
  $period[0] = '<' . t('none') . '>';

  $form['akamai'] = array(
    '#type' => 'fieldset',
    '#title' => t('Caching in Akamai'),
  );

  $form['akamai']['akamai_edge_control_maximum_age'] = array(
    '#type' => 'select',
    '#title' => t('Expiration of cached pages in Akamai'),
    '#default_value' => variable_get('akamai_edge_control_maximum_age', 0),
    '#options' => $period,
    '#description' => t('The maximum time Akamai can use an old version of a page.'),
  );

  $form['akamai']['auth'] = array(
    '#type' => 'fieldset',
    '#title' => t('Caching for authenticated users in Akamai'),
    '#description' => t('Cache the full page view of certain content types in Akamai for authenticated users.'),
  );

  foreach (node_type_get_names() as $key => $value) {
    $key = 'akamai_edge_control_auth_cache_node_' . $key;

    $form['akamai']['auth'][$key] = array(
      '#type' => 'checkbox',
      '#title' => t('!type nodes full page view.', array('!type' => $value)),
      '#default_value' => variable_get($key, FALSE),
    );
  }
}
