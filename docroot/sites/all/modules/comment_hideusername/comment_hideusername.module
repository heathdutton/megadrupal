<?php

/**
 * @file
 * @brief Hide username when submitting comments
 *
 * Description: The idea is to simplify the form the user sees
 *
 * @author Sean Boran (boran), http://drupal.org/user/147185
 */

// Settings
define('COMMENTS_HIDEUSER_DEBUG', 1);          // define level 0-3 (0=none)
define('COMMENTS_HIDEUSER_DEBUGTOSCREEN', 0);  // 1=screen 0=log


// TODO: experiment with generic debug function. 
//   How could this be generic and usable from  several modules?
function __debugch($msg, $to_level=1) {
  $_moduleName_ = "comment_hideusername";
  //dsm('to_level=' .$to_level .', COMMENTS_HIDEUSER_DEBUG=' .COMMENTS_HIDEUSER_DEBUG);

  $msg = check_plain($msg);
  if ( is_int($to_level) && is_string($msg) && COMMENTS_HIDEUSER_DEBUG>=$to_level ) {
    if (COMMENTS_HIDEUSER_DEBUGTOSCREEN==1) {
      if ( module_exists('devel') ) {
        dsm("$_moduleName_ debug: " . $msg);
      }
      else {
        drupal_set_message($_moduleName_  . " debug: " . $msg);
      }
    }
    else {
      watchdog("$_moduleName_", $msg);
    }
  }
}

/**
 * hook_form_alter()
 * comments: hide user name when submitting
 */
function comment_hideusername_form_alter(&$form, &$form_state, $form_id) {
  global $user;
  __debugch("_form_alter: id=$form_id", 3);

  variable_get('comment_hideusername_hide_subject', false);
  #if ($form_id == 'comment_node_page_form') {   // page content type
  if (preg_match('/^comment_node_.*_form$/', $form_id)) { // all types
    unset($form['author']['_author']);      // hide user

    if (variable_get('comment_hideusername_hide_subject', false)==true) {
      $form['subject']['#access']=false;      // hide comment subject
    }
    //dsm($form);
  }

}
