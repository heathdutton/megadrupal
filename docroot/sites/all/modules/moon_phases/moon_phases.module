<?php

/**
 * @file
 * Displays the moon in it's current phase in a block and on a page with phase 
 * description. It also displays a calendar of the moon phases.
 */

require_once DRUPAL_ROOT . '/' . drupal_get_path( 'module', 'moon_phases' ) . '/lib/moon_phase.class.php';

/**
 * Define the Moon Phases to be displayed on the phase page.
 */
define( 'MOON_PHASE_NEW_MOON', '<p>' . t( 'What is this ghostly image? It\'s a new moon&#8230; a sort of moon that you cannot see from Earth&#8230; except during the stirring moments of a solar eclipse.' ) . '</p>
<p>' . t( 'A new moon is between the Earth and sun. If it is directly between, a solar eclipse takes place. But that doesn\'t happen every month. Instead, once each month, the moon comes all the way around in its orbit so that it is more or less between us and the sun. This is a new moon: a moon whose lighted half is facing entirely away from Earth.' ) . '</p>
<p>' . t( 'A new moon rises when the sun rises and sets when the sun sets. It crosses the sky with the sun during the day. Each new lunar cycle is measured beginning at each new moon. Astronomers call one lunar cycle a "lunation."' ) . '</p>
<cite><a href="http://www.earthsky.org/article/new-moon" target="_blank" class="small">' . t( 'Read more at EarthSky.org' ) . ' &raquo;</a></cite>' );

define( 'MOON_PHASE_WAXING_CRESCENT', '<p>' . t( 'A waxing crescent moon-sometimes called a "young moon"-is always seen in the west after sunset. At this moon phase, the Earth, moon and sun are located nearly on a line in space. If they were more precisely on a line, as they are at new moon, we wouldn\'t see the moon. The moon would travel across the sky during the day, lost in the sun\'s glare. Instead, a waxing crescent moon is seen one day to several days after new moon. It rises one hour to several hours behind the sun and follows the sun across the sky during the day. When the sun sets, and the sky darkens, the moon pops into view in the western sky.' ) . '</p>
<p>' . t( 'Because the waxing crescent moon is nearly on a line with the Earth and sun, the "day side" is facing mostly away from us. We see only a slender fraction of the day side: a crescent moon. Each evening, because the moon is moving eastward in orbit around Earth, the moon appears farther from the sunset glare. Each evening, as the moon\'s orbital motion carries it away from the Earth/sun line, we see more of the moon\'s day side. Thus the crescent in the west after sunset appears to wax, or grow fatter each evening.' ) . '</p>
<p>' . t( 'Note that a crescent moon has nothing to do with Earth\'s shadow on the moon. The only time Earth\'s shadow can fall on the moon is at full moon, during a lunar eclipse. There IS a shadow on a crescent moon, but it\'s the moon\'s OWN shadow. Night on the moon happens on the part of the moon submerged in the moon\'s own shadow. Likewise, night on Earth happens on the part of Earth submerged in Earth\'s own shadow.' ) . '</p>
<p>' . t( 'You sometimes see a pale glow on the darkened portion (night side) of a crescent moon. This glow is due to light reflected from Earth\'s day side. It\'s called "earthshine."' ) . '</p>
<cite><a href="http://www.earthsky.org/article/waxing-crescent" target="_blank" class="small">' . t( 'Read more at EarthSky.org' ) . ' &raquo;</a></cite>' );

define( 'MOON_PHASE_FIRST_QUARTER', '<p>' . t( 'A first quarter moon looks like half a pie. It rises at noon and is high overhead at sunset. It sets around midnight.' ) . '</p>
<p>' . t( 'First quarter moon comes a week after new moon. Now, as seen from above, the moon in its orbit around Earth is at right angles to a line between the Earth and sun.' ) .'</p>
<p>' . t( 'A first quarter moon is called "first quarter" because it is one quarter of the way around in its orbit of Earth, as measured from one new moon to the next. Also, although some people call this a "half moon," and although it really does appear half-lit to us, it\'s good to recall that the illuminated portion of a first quarter moon truly is just a quarter. On the night of first quarter moon, we see half the moon\'s day side, or a TRUE quarter of the moon. Another lighted quarter of the moon shines just as brightly in the direction opposite Earth!' ) . '</p>
<cite><a href="http://www.earthsky.org/article/first-quarter" target="_blank" class="small">' . t( 'Read more at EarthSky.org' ) . ' &raquo;</a></cite>' );

define( 'MOON_PHASE_WAXING_GIBBOUS', '<p>' . t( 'A waxing gibbous moon appears high in the east at sunset. It\'s nearly, but not quite, a full moon... appearing more than half lighted but less than full. This moon phase comes between one and two weeks after new moon.' ) . '</p>
<p>' . t( 'The moon has moved in its orbit so that it\'s now relatively far from the sun in our sky. A waxing gibbous moon rises during the hours between noon and sunset. It sets in the wee hours after midnight. People sometimes see a waxing gibbous moon in the afternoon, shortly after moonrise, while it\'s ascending in the east as the sun is descending in the west. It\'s easy to see a waxing gibbous moon in the daytime because, at this phase of the moon, a large fraction of the moon\'s day side is facing our way. Thus a waxing gibbous moon is more noticeable in the sky than a crescent moon, with only a slim fraction of the lunar day side visible. Also, a waxing gibbous moon is far from the sun on the sky\'s dome, so the sun\'s glare isn\'t hiding it from view.' ) . '</p>
<p>' . t( 'The word "gibbous" comes from a root word that means "hump-backed." You can see the hump-backed shape of the waxing gibbous moon.' ) . '</p>
<cite><a href="http://www.earthsky.org/article/waxing-gibbous" target="_blank" class="small">' . t( 'Read more at EarthSky.org' ) . ' &raquo;</a></cite>' );

define( 'MOON_PHASE_FULL_MOON', '<p>' . t( 'A full moon always rises in the east around the time the sun is setting in the west. At full moon, we are seeing all of the moon\'s day side. The moon and sun are on a line, with Earth in between. It\'s as though Earth is the fulcrum of a seesaw, and the moon and sun are sitting on either end of the seesaw. Thus as the sun sets in the west, the full moon rises. When the sun is below our feet at midnight, the full moon is highest in the sky. When the sun rises again at dawn, the full moon is setting.' ) . '</p>
<p>' . t( 'In many ways, a full moon is the opposite of a new moon. At both the new and full phases, the moon is on a line with the Earth and sun. At new moon, the moon is in the middle position along the line. At full moon, Earth is in the middle.</p>
<p>Full moon always comes about two weeks after new moon, when the moon is midway around in its orbit of Earth, as measured from one new moon to the next.' ) . '</p>
<p>' . t( 'If there is a lunar eclipse, it must happen at full moon. It\'s only a full moon that Earth\'s shadow, extending opposite the sun, can fall on the moon\'s face.' ) . '</p>
<cite><a href="http://www.earthsky.org/article/full-moon" target="_blank" class="small">' . t( 'Read more at EarthSky.org' ) . ' &raquo;</a></cite>' );

define( 'MOON_PHASE_WANING_GIBBOUS', '<p>' . t( 'A waning gibbous moon sails over the eastern horizon in the hours between sunset and midnight. It\'s past full now... appearing less than full but more than half lighted.' ) . '</p>
<p>' . t( 'What can I say about a waning gibbous moon? Only that it can surprise you if you happen to be out late in the evening. It rises eerily some hours after sunset, glowing redly like a full moon when it\'s near the horizon. Sometimes it looks like a misshapen clone of a full moon.' ) . '</p>
<p>' . t( 'Because it comes up late at night, the waning gibbous moon prompts people to start asking, "Where is the moon? I looked for it last night and couldn\'t find it." It also initiates a rash of questions seeing the moon during the day. If it rises late at night, you know the waning gibbous moon must set after sunrise. In fact, in the few days after full moon, you\'ll often see the waning gibbous moon in the west in early morning, floating against the pale blue sky.' ) . '</p>
<cite><a href="http://www.earthsky.org/article/waning-gibbous" target="_blank" class="small">' . t( 'Read more at EarthSky.org' ) . ' &raquo;</a></cite>' );

define( 'MOON_PHASE_LAST_QUARTER', '<p>' . t( 'Last quarter moon comes about three weeks after new moon. Now, as seen from above, the moon in its orbit around Earth is at right angles to a line between the Earth and sun. The moon is now three-quarters of the way around in its orbit of Earth, as measured from one new moon to the next.' ) . '</p>
<p>' . t( 'A last quarter moon looks half-illuminated. It rises around midnight, appears at its highest in the sky at dawn, and sets around noon. After this, the moon will begin edging noticeably closer to the sun again on the sky\'s dome. Fewer people notice the moon during the day from about last quarter on, because the sun\'s glare begins to dominate the moon.' ) . '</p>
<p>' . t( 'A last quarter moon can be used as a guidepost to Earth\'s direction of motion in orbit around the sun. In other words, when you look at a last quarter moon high in the predawn sky, you\'re gazing out approximately along the path of Earth\'s orbit, in a forward direction. The moon is moving in orbit around the sun with the Earth. But, if we could somehow anchor the moon in space... tie it down, keep it still... Earth\'s orbital speed of 18 miles per second would carry us across the space between us and the moon in only a few hours.' ) . '</p>
<cite><a href="http://www.earthsky.org/article/last-quarter" target="_blank" class="small">' . t( 'Read more at EarthSky.org' ) . ' &raquo;</a></cite>' );

define( 'MOON_PHASE_WANING_CRESCENT', '<p>' . t( 'A waning crescent moon-sometimes called an "old moon"-is seen in the east before dawn. Now the moon has moved nearly entirely around in its orbit of Earth, as measured from one new moon to the next.' ) . '</p>
<p>' . t( 'Because the moon is nearly on a line with the Earth and sun again, the "day side" of the moon is facing mostly away from us once more. We see only a slender fraction of the moon\'s day side: a crescent moon. Each morning before dawn, because the moon is moving eastward in orbit around Earth, the moon appears closer to the sunrise glare. We see less and less of the moon\'s day side, and thus the crescent in the east before dawn appears thinner each day.' ) . '</p>
<p>' . t( 'The moon, as always, is rising in the east day after day. But most people won\'t see this moon phase unless they get up early. When the sun comes up, and the sky grows brighter, the waning crescent moon fades. Now the moon is so near the Earth/sun line that the sun\'s glare is drowning this slim moon from view. Still, the waning crescent is up there, nearly all day long, moving ahead of the sun across the sky\'s dome. It sets in the west several hours or less before sunset.' ) . '</p>
<cite><a href="http://www.earthsky.org/article/waning-crescent" target="_blank" class="small">' . t( 'Read more at EarthSky.org' ) . ' &raquo;</a></cite>' );


/**
 * Implementation of hook_help()
 */
function moon_phases_help( $path, $arg ) {

  switch ( $path ) {
    case 'admin/help#moon_phases':
      return '<p>' . t( 'Moon Phases displays the current phase of the moon or the upcoming week.' ) . '</p>';
  }

} // function moon_phases_help


/**
 * Implementation of hook_block_info()
 */
function moon_phases_block_info() {

  $blocks[ 'moons' ] = array(
    'info' => t( 'Moon Phases' ),
    'cache' => DRUPAL_NO_CACHE,
  );

  return $blocks;

} // function moon_phases_block_info()


/**
 * Implementation of hook_block_configure()
 */
function moon_phases_block_configure( $delta = '' ) {
  
  $form = array();
  
  switch ( $delta ) {
    case 'moons':
      $form[ 'show_illum' ] = array(
        '#type' => 'checkbox',
        '#title' => t( 'Show illumination' ),
        '#description' => t( 'If you want to display the percentage of illumination, check this checkbox.' ),
        '#default_value' => variable_get( 'moon_phases_show_illum', NULL ),
      );
      
      $form[ 'show_cycle' ] = array(
        '#type' => 'checkbox',
        '#title' => t( 'Show days until New moon' ),
        '#description' => t( 'If you want to display the number of days until the New moon, check this checkbox.' ),
        '#default_value' => variable_get( 'moon_phases_show_cycle', NULL ),
      );
      
      return $form;
  }
  
} // function moon_phases_block_configure()


/**
 * Implementation of hook_block_save()
 */
function moon_phases_block_save( $delta = '', $edit = array() ) {
  
  switch ( $delta ) {
    case 'moons':
      variable_set( 'moon_phases_show_illum', $edit[ 'show_illum' ] );
      variable_set( 'moon_phases_show_cycle', $edit[ 'show_cycle' ] );
  }
  
} // function moon_phases_block_save()


/**
 * Implementation of hook_block_view()
 */
function moon_phases_block_view( $delta = '' ) {

  $block = array();

  switch ( $delta ) {
    case 'moons':
      $block[ 'subject' ] = t( 'Today\'s Moon Phase' );
      $block[ 'content' ] = moon_phases_create_blk();
      break;
  }

  return $block;

} // function moon_phases_block_view()


/**
 * Implementation of hook_menu()
 */
function moon_phases_menu() {

  $items = array();

  $items[ 'admin/config/content/moons' ] = array(
    'title' => 'Moon Phases',
    'description' => 'Settings page for the moon phases module',
    'page callback' => 'drupal_get_form',
    'page arguments' => array( 'moon_phases_descriptions_form' ),
    'access arguments' => array( 'administer site configuration' ),
    'file' => 'moon_phases.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );

  $items[ 'admin/config/content/moons/descriptions' ] = array(
    'title' => 'Descriptions',
    'description' => 'Configuration for moon phase descriptions',
    'page callback' => 'drupal_get_form',
    'page arguments' => array( 'moon_phases_descriptions_form' ),
    'access arguments' => array( 'administer site configuration' ),
    'file' => 'moon_phases.admin.inc',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => 1,
  );

  $items[ 'admin/config/content/moons/settings' ] = array(
    'title' => 'Settings',
    'description' => 'Settings page for the moon phases module',
    'page callback' => 'drupal_get_form',
    'page arguments' => array( 'moon_phases_admin_form' ),
    'access arguments' => array( 'administer site configuration' ),
    'file' => 'moon_phases.admin.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 2,
  );

  $items[ 'moon/phases' ] = array(
    'title' => 'Moon Phases',
    'description' => 'Display the moon phases',
    'page callback' => 'moon_phases_page',
    'access arguments' => array( 'access content' ),
    'type' => MENU_NORMAL_ITEM,
  );

  $items[ 'moon/phases/main' ] = array(
    'title' => 'Moon Phases',
    'description' => 'Display the moon phases',
    'page callback' => 'moon_phases_page',
    'access arguments' => array( 'access content' ),
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => 1
  );

  $items[ 'moon/phases/calendar' ] = array(
    'title' => 'Calendar',
    'description' => 'Display the moon phases',
    'page callback' => 'moon_phases_calendar',
    'access arguments' => array( 'access content' ),
    'type' => MENU_LOCAL_TASK,
    'weight' => 2
  );

  return $items;

} // function moon_phases_menu()


/**
 * Implementation of hook_theme()
 */
function moon_phases_theme( $existing, $type, $theme, $path ) {

  return array(
    'moon_phase_block' => array(
      'variables' => array( 
        'id' => NULL, 
        'image' => NULL, 
        'link' => NULL, 
        'illum' => NULL,
        'days' => NULL,
      ),
      'template' => 'moon_phases-block',
      'path' => drupal_get_path( 'module', 'moon_phases' ) . '/theming',
    ),
    'moon_phase_page' => array(
      'variables' => array(
        'prev' => NULL,
        'next' => NULL,
        'day' => NULL,
        'image' => NULL,
        'definition' => NULL,
        'table' => NULL,
      ),
      'template' => 'moon_phases-main',
      'path' => drupal_get_path( 'module', 'moon_phases' ) . '/theming',
    ),
    'moon_phase_calendar' => array(
      'render element' => 'moondata',
      'template' => 'moon_phases-calendar',
      'path' => drupal_get_path( 'module', 'moon_phases' ) . '/theming',
    ),
    'moon_phase-moon' => array(
      'render element' => 'moondata',
      'template' => 'moon_phases-moon',
      'path' => drupal_get_path( 'module', 'moon_phases' ) . '/theming/',
    ),
    'moon_phases_cell' => array(
      'variables' => array( 'week' => NULL, 'first' => NULL, 'class' => NULL ),
      'template' => 'moon_phases-cal-cell',
      'path' => drupal_get_path( 'module', 'moon_phases' ) . '/theming',
    ),
    'moon_phases_extra' => array(
      'variables' => array( 'to_full' => NULL, 'to_new' => NULL, 'illum' => NULL ),
      'template' => 'moon_phases-extra',
      'path' => drupal_get_path( 'module', 'moon_phases' ) . '/theming',
    ),
  );

} // function moon_phases_theme()


/**
 * Creates moon phase block with a moon phase image linked to moon phase page
 * 
 * @return 
 *    Retuns a themed block with moon and link to phase page
 */
function moon_phases_create_blk() {

  // Get moon phase data
  $dateAsTimeStamp = '';
  $moon = new moonPhase( $dateAsTimeStamp );

  // Get class - will be either day or night based on sunset/sunrise times
  $class = moon_phases_calc_sun_data();

  // Get moon phase array with css id and title
  $moon_data = moon_phases_moon_data();
  $phase = $moon->getPhaseID();
  
  $id = $moon_data[ $phase ][ 'id' ];

  $phase_type = ( $phase == 4 || $phase == 0 || $phase == 8 ) ? 'full' : NULL;
  $phase_type = ( ! $phase_type && $phase < 4 ) ? 'waxing' : 'waning';

  // Get percentage of illumination
  $illum =  $moon->getPercentOfIllumination();

  $image = moon_phases_get_image( $phase, $class, $illum );
 
  $illum .= t( ' visible' );
  
  $illum = ( variable_get( 'moon_phases_show_illum', NULL ) ) ? $illum : NULL;
  
  // Get # of days until next New moon
  $new_moon = ceil( $moon->getDaysUntilNextNewMoon() );
  $days = format_plural( $new_moon, 'day', 'days' );
  $new_moon .= ' '  . t( '%days until the next New moon', array( '%days' => $days ) );
  
  $new_moon = ( variable_get( 'moon_phases_show_cycle', NULL ) ) ? $new_moon : NULL;
  
  $link = l( $moon_data[ $phase ][ 'title' ] . '&nbsp;&raquo;', 'moon/phases', array( 'html' => TRUE ) );

  return theme( 'moon_phase_block', array( 'id' => $id, 'image' => $image, 'link' => $link, 'illum' => $illum, 'days' => $new_moon ) );

} // function moon_phases_create_blk


/**
 * Creates the moon phase page, /moon/phases
 * The page displays one days moon data; header, image and definition, days 
 * until next full moon, days until next new moon and percentage of illumination
 * 
 * @return 
 *  Returns the themed moon phase page
 */
function moon_phases_page() {

  $phase_data = array();

  // Get moon phase data
  $dateAsTimeStamp = ( isset( $_GET[ 'date' ] ) ) ? $_GET[ 'date' ] : NULL;
  $moon = new moonPhase( $dateAsTimeStamp );

  // Get moon phase array with css id and title
  $moon_data = moon_phases_moon_data();
  $phase = $moon->getPhaseID();

  $definition = moon_phases_get_definitions();
  $definition = $definition[ $phase ];

  $date = ( $dateAsTimeStamp > 0 ) ? $dateAsTimeStamp : time();
  $prev = $date - 86400;
  $next = $date + 86400;

  // Get class - will be either day or night based on sunset/sunrise times
  $class = moon_phases_calc_sun_data();

  // Get moon phase array with css id and title
  $moon_data = moon_phases_moon_data();
  $phase = $moon->getPhaseID();


  $day = format_date( $date, 'custom', 'l, F jS, Y', NULL );
  $title = $moon_data[ $phase ][ 'title' ];
  drupal_set_title( t( '!title', array( '!title' => $title ) ) );

  $type = NULL;
  $phase_type= ( $phase == 4 || $phase == 0 || $phase == 8 ) ? 'full' : NULL;
  $phase_type = ( !$phase_type && $phase < 4 ) ? 'waxing' : 'waning';


  $to_full = ceil( $moon->getDaysUntilNextFullMoon() );
  $to_full = $to_full . format_plural( $to_full, ' day', ' days' );

  $to_new = ceil( $moon->getDaysUntilNextNewMoon() );
  $to_new = $to_new . format_plural( $to_new, ' day', ' days' );

  $illum = $moon->getPercentOfIllumination();
  
  $table = theme( 'moon_phases_extra', array( 'to_full' => $to_full, 'to_new' => $to_new, 'illum' => $illum ) );

  $prev = l( '&laquo;', 'moon/phases', array( 'html' => TRUE, 'attributes' => array( 'class' => array( 'moon-prev' ) ), 'query' => array( 'date' => $prev ) ) );
  $next = l( '&raquo;', 'moon/phases', array( 'html' => TRUE, 'attributes' => array( 'class' => array( 'moon-next' ) ), 'query' => array( 'date' => $next ) ) );

  $image = moon_phases_get_image( $phase, $class, $illum );
  
  return theme( 'moon_phase_page', array( 'prev' => $prev, 'next' => $next, 'day' => $day, 'image' => $image, 'definition' => $definition, 'table' => $table,) );

} // function moon_phases_page


/**
 * Creates moon phase page /moon/phases/calendar
 * 
 * @return 
 *   Returns the themed calendar page
 */
function moon_phases_calendar() {

  $month = ( isset( $_GET[ 'month' ] ) ) ? $_GET[ 'month' ] :  date( 'n', time() );
  $year  = ( isset( $_GET[ 'year' ] ) ) ? $_GET[ 'year' ] : date( 'Y', time() );

  drupal_set_title( t( 'Moon Phases Calendar' ) );

  $end_day = date( 'j', mktime( date( 'g', time() ), date( 'i', time() ), date( 's', time() ), $month + 1, 0, $year ) );

  $week = 0;

  for ( $i = 1; $i <= $end_day; $i++ ) {
    $day_stamp = mktime( date( 'g', time() ), date( 'i', time() ), date( 's', time() ), $month, $i, $year );

    $moon = new moonPhase( $day_stamp );

    $phase_data = array();
    $phase_data[ 'class' ] = moon_phases_calc_sun_data();
    $phase_data[ 'day' ] = $i;
    $phase_data[ 'long_date' ] = date( 'l, F jS, Y', $day_stamp );

    // Get moon phase array with css id and title
    $moon_data = moon_phases_moon_data();
    $phase = $moon->getPhaseID();

    $phase_data[ 'phase_data' ] = $moon_data[ $phase ];

    $type = NULL;
    $phase_type = ( $phase == 4 || $phase == 0 || $phase == 8 ) ? 'full' : NULL;
    $phase_type = ( !$phase_type && $phase < 4 ) ? 'waxing' : 'waning';

    $illum =  $moon->getPercentOfIllumination();

    $phase_data[ 'image' ] = moon_phases_get_image( $phase, $phase_data[ 'class' ], $illum );

    /**
     * PHP date() doesn't have a means for returning the week of the year starting on Monday
     * So we needed to calculate the weeks on our own.
     * We create an array using $week as our starting point.
     * Then we check the day of the week - date( 'w', $day_stamp ) - which returns the days 0 - 6 (Sunday - Saturday)
     * We then check the modulus to see if it is the end of the week.
     * If it is we add another row to our array
     * -TC
     */
    $month_data[ $week ][ date( 'w', $day_stamp ) ] = $phase_data;
    $week = ( ( ( ( date( 'w', $day_stamp ) + 1 ) ) % 7 ) == 0 ) ? $week + 1 : $week;
  }

  $moondata[ 'calendar' ] = moon_phases_create_calendar( $month_data, $month, $year );

  return theme( 'moon_phase_calendar', array( 'moondata' => $moondata ) ) ;

} // function moon_phases_calendar


/**
 * Creates a month of moon phases
 * 
 * @return 
 *  Returns the phases of the moon for a given month in calendar format
 */
function moon_phases_create_calendar( $phase_data, $month, $year ) {

  $prev = l( '&laquo;', 'moon/phases/calendar', array( 'html' => TRUE, 'attributes' => array( 'class' => array( 'moon-prev' ) ), 'query' => array( 'month' => date( 'n', mktime( 0, 0, 0, $month, 0, $year ) ), 'year' => date( 'Y', mktime( 0, 0, 0, $month, 0, $year ) ) ) ) );
  $next = l( '&raquo;', 'moon/phases/calendar', array( 'html' => TRUE, 'attributes' => array( 'class' => array( 'moon-next' ) ), 'query' => array( 'month' => date( 'n', mktime( 0, 0, 0, $month + 1, 1, $year ) ), 'year' => date( 'Y', mktime( 0, 0, 0, $month + 1, 1, $year ) ) ) ) );

  $title = date( 'F Y', mktime( 0, 0, 0, $month, 1, $year ) );
  $class = moon_phases_calc_sun_data();
  
  $content = '<div id="moon-cal"><header id="moonav">' . $prev . $title . $next . '</header>';
  $content .= '<div class="moonclear"></div>';
  
  $content .= '<section id="cal-head"><div class="dow">';

  $days = array( 'Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', );
  $content .= implode( '</div><div class="dow">', $days );
  
  $content .= '</div></section>';


  $content .= '<section id="cal">';
  
  foreach ( $phase_data as $week ) {
      $content .= ( isset( $week[ 0 ] ) ) ? theme( 'moon_phases_cell', array( 'week' => $week[ 0 ], 'first' => 'first', 'class' => $class ) ) : '<div class="moon-cell first"></div>';
      $content .= ( isset( $week[ 1 ] ) ) ? theme( 'moon_phases_cell', array( 'week' => $week[ 1 ], 'class' => $class ) ) : '<div class="moon-cell"></div>';
      $content .= ( isset( $week[ 2 ] ) ) ? theme( 'moon_phases_cell', array( 'week' => $week[ 2 ], 'class' => $class ) ) : '<div class="moon-cell"></div>';
      $content .= ( isset( $week[ 3 ] ) ) ? theme( 'moon_phases_cell', array( 'week' => $week[ 3 ], 'class' => $class ) ) : '<div class="moon-cell"></div>';
      $content .= ( isset( $week[ 4 ] ) ) ? theme( 'moon_phases_cell', array( 'week' => $week[ 4 ], 'class' => $class ) ) : '<div class="moon-cell"></div>';
      $content .= ( isset( $week[ 5 ] ) ) ? theme( 'moon_phases_cell', array( 'week' => $week[ 5 ], 'class' => $class ) ) : '<div class="moon-cell"></div>';
      $content .= ( isset( $week[ 6 ] ) ) ? theme( 'moon_phases_cell', array( 'week' => $week[ 6 ], 'class' => $class ) ) : '<div class="moon-cell"></div>';
  }
  
  $content .= '</section></div>';

  return $content;

} // function moon_phase_create_calendar()


/**
 * Creates the moon image with mask and offset. The mask covers part of the moon
 * giving the illusion of the moon phase. The offset determines how much of the 
 * moon will show.
 * 
 * @param $phase 
 *   A string representing the phase of the moon
 * @param $class
 *   A string, either day or night
 * @param $illum
 *   A string percentage of the moon that is visible
 * 
 * @return 
 *   Returns a themed image of the moon
 */
function moon_phases_get_image( $phase, $class, $illum ) {

  switch ( $phase ) {
    // new moon
    case 0:
    case 8:
      $moondata = array(
        'left' => array(
          'image' => theme_image(
            array(
              'path' => drupal_get_path( 'module', 'moon_phases' ) . '/styles/images/' . $class . '_first_quarter.png',
              'width' => 26,
              'height' => 52,
              'alt' => 'left',
              'title' => 'New Moon',
              'attributes' => array( 'class' => 'moon-overlay' ),
            )
          ),
        ),
        'right' => array(
          'image' => theme_image(
            array(
              'path' => drupal_get_path( 'module', 'moon_phases' ) . '/styles/images/' . $class . '_last_quarter.png',
              'width' => 26,
              'height' => 52,
              'alt' => 'right',
              'title' => 'New Moon',
              'attributes' => array( 'class' => 'moon-overlay', ),
            )
          )
        )
      );
      break;

    // waxing crescent
    case 1:
      $offset = $illum / 2;
      $left = 26;
      $right = 26 - $offset;
      $right = ( $right > 23 ) ? 23 : $right;

      $moondata = array(
        'left' => array(
          'image' => theme_image(
            array(
              'path' => drupal_get_path( 'module', 'moon_phases' ) . '/styles/images/' . $class . '_first_quarter.png',
              'width' => $left,
              'height' => 52,
              'alt' => 'left',
              'title' => 'Waxing Crescent',
              'attributes' => array( 'class' => 'moon-overlay', 'align' => 'right' ),
            )
          ),
        ),
        'right' => array(
          'image' => theme_image( 
            array( 
              'path' => drupal_get_path( 'module', 'moon_phases' ) . '/styles/images/' . $class . '_last_quarter.png',
              'width' => $right,
              'height' => 52,
              'alt' => 'right',
              'title' => 'Waxing Crescent',
              'attributes' => array( 'class' => 'moon-overlay', 'align' => 'left' ),
            )
          ),
        ),
      );
      break;

    // first quarter
    case 2:
      $moondata = array(
        'left' => array(
          'image' => theme_image( 
            array( 
              'path' => drupal_get_path( 'module', 'moon_phases' ) . '/styles/images/' . $class . '_first_quarter.png',
              'width' => 26,
              'height' => 52,
              'alt' => 'right',
              'title' => 'Waxing Crescent',
              'attributes' => array( 'class' => 'moon-overlay' ),
            )
          ),
        ),
        'right' => array(
            'image' => NULL,
        ),
      );
      break;

    // waxing gibbous
    case 3:
      $offset = 26 - ( 26 * ( ( $illum -  50 ) / 100 ) );
      $moondata = array(
        'left' => array(
          'image' => theme_image( 
            array( 
              'path' => drupal_get_path( 'module', 'moon_phases' ) . '/styles/images/' . $class . '_waxing_gibbous.png',
              'width' => $offset,
              'height' => 52,
              'alt' => 'right',
              'title' => 'Waxing Gibbous',
              'attributes' => array( 'class' => 'moon-overlay', 'align' => 'left' ),
            )
          ),
        ),
        'right' => array(
            'image' => NULL,
        ),
      );
      break;

    // full moon
    case 4:
      $moondata = array(
        'left' => array(
          'image' => NULL,
        ),
        'right' => array(
          'image' => NULL,
        ),
      );
      break;

    // waning gibbous
    case 5:
      $offset = 26 - ( 26 * ( ( $illum -  50 ) / 100 ) );
      $moondata = array(
        'left' => array(
          'image' => NULL,
        ),
        'right' => array(
          'image' => theme_image( 
            array( 
              'path' => drupal_get_path( 'module', 'moon_phases' ) . '/styles/images/' . $class . '_waning_gibbous.png',
              'width' => $offset,
              'height' => 52,
              'alt' => 'right',
              'title' => 'Waning Gibbous',
              'attributes' => array( 'class' => 'moon-overlay', 'align' => 'right' ),
            )
          ),
        ),
      );
      break;

    // last quarter
    case 6:
      $moondata = array(
        'left' => array(
          'image' => NULL,
        ),
        'right' => array(
          'image' => theme_image( 
            array( 
              'path' => drupal_get_path( 'module', 'moon_phases' ) . '/styles/images/' . $class . '_last_quarter.png',
              'width' => 26,
              'height' => 52,
              'alt' => 'right',
              'title' => 'Waning Gibbous',
              'attributes' => array( 'class' => 'moon-overlay', 'align' => 'right' ),
            )
          ),
        ),
      );
      break;

    // waning crescent
    case 7:
      $offset = $illum / 2;
      $left = 26 - $offset;
      $right = 26;
      $left = ( $left > 23 ) ? 23 : $left;
      $moondata = array(
        'left' => array(
          'image' => theme_image( 
            array( 
              'path' => drupal_get_path( 'module', 'moon_phases' ) . '/styles/images/' . $class . '_first_quarter.png',
              'width' => $left,
              'height' => 52,
              'alt' => 'left',
              'title' => 'Waning Crescent',
              'attributes' => array( 'class' => 'moon-overlay', 'align' => 'right' ),
            )
          ),
        ),
        'right' => array(
          'image' => theme_image( 
            array( 
              'path' => drupal_get_path( 'module', 'moon_phases' ) . '/styles/images/' . $class . '_last_quarter.png',
              'width' => $right,
              'height' => 52,
              'alt' => 'right',
              'title' => 'Waning Gibbous',
              'attributes' => array( 'width' => $right, 'height' => 52, 'class' => 'moon-overlay', 'align' => 'left' ),
            )
          ),
        ),
      );
      break;


    default:
      return false;
  }

  $moondata[ 'class' ] = $class;

  return theme( 'moon_phase-moon', array( 'moondata' => $moondata ) );

} // function moon_phases_get_image


/**
 * Returns an array of data abut the phase
 * 
 * @return 
 *   Returns an array of moon data
 *     - 'id': The element ID
 *     - 'type': The type of moon phase; new, full, waxing or waning
 *     - 'title': The moon phase title
 */
function moon_phases_moon_data() {

  return array(
    0 => array( 'id' => 'new', 'type' => 'new', 'title' => t( 'New Moon' ), ),
    1 => array( 'id' => 'waxing_cresent', 'type' => 'waxing', 'title' => t( 'Waxing Cresent' ), ),
    2 => array( 'id' => 'first_quarter', 'type' => 'waxing', 'title' => t( 'First Quarter' ), ),
    3 => array( 'id' => 'waxing_gibbous', 'type' => 'waxing', 'title' => t( 'Waxing Gibbous' ), ),
    4 => array( 'id' => 'full', 'type' => 'full', 'title' => t( 'Full Moon' ), ),
    5 => array( 'id' => 'waning_gibbous', 'type' => 'waning', 'title' => t( 'Waning Gibbous' ), ),
    6 => array( 'id' => 'last_quarter', 'type' => 'waning', 'title' => t( 'Last Quarter' ), ),
    7 => array( 'id' => 'waning_crescent', 'type' => 'waning', 'title' => t( 'Waning Cresent' ), ),
    8 => array( 'id' => 'new', 'type' => 'new', 'title' => t( 'New Moon' ), ),
  );

} // function moon_phases_moon_data


/**
 * Determines whether it is currently day or night
 * 
 * @return
 *   Returns a string, either day or night
 */
function moon_phases_calc_sun_data() {

  $mon = date( 'n' );
  $day = date( 'j' );
  $year = date( 'Y' );

  $offset = ( ( variable_get( 'date_default_timezone', 0 ) / 60 ) / 60 );

  $sunrise = date_sunrise( mktime( 12, 0, 1, $mon, $day, $year ), SUNFUNCS_RET_TIMESTAMP, variable_get( 'moon_lat', 0 ), variable_get( 'moon_lon', 0 ), 96, $offset );
  $sunset = date_sunset( mktime( 12, 0, 1, $mon, $day, $year ), SUNFUNCS_RET_TIMESTAMP, variable_get( 'moon_lat', 0 ), variable_get( 'moon_lon', 0 ), 96, $offset );

  return ( ( ( time() - 3600 ) > $sunrise ) && ( ( time() - 3600 ) < $sunset ) ) ? 'day' : 'night';

} // function moon_phases_calc_sun_data


/**
 * Returns an array containing the moon phase description
 * 
 * @return
 *   Returns an indexed arry of moon phase descriptions
 */
function moon_phases_get_definitions() {

  return array(
    0 => variable_get( 'phase_new_moon', MOON_PHASE_NEW_MOON ),
    1 => variable_get( 'phase_waxing_cresent', MOON_PHASE_WAXING_CRESCENT ),
    2 => variable_get( 'phase_first_quarter', MOON_PHASE_FIRST_QUARTER ),
    3 => variable_get( 'phase_waxing_gibbous', MOON_PHASE_WAXING_GIBBOUS ),
    4 => variable_get( 'phase_full_moon', MOON_PHASE_FULL_MOON ),
    5 => variable_get( 'phase_waning_gibbous', MOON_PHASE_WANING_GIBBOUS ),
    6 => variable_get( 'phase_last_quarter', MOON_PHASE_LAST_QUARTER ),
    7 => variable_get( 'phase_waning_crescent', MOON_PHASE_WANING_CRESCENT ),
    8 => variable_get( 'phase_new_moon', MOON_PHASE_NEW_MOON ),
  );

} // function moon_phases_get_definitions
