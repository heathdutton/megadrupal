<?php

/**
 * @file
 * Main Numbered Multivalue Fields module functions.
 */

/**
 * Implements hook_help().
 */
function numbered_multivalue_fields_help($path, $arg) {
  switch ($path) {
    // Main module help for the block module.
    case 'admin/help#numbered_multivalue_fields':
      return '<p>' . t("Numberd MultiValues Fields is a small module which enables you to number Multiple Value Fields. This can be helpful when you expect a large quantity of values per field. You can enable numbering in your field settings - Just check 'Numbered MultiValue Field'.") . '</p>';
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function numbered_multivalue_fields_preprocess_field_multiple_value_form(&$variables) {
  $element = &$variables['element'];

  if ($element['#cardinality'] > 1 || $element['#cardinality'] == FIELD_CARDINALITY_UNLIMITED) {
    foreach (element_children($element) as $key) {
      if (is_numeric($key) && isset($element[$key]['#numbered_multivalue_fields']) && $element[$key]['#numbered_multivalue_fields']) {
        $element[$key]['value']['#post_render'][] = 'numbered_multivalue_fields_post_render';
      }
    }
  }
}

/**
 * Post process render to give token.
 */
function numbered_multivalue_fields_post_render($html, $element) {
  $html = '[numbered_multivalue_fields]' . $html;
  return $html;
}

/**
 * Implements hook_preprocess_HOOK().
 */
function numbered_multivalue_fields_preprocess_table(&$variables) {
  $numbered = FALSE;
  $rows = &$variables['rows'];

  foreach ($rows as $key => &$values) {
    if (isset($values['data'])) {
      $found = FALSE;
      foreach ($values['data'] as &$cells) {
        if (is_string($cells) && preg_match('/\[numbered_multivalue_fields\]/', $cells)) {
          $cells = str_replace('[numbered_multivalue_fields]', '', $cells);
          $found = TRUE;
          $numbered = TRUE;
          break;
        }
      }
      if ($found) {
        $new_cell  = array('data' => ($key + 1), 'class' => array('row-number'));
        array_splice($values['data'], 1, 0, array($new_cell));
      }
    }
  }

  if ($numbered) {
    $variables['header'][0]['colspan']++;
  }
}

/**
 * Implements hook_field_info_alter().
 */
function numbered_multivalue_fields_field_info_alter(&$info) {
  // Add the 'numbered_multivalue_fields' instance setting to all field types.
  foreach ($info as &$field_type_info) {
    $field_type_info += array('instance_settings' => array());
    $field_type_info['instance_settings'] += array(
      'numbered_multivalue_fields' => '',
    );
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Add a checkbox for the 'numbered_multivalue_fields' instance settings on the
 * 'Edit field instance' form.
 */
function numbered_multivalue_fields_form_field_ui_field_edit_form_alter(&$form, &$form_state, $form_id) {

  $instance = $form['#instance'];

  if (empty($form['#field']['locked'])) {

    $form['instance']['numbered_multivalue_fields'] = array(
      '#type' => 'checkbox',
      '#title' => t('Numbered MultiValue Field'),
      '#description' => t("This enables multivalue field numbering."),
      '#default_value' => isset($instance['numbered_multivalue_fields']) ? $instance['numbered_multivalue_fields'] : '',
      // Hidden when the 'Number of values' is 1.
      '#states' => array(
        'invisible' => array(
          ':input[name="field[cardinality]"]' => array('value' => '1'),
        ),
      ),
    );
  }
}

/**
 * Implements hook_field_widget_form_alter().
 */
function numbered_multivalue_fields_field_widget_form_alter(&$element, &$form_state, $context) {
  $field = $context['field'];
  $instance = $context['instance'];

  if ($field['cardinality'] == FIELD_CARDINALITY_UNLIMITED || $field['cardinality'] > 1) {
    if (!empty($instance['numbered_multivalue_fields'])) {
      $element['#numbered_multivalue_fields'] = $instance['numbered_multivalue_fields'];
    }
  }
}
