<?php

/**
 * @file
 * Hook implementations and shared functions.
 */

/**
 * Implements hook_ideal_request_alter().
 */
function idealubercart_ideal_request_alter($type, DOMDocument $dom, PaymentMethod $payment_method) {
  /** @var iDEALPaymentMethodController $controller */
  $controller = $payment_method->controller;
  if ($type == $controller::REQUEST_TRANSACTION) {
    $xpath = new DOMXPath($dom);
    $xpath->registerNamespace('iDEAL', $controller::IDEAL_XML_NAMESPACE);
    $pid = $xpath->query('/iDEAL:AcquirerTrxReq/iDEAL:Transaction/iDEAL:purchaseID')->item(0)->nodeValue;
    $payment = entity_load_single('payment', $pid);
    payment_ubercart_order_id_load($payment);
    if ($payment->context == 'payment_ubercart') {
      $xpath->query('/iDEAL:AcquirerTrxReq/iDEAL:Transaction/iDEAL:purchaseID')->item(0)->nodeValue = $payment->payment_ubercart_uc_order_id;
    }
  }
}
