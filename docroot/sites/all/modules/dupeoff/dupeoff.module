<?php

/**
* Display help and module information
*/
function dupeoff_help($path, $arg) {
  $output = '';
  switch ($path) {
    case "admin/help#dupeoff":
      $output = '<p>'.  t("DupeOff performs grammar, style and plagiarism checks on your content.") .'</p>';
      break;
  }
  return $output;
}

/**
 * implementation of hook_permission
 */
function dupeoff_permission() {
  return array(
    'DupeOff_permission' => array(
      'title' => t('Use DupeOff'),
      'description' => t('Permission for role to perform DupeOff checks.'),
    ),
  );
}

/**
 * Implementation of hook_menu
 */
function dupeoff_menu() {
  $items = array();

  $items['admin/config/system/dupeoff'] = array(
    'title' => 'DupeOff Settings',
    'description' => 'Set the various DupeOff Settings here',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('dupeoff_admin'),
    'access arguments' => array('access administration pages'),
    'type' => MENU_NORMAL_ITEM,
   );

   $items['dupeoff/check'] = array(
    'title' => 'DupeOff Check',
    'page callback' => 'dupeoff_perform',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
   );

   
  return $items;
}

// ======================================
// Administration Page:
// ======================================
function dupeoff_admin() {

// get fields of type text
foreach (field_info_fields() as $field)  {
  if ($field["module"] == "text")
    $text_fields[$field["field_name"]] = $field["field_name"];
  }
  //dpm($text_fields);

    $form['field'] = array(
    '#type' => 'fieldset',
    '#title' => t('Field Settings'),
  '#description' => t("Select the field which will be enabled for DupeOff."),
    '#weight' => 0,
    '#collapsible' => FALSE,
    '#collapsed' => FALSE,
  );
  $form['field']['dupeoff_field'] = array(
    '#type' => 'select',
    '#title' => t('DupeOff Field'),
    '#default_value' => variable_get('dupeoff_field', 'body'),
  '#options' => $text_fields,
    '#description' => t("Your DupeOff field."),
    '#required' => FALSE,
  );
  $form['field']['dupeoff_field_location'] = array(
    '#type' => 'select',
    '#title' => t('DupeOff Field Location'),
    '#default_value' => variable_get('dupeoff_field', 'before'),
  '#options' => array("before" => "before", "after" => "after"),
    '#description' => t("Show the DupeOff button before or after the text field."),
    '#required' => FALSE,
  );
  
  $form['account'] = array(
    '#type' => 'fieldset',
    '#title' => t('Account Settings'),
  '#description' => t("Your account details for <a href=\"http://dupeoff.com\" target=\"_blank\">dupeoff.com</a>. You can use the service without an account, but your usage is limited to checking one post up to 600 words per day. If you want more get an account <a href=\"http://dupeoff.com/user\" target=\"_blank\">here</a>."),
    '#weight' => 0,
    '#collapsible' => FALSE,
    '#collapsed' => FALSE,
  );
  $form['account']['dupeoff_username'] = array(
    '#type' => 'textfield',
    '#title' => t('DupeOff Username'),
    '#default_value' => variable_get('dupeoff_username', ''),
    '#size' => 32,
    '#maxlength' => 128,
    '#description' => t("Your DupeOff username."),
    '#required' => FALSE,
  );
  $form['account']['dupeoff_password'] = array(
    '#type' => 'textfield',
    '#title' => t('DupeOff Password'),
    '#default_value' => variable_get('dupeoff_password', ''),
    '#size' => 32,
    '#maxlength' => 128,
    '#description' => t("Your DupeOff password."),
    '#required' => FALSE,
  );
  $form['debug'] = array(
    '#type' => 'fieldset',
    '#title' => t('Debug Settings'),
    '#weight' => 1,
    '#collapsible' => FALSE,
    '#collapsed' => FALSE,
  );
  $form['debug']['dupeoff_debug'] = array(
    '#type' => 'checkbox',
    '#title' => t('Debug Mode'),
    '#default_value' => variable_get('dupeoff_debug', FALSE),
    '#description' => t("Check this to write all debug messages to the log."),
    '#required' => FALSE,
  );
  
return system_settings_form($form);
}


function dupeoff_node_view($node)  {
  if (user_access('Use DupeOff')) {

    drupal_add_js('
        jQuery(document).ready(function(){
        jQuery(".field-name-' . variable_get('dupeoff_field', 'body').'") . ' . variable_get('dupeoff_field_location', 'before') . '(\'<div id="dupeoff-button-holder"><button type="button"  id="dupeoff-submit">Check with DupeOff</button></div>\');      
        jQuery("#dupeoff-submit").click(function(){
		
          jQuery("#dupeoff-button-holder").append("<img id=\"dupeoff_throbber\" src=\"sites/all/modules/dupeoff/images/throbber.gif\" />");

          jQuery.ajax({
             type: "POST",
             url: "dupeoff/check",
             dataType: "html",
             data: {"text": jQuery(".field-name-' . variable_get('dupeoff_field') . '").html()
              },
             success: function(dupeoff_result){
                jQuery("#dupeoff-submit").after(dupeoff_result);
				jQuery("#dupeoff_throbber").remove(); 
             }
            });    
          });
        });
        ', 'inline');
    
    }
  }

function dupeoff_node_prepare($node)  {
  if (user_access('Use DupeOff')) {

    drupal_add_js('
        jQuery(document).ready(function(){
        jQuery("#edit-' . variable_get('dupeoff_field', 'body').'") . ' . variable_get('dupeoff_field_location', 'before') . '(\'<div id="dupeoff-button-holder"><button type="button"  id="dupeoff-submit" onclick="return false;">Check with DupeOff</button></div>\');      
        jQuery("#dupeoff-submit").click(function(event){


          jQuery("#dupeoff-button-holder").append("<img id=\"dupeoff_throbber\" src=\"sites/all/modules/dupeoff/images/throbber.gif\" />");

          jQuery.ajax({
             type: "POST",
             url: "dupeoff/check",
             dataType: "html",
             data: {"text": jQuery("#edit-' . variable_get('dupeoff_field') . '").html()
              },
             success: function(dupeoff_result){
                jQuery("#dupeoff-submit").after(dupeoff_result);
				jQuery("#dupeoff_throbber").remove(); 
             }
            });    		  
			event.preventDefault();
			return false;
          });
        });
        ', 'inline');
    
    }
  }  
  
function dupeoff_perform() {
  module_load_include("php", "dupeoff", "dupeoff_api");
  
  dupeoff_debug_message('Received a raw POST submission: '. print_r($_POST,TRUE));
  dupeoff_check_api ($_POST["text"]);
}

function dupeoff_debug_message($message) {
  //Debugging
  if (variable_get('dupeoff_debug', FALSE)) {
    watchdog('dupeoff',$message);
  }
}
