<?php

/**
* Implementation of hook_block().
*/
function whereiam_block_info() {
  $blocks['whereiam'] = array(
    'info' => t("Where I Am"),
    'cache' => DRUPAL_CACHE_PER_ROLE 
    );
  return $blocks;
  } // end function fightfi_block


/**
* Implementation of hook_block_view().
*/
function whereiam_block_view($delta = '') {

  if ($delta == 'whereiam') {
    $block['subject'] = t("Where I Am");
    if (user_access('access content')) {
      $block['content'] = drupal_render(drupal_get_form("whereiam_set_location_form"));
      }
  return $block;
  }
}

/**
* Sets location fields from submitted form.
*/
function whereiam_set_location_form_submit($form) {
  global $user;
  $street = $form['street']['#value'];
  $city = $form['city']['#value'];
  $usr = user_load($user->uid);
  $locations = array();
  if (isset($city) && $city != "") {
    $locations[0]['city'] = $city;
  }
  if (isset($street) && $street != "") {
    $locations[0]['street'] = $street;
  }
  $criteria = array();
  $criteria['uid'] = $usr->uid;

  if (isset($city) || isset($street)) {
    $lid = location_save_locations($locations, $criteria);
  }
}

/**
* Defines the form to be used in the "Where I Am" block.
*/
function whereiam_set_location_form() {
  global $user;
  $usr = user_load($user->uid);
  $form['street'] = array(
    '#type' => "textfield",
    '#title' => t("Address"),
    '#default_value' => $usr->locations[0]['street']
  );

  $form['city'] = array(
    '#type' => "textfield",
    '#title' => t('City'),
    '#default_value' => $usr->locations[0]['city']
    );

  $form['submit'] = array(
    '#value' => "Imposta",
    '#type' => "submit"
    );

$form['#submit'][] = "whereiam_set_location_form_submit";
  return $form;
}


