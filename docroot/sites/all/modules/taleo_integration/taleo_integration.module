<?php

/**
 * @file taleo_integration.module
 *
 * Original author: Gokul
 *
 */


/**
 * Implements hook_menu().
 */
function taleo_integration_menu() {
  $items = array();
  $items['admin/config/taleo-integration'] = array(
    'title' => 'Taleo Integration',
    'description' => 'Login Credentials and settings for Taleo account',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('taleo_integration_admin_settings'),
    'access arguments' => array('administer site configuration'),
    'file' => 'taleo_integration.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );
  $items['taleo-postings'] = array(
    'title' => 'Taleo Job Listing page',
    'description' => 'Taleo Job Listing page',
    'page callback' => 'get_jobs_from_taleo',
    'access arguments' => array('view content'),
    'file' => 'taleo.inc',
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}


/**
 * Implements hook_permission().
 */
function taleo_integration_permission() {
  return array(
    'taleo settings' => array(
      'title' => t('taleo settings'),
      'description' => t('TODO Add a description for \'taleo settings\''),
    ),
  );
}

/**
 * Implements hook_theme().
 */
function taleo_integration_theme() {
  return array(
    'taleo_feeds' => array(
      'variables' => array('jobs' => NULL),
    ),
  );
}

/**
 * @return
 * The themed output of the taleo job list feed
 */
function theme_taleo_feeds($variables) {
  $jobs = $variables['jobs'];
  $output = '';
  $taleo_listing_subtitle =  check_plain(variable_get('taleo_listing_subtitle', t('Hot Jobs')));
  $output .= '<div class="taleo-postings"><div class = "$taleo_listing_subtitle"><h3>' . t($taleo_listing_subtitle) . '<br/>' . t('Try') . '</h3></div><br/>';
  foreach ($jobs as $key => $job) {
    $output .=  '<span class = "state"><b>' . ucfirst(strtolower($job->location)) . ':</b> </span><span class = "job-title" >' . check_plain($job->title) . '</span><br/><br/>';
  }
  $output .=  '</div><br/>';
  return $output;
}



/**
 * Implements hook_block_info().
 */
function taleo_integration_block_info() {
  $block[0]['info'] = t('Taleo Job Posting');
  $block[0]['cache'] = BLOCK_CACHE_GLOBAL;
  return $block;
}

/**
 * Implements hook_block_configure().
 */
function taleo_integration_block_configure($delta) {
  // TODO Rename block deltas (e.g. delta-0) to readable strings.
  $form = array();
  if ($delta == 'delta-0') {
    // All we need to provide is a text field, Drupal will take care of
    // the other block configuration options and the save button.
    $form['taleo_listing_block_limit'] = array(
      '#type' => 'textfield',
      '#title' => t('Max Number of postings to be shown on this block'),
      '#size' => 60,
      '#description' => t(''),
      '#default_value' => variable_get('taleo_listing_block_limit', 5),
    );
    $form['taleo_listing_subtitle'] = array(
      '#type' => 'textfield',
      '#title' => t('Sub-title for the block'),
      '#size' => 60,
      '#description' => t('Sub-title for the block'),
      '#default_value' => variable_get('taleo_listing_subtitle', t('Hot Jobs')),
    );
  }
  return $form;
}

/**
 * Implements hook_block_save().
 */
function taleo_integration_block_save($delta, $edit) {
  // TODO Rename block deltas (e.g. delta-0) to readable strings.
  if ($delta == 'delta-0') {
    // Have Drupal save the string to the database.
    variable_set('taleo_listing_subtitle', $edit['taleo_listing_subtitle']);
    if (!is_numeric($edit['taleo_listing_block_limit'])) {
      form_set_error('taleo_listing_block_limit', t('The taleo postings limit must be numeric.'));
    }
    else {
      variable_set('taleo_listing_block_limit', $edit['taleo_listing_block_limit']);
    }
  }
  return;
}

/**
 * Implements hook_block_view().
 */
function taleo_integration_block_view($delta) {
  // TODO Rename block deltas (e.g. delta-0) to readable strings.
  switch ($delta) {
    case 'delta-0':
      module_load_include('inc', 'taleo_integration', 'taleo');
      $limit = variable_get('taleo_listing_block_limit', 5);
      $block['subject'] = t('Taleo Job posting');
      $jobs = get_jobs_from_taleo('', $limit);
      $block['content'] = theme('taleo_feeds', array('jobs' => $jobs));
      break;
  }
  return $block;
}

/**
 * Implements hook_block().
 */
function taleo_integration_block_OLD($op = 'list', $delta = 0, $edit = array()) { }
