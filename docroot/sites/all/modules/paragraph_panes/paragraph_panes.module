<?php

/**
 * @file
 * This module allows you to add paragraph items to panels in Page Manager.
 */

/**
 * Implements hook_ctools_plugin_directory().
 */
function paragraph_panes_ctools_plugin_directory($owner, $plugin_type) {
  if ($owner == 'ctools') {
    return 'plugins/' . $plugin_type;
  }
}

/**
 * The 'edit form' callback for the content type.
 */
function paragraph_panes_edit_form($form, &$form_state) {
  $entity_type = 'paragraphs_item';
  $bundle_name = $form_state['subtype_name'];
  $entity = new ParagraphsItemEntity(array('bundle' => $bundle_name));

  // Initialize #parents if not set to avoid warnings.
  if (!isset($form['#parents'])) {
    $form['#parents'] = array();
  }

  // Load the field form for each field of the paragraph bundle.
  $fields = field_info_instances('paragraphs_item', $bundle_name);
  foreach ($fields as $field) {
    $field_name = $field['field_name'];
    $field_info = field_info_field($field_name);
    $instance = field_info_instance($entity_type, $field_name, $bundle_name);
    $items = $form_state['conf'][$field_name];
    if (!empty($items)) {
      _paragraph_panes_restore_entities($items);
    }

    $field_form = field_default_form($entity_type, $entity, $field_info, $instance, LANGUAGE_NONE, $items, $form, $form_state);
    $form = array_merge($form, $field_form);
  }

  return $form;
}

/**
 * The submit form stores the data in $conf.
 */
function paragraph_panes_edit_form_submit($form, &$form_state) {
  $fields = field_info_instances('paragraphs_item', $form_state['subtype_name']);
  foreach ($fields as $field) {
    $field_name = $field['field_name'];
    $field_value = $form_state['values'][$field_name][LANGUAGE_NONE];
    $form_state['conf'][$field_name] = _paragraph_panes_sanitize_values($field_value);
  }
}

/**
 * Sanitizes the form_values array for a field.
 *
 * @param array $field_values
 *   The form_values array.
 *
 * @return array
 *   The array with empty and invalid/unneeded values removed.
 */
function _paragraph_panes_sanitize_values(array $field_values) {
  $clean = array();

  // Strip out add more button which is not a value.
  if (isset($field_values['add_more'])) {
    unset($field_values['add_more']);
  }

  foreach ($field_values as $key => &$field_value) {
    // Serialize entity since otherwise it can not be exported in features,
    // since features tries to eval() each var_export(), which in this case
    // would include a Entity::set_state call and that function does not exist.
    if (isset($field_value['entity'])) {
      $field_value['serialized_entity'] = serialize($field_value['entity']);
      unset($field_value['entity']);
    }

    // Strip out actions which do not contain values anyhow.
    if (isset($field_value['actions'])) {
      unset($field_value['actions']);
    }

    // Check if there are nested entities.
    if (is_array($field_value)) {
      $field_value = _paragraph_panes_sanitize_values($field_value);
    }

    // Filter out the empty values for unlimited multi-value fields.
    $valid_field = FALSE;
    $value_keys = array('value', 'fid', 'url', 'target_id');
    if (!array_key_exists($value_keys)) {
      // Fields which do not contain a 'value key' are always valid,
      // and thus should be included.
      $valid_field = TRUE;
    }
    else {
      // Check if the 'value key' is not empty, in which case the field should
      // also be included.
      foreach ($value_keys as $value_key) {
        if (!empty($field_value[$value_key])) {
          $valid_field = TRUE;
          break;
        }
      }
    }

    if ($valid_field) {
      $clean[$key] = $field_value;
    }
  }

  return $clean;
}

/**
 * Unserializes the enitities back again.
 *
 * @param array $values
 *    The values array which contains the serialized entities.
 */
function _paragraph_panes_restore_entities(array &$values) {
  foreach ($values as &$value) {
    if (is_array($value) && isset($value['serialized_entity'])) {
      $value['entity'] = unserialize($value['serialized_entity']);
      unset($value['serialized_entity']);
    }

    if (is_array($value)) {
      _paragraph_panes_restore_entities($value);
    }
  }
}

/**
 * Implements hook_help().
 */
function paragraph_panes_help($path, $arg) {
  switch ($path) {
    case 'admin/help#paragraph_panes':
      $filepath = dirname(__FILE__) . '/README.md';
      if (file_exists($filepath)) {
        $readme = file_get_contents($filepath);
      }
      else {
        $filepath = dirname(__FILE__) . '/README.txt';
        if (file_exists($filepath)) {
          $readme = file_get_contents($filepath);
        }
      }
      if (!isset($readme)) {
        return NULL;
      }
      if (module_exists('markdown')) {
        $filters = module_invoke('markdown', 'filter_info');
        $info = $filters['filter_markdown'];

        if (function_exists($info['process callback'])) {
          $output = $info['process callback']($readme, NULL);
        }
        else {
          $output = '<pre>' . $readme . '</pre>';
        }
      }
      else {
        $output = '<pre>' . $readme . '</pre>';
      }

      return $output;
  }
}
