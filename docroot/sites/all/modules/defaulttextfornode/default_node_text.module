<?php

/**
 * @file
 * Prepopulates the node-add form with default body/teaser text
 */

/**
 * Implementation of hook_form_alter().
 */
function default_node_text_form_alter(&$form, $form_state, $form_id) {
  switch ($form_id) {
    case 'node_type_form':
      $form['default_text'] = array(
		  
        '#type' => 'fieldset',
		    '#group' => 'additional_settings',
        '#title' => 'Default text for node',
        'default_value' => array (
                    '#type' => 'textarea',
                    '#title' => t('Default text for node'),
					          '#default_value' => variable_get('default_text_' . $form['#node_type']->type, ''),
                    '#description' => t('This text will prepopulate the body field. PHP code wrapped in &lt;?php ?&gt; tags will be evaluated.'),
                )

      );
	    $form['#submit'][] = "default_node_text_form_submit";
      break;

    default:
      if (! array_key_exists('body',$form)) {return;}
   	  $language = $form['body']['#language'];
      if (strpos($form_id, 'node_form') && strpos(strtolower($form['#action']), '/add/') && trim($form['body'][$language][0]['#default_value']) == '') {
		  
        $default_text = variable_get('default_text_' . $form['type']['#value'], '');   
	     	if (module_exists('php')) {
	        $default_text = php_eval($default_text);   
		    }
        // Replace body text with evaluated default text
        $form['body'][$language][0]['#default_value'] = $default_text;
        // Update node body and teaser values in the $form[#node] object
        if (strpos($default_text, '<!--break-->') !== FALSE) {
          list($form['body'][$language][0]['summary']['#default_value'], $form['body'][$language][0]['#default_value']) = explode('<!--break-->', $default_text, 2);
        }
        else {
          $form['body'][$language][0]['#default_value'] = $default_text;
        }
		
      }
      break;
  }
}

function default_node_text_form_submit($form, &$form_state) {
  $text = $form['default_text']['default_value']['#value'];
  if ($text != "") {
    variable_set('default_text_' . $form['#node_type']->type, $text);
  }
  else {
    variable_del('default_text_' . $form['#node_type']->type);
  }

}