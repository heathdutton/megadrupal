<?php
/**
 * @file
 * Integration with Bazaarvoice ratings & reviews service.
 */

/**
 * Implements hook_permission().
 */
function bazaarvoice_permission() {
  $permissions = array();

  $permissions['administer bazaarvoice'] = array(
    'title' => t('Administer Bazaarvoice'),
  );
  $permissions['administer bazaarvoice locales'] = array(
    'title' => t('Administer bazaarvoice locales'),
  );
  return $permissions;
}

/**
 * Implements hook_features_api().
 */
function bazaarvoice_features_api() {
  return array(
    'bazaarvoice_locale' => array(
      'name' => t('Bazaarvoice Locales'),
      'default_file' => FEATURES_DEFAULTS_INCLUDED,
      'default_hook' => 'bazaarvoice_locale',
      'feature_source' => TRUE,
      'file' => drupal_get_path('module', 'bazaarvoice') . '/includes/features.inc',
    ),
  );
}

/**
 * Retrieves a list of enabled site languages.
 *
 * @return array
 *   Array of enabled site languages.
 */
function bazaarvoice_get_site_languages() {
  // Get list of enabled languages.
  $languages = language_list('enabled');
  $languages = isset($languages[1]) ? $languages[1] : FALSE;
  // Have languages? return them, else return an empty array.
  return $languages ?: array();
}

/**
 * Retrieve the locale code for a particular language.
 *
 * @param bool|string $lang_code
 *   The lang code of language to retrieve locale for.
 * @param bool $use_default
 *   Boolean check to return default locale if one is not found for lang_code.
 *
 * @return mixed
 *   Either the locale string or boolean FALSE.
 */
function bazaarvoice_get_locale($lang_code = FALSE, $use_default = FALSE) {
  global $language;
  $locale = FALSE;
  // If no lang_code is passed, get the current language.
  if (!$lang_code) {
    $lang_code = $language->language;
  }
  // Get list of all locales.
  $locales = bazaarvoice_get_locales();
  // Return locale for given language if found.
  if (isset($locales[$lang_code])) {
    $locale = $locales[$lang_code]['locale'];
  }
  // Else use default?
  elseif ($use_default) {
    $locale = bazaarvoice_get_default_locale();
  }
  return $locale;
}

/**
 * Retrieve list of Bazaarvoice locales.
 *
 * @return array
 *   Array of locales or empty array.
 */
function bazaarvoice_get_locales() {
  $locales = &drupal_static(__FUNCTION__);
  if (!$locales) {
    $locales = db_select('bazaarvoice_locales', 'bl')
      ->fields('bl')
      ->execute()
      ->fetchAllAssoc('language', PDO::FETCH_ASSOC);
    // Allow other modules to alter.
    drupal_alter('bazaarvoice_locales', $locales);
  }

  return $locales ? $locales : array();
}

/**
 * Store the language locales.
 *
 * @param array $locales
 *   Array of locales with key of the language code.
 */
function bazaarvoice_set_locales(array $locales) {

  // Allow other modules to take actions.
  $locales = module_invoke_all('bazaarvoice_presave_locales', $locales);

  foreach ($locales as $lang_code => $locale) {
    db_merge('bazaarvoice_locales')
      ->key(array('language' => $lang_code))
      ->fields($locale)
      ->execute();
  }
}

/**
 * Remove locales for site languages.
 *
 * @param array $languages
 *   Language codes to delete locale for.
 */
function bazaarvoice_delete_locales(array $languages) {
  if (!empty($languages)) {
    db_delete('bazaarvoice_locales')
      ->condition('language', $languages, 'IN')
      ->execute();
  }
  // Allow other modules to take actions.
  module_invoke_all('bazaarvoice_postdelete_locales', $languages);
}

/**
 * Return the default locale for the site.
 *
 * @return string
 *   The default locale.
 */
function bazaarvoice_get_default_locale() {
  $default_locale = &drupal_static(__FUNCTION__);

  if (!$default_locale) {
    // Attempt to get locale flagged as default.
    $locale = db_select('bazaarvoice_locales', 'bl')
      ->fields('bl', array('locale'))
      ->condition('is_default', 1)
      ->range(0, 1)
      ->execute()
      ->fetchCol();
    // Able to retrieve a default locale?
    if ($locale) {
      $default_locale = $locale;
    }
    else {
      // Attempt to get locale for site default language.
      if ($locale = bazaarvoice_get_locale(language_default('language'))) {
        $default_locale = $locale;
      }
    }
    // Allow other modules to alter.
    drupal_alter('bazaarvoice_default_locale', $default_locale);
  }

  // Return default locale, or hardcoded default of en_US.
  return $default_locale ? $default_locale : 'en_US';
}
