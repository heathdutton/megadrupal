<?php
/**
 * @file
 * Contains core functions for the WebducateAPI - Commerce module.
 */

/**
 * Include additional files.
 */
foreach (module_list() as $module) {
  if (file_exists($file = dirname(__FILE__) . "/includes/{$module}.inc")) {
    require_once $file;
  }
}

/**
 * Features include.
 */
include_once 'webducateapi_commerce.features.inc';

/**
 * Implements hook_menu().
 */
function webducateapi_commerce_menu() {
  $items = array();

  $items['admin/commerce/config/webducateapi'] = array(
    'title' => t('WebducateAPI settings'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('webducateapi_commerce_settings'),
    'access arguments' => array('configure store'),
    'file' => 'webducateapi_commerce.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_cron().
 */
function webducateapi_commerce_cron() {
  $settings = variable_get('webducateapi_commerce', webducateapi_commerce_defaults());

  if ($settings['enabled']) {
    $courses = webducateapi_get_courses();
    foreach ($courses as $webducate_id => $course) {
      $product = commerce_product_load_by_sku($webducate_id);
      if (empty($product)) {
        // Create product entity.
        $product = commerce_product_new('webducate_course');
        $product->title = $course['title'];
        $product->sku = $webducate_id;
        $product->language = LANGUAGE_NONE;
        $product->commerce_price[LANGUAGE_NONE][] = array(
          'amount' => $course['price'] * 100,
          'currency_code' => 'AUD',
        );
        commerce_product_save($product);
        field_attach_update('commerce_product', $product);

        // Create product wrapper node.
        $node = new stdClass();
        $node->title = $course['name'];
        $node->type = $settings['content_type'];
        node_object_prepare($node);
        $node->language = LANGUAGE_NONE;
        $node->uid = 1;
        $node->status = 1;
        if (!empty($settings['map']['body'])) {
          $node->{$settings['map']['body']}[LANGUAGE_NONE][] = array(
            'value' => $course['description'],
            'format' => filter_default_format(),
          );
        }
        $node->{$settings['map']['product_reference']}[LANGUAGE_NONE][]['product_id'] = $product->product_id;
        $node = node_submit($node);
        node_save($node);
      }
    }
  }
}

/**
 * Defaults for WebducateAPI - Commerce settings.
 */
function webducateapi_commerce_defaults() {
  return array(
    'enabled' => FALSE,
    'content_type' => NULL,
    'map' => array(
      'product_reference' => NULL,
      'body' => NULL,
    ),
  );
}
