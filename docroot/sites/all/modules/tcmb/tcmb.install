<?php
/**
 * @file
 * The installer file for Tcmb module.
 */

/*
 * Implements hook_schema().
 */

function tcmb_schema() {
  $schema['tcmb'] = array(
    'fields' => array(
      'currency_name' => array(
        'type' => 'varchar',
        'length' => 50,
      ),
      'currency_code' => array(
        'type' => 'varchar',
        'length' => 3,
      ),
      'updated' => array(
        'mysql_type' => 'date',
      ),
      'buying' => array(
        'type' => 'numeric',
        'precision' => 6,
        'scale' => 4,
      ),
      'selling' => array(
        'type' => 'numeric',
        'precision' => 6,
        'scale' => 4,
      ),
    ),
  );
  return $schema;
}

/*
 * Implements hook_install().
 */

function tcmb_install() {
  variable_set('tcmb_show_currency_block_title', 1);
  variable_set('tcmb_show_gold_block_title', 1);
  variable_set('tcmb_show_currency_block_footer', 1);
  variable_set('tcmb_show_gold_block_footer', 1);
  $tcmb_currency_codes = tcmb_currency_codes();
  $tcmb_currency_xml = new DomDocument;
  $tcmb_currency_xml->load('http://www.tcmb.gov.tr/kurlar/today.xml');
  $tcmb_xpath = new DOMXPath($tcmb_currency_xml);
  foreach ($tcmb_currency_codes as $currency_code => $currency_name) {
    $query = "//Currency[@CurrencyCode='$currency_code']";
    $results = $tcmb_xpath->query($query);
    $buying = $results->item(0)->getElementsByTagName('ForexBuying')->item(0)->nodeValue;
    $selling = $results->item(0)->getElementsByTagName('ForexSelling')->item(0)->nodeValue;
    $created = $tcmb_currency_xml->getElementsByTagName('Tarih_Date')->item(0)->getAttribute('Tarih');
    $updated = date('Y-m-d', strtotime($created));
    $currency = db_insert('tcmb')
      ->fields(array(
        'currency_name' => $tcmb_currency_codes[$currency_code],
        'currency_code' => $currency_code,
        'updated' => $updated,
        'buying' => $results->item(0)->getElementsByTagName('ForexBuying')->item(0)->nodeValue,
        'selling' => $results->item(0)->getElementsByTagName('ForexSelling')->item(0)->nodeValue,
      ))
      ->execute();
  }
  drupal_set_message(st('Initial values for currency codes have been stored.'));
  watchdog('tcmb', 'Initial currency rates have been stored.', WATCHDOG_INFO);
}

/*
 * Implements hook_requirements().
 */

function tcmb_requirements($phase) {
  $requirements = array();
  $requirements['php_allow_url_fopen'] = array(
    'title' => st('Tcmb XML reading'),
  );
  $allow_url_fopen = trim(ini_get('allow_url_fopen'));
  if (empty($allow_url_fopen) && $allow_url_fopen != 'On') {
    $requirements['php_allow_url_fopen']['description'] = st('<em>allow_url_fopen</em> is disabled. Tcmb requires that this configuration directive be enabled. The PHP manual has instructions for <a href="http://php.net/configuration.changes">how to change configuration settings</a>.');
    $requirements['php_allow_url_fopen']['severity'] = REQUIREMENT_ERROR;
    $requirements['php_allow_url_fopen']['value'] = st('Not enabled');
  }
  else {
    $requirements['php_allow_url_fopen']['value'] = st('Enabled');
  }
  return $requirements;
}

/**
 * Implements hook_uninstall().
 */

function tcmb_uninstall() {
  db_query("DELETE FROM {variable} where name like 'tcmb_%'");
  db_query("DELETE FROM {block} WHERE module = 'tcmb'");
  db_query("DELETE FROM {watchdog} WHERE type='tcmb'");
}
