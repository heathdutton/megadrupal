<?php

/**
 * Implements theme_preprocess_aggregator_item().
 */
function aggregator_item_length_preprocess_aggregator_item(&$variables) {
  $item_length = variable_get('aggregator_item_length', 'fulltext');
  switch ($item_length) {
    case 'teaser':
      $summary = text_summary($variables['content'], NULL, variable_get('aggregator_teaser_length', 600));
      if ($summary != $variables['content']) {
        // Ensure tags are closed properly.
        $summary = _filter_htmlcorrector($summary);
        $summary .= '<p><a href="' . $variables['feed_url'] . '">' . t('Read more') . "</a></p>\n";
      }
      $variables['content'] = $summary;
      break;
    case 'title':
      $variables['content'] = '';
      break;
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function aggregator_item_length_form_aggregator_admin_form_alter(&$form, &$form_state) {
  $form['modules']['aggregator']['aggregator_item_length'] = array(
    '#type' => 'select',
    '#title' => t('Aggregator item display'),
    '#description' => t('Global setting for the default display of content items in each feed. Does not affect the length of items in RSS feeds, which can be changed under <a href="@url">RSS publishing</a>.', array('@url' => url('admin/config/services/rss-publishing'))),
    '#default_value' => variable_get('aggregator_item_length', 'fulltext'),
    '#options' => array(
      'title' => t('Titles only'),
      'teaser' => t('Titles plus trimmed teaser'),
      'fulltext' => t('Full text'),
    ),
  );
  $form['modules']['aggregator']['aggregator_teaser_length'] += array(
    '#weight' => 10,
    '#states' => array(
      'visible' => array(
        ':input[name="aggregator_item_length"]' => array('value' => 'teaser'),
      ),
    ),
  );
}
