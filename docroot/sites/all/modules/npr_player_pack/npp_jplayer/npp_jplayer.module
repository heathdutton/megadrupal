<?php
/**
 * @file
 * Adds a formatter for the npr_audio field.
 */

/**
 * Implements hook_field_formatter_settings_form().
 */
function npp_jplayer_field_formatter_settings_form($field, $instance, $view_mode, $form, &$form_state) {
  $display = $instance['display'][$view_mode];
  $settings = $display['settings'];
  $element = array();
  $element['jplayer_location'] = array(
    '#type' => 'textfield',
    '#title' => t('Player Location'),
    '#description' => t('Set the absolute, relative, or external location of the jPlayer Javascript file.'),
    '#default_value' => $settings['jplayer_location'],
  );
  $element['jplayer_swf_location'] = array(
    '#type' => 'textfield',
    '#title' => t('Player SWF Location'),
    '#description' => t('Set the absolute, relative, or external location of jplayer.swf. Should be a directory.'),
    '#default_value' => $settings['jplayer_swf_location'],
  );
  $element['jplayer_skin_location'] = array(
    '#type' => 'textfield',
    '#title' => t('Player Skin Location'),
    '#description' => t('Set the absolute, relative, or external location of the jPlayer skin CSS file.'),
    '#default_value' => $settings['jplayer_skin_location'],
  );
  $element['jplayer_instance_prefix'] = array(
    '#type' => 'textfield',
    '#title' => t('Player Instance Prefix'),
    '#description' => t('Each jPlayer instance requires a unique ID element.
                         This option sets the prefix of each unique element.
                         It will be appended with a hyphen and 4 random,
                         alphanumeric characters.'),
    '#default_value' => $settings['jplayer_instance_prefix'],
  );
  $element['jplayer_repeat'] = array(
    '#type' => 'checkbox',
    '#title' => t('Enable Repeat Button'),
    '#description' => t('Display or hide the player\'s repeat button.'),
    '#default_value' => $settings['jplayer_repeat'],
  );
  $element['jplayer_download_link'] = array(
    '#type' => 'checkbox',
    '#title' => t('Enable Download Link'),
    '#description' => t('Display or hide a download link to the audio.'),
    '#default_value' => $settings['jplayer_download_link'],
  );
  $element['jplayer_time_margin_fix'] = array(
    '#type' => 'checkbox',
    '#title' => t('Enable fix for time margins.'),
    '#description' => t('Activate or disable the fix for margins of the current-time and remaining-time.'),
    '#default_value' => $settings['jplayer_time_margin_fix'],
  );
  return $element;
}

/**
 * Implements hook_field_formatter_settings_summary().
 */
function npp_jplayer_field_formatter_settings_summary($field, $instance, $view_mode) {
  $summary = t('Configure some player settings like jPlayer Javascript location and skin.');
  return $summary;
}

/**
 * Implements hook_field_formatter_info().
 */
function npp_jplayer_field_formatter_info() {
  return array(
    'npp_jplayer_formatter' => array(
      'label' => t('NPP jPlayer'),
      'field types' => array('npr_audio'),
      'settings' => array(
        'jplayer_location' => '/sites/all/libraries/player/jplayer/dist/jplayer/jquery.jplayer.min.js',
        'jplayer_skin_location' => '/sites/all/libraries/player/jplayer/dist/skin/blue.monday/css/jplayer.blue.monday.css',
        'jplayer_swf_location' => '/sites/all/libraries/player/jplayer/dist/jplayer',
        'jplayer_instance_prefix' => 'npp_jplayer',
        'jplayer_repeat' => FALSE,
        'jplayer_download_link' => TRUE,
        'jplayer_time_margin_fix' => TRUE,
      ),
    ),
  );
}

/**
 * Implements hook_theme().
 */
function npp_jplayer_theme($existing, $type, $theme, $path) {
  $functions = array();
  $functions['jplayer'] = array(
    'prefix' => NULL,
    'rstring' => NULL,
    'repeat' => NULL,
    'downloadlink' => NULL,
    'mp3' => NULL,
  );

  return $functions;
}

/**
 * Registered theme function that output player HTML.
 */
function theme_jplayer($args) {
  $prefix = $args['prefix'];
  $rstring = $args['rstring'];

  $html = <<<HTML
<div id="$prefix-$rstring" class="jp-jplayer"></div>
<div id="npp_jp_container_1" class="jp-audio" role="application" aria-label="media player">
  <div class="jp-type-single">
    <div class="jp-gui jp-interface">
      <div class="jp-controls-holder">
        <div class="jp-volume-controls">
          <button class="jp-mute" role="button" tabindex="0">mute</button>
          <button class="jp-volume-max" role="button" tabindex="0">max volume</button>
          <div class="jp-volume-bar">
            <div class="jp-volume-bar-value"></div>
          </div>
        </div>
        <div class="jp-controls">
          <button class="jp-play" role="button" tabindex="0">play</button>
          <button class="jp-stop" role="button" tabindex="0">stop</button>
        </div>
        <div class="jp-progress">
          <div class="jp-seek-bar">
            <div class="jp-play-bar"></div>
          </div>
        </div>
        <div class="jp-toggles">
HTML;
  // Repeat settings
  if ($args['repeat']) {
    $html .= <<<HTML
              <button class="jp-repeat" role="button" tabindex="0">repeat</button>
HTML;
  }
    // Update required settings
    // Detect if the margin fix for time should be applied.
    if ($args['margin_fix']) {
      $margin_fix_left = 'style="padding-left: 10px;"';
      $margin_fix_right = 'style="padding-right: 10px;"';
    }
    else {
      $margin_fix_left = ' ';
      $margin_fix_right = ' ';
    }

    $html .= <<<HTML
        </div>
      </div>
        <div $margin_fix_left class="jp-current-time" role="timer" aria-label="time">&nbsp;</div>
        <div $margin_fix_right class="jp-duration" role="timer" aria-label="duration">&nbsp;</div>
    </div>
    <div class="jp-details">
      <div class="jp-title" aria-label="title">&nbsp;</div>
    </div>
    <div class="jp-no-solution">
      <span>Update Required</span>
      To play the media you will need to either update your browser to a recent version or update your <a href="http://get.adobe.com/flashplayer/" target="_blank">Flash plugin</a>.
    </div>
  </div>
</div>

HTML;
  // Download link settings
  if ($args['downloadlink']) {
    $html .= '<div class="npp_download_link"><a href="' . $args['mp3'] . '">Download this audio</a></div>';
  }

  return $html;
}

/**
 * Implements hook_field_formatter_view().
 */
function npp_jplayer_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  $element = array();

  // Require the mp3 scraper library.
  $path = dirname(__FILE__);
  require_once "$path/../npp_library.php";

  $mp3 = '';
  foreach ($items as $delta => $item) {
    if ($item['mp3']) {
      $mp3 = _npp_get_mp3($item['mp3']);
      $mp3 = check_plain($mp3);
    }
  }

  if (!$mp3) {
    return $element;
  }

  $prefix = check_plain($display['settings']['jplayer_instance_prefix']);
  $swflocation = check_plain($display['settings']['jplayer_swf_location']);
  $skin = check_plain($display['settings']['jplayer_skin_location']);
  $location = check_plain($display['settings']['jplayer_location']);
  $repeat = check_plain($display['settings']['jplayer_repeat']);
  $downloadlink = ($display['settings']['jplayer_download_link']) ? TRUE : FALSE;
  $story_title = t($entity->title);
  $margin_fix = ($display['settings']['jplayer_time_margin_fix']) ? TRUE : FALSE;

  // Generate a random string.
  $rstring = user_password(4);

  $jplayer_instance = <<<JAVASCRIPT
    jQuery(document).ready(function($){
      $("#$prefix-$rstring").jPlayer({
        ready: function () {
          $(this).jPlayer("setMedia", {
            mp3: "$mp3",
            title: "$story_title"
          });
        },
        swfPath: "$swflocation",
        supplied: "mp3",
        cssSelectorAncestor: "#npp_jp_container_1",
        useStateClassSkin: true,
        autoBlur: false,
        smoothPlayBar: true,
        keyEnabled: true,
        remainingDuration: true,
        toggleDuration: true
      });
    });
JAVASCRIPT;

  $element[0]['#markup'] = theme('jplayer', array(
    'prefix' => $prefix,
    'rstring' => $rstring,
    'repeat' => $repeat,
    'downloadlink' => $downloadlink,
    'mp3' => $mp3,
    'margin_fix' => $margin_fix,
  ));

  $element['#attached']['js'] = array(
    // Attach the jPlayer library.
    $location => array(
      'type' => 'file',
      'scope' => 'header',
    ),
    // Attach the instance.
    $jplayer_instance => array(
      'type' => 'inline',
      'scope' => 'header',
    ),
  );

  // Normally you would add this CSS via $element['#attached']['css'],
  // but the CSS wasn't rendering. This way works, though it is sloppy.
  $style = array(
    '#tag' => 'link',
    '#attributes' => array(
      'rel' => 'stylesheet',
      'type' => 'text/css',
      'href' => $skin,
    ),
  );
  drupal_add_html_head($style, 'npp_jplayer_skin');

  return $element;
}
