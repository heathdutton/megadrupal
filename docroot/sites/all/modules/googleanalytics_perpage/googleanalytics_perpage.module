<?php

/**
 * @file googleanalytics_perpage.module
 * Drupal hooks for googleanalytics_perpage module.
 */


/**
 * Implements hook_menu().
 */
function googleanalytics_perpage_menu() {
  $items['admin/config/system/googleanalytics/settings'] = array(
    'title'            => 'Site-wide Settings',
    'description'      => 'Configure tracking behavior to get insights into your website traffic and marketing effectiveness.',
    'page callback'    => 'drupal_get_form',
    'page arguments'   => array('googleanalytics_admin_settings_form'),
    'access arguments' => array('administer google analytics'),
    'type'             => MENU_DEFAULT_LOCAL_TASK,
    'file'             => drupal_get_path('module', 'googleanalytics') .'/googleanalytics.admin.inc',
    'weight'           => 0,
  );
  $items['admin/config/system/googleanalytics/perpage'] = array(
    'title'            => 'Per Page Settings',
    'description'      => 'Configure extra per-page tracking google analytics snippets.',
    'page callback'    => 'drupal_get_form',
    'page arguments'   => array('googleanalytics_perpage_form'),
    'access arguments' => array('administer google analytics'),
    'type'             => MENU_LOCAL_TASK,
    'file'             => 'includes/googleanalytics_perpage.admin.inc',
    'weight'           => 10,
  );

  return $items;
}


/**
 * Implements hook_theme().
 */
function googleanalytics_perpage_theme() {
  return array(
    'googleanalytics_perpage_snippet_table' => array('render element' => 'form', 'file' => 'includes/googleanalytics_perpage.theme.inc'),
  );
}


/**
 * Implements hook_page_alter().
 */
function googleanalytics_perpage_page_alter(&$page) {
  require_once(drupal_get_path('module', 'googleanalytics') .'/googleanalytics.module');
  global $user;

  $id = variable_get('googleanalytics_account', '');

  // Get page status code for visibility filtering.
  $status = drupal_get_http_header('Status');
  $trackable_status_codes = array(
    '403 Forbidden',
    '404 Not Found',
  );

  // 1. Check if the GA account number has a value.
  // 2. Track page views based on visibility value.
  // 3. Check if we should track the currently active user's role.
  // 4. Ignore pages visibility filter for 404 or 403 status codes.
  if (!empty($id) && (_googleanalytics_visibility_pages() || in_array($status, $trackable_status_codes)) && _googleanalytics_visibility_user($user)) {
    $result = db_query('SELECT snippet, paths FROM {googleanalytics_perpage} WHERE active = 1');
    $current_path = $_GET['q'];

    // Get the page scope setting from googleanalytics:
    $scope = variable_get('googleanalytics_js_scope', 'header');
    
    foreach ($result as $record) {
      if (drupal_match_path($current_path, $record->paths)) {
        // If a match is found for the current page, add the JS snippet.
        drupal_add_js($record->snippet, array('scope' => $scope, 'type' => 'inline'));
      }
    }
  }
}