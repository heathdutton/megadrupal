<?php

class ContentMaskTestCase extends DrupalWebTestCase {
  public static function getInfo() {
    return array(
      'name' => 'Content Mask',
      'description' => 'Ensure that the content_mask module works properly.',
      'group' => 'Content',
    );
  }

  public function setUp() {
    parent::setUp('content_mask');

    $format = new stdClass();
    $format->format = 'content_mask_format';
    $format->name = 'content_mask_format';
    $format->filters = array(
      'content_mask' => array(
        'status' => TRUE,
      ),
    );

    filter_format_save($format);

    $this->drupalCreateContentType(array(
      'type' => 'content_mask_type',
      'name' => 'content_mask_type',
    ));
  }

  public function testUserWithTheCorrectIdShouldSeeWholeContent() {
    $user = $this->drupalCreateUser(array('access content'));
    $uid = $user->uid;

    $node = array();
    $node['type'] = 'content_mask_type';
    $node['title'] = $this->randomName(8);
    $node['body'][LANGUAGE_NONE][0]['format'] = 'content_mask_format';
    $node['body'][LANGUAGE_NONE][0]['value'] = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla ac ligula non
augue scelerisque dapibus vel et ante. Pellentesque volutpat nibh ut ipsum
bibendum euismod. Ut nibh nisi, aliquam sed ornare eu, hendrerit quis nunc. Nam
vel nunc sed erat dapibus accumsan id eget nunc.

[content_mask uid='$uid']
Mauris ornare augue ac augue tempor auctor. Praesent justo ligula, convallis
quis semper a, eleifend ut mi. Etiam eleifend aliquet quam, accumsan eleifend
erat vestibulum at. Pellentesque habitant morbi tristique senectus et netus et
malesuada fames ac turpis egestas.
[/content_mask]";

    $node = $this->drupalCreateNode($node);

    // Retrieve page as the logged in user
    $this->drupalLogin($user);
    $this->drupalGet('node/' . $node->nid);
    $this->assertText("Mauris ornare augue ac augue tempor auctor. Praesent justo ligula, convallis
quis semper a, eleifend ut mi. Etiam eleifend aliquet quam, accumsan eleifend
erat vestibulum at. Pellentesque habitant morbi tristique senectus et netus et
malesuada fames ac turpis egestas.", t('Check that the user sees the full body'));
  }

  public function testUserWithTheIncorrectIdShouldSeePartContent() {
    $user = $this->drupalCreateUser(array('access content'));

    $node = array();
    $node['type'] = 'content_mask_type';
    $node['title'] = $this->randomName(8);
    $node['body'][LANGUAGE_NONE][0]['format'] = 'content_mask_format';
    $node['body'][LANGUAGE_NONE][0]['value'] = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla ac ligula non
augue scelerisque dapibus vel et ante. Pellentesque volutpat nibh ut ipsum
bibendum euismod. Ut nibh nisi, aliquam sed ornare eu, hendrerit quis nunc. Nam
vel nunc sed erat dapibus accumsan id eget nunc.

[content_mask uid='1']
Mauris ornare augue ac augue tempor auctor. Praesent justo ligula, convallis
quis semper a, eleifend ut mi. Etiam eleifend aliquet quam, accumsan eleifend
erat vestibulum at. Pellentesque habitant morbi tristique senectus et netus et
malesuada fames ac turpis egestas.
[/content_mask]";

    $node = $this->drupalCreateNode($node);

    // Retrieve page as the logged in user
    $this->drupalLogin($user);
    $this->drupalGet('node/' . $node->nid);
    $this->assertNoText("Mauris ornare augue ac augue tempor auctor. Praesent justo ligula, convallis
quis semper a, eleifend ut mi. Etiam eleifend aliquet quam, accumsan eleifend
erat vestibulum at. Pellentesque habitant morbi tristique senectus et netus et
malesuada fames ac turpis egestas.", t('Check that the user not sees the full body'));
  }

  public function testMultipleIdsCanBeSetAsAttribute() {
    $user = $this->drupalCreateUser(array('access content'));
    $uid = $user->uid;

    $node = array();
    $node['type'] = 'content_mask_type';
    $node['title'] = $this->randomName(8);
    $node['body'][LANGUAGE_NONE][0]['format'] = 'content_mask_format';
    $node['body'][LANGUAGE_NONE][0]['value'] = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla ac ligula non
augue scelerisque dapibus vel et ante. Pellentesque volutpat nibh ut ipsum
bibendum euismod. Ut nibh nisi, aliquam sed ornare eu, hendrerit quis nunc. Nam
vel nunc sed erat dapibus accumsan id eget nunc.

[content_mask uid='1|$uid']
Mauris ornare augue ac augue tempor auctor. Praesent justo ligula, convallis
quis semper a, eleifend ut mi. Etiam eleifend aliquet quam, accumsan eleifend
erat vestibulum at. Pellentesque habitant morbi tristique senectus et netus et
malesuada fames ac turpis egestas.
[/content_mask]";

    $node = $this->drupalCreateNode($node);

    // Retrieve page as the logged in user
    $this->drupalLogin($user);
    $this->drupalGet('node/' . $node->nid);
    $this->assertText("Mauris ornare augue ac augue tempor auctor. Praesent justo ligula, convallis
quis semper a, eleifend ut mi. Etiam eleifend aliquet quam, accumsan eleifend
erat vestibulum at. Pellentesque habitant morbi tristique senectus et netus et
malesuada fames ac turpis egestas.", t('Check that the user sees the full body'));
  }

  public function testUserWithTheCorrectRoleShouldSeeWholeContent() {
    $user = $this->drupalCreateUser(array('access content'));

    $node = array();
    $node['type'] = 'content_mask_type';
    $node['title'] = $this->randomName(8);
    $node['body'][LANGUAGE_NONE][0]['format'] = 'content_mask_format';
    $node['body'][LANGUAGE_NONE][0]['value'] = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla ac ligula non
augue scelerisque dapibus vel et ante. Pellentesque volutpat nibh ut ipsum
bibendum euismod. Ut nibh nisi, aliquam sed ornare eu, hendrerit quis nunc. Nam
vel nunc sed erat dapibus accumsan id eget nunc.

[content_mask role='authenticated user']
Mauris ornare augue ac augue tempor auctor. Praesent justo ligula, convallis
quis semper a, eleifend ut mi. Etiam eleifend aliquet quam, accumsan eleifend
erat vestibulum at. Pellentesque habitant morbi tristique senectus et netus et
malesuada fames ac turpis egestas.
[/content_mask]";

    $node = $this->drupalCreateNode($node);

    // Retrieve page as the logged in user
    $this->drupalLogin($user);
    $this->drupalGet('node/' . $node->nid);
    $this->assertText("Mauris ornare augue ac augue tempor auctor. Praesent justo ligula, convallis
quis semper a, eleifend ut mi. Etiam eleifend aliquet quam, accumsan eleifend
erat vestibulum at. Pellentesque habitant morbi tristique senectus et netus et
malesuada fames ac turpis egestas.", t('Check that the user sees the full body'));
  }

  public function testUserWithTheIncorrectRoleShouldSeePartContent() {
    $user = $this->drupalCreateUser(array('access content'));

    $node = array();
    $node['type'] = 'content_mask_type';
    $node['title'] = $this->randomName(8);
    $node['body'][LANGUAGE_NONE][0]['format'] = 'content_mask_format';
    $node['body'][LANGUAGE_NONE][0]['value'] = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla ac ligula non
augue scelerisque dapibus vel et ante. Pellentesque volutpat nibh ut ipsum
bibendum euismod. Ut nibh nisi, aliquam sed ornare eu, hendrerit quis nunc. Nam
vel nunc sed erat dapibus accumsan id eget nunc.

[content_mask role='administrator']
Mauris ornare augue ac augue tempor auctor. Praesent justo ligula, convallis
quis semper a, eleifend ut mi. Etiam eleifend aliquet quam, accumsan eleifend
erat vestibulum at. Pellentesque habitant morbi tristique senectus et netus et
malesuada fames ac turpis egestas.
[/content_mask]";

    $node = $this->drupalCreateNode($node);

    // Retrieve page as the logged in user
    $this->drupalLogin($user);
    $this->drupalGet('node/' . $node->nid);
    $this->assertNoText("Mauris ornare augue ac augue tempor auctor. Praesent justo ligula, convallis
quis semper a, eleifend ut mi. Etiam eleifend aliquet quam, accumsan eleifend
erat vestibulum at. Pellentesque habitant morbi tristique senectus et netus et
malesuada fames ac turpis egestas.", t('Check that the user not sees the full body'));
  }

  public function testMultipleRolesCanBeSetAsAttribute() {
    $user = $this->drupalCreateUser(array('access content'));

    debug($user);

    $node = array();
    $node['type'] = 'content_mask_type';
    $node['title'] = $this->randomName(8);
    $node['body'][LANGUAGE_NONE][0]['format'] = 'content_mask_format';
    $node['body'][LANGUAGE_NONE][0]['value'] = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla ac ligula non
augue scelerisque dapibus vel et ante. Pellentesque volutpat nibh ut ipsum
bibendum euismod. Ut nibh nisi, aliquam sed ornare eu, hendrerit quis nunc. Nam
vel nunc sed erat dapibus accumsan id eget nunc.

[content_mask role='administrator|authenticated user']
Mauris ornare augue ac augue tempor auctor. Praesent justo ligula, convallis
quis semper a, eleifend ut mi. Etiam eleifend aliquet quam, accumsan eleifend
erat vestibulum at. Pellentesque habitant morbi tristique senectus et netus et
malesuada fames ac turpis egestas.
[/content_mask]";

    $node = $this->drupalCreateNode($node);

    // Retrieve page as the logged in user
    $this->drupalLogin($user);
    $this->drupalGet('node/' . $node->nid);
    $this->assertText("Mauris ornare augue ac augue tempor auctor. Praesent justo ligula, convallis
quis semper a, eleifend ut mi. Etiam eleifend aliquet quam, accumsan eleifend
erat vestibulum at. Pellentesque habitant morbi tristique senectus et netus et
malesuada fames ac turpis egestas.", t('Check that the user sees the full body'));
  }

  public function testUserCanBypassFilterWithCorrectPermission() {
    $user = $this->drupalCreateUser(array('access content', 'bypass content_mask access'));

    $node = array();
    $node['type'] = 'content_mask_type';
    $node['title'] = $this->randomName(8);
    $node['body'][LANGUAGE_NONE][0]['format'] = 'content_mask_format';
    $node['body'][LANGUAGE_NONE][0]['value'] = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla ac ligula non
augue scelerisque dapibus vel et ante. Pellentesque volutpat nibh ut ipsum
bibendum euismod. Ut nibh nisi, aliquam sed ornare eu, hendrerit quis nunc. Nam
vel nunc sed erat dapibus accumsan id eget nunc.

[content_mask role='administrator']
Mauris ornare augue ac augue tempor auctor. Praesent justo ligula, convallis
quis semper a, eleifend ut mi. Etiam eleifend aliquet quam, accumsan eleifend
erat vestibulum at. Pellentesque habitant morbi tristique senectus et netus et
malesuada fames ac turpis egestas.
[/content_mask]";

    $node = $this->drupalCreateNode($node);

    // Retrieve page as the logged in user
    $this->drupalLogin($user);
    $this->drupalGet('node/' . $node->nid);
    $this->assertText("Mauris ornare augue ac augue tempor auctor. Praesent justo ligula, convallis
quis semper a, eleifend ut mi. Etiam eleifend aliquet quam, accumsan eleifend
erat vestibulum at. Pellentesque habitant morbi tristique senectus et netus et
malesuada fames ac turpis egestas.", t('Check that the user sees the full body'));
  }

  public function testUserCanSeeWholeContentWhenNoAttributesSet() {
    $user = $this->drupalCreateUser(array('access content'));

    $node = array();
    $node['type'] = 'content_mask_type';
    $node['title'] = $this->randomName(8);
    $node['body'][LANGUAGE_NONE][0]['format'] = 'content_mask_format';
    $node['body'][LANGUAGE_NONE][0]['value'] = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla ac ligula non
augue scelerisque dapibus vel et ante. Pellentesque volutpat nibh ut ipsum
bibendum euismod. Ut nibh nisi, aliquam sed ornare eu, hendrerit quis nunc. Nam
vel nunc sed erat dapibus accumsan id eget nunc.

[content_mask]
Mauris ornare augue ac augue tempor auctor. Praesent justo ligula, convallis
quis semper a, eleifend ut mi. Etiam eleifend aliquet quam, accumsan eleifend
erat vestibulum at. Pellentesque habitant morbi tristique senectus et netus et
malesuada fames ac turpis egestas.
[/content_mask]";

    $node = $this->drupalCreateNode($node);

    // Retrieve page as the logged in user
    $this->drupalLogin($user);
    $this->drupalGet('node/' . $node->nid);
    $this->assertText("Mauris ornare augue ac augue tempor auctor. Praesent justo ligula, convallis
quis semper a, eleifend ut mi. Etiam eleifend aliquet quam, accumsan eleifend
erat vestibulum at. Pellentesque habitant morbi tristique senectus et netus et
malesuada fames ac turpis egestas.", t('Check that the user sees the full body'));
  }
}
