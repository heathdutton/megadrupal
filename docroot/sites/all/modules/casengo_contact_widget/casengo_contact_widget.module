<?php
/**
 * @file
 * Module file for the Casengo contact widget.
 *
 * This integrates the Casengo contact widget as a popup
 * or as a block to be displayed on Drupal sites.
 */

/**
 * Implements hook_menu().
 */
function casengo_contact_widget_menu() {
  $items = array();
  $items['admin/config/services/casengo'] = array(
    'title' => 'Casengo settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('casengo_contact_widget_settings'),
    'access arguments' => array('administer site configuration'),
  );
  return $items;
}

/**
 * Implements hook_theme().
 */
function casengo_contact_widget_theme() {
  return array(
    'casengo_contact_widget_output' => array(
      'arguments' => array(
        'casengo_contact_widget_domain' => NULL,
        'casengo_contact_widget_pos' => NULL,
        'casengo_contact_widget_label' => NULL,
        'casengo_contact_widget_theme' => NULL,
      ),
    ),
  );
}

/**
 * Implements hook_page_alter().
 */
function casengo_contact_widget_page_alter(&$page) {
  if (variable_get('casengo_enable', 1)) {
    if (!variable_get('casengo_context', 0)) {
      $variables = casengo_contact_widget_add_widget();
      $page['page_bottom']['tns']['#markup'] = theme('casengo_contact_widget_output', $variables);
    }
    else {
      if ($plugin = context_get_plugin('reaction', 'casengo_contact_widget_add')) {
        if ($plugin->execute()) {
          $variables = casengo_contact_widget_add_widget();
          $page['page_bottom']['tns']['#markup'] = theme('casengo_contact_widget_output', $variables);
        }
      }
    }
  }
}

/**
 * Implements hook_context_registry().
 */
function casengo_contact_widget_context_registry() {
  return array(
    'reactions' => array(
      'casengo_contact_widget_add' => array(
        'title' => t('Casengo'),
        'plugin' => 'casengo_contact_widget_context_reaction_add',
        'description' => t('Add Casengo widget script to the page'),
      ),
    ),
  );
}

/**
 * Implements hook_ctools_plugin_api().
 */
function casengo_contact_widget_ctools_plugin_api($module, $api) {
  if ($module == 'context' && $api == 'plugins') {
    return array('version' => 3);
  }
}

/**
 * Implements hook_context_plugins().
 */
function casengo_contact_widget_context_plugins() {
  $plugins = array();
  $plugins['casengo_context_reaction_add'] = array(
    'handler' => array(
      'path' => drupal_get_path('module', 'casengo') . '/plugins',
      'file' => 'casengo_context_reaction_add.inc',
      'class' => 'casengo_context_reaction_add',
      'parent' => 'context_reaction',
    ),
  );
  return $plugins;
}

/**
 * Settings of the widget properties.
 */
function casengo_contact_widget_settings() {
  $form = array();
  $form['casengo_contact_widget_domain'] = array(
    '#type' => 'textfield',
    '#title' => t('Subdomain name'),
    '#description' => t('Enter your unique Casengo subdomain name, eg. yourcompany where the domain is yourcompany.casengo.com'),
    '#default_value' => variable_get('casengo_contact_widget_domain', ''),
  );
  $form['casengo_contact_widget_label'] = array(
    '#type' => 'textfield',
    '#title' => t('Text of label'),
    '#description' => t('Text that appears in the contact widget'),
    '#default_value' => variable_get('casengo_contact_widget_label', ''),
  );
  $form['casengo_contact_widget_theme'] = array(
    '#type' => 'select',
    '#title' => t('Theme'),
    '#description' => t('Select the color theme'),
    '#default_value' => variable_get('casengo_contact_widget_theme', ''),
    '#options' => array(
      'darkgrey' => t('Dark grey'),
      'lightgrey' => t('Light grey'),
      'white' => t('White'),
      'orange' => t('Orange'),
      'blue' => t('Blue'),
      'purple' => t('Purple'),
      'red' => t('Red'),
      'green' => t('Green')),
  );
  $form['casengo_contact_widget_pos'] = array(
    '#type' => 'radios',
    '#title' => t('Position of the contact widget'),
    '#description' => t(''),
    '#default_value' => variable_get('casengo_contact_widget_pos', ''),
    '#options' => array(
      'middle-left' => t('Middle left'),
      'middle-right' => t('Middle right'),
      'bottom-right' => t('Bottom right')),
  );

  if (module_exists('context')) {
    $form['casengo_contact_widget_context'] = array(
      '#type' => 'checkbox',
      '#title' => t('Use Context to choose when Casengo is added to the page.'),
      '#description' => t('The Casengo code will be included on all pages of your site by default. You can use <a href="!context_url">Context module</a> to fine tune when and where it will be displayed.', array('!context_url' => url('admin/structure/context'))),
      '#default_value' => variable_get('casengo_contact_widget_context', 0),
    );
  }
  return system_settings_form($form);
}

/**
 * Adding the widget itself.
 */
function casengo_contact_widget_add_widget() {
  $variables = array();
  static $added;
  if (!isset($added)) {
    global $user;
    $path = drupal_get_path('module', 'casengo');

    $cas_domain = variable_get('casengo_contact_widget_domain', '');
    $cas_pos = variable_get('casengo_contact_widget_pos', '');
    $cas_label = variable_get('casengo_contact_widget_label', '');
    $cas_theme = variable_get('casengo_contact_widget_theme', '');

    if (!isset($cas_domain)) {
      $cas_domain = '';
    }

    if (!isset($cas_pos)) {
      $cas_pos = 'middle-left';
    }

    if (!isset($cas_label)) {
      $cas_label = 'Contact';
    }

    if (!isset($cas_theme)) {
      $cas_theme = 'darkgrey';
    }

    // Add the variables to the variables array
    // to be returned for this function and passed to the theme layer.
    $variables['casengo_contact_widget_domain'] = $cas_domain;
    $variables['casengo_contact_widget_theme'] = $cas_theme;
    $variables['casengo_contact_widget_pos'] = $cas_pos;
    $variables['casengo_contact_widget_label'] = $cas_label;
    // Pass the subdomain name to be used in JavaScript.
    drupal_add_js(array('casengoContactWidget' => array('subDomainName' => $cas_domain)), 'setting');
  }
  return $variables;
}
/**
 * Preprocess function for casengo widget output.
 */
function casengo_contact_widget_preprocess_casengo_contact_widget_output(&$variables) {
  $variables['casengo_contact_widget_domain'] = check_plain($variables['casengo_contact_widget_domain']);
  $variables['casengo_contact_widget_label'] = check_plain($variables['casengo_contact_widget_label']);
  $variables['casengo_contact_widget_theme'] = check_plain($variables['casengo_contact_widget_theme']);
  $variables['casengo_contact_widget_pos'] = check_plain($variables['casengo_contact_widget_pos']);
}
/**
 * Theme function for casengo widget output.
 */
function theme_casengo_contact_widget_output($variables) {
  extract($variables);
  $output = '<div class="casengo-vipbtn"><!-- subdomain="';
  $output .= $casengo_contact_widget_domain . '" group="" label="';
  $output .= $casengo_contact_widget_label . '" position="';
  $output .= $casengo_contact_widget_pos . '" theme="';
  $output .= $casengo_contact_widget_theme . '" --></div>';
  drupal_add_js(drupal_get_path('module', 'casengo_contact_widget') . '/js/casengo_contact_widget.js');
  return $output;
}
