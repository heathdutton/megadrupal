<?php
/**
 * @file
 * Defines radiogrid form element.
 */

/**
 * Implements hook_element_info().
 */
function radiogrid_element_info() {
  $types = array();

  $types['radiogrid'] = array(
    '#input' => TRUE,
    '#process' => array('radiogrid_radiogrid_process'),
    '#theme' => 'radiogrid',
    '#theme_wrappers' => array('form_element'),
    '#default_value' => array(),
  );

  return $types;
}

/**
 * Implements hook_process().
 */
function radiogrid_radiogrid_process($element) {
  // Add required validation to radiogrid element.
  if (empty($element['#element_validate'])) {
    $element['#element_validate'] = array();
  }
  array_unshift($element['#element_validate'], 'radiogrid_radiogrid_validate');

  return $element;
}

/**
 * Implements radiogrid required validation.
 */
function radiogrid_radiogrid_validate($element) {
  if (isset($element['#required']) && $element['#required']) {
    $valid = TRUE;
    // Test for unanswered questions.
    foreach (array_keys($element['#questions']) as $key) {
      if (!isset($element['#value'][$key])) {
        // Any unanswered question fails validation.
        $valid = FALSE;
        break;
      }
    }
    if (!$valid) {
      $t = get_t();
      form_error($element,
        check_plain($t('!name field is required.',
          array('!name' => $element['#title']))
        )
      );
    }
  }
}

/**
 * Implements hook_theme().
 */
function radiogrid_theme() {
  return array(
    'radiogrid' => array(
      'render element' => 'element',
    ),
  );
}

/**
 * Implements radiogrid theme function.
 *
 * @param array $variables
 *   An associative array containing the properties of the element.
 *   Available properties:
 *    #title - Plain text.
 *    #description - Plain text.
 *    #required - TRUE or FALSE, defaults to FALSE.
 *    #value - Array of #options keys.
 *    #default_value - Array of #options keys.
 *    #intro_text - Plain text displayed between title and questions.
 *    #questions_head - Plain text displayed in the first table cell.
 *    #questions - Array of plain text questions.
 *    #options - Array of key/value options.
 *    #numbered - TRUE or FALSE, defaults to FALSE.
 *    #outro_text - Plain text displayed between questions and description.
 */
function theme_radiogrid(array $variables) {
  $element = $variables['element'];

  $output = '<table class="radiogrid" id="edit-'
          . $element['#name'] . '">' . "\n";

  $output .= '<thead>';
  if (!empty($element['#intro_text'])) {
    $output .= '<tr><td class="intro" colspan="'
            . (count($element['#options']) + 1) . '">'
            . check_plain($element['#intro_text']) . '</td></tr>' . "\n";
  }
  $output .= '<tr><td class="question-head">'
          . (empty($element['#questions_head'])
            ? '&nbsp;' : check_plain($element['#questions_head']))
          . '</td>';
  foreach ($element['#options'] as $option) {
    $output .= '<td class="option-head">' . check_plain($option) . '</td>';
  }
  $output .= '</tr></thead>' . "\n";

  $output .= '<tbody>' . "\n";
  $question_number = 0;
  $number = '';
  foreach ($element['#questions'] as $question_id => $question) {
    if (isset($element['#numbered']) && $element['#numbered']) {
      $number = '<span class="question-number">'
              . ++$question_number . '.</span> ';
    }
    $output .= '<tr><td class="question">' . $number
            . check_plain($question) . '</td>';
    foreach ($element['#options'] as $key => $option) {
      if (isset($element['#value'][$question_id])
        && $element['#value'][$question_id] == $key
      ) {
        $checked = ' checked="checked"';
      }
      else {
        $checked = '';
      }
      $output .= '<td class="option"><input type="radio" name="'
              . $element['#name'] . '[' . $question_id . ']" value="'
              . $key . '"' . $checked . '/></td>';
    }
    $output .= '</tr>' . "\n";
  }
  $output .= '</tbody>' . "\n";

  if (!empty($element['#outro_text'])) {
    $output .= '<tfoot><tr>';
    $output .= '<td class="outro" colspan="'
            . (count($element['#options']) + 1) . '">'
            . check_plain($element['#outro_text']) . '</td>';
    $output .= '</tr></tfoot>' . "\n";
  }

  $output .= '</table>' . "\n";
  return $output;
}
