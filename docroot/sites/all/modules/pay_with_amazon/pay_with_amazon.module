<?php

/**
 * @file
 * Modules file for Pay With Amazon Integration.
 */

/**
 * Implements hook_menu().
 */
function pay_with_amazon_menu() {
  $items = array();
  $path = drupal_get_path('module', 'pay_with_amazon');

  $items['admin/commerce/config/payment-methods/pay-with-amazon'] = array(
    'title' => 'Pay With Amazon',
    'description' => 'Pay With Amazon Credentials',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('pay_with_amazon_admin_settings_form'),
    'access arguments' => array('administer payment methods'),
    'file' => 'pay_with_amazon.admin.inc',
    'file path' => $path,
  );
  return $items;
}

/**
 * Implements hook_form_alter().
 */
function pay_with_amazon_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'commerce_checkout_form_checkout') {
    require_once libraries_get_path('pay_with_amazon') . '/signature/merchant/cart/html/MerchantHTMLCartFactory.php';
    require_once libraries_get_path('pay_with_amazon') . '/signature/common/cart/xml/XMLCartFactory.php';
    require_once libraries_get_path('pay_with_amazon') . '/signature/common/signature/SignatureCalculator.php';

    $merchant_id = variable_get('pay_with_amazon_merchantid', '');
    $access_key_id = variable_get('pay_with_amazon_access_key_id', '');
    $secret_key_id = variable_get('pay_with_amazon_secret_key_id', '');

    $cart_factory = new XMLCartFactory();
    $calculator = new SignatureCalculator();

    $cart = $cart_factory->getSignatureInput($merchant_id, $access_key_id);
    $signature = $calculator->calculateRFC2104HMAC($cart, $secret_key_id);
    $cart_html = $cart_factory->getCartHTML($merchant_id, $access_key_id, $signature);

    $form['cart_contents']['pay_with_amazon'] = array(
      '#markup' => '<div style = "text-align:right;">' . $cart_html . '</div>' ,
    );
  }
}
