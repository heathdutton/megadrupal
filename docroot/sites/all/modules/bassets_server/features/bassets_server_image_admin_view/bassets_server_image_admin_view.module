<?php
/**
 * @file
 * Code for the Bassets Image admin view feature.
 */

 include_once 'bassets_server_image_admin_view.features.inc';

/**
 * Implements hook_permission().
 */
function bassets_server_image_admin_view_permission() {
  $permissions = array(
    'Use image image admin replacement' => array(
      'title' => t('Use image image admin replacement'),
      'description' => t('Replacement of "admin/content/file" for users without "Aminister files" permission.'),
    ),
  );
  return $permissions;
}

/**
 * Implements hook_views_bulk_operations_form_alter().
 */
function bassets_server_image_admin_view_views_bulk_operations_form_alter(&$form, &$form_state, $vbo) {
  if ($vbo->table == 'file_managed' && $form_state['step'] == 'views_form_views_form') {
    // Alter the first step of the VBO form (the selection page).
    $access = user_access('bypass file access') || user_access('administer files');
    if (!$access) {
      $form['select']['submit']['#validate'] = array_merge(array('_bassets_server_views_form_views_form_validate'), $form['select']['submit']['#validate']);
    }
  }
}

/**
 * Validation function, which removes all selected files from the selection, when
 * the user do not have the permission to perform the action.
 */
function _bassets_server_views_form_views_form_validate($form, &$form_state) {
  $ids = array_filter($form_state['values']['views_bulk_operations']);
  $op = $form_state['values']['operation'];
  if ($op && count($ids)) {
    switch ($op) {
      case 'action::views_bulk_operations_delete_item':
        $files = entity_load('file', $ids);
        $file_names = array();
        foreach ($files as $file) {
          $access = file_entity_access('delete', $file);
          if (!$access) {
            $file_names[] = $file->filename;
            $index = array_search($file->fid, $ids);
            unset($ids[$index]);
          }
        }
        if (!empty($file_names)) {
          drupal_set_message(t('You do not have the permission to delete following files: @file_names', array('@file_names' => implode(',', $file_names))), 'warning');
        }
        $form_state['values']['views_bulk_operations'] = $ids;
        break;
      case 'action::views_bulk_operations_modify_action':
        $files = entity_load('file', $ids);
        $file_names = array();
        foreach ($files as $file) {
          $access = file_entity_access('update', $file);
          if (!$access) {
            $file_names[] = $file->filename;
            $index = array_search($file->fid, $ids);
            unset($ids[$index]);
          }
        }
        if (!empty($file_names)) {
          drupal_set_message(t('You do not have the permission to modify following files: @file_names', array('@file_names' => implode(',', $file_names))), 'warning');
        }
        $form_state['values']['views_bulk_operations'] = $ids;
        break;
    }
  }
}
