<?php
/**
 * @file
 * Administration menu exclude.
 *
 * Allows the user to specify which paths to exclude from loading
 * the administration menu.
 */

/**
 * Implements hook_help().
 */
function admin_menu_exclude_help($path, $arg) {
  switch ($path) {
    case 'admin/help#admin_menu_exclude':
      $output = '';
      $output .= '<p>' . t("The Administration menu exclude module allows you to exclude certain paths from rendering the administration menu. It can be useful for example if you are using Civicrm, as it loads its own menu bar.") . '</p>';
      $output .= '<p>' . t("It creates a new tab in the administration menu configuration page to write the url's you want to exclude.") . '</p>';
      return $output;
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function admin_menu_exclude_form_admin_menu_theme_settings_alter(&$form, &$form_state, $form_id) {
  $form['exclude'] = array(
    '#type' => 'fieldset',
    '#title' => t('Exclude'),
    '#group' => 'advanced',
  );
  $form['exclude']['admin_menu_exclude_paths'] = array(
    '#type' => 'textarea',
    '#title' => t('Exclude paths from loading administration menu'),
    '#default_value' => variable_get('admin_menu_exclude_paths', ''),
    '#description' => t('Add a line for each url you want to exclude.  You can use wildcards at the end of the url. Example: user/*'),
  );
  return system_settings_form($form);
}

/**
 * Implements hook_init().
 */
function admin_menu_exclude_init() {
  $hide = FALSE;
  $current_path = current_path();
  $custom_paths = variable_get('admin_menu_exclude_paths', '');
  if ($custom_paths != '') {
    $custom_paths = explode(PHP_EOL, $custom_paths);
    foreach ($custom_paths as $path) {
      $path = trim($path);
      if (
        drupal_match_path($current_path, $path . '/*') ||
        drupal_match_path($current_path, $path) ||
        drupal_match_path(drupal_get_path_alias($current_path), $path)
      ) {
        $hide = TRUE;
        break;
      }
    }
  }
  if ($hide) {
    module_invoke('admin_menu', 'suppress');
  }
}
