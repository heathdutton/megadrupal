<?php
// $Id: confident_captcha.module,v 1.3.2.1 2010/09/10 18:17:14 steve918 Exp $

/**
 * @file
 * Uses the Confident Technologies web service to improve the CAPTCHA system.
 */

/**
* Display help and module information
* @param section which section of the site we're displaying help
* @return help text for section
*/
function confident_captcha_help($path, $arg) {
  $output = '';
  switch ($path) {
    case 'admin/modules#name':
      $output .= t('Confident CAPTCHA');
      break;
    case 'admin/modules#description':
    case 'admin/user/captcha/confident_captcha':
      $output .= t('Uses the <a href="@url" target="_blank">Confident Technologies</a> web service to improve the CAPTCHA system.', array('@url' => url('http://confidenttechnologies.com')));
      break;
    case 'admin/help#confident_captcha':
      $output = '' . '<p>'.
        t('Uses the Confident Technologies web service to improve the CAPTCHA module. For more information on what Confident Technologies is, visit <a href="@url" target="_blank">the official website</a>.', array('@url' => url('https://login.confidenttechnologies.com'))) .
        '</p><h3>' .
        t('Configuration') .
        '</h3><p>' .
        t('The settings associated with Confident CAPTCHA can be found in the <a href="@confident_captcha_tab">Confident CAPTCHA tab</a>, in the <a href="@captchasettings">CAPTCHA settings</a>. You must set your Confident Technologies customer ID, site ID, and API username and password in order to use the module. Once done, visit the <a href="@captchasettings">CAPTCHA settings</a>, where you can choose where Confident CAPTCHA should be displayed.', array('@confident_captcha_tab' => url('admin/user/captcha/confident_captcha'), '@captchasettings' => url('admin/user/captcha'))) .
        '</p>';
      break;
  }
  return $output;
}

/**
 * Implementation of hook_menu().
 */
function confident_captcha_menu() {
  $items = array();
  $items['admin/config/people/captcha/confident_captcha'] = array(
    'title' => 'Confident Captcha',
    'description' => 'Administer the Confident CAPTCHA module.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('confident_captcha_admin_settings'),
    'access arguments' => array('administer confident captcha'),
    'type' => MENU_LOCAL_TASK,
    'file' => 'confident_captcha.admin.inc',
  );
  return $items;
}

/**
* Valid permissions for this module
* @return array An array of valid permissions for the captcha module
*/
function confident_captcha_permission() {
  return array('administer confident captcha' => array( 'title' => t('Confident Captcha Administration'),  'description' => t('Administer Confident Captcha settings'), ), );
}

/** 
 * Get Confident CAPTCHA API settings
 */
function confident_captcha_api_settings() {
  module_load_include('php', 'confident_captcha', 'confident/ConfidentCaptchaClient');
  module_load_include('php', 'confident_captcha', 'confident/ConfidentCaptchaCredentials');
  module_load_include('php', 'confident_captcha', 'confident/ConfidentCaptchaProperties');
  module_load_include('php', 'confident_captcha', 'confident/ConfidentCaptchaResponses');


  $api_settings = array(
    'customer_id' => variable_get('confident_captcha_customer_id', ''),
    'site_id' => variable_get('confident_captcha_site_id', ''),
    'api_username' => variable_get('confident_captcha_api_username', ''),
    'api_password' => variable_get('confident_captcha_api_password', ''),
    'captcha_server_url' => variable_get('confident_captcha_server_url', 'http://captcha.confidenttechnologies.com'),
    'fail_open' => variable_get('fail_open', TRUE),
    'image_code_color' => variable_get('confident_captcha_grid_color', 'Blue'),
    'display_style' => variable_get('confident_captcha_display_style', 'flyout'),
    'logo_name' => variable_get('confident_captcha_logo_name', ''),
    'billboard_name' => variable_get('confident_captcha_billboard_name', ''),
    'ip_addr' => ip_address(),
    'height' => variable_get('confident_captcha_grid_height', 3),
    'width' => variable_get('confident_captcha_grid_width', 3),
    'captcha_length' => variable_get('confident_captcha_captcha_length', 4),
  );
  return $api_settings;
}

/**
 * Confident Technologies CAPTCHA implementation of hook_captcha
 */
function confident_captcha_captcha() {
  $args = func_get_args();
  $op = array_shift($args); 
  switch ($op) {
    case 'list':
      return array('Confident CAPTCHA');

    case 'generate':
      $captcha_type = array_shift($args);
      $result = array();
      if ($captcha_type == 'Confident CAPTCHA') {

        $settings = confident_captcha_api_settings();

        $confident_captcha_client =
            new ConfidentCaptchaClient($settings['captcha_server_url']);

        $confident_captcha_credentials =
            new ConfidentCaptchaCredentials(
                $settings['api_username'],
                $settings['api_password'],
                $settings['customer_id'],
                $settings['site_id']);
        $confident_captcha_client->setCredentials($confident_captcha_credentials);

        $confident_captcha_properties = new ConfidentCaptchaProperties();
        $confident_captcha_properties->setProperty('library_version', '20120625_PHP');
        $confident_captcha_properties->setProperty('display_style', $settings["display_style"]);
        $confident_captcha_properties->setProperty('width', $settings["width"]);
        $confident_captcha_properties->setProperty('height', $settings["height"]);
        $confident_captcha_properties->setProperty('captcha_length', $settings["captcha_length"]);
        $confident_captcha_properties->setProperty('image_code_color', $settings["image_code_color"]);
        $confident_captcha_properties->setProperty('logo_name', $settings["logo_name"]);
        $confident_captcha_properties->setProperty('billboard_name', $settings["billboard_name"]);
        $confident_captcha_client->setCaptchaProperties($confident_captcha_properties);

        $confident_captcha_captcha = $confident_captcha_client->createCaptcha();

        // Check if Confident Technologies CAPTCHA is available and show Math if not
        if ($confident_captcha_captcha == "") {
          error_log("Confident Captcha: create captcha failed.");
        }
        $base = drupal_get_path('module', 'confident_captcha');
        drupal_add_js( "$base/jquery.min.js", 'module');
        $confident_captcha_captcha .=
            '<script type="text/javascript">jQuery.noConflict();
			    jQuery(".confidentcaptcha_flyout, .confidentcaptcha_lightbox")
						.parents()
						.each(function(){
						    if(jQuery(this).css("overflow") == "hidden") {
							    jQuery(this).css("overflow","visible");
							}
						});

			</script>';

        // Create the form
        $result['solution'] = TRUE;     // require TRUE to be returned
        $result['captcha_validate'] = 'confident_captcha_captcha_validate';
        $result['form']['captcha_response'] = array(
            '#type' => 'hidden',
            '#value' => 'Confident CAPTCHA',
        );

        $result['form']['captcha_form'] = array(
            '#type' => 'item',
            '#description' => $confident_captcha_captcha,
            '#required' => TRUE,
            '#value' => isset($confident_captcha_form_value) ? '<div id="confident_captcha_custom_theme_widget">' . $confident_captcha_form_value . '</div>' : NULL,
        );
      }
      return $result;      
  }
}

/**
 * Validate a Confident CAPTCHA
 */
function confident_captcha_captcha_validate($solution = NULL, $response = NULL){
  if($response == 'Confident CAPTCHA'){
		$settings = confident_captcha_api_settings();

        $confident_captcha_client =
            new ConfidentCaptchaClient($settings['captcha_server_url']);

        $confident_captcha_credentials =
            new ConfidentCaptchaCredentials(
                $settings['api_username'],
                $settings['api_password'],
                $settings['customer_id'],
                $settings['site_id']);
        $confident_captcha_client->setCredentials($confident_captcha_credentials);

        $confident_captcha_properties = new ConfidentCaptchaProperties();
        $confident_captcha_properties->setProperty('library_version', '20120625_PHP');
        $confident_captcha_properties->setProperty('display_style', $settings["display_style"]);
        $confident_captcha_properties->setProperty('width', $settings["width"]);
        $confident_captcha_properties->setProperty('height', $settings["height"]);
        $confident_captcha_properties->setProperty('captcha_length', $settings["captcha_length"]);
        $confident_captcha_properties->setProperty('image_code_color', $settings["image_code_color"]);
        $confident_captcha_client->setCaptchaProperties($confident_captcha_properties);

        $captcha_id = $_POST['confidentcaptcha_captcha_id'];
        $code = $_POST['confidentcaptcha_code'];
        $click_coordinates = $_POST['confidentcaptcha_click_coordinates'];

        $confident_captcha_validate_response =
            $confident_captcha_client->checkCaptcha($_POST, $captcha_id, $code, $click_coordinates);

        $valid = $confident_captcha_validate_response->wasCaptchaSolved();

	    return $valid;
	}
	
	return false;
}
