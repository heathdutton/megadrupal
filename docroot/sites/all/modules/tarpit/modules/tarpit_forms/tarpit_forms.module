<?php

/**
 * Implements hook_menu().
 */
function tarpit_forms_menu() {
  $items = array();
  $title = \Drupal\tarpit\Config::get('tarpit.page_title');
  $path = \Drupal\tarpit\Config::get('tarpit.tarpit_forms_path');

  $items[$path] = array(
    'title' => $title,
    'page callback' => '_tarpit_forms_get_page',
    'access arguments' => array('access tarpit'),
    'file' => 'tarpit_forms.pages.inc',
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implements hook_form_alter().
 */
function tarpit_forms_form_alter(&$form, &$form_state, $form_id) {
  $path = current_path();
  $exploded_path = explode('/', $path);
  $default_path = \Drupal\tarpit\Config::get('tarpit.tarpit_forms_path');

  if ($exploded_path[0] === $default_path) {
    $path = implode('/', $exploded_path);
  } else {
    $path = $default_path;
  }

  $config = array(
    'size' => \Drupal\tarpit\Config::get('tarpit.size'),
    'links' => \Drupal\tarpit\Config::get('tarpit.links'),
    'wordlist'  => \Drupal\tarpit\Config::get('tarpit.wordlist'),
  );

  $markup = _tarpit_generate_content($path, $config['size'], $config['links'], $config['wordlist'], 0);

  $chars = "abcdefghijklmnopqrstuvwzxyz";
  $len = strlen($chars . '0123456789_-') - 1;
  $size = round(mt_rand(30, 65)) -1;
  $class = substr($chars, mt_rand(0, strlen($chars)), 1);
  for ($i=0;$i<$size;++$i) {
    $class .= substr($chars . '0123456789_-', mt_rand(0, $len), 1);
  }

  $form[$class] = array(
    '#type' => 'container',
    '#attributes' => array(
      'class' => array($class),
    ),
    $class => array(
      '#type' => 'item',
      '#title' => 'Tarpit',
      '#markup' => $markup,
    ),
    '#attached' => array(
      'css' => array(
        array(
          'data' => 'div.' . $class .'{width:0;height:0;overflow:hidden;display:none}',
          'scope' => 'header',
          'group' => CSS_THEME,
          'type' => 'inline'
        )
      )
    )
  );
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function tarpit_forms_form_tarpit_ui_admin_settings_alter(&$form, &$form_state, $form_id) {
  $form['tarpit_forms']['tarpit_forms_path'] = array(
    '#type' => 'textfield',
    '#title' => 'Tarpit path',
    '#description' => 'Page path used to generate a tarpit. Needed in Tarpit Forms.',
    '#default_value' => \Drupal\tarpit\Config::get('tarpit.tarpit_forms_path'),
  );
}