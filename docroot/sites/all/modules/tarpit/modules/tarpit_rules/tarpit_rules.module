<?php

/**
 * Implements hook_tarpit_reaction().
 */
function tarpit_rules_tarpit_reaction($arguments) {
  $depth = count($arguments['args']);
  $depth_config = \Drupal\tarpit\Config::get('tarpit.depth');

  rules_invoke_event('tarpit', $depth, $depth_config);
}

/**
 * Rules action: Tarpit Sleep.
 */
function tarpit_rules_rules_action_sleep($sleep_min = 0, $sleep_max = 0) {
  _tarpit_sleep($sleep_min, $sleep_max);
}

/**
 * Rules action: Tarpit Generate Content.
 */
function tarpit_rules_rules_action_generate_content($words, $links, $file) {
  $text = _tarpit_generate_render_array($words, $links, $file);
  drupal_static('generate_content', $text);
}

/**
 * Rules action: Tarpit Disable Blocks.
 */
function tarpit_rules_rules_action_disable_blocks($blocks_to_disable = array()) {
  drupal_static('blocks_to_disable', $blocks_to_disable);
}

/**
 * Implements hook_block_list_alter().
 */
function tarpit_rules_block_list_alter(&$blocks) {
  $blocks_to_disable = drupal_static('blocks_to_disable', '');
  $blocks_to_disable = explode("\r\n", $blocks_to_disable);
  foreach($blocks as $key => $block) {
    $id = $block->module . '::' . $block->delta;
    if (in_array($id, $blocks_to_disable) || in_array($block->module.'::*', $blocks_to_disable) || in_array('*::*', $blocks_to_disable)) {
      if ($id != 'system::main') {
        unset($blocks[$key]);
      }
    }
  }
}

/**
 * Implements hook_page_alter().
 */
function tarpit_rules_page_alter(&$page) {
  if ($text = drupal_static('generate_content')) {
    $page['content'] = $text;
  }
}
