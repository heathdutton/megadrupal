<?php

/**
 * @file
 * Tests for Chessboard Renderer module.
 */

/**
 * Functional tests for the Chessboard Renderer filter.
 */
class ChessboardFilterTestCase extends DrupalWebTestCase {
  protected $expected;

  public static function getInfo() {

    return array(
      'name' => 'Chessboard Renderer filter functionality',
      'description' => 'Filter texts and assert that the result is the same for each supported syntax.',
      'group' => 'Chessboard Renderer',
    );
  }

  public function setUp() {
    parent::setUp('chessboard');
    module_disable(array('rdf'), FALSE);

    $image_base = file_create_url(drupal_get_path('module', 'chessboard') . '/default');

    $this->expected['starting position'] = '<div class="chessboard"><div class="row"><img class="chessboard-square" src="' . $image_base . '/rdl.png" width="40" height="40" alt="r" title="" /><img class="chessboard-square" src="' . $image_base . '/ndd.png" width="40" height="40" alt="n" title="" /><img class="chessboard-square" src="' . $image_base . '/bdl.png" width="40" height="40" alt="b" title="" /><img class="chessboard-square" src="' . $image_base . '/qdd.png" width="40" height="40" alt="q" title="" /><img class="chessboard-square" src="' . $image_base . '/kdl.png" width="40" height="40" alt="k" title="" /><img class="chessboard-square" src="' . $image_base . '/bdd.png" width="40" height="40" alt="b" title="" /><img class="chessboard-square" src="' . $image_base . '/ndl.png" width="40" height="40" alt="n" title="" /><img class="chessboard-square" src="' . $image_base . '/rdd.png" width="40" height="40" alt="r" title="" /></div><div class="row"><img class="chessboard-square" src="' . $image_base . '/pdd.png" width="40" height="40" alt="p" title="" /><img class="chessboard-square" src="' . $image_base . '/pdl.png" width="40" height="40" alt="p" title="" /><img class="chessboard-square" src="' . $image_base . '/pdd.png" width="40" height="40" alt="p" title="" /><img class="chessboard-square" src="' . $image_base . '/pdl.png" width="40" height="40" alt="p" title="" /><img class="chessboard-square" src="' . $image_base . '/pdd.png" width="40" height="40" alt="p" title="" /><img class="chessboard-square" src="' . $image_base . '/pdl.png" width="40" height="40" alt="p" title="" /><img class="chessboard-square" src="' . $image_base . '/pdd.png" width="40" height="40" alt="p" title="" /><img class="chessboard-square" src="' . $image_base . '/pdl.png" width="40" height="40" alt="p" title="" /></div><div class="row"><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /></div><div class="row"><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /></div><div class="row"><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /></div><div class="row"><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /></div><div class="row"><img class="chessboard-square" src="' . $image_base . '/pll.png" width="40" height="40" alt="P" title="" /><img class="chessboard-square" src="' . $image_base . '/pld.png" width="40" height="40" alt="P" title="" /><img class="chessboard-square" src="' . $image_base . '/pll.png" width="40" height="40" alt="P" title="" /><img class="chessboard-square" src="' . $image_base . '/pld.png" width="40" height="40" alt="P" title="" /><img class="chessboard-square" src="' . $image_base . '/pll.png" width="40" height="40" alt="P" title="" /><img class="chessboard-square" src="' . $image_base . '/pld.png" width="40" height="40" alt="P" title="" /><img class="chessboard-square" src="' . $image_base . '/pll.png" width="40" height="40" alt="P" title="" /><img class="chessboard-square" src="' . $image_base . '/pld.png" width="40" height="40" alt="P" title="" /></div><div class="row"><img class="chessboard-square" src="' . $image_base . '/rld.png" width="40" height="40" alt="R" title="" /><img class="chessboard-square" src="' . $image_base . '/nll.png" width="40" height="40" alt="N" title="" /><img class="chessboard-square" src="' . $image_base . '/bld.png" width="40" height="40" alt="B" title="" /><img class="chessboard-square" src="' . $image_base . '/qll.png" width="40" height="40" alt="Q" title="" /><img class="chessboard-square" src="' . $image_base . '/kld.png" width="40" height="40" alt="K" title="" /><img class="chessboard-square" src="' . $image_base . '/bll.png" width="40" height="40" alt="B" title="" /><img class="chessboard-square" src="' . $image_base . '/nld.png" width="40" height="40" alt="N" title="" /><img class="chessboard-square" src="' . $image_base . '/rll.png" width="40" height="40" alt="R" title="" /></div></div>';

    $this->expected['marked squares'] = '<div class="chessboard"><div class="row"><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /></div><div class="row"><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/xxl.png" width="40" height="40" alt="x" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/xxl.png" width="40" height="40" alt="x" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /></div><div class="row"><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/xxl.png" width="40" height="40" alt="x" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/xxl.png" width="40" height="40" alt="x" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /></div><div class="row"><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/nld.png" width="40" height="40" alt="N" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /></div><div class="row"><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/xxl.png" width="40" height="40" alt="x" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/xxl.png" width="40" height="40" alt="x" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /></div><div class="row"><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/xxl.png" width="40" height="40" alt="x" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/xxl.png" width="40" height="40" alt="x" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /></div><div class="row"><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /></div><div class="row"><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /></div></div>';

    $this->expected['portion'] = '<div class="chessboard"><div class="border-top"><img class="chessboard-border-h" src="' . $image_base . '/h.png" width="40" height="4" alt="" title="" /><img class="chessboard-border-h" src="' . $image_base . '/h.png" width="40" height="4" alt="" title="" /><img class="chessboard-border-h" src="' . $image_base . '/h.png" width="40" height="4" alt="" title="" /><img class="chessboard-border-c" src="' . $image_base . '/c.png" width="4" height="4" alt="" title="" /></div><div class="row"><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/rdl.png" width="40" height="40" alt="r" title="" /><img class="chessboard-square" src="' . $image_base . '/kdd.png" width="40" height="40" alt="k" title="" /><img class="chessboard-border-v" src="' . $image_base . '/v.png" width="4" height="40" alt="" title="" /></div><div class="row"><img class="chessboard-square" src="' . $image_base . '/nll.png" width="40" height="40" alt="N" title="" /><img class="chessboard-square" src="' . $image_base . '/pdd.png" width="40" height="40" alt="p" title="" /><img class="chessboard-square" src="' . $image_base . '/pdl.png" width="40" height="40" alt="p" title="" /><img class="chessboard-border-v" src="' . $image_base . '/v.png" width="4" height="40" alt="" title="" /></div><div class="row"><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-square" src="' . $image_base . '/d.png" width="40" height="40" alt="-" title="" /><img class="chessboard-border-v" src="' . $image_base . '/v.png" width="4" height="40" alt="" title="" /></div></div>';

    $this->expected['borders'] = '<div class="chessboard"><div class="border-top"><img class="chessboard-border-c" src="' . $image_base . '/c.png" width="4" height="4" alt="" title="" /><img class="chessboard-border-h" src="' . $image_base . '/h.png" width="40" height="4" alt="" title="" /><img class="chessboard-border-c" src="' . $image_base . '/c.png" width="4" height="4" alt="" title="" /></div><div class="row"><img class="chessboard-border-v" src="' . $image_base . '/v.png" width="4" height="40" alt="" title="" /><img class="chessboard-square" src="' . $image_base . '/l.png" width="40" height="40" alt="-" title="" /><img class="chessboard-border-v" src="' . $image_base . '/v.png" width="4" height="40" alt="" title="" /></div><div class="border-bottom"><img class="chessboard-border-c" src="' . $image_base . '/c.png" width="4" height="4" alt="" title="" /><img class="chessboard-border-h" src="' . $image_base . '/h.png" width="40" height="4" alt="" title="" /><img class="chessboard-border-c" src="' . $image_base . '/c.png" width="4" height="4" alt="" title="" /></div></div>';

    $privileged_user = $this->drupalCreateUser(array('administer filters'));
    $this->drupalLogin($privileged_user);
    $edit_fields = array('filters[chessboard_filter_diagram][status]' => TRUE);
    $this->drupalPost('admin/config/content/formats/filtered_html', $edit_fields, 'Save configuration');
    $this->drupalLogout();
  }

  public function testChessboardFilterProcessField() {
    $expected = '';
    $expected .= $this->expected['starting position'];
    $expected .= $this->expected['marked squares'];
    $expected .= $this->expected['borders'];

    $text = '';

    // Starting position.
    $text .= '[chessboard]rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR[/chessboard]';

    // Marked squares.
    $text .= '[chessboard]8/3x1x2/2x3x1/4N3/2x3x1/3x1x2/8/8[/chessboard]';

    // Borders.
    $text .= '[chessboard](1TRBL)1[/chessboard]';

    $settings = array(
      'body' => array(LANGUAGE_NONE => array(array('value' => $text))),
    );
    $node = $this->drupalCreateNode($settings);
    $this->drupalGet('node/' . $node->nid);
    $this->assertRaw($expected);
  }

  public function testChessboardFilterProcessSimple() {
    $expected = '';
    $expected .= $this->expected['starting position'];
    $expected .= $this->expected['marked squares'];
    $expected .= $this->expected['portion'];

    $text = '';

    // Starting position.
    $text .= '[chessboard]
rnbqkbnr
pppppppp
--------
--------
--------
--------
PPPPPPPP
RNBQKBNR
[/chessboard]';

    // Marked squares.
    $text .= '[chessboard]
--------
---x-x--
--x---x-
----N---
--x---x-
---x-x--
--------
--------
[/chessboard]';

    // Portion of a chessboard.
    $text .= '[chessboard](d3TR)
-rk
Npp
---
[/chessboard]';

    $settings = array(
      'body' => array(LANGUAGE_NONE => array(array('value' => $text))),
    );
    $node = $this->drupalCreateNode($settings);

    $this->drupalGet('node/' . $node->nid);
    $this->assertRaw($expected);
  }

  public function testChessboardFilterProcessMixture() {
    $expected = $this->expected['starting position'];

    $text = '';

    // Starting position.
    $text .= '[chessboard]
rnbqkbnr
pppppppp
8/8/8/8
PPPPPPPP
RNBQKBNR
[/chessboard]';

    $settings = array(
      'body' => array(LANGUAGE_NONE => array(array('value' => $text))),
    );
    $node = $this->drupalCreateNode($settings);
    $this->drupalGet('node/' . $node->nid);
    $this->assertRaw($expected);
  }

  public function testChessboardFilterProcessAttached() {
    $media = 'all';
    $file = drupal_get_path('module', 'chessboard') . '/chessboard.css';
    $query_string = variable_get('css_js_query_string', '0');
    $raw = '<link type="text/css" rel="stylesheet" href="' . file_create_url($file) . '?' . $query_string . '" media="' . $media . '"';

    $node = $this->drupalCreateNode(array());

    // Assert that no chessboard structures are added to pages yet.
    $this->drupalGet('node/' . $node->nid);
    $this->assertNoRaw($raw);

    $settings = array(
      'body' => array(LANGUAGE_NONE => array(array('value' => '[chessboard]rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR[/chessboard]'))),
      'nid' => $node->nid,
      'vid' => $node->vid,
    );
    $node = $this->drupalCreateNode($settings);

    // Activate the adding to the page of chessboard structures.
    $this->drupalGet('node/' . $node->nid);

    // Assert presence of chessboard structures (markup not retrieved from cache).
    $this->drupalGet('node/' . $node->nid);
    $this->assertRaw($raw);

    // Assert presence of chessboard structures (markup retrieved from cache).
    $this->drupalGet('node/' . $node->nid);
    $this->assertRaw($raw);
  }
}
