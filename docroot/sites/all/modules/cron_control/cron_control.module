<?php

/**
 * @file
 * Using Cron Control you're able to fine-tune Drupal's cron,
 * especially in clustered environments.
 * Using the current version of Cron Control, you'll be able to turn on
 * or off individual cron jobs or define the server on which they should run.
 *
 * @author
 *   Markus Kalkbrenner | bio.logis GmbH
 */

/**
 * Implements hook_module_implements_alter().
 */
function cron_control_module_implements_alter(&$implementations, $hook) {
  if ('cron' == $hook) {
    $server_addr = isset($_SERVER['SERVER_ADDR']) ? $_SERVER['SERVER_ADDR'] : '127.0.0.1';
    foreach ($implementations as $module => $group) {
      if ('cron_control' != $module) {
        $result = db_merge('cron_control_jobs')
          ->key(array(
            'module' => $module,
            'server_addr' => $server_addr,
            ))
          ->fields(array(
            'module' => $module,
            'server_addr' => $server_addr,
            ))
          ->execute();
        unset($implementations[$module]);
      }
    }
  }
}

/**
 * Implements hook_modules_disabled().
 */
function cron_control_modules_disabled($modules) {
  foreach ($modules as $module) {
    db_delete('cron_control_jobs')
      ->condition('module', $module)
      ->execute();
  }
}

/**
 * Implements hook_cron().
 */
function cron_control_cron() {
  $server_addr = isset($_SERVER['SERVER_ADDR']) ? $_SERVER['SERVER_ADDR'] : '127.0.0.1';

  if (variable_get('cron_control_temp_disable_global', FALSE)) {
    drupal_set_message(t('Cron jobs are disabled temporarily.'), 'warning');
    watchdog(
      'cron',
      'Cron jobs are disabled globally by the cron control configuration. No jobs executed on server %server_addr.',
      array('%server_addr' => $server_addr,),
      WATCHDOG_WARNING
    );
    return;
  }

  $modules_invoked = array();
  if ($result =
    db_select('cron_control_jobs', 'ccj')
      ->fields('ccj')
      ->condition('server_addr', $server_addr)
      ->execute()) {
    while ($job = $result->fetchObject()) {
      if ($job->active) {
        module_invoke($job->module, 'cron');
        $modules_invoked[] = $job->module;
      }
    }
  }
  watchdog('cron', 'Cron run completed on server %server_addr. Modules invoked: %modules_invoked', array('%server_addr' => $server_addr, '%modules_invoked' => implode(', ', $modules_invoked)), WATCHDOG_NOTICE);
}

/**
 * Implements hook_menu().
 */
function cron_control_menu() {
  $items = array();

  $items['admin/config/system/cron/cron'] = array(
    'title' => 'Cron',
    'description' => 'Manage automatic site maintenance tasks.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('system_cron_settings'),
    'access arguments' => array('administer site configuration'),
    'file' => 'system.admin.inc',
    'weight' => 0,
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );

  $items['admin/config/system/cron/cron_control'] = array(
    'title' => 'Cron Control',
    'description' => "Fine-tune Drupal cron's behaviour, also in a clustered environment",
    'access callback' => 'user_access',
    'access arguments' => array('administer cron jobs'),
    'file' => 'cron_control_admin.inc',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('cron_control_jobs_form', 'server_addr'),
    'weight' => 10,
    'type' => MENU_LOCAL_TASK,
  );

  $items['admin/config/system/cron/cron_control/jobs_by_server_addr'] = array(
    'title' => 'By server address',
    'description' => "Fine-tune Drupal cron's behaviour, also in a clustered environment",
    'access callback' => 'user_access',
    'access arguments' => array('administer cron jobs'),
    'file' => 'cron_control_admin.inc',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('cron_control_jobs_form', 'server_addr'),
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => 1,
  );

  $items['admin/config/system/cron/cron_control/jobs_by_module'] = array(
    'title' => 'By module',
    'description' => "Fine-tune Drupal cron's behaviour, also in a clustered environment",
    'access callback' => 'user_access',
    'access arguments' => array('administer cron jobs'),
    'file' => 'cron_control_admin.inc',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('cron_control_jobs_form', 'module'),
    'type' => MENU_LOCAL_TASK,
    'weight' => 2,
  );

  return $items;
}


/**
 * Implements hook_permission().
 */
function cron_control_permission() {
  return array(
    'administer cron jobs' => array(
      'title' => t('administer cron jobs'),
      'description' => t('TODO Add a description for "administer cron jobs"'),
    ),
  );
}
