<?php
/**
 * @file
 * Installation, uninstallation and update functions.
 */

/**
 * Upgrade broken schema for double_field and auxiliary content field.
 */
function advanced_page_update_7001(&$sandbox) {
  // Get the current settings.
  $result = db_query('SELECT data FROM {field_config} WHERE field_name = :name', array(':name' => 'field_advanced_page_aux_content'))->fetchField();

  // Change the settings.
  $data = unserialize($result);
  $data['settings']['first'] = array(
    'type' => 'varchar',
    'maxlength' => '255',
    'size' => 'normal',
    'precision' => '10',
    'scale' => '2',
  );
  $data['settings']['second'] = array(
    'type' => 'text',
    'maxlength' => '4096',
    'size' => 'normal',
    'precision' => '10',
    'scale' => '2',
  );
  unset($data['settings']['first_maxlength']);
  unset($data['settings']['second_maxlength']);
  unset($data['indexes']['second']);

  // Write settings back to the database.
  db_update('field_config')
    ->fields(array('data' => serialize($data)))
    ->condition('field_name', 'field_advanced_page_aux_content')
    ->execute();

  db_query("ALTER TABLE field_data_field_advanced_page_aux_content MODIFY COLUMN `field_advanced_page_aux_content_second` longtext CHARACTER SET utf8mb4");
  db_query("ALTER TABLE field_revision_field_advanced_page_aux_content MODIFY COLUMN `field_advanced_page_aux_content_second` longtext CHARACTER SET utf8mb4");

  drupal_set_message("Database update complete. Please revert the advanced_page feature to complete the process. (drush fr advanced_page)", 'status');
}
