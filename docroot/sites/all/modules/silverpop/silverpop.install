<?php

/**
 * @file
 * Install file for the silverpop module.
 */

/**
 * Implements hook_uninstall().
 */
function silverpop_uninstall() {
  variable_del('silverpop_tracked_domains');
  variable_del('silverpop_script_src');

}

/**
 * Implements hook_schema().
 */
function silverpop_schema() {
  $schema = array();

  $schema['silverpop_settings'] = array(
    'description' => 'Stores event IDs and classes for silverpop tracking',
    'fields' => array(
      'id' => array(
        'type' => 'serial',
        'not null' => TRUE,
        'description' => 'Primary Key: Unique ID.',
      ),
      'event_name' => array(
        'type' => 'varchar',
        'length' => 255,
        'not null' => TRUE,
        'default' => '',
        'description' => 'Event friendly name to track.',
      ),
      'event_type' => array(
        'type' => 'varchar',
        'length' => 255,
        'not null' => TRUE,
        'default' => '',
        'description' => 'Event type to track.',
      ),
      'css_selector' => array(
        'type' => 'varchar',
        'length' => 255,
        'not null' => TRUE,
        'default' => '',
        'description' => 'CSS selector of site link to track clicks.',
      ),
    ),
    'primary key' => array('id'),
  );

  return $schema;
}

/**
 * Encrypt Silverpop password.
 */
function silverpop_update_7000(&$sandbox) {
  $password = variable_get('silverpop_password', '');

  // We are going to encrypt.
  if ($password AND function_exists('mcrypt_encrypt')) {
    $key = drupal_get_hash_salt();

    $ciphertext = mcrypt_encrypt(MCRYPT_RIJNDAEL_128, $key, $password, MCRYPT_MODE_CBC);
    $ciphertext_base64 = base64_encode($ciphertext);

    // Store encrypted password.
    variable_set('silverpop_password', $ciphertext_base64);
  }
}

/**
 * Upgrade password to latest encryption.
 */
function silverpop_update_7001() {
  $password = _silverpop_get_password_7001();
  variable_set('silverpop_password', silverpop_set_password($password));
}

/**
 * Silverpop get password at schema_version 7001.
 *
 * @return string
 */
function _silverpop_get_password_7001() {
  $password = variable_get('silverpop_password', '');

  // If mcrypt is being used we need to decrypt the password.
  if ($password AND function_exists('mcrypt_encrypt')) {
    $key = substr(drupal_get_hash_salt(), 0, 32);
    $ciphertext_dec = base64_decode($password);
    $plaintext_dec = mcrypt_decrypt(MCRYPT_RIJNDAEL_128, $key, $ciphertext_dec, MCRYPT_MODE_CBC);

    return rtrim($plaintext_dec, "\0");
  }
  elseif ($password) {
    return $password;
  }
  else {
    return '';
  }
}
