<?php

/**
 * @file
 * Allows you to quickly stylize quotations that appear on your site.
 */

/**
 * Implements hook_menu().
 */
function quotations_menu() {
  $items = array();
  $items['admin/config/user-interface/quotations'] = array(
    'title' => 'Quotations',
    'description' => 'Settings for the quotations that appear on your site.',
    'access arguments' => array('administer site configuration'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('_quotations_admin_settings'),
    'type' => MENU_NORMAL_ITEM
  );
  return $items;
}

/**
 * Builder function for admin settings form.
 * Build the admin interface where the user specifies the id or class that is to be used as the "quotation" div.
 * They should also specify an "attribution" div.
 */
function _quotations_admin_settings() {
  $form = array();
  $form['quotations_quotation_class'] = array(
    '#type' => 'textfield',
    '#title' => 'Quotation Class',
    '#default_value' => variable_get('quotations_quotation_class', ''),
    '#description' => t('What portion of the page should be stylized by the Quotations module? You may enter either a CSS class attribute or a CSS id attribute.<br />For example, if you want text within &lt;div class="my-quotation"&gt; to be stylized, enter <strong>.my-quotation</strong>.<br />If using a CSS id, use the format <strong>#my-quotation</strong>.'),
    '#required' => TRUE,
  );
  $form['quotations_quotation_italics'] = array(
    '#type' => 'radios',
    '#title' => t('Italicize Quotation'),
    '#default_value' => variable_get('quotations_quotation_italics', 0),
    '#options' => array(t('No'), t('Yes')),
    '#required' => TRUE,
  );
  // Then they need to pick the quotation images that they wish to use.
  // Radio buttons with the images below.
  $form['quotations_marks_choice'] = array(
    '#type' => 'radios',
    '#title' => t('Quotation Marks'),
    '#default_value' => variable_get('quotations_marks_choice', ''),
    '#options' => array(
      'q_set1_light' => t('Light Set 1') . '<br /><div class="quotations-quotation quotations-set1-light">Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Morbi commodo, ipsum sed pharetra gravida, orci magna rhoncus neque, id pulvinar odio lorem non turpis. Nullam sit amet enim.</div>',
      'q_set1_dark' => t('Dark Set 1') . '<br /><div class="quotations-quotation quotations-set1-dark">Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Morbi commodo, ipsum sed pharetra gravida, orci magna rhoncus neque, id pulvinar odio lorem non turpis. Nullam sit amet enim.</div>',
      'q_set2_light' => t('Light Set 2') . '<br /><div class="quotations-quotation quotations-set2-light">Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Morbi commodo, ipsum sed pharetra gravida, orci magna rhoncus neque, id pulvinar odio lorem non turpis. Nullam sit amet enim.</div>',
      'q_set2_dark' => t('Dark Set 2') . '<br /><div class="quotations-quotation quotations-set2-dark">Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Morbi commodo, ipsum sed pharetra gravida, orci magna rhoncus neque, id pulvinar odio lorem non turpis. Nullam sit amet enim.</div>',
      'q_set3_light' => t('Light Set 3') . '<br /><div class="quotations-quotation quotations-set3-light">Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Morbi commodo, ipsum sed pharetra gravida, orci magna rhoncus neque, id pulvinar odio lorem non turpis. Nullam sit amet enim.</div>',
      'q_set3_dark' => t('Dark Set 3') . '<br /><div class="quotations-quotation quotations-set3-dark">Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Morbi commodo, ipsum sed pharetra gravida, orci magna rhoncus neque, id pulvinar odio lorem non turpis. Nullam sit amet enim.</div>',
      'q_set4_light' => t('Light Set 4') . '<br /><div class="quotations-quotation quotations-set4-light">Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Morbi commodo, ipsum sed pharetra gravida, orci magna rhoncus neque, id pulvinar odio lorem non turpis. Nullam sit amet enim.</div>',
      'q_set4_dark' => t('Dark Set 4') . '<br /><div class="quotations-quotation quotations-set4-dark">Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Morbi commodo, ipsum sed pharetra gravida, orci magna rhoncus neque, id pulvinar odio lorem non turpis. Nullam sit amet enim.</div>',
      'q_set5_light' => t('Light Set 5') . '<br /><div class="quotations-quotation quotations-set5-light">Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Morbi commodo, ipsum sed pharetra gravida, orci magna rhoncus neque, id pulvinar odio lorem non turpis. Nullam sit amet enim.</div>',
      'q_set5_dark' => t('Dark Set 5') . '<br /><div class="quotations-quotation quotations-set5-dark">Lorem ipsum dolor sit amet, consectetuer adipiscing elit. Morbi commodo, ipsum sed pharetra gravida, orci magna rhoncus neque, id pulvinar odio lorem non turpis. Nullam sit amet enim.</div>',
    ),
    '#required' => TRUE,
  );
  $form['quotations_quotation_placement'] = array(
    '#type' => 'radios',
    '#title' => t('Quotation Marks Placement'),
    '#description' => t('Where do you want the quotation marks to appear in relation to the text of the quotation?'),
    '#default_value' => variable_get('quotations_quotation_placement', 'top_bottom'),
    '#options' => array(
      'top_bottom' => t('Top/Bottom'),
      'left_right' => t('Left/Right')
    ),
    '#required' => TRUE,
  );
  $form['quotations_attribution_class'] = array(
    '#type' => 'textfield',
    '#title' => 'Attribution Class',
    '#default_value' => variable_get('quotations_attribution_class', ''),
    '#description' => t('If you are going to have a separate section on the page where you attribute a quote to a particular person or organization, please enter the applicable CSS class or id using the same format as above.'),
    '#required' => FALSE,
  );
  $form['quotations_attribution_italics'] = array(
    '#type' => 'radios',
    '#title' => t('Italicize Attribution'),
    '#default_value' => variable_get('quotations_attribution_italics', 0),
    '#options' => array(t('No'), t('Yes')),
    '#required' => FALSE,
  );
  $form['quotations_attribution_prepend'] = array(
    '#type' => 'textfield',
    '#title' => 'Attribution Prepended Characters',
    '#default_value' => variable_get('quotations_attribution_prepend', ''),
    '#description' => t('If you would like to have a character or two prepended at the beginning of your attribution, such as a dash (-) or a tilde (~), you may add that here. You can add spaces here too.'),
    '#required' => FALSE,
    '#size' => 4,
  );

  $form = system_settings_form($form);
  $form['#submit'][] = '_quotations_admin_settings_submit';
  return $form;
}

/**
 * Function to build the css file in their files directory.  Make a new directory called "quotations".
 */
function _quotations_admin_settings_submit($form, &$form_state) {
  // Also, set a variable called "quotations_css_path".
  $files_directory_path = drupal_realpath('public://');
  $quotations_css_path_dir = $files_directory_path . '/quotations';
  $quotations_css_path = $quotations_css_path_dir . '/quotations-custom.css';
  $quotations_stream_wrapper_path_dir = 'public://quotations'; // Used in hood_uninstall.
  $quotations_stream_wrapper_path = 'public://quotations/quotations-custom.css'; // Used in file_save_data.
  $original_css = drupal_get_path('module', 'quotations') . '/quotations.css';
  variable_set('quotations_css_path', $quotations_css_path);
  variable_set('quotations_stream_wrapper_path_dir', $quotations_stream_wrapper_path_dir);
  variable_set('quotations_stream_wrapper_path', $quotations_stream_wrapper_path);
  // Check the destination directory.
  file_prepare_directory($quotations_css_path_dir, FILE_CREATE_DIRECTORY);

  // Read the original.
  $file = fread(fopen($original_css, "r"), 100000);

  // Remove previews section of the CSS file.
  $file = preg_replace('/\n\/\* Previews \*\/[^%]*/', '', $file);
  // Replace stuff as requested by the admin.
  // TODO: Need to modify the base classes to use what they asked for, add in italics, etc.
  if ($form_state['values']['quotations_quotation_italics'] == TRUE) {
    $file = str_replace('.quotations-quotation {', ".quotations-quotation {\n  font-style: italic;", $file);
  }
  if ($form_state['values']['quotations_attribution_italics'] == TRUE) {
    $file = str_replace('.quotations-attribution {', ".quotations-attribution {\n  font-style: italic;", $file);
  }
  $file = str_replace('.quotations-quotation', $form_state['values']['quotations_quotation_class'], $file);
  $file = str_replace('.quotations-attribution', $form_state['values']['quotations_attribution_class'], $file);
  $file = str_replace('q_set1_light', $form_state['values']['quotations_marks_choice'], $file);
  if ($form_state['values']['quotations_quotation_placement'] == 'left_right') {
    $file = str_replace('padding: 52px 20px 0 30px;', 'padding: 25px 70px 0 80px;', $file);
    $file = str_replace('margin: 0 -30px 0 0;', 'margin: -30px -70px 0 0;', $file);
  }
  if (!empty($form_state['values']['quotations_attribution_prepend'])) {
    $file = str_replace('content: "";', 'content: "' . check_plain($form_state['values']['quotations_attribution_prepend']) . '";', $file);
  }
  // Also, point to the module's images directory.
  $file = str_replace('(images', '(' . base_path() . drupal_get_path('module', 'quotations') . '/images', $file);

  // Copy over the custom stylesheet if it already exists.
  file_save_data($file, $quotations_stream_wrapper_path, FILE_EXISTS_REPLACE);
  // Flush CSS cache.
  drupal_flush_all_caches();
}

/**
 * Implements hook_init().
 */
function quotations_init() {
  // Add the base CSS file included with the module.
  drupal_add_css(drupal_get_path('module', 'quotations') . '/quotations.css');
  // Add CSS to the page based on the admin's selections on the admin settings form.
  $quotations_css_path = variable_get('quotations_css_path', '');
  if (!empty($quotations_css_path)) {
    drupal_add_css($quotations_css_path);
  }
}

/**
 * Implements hook_help().
 */
function quotations_help($path, $arg) {
  switch ($path) {
    case 'admin/help#quotations':
      $output = '<p>' . t('The Quotations module is used to quickly and easily add styling to quotations that you want to appear on your site. It includes default sets of images and CSS that you can apply to specific CSS classes that appear on your site. Quotations are most often built in Drupal blocks.</p><p>Two common uses of the module are to 1) manually create a custom block that contains a quotation on the <a href="/admin/admin/block">blocks page</a> and add some CSS wrapper divs to affect the styling of the block or to 2) create a block using the Views module and then use the Quotations configuration page to adjust the default display of the Views block. In order to enable the functionality of the Quotations module, you will need to make sure that you have configured the behavior of the module at the administration pages listed at the bottom of this page.') . '</p>';
      $output .= '<h2>' . t('Displaying Your Quotations') . '</h2>';
      $output .= '<h3>' . t('Method 1: Build Your Own Block') . '</h3>';
      $output .= '<p>' . t('If you have just a single quotation or two that need to appear somewhere on your site, you may wish to use this method:') . '</p>';
      $output .= '<ol><li>Visit the <a href="/admin/structure/block">blocks page</a> and add a new block</li>';
      $output .= '<li>Add the quotation to the block and wrap a div around the quotation text with whatever CSS class you like. It can be named whatever you like.</li>';
      $output .= '<li>Add the attribution (name of the person or organization who wrote or spoke the quotation) to the block and wrap a div around the attribution text with whatever CSS class you like. It can be named whatever you like, but should be different from the CSS class used in the previous step.</li>';
      $output .= '<li>' . t('Save the block and then assign it to one of the regions in the theme that you are using.') . '</li>';
      $output .= '<li>' . t('Visit the <a href="/admin/config/user-interface/quotations">Quotations administration page</a> and enter in your preferences along with the two CSS classes that you just created.') . '</li>';
      $output .= '<li>' . t('Done! Your quotations should now be styled in the manner that you specified.') . '</li></ol><p>&nbsp;</p>';
      $output .= '<h3>' . t('Method 2: Build a View and Style It') . '</h3>';
      $output .= '<p>' . t('If you have multiple quotations that will appear throughout your site (perhaps randomly), you may want to follow these instructions:') . '</p>';
      $output .= '<ol><li>' . t('Create a content type called "Quotation" that has two fields: "quotation body" and "attribution". The attribution field will contain the name of the person or organization who wrote or said the quotation.') . '</li>';
      $output .= '<li>' . t('Enter in a few sample quotations so that you can get started.') . '</li>';
      $output .= '<li>' . t('Build a view using the Views module that shows the content of both the "quotation body" and "attribution" fileds.') . '</li>';
      $output .= '<li>' . t('Add a "block" display to your view.') . '</li>';
      $output .= '<li>' . t('Assign the block to one of the regions in the theme that you are using.') . '</li>';
      $output .= '<li>' . t('Visit a page where your quotation block is showing and take a look at the HTML by viewing the source of the page.') . '</li>';
      $output .= '<li>' . t('Find one of the CSS classes that wraps around the "quotation body" field contents.') . '</li>';
      $output .= '<li>' . t('Find one of the CSS classes that wraps around the "attribution" field contents.') . '</li>';
      $output .= '<li>' . t('Visit the <a href="/admin/config/user-interface/quotations">Quotations administration page</a> and enter in your preferences along with the two CSS classes that you just uncovered.') . '</li>';
      $output .= '<li>' . t('Done! Your quotations should now be styled in the manner that you specified.') . '</li></ol><p>&nbsp;</p>';
      return $output;
      break;
    case 'admin/settings/modules#description':
      return t('Allows you to quickly stylize quotations that appear on your site.');
      break;
  }
}