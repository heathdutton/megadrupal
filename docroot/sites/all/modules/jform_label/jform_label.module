<?php
/**
 * @file
 * This will handle the form ids and add jform_label.js when required.
 */

/**
 * Implements hook_perm().
 */
function jform_label_permission() {
  $permissions['administer jform label'] = array(
    'title' => t('Administer settings for Jform Label.'),
  );
  return $permissions;
}

/**
 * Implements hook_menu().
 */
function jform_label_menu() {
  $items['admin/config/user-interface/jform_label'] = array(
    'title' => 'Jquery Form Label',
    'description' => 'Jquery Form label settings form.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('_jform_label_settings_form', 5),
    'access arguments' => array('administer jform label'),
  );
  return $items;
}

/**
 * Form builder for the jform label configuration form.
 */
function _jform_label_settings_form($form_state) {
  $form['jform_label_focused_color'] = array(
    '#type' => 'textfield',
    '#title' => t('Focused color'),
    '#description' => t('Enter focused color (e.g. #227799)'),
    '#default_value' => variable_get('jform_label_focused_color', '#000000'),
    '#required' => TRUE,
  );
  $form['jform_label_focused_bgcolor'] = array(
    '#type' => 'textfield',
    '#title' => t('Focused background color'),
    '#description' => t('Enter focused background color (e.g. #227799)'),
    '#default_value' => variable_get('jform_label_focused_bgcolor', '#f1f1f1'),
    '#required' => TRUE,
  );
  $form['jform_label_fade_opacity'] = array(
    '#type' => 'textfield',
    '#title' => t('Fade opacity value'),
    '#description' => t('Enter fade opacity value between 0.0 to 1.0'),
    '#default_value' => variable_get('jform_label_fade_opacity', 0.5),
    '#required' => TRUE,
  );
  $form['jform_label_fade_duration'] = array(
    '#type' => 'textfield',
    '#title' => t('Fade duration value'),
    '#description' => t('Enter fade duration value (e.g. 300)'),
    '#default_value' => variable_get('jform_label_fade_duration', 300),
    '#required' => TRUE,
  );
  $form['jform_label_form_ids'] = array(
    '#type' => 'textarea',
    '#title' => t('HTML Form IDs'),
    '#description' => t('HTML form id without # sign, each per line.'),
    '#default_value' => variable_get('jform_label_form_ids', ''),
    '#required' => TRUE,
    '#wysiwyg' => FALSE,
  );
  return system_settings_form($form);
}

/**
 * Implements hook_form_FORM_ID_validate().
 */
function _jform_label_settings_form_validate($form, &$form_state) {
  // Validate fields.
  if (!preg_match('/^#[a-f0-9]{6}$/i', $form_state['values']['jform_label_focused_color'])) {
    form_set_error('jform_label_focused_color', t('Please enter valid value in Focused color (e.g. #f1f1f1).'));
  }
  if (!preg_match('/^#[a-f0-9]{6}$/i', $form_state['values']['jform_label_focused_bgcolor'])) {
    form_set_error('jform_label_focused_bgcolor', t('Please enter valid value in Focused background color (e.g. #f1f1f1).'));
  }
  if (!(is_numeric($form_state['values']['jform_label_fade_opacity']) &&
          $form_state['values']['jform_label_fade_opacity'] <= 1.0 &&
          $form_state['values']['jform_label_fade_opacity'] >= 0.0)) {
    form_set_error('jform_label_fade_opacity', t('Fade opacity should be between 0.0 to 1.0.'));
  }
  if (!is_numeric($form_state['values']['jform_label_fade_duration'])) {
    form_set_error('jform_label_fade_duration', t('Fade duration should be numeric value.'));
  }
}

/**
 * Implments hook_page_alter().
 *
 * This attach jquery code to perform actions.
 */
function jform_label_page_alter(&$page) {
  global $_jform_label;
  $jform_selector = array();
  if (variable_get('jform_label_form_ids', false)){
    $jform_ids = preg_split('/(\r\n?|\n)/', variable_get('jform_label_form_ids', NULL));
    if (!empty($_jform_label)) {
      foreach ($_jform_label as $html_form_id) {
        if (in_array($html_form_id, $jform_ids)) {
          $jform_selector[] = "#" . $html_form_id;
        }
      }
    }
    // Attach js file to build action.
    if (!empty($jform_selector)) {
      drupal_add_js(drupal_get_path('module', 'jform_label') . '/jform_label.js');
      $setting = array();
      $setting['jformLabelFocusedColor'] = variable_get('jform_label_focused_color', '#ffffff');
      $setting['jformLabelFocusedBgColor'] = variable_get('jform_label_focused_bgcolor', '#222222');
      $setting['jformLabelFadeOpacity'] = variable_get('jform_label_fade_opacity', 0.5);
      $setting['jformLabelFadeDuration'] = variable_get('jform_label_fade_duration', 200);
      drupal_add_js($setting, 'setting');
      drupal_add_js('jQuery(document).ready(function ($) { $("' . implode(",", $jform_selector) . '").formLabel();});', array('type' => 'inline', 'scope' => 'footer'));
    }
  }
}

/**
 * Implements hook_form_alter().
 *
 * @global $_jform_label
 */
function jform_label_form_alter(&$form, &$form_state, $form_id) {
  global $_jform_label;
  $_jform_label[] = $form['#id'];
}
