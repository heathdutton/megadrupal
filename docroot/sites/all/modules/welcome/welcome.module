<?php
/**
 * @file
 * Module file for welcome
 */

/**
 * Implements hook_menu().
 */
function welcome_menu() {
  $items['admin/config/people/welcome'] = array(
    'title' => 'Welcome message configure',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('welcome_admin_settings'),
    'access arguments' => array('administer users'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'welcome.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_user_login().
 */
function welcome_user_login(&$edit, $account) {
  $message = welcome_get_message($account);
  if ($message) {
    $message_replaced = token_replace($message, array('user' => $account));
    drupal_set_message(t($message_replaced));
  }
}

/**
 * Implements hook_theme().
 */
function welcome_theme() {
  return array(
    'welcome_admin_settings' => array(
      'render element' => 'form',
      'file' => 'welcome.admin.inc',
    ),
  );
}

/**
 * Get message for current user.
 */
function welcome_get_message($account) {
  $roles = $account->roles;
  $rid = array_keys($roles);

  $query = db_select('welcome_message', 'wm')
    ->fields('wm', array('rid', 'message', 'weight'))
    ->condition('rid', $rid, 'IN')
    ->orderBy('weight', 'ASC')
    ->range(0, 1);

  $result = $query->execute();
  $message = $result->fetch();

  if ($message) {
    $user_message = $message->message;
    // Allow other modules to add to the message
    $msg_addition = module_invoke_all('welcome_message_addition');
    if (is_array($msg_addition)) {
      foreach($msg_addition as $addition) {
        $user_message .=  ' ' . $addition;
      }
    }
    return $user_message;
  }

  return FALSE;
}

/**
 * Implements hook_help().
 */
function welcome_help($path, $arg) {
  switch ($path) {
    case 'admin/config/people/welcome':
      $output = '<p>' . t('<strong>Welcome message per role.</strong> Drag to order. If a user has more than one role, roles higher in the list will be used') . '</p>';
      return $output;
  }
}
