<?php

/**
 * @file
 * Install and uninstall configuration and functions for Parish Bulletin module.
 */

/**
 * Implements hook_install().
 */
function parish_bulletin_install() {
  // Load content_types.node.inc to create content types..
  module_load_include('inc', 'node', 'content_types');

  // Create 'bulletin' content type.
  $bulletin_type = array(
    'type' => 'bulletin',
    'name' => st('Bulletin'),
    'base' => 'node_content',
    'has_title' => FALSE,
    'description' => st('Bulletins contain downloadable PDFs or images of your Parish bulletin that are listed on the Bulletins page.'),
    'custom' => TRUE,
    'modified' => TRUE,
    'locked' => TRUE,
  );
  $bulletin_type = node_type_set_defaults($bulletin_type);
  node_type_save($bulletin_type);

  // Default "Bulletin" to not be promoted and have comments disabled.
  variable_set('node_options_bulletin', array('status'));
  if (module_exists('comment')) {
    variable_set('comment_bulletin', COMMENT_NODE_HIDDEN);
  }

  // Don't display date and author information for "Bulletin" nodes.
  variable_set('node_submitted_bulletin', FALSE);

  // Create fields for both the bulletin and event content types. (Use an
  // include file rather than defining them here, because there are many).
  module_load_include('inc', 'parish_bulletin', 'includes/parish_bulletin.fields');
  _create_parish_bulletin_fields();
}

/**
 * Implements hook_uninstall().
 */
function parish_bulletin_uninstall() {
  // Delete all parish bulletin variables.
  db_delete('variable')
    ->condition('name', db_like('parish_bulletin_') . '%', 'LIKE')
    ->execute();

  // Delete the bulletin content type if there are no existing bulletin nodes.
  $query = new EntityFieldQuery();
  $results = $query->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', 'bulletin')
    ->range(0, 1)
    ->execute();
  if (empty($results)) {
    node_type_delete('bulletin');
    drupal_flush_all_caches();
  }
}
