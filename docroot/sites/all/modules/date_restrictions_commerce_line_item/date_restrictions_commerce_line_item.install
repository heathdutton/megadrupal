<?php

/**
 * Update field's settings.
 */
function date_restrictions_commerce_line_item_update_7001() {
  $query = db_select('field_config_instance', 'fci');
  $query->join('field_config', 'fc', 'fci.field_name = fc.field_name');
  $query
    ->fields('fci', array('entity_type', 'bundle', 'field_name'))
    ->condition('fc.type', array('date', 'datetime', 'datestamp'), 'IN');
  $result = $query->execute();
  while ($r = $result->fetchObject()) {
    $instance = field_info_instance($r->entity_type, $r->field_name, $r->bundle);
    if (isset($instance['settings']['restrictions'])) {
      if (isset($instance['settings']['restrictions']['line_item'])) {
        $instance['settings']['restrictions']['allowed_values'] = array(
          'type'     => $instance['settings']['restrictions']['line_item']['enabled']?'product_display_date':'disabled',
          'source_field' => $instance['settings']['restrictions']['allowed_values'],
        );
        unset($instance['settings']['restrictions']['line_item']);
      }
    }
    field_update_instance($instance);
  }
}
