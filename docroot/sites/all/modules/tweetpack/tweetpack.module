<?php
// $Id: tweetpack.module,v 1.1 2010/04/17 08:47:57 poseurtech Exp $

/**
 * Implementation of hook_init().
 */
function tweetpack_init() {
  $enable_intents = variable_get('tweetpack_enable_intents', 1);
  if($enable_intents != '0') {
    drupal_add_js('//platform.twitter.com/widgets.js', 'external');  
  }
}

/**
 * Implementation of hook_menu().
 */
function tweetpack_menu() {

  $items = array();

  $items['admin/config/services/tweetpack'] = array(
    'title' => 'TweetPack',
    'description' => 'Settings for TweetPack module.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tweetpack_admin'),
    'access arguments' => array('administer blocks'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'tweetpack.admin.inc',
  );

  return $items;
}

/**
 * Implements blocks.
 */
function tweetpack_block_info() {
  $blocks = array();

  $blocks['tweetpack-block-twitter-button'] = array(
    'info' => t('TweetPack Button'),
  );
  $blocks['tweetpack-block-feed-box'] = array(
    'info' => t('TweetPack Feed Box'),
  ); 
  return $blocks;
}

function tweetpack_block_view($delta = ''){
  $block = array();

  switch ($delta) {
   case 'tweetpack-block-twitter-button':
     $type= variable_get('tweetpack_button_type', 0);
     $size = variable_get('tweetpack_button_size', 0);
     $showcount = variable_get('tweetpack_button_showcount', '');
     $name = variable_get('tweetpack_button_name', '');
     $share = variable_get('tweetpack_button_share', '');
     $shareurl = variable_get('tweetpack_button_shareurl', '');
     $block['content'] = theme('tweetpack_block_follow_button', array($type, $size, $showcount, $name, $share, $shareurl));
   break;
   case 'tweetpack-block-feed-box':
     $widget_id = variable_get('tweetpack_feed_widget_id', '');
     $block['content'] = theme('tweetpack_block_feed_box', array($widget_id));
   break;
 }
 return $block;
}

function tweetpack_block_configure($delta = ''){
  $form = array();

  switch ($delta) {
    case 'tweetpack-block-twitter-button':
      $form['tweetpack_button'] = array(
        '#type' => 'fieldset',
        '#title' => t('Button Settings'),
        '#prefix' => '<div class="tweetpack_button">',
        '#suffix' => '</div>',
      );    
      $form['tweetpack_button']['tweetpack_button_type'] = array(
        '#type' => 'radios',
        '#title' => t('Button Type'),
        '#description' => t('What type of button would you like to display?'),
        '#options' => array(t('Follow'), t('Share')),
        '#default_value' => variable_get('tweetpack_button_type', 0),
        '#required' => TRUE,
      );   
      $form['tweetpack_button']['tweetpack_button_size'] = array(
        '#type' => 'radios',
        '#title' => t('Button Size'),
        '#description' => t('What size button would you like to display?'),
        '#options' => array(t('Small'), t('Large')),
        '#default_value' => variable_get('tweetpack_button_size', 0),
        '#required' => FALSE,
      );
      $form['tweetpack_button']['tweetpack_button_showcount'] = array(
        '#type' => 'radios',
        '#title' => t('Show Count'),
        '#description' => t('If applicable - would you like to show the count associatted with this button?'),
        '#options' => array(t('No'), t('Yes')),
        '#default_value' => variable_get('tweetpack_button_showcount', 0),
        '#required' => FALSE,
      );        
      $form['tweetpack_button']['tweetpack_button_name'] = array(
        '#type' => 'textfield',
        '#title' => t('Username'),
        '#description' => t('Username of the Twitter account to be followed or to be used as via if this is a share button.'),
        '#default_value' => variable_get('tweetpack_button_name',  ''),
        '#required' => FALSE,
      );
      $form['tweetpack_button']['tweetpack_button_share'] = array(
        '#type' => 'textarea',
        '#title' => t('Share Text'),
        '#description' => t('Define the text you wish to show if this is a share box.'),
        '#default_value' => variable_get('tweetpack_button_share',  ''),
        '#required' => FALSE,
      ); 
      $form['tweetpack_button']['tweetpack_button_shareurl'] = array(
        '#type' => 'textfield',
        '#title' => t('Share Url'),
        '#description' => t('Provide the url to be shared - use special tags %none for no url or %current to use the current page url'),
        '#default_value' => variable_get('tweetpack_button_shareurl',  ''),
        '#required' => FALSE,
      );      
    break;
    case 'tweetpack-block-feed-box':
      $form['tweetpack_feed_widget_id'] = array(
        '#type' => 'textfield',
        '#title' => t('Widget ID'),
        '#description' => t('ID of widget generated at ' . l("Twitter Site", "https://twitter.com/settings/widgets/",  array('attributes' => array('target' => '_blank'))) . '?'),
        '#default_value' => variable_get('tweetpack_feed_widget_id', ''),
        '#required' => TRUE,
      );
    break;
  }
  return $form;
}

function tweetpack_block_save($delta = '', $edit = array()){
  switch ($delta) {
    case 'tweetpack-block-twitter-button':
      variable_set('tweetpack_button_type', $edit['tweetpack_button_type']);
      variable_set('tweetpack_button_size', $edit['tweetpack_button_size']);
      variable_set('tweetpack_button_showcount', $edit['tweetpack_button_showcount']);
      variable_set('tweetpack_button_name', $edit['tweetpack_button_name']);
      variable_set('tweetpack_button_share', $edit['tweetpack_button_share']);
      variable_set('tweetpack_button_shareurl', $edit['tweetpack_button_shareurl']);
    break;
    case 'tweetpack-block-feed-box':
      variable_set('tweetpack_feed_widget_id', $edit['tweetpack_feed_widget_id']);
    break;
  }
}

/**
 * Implementation of hook_theme().
 */
function tweetpack_theme() {
  return array(
    'tweetpack_block_follow_button' => array(
      'template' => 'templates/tweetpack_block_follow_button',
      'arguments' => array(
        'type' => NULL,
        'size' => NULL,
        'showcount' => NULL,
        'name' => NULL,
        'share' => NULL,
        'shareurl' => NULL
      ),
    ),
    'tweetpack_block_feed_box' => array(
      'template' => 'templates/tweetpack_block_feed_box',
      'arguments' => array(
        'widget_id' => NULL
      ),
    ),
  );
}