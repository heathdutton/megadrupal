<?php

/**
 * @file
 * Scald Chart Installation
 */

/**
 * Implements hook_install().
 */
function scald_chart_install() {
  ScaldAtomController::addType('chart', 'Chart', 'Chart');
}

/**
 * Implements hook_uninstall().
 */
function scald_chart_uninstall() {
  field_cache_clear();

  // Remove fields.
  $instance = field_info_instance('scald_atom', 'scald_chart_subtitle', 'chart');
  field_delete_instance($instance, $field_cleanup = TRUE);

  $instance = field_info_instance('multifield', 'scald_chart_categories_label', 'scald_chart_categories');
  field_delete_instance($instance, $field_cleanup = TRUE);

  $instance = field_info_instance('multifield', 'scald_chart_categories_data', 'scald_chart_categories');
  field_delete_instance($instance, $field_cleanup = TRUE);

  $instance = field_info_instance('scald_atom', 'scald_chart_categories', 'chart');
  field_delete_instance($instance, $field_cleanup = TRUE);

  $instance = field_info_instance('scald_atom', 'scald_chart_series', 'chart');
  field_delete_instance($instance, $field_cleanup = TRUE);

  $instance = field_info_instance('scald_atom', 'scald_chart_series', 'chart');
  field_delete_instance($instance, $field_cleanup = TRUE);

  $instance = field_info_instance('scald_atom', 'scald_chart_type', 'chart');
  field_delete_instance($instance, $field_cleanup = TRUE);

  drupal_load('module', 'scald');
  // If Scald is disabled, its classes are not autoloaded.
  module_load_include('inc', 'scald', 'includes/ScaldAtomController');

  ScaldAtomController::removeType('chart');
}


/**
 * Implements hook_enable().
 */
function scald_chart_enable() {
  // Create chart subtitle field.
  if (!field_info_field('scald_chart_subtitle')) {
    $field = array(
      'field_name' => 'scald_chart_subtitle',
      'type' => 'text',
      'cardinality' => 1,
      'settings' => array(
        'max_length' => 255,
      ),
    );

    field_create_field($field);
  }

  $instance = array(
    'field_name' => 'scald_chart_subtitle',
    'label' => t('Subtitle'),
    'entity_type' => 'scald_atom',
    'bundle' => 'chart',
    'required' => FALSE,
    'display' => array(
      'default' => array(
        'label' => 'above',
        'module' => 'text',
        'settings' => array(),
        'type' => 'text_default',
        'weight' => 2,
      ),
    ),
    'settings' => array(
      'text_processing' => 0,
    ),
    'widget' => array(
      'active' => 1,
      'module' => 'text',
      'settings' => array(
        'size' => 60,
      ),
      'type' => 'text_textfield',
      'weight' => 4,
    ),
  );

  if (!field_read_instance($instance['entity_type'], $instance['field_name'], $instance['bundle'])) {
    field_create_instance($instance);
  }

  // Create chart type field.
  if (!field_info_field('scald_chart_type')) {
    $field = array(
      'field_name' => 'scald_chart_type',
      'type' => 'list_text',
      'cardinality' => 1,
      'settings' => array(
        'allowed_values' => array(
          'bar' => 'Bar',
          'line' => 'Line',
        ),
        'allowed_values_function' => '',
      ),
    );

    field_create_field($field);
  }

  $instance = array(
    'field_name' => 'scald_chart_type',
    'label' => t('Chart type'),
    'entity_type' => 'scald_atom',
    'bundle' => 'chart',
    'required' => TRUE,
    'display' => array(
      'default' => array(
        'label' => 'above',
        'module' => 'list',
        'settings' => array(),
        'type' => 'list_default',
        'weight' => 5,
      ),
    ),
    'widget' => array(
      'active' => 1,
      'module' => 'options',
      'settings' => array(
        'apply_chosen' => '',
      ),
      'type' => 'options_select',
      'weight' => 5,
    ),
  );

  if (!field_read_instance($instance['entity_type'], $instance['field_name'], $instance['bundle'])) {
    field_create_instance($instance);
  }

  // Create chart options group field.
  if (!field_group_exists('scald_g_chart_options', 'scald_atom', 'chart', 'form')) {
    $field_group = new stdClass();
    $field_group->disabled = FALSE; /* Edit this to true to make a default field_group disabled initially */
    $field_group->api_version = 1;
    $field_group->identifier = 'scald_g_chart_options|scald_atom|chart|form';
    $field_group->group_name = 'scald_g_chart_options';
    $field_group->entity_type = 'scald_atom';
    $field_group->bundle = 'chart';
    $field_group->mode = 'form';
    $field_group->parent_name = '';
    $field_group->export_type = EXPORT_IN_DATABASE;
    $field_group->data = array(
      'label' => 'Chart options',
      'weight' => 4,
      'children' => array(
        0 => 'scald_chart_max',
        1 => 'scald_chart_min',
        2 => 'scald_chart_tick_interval',
        3 => 'scald_chart_legend_title',
      ),
      'format_type' => 'fieldset',
      'format_settings' => array(
        'label' => 'Chart options',
        'instance_settings' => array(
          'required_fields' => 1,
          'classes' => 'scald-g-chart-options field-group-fieldset',
          'description' => '',
        ),
        'formatter' => 'collapsed',
      ),
    );

    drupal_write_record('field_group', $field_group);
  }

  // Create group children.

  // Create chart min.
  if (!field_info_field('scald_chart_min')) {
    $field = array(
      'field_name' => 'scald_chart_min',
      'type' => 'number_integer',
      'cardinality' => 1,
      'settings' => array(),
    );

    field_create_field($field);
  }

  $instance = array(
    'field_name' => 'scald_chart_min',
    'label' => 'Min',
    'entity_type' => 'scald_atom',
    'bundle' => 'chart',
    'required' => 0,
    'display' => array(
      'default' => array(
        'label' => 'above',
        'module' => 'number',
        'settings' => array(
          'decimal_separator' => '.',
          'prefix_suffix' => TRUE,
          'scale' => 0,
          'thousand_separator' => ' ',
        ),
        'type' => 'number_integer',
        'weight' => 6,
      ),
    ),
    'settings' => array(
      'max' => '',
      'min' => '',
      'prefix' => '',
      'suffix' => '',
    ),
    'widget' => array(
      'settings' => array(),
      'type' => 'number',
      'weight' => 6,
    ),
  );

  if (!field_read_instance($instance['entity_type'], $instance['field_name'], $instance['bundle'])) {
    field_create_instance($instance);
  }

  // Create chart max.
  if (!field_info_field('scald_chart_max')) {
    $field = array(
      'field_name' => 'scald_chart_max',
      'type' => 'number_integer',
      'cardinality' => 1,
      'settings' => array(),
    );

    field_create_field($field);
  }

  $instance = array(
    'field_name' => 'scald_chart_max',
    'label' => 'Max',
    'entity_type' => 'scald_atom',
    'bundle' => 'chart',
    'required' => 0,
    'display' => array(
      'default' => array(
        'label' => 'above',
        'module' => 'number',
        'settings' => array(
          'decimal_separator' => '.',
          'prefix_suffix' => TRUE,
          'scale' => 0,
          'thousand_separator' => ' ',
        ),
        'type' => 'number_integer',
        'weight' => 7,
      ),
    ),
    'settings' => array(
      'max' => '',
      'min' => '',
      'prefix' => '',
      'suffix' => '',
    ),
    'widget' => array(
      'settings' => array(),
      'type' => 'number',
      'weight' => 7,
    ),
  );

  if (!field_read_instance($instance['entity_type'], $instance['field_name'], $instance['bundle'])) {
    field_create_instance($instance);
  }

  // Create chart tick interval.
  if (!field_info_field('scald_chart_tick_interval')) {
    $field = array(
      'field_name' => 'scald_chart_tick_interval',
      'type' => 'number_integer',
      'cardinality' => 1,
      'settings' => array(),
    );

    field_create_field($field);
  }

  $instance = array(
    'field_name' => 'scald_chart_tick_interval',
    'label' => 'Tick interval',
    'entity_type' => 'scald_atom',
    'bundle' => 'chart',
    'required' => 0,
    'display' => array(
      'default' => array(
        'label' => 'above',
        'module' => 'number',
        'settings' => array(
          'decimal_separator' => '.',
          'prefix_suffix' => TRUE,
          'scale' => 0,
          'thousand_separator' => ' ',
        ),
        'type' => 'number_integer',
        'weight' => 8,
      ),
    ),
    'settings' => array(
      'max' => '',
      'min' => '0',
      'prefix' => '',
      'suffix' => '',
    ),
    'widget' => array(
      'settings' => array(),
      'type' => 'number',
      'weight' => 8,
    ),
  );

  if (!field_read_instance($instance['entity_type'], $instance['field_name'], $instance['bundle'])) {
    field_create_instance($instance);
  }

  // Create chart legend title.
  if (!field_info_field('scald_chart_legend_title')) {
    $field = array(
      'field_name' => 'scald_chart_legend_title',
      'type' => 'text',
      'cardinality' => 1,
      'settings' => array(
        'max_length' => 255,
      ),
    );

    field_create_field($field);
  }

  $instance = array(
    'field_name' => 'scald_chart_legend_title',
    'label' => 'Legend title',
    'entity_type' => 'scald_atom',
    'bundle' => 'chart',
    'required' => FALSE,
    'display' => array(
      'default' => array(
        'label' => 'above',
        'module' => 'text',
        'settings' => array(),
        'type' => 'text_default',
        'weight' => 9,
      ),
    ),
    'settings' => array(
      'text_processing' => 0,
    ),
    'widget' => array(
      'module' => 'text',
      'settings' => array(
        'size' => 60,
      ),
      'type' => 'text_textfield',
      'weight' => 9,
    ),
  );

  if (!field_read_instance($instance['entity_type'], $instance['field_name'], $instance['bundle'])) {
    field_create_instance($instance);
  }

  // Create chart series field.
  if (!field_info_field('scald_chart_series')) {
    $field = array(
      'field_name' => 'scald_chart_series',
      'type' => 'text',
      'cardinality' => -1,
      'settings' => array(
        'max_length' => 255,
      ),
    );

    field_create_field($field);
  }

  $instance = array(
    'field_name' => 'scald_chart_series',
    'label' => t('Series'),
    'entity_type' => 'scald_atom',
    'bundle' => 'chart',
    'required' => TRUE,
    'display' => array(
      'default' => array(
        'label' => 'above',
        'module' => 'text',
        'settings' => array(),
        'type' => 'text_default',
        'weight' => 7,
      ),
    ),
    'settings' => array(
      'context' => 'debug',
      'context_default' => 'sdl_editor_representation',
      'dnd_enabled' => 0,
      'mee_enabled' => 0,
      'text_processing' => 0,
    ),
    'widget' => array(
      'active' => 1,
      'module' => 'text',
      'settings' => array(
        'size' => 60,
      ),
      'type' => 'text_textfield',
      'weight' => 7,
    ),
  );

  if (!field_read_instance($instance['entity_type'], $instance['field_name'], $instance['bundle'])) {
    field_create_instance($instance);
  }

  // Create chart categories label subfield.
  if (!field_info_field('scald_chart_categories_label')) {
    $field = array(
      'field_name' => 'scald_chart_categories_label',
      'type' => 'text',
      'cardinality' => 1,
      'settings' => array(
        'max_length' => 255,
      ),
    );

    field_create_field($field);
  }

  $instance = array(
    'field_name' => 'scald_chart_categories_label',
    'entity_type' => 'field_collection_item',
    'label' => t('Label'),
    'bundle' => 'scald_chart_categories',
    'required' => FALSE,
    'display' => array(
      'default' => array(
        'label' => 'above',
        'module' => 'text',
        'settings' => array(),
        'type' => 'text_default',
        'weight' => 0,
      ),
    ),
    'settings' => array(
      'context' => 'debug',
      'dnd_enabled' => 0,
      'mee_enabled' => 0,
      'text_processing' => 0,
    ),
    'widget' => array(
      'active' => 1,
      'module' => 'text',
      'settings' => array(
        'size' => 60,
      ),
      'type' => 'text_textfield',
      'weight' => 0,
    ),
  );

  if (!field_read_instance($instance['entity_type'], $instance['field_name'], $instance['bundle'])) {
    field_create_instance($instance);
  }

  // Create chart categories data subfield.
  if (!field_info_field('scald_chart_categories_data')) {
    $field = array(
      'field_name' => 'scald_chart_categories_data',
      'type' => 'text',
      'cardinality' => 1,
      'settings' => array(
        'max_length' => 255,
      ),
    );

    field_create_field($field);
  }

  $instance = array(
    'field_name' => 'scald_chart_categories_data',
    'entity_type' => 'field_collection_item',
    'label' => t('Data'),
    'bundle' => 'scald_chart_categories',
    'required' => FALSE,
    'display' => array(
      'default' => array(
        'label' => 'above',
        'module' => 'text',
        'settings' => array(),
        'type' => 'text_default',
        'weight' => 1,
      ),
    ),
    'settings' => array(
      'context' => 'debug',
      'context_default' => 'sdl_editor_representation',
      'dnd_enabled' => 0,
      'mee_enabled' => 0,
      'text_processing' => 0,
    ),
    'widget' => array(
      'active' => 1,
      'module' => 'text',
      'settings' => array(
        'size' => 60,
      ),
      'type' => 'text_textfield',
      'weight' => 1,
    ),
  );

  if (!field_read_instance($instance['entity_type'], $instance['field_name'], $instance['bundle'])) {
    field_create_instance($instance);
  }

  // Create chart categories field.
  if (!field_info_field('scald_chart_categories')) {
    $field = array(
      'field_name' => 'scald_chart_categories',
      'type' => 'field_collection',
      'cardinality' => -1,
      'settings' => array(
        'hide_blank_items' => 1,
        'path' => '',
      ),
    );

    field_create_field($field);
  }

  $instance = array(
    'field_name' => 'scald_chart_categories',
    'entity_type' => 'scald_atom',
    'label' => t('Categories'),
    'bundle' => 'chart',
    'required' => TRUE,
    'display' => array(
      'default' => array(
        'label' => 'above',
        'module' => 'field_collection',
        'settings' => array(
          'add' => 'Add',
          'delete' => 'Delete',
          'description' => TRUE,
          'edit' => 'Edit',
          'view_mode' => 'full',
        ),
        'type' => 'field_collection_view',
        'weight' => 8,
      ),
    ),
    'widget' => array(
      'active' => 0,
      'module' => 'field_collection',
      'settings' => array(),
      'type' => 'field_collection_embed',
      'weight' => 8,
    ),
  );

  if (!field_read_instance($instance['entity_type'], $instance['field_name'], $instance['bundle'])) {
    field_create_instance($instance);
  }

  // Create chart footer field.
  if (!field_info_field('scald_chart_credit')) {
    $field = array(
      'field_name' => 'scald_chart_credit',
      'type' => 'link_field',
      'cardinality' => 1,
      'settings' => array(
        'attributes' => array(
          'class' => '',
          'rel' => '',
          'target' => 'default',
        ),
        'display' => array(
          'url_cutoff' => 80,
        ),
        'title' => 'optional',
        'title_maxlength' => 128,
        'title_value' => '',
        'url' => 0,
      ),
    );

    field_create_field($field);
  }

  $instance = array(
    'field_name' => 'scald_chart_credit',
    'label' => t('Credit'),
    'entity_type' => 'scald_atom',
    'bundle' => 'chart',
    'required' => FALSE,
    'display' => array(
      'default' => array(
        'label' => 'above',
        'module' => 'text',
        'settings' => array(),
        'type' => 'text_default',
        'weight' => 9,
      ),
    ),
    'settings' => array(
      'absolute_url' => 1,
      'attributes' => array(
        'class' => '',
        'configurable_class' => 0,
        'configurable_title' => 0,
        'rel' => '',
        'target' => 'default',
        'title' => '',
      ),
      'display' => array(
        'url_cutoff' => 80,
      ),
      'rel_remove' => 'default',
      'title' => 'optional',
      'title_label_use_field_label' => 0,
      'title_maxlength' => 128,
      'title_value' => '',
      'url' => 'optional',
      'validate_url' => 1,
    ),
    'widget' => array(
      'active' => 0,
      'module' => 'link',
      'settings' => array(),
      'type' => 'link_field',
      'weight' => 9,
    ),
  );

  if (!field_read_instance($instance['entity_type'], $instance['field_name'], $instance['bundle'])) {
    field_create_instance($instance);
  }
}
