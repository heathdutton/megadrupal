<?php
/**
 * @file
 * This file holds the functions for the installing
 * and enabling of the sn_fb_dynamic_cover_photo module.
 *
 * @SNDCP sn_fb_dynamic_cover_photo
 */

/**
 * Implements hook_schema().
 */
function sn_fb_dynamic_cover_photo_schema() {
  $schema['sn_fb_dcp_config'] = array(
    'description' => 'Maintains Access token and and its expiration date.',
    'fields' => array(
      'access_token' => array(
        'type' => 'text',
        'length' => 255,
        'not null' => TRUE,
        'description' => 'Access Token from Facebook.',
      ),
      'expires' => array(
        'type' => 'int',
        'length' => 11,
        'unsigned' => TRUE,
        'not null' => TRUE,
        'default' => 0,
        'description' => 'Time of expiration of access token ',
      ),
    ),
  );

  $schema['sn_fb_dcp_images'] = array(
    'description' => 'Maintains images information which are uploaded as facebook cover.',
    'fields' => array(
      'id' => array(
        'description' => 'Primary Key: Unique category ID.',
        'type' => 'serial',
        'unsigned' => TRUE,
        'not null' => TRUE,
      ),
      'fb_id' => array(
        'description' => 'facebook unique id.',
        'type' => 'varchar',
        'length' => 255,
        'not null' => TRUE,
        'default' => '',
      ),
      'image_name' => array(
        'description' => 'facebook unique id.',
        'type' => 'varchar',
        'length' => 255,
        'not null' => TRUE,
        'default' => '',
      ),
      'cover_id' => array(
        'description' => 'facebook unique id.',
        'type' => 'varchar',
        'length' => 255,
        'not null' => TRUE,
        'default' => '',
      ),
      'created' => array(
        'description' => 'The time of creation for cover photo.',
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE,
      ),
    ),
    'primary key' => array('id'),
  );

  $schema['sn_fb_dcp_last_updated'] = array(
    'description' => 'Maintains information of last updated Photo.',
    'fields' => array(
      'fb_id' => array(
        'description' => 'facebook unique id.',
        'type' => 'varchar',
        'length' => 255,
        'not null' => TRUE,
        'default' => '',
      ),
      'updated' => array(
        'description' => 'The time of last updated cover photo.',
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE,
      ),
    ),
  );

  return $schema;
}


/**
 * Implements hook_install().
 */
function sn_fb_dynamic_cover_photo_install() {
  $file = scandir(drupal_realpath('public://'));
  if (!in_array('styles', $file)) {
    sn_fb_dynamic_cover_photo_create_directory('', 'styles');
  }

  sn_fb_dynamic_cover_photo_create_directory('styles/dcp_images/public/field/', 'image');
  sn_fb_dynamic_cover_photo_create_directory('', 'DCP');
}

/**
 * Function to create directory path for dynamic cover photo.
 *
 * @param string $path
 *   Path for directory creation
 * @param string $dir_name
 *   Path for directory creation
 */
function sn_fb_dynamic_cover_photo_create_directory($path, $dir_name) {
  $mydir = drupal_realpath('public://') . DIRECTORY_SEPARATOR . $path . $dir_name;
  file_prepare_directory($mydir, FILE_CREATE_DIRECTORY);
  file_prepare_directory($mydir, FILE_MODIFY_PERMISSIONS);
}

/**
 * Implements hook_requirements().
 */
function sn_fb_dynamic_cover_photo_requirements($phase) {
  $requirements = array();
  $t = get_t();
  $has_curl = function_exists('curl_init');
  $has_gd_library = function_exists('gd_info');
  $requirements['sn_fb_dynamic_cover_photo'] = array(
    'title' => $t('cURL'),
    'value' => $has_curl ? $t('Enabled') : $t('Not found'),
  );

  if (!$has_curl) {
    $requirements['sn_fb_dynamic_cover_photo']['severity'] = REQUIREMENT_ERROR;
    $requirements['sn_fb_dynamic_cover_photo']['description'] = $t("SN FB Dynamic Cover Photo requires the PHP <a href='!curl_url'>cURL</a> library.", array('!curl_url' => 'http://php.net/manual/en/curl.setup.php'));
  }

  $requirements['sn_fb_dynamic_cover_photo'] = array(
    'title' => $t('gd library'),
    'value' => $has_gd_library ? $t('Enabled') : $t('Not found'),
  );

  if (!$has_gd_library) {
    $requirements['sn_fb_dynamic_cover_photo']['severity'] = REQUIREMENT_ERROR;
    $requirements['sn_fb_dynamic_cover_photo']['description'] = $t("SN FB Dynamic Cover Photo requires the PHP <a href='!gd_library_url'>gd library</a> library.", array('!gd_library_url' => 'http://www.php.net/manual/en/image.setup.php'));
  }

  return $requirements;
}

/*
 * Implements hook_uninstall().
 */
function sn_fb_dynamic_cover_photo_uninstall() {
  variable_del('sn_fb_dynamic_cover_photo_app_id');
  variable_del('sn_fb_dynamic_cover_photo_redirect_uri');
  variable_del('sn_fb_dynamic_cover_photo_secret');
  variable_del('sn_fb_dynamic_cover_photo_brand_page');
  variable_del('sn_fb_dynamic_cover_photo_album_name');
  variable_del('sn_fb_dynamic_cover_photo_upload_directory');
  variable_del('sn_fb_dynamic_cover_photo_scope');
  variable_del('sn_fb_dynamic_cover_photo_album_name');
}
