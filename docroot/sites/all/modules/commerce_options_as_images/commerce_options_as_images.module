<?php
/**
 * Module implementation.
 */

/**
 * Implements hook_form_FORM_ID_alter().
 */
function commerce_options_as_images_form_commerce_cart_add_to_cart_form_alter(&$form, &$form_state, $form_id) {
  if (array_key_exists('#options', $form['product_id'])) {
    $options = commerce_options_as_images_product_image_id_options($form['product_id']['#options']);

    // Todo Add default settings.
    if ($options != 0) {
      $form['product_id']['#type'] = 'radios';
      $form['product_id']['#options'] = $options;
      $form['#attached']['css'] = array(
        drupal_get_path('module',
          'commerce_options_as_images') . '/css/commerce_options_as_images.css'
      );
    }
  }
}


/**
 * Creates an options array for radios control.
 */
function commerce_options_as_images_product_image_id_options($options) {
  $result = array();
  $field_photo = variable_get('commerce_options_as_images_image_field');
  $image_style = variable_get('commerce_options_as_images_image_style');
  if ($field_photo && $image_style) {
    $prod_ids = array_keys($options);
    $products = commerce_product_load_multiple($prod_ids);
    foreach ($products as $key => $product) {
      $result[$key] = theme('image_style',
        array(
          'style_name' => $image_style,
          'path' => $product->{$field_photo}[LANGUAGE_NONE][0]['uri'],
          'title' => $product->title,
        )
      );
    }
  }
  else {
    drupal_set_message(t('Visit !link before to set settings.', array('!link' => l(t('settings page'), 'admin/commerce/config/options_as_images'))), 'error');
    $result = 0;
  }

  return $result;
}

/**
 * Implements hook_menu().
 */
function commerce_options_as_images_menu() {
  $items['admin/commerce/config/options_as_images'] = array(
    'title' => 'Commerce Options as Images settings page',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('commerce_options_as_images_settings_form'),
    'access arguments' => array('administer commerce'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'includes/commerce_options_as_images_ui.admin.inc',
  );

  return $items;
}
