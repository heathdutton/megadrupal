<?php
/**
 * @file
 * Database schema for the Payment Checkout.fi module.
 */

/**
 * Implements hook_schema().
 */
function payment_checkoutfi_schema() {
  $schema['payment_checkoutfi'] = array(
    'fields' => array(
      'pmid' => array(
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE,
      ),
      'merchant_id' => array(
        'type' => 'varchar',
        'length' => 255,
        'not null' => TRUE,
      ),
      'passphrase' => array(
        'type' => 'varchar',
        'length' => 255,
        'not null' => TRUE,
      ),
      'message' => array(
        'type' => 'text',
      ),
      'content' => array(
        'type' => 'int',
        'not null' => TRUE,
        'size' => 'tiny',
      ),
      'date_offset' => array(
        'type' => 'varchar',
        'length' => 255,
      ),
      'onsite_gateway' => array(
        'type' => 'int',
        'not null' => TRUE,
        'size' => 'tiny',
      ),
    ),
    'primary key' => array('pmid'),
  );
  return $schema;
}

/**
 * Implements hook_install().
 */
function payment_checkoutfi_install() {
  // Create default return messages.
  require_once 'payment_checkoutfi.module';
  $messages = array(
    'payment_checkoutfi_status_default' => 'The status of your payment is unknown. Please contact us if you have any questions.',
    PAYMENT_CHECKOUTFI_STATUS_COMPLETE => 'Your payment was completed successfully.',
    PAYMENT_CHECKOUTFI_STATUS_PENDING => 'The payment process was completed successfully. Your order will be shipped as soon as we have received your payment.',
    PAYMENT_CHECKOUTFI_STATUS_CANCELED_BY_USER => 'Your payment has been canceled.',
    PAYMENT_CHECKOUTFI_STATUS_CANCELED_BY_SYSTEM => 'Your payment has been canceled by the system.',
    PAYMENT_CHECKOUTFI_STATUS_TIMEOUT => 'Your payment has timed out. Please try again.',
  );
  foreach ($messages as $variable_name => $message) {
    variable_set($variable_name, $message);
  }
}

/**
 * Implements hook_uninstall().
 */
function payment_checkoutfi_uninstall() {
  // Delete module variables.
  db_delete('variable')
    ->condition('name', 'payment_checkoutfi%', 'LIKE')
    ->execute();

  // Clear variable cache.
  cache_clear_all('variables', 'cache_bootstrap');
}

/**
 * Implements hook_requirements().
 */
function payment_checkoutfi_requirements($phase) {
  $requirements = array();
  // Ensure translations don't break during installation.
  $t = get_t();

  // Check if SimpleXML is enabled.
  if ($phase == 'runtime') {
    $simplexml_enabled = extension_loaded('simplexml');
    $requirements['checkoutfi_simplexml'] = array(
      'title' => $t('Payment Checkout.fi'),
      'value' => $simplexml_enabled ? $t('SimpleXML loaded') : $t('SimpleXML not loaded'),
      'severity' => $simplexml_enabled ? REQUIREMENT_OK : REQUIREMENT_WARNING,
      'description' => $t('Payment for Checkout.fi uses the SimpleXML PHP extension to parse XML data for its on-site gateway. If this extension is not enabled, users will be redirected to offsite-payment instead.'),
    );
  }

  return $requirements;
}
