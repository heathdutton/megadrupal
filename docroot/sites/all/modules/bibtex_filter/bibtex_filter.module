<?php
function bibtex_filter_filter_info() {
  $filters['filter_bibtex'] = array(
    'title' => t('Convert BibTeX into HTML'), 
    //'description' => t('Converts BibTeX into HTML'), 
    'process callback' => '_filter_bibtex', 
    'settings callback' => '_filter_bibtex_settings',
    'tips callback' => '_filter_bibtex_tips',
  );
  return $filters;
}

function _filter_bibtex($text, $filter, $format, $langcode, $cache, $cache_id) {
  require_once (drupal_get_path('module', 'bibtex_filter') . '/bibtex2html.php');
  $text = bibstring2html($text, $displayTypes = NULL, $groupType = $filter->settings['groupType'], $groupYear = $filter->settings['groupYear'], $bibLink = $filter->settings['bibLink'], $highlightName = NULL, $numbersDesc = NULL, $sorting = NULL, $authorLimit = NULL, $abstractLink = NULL);
  return $text;
}

function _filter_bibtex_settings($form, &$form_state, $filter, $format, $defaults, $filters) {
  $filter->settings += $defaults;
  $elements = array();
  $elements['groupType'] = array(
    '#type' => 'checkbox', 
    '#title' => t('Group by type'), 
    '#description' => t('Group bibliography by type of publication.'), 
    '#default_value' => $filter->settings['groupType'],
  );

  $elements['groupYear'] = array(
    '#type' => 'checkbox', 
    '#title' => t('Group by year'), 
    '#description' => t('Group bibliography by year of publication.'), 
    '#default_value' => $filter->settings['groupYear'],
  );
  $elements['bibLink'] = array(
    '#type' => 'checkbox', 
    '#title' => t('Link to bibliography'), 
    '#description' => t('Display link to bibliography.'), 
    '#default_value' => $filter->settings['bibLink'],
  );

  return $elements;
}
