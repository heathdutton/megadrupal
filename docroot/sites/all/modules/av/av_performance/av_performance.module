<?php
/**
 * @file av_performance.module
 * Provides integration with AudienceView Performances data
 */

/**
 * Implements hook_menu().
 */
function av_performance_menu() { 
  $items['av/performance'] = array(
    'title' => 'AudienceView Performance',
    'description' => 'Display AV Performance Data',
    'page callback' => 'av_performance_show',
    'page arguments' => array(2),
    'access arguments' => array('administer site configuration'),
    'weight' => 0,
    'type' => MENU_NORMAL_ITEM,
  );  

  return $items;
}

function av_performance_show($perf_id) {
  $output = '';
  $result = av_performance_get($perf_id);

  if ($perf_id) {
    foreach ($result as $idx => $value) {
      $output .= '<dt>' . $idx . '</dt> <dd> ' . $value . '</dd>';
    }
  }
  else {
    drupal_set_message(t('You must provide a performance_id at the end of the URL.'), 'error');
  }
  return $output; 
}

function av_performance_get($perf_id) {

  $cookie_jar = tempnam(file_directory_temp(), 'drupal_av_cookie' . date('U') . rand());
  $url = variable_get('av_url') . "/WebAPI/session/authenticateUser";
  $strPost = "userid=" . urlencode(variable_get('av_username')) . "&password=" . urlencode(variable_get('av_password'));

  $ch = @curl_init();
  @curl_setopt($ch, CURLOPT_POSTFIELDS, $strPost);
  @curl_setopt($ch, CURLOPT_URL, $url);
  @curl_setopt($ch, CURLOPT_COOKIESESSION, TRUE);
  @curl_setopt($ch, CURLOPT_COOKIEJAR, $cookie_jar);
  @curl_setopt($ch, CURLOPT_RETURNTRANSFER, TRUE);
  $response = @curl_exec($ch);

  $url = variable_get('av_url') . "/WebAPI/session/boCreate";
  @curl_setopt($ch, CURLOPT_URL, $url);
  $strPost = "handle=" . urlencode('MyPerf') . "&object=" . urlencode('TSperformanceBO');
  @curl_setopt($ch, CURLOPT_POSTFIELDS, $strPost);
  $response = @curl_exec($ch);

  $url = variable_get('av_url') . "/WebAPI/object/MyPerf/load";
  @curl_setopt($ch, CURLOPT_URL, $url);
  $strPost = urlencode('SET::Performance::performance_id') . '=' . urlencode($perf_id);
  $strPost .= '&GET=Performance';
  @curl_setopt($ch, CURLOPT_POSTFIELDS, $strPost);
  $result = @curl_exec($ch);

  $root = simplexml_load_string($result);
  $data = get_object_vars($root);

  $p = array(); 
  $p['name'] = $data['data']->Performance->name;
  $p['description'] = $data['data']->Performance->description;
  $p['short_description'] = $data['data']->Performance->short_description;
  $p['series_description'] = $data['data']->Performance->series_description;
  $p['group'] = $data['data']->Performance->group;
  $p['performance_type'] = $data['data']->Performance->performance_type;
  $p['start'] = $data['data']->Performance->start_date;
  $p['end'] = $data['data']->Performance->end_date;
  $p['day_of_week'] = $data['data']->Performance->day_of_week;
  $p['gl_code'] = $data['data']->Performance->gl_code;
  $p['venue_name'] = $data['data']->Performance->venue_name;
  $p['data1'] = $data['data']->Performance->data1;
  $p['data2'] = $data['data']->Performance->data2;
  $p['data3'] = $data['data']->Performance->data3;
  $p['data4'] = $data['data']->Performance->data4;

  // remove the cookie jar
  unlink($cookie_jar) or drupal_set_message(t("Can't unlink @file.", array('@file' => $cookie_jar)));

  return $p;
}
