<?php

/**
 * @file
 * Simple module to integrate Snoobi website tracking service on a site
 */

/**
 * Implements hook_permission().
 */
function snoobi_permission() {
  return array(
    'administer snoobi' => array(
      'title' => t('Administer Snoobi'),
      'description' => t('Set Snoobi account'),
    ),
    'view snoobi' => array(
      'title' => t('Enable Snoobi tracking'),
      'description' => t('Track the selected role(s) with Snoobi'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function snoobi_menu() {
  $items = array();

  $items['admin/config/system/snoobi'] = array(
    'title' => 'Snoobi',
    'description' => 'Set username for Snoobi tracking',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('snoobi_admin_settings'),
    'access arguments' => array('administer snoobi'),
    'file' => 'snoobi.admin.inc',
  );

  return $items;
}


/**
 * Implements hook_page_alter().
 */
function snoobi_page_alter(&$vars, $hook) {
  if (user_access('view snoobi')) {

    if (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] == 'on') {
      $snoobi_protocol = 'https';
    }
    else {
      $snoobi_protocol = 'http';
    }

    $path = $snoobi_protocol . '://eu1.snoobi.com/snoop.php';

    $options = array(
      'external' => TRUE,
      'query' => array(
        'tili' => check_plain(variable_get('snoobi_username', 'corporatename_fi')),
      ),
    );

    // Alter
    drupal_alter('snoobi_url', $path, $options);
    $script_url = url($path, $options);

    drupal_add_js($script_url, array('scope' => 'footer', 'type' => 'external'));
  }
}
