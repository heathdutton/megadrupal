<?php

/**
 * @file
 * Adds support for sending SMS messages using the main_sms gateway.
 */

/**
 * Implements hook_gateway_info().
 */
function sms_mainsms_gateway_info() {
  return array(
    'mainsms' => array(
      'name' => 'Main SMS',
      'configure form' => 'sms_mainsms_admin_form',
      'receive' => TRUE,
      'send' => 'sms_mainsms_send',
      'send form' => 'sms_mainsms_send_form',
    ),
  );
}

/**
 * Admin/settings form.
 */
function sms_mainsms_admin_form($configuration) {
  $form['sms_mainsms_project'] = array(
    '#type' => 'textfield',
    '#title' => t('Project name'),
    '#size' => 40,
    '#maxlength' => 255,
    '#default_value' => !empty($configuration['sms_mainsms_project']) ? $configuration['sms_mainsms_project'] : '',
  );
  $form['sms_mainsms_api_key'] = array(
    '#type' => 'textfield',
    '#title' => t('API Key'),
    '#size' => 30,
    '#maxlength' => 255,
    '#default_value' => !empty($configuration['sms_mainsms_api_key']) ? $configuration['sms_mainsms_api_key'] : '',
  );
  $form['sms_mainsms_sender'] = array(
    '#type' => 'textfield',
    '#title' => t('Sender'),
    '#size' => 20,
    '#maxlength' => 255,
    '#default_value' => !empty($configuration['sms_mainsms_sender']) ? $configuration['sms_mainsms_sender'] : '',
  );
  
  return $form;
}

/**
 * Callback for sending messages.
 */
function sms_mainsms_send($number, $message, $options) {
  return sms_mainsms_command('sendmsg', array('number' => $number, 'message' => $message), NULL, NULL);
}

/**
 * Executes a command using the Main SMS API
 */
function sms_mainsms_command($command = 'auth', $data = array(), $config = NULL, $account = '') {
  require_once DRUPAL_ROOT . '/' . drupal_get_path('module', 'sms_mainsms') . '/inc/mainsms.class.php';

  $gateway = sms_gateways('gateway', 'mainsms');

  if ($config == NULL) {
    $config = $gateway['configuration'];
  }
  
  switch ($command) {
    case 'sendmsg':
      $api = new MainSMS($config['sms_mainsms_project'], $config['sms_mainsms_api_key'], false, false);
      $send_result = $api->sendSMS($data['number'], $data['message'], $config['sms_mainsms_sender']);
      if (!$send_result) {
        $response = $api->getResponse();
        $result = array(
          'status' => FALSE,
          'message' => t('Error of sending SMS') . print_r($response, 1),
        );
      }
      else {
        $result = array(
          'status' => TRUE,
          'data' => t('Message sent to @number', array('@number' => $data['number'])),
        );
      }
      return $result;
  }

}
