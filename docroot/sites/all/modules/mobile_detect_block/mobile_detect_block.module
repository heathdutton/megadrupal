<?php

/**
 * @file mobile_detect Block.
 * Block visibility options for mobile devices using mobile_detect detection.
 */

/**
 * Implements hook_form_FORMID_alter().
 * @see block_add_block_form()
 */
function mobile_detect_block_form_block_add_block_form_alter(&$form, &$form_state) {
  mobile_detect_block_form_block_admin_configure_alter($form, $form_state);
}

/**
 * Implements hook_form_FORMID_alter().
 * Adds mobile specific visibility options to block configuration form.
 * @see block_admin_configure()
 */
function mobile_detect_block_form_block_admin_configure_alter(&$form, &$form_state) {
  $is_mobile_result = db_query("SELECT is_mobile_device FROM {mobile_detect_block} WHERE module = :module AND delta = :delta", array(
    ':module' => $form['module']['#value'],
    ':delta' => $form['delta']['#value'],
  ))->fetchCol();

  $is_tablet_result = db_query("SELECT is_tablet_device FROM {mobile_detect_block} WHERE module = :module AND delta = :delta", array(
    ':module' => $form['module']['#value'],
    ':delta' => $form['delta']['#value'],
  ))->fetchCol();

  $is_mobile_default_value = 0;
  $is_tablet_default_value = 0;

  if (!empty($is_mobile_result)) {
    $is_mobile_default_value = $is_mobile_result[0];
  }
  if (!empty($is_tablet_result)) {
    $is_tablet_default_value = $is_tablet_result[0];
  }

  $form['visibility']['mobile_detect_block'] = array(
    '#type' => 'fieldset',
    '#title' => t('Mobile Detect'),
    '#group' => 'visibility',
    '#weight' => 6,
    '#tree' => true,
    '#attached' => array(
      'js' => array(drupal_get_path('module', 'mobile_detect_block') . '/mobile_detect_block.js'),
    ),
  );
  $form['visibility']['mobile_detect_block']['is_mobile_device'] = array(
    '#type' => 'radios',
    '#title' => t('Hide or show this block in smalltouch mobile devices'),
    '#default_value' => $is_mobile_default_value,
    '#options' => array(
      0 => t('Not restricted'),
      1 => t('Hide'),
      2 => t('Show'),
    ),
  );
  $form['visibility']['mobile_detect_block']['is_tablet_device'] = array(
    '#type' => 'radios',
    '#title' => t('Hide or show this block in tablet devices'),
    '#default_value' => $is_tablet_default_value,
    '#options' => array(
      0 => t('Not restricted'),
      1 => t('Hide'),
      2 => t('Show'),
    ),
  );

  $form['#submit'][] = 'mobile_detect_block_form_block_admin_configure_submit';
}

/**
 * Form submit handler for block configuration form.
 * @see mobile_detect_block_form_block_admin_configure_alter()
 */
function mobile_detect_block_form_block_admin_configure_submit($form, &$form_state) {
  db_delete('mobile_detect_block')
    ->condition('module', $form_state['values']['module'])
    ->condition('delta', $form_state['values']['delta'])
    ->execute();
  $query = db_insert('mobile_detect_block')->fields(array(
    'is_mobile_device',
    'is_tablet_device',
    'module',
    'delta',
  ));
  $query->values(array(
    'is_mobile_device' => $form_state['values']['mobile_detect_block']['is_mobile_device'],
    'is_tablet_device' => $form_state['values']['mobile_detect_block']['is_tablet_device'],
    'module' => $form_state['values']['module'],
    'delta' => $form_state['values']['delta'],
  ));
  $query->execute();
}

/**
 * Implements hook_block_list_alter().
 * Check the mobile detect specific visibilty settings.
 * Remove the block if the visibility conditions are not met.
 */
function mobile_detect_block_block_list_alter(&$blocks) {
  global $theme_key;

  if (function_exists('mobile_detect_get_object')) {
    $detect = mobile_detect_get_object();
    $is_mobile_device = $detect->isMobile(); // boolean false/true
    $is_tablet_device = $detect->isTablet(); // boolean false/true

    //var_dump($is_mobile_device);
    //var_dump($is_tablet_device);
  }


/*
  $browser = mobile_detect_get_browser();
  $is_mobile = FALSE;
  if (isset($browser['ismobiledevice'])) {
    if ($browser['ismobiledevice'] == 1 || variable_get('mobile_switch_ismobiledevice', FALSE)) {
      $is_mobile = TRUE;
    }
  }

  $mobile_detect_block = array();
  $result = db_query('SELECT module, delta, ismobile FROM {mobile_detect_block}');
  foreach ($result as $record) {
    $mobile_detect_block[$record->module][$record->delta] = (int) $record->ismobile;
  }

  foreach ($blocks as $key => $block) {
    if (!isset($block->theme) || !isset($block->status) || $block->theme != $theme_key || $block->status != 1) {
      // This block was added by a contrib module, leave it in the list.
      continue;
    }

    foreach ($mobile_detect_block as $module => $delta) {
      if ($module == $block->module) {
        foreach ($delta as $delta_key => $delta_value) {
          if ($delta_key == $block->delta) {
            if ($delta_value == 2 && $is_mobile == FALSE) {
              unset($blocks[$key]);
            }
            if ($delta_value == 1 && $is_mobile == TRUE) {
              unset($blocks[$key]);
            }
          }
        }
      }
    }
  }
*/
}
