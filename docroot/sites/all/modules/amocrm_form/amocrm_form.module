<?php

/**
 * @file
 * An easy, automated integration between your website and amoCRM.
 * Web-form generator for Drupal captures leads, contacts and companies.
 */

/**
 * Implements hook_filter_info().
 */
function amocrm_form_filter_info() {
  $filters['amocrm_from'] = array(
    'title' => t('Convert amocrm short-code to form'),
    'description' => t('This filter will convert [amocrm id="yyy" hash="xxx"] short-code into markup'),
    'process callback' => 'amocrm_form_filter_process',
  );

  return $filters;
}

/**
 * Process callback for 'amocrm_from' filter.
 *
 * @param string $text
 *   Original text
 *
 * @return string
 *   Processed text
 */
function amocrm_form_filter_process($text) {
  $text = preg_replace_callback(
    '/\[amocrm id=\"(\d+)\" hash=\"([0-9a-zA-Z]+)\" locale=\"([a-z]+)\"\]/s',
    'amocrm_form_filter_replace_process',
    $text
  );

  return $text;
}

/**
 * Replace callback for amocrm_form_filter_process().
 *
 * @param array $matches
 *   Matches from original text
 *
 * @return string
 */
function amocrm_form_filter_replace_process($matches) {
  if (!empty($matches[2]) && !empty($matches[1])) {

    $id = $matches[1];
    $hash = $matches[2];
    $locale = $matches[3];

    $text = '<script>var amo_forms_params = {id:"' . $id . '", hash: "' . $hash . '"};</script>';
    $text .= '<script id="amoforms_script" async="async" src="https://forms.amocrm.' . $locale . '/forms/assets/js/amoforms.js"></script>';

    return $text;
  }

  return $matches[0];
}
