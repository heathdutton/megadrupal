<?php
/**
 * @file
 * All module hooks implementation can be found in this file.
 */

/**
 * Implements hook_permission().
 */
function gov_analytics_permission() {
  return array(
    'administer gov analytics' => array(
      'title' => t('Administer Gov Analytics'),
    )
  );
}

/**
 * Implements hook_init().
 */
function gov_analytics_init() {
  // Load administrative pages
  module_load_include('admin.inc', 'gov_analytics');

  /**
   * Implements _add_html_head. Logic to build metatag variables output.
   */
  $gov_analytics_settings = array();
  $gov_analytics_settings['agency']        = variable_get('gov_analytics_agency', 'unspecified:domain.com');
  $gov_analytics_settings['subagency']     = variable_get('gov_analytics_subagency','unspecified:domain.com -domain.com');
  $gov_analytics_settings['ver']           = variable_get('gov_analytics_ver',1);
  $gov_analytics_settings['sp']            = variable_get('gov_analytics_sp');
  $gov_analytics_settings['exts']          = variable_get('gov_analytics_exts');
  $gov_analytics_settings['yt']            = variable_get('gov_analytics_yt',1);
  $gov_analytics_settings['sdor']          = variable_get('gov_analytics_sdor',1);
  $gov_analytics_settings['dclink']        = variable_get('gov_analytics_dclink',0);
  $gov_analytics_settings['pua']           = variable_get('gov_analytics_pua');
  $gov_analytics_settings['enhlink']       = variable_get('gov_analytics_enhlink',0);
  $gov_analytics_settings['autotracker']   = variable_get('gov_analytics_autotracker',1);
  $gov_analytics_settings['optout']        = variable_get('gov_analytics_optout',0);
  $gov_analytics_settings['maincd']        = variable_get('gov_analytics_maincd',1);
  $gov_analytics_settings['cto']           = variable_get('gov_analytics_cto','24');

  settype($gov_analytics_settings['ver'], "bool");
  settype($gov_analytics_settings['yt'], "bool");
  settype($gov_analytics_settings['sdor'], "bool");
  settype($gov_analytics_settings['dclink'], "bool");
  settype($gov_analytics_settings['enhlink'], "bool");
  settype($gov_analytics_settings['autotracker'], "bool");
  settype($gov_analytics_settings['optout'], "bool");
  settype($gov_analytics_settings['maincd'], "bool");

  $gov_analytics_query = '?';
  $gov_analytics_query_index = 1;

  foreach($gov_analytics_settings as $key => $setting) {
    if (!empty($setting)) {
      if(is_bool($setting) AND $setting) {
        $setting = "true";
      }
      if(is_string($setting) AND !is_array($setting)) {
        $setting = check_plain($setting);
        if($gov_analytics_query_index > 1) {
          $gov_analytics_query = $gov_analytics_query . "&" . $key . '=' . $setting;
      } else {
        $gov_analytics_query = $gov_analytics_query . $key . '=' . $setting;
      }
      $gov_analytics_query_index++;
      }
    }
  }
   
  $gov_analytics_markup = '<meta type="text/javascript" id="_fed_an_ua_tag" src="' . $gov_analytics_query . '" />';
  $gov_analytics_js = array(
    '#type' => 'markup',
    '#markup' => $gov_analytics_markup,
  );
  drupal_add_html_head($gov_analytics_js, 'gov_analytics_js');

  /**
   * Implements hook_libraries_info().
   *
   * For defining external libraries.
   */
  function gov_analytics_libraries_info() {

    // Expected to be extracted into 'sites/all/libraries/digitalgov_dap'.
    $libraries['digitalgov_dap'] = array(
      'name' => 'Digitalgov DAP',
      'vendor url' => 'http://www.digitalgov.gov/services/dap/analytics-tool-instructions/',
      'download url' => 'https://raw.githubusercontent.com/digital-analytics-program/gov-wide-code/master',
      'version callback' => 'gov_analytics_version_callback',
      'files' => array(
        'js' => array('Universal-Federated-Analytics-Min.js'), 
      ),
    );
    
    function gov_analytics_version_callback() {
      return TRUE;
    }

    return $libraries;
  }

  if (module_exists('libraries')) {
    libraries_load('digitalgov_dap');
  }
}

/**
 * Implements hook_menu().
 */
function gov_analytics_menu() {
  $items = array();

  $items['admin/config/system/gov_analytics'] = array(
  'title' => 'Gov Analytics',
  'description' => 'Configure Government-Wide Analytics Tool for Federal Agencies',
  'page callback' => 'drupal_get_form',
  'page arguments' => array('gov_analytics_form'),
  'access arguments' => array('administer gov analytics'),
  'type' => MENU_NORMAL_ITEM,
  );
 
  return $items;
}