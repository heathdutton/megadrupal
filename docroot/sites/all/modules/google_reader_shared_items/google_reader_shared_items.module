<?php
/**
 * @file
 * Google Reader Shared Items
 *
 * Pulls your shared items from Google Reader for display in a block.
 */

/**
 * Implements hook_block_info().
 */
function google_reader_shared_items_block_info() {
  $blocks['shared_items']['info'] = t('Google Reader Shared Items');
  return $blocks;
}

/**
 * Implements hook_block_configure().
 */
function google_reader_shared_items_block_configure($delta) {
  if ($delta == 'shared_items' && user_access('administer blocks')) {
    $form['google_reader_shared_items_sharing_code'] = array(
      '#type' => 'textarea',
      '#title' => t('Sharing Code'),
      '#description' => t('Paste in your sharing code from Google Reader. Click on Sharing Settings in the left sidebar, then Add A Clip at the bottom of the settings page. Copy the Javascript from the text box at the bottom, and paste it here, and the module will strip out the relevant part.'),
      '#cols' => 60,
      '#rows' => 5,
      '#default_value' => variable_get('google_reader_shared_items_sharing_code', ''),
    );
    $form['google_reader_shared_items_count'] = array(
      '#type' => 'select',
      '#title' => t('Number of items to display'),
      '#description' => t('How many items should be shown in the block?'),
      '#options' => array(
        5 => 5,
        10 => 10,
        20 => 20,
      ),
      '#default_value' => variable_get('google_reader_shared_items_count', 10),
    );


  }
  return $form;
}

/**
 * Implements hook_block_save().
 */
function google_reader_shared_items_block_save($delta, $edit) {
  if ($delta == 'shared_items') {
    variable_set('google_reader_shared_items_count', $edit['google_reader_shared_items_count']);
    $share_code = $edit['google_reader_shared_items_sharing_code'];

    if (empty($share_code)) {
      variable_del('google_reader_shared_items_sharing_code');
      return;
    }

    // If just the URL of the JSON file was input, save it
    if (strpos($share_code, 'http://www.google.com/reader/public/javascript/user/') === 0) {
      return _google_reader_shared_items_save_url($share_code);
    }

    // Parse out the script URLs from the sharing code
    // Regex from http://www.the-art-of-web.com/php/parse-links/#section_4
    $regexp = "<script\s[^>]*src=(\"??)([^\" >]*?)\\1[^>]*>(.*)<\/script>";
    if (preg_match_all("/$regexp/siU", $share_code, $matches, PREG_SET_ORDER)) {
      // Loop over the URLs from the <script> tags
      foreach ($matches as $match) {
        // Check if it's a URL for the JSON file
        if (strpos($match[2], 'http://www.google.com/reader/public/javascript/user/') === 0
          || strpos($match[2], 'https://www.google.com/reader/public/javascript/user/') === 0) {
          return _google_reader_shared_items_save_url($match[2]);
        }
      }
    }
  }
}

/**
 * Implements hook_block_view().
 */
function google_reader_shared_items_block_view($delta) {
  if ($delta == 'shared_items') {
    $block['subject'] = t('Google Reader Shared Items');
    $block['content'] = _google_reader_shared_items_list();
  }
  return $block;
}

/**
 * Implements hook_block().
 */
function google_reader_shared_items_block_OLD($op = 'list', $delta = 0, $edit = array()) { }


/**
 * Strip out the relevant part of the JSON URL and save it
 */
function _google_reader_shared_items_save_url($url) {
  $url_parts = parse_url($url);
  $url = 'http://' . $url_parts['host'] . $url_parts['path'];
  variable_set('google_reader_shared_items_sharing_code', $url);
  return true;
}


/**
 * Get the content for the Google Reader Shared Items block
 */
function _google_reader_shared_items_list() {
  $headers = array();
  $options = array('query' => array('n' => variable_get('google_reader_shared_items_count', 10)));
  $url = url(variable_get('google_reader_shared_items_sharing_code', ''), $options);

  $requests[$url] = $request = drupal_http_request($url, array('headers' => $headers));
  if ($request->code == 200 && !empty($request->data)) {
    $shared_item_object = json_decode($request->data);
    $item_list = array();
    foreach ($shared_item_object->items as $item) {
      $url = $item->alternate->href;
      if (isset($item->title) && !empty($item->title)) {
        $title = $item->title;
      }
      else {
        $title = t("(no title)");
      }
      $item_list[] = l($title, $url);
    }
    return theme('item_list', array('items' => $item_list));
  }
  return "could not retrieve data";
}
