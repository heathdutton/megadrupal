<?php

function dynatree_init() {

  //add dependencies for the script
  drupal_add_library('system', 'jquery.cookie', TRUE);
  drupal_add_library('system', 'ui', TRUE);
  drupal_add_library('system', 'ui', TRUE);
  drupal_add_library('system', 'ui.widget', TRUE);

  //add the dynatree lib
  $library_path = libraries_get_path('dynatree');
  drupal_add_js($library_path . '/src/jquery.dynatree.js');

  //add modules js
  $path = drupal_get_path('module', 'dynatree');
  drupal_add_js($path . '/dynatree.settings.js');

  //Menus
  $css_ids = explode("\n", variable_get('dynatree_forms_ids', '#primary-menu-bar nav'));
  $css_ids = array_filter(array_map('trim', $css_ids));


  $theme_select = variable_get('dynatree_theme_select', 'default');

  if ($theme_select == 'custom') {
    //CUSTOM SKIN
    $customThemePath = variable_get('dynatree_custom_theme_path', '');
    drupal_add_css($customThemePath);
  }
  else {
    //STANDARD SKINS
    $skin = variable_get('dynatree_script_themes', 'skin');
    drupal_add_css($library_path . '/src/' . $skin . '/ui.dynatree.css');
  }


  //push settings to the js.
  drupal_add_js(array(
    'dynatreeMenus'           => $css_ids,
  ), 'setting');


}


/**
 * implementation of hook_menu()
 */
function dynatree_menu() {
  $items = array();

  $items['admin/config/user-interface/dynatree'] = array(
    'title'            => 'Dynatree',
    'description'      => 'Configure dynatree',
    'page callback'    => 'drupal_get_form',
    'page arguments'   => array('dynatree_admin_settings_form'),
    'access arguments' => array('administer site configuration'),
    'file'             => 'dynatree.admin.inc',
  );

  return $items;
}


/**
 * Standard drupal menus have a class "expanded" when you set children of trees to be opened on default
 * "expanded" tells dynatree to open the menu by default. We do not want that and so remove these expanded classes
 * on "dynatree enabled menus"
 */
function dynatree_preprocess_menu_link(&$variables) {
  //dpm($variables);

  //get selected menus
  //we filter out non selected menus, value 0
  $menus = array_filter(variable_get('dynatree_id_list', array()));

  $l = &$variables['element']['#original_link'];



  //go to all selected menus and remove class if selected
  foreach ($menus as $key => $menu_name) {

      if ($l['menu_name'] == $menu_name) {
        unset($variables['element']['#attributes']['class']);
      }

      //set the items of the manu to be expanden, otherwise there is no tree...
      $update_db = db_update('menu_links')
        ->fields(array(
        'expanded' => 1,
      ))
        ->condition('menu_name', $menu_name)
        ->execute();

    }

}




