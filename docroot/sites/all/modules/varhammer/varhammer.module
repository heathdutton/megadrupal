<?php
/**
 * @file
 * Code for the VarHammer (of steel) module.
 */

/**
 * Implements hook_menu().
 */
function varhammer_menu() {
  $items['admin/config/varhammer'] = array(
    'title' => 'VarHammer',
    'description' => 'Contains the settings pages generated by VarHammer',
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('access administration pages'),
    'position' => 'right',
    'weight' => -50,
    'file' => 'system.admin.inc',
    'file path' => 'modules/system',
  );
  // Generate the menu entries for each settings form.
  foreach (variable_get('varhammer_settings', array()) as $key => $section) {
    $items['admin/config/varhammer/' . $key] = array(
      'title' => $section['title'],
      'description' => isset($section['description']) ? $section['description'] : '',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('varhammer_settings_form', $key),
      'access arguments' => array($section['permission']),
    );
  }
  return $items;
}

/**
 * Form callback for the settings form.
 * 
 * @param string $settings_section
 *   The key of the section in the settings array used for this form.
 */
function varhammer_settings_form($form, &$form_state, $settings_section) {
  $form = array();
  $form['#settings_section'] = $settings_section;
  $config = variable_get('varhammer_settings', array());
  $settings = $config[$settings_section]['settings'];
  foreach ($settings as $key => $name) {
    $form[$key] = array(
      '#type' => 'textfield',
      '#title' => $name,
      '#default_value' => variable_get($key, ''),
    );
  }
  return system_settings_form($form);
}
