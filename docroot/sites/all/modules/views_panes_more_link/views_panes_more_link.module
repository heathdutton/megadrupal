<?php
/**
 * Implements hook_form_alter.
 */
function views_panes_more_link_form_alter(&$form, &$form_state, $form_id) {
  if($form_id == "views_content_views_panes_content_type_edit_form"){
    $conf = $form_state['conf'];
    $form['more_link'] = array(
      '#type' => 'fieldset',
      '#title' => t('More link'),
      '#collapsible' => TRUE,
      '#collapsed' => FALSE,
      "#weight" => 15,
    );
    $form['more_link']['more_title'] = array(
      '#type' => 'textfield',
      '#title' => t('Title'),
      '#size' => 50,
      '#description' => t('More link title.'),
      '#default_value' => !empty($conf['more_title']) ? $conf['more_title'] : '',
    );
    $form['more_link']['more_url'] = array(
      '#type' => 'textfield',
      '#title' => t('Url'),
      '#size' => 50,
      '#description' => t('More link url.'),
      '#default_value' => !empty($conf['more_url']) ? $conf['more_url'] : '',
    );
    $form['more_link']['more_wrapper'] = array(
      '#type' => 'textfield',
      '#title' => t('Wapper element'),
      '#size' => 50,
      '#description' => t('More link html wrapper element, default is "div"'),
      '#default_value' => !empty($conf['more_wrapper']) ? $conf['more_wrapper'] : "div",
    );
    $form['more_link']['more_class'] = array(
      '#type' => 'textfield',
      '#title' => t('Class'),
      '#size' => 50,
      '#description' => t('Class to be added to the href.'),
      '#default_value' => !empty($conf['more_class']) ? $conf['more_class'] : '',
    );
    $form['more_link']['in_title'] = array(
      '#type' => 'checkbox',
      '#title' => t('In title'),
      '#size' => 50,
      '#description' => t('Embed the more link inside the pane title?'),
      '#default_value' => !empty($conf['in_title']) ? $conf['in_title'] : 0,
    );

    $form['#submit'][] = 'views_panes_more_link_pane_more_link_form_submit'; 
  }
}

/*
* Form submit handler, to handle the new configurations added to the pane settings form
*/
function views_panes_more_link_pane_more_link_form_submit($form, &$form_state) {
  $form_state['conf']['more_title'] = $form_state['values']['more_title'];
  $form_state['conf']['more_url'] = $form_state['values']['more_url'];
  $form_state['conf']['more_wrapper'] = $form_state['values']['more_wrapper'];
  $form_state['conf']['more_class'] = $form_state['values']['more_class'];
  $form_state['conf']['in_title'] = $form_state['values']['in_title'];
}

/*
* Implements hook_preprocess_panels_pane
*/
function views_panes_more_link_preprocess_panels_pane(&$variables) {
  $conf = $variables['pane']->configuration;
  if ($variables['pane']->type == 'views_panes' && !empty($conf['more_title']) && !empty($conf['more_url'])) {
    $title = $conf['more_title'];
    $url = $conf['more_url'];
    $class = $conf['more_class'] ? $conf['more_class'] : '';
    $wrapper = $conf['more_wrapper'] ? $conf['more_wrapper'] : 'div';
    $link = l(t($title), $url, array(
      'attributes' => array(
        'class' => array(
          $class,
          ),
        ),
      )
    );
    if($conf['in_title']){
      $variables['title'] = t($variables['title'], array(), array("context" => "panels:pane:more:link:title")) . '<' . $wrapper . ' class="' . $class . '">' . $link . '</'. $wrapper .'>';
    }else{
      $variables['more'] =  '<' . $wrapper . ' class="' . $class . '">' . $link . '</'. $wrapper .'>';
    }
  }
}