<?php

/**
 * @file
 * Utilizes the LibAnswers API to show questions and answers to site visitors.
 */


/**
 * Define constants.
 */
define('LIBANSWERS_DOMAIN', variable_get('libanswers_domain'));
define('LIBANSWERS_ID', variable_get('libanswers_id'));
define('LIBANSWERS_CHAT_CODE', variable_get('libanswers_chat_code'));

/**
 * Implements hook_permission().
 */
function libanswers_permission() {
  return array(
    'configure libanswers' => array(
      'title' => t('Configure LibAnswers'),
      'description' => t('Allows users to make configuration changes for the LibAnswers block/pages displayed on the site.'),
    ),
  );
}

/**
 * Implements hook_init().
 */
function libanswers_init() {
  // Opted to using page-specific JS embeds below because was getting an error related to zIndex that
  // didn't appear to have a resolution w/ the jQuery Update versions of the CSS/scripts.
  /*drupal_add_library('system', 'ui.widget');
  drupal_add_library('system', 'ui.position');
  drupal_add_library('system', 'ui.autocomplete');*/
  drupal_add_js(array('libanswers' => array('id' => LIBANSWERS_ID, 'domain' => str_replace('http://', '', str_replace('https://', '', LIBANSWERS_DOMAIN)))), 'setting');
  drupal_add_js(drupal_get_path('module', 'libanswers') . '/libanswers.min.js', 'file');
}

/**
 * Implements hook_block_info().
 */
function libanswers_block_info() {
  $blocks = array();
  $blocks['libanswers'] = array(
    'info' => 'LibAnswers: Featured Answers'
  );
  $blocks['libanswers_chat'] = array(
    'info' => 'LibAnswers: Chat'
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function libanswers_block_view($delta = '') {
  $block = array();

  if ($delta == 'libanswers') {
    $block['subject'] = 'LibAnswers: Featured Answers';
    $block['content'] = libanswers_get_answers_block();
  }
  else if ($delta == 'libanswers_chat') {
    $block['subject'] = 'Ask Us';
    $block['content'] = libanswers_get_chat_block();
  }

  return $block;
}

/**
 * Implements hook_menu().
 */
function libanswers_menu() {
  $items['admin/config/user-interface/libanswers'] = array(
    'title' => t('LibAnswers'),
    'description' => t('Utilizes the LibAnswers API to show questions and answers to site visitors.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('libanswers_settings'),
    'file' => 'libanswers.admin.inc',
    'access arguments' => array('configure libanswers'),
    'type' => MENU_NORMAL_ITEM
  );
  // Add a menu callback that accepts a question ID. Then, run the single question/answer api to determine the page contents.
  // This will display the answer to the user in a page. Should look like libanswers/%
  $items['ask-us/answer/%'] = array(
    'title' => t('Ask a Librarian'),
    'page callback' => 'libanswers_page_get_answer',
    'page arguments' => array(2),
    'file' => 'libanswers.pages.inc', // Move page callback functions to an include file or else they're called on each page load.
    'access callback' => TRUE,
    'type' => MENU_CALLBACK
  );
  // A simple page to display the search form and a tag cloud
  $items['ask-us'] = array(
    'title' => t('Ask a Librarian'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('libanswers_search_form'),
    'file' => 'libanswers.pages.inc',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK
  );
  $items['ask-us/search-results'] = array(
    'title' => t('Search Results'),
    'page callback' => 'libanswers_search_results',
    'file' => 'libanswers.pages.inc',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK
  );
  $items['ask-us/search-results-unthemed'] = array(
    'title' => t('Search Results'),
    'page callback' => 'libanswers_search_results_unthemed',
    'file' => 'libanswers.pages.inc',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK
  );
  $items['ask-us/topic'] = array(
    'title' => t('Topics'),
    'page callback' => 'libanswers_page_get_topic_list',
    'file' => 'libanswers.pages.inc',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK
  );
  $items['ask-us/topic/%'] = array(
    'title' => t('Topic Answers'),
    'title callback' => 'libanswers_page_get_topic_title',
    'title arguments' => array(2),
    'page callback' => 'libanswers_page_get_topic_answers',
    'page arguments' => array(2),
    'file' => 'libanswers.pages.inc',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK
  );
  $items['ask-us/block-unthemed'] = array(
    'title' => t('Ask Us'),
    'page callback' => 'libanswers_block_unthemed',
    'file' => 'libanswers.pages.inc',
    'access callback' => TRUE,
    'type' => MENU_CALLBACK
  );
  return $items;
}

/**
 * Builds the content of the basic block. We need to separate this out so that it can be called as either block content or unthemed page content for use in the Javascript.
 */
function libanswers_get_answers_block() {
  $questions = file_get_contents('http://api.libanswers.com/api_answers.php?iid=' . LIBANSWERS_ID . '&type=featured&limit=4&showdet=0&showans=0&break=li&format=html');
  $questions = str_replace(' target="_blank"', '', $questions);
  $questions = str_replace(LIBANSWERS_DOMAIN . '/a.php?qid=', '/ask-us/answer/', $questions);
  $block = '<div id="libanswers-inner">
    <h2>FAQs:</h2>
    ' . $questions . '
    <ul><li><a href="/ask-us">More &raquo;</a></li></ul>
    <form id="libanswers-ajax-form">
      <textarea class="form-textarea" rows="2" cols="10" id="libanswers-ajax-query">Don\'t see your question above? Have feedback? Type it here.</textarea>
      <input type="submit" class="form-submit" value="Submit">
    </form>
  </div>';
  return $block;
}

/**
 * Builds the content of the chat block.
 */
function libanswers_get_chat_block() {
  $minimal_domain = str_replace('http://', '', str_replace('https://', '', LIBANSWERS_DOMAIN));
  /*<!-- Springshare Chat code //-->
  <div id="libchat_inline_widget"> &nbsp;</div>
  <script type="text/javascript">
   var libchat_inline = {
     iid: "' . LIBANSWERS_ID . '",
     key: "39120b8206ff8ec",
     domain: "' . $minimal_domain . '",
     color_backg: "#CFE9F5",
     color_border: "#CFE9F5",
     color_heading: "#008EB6",
     splash: "Ask Us",
     width: "262px",
     star_ratings: false,
     la_hide: true,
     la_hide_msg: "Sorry, chat is offline. <a href=\"/ask-us\">Search the Knowledge Base or Submit your Question</a>",
     depart_id: "930"
   };
  </script>
  <!-- End Springshare Chat code //-->*/
  $modified_chat_code = trim(preg_replace('/\s+/', ' ', LIBANSWERS_CHAT_CODE));
  preg_match('/width:(\d+)\s.*libchat_([^"]*).*/', $modified_chat_code, $matches); // U makes it an ungreedy match.
  $width = $matches[1];
  $hash = $matches[2];
  $block = '<div id="libchat_inline_widget"></div>
  <script>
    var libchat_' . $hash . ' = {
      iid:' . LIBANSWERS_ID . ',
      width:' . $width . '
    }
  </script>
  <script type="text/javascript" src="//askus.richlandlibrary.com/load_chat.php?hash=' . $hash . '&options=libchat_' . $hash . '"></script>';
  return $block;
}

/**
 * Builds the tag cloud.
 */
function libanswers_get_tag_cloud() {
  $tag_cloud = file_get_contents('http://api.libanswers.com/api_topics.php?iid=' . LIBANSWERS_ID . '&list=cloud&sort=name&count=0&limit=100&incempty=0&minsize=80&maxsize=150&format=html');
  $tag_cloud = str_replace(LIBANSWERS_DOMAIN . '/browse.php?tid=', '/ask-us/topic/', $tag_cloud);
  $output .= '<h2>Browse by Popular Topics:</h2>';
  $output .= $tag_cloud;
  $output .= ' - <a href="/ask-us/topic">View All Topics</a>';
  return $output;
}

/**
 * Builds the in-page question form.
 */
function libanswers_get_question_form($header = TRUE) {
  $output = '<div id="libanswers-form-wrapper"><script> var la_iid = \'' . LIBANSWERS_ID . '\'; var la_formelements = [\'intro\', \'question\', \'details\', \'name\', \'email\', \'multi1\', \'multi2\', \'multi3\', \'text1\', \'text2\', \'text3\', \'req\', \'conf\']; var la_css = 0; </script><script src="//api.libanswers.com/js/widget_form.min.js"></script><!--<div id=la_widgetform>-->';
  if ($header == TRUE) {
    $output .= '<h2 class="la_header">' . t('Ask Us a Question or Leave Feedback') . '</h2>';
  }
  else {
    $output .= '<h2 class="la_header">' . t('Not the answer you\'re looking for? Submit your question here.') . '</h2>';
  }
  $output .= '<!--</div>--><div id="la_result"></div><form onsubmit="return la_formSubmit(\'Please enter a question.\', \'Question must not be longer than 150 characters.\', \'Invalid email address.\', \'Please answer all required questions.\', \'Error submitting your question. Please reload the page and try again.\', \'Working...\');" method="post" class="la_askqform_page" id="la_askqform" name="la_askqform"><input type="hidden" value="' . LIBANSWERS_ID . '" name="instid"><input type="hidden" value="4" name="source"><div class="la_askintro">Have a question? We have answers! Leave your question or comment below and we will reply within 24 hours. Please give an e-mail address so we know where to send your answer. We will not share it.</div>
  <div class="la_field form-item" id="la_question"><textarea class="inputtext" id="pquestion" name="pquestion">* Question/Comment</textarea></div>
  <div class="la_field form-item" id="la_details"><textarea class="inputtext" id="pdetails" name="pdetails">More Detail/Explanation</textarea></div>
  <div class="la_field form-item" id="la_name"><input type="text" value="Name" name="pname" id="pname" class="inputtext"></div>
  <div class="la_field form-item" id="la_email"><input type="text" value="* Email" name="pemail" id="pemail" class="inputtext required"></div>
  <div class="la_field form-item" id="la_text1"><input type="text" value="Library Card Number" name="val4" id="val4" class="inputtext"></div>
  <div id="la_required form-item">Fields marked with <span class="reqnote"> *</span> are required.</div>
  <div class="form-item"><input id="qsubmitbutton" type="submit" class="form-submit" value="Submit Your Question"></div></form></div>';
  return $output;
}
