<?php
/**
 * @file
 * Primary hook implementations for Broadstreet Ads.
 */

/**
 * Implements hook_init().
 */
function broadstreet_ads_init() {
  // Don't laod anything on admin pages.
  if (path_is_admin(current_path())) {
    return;
  }

  // Don't load anything if there are no zones configured.
  $zones = variable_get('broadstreet_ads_zones', array());
  if (empty($zones)) {
    return;
  }

  // Load the ads initializer.
  $element = array(
    '#type' => 'markup',
    '#markup' => "<script type=\"text/javascript\" src=\"http://cdn.broadstreetads.com/init.js\"></script>\n",
  );
  drupal_add_html_head($element, 'broadstreet_ads');
}

/**
 * Implements hook_permission().
 */
function broadstreet_ads_permission() {
  return array(
    'administer broadstreet ads' => array(
      'title' => 'Administer Broadstreet Ads',
    ),
  );
}

/**
 * Implements hook_menu().
 */
function broadstreet_ads_menu() {
  $items = array();

  $items['admin/config/services/broadstreet-ads'] = array(
    'title' => 'Broadstreet Ads',
    'description' => 'Configure the available Broadstreet Ads ad blocks.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('broadstreet_ads_settings_form'),
    'access callback' => 'user_access',
    'access arguments' => array('administer broadstreet ads'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'broadstreet_ads.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_block_info().
 */
function broadstreet_ads_block_info() {
  $blocks = array();

  // The core block integration can be disabled.
  if (variable_get('broadstreet_ads_blocks', TRUE)) {
    // Load all of the zones.
    $zones = variable_get('broadstreet_ads_zones', array());

    // Add a block for each zone.
    if (!empty($zones) && is_array($zones)) {
      foreach ($zones as $zone_id => $label) {
        $blocks[$zone_id] = array(
          'info' => broadstreet_ads_zone_label($zone_id),
        );
      }
    }
  }

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function broadstreet_ads_block_view($delta) {
  $block = array();

  $vars = array(
    'account_id' => variable_get('broadstreet_ads_account_id'),
    'zone' => $delta,
    'pid' => 0,
  );
  if (!empty($vars['account_id'])) {
    $block['subject'] = '';
    $block['content'] = theme('broadstreet_ad', $vars);
  }

  return $block;
}

/**
 * Implements hook_theme().
 */
function broadstreet_ads_theme() {
  return array(
    'broadstreet_ad' => array(
      'template' => 'broadstreet-ad',
      'variables' => array(
        'pid' => 0,
        'zone' => NULL,
      ),
    ),
    'broadstreet_ads_settings_form' => array(
      'variables' => array(),
    ),
  );
}

/**
 * Implementation of hook_ctools_plugin_dierctory() to let the system know
 * where our content_type plugins are.
 */
function broadstreet_ads_ctools_plugin_directory($owner, $plugin_type) {
  if ($owner == 'ctools') {
    return 'plugins/' . $plugin_type;
  }
}

/**
 * Format a standard label for the ad zones.
 */
function broadstreet_ads_zone_label($zone_id) {
  $zones = variable_get('broadstreet_ads_zones', array());
  $label = '';

  if (isset($zones[$zone_id])) {
    $label = $zones[$zone_id];
    if (is_numeric($label)) {
      $label = '#' . $label;
    }
    $label = t('Broadstreet Ad: !label', array('!label' => $label));
  }
  else {
    $label = t('Unknown zone "!zone_id"', array('!zone_id' => '$zone_id'));
  }

  return $label;
}
