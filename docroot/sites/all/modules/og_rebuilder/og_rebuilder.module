<?php

/**
 * @file
 * Main file for OG Rebuilder module.
 */

define('OG_REBUILDER_REBUILD', 'og_rebuilder_rebuild');

/**
 * Implements hook_form_BASE_FORM_ID_alter() for node_form form.
 */
function og_rebuilder_form_node_form_alter(&$form, &$form_state, $form_id) {
  $node = $form_state['node'];

  if (empty($node->{OG_ACCESS_FIELD}) || empty($node->nid)) {
    return;
  }

  $form['#submit'][] = 'og_rebuilder_form_node_form_submit';
}

/**
 * Submit callback for node_form form.
 *
 * Compares the previous node access state and the current state, and if it
 * has changed, triggers an access rebuild for its contents.
 *
 * @see og_rebuilder_form_node_form_alter().
 */
function og_rebuilder_form_node_form_submit(&$form, &$form_state, $form_id) {
  $current_access_mode = $form_state['values'][OG_ACCESS_FIELD][LANGUAGE_NONE][0]['value'];
  $previous_access_mode = $form_state['node']->{OG_ACCESS_FIELD}[LANGUAGE_NONE][0]['value'];

  if ($current_access_mode == $previous_access_mode) {
    return;
  }

  $nid = &drupal_static(OG_REBUILDER_REBUILD);
  $nid = $form_state['node']->nid;
}

/**
 * Implements hook_exit().
 *
 * Rebuilds the access permissions for a given group if it's access permission
 * has changed.
 *
 * @see og_rebuilder_form_node_form_submit().
 */
function og_rebuilder_exit() {
  $nid = drupal_static(OG_REBUILDER_REBUILD, false);

  if ($nid) {
    og_rebuilder_access_rebuild(node_load($nid));
  }
}

/**
 * Rebuilds the access permissions for a given group.
 *
 * This is a re-implementation of node_access_rebuild() but runs only for
 * a given group instead for all content.
 *
 * @TODO In the future groups might be too large and this may require a batch.
 */
function og_rebuilder_access_rebuild($node) {

  // Fetch all content related with this group.
  $sql = "SELECT etid FROM {og_membership} WHERE group_type = 'node' AND gid = :gid";
  $args = array(':gid' => $node->nid);

  $results = db_query($sql, $args)->fetchAllAssoc('etid');
  $nids = array_keys($results);

  $nodes = node_load_multiple($nids);

  // Rebuild the group child nodes permissions.
  foreach ($nodes as $child_node) {
    node_access_acquire_grants($child_node);
  }

  cache_clear_all();
}
