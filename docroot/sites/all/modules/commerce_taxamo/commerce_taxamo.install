<?php

/**
 * @file
 * Install, update, and uninstall functions for the Taxamo for Commerce module.
 */


/**
 * Implements hook_requirements().
 */
function commerce_taxamo_requirements($phase) {
  $requirements = array();

  $t = get_t();

  if ($phase == 'runtime') {
    // Check the results of the test
    if (commerce_taxamo_load_taxamo_php()) {
      $min_version = '1.0.15';

      $value_variables = array(
        '%min_version' => $min_version,
      );

      $correct_version = FALSE;

      if (property_exists('Taxamo', 'VERSION')) {
        $version = Taxamo::$VERSION;
        $value_variables['%version_installed'] = $version;
        if (version_compare($min_version, $version, '<=')) {
          $correct_version = TRUE;
        }
      }

      if ($correct_version) {
        $severity = REQUIREMENT_OK;
        $value = $t('Taxamo PHP library %version_installed installed.', $value_variables);
      }
      else {
        $severity = REQUIREMENT_ERROR;
        $value = $t('Taxamo PHP library installed, but the module needs at least version %min_version to properly work.', $value_variables);
      }

      $requirements['taxamo-php'] = array(
        'title' => $t('Taxamo PHP'),
        'severity' => $severity,
        'value' => $value,
      );
    }
    else {
      $requirements['taxamo-php'] = array(
        'title' => $t('Taxamo PHP'),
        'description' => $t('Taxamo PHP library not found. Please consult the README.txt for installation instructions.'),
        'severity' => REQUIREMENT_ERROR,
        'value' => $t('Taxamo PHP library not found.'),
      );
    }
  }
  return $requirements;
}

/**
 * Implements hook_enable().
 */
function commerce_taxamo_enable() {
  commerce_taxamo_ensure_fields();
  commerce_line_item_configure_line_item_types();
}

/**
 * Implements hook_uninstall().
 */
function commerce_taxamo_uninstall() {
  // Delete variables created.
  variable_del('commerce_taxamo_public_token');
  variable_del('commerce_taxamo_private_token');
  variable_del('commerce_taxamo_product_type_default_value');
  variable_del('commerce_taxamo_tax_rate');
  variable_del('commerce_taxamo_component_display_title');
  variable_del('commerce_taxamo_order_statuses_delete');
  variable_del('commerce_taxamo_order_statuses_precalculate');
  variable_del('commerce_taxamo_order_statuses_confirm');
  variable_del('commerce_taxamo_tax_included');
  variable_del('commerce_taxamo_country_detection');
  variable_del('commerce_taxamo_country_defined');

  // Delete Custom Fields created.
  field_delete_field('commerce_taxamo_product_type');
}

/**
 * Removes unused table {commerce_taxamo_transactions}.
 */
function commerce_taxamo_update_7101(&$sandbox) {
  if (db_table_exists('commerce_taxamo_transactions')) {
    db_drop_table('commerce_taxamo_transactions');
  }
}
