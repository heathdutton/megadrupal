<?php

/**
 * @file
 * Module implementing page to show the image styles with preview and additional
 * information (effects).
 */

/**
 * Define translation context.
 */
define('IMAGE_STYLES_INFO_TRANSLATE_CONTEXT', 'image_styles_info');

/**
 * Implements hook_menu().
 */
function image_styles_info_menu() {
  return array(
    'admin/reports/image-styles-list' => array(
      'title' => 'Image Styles list',
      'page callback' => 'image_styles_info_page',
      'access arguments' => array('administer image styles'),
      'type' => MENU_NORMAL_ITEM,
    ),
  );
}

/**
 * Callback function to return image styles info page.
 */
function image_styles_info_page() {
  module_load_include('inc', 'image', 'image.admin');

  // Use in translation context.
  $context = array(
    'context' => IMAGE_STYLES_INFO_TRANSLATE_CONTEXT,
  );

  // Prepare header of the table.
  $header = array(
    t('Style name', array(), $context),
    t('Effects', array(), $context),
    t('Preview', array(), $context),
  );

  // Get array of all image styles.
  $styles = image_styles();

  // Get path of sample image.
  $preview_image_path = variable_get('image_styles_info_sample');

  // If sample image doesn't provided then get path of default sample image.
  if (empty($preview_image_path)) {
    $preview_image_path = drupal_get_path('module', 'image_styles_info') . '/images/sample.jpg';
  }

  $rows = array();
  foreach ($styles as $style) {
    $image_style_path = image_style_path($style['name'], $preview_image_path);

    // Generate image style file if doesn't exists.
    if (!file_exists($image_style_path)) {
      image_style_create_derivative($style, $preview_image_path, $image_style_path);
    }

    // Add cache_bypass to reload image per re-load page.
    $image_style_path = file_create_url($image_style_path) . '?cache_bypass=' . REQUEST_TIME;

    $image = theme('image', array(
      'path' => $image_style_path,
      'title' => t('Click to open image in new window (tab)', array(), $context),
      'alt' => t('Sample image', array(), $context),
    ));

    $style_url = 'admin/config/media/image-styles/edit/' . $style['name'];
    $effects = image_styles_info_effects($style);

    $rows[$style['name']] = array(
      l($style['name'], $style_url, array(
        'attributes' => array(
          'title' => t('Click to edit image style', array(), $context),
        ),
      )),
      $effects,
      l($image, $image_style_path, array(
        'html' => TRUE,
        'attributes' => array('target' => '_blank'),
      )),
    );
  }

  // Sort image styles by machine name.
  ksort($rows);

  return theme('table', array(
    'header' => $header,
    'rows' => $rows,
  ));
}

/**
 * Helper function to get additional info (effects) of image style settings.
 *
 * @param $style
 *   The data of the style.
 * @return String of the additional info (effects) of the style.
 */
function image_styles_info_effects($style) {
  $effects = array();

  foreach ($style['effects'] as $effect) {
    $summary = isset($effect['summary theme']) ? theme($effect['summary theme'], array('data' => $effect['data'])) : '';
    $effects[] = $effect['label'] . (empty($summary) ? '' : ' ' . $summary);
  }

  return theme('item_list', array(
    'items' => $effects,
  ));
}
