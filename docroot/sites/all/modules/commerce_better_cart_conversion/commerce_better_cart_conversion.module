<?php

/**
 * Implements hook_menu().
 */
function commerce_better_cart_conversion_menu() {
  $items = array();

  $items['admin/commerce/config/cart_conversion'] = array(
    'title' => 'Cart Conversion',
    'description' => 'Configure the settings for the Cart Conversion module',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('commerce_better_cart_conversion_admin_form'),
    'access arguments' => array('administer commerce cart conversion'),
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function commerce_better_cart_conversion_permission() {
  return array(
    'administer commerce cart conversion' => array(
      'title' => t('Administer commerce cart conversion'),
      'description' => t('Set the settings for the commerce cart conversion module'),
    ),
  );
}

/**
 * Form builder function to build the admin settings form
 */
function commerce_better_cart_conversion_admin_form($form, &$form_state) {

  $form['commerce_better_cart_conversion_states'] = array(
    '#type' => 'select',
    '#options' => commerce_order_status_options_list(),
    '#multiple' => TRUE,
    '#default_value' => variable_get('commerce_better_cart_conversion_states', array()),
    '#title' => t('Cart states'),
    '#description' => t('When a user logs in, the orders with the selected statuses will be set to <em>canceled_cart</em>.'),
    '#size' => 20,
  );

  return system_settings_form($form);
}

/**
 * Implements hook_commerce_cart_order_convert().
 */
function commerce_better_cart_conversion_commerce_cart_order_convert($order_wrapper, $account) {
  // Update any old cart orders to be canceled_cart...
  $cart_statuses = variable_get('commerce_better_cart_conversion_states', array());

  // Start the query
  $query = db_select('commerce_order', 'co')
           ->fields('co', array('order_id'))
           ->condition('co.uid', $account->uid)
           ->condition('co.status', $cart_statuses);

  // Domain access?
  if (module_exists('domain')) {
    $domain = domain_get_domain();
    $query->condition('co.domain_id', $domain['domain_id']);
  }

  $results = $query->execute();
  foreach ($results as $result) {
    $order = commerce_order_load($result->order_id);
    if ($order) {
      commerce_order_status_update($order, 'canceled_cart', FALSE, TRUE, t('Cart order orphaned by user logged in.'));
    }
  }
}

/**
 * Implements hook_commerce_order_status_info().
 */
function commerce_better_cart_conversion_commerce_order_status_info() {
  $order_statuses = array();

  $order_statuses['canceled_cart'] = array(
    'name' => 'canceled_cart', 
    'title' => t('Orphaned Cart'), 
    'state' => 'canceled',
  );

  return $order_statuses;
}
