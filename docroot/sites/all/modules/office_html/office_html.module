<?php

/**
 * @file
 * Comments out Microsoft Office-generated HTML.
 *
 * This file is where the magic happens.
 */

/**
 * Implements hook_filter_info().
 */
function office_html_filter_info() {
  $filters['office_html_strip'] = array(
    'title' => t('Strip style, script, and xml tags and content'),
    'description' => t('Removes header tags (style, script, xml) and all included content, otherwise left behind by the core HTML filter.'),
    'prepare callback' => '_office_html_filter_strip',
    'tips callback' => '_office_html_filter_strip_tips',
  );
  $filters['office_html_convert'] = array(
    'title' => t('Convert HTML entities to standard text'),
    'description' => t('Converts HTML entities generated by Office programs into standard text entities.'),
    'prepare callback' => '_office_html_filter_convert',
    'tips callback' => '_office_html_filter_convert_tips',
  );
  return $filters;
}

/**
 * Callback for strip filter.
 */
function _office_html_filter_strip($text, $filter, $format, $langcode, $cache, $cache_id) {
  $text = preg_replace('/<style.*?<\/style>/xmsi', '', $text);
  $text = preg_replace('/<xml.*?<\/xml>/xmsi', '', $text);
  $text = preg_replace('/<script.*?<\/script>/xmsi', '', $text);
  $text = preg_replace('/<w:WordDocument.*?<\/w:WordDocument>/xmsi', '', $text);
  return $text;
}

/**
 * Callback for conversion filter.
 */
function _office_html_filter_convert($text, $filter, $format, $langcode, $cache, $cache_id) {
  $find = array('&#039;', '&#0160;', '&nbsp;', '', '', '', '', '&rsquo;', '&lsquo;', '&ldquo;', '&rdquo;', '&mdash;', '&ndash;');
  $replace = array("'", ' ', ' ', '"', '"', "'", "'", "'", "'", '"', '"', '--', '-');
  return str_replace($find, $replace, $text);
}

/**
 * Filter tips for strip filter.
 */
function _office_html_filter_strip_tips($filter, $format, $long) {
  return t('HTML header tags generated by Microsoft Office are stripped');
}

/**
 * Filter tips for conversion filter.
 */
function _office_html_filter_convert_tips($filter, $format, $long) {
  return t('HTML entities generated by Microsoft Office are converted to plain-text equivalents');
}
