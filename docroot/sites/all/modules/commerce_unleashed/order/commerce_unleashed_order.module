<?php

/**
 * Impliments hook_views_api()
 */
function commerce_unleashed_order_views_api() {
  return array(
    'api' => 3,
  );
}

function commerce_unleased_order_post($commerce_order) {

  $order = views_json_get('unleashed_order_json', 'default', array($commerce_order->order_id));

  $owner = user_load($commerce_order->uid);
  $order->Customer = new stdClass();
  $order->Customer->Guid = $owner->uuid;

  $line_items = views_json_get('unleashed_line_item_json', 'default', array($commerce_order->order_id));

  foreach ($line_items->SalesOrderLines as $key => $SalesOrderLine) {
    $sku = $SalesOrderLine->Product;
    $commerce_product = commerce_product_load_by_sku($sku);
    $line_items->SalesOrderLines[$key]->Product = new stdClass();
    $line_items->SalesOrderLines[$key]->Product->Guid = $commerce_product->uuid;
    $line_items->SalesOrderLines[$key]->Product->ProductCode = $sku;
  }

  $order->SalesOrderLines = $line_items->SalesOrderLines;

  $order->Tax = new stdClass();
  $order->Tax->TaxCode = 'None';

  watchdog('commerce_unleashed', '<pre>' . print_r(json_encode($order), TRUE) . '</pre>');

  $endpoint = '/SalesInvoices/';
  $responce = commerce_unleashed_post_json($endpoint, $commerce_order->uuid, $order);

  watchdog('commerce_unleashed', '<pre>' . print_r($responce, TRUE) . '</pre>');
}
