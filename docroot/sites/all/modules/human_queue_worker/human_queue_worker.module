<?php

/**
 * @file human_queue_worker.module
 * Allows human users to work on processing queue items.
 */

/**
 * Implements hook_menu().
 */
function human_queue_worker_menu() {
  $items['queue_processing'] = array(
    'title' => 'Queue processing',
    'page callback' => 'human_queue_worker_overview_page',
    'access callback' => 'human_queue_worker_queue_access',
    'access arguments' => array(),
    'file' => 'human_queue_worker.pages.inc',
    'type' => MENU_SUGGESTED_ITEM,
  );

  $items['queue_processing/%'] = array(
    'title' => 'Queue processing',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('human_queue_worker_form', 1),
    'access callback' => 'human_queue_worker_queue_access',
    'access arguments' => array(1),
    'file' => 'human_queue_worker.pages.inc',
    'type' => MENU_SUGGESTED_ITEM,
  );

  return $items;
}

/**
 * Menu access callback.
 *
 * @param $queue_name
 *  (optional) The machine name of a queue that humans may work on. If omitted,
 *  access is granted if the user has access to at least one out of all the
 *  queues defined.
 */
function human_queue_worker_queue_access($queue_name = NULL) {
  $human_queue_info = module_invoke_all('human_queue_worker_info');

  // If a queue was requested that doesn't exist, deny access.
  if (isset($queue_name) && !isset($human_queue_info[$queue_name])) {
    return FALSE;
  }

  if (user_access('process all human queues')) {
    return TRUE;
  }

  if (isset($queue_name)) {
    if (user_access("process queue $queue_name")) {
      return TRUE;
    }
  }
  else {
    // If no queue name was given, grant access if the user may work on any of
    // the queues.
    foreach ($human_queue_info as $queue_name => $info) {
      if (user_access("process queue $queue_name")) {
        return TRUE;
      }
    }
  }

  return FALSE;
}

/**
 * Implements hook_permission().
 */
function human_queue_worker_permission() {
  $permissions = array(
    'process all human queues' =>  array(
      'title' => t('Process all human queues'),
      'description' => t('Perform processing of entities in all queues defined for human processing.'),
    ),
  );

  foreach (module_invoke_all('human_queue_worker_info') as $queue_name => $queue_info) {
    $permissions["process queue $queue_name"] = array(
      'title' => t('Process human queue %label', array(
        '%label' => $queue_info['label'],
      )),
    );
  }

  return $permissions;
}
