<?php


define('ALEXA_SITE_INFO_SIZE', '120 x 95');
define('ALEXA_TRAFFIC_RANK_SIZE', '120 x 65');
define('ALEXA_WIDGETS_PERM', 'administer alexa widgets');

/**
 * 
 * Implements hook_perm()
 */
function alexa_widgets_perm() {
  return array(
    ALEXA_WIDGETS_PERM,
  );
}

/**
 * 
 * Implements hook_block_info()
 */
function alexa_widgets_block_info() {
  $blocks['alexa'] = array(
    'info' => t('Alexa widget'),
    'cache' => DRUPAL_NO_CACHE,
  );
  return $blocks;
}
/**
 * 
 * Implements hook_block_view()
 */
function alexa_widgets_block_view($delta = '') {
  switch ($delta) {
    case 'alexa':
      $blocks['subject'] = t('Alexa widget');
      $option = _alexa_widgets_get_widget_option();
      if ($option->typewidget == 0) {
        $blocks['content'] = theme('traffic_graph', 
          array('siteurl1' => $option->siteurl1, 
          'siteurl2' => $option->siteurl2, 
          'siteurl3' => $option->siteurl3, 
          'width' => $option->width, 
          'height' => $option->height, 
          'type' => $option->optiontype, 
          'range' => $option->optionrange, 
          'bgcolor' => $option->bgcolor, ));
      } 
      else {
        if ($option->typewidget == 1) {
          $blocks['content'] = theme('site_info', 
            array('siteurl' => $option->siteurl1, 
            'type' => $option->optiontype, ));
        } 
        else {
          $blocks['content'] = theme('traffic_rank', 
            array('siteurl' => $option->siteurl1, 
            'type' => $option->optiontype, ));
        }
      }
     break;
  }
  return $blocks;
}

function alexa_widgets_theme() {
  return array(
    'traffic_graph' => array(
      'template' => 'alexa_widgets_traffic_graph',
      'variables' => array(
        'siteurl1' => NULL,
        'siteurl2' => NULL,
        'siteurl3' => NULL,
        'width' => 400,
        'height' => 220,
        'type' => 'r',
        'range' => '3m',
        'bgcolor' => 'e6f3fc'
      ),
    ),
    'site_info' => array(
      'template' => 'alexa_widgets_site_info',
      'variables' => array(
        'siteurl' => NULL,
        'type' => ALEXA_SITE_INFO_SIZE
      ),
    ),
    'traffic_rank' => array(
      'template' => 'alexa_widgets_traffic_rank',
      'variables' => array(
        'siteurl' => NULL,
        'type' => ALEXA_TRAFFIC_RANK_SIZE
      ),
    ),
  );
}

function alexa_widgets_menu() {
  $items['admin/settings/alexa_widgets'] = array(
    'title' => 'Alexa Widgets',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('alexa_widgets_setting_form'),
    'description' => 'Setup Alexa widget',
    'type' => MENU_NORMAL_ITEM,
    'access arguments' => array(
      ALEXA_WIDGETS_PERM
    ),
  );
  $items['admin/settings/alexa_widgets/traffic_graph'] = array(
    'title' => 'Setup Alexa traffic graph widget',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('alexa_widgets_traffic_graph_form'),
    'type' => MENU_CALLBACK,
    'access arguments' => array(
      ALEXA_WIDGETS_PERM
    ),
  );
  $items['admin/settings/alexa_widgets/site_info'] = array(
    'title' => 'Setup Alexa Site Info Widget',
    'page callback' => 'alexa_widgets_site_info',
    'type' => MENU_CALLBACK,
    'access arguments' => array(
      ALEXA_WIDGETS_PERM
    ),
  );
  $items['admin/settings/alexa_widgets/traffic_rank'] = array(
    'title' => 'Setup Alexa traffic rank widget',
    'page callback' => 'alexa_widgets_traffic_rank',
    'type' => MENU_CALLBACK,
    'access arguments' => array(
      ALEXA_WIDGETS_PERM
    ),
  );

  return $items;
}

function alexa_widgets_site_info() {
  $option = _alexa_widgets_get_widget_option();
  return drupal_get_form('alexa_widgets_site_info_form', $option);
}

function alexa_widgets_traffic_rank() {
  $option = _alexa_widgets_get_widget_option();
  return drupal_get_form('alexa_widgets_traffic_rank_form', $option);
}

function alexa_widgets_site_info_form($context, $formstatus) {
  $url = '';
  $option = $formstatus['build_info']['args'][0];
  if ($option && $option->siteurl1) {
    $url = $option->siteurl1;
  }
  $form['siteurl'] = array(
    '#type' => 'textfield',
    '#title' => t('Url'),
    '#default_value' => $url,
    
  );
  $default_option = ALEXA_SITE_INFO_SIZE;
  if ($option && $option->typewidget == 1) {
    $default_option = $option->optiontype;
  }
  $form['type'] = array(
    '#type' => 'select',
    '#title' => t('Size'),
    '#default_value' => $default_option,
    '#options' => array(
      '120 x 95' => t('120 x 95'),
      '120 x 240' => t('120 x 240'),
      '468 x 60' => t('468 x 60'),
      
    )
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save'),
    
  );
  return $form;
}

function alexa_widgets_traffic_rank_form($context, $formstatus) {
  $url = '';
  $option = $formstatus['build_info']['args'][0];
  if ($option && $option->siteurl1) {
    $url = $option->siteurl1;
  }
  $form['siteurl'] = array(
    '#type' => 'textfield',
    '#title' => t('Url'),
    '#default_value' => $url,
    
  );
  $default_option = ALEXA_TRAFFIC_RANK_SIZE;
  if ($option && $option->typewidget == 2) {
    $default_option = $option->optiontype;
  }
  $form['type'] = array(
    '#type' => 'select',
    '#title' => t('Size'),
    '#default_value' => $default_option,
    '#options' => array(
      '120 x 65' => t('120 x 65'),
      '120 x 90' => t('120 x 90'),
      '468 x 60' => t('468 x 60'),
      
    )
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save'),
    
  );
  return $form;
}

function alexa_widgets_traffic_rank_form_submit($form, & $form_state) {
  $form_values = $form_state['values'];
  $siteurl = $form_values['siteurl'];
  $type = $form_values['type'];
  _alexa_widgets_update_traffic_rank($siteurl, $type);
}

function alexa_widgets_site_info_form_submit($form, & $form_state) {
  $form_values = $form_state['values'];
  $siteurl = $form_values['siteurl'];
  $type = $form_values['type'];
  _alexa_widgets_update_site_info($siteurl, $type);
}

function alexa_widgets_setting_form() {
  $form['widgettype'] = array(
    '#type' => 'select',
    '#title' => t('Widget type'),
    '#options' => array(
      'site_info' => t('Alexa site info'),
      'traffic_rank' => t('Alexa traffic rank '),
//      'traffic_graph' => t('Alexa traffic graph'),
    )
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Choose widget'),
    
  );
  return $form;
}

function alexa_widgets_traffic_graph_form() {
  $form['siteurl1'] = array(
    '#type' => 'textfield',
    '#title' => t('Site url'),
    
  );
  $form['siteurl2'] = array(
    '#type' => 'textfield',
    '#title' => t('Site url'),
  );
  $form['siteurl3'] = array(
    '#type' => 'textfield',
    '#title' => t('Site url'),
  );
  $form['height'] = array(
    '#type' => 'textfield',
    '#title' => t('Height'),
    
  );
  $form['width'] = array(
    '#type' => 'textfield',
    '#title' => t('Width'),
    
  );
  $form['bgcolor'] = array(
    '#type' => 'textfield',
    '#title' => t('Background color'),
    
  );
  $form['range'] = array(
    '#type' => 'select',
    '#title' => t('Range'),
    '#options' => array(
      '3m' => t('3 months'),
      '7d' => t('7 days'),
      '1m' => t('1 month'),
      '1y' => t('1 year'),
      '3y' => t('3 years'),
      '5y' => t('5 years'),
      'max' => t('Max'),
      
    ),
    
  );
  $form['type'] = array(
    '#type' => 'select',
    '#title' => t('Type'),
    '#options' => array(
      'r' => t('Reach'),
      'n' => t('Rank'),
      'p' => t('Page views'),
      
    ),
    
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save'),
    
  );
  return $form;
}

function alexa_widgets_traffic_graph_form_submit($form, & $form_state) {
  $form_values = $form_state['values'];
  _alexa_widgets_update_traffic_graph($form_values['siteurl1'], $form_values['siteurl2'], $form_values['siteurl3'], $form_values['height'], $form_values['width'], $form_values['bgcolor'], $form_values['range'], $form_values['type']);
}

function alexa_widgets_setting_form_submit($form, & $form_state) {
  $form_values = $form_state['values'];
  $type = $form_values['widgettype'];
  if ($type == 'traffic_graph') {
    $form_state['redirect'] = 'admin/settings/alexa_widgets/traffic_graph';
  }
  else {
    if ($type == 'site_info') {
      $form_state['redirect'] = 'admin/settings/alexa_widgets/site_info';
    }
    else {
      $form_state['redirect'] = 'admin/settings/alexa_widgets/traffic_rank';
    }
  }
}

function _alexa_widgets_update_traffic_graph($url1, $url2, $url3, $height, $width, $bgcolor, $range, $type) {
  db_query("UPDATE {alexaoption} SET typewidget=:typewidget,siteurl1=:siteurl1,siteurl2=:siteurl2,siteurl3=:siteurl3,height=:height,width=:width,bgcolor=:bgcolor,optionrange=:optionrange,optiontype=:optiontype where vid=:vid ", array(':typewidget' => 0, ':siteurl1' => $url1, ':siteurl2' => $url2, ':siteurl3' => $url3, ':height' => $height, ':width'=>$width, ':bgcolor' => $bgcolor, ':optionrange' => $range, ':optiontype' => $type, ':vid' => 1));
}

function _alexa_widgets_update_site_info($url, $type) {
  db_query("UPDATE {alexaoption} SET typewidget=:typewidget,siteurl1=:siteurl1,optiontype=:optiontype where vid=:vid ", array(':typewidget' => 1, ':siteurl1' => $url, ':optiontype'=>$type, ':vid' => 1));
}

function _alexa_widgets_update_traffic_rank($url, $type) {
  db_query("UPDATE {alexaoption} SET typewidget=:typewidget,siteurl1=:siteurl1,optiontype=:optiontype where vid=:vid ", array(':typewidget' => 2, ':siteurl1' => $url, ':optiontype' => $type, ':vid' => 1));
}

function _alexa_widgets_get_widget_option() {
  $res = db_query("SELECT * FROM {alexaoption}");
  $result = array();
  foreach ($res as $record) {
  $result[] = $record;
  }
  return $result[0];
}