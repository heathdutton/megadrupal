<?php
/**
 * @file
 * Homebox packery main file.
 */

require_once 'includes/homebox_packery.admin.inc';

/**
 * Implements hook_library().
 */
function homebox_packery_library() {
  $library = libraries_get_path('packery');

  $libraries['packery'] = array(
    'title' => 'Packery',
    'website' => 'http://packery.metafizzy.co',
    'version' => array(),
    'js' => array(
      $library . '/packery.pkgd.min.js' => array(
        'scope' => 'footer',
      ),
    ),
  );

  return $libraries;
}

/**
 * Load Homebox packery settings for javascript.
 */
function homebox_packery_load_settings($page) {
  // Load settings array.
  // TODO: Check containerStyle why it goes on top when set.
  $settings = array(
    /*'containerStyle' => $page->settings['packery_settings']['container_style'],*/
    'columnWidth' => (int) $page->settings['packery_settings']['column_width'],
    'rowHeight' => (int) $page->settings['packery_settings']['row_height'],
    'gutter' => (int) $page->settings['packery_settings']['gutter'],
    'isHorizontal' => (boolean) $page->settings['packery_settings']['is_horizontal'],
    'isInitLayout' => (boolean) $page->settings['packery_settings']['is_init_layout'],
    'isOriginLeft' => (boolean) $page->settings['packery_settings']['is_origin_left'],
    'isOriginTop' => (boolean) $page->settings['packery_settings']['is_origin_top'],
    'isResizeBound' => (boolean) $page->settings['packery_settings']['is_resize_bound'],
    'itemSelector' => $page->settings['packery_settings']['item_selector'],
    'stamp' => $page->settings['packery_settings']['stamp'],
    'transitionDuration' => $page->settings['packery_settings']['transition_duration'],
  );

  return $settings;
}

/**
 * Preprocesses variables for homebox.tpl.php template.
 *
 * Hook to check if Packery is set or not and add the packery implementation
 */
function homebox_packery_preprocess_homebox(&$variables) {
  // Check if Packery is active for this page.
  if (!empty($variables['page']->settings['packery'])) {
    drupal_add_library('homebox_packery', 'packery');
    $homebox_class = drupal_html_class('packery-' . $variables['page']->name);
    $selector = '.' . $homebox_class . ' .homebox-column';
    $settings = homebox_packery_load_settings($variables['page']);
    drupal_add_js(array('homebox_packery' => array('packery' => array($selector => array('settings' => $settings)))), 'setting');

    $module_path = drupal_get_path('module', 'homebox_packery');
    drupal_add_js($module_path . '/js/homebox_packery.js', array(
      'type' => 'file',
      'scope' => 'header',
      'group' => JS_DEFAULT,
      'defer' => FALSE,
      'cache' => TRUE,
      'preprocess' => TRUE,
      )
    );

    // Add stylesheet to overhide the homebox style.
    drupal_add_css($module_path . '/css/homebox_packery.css', array(
      'type' => 'file',
      'group' => CSS_DEFAULT,
      'media' => 'all',
      'preprocess' => TRUE,
      )
    );

    $variables['classes_array'][] = $homebox_class;
  }
}

/**
 * Preprocesses variables for homebox-block.tpl.php template.
 *
 * If Packery is set, we add class for the not movable blocks.
 */
function homebox_packery_preprocess_homebox_block(&$variables) {
  if (!empty($variables['page']->settings['packery'])) {
    $block_name = $variables['block']->module . '_' . $variables['block']->delta;
    // If the block is not movable.
    if ($variables['page']->settings['blocks'][$block_name]['movable'] == 0) {
      // Add the class from the settings without the point.
      $variables['block']->homebox_classes .= ' ' . substr($variables['page']->settings['packery_settings']['stamp'], 1);
    }
  }
}
