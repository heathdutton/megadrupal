(function(d){var a=Drupal.states={postponed:[]};Drupal.behaviors.states={attach:function(h,i){var g=d(h);for(var f in i.states){for(var j in i.states[f]){new a.Dependent({element:g.find(f),state:a.State.sanitize(j),constraints:i.states[f][j]})}}while(a.postponed.length){(a.postponed.shift())()}}};a.Dependent=function(g){d.extend(this,{values:{},oldValue:null},g);this.dependees=this.getDependees();for(var f in this.dependees){this.initializeDependee(f,this.dependees[f])}};a.Dependent.comparisons={RegExp:function(f,g){return f.test(g)},Function:function(f,g){return f(g)},Number:function(f,g){return(typeof g==="string")?c(f.toString(),g):c(f,g)}};a.Dependent.prototype={initializeDependee:function(f,h){var j;this.values[f]={};for(var g in h){if(h.hasOwnProperty(g)){j=h[g];if(d.inArray(j,h)===-1){continue}j=a.State.sanitize(j);this.values[f][j.name]=null;d(f).bind("state:"+j,d.proxy(function(i){this.update(f,j,i.value)},this));new a.Trigger({selector:f,state:j})}}},compare:function(g,f,i){var h=this.values[f][i.name];if(g.constructor.name in a.Dependent.comparisons){return a.Dependent.comparisons[g.constructor.name](g,h)}else{return c(g,h)}},update:function(f,h,g){if(g!==this.values[f][h.name]){this.values[f][h.name]=g;this.reevaluate()}},reevaluate:function(){var f=this.verifyConstraints(this.constraints);if(f!==this.oldValue){this.oldValue=f;f=e(f,this.state.invert);this.element.trigger({type:"state:"+this.state,value:f,trigger:true})}},verifyConstraints:function(o,j){var h;if(d.isArray(o)){var g=d.inArray("xor",o)===-1;for(var k=0,f=o.length;k<f;k++){if(o[k]!="xor"){var l=this.checkConstraints(o[k],j,k);if(l&&(g||h)){return g}h=h||l}}}else{if(d.isPlainObject(o)){for(var m in o){if(o.hasOwnProperty(m)){h=b(h,this.checkConstraints(o[m],j,m));if(h===false){return false}}}}}return h},checkConstraints:function(h,f,g){if(typeof g!=="string"||(/[0-9]/).test(g[0])){g=null}else{if(typeof f==="undefined"){f=g;g=null}}if(g!==null){g=a.State.sanitize(g);return e(this.compare(h,f,g),g.invert)}else{return this.verifyConstraints(h,f)}},getDependees:function(){var f={};var g=this.compare;this.compare=function(i,h,j){(f[h]||(f[h]=[])).push(j.name)};this.verifyConstraints(this.constraints);this.compare=g;return f}};a.Trigger=function(f){d.extend(this,f);if(this.state in a.Trigger.states){this.element=d(this.selector);if(!this.element.data("trigger:"+this.state)){this.initialize()}}};a.Trigger.prototype={initialize:function(){var f=a.Trigger.states[this.state];if(typeof f=="function"){f.call(window,this.element)}else{for(var g in f){if(f.hasOwnProperty(g)){this.defaultTrigger(g,f[g])}}}this.element.data("trigger:"+this.state,true)},defaultTrigger:function(g,h){var f=h.call(this.element);this.element.bind(g,d.proxy(function(j){var i=h.call(this.element,j);if(f!==i){this.element.trigger({type:"state:"+this.state,value:i,oldValue:f});f=i}},this));a.postponed.push(d.proxy(function(){this.element.trigger({type:"state:"+this.state,value:f,oldValue:null})},this))}};a.Trigger.states={empty:{keyup:function(){return this.val()==""}},checked:{change:function(){return this.is(":checked")}},value:{keyup:function(){if(this.length>1){return this.filter(":checked").val()||false}return this.val()},change:function(){if(this.length>1){return this.filter(":checked").val()||false}return this.val()}},collapsed:{collapsed:function(f){return(typeof f!=="undefined"&&"value" in f)?f.value:this.is(".collapsed")}}};a.State=function(f){this.pristine=this.name=f;while(true){while(this.name.charAt(0)=="!"){this.name=this.name.substring(1);this.invert=!this.invert}if(this.name in a.State.aliases){this.name=a.State.aliases[this.name]}else{break}}};a.State.sanitize=function(f){if(f instanceof a.State){return f}else{return new a.State(f)}};a.State.aliases={enabled:"!disabled",invisible:"!visible",invalid:"!valid",untouched:"!touched",optional:"!required",filled:"!empty",unchecked:"!checked",irrelevant:"!relevant",expanded:"!collapsed",readwrite:"!readonly"};a.State.prototype={invert:false,toString:function(){return this.name}};d(document).bind("state:disabled",function(f){if(f.trigger){d(f.target).attr("disabled",f.value).closest(".form-item, .form-submit, .form-wrapper").toggleClass("form-disabled",f.value).find("select, input, textarea").attr("disabled",f.value)}});d(document).bind("state:required",function(f){if(f.trigger){if(f.value){d(f.target).closest(".form-item, .form-wrapper").find("label").append('<span class="form-required">*</span>')}else{d(f.target).closest(".form-item, .form-wrapper").find("label .form-required").remove()}}});d(document).bind("state:visible",function(f){if(f.trigger){d(f.target).closest(".form-item, .form-submit, .form-wrapper").toggle(f.value)}});d(document).bind("state:checked",function(f){if(f.trigger){d(f.target).attr("checked",f.value)}});d(document).bind("state:collapsed",function(f){if(f.trigger){if(d(f.target).is(".collapsed")!==f.value){d("> legend a",f.target).click()}}});function b(g,f){return typeof g==="undefined"?f:(typeof f==="undefined"?g:g&&f)}function e(f,g){return(g&&typeof f!=="undefined")?!f:f}function c(g,f){return(g===f)?(typeof g==="undefined"?g:true):(typeof g==="undefined"||typeof f==="undefined")}})(jQuery);