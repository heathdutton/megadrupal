(function(e){Drupal.behaviors.autocomplete={attach:function(t,n){var r=[];e("input.autocomplete",t).once("autocomplete",function(){var t=this.value;r[t]||(r[t]=new Drupal.ACDB(t));var n=e("#"+this.id.substr(0,this.id.length-13)).attr("autocomplete","OFF").attr("aria-autocomplete","list");e(n[0].form).submit(Drupal.autocompleteSubmit),n.parent().attr("role","application").append(e('<span class="element-invisible" aria-live="assertive"></span>').attr("id",n.attr("id")+"-autocomplete-aria-live")),new Drupal.jsAC(n,r[t])})}},Drupal.autocompleteSubmit=function(){return e("#autocomplete").each(function(){this.owner.hidePopup()}).length==0},Drupal.jsAC=function(t,n){var r=this;this.input=t[0],this.ariaLive=e("#"+this.input.id+"-autocomplete-aria-live"),this.db=n,t.keydown(function(e){return r.onkeydown(this,e)}).keyup(function(e){r.onkeyup(this,e)}).blur(function(){r.hidePopup(),r.db.cancel()})},Drupal.jsAC.prototype.onkeydown=function(e,t){t||(t=window.event);switch(t.keyCode){case 40:return this.selectDown(),!1;case 38:return this.selectUp(),!1;default:return!0}},Drupal.jsAC.prototype.onkeyup=function(e,t){t||(t=window.event);switch(t.keyCode){case 16:case 17:case 18:case 20:case 33:case 34:case 35:case 36:case 37:case 38:case 39:case 40:return!0;case 9:case 13:case 27:return this.hidePopup(t.keyCode),!0;default:return e.value.length>0&&!e.readOnly?this.populatePopup():this.hidePopup(t.keyCode),!0}},Drupal.jsAC.prototype.select=function(t){this.input.value=e(t).data("autocompleteValue")},Drupal.jsAC.prototype.selectDown=function(){if(this.selected&&this.selected.nextSibling)this.highlight(this.selected.nextSibling);else if(this.popup){var t=e("li",this.popup);t.length>0&&this.highlight(t.get(0))}},Drupal.jsAC.prototype.selectUp=function(){this.selected&&this.selected.previousSibling&&this.highlight(this.selected.previousSibling)},Drupal.jsAC.prototype.highlight=function(t){this.selected&&e(this.selected).removeClass("selected"),e(t).addClass("selected"),this.selected=t,e(this.ariaLive).html(e(this.selected).html())},Drupal.jsAC.prototype.unhighlight=function(t){e(t).removeClass("selected"),this.selected=!1,e(this.ariaLive).empty()},Drupal.jsAC.prototype.hidePopup=function(t){this.selected&&(t&&t!=46&&t!=8&&t!=27||!t)&&(this.input.value=e(this.selected).data("autocompleteValue"));var n=this.popup;n&&(this.popup=null,e(n).fadeOut("fast",function(){e(n).remove()})),this.selected=!1,e(this.ariaLive).empty()},Drupal.jsAC.prototype.populatePopup=function(){var t=e(this.input),n=t.position();this.popup&&e(this.popup).remove(),this.selected=!1,this.popup=e('<div id="autocomplete"></div>')[0],this.popup.owner=this,e(this.popup).css({top:parseInt(n.top+this.input.offsetHeight,10)+"px",left:parseInt(n.left,10)+"px",width:t.innerWidth()+"px",display:"none"}),t.before(this.popup),this.db.owner=this,this.db.search(this.input.value)},Drupal.jsAC.prototype.found=function(t){if(!this.input.value.length)return!1;var n=e("<ul></ul>"),r=this;for(key in t)e("<li></li>").html(e("<div></div>").html(t[key])).mousedown(function(){r.select(this)}).mouseover(function(){r.highlight(this)}).mouseout(function(){r.unhighlight(this)}).data("autocompleteValue",key).appendTo(n);this.popup&&(n.children().length?(e(this.popup).empty().append(n).show(),e(this.ariaLive).html(Drupal.t("Autocomplete popup"))):(e(this.popup).css({visibility:"hidden"}),this.hidePopup()))},Drupal.jsAC.prototype.setStatus=function(t){switch(t){case"begin":e(this.input).addClass("throbbing"),e(this.ariaLive).html(Drupal.t("Searching for matches..."));break;case"cancel":case"error":case"found":e(this.input).removeClass("throbbing")}},Drupal.ACDB=function(e){this.uri=e,this.delay=300,this.cache={}},Drupal.ACDB.prototype.search=function(t){var n=this;this.searchString=t,t=t.replace(/^\s+|\s+$/,"");if(t.length<=0||t.charAt(t.length-1)==",")return;if(this.cache[t])return this.owner.found(this.cache[t]);this.timer&&clearTimeout(this.timer),this.timer=setTimeout(function(){n.owner.setStatus("begin"),e.ajax({type:"GET",url:n.uri+"/"+Drupal.encodePath(t),dataType:"json",success:function(e){if(typeof e.status=="undefined"||e.status!=0)n.cache[t]=e,n.searchString==t&&n.owner.found(e),n.owner.setStatus("found")},error:function(e){alert(Drupal.ajaxError(e,n.uri))}})},this.delay)},Drupal.ACDB.prototype.cancel=function(){this.owner&&this.owner.setStatus("cancel"),this.timer&&clearTimeout(this.timer),this.searchString=""}})(jQuery);