(function(e){Drupal.behaviors.overlayParent={attach:function(t,n){Drupal.overlay.isOpen&&Drupal.overlay.makeDocumentUntabbable(t);if(this.processed)return;this.processed=!0,e(window).bind("hashchange.drupal-overlay",e.proxy(Drupal.overlay,"eventhandlerOperateByURLFragment")).triggerHandler("hashchange.drupal-overlay"),e(document).bind("click.drupal-overlay mouseup.drupal-overlay",e.proxy(Drupal.overlay,"eventhandlerOverrideLink"))}},Drupal.overlay=Drupal.overlay||{isOpen:!1,isOpening:!1,isClosing:!1,isLoading:!1},Drupal.overlay.prototype={},Drupal.overlay.open=function(t){return this.isOpen||this.isOpening?this.load(t):(this.isOpening=!0,this.originalTitle=document.title,this.create(),this.isOpening=!1,this.isOpen=!0,e(document.documentElement).addClass("overlay-open"),this.makeDocumentUntabbable(),e(document).trigger("drupalOverlayOpen"),this.load(t))},Drupal.overlay.create=function(){this.$container=e(Drupal.theme("overlayContainer")).appendTo(document.body),this.activeFrame=this.$iframeA=e(Drupal.theme("overlayElement")).appendTo(this.$container),this.inactiveFrame=this.$iframeB=e(Drupal.theme("overlayElement")).appendTo(this.$container),this.$iframeA.bind("load.drupal-overlay",{self:this.$iframeA[0],sibling:this.$iframeB},e.proxy(this,"loadChild")),this.$iframeB.bind("load.drupal-overlay",{self:this.$iframeB[0],sibling:this.$iframeA},e.proxy(this,"loadChild"));var t=".drupal-overlay.drupal-overlay-open";e(window).bind("resize"+t,e.proxy(this,"eventhandlerOuterResize")),e(document).bind("drupalOverlayLoad"+t,e.proxy(this,"eventhandlerOuterResize")).bind("drupalOverlayReady"+t+" drupalOverlayClose"+t,e.proxy(this,"eventhandlerSyncURLFragment")).bind("drupalOverlayClose"+t,e.proxy(this,"eventhandlerRefreshPage")).bind("drupalOverlayBeforeClose"+t+" drupalOverlayBeforeLoad"+t+" drupalOverlayResize"+t,e.proxy(this,"eventhandlerDispatchEvent")),e(".overlay-displace-top, .overlay-displace-bottom").length&&e(document).bind("drupalOverlayResize"+t,e.proxy(this,"eventhandlerAlterDisplacedElements")).bind("drupalOverlayClose"+t,e.proxy(this,"eventhandlerRestoreDisplacedElements"))},Drupal.overlay.load=function(t){if(!this.isOpen)return!1;e(document).trigger("drupalOverlayBeforeLoad"),e(document.documentElement).addClass("overlay-loading");var n=this.inactiveFrame[0].contentDocument||this.inactiveFrame[0].contentWindow.document;return n.location.replace(t),!0},Drupal.overlay.close=function(){if(!this.isOpen||this.isClosing)return!1;var t=e.Event("drupalOverlayBeforeClose");return e(document).trigger(t),t.isDefaultPrevented()?!1:(this.isClosing=!0,this.isOpen=!1,e(document.documentElement).removeClass("overlay-open"),document.title=this.originalTitle,this.makeDocumentTabbable(),e(document).trigger("drupalOverlayClose"),this.isLoading||(this.destroy(),this.isClosing=!1),!0)},Drupal.overlay.destroy=function(){e([document,window]).unbind(".drupal-overlay-open"),this.$container.remove(),this.$container=null,this.$iframeA=null,this.$iframeB=null,this.iframeWindow=null},Drupal.overlay.redirect=function(t){var n=e(t.link(t)).get(0);return window.location.href==n.href&&e(window).triggerHandler("hashchange.drupal-overlay"),window.location.href=n.href,!0},Drupal.overlay.bindChild=function(t,n){this.iframeWindow=t;if(n||this.isClosing||!this.isOpen)return;e(document).trigger("drupalOverlayReady")},Drupal.overlay.loadChild=function(t){var n=t.data.self,r=n.contentDocument||n.contentWindow.document,i=r.defaultView||r.parentWindow;if(i.location=="about:blank")return;this.isLoading=!1,e(document.documentElement).removeClass("overlay-loading"),t.data.sibling.removeClass("overlay-active").attr({tabindex:-1});if(this.isOpen&&!this.isClosing)if(i.Drupal&&i.Drupal.overlayChild){document.title=i.document.title,this.activeFrame=e(n).addClass("overlay-active").attr("title",Drupal.t("@title dialog",{"@title":i.jQuery("#overlay-title").text()})).removeAttr("tabindex"),this.inactiveFrame=t.data.sibling,(this.inactiveFrame[0].contentDocument||this.inactiveFrame[0].contentWindow.document).location.replace("about:blank"),this.activeFrame.focus();var s=i.jQuery("a:first");Drupal.overlay.setFocusBefore(s,i.document),e(document).trigger("drupalOverlayLoad")}else window.location=i.location.href.replace(/([?&]?)render=overlay&?/g,"$1").replace(/\?$/,"");else this.destroy()},Drupal.overlay.setFocusBefore=function(t,n){var r=n.createElement("a"),i=e(r).addClass("element-invisible").attr("href","#");i.insertBefore(t),i.focus(),i.one("blur",function(){e(this).remove()})},Drupal.overlay.isAdminLink=function(e){if(Drupal.overlay.isExternalLink(e))return!1;var t=this.getPath(e);if(!this.adminPathRegExp){var n="";Drupal.settings.overlay.pathPrefixes.length&&(n="("+Drupal.settings.overlay.pathPrefixes.join("/|")+"/|)");var r="^"+n+"("+Drupal.settings.overlay.paths.admin.replace(/\s+/g,"|")+")$",i="^"+n+"("+Drupal.settings.overlay.paths.non_admin.replace(/\s+/g,"|")+")$";r=r.replace(/\*/g,".*"),i=i.replace(/\*/g,".*"),this.adminPathRegExp=new RegExp(r),this.nonAdminPathRegExp=new RegExp(i)}return this.adminPathRegExp.exec(t)&&!this.nonAdminPathRegExp.exec(t)},Drupal.overlay.isExternalLink=function(e){var t=RegExp("^((f|ht)tps?:)?//(?!"+window.location.host+")");return t.test(e)},Drupal.overlay.eventhandlerOuterResize=function(t){if(!this.isOpen&&!this.isOpening||this.isClosing||!this.iframeWindow)return;typeof document.body.style.maxHeight!="string"&&this.activeFrame.height(e(window).height()),e(document).trigger("drupalOverlayResize")},Drupal.overlay.eventhandlerAlterDisplacedElements=function(t){if(!this.isOpen&&!this.isOpening||this.isClosing||!this.iframeWindow)return;e(this.iframeWindow.document.body).css({marginTop:Drupal.overlay.getDisplacement("top"),marginBottom:Drupal.overlay.getDisplacement("bottom")}).addClass("overlay-trigger-reflow").removeClass("overlay-trigger-reflow");var n=this.iframeWindow.document.body.clientHeight,r=this.iframeWindow.document.body.clientWidth,i=typeof document.body.style.maxWidth=="string"?"maxWidth":"width";if(Drupal.overlay.leftSidedScrollbarOffset===undefined&&e(document.documentElement).attr("dir")==="rtl")if(e.browser.opera)Drupal.overlay.leftSidedScrollbarOffset=document.documentElement.clientWidth-this.iframeWindow.document.documentElement.clientWidth+this.iframeWindow.document.documentElement.clientLeft;else if(this.iframeWindow.document.documentElement.clientLeft)Drupal.overlay.leftSidedScrollbarOffset=this.iframeWindow.document.documentElement.clientLeft;else{var s=e('<div style="direction: rtl; overflow: scroll;"></div>').appendTo(document.body),o=e("<div></div>").appendTo(s);Drupal.overlay.leftSidedScrollbarOffset=parseInt(o[0].offsetLeft-s[0].offsetLeft),s.remove()}e(".overlay-displace-top, .overlay-displace-bottom").each(function(){var t=e(this).data(),s=r;this.filters&&this.filters.length&&this.filters.item("DXImageTransform.Microsoft.Shadow")&&(s-=1),Drupal.overlay.leftSidedScrollbarOffset&&e(this).css("left",Drupal.overlay.leftSidedScrollbarOffset);var o=parseInt(e(this).css(i));if(t.drupalOverlay&&t.drupalOverlay.maxWidth||isNaN(o)||o>s||o<=0)e(this).css(i,s),(t.drupalOverlay=t.drupalOverlay||{}).maxWidth=!0;var u=e(this).offset(),a=u.left+e(this).outerWidth();if(t.drupalOverlay&&t.drupalOverlay.clip||a>s)Drupal.overlay.leftSidedScrollbarOffset?e(this).css("clip","rect(auto, auto, "+(n-u.top)+"px, "+(Drupal.overlay.leftSidedScrollbarOffset+2)+"px)"):e(this).css("clip","rect(auto, "+(s-u.left)+"px, "+(n-u.top)+"px, auto)"),(t.drupalOverlay=t.drupalOverlay||{}).clip=!0})},Drupal.overlay.eventhandlerRestoreDisplacedElements=function(t){var n=e(".overlay-displace-top, .overlay-displace-bottom");try{n.css({maxWidth:"",clip:""})}catch(r){n.attr("style",function(e,t){return t.replace(/clip\s*:\s*rect\([^)]+\);?/i,"")})}},Drupal.overlay.eventhandlerOverrideLink=function(t){if(t.type=="click"&&t.button==2||t.type=="mouseup"&&t.button!=2)return;var n=e(t.target);if(!n.is("a")){n=n.closest("a");if(!n.length)return}if(n.hasClass("overlay-exclude"))return;if(n.hasClass("overlay-close")){e.bbq.removeState("overlay");return}var r=n[0],i=r.href;if(i!=undefined&&i!=""&&r.protocol.match(/^https?\:/)){var s=i.replace(r.ownerDocument.location.href,"");if(s.length==0||s.charAt(0)=="#")return;if(this.isAdminLink(i)){var o=n.hasClass("overlay-restore")&&typeof e.bbq.getState("overlay-context")=="string"?Drupal.settings.basePath+e.bbq.getState("overlay-context"):null;i=this.fragmentizeLink(n.get(0),o);if(t.button==0&&!t.altKey&&!t.ctrlKey&&!t.metaKey&&!t.shiftKey)return this.redirect(i),!1;n.one("blur mousedown",{target:r,href:r.href},function(t){e(t.data.target).attr("href",t.data.href)}).attr("href",i)}else if(this.isOpen&&r.ownerDocument===this.iframeWindow.document)if(r.hostname!=window.location.hostname)n.attr("target")||n.attr("target","_parent");else{n[0].hash||n.attr("href",e.param.fragment(i,{"overlay-context":this.getPath(window.location)+window.location.search}));var u=e.deparam.querystring(i);if(u.destination&&this.isAdminLink(u.destination)){var a=e.param.fragment(this.getPath(window.location),{overlay:u.destination});n.attr("href",e.param.querystring(i,{destination:a}))}n.attr("target")||n.attr("target","_parent")}}},Drupal.overlay.eventhandlerOperateByURLFragment=function(t){if(e.data(window.location,window.location.href)==="redirect"){e.data(window.location,window.location.href,null);return}var n=e.bbq.getState("overlay");if(n){var r=e.param.querystring(Drupal.settings.basePath+n,{render:"overlay"});this.open(r),this.resetActiveClass(this.getPath(Drupal.settings.basePath+n))}else this.isOpen&&!this.isClosing&&(this.close(),this.resetActiveClass(this.getPath(window.location)))},Drupal.overlay.eventhandlerSyncURLFragment=function(t){if(this.isOpen){var n=e.bbq.getState("overlay");if(this.getPath(Drupal.settings.basePath+n)!=this.getPath(this.iframeWindow.document.location)){var r=Drupal.overlay.fragmentizeLink(this.iframeWindow.document.location);e.data(window.location,r,"redirect"),window.location.replace(r)}}else e.bbq.removeState("overlay")},Drupal.overlay.eventhandlerRefreshPage=function(e){Drupal.overlay.refreshPage&&window.location.reload(!0)},Drupal.overlay.eventhandlerDispatchEvent=function(e){this.iframeWindow&&this.iframeWindow.document&&this.iframeWindow.jQuery(this.iframeWindow.document).trigger(e)},Drupal.overlay.fragmentizeLink=function(t,n){var r=e.deparam.fragment(t.href);if(r.overlay)return t.href;var i=this.getPath(t,!0),s=i+t.search.replace(/&?render=overlay/,"").replace(/\?$/,"")+t.hash;return e.param.fragment(n||window.location.href,{overlay:s})},Drupal.overlay.refreshRegions=function(t){e.each(t,function(){var t=this;e.each(t,function(n){var r=t[n],i="."+n;Drupal.detachBehaviors(e(i)),e.get(Drupal.settings.basePath+Drupal.settings.overlay.ajaxCallback+"/"+r,function(t){e(i).replaceWith(e(t)),Drupal.attachBehaviors(e(i),Drupal.settings)})})})},Drupal.overlay.resetActiveClass=function(t){var n=this,r=window.location.protocol+window.location.hostname;e(".overlay-displace-top, .overlay-displace-bottom").find("a[href]").removeClass("active").each(function(){var i=this.protocol+this.hostname,s=n.getPath(this);i==r&&(t+"/").indexOf(s+"/")===0&&(s!==""||t==="")&&e(this).addClass("active")})},Drupal.overlay.getPath=function(t,n){typeof t=="string"&&(t=e(t.link(t)).get(0));var r=t.pathname;r.charAt(0)!="/"&&(r="/"+r),r=r.replace(new RegExp(Drupal.settings.basePath+"(?:index.php)?"),"");if(r==""&&!n){var i=(new RegExp("([?&])q=(.+)([&#]|$)")).exec(t.search);i&&i.length==4&&(r=i[2])}return r},Drupal.overlay.getDisplacement=function(t){var n=0,r=e(".overlay-displace-"+t+":last");if(r.length){n=r.offset().top+r.outerHeight();var i=r.css("box-shadow"),s=typeof i!="undefined"&&i!=="none";!s&&/DXImageTransform\.Microsoft\.Shadow/.test(r.css("filter"))&&(n-=r[0].filters.item("DXImageTransform.Microsoft.Shadow").strength,n=Math.max(0,n))}return n},Drupal.overlay.makeDocumentUntabbable=function(t){if(jQuery.browser.msie&&parseInt(jQuery.browser.version,10)<8){e("#overlay-disable-message a",t).attr("tabindex",-1);return}t=t||document.body;var n,r,i;i=e("[tabindex] :not(.overlay-element)",t),i.each(Drupal.overlay._recordTabindex),Drupal.overlay._hasTabindex=i.add(Drupal.overlay._hasTabindex),r=e("a, area, button, input, object, select, textarea, iframe"),r=r.add(i),n=e(".overlay-element, #overlay-container, .overlay-displace-top, .overlay-displace-bottom").find("*"),r=r.not(n),r.attr("tabindex",-1)},Drupal.overlay.makeDocumentTabbable=function(t){if(jQuery.browser.msie&&parseInt(jQuery.browser.version,10)<8)return;var n;t=t||document.body;var r=e("[tabindex]",t);if(jQuery.browser.msie&&parseInt(jQuery.browser.version,10)<8){var i,s=r.length;for(i=0;i<s;i++)r[i].removeAttribute("tabIndex")}else r.removeAttr("tabindex");n=e(Drupal.overlay._hasTabindex,t),n.each(Drupal.overlay._restoreTabindex),Drupal.overlay._hasTabindex=Drupal.overlay._hasTabindex.not(n)},Drupal.overlay._recordTabindex=function(){var t=e(this),n=e(this).attr("tabindex");t.data("drupalOverlayOriginalTabIndex",n)},Drupal.overlay._restoreTabindex=function(){var t=e(this),n=t.data("drupalOverlayOriginalTabIndex");t.attr("tabindex",n)},Drupal.theme.prototype.overlayContainer=function(){return'<div id="overlay-container"><div class="overlay-modal-background"></div></div>'},Drupal.theme.prototype.overlayElement=function(e){return'<iframe class="overlay-element" frameborder="0" scrolling="auto" allowtransparency="true"></iframe>'}})(jQuery);
