(function(e){Drupal.behaviors.tableDrag={attach:function(t,n){for(var r in n.tableDrag)e("#"+r,t).once("tabledrag",function(){Drupal.tableDrag[r]=new Drupal.tableDrag(this,n.tableDrag[r])})}},Drupal.tableDrag=function(t,n){var r=this;this.table=t,this.tableSettings=n,this.dragObject=null,this.rowObject=null,this.oldRowElement=null,this.oldY=0,this.changed=!1,this.maxDepth=0,this.rtl=e(this.table).css("direction")=="rtl"?-1:1,this.scrollSettings={amount:4,interval:50,trigger:70},this.scrollInterval=null,this.scrollY=0,this.windowHeight=0,this.indentEnabled=!1;for(var i in n)for(var s in n[i])n[i][s].relationship=="parent"&&(this.indentEnabled=!0),n[i][s].limit>0&&(this.maxDepth=n[i][s].limit);if(this.indentEnabled){this.indentCount=1;var o=Drupal.theme("tableDragIndentation"),u=e("<tr/>").addClass("draggable").appendTo(t),a=e("<td/>").appendTo(u).prepend(o).prepend(o);this.indentAmount=e(".indentation",a).get(1).offsetLeft-e(".indentation",a).get(0).offsetLeft,u.remove()}e("> tr.draggable, > tbody > tr.draggable",t).each(function(){r.makeDraggable(this)}),e(t).before(e('<a href="#" class="tabledrag-toggle-weight"></a>').attr("title",Drupal.t("Re-order rows by numerical weight instead of dragging.")).click(function(){return e.cookie("Drupal.tableDrag.showWeight")==1?r.hideColumns():r.showColumns(),!1}).wrap('<div class="tabledrag-toggle-weight-wrapper"></div>').parent()),r.initColumns(),e(document).bind("mousemove",function(e){return r.dragRow(e,r)}),e(document).bind("mouseup",function(e){return r.dropRow(e,r)})},Drupal.tableDrag.prototype.initColumns=function(){for(var t in this.tableSettings){for(var n in this.tableSettings[t]){var r=e("."+this.tableSettings[t][n].target+":first",this.table);if(r.length&&this.tableSettings[t][n].hidden){var i=this.tableSettings[t][n].hidden,s=r.closest("td");break}}if(i&&s[0]){var o=e("> td",s.parent()).index(s.get(0))+1;e("> thead > tr, > tbody > tr, > tr",this.table).each(function(){var t=o,n=e(this).children();n.each(function(e){e<t&&this.colSpan&&this.colSpan>1&&(t-=this.colSpan-1)}),t>0&&(s=n.filter(":nth-child("+t+")"),s[0].colSpan&&s[0].colSpan>1?s.addClass("tabledrag-has-colspan"):s.addClass("tabledrag-hide"))})}}e.cookie("Drupal.tableDrag.showWeight")===null?(e.cookie("Drupal.tableDrag.showWeight",0,{path:Drupal.settings.basePath,expires:365}),this.hideColumns()):e.cookie("Drupal.tableDrag.showWeight")==1?this.showColumns():this.hideColumns()},Drupal.tableDrag.prototype.hideColumns=function(){e(".tabledrag-hide","table.tabledrag-processed").css("display","none"),e(".tabledrag-handle","table.tabledrag-processed").css("display",""),e(".tabledrag-has-colspan","table.tabledrag-processed").each(function(){this.colSpan=this.colSpan-1}),e(".tabledrag-toggle-weight").text(Drupal.t("Show row weights")),e.cookie("Drupal.tableDrag.showWeight",0,{path:Drupal.settings.basePath,expires:365}),e("table.tabledrag-processed").trigger("columnschange","hide")},Drupal.tableDrag.prototype.showColumns=function(){e(".tabledrag-hide","table.tabledrag-processed").css("display",""),e(".tabledrag-handle","table.tabledrag-processed").css("display","none"),e(".tabledrag-has-colspan","table.tabledrag-processed").each(function(){this.colSpan=this.colSpan+1}),e(".tabledrag-toggle-weight").text(Drupal.t("Hide row weights")),e.cookie("Drupal.tableDrag.showWeight",1,{path:Drupal.settings.basePath,expires:365}),e("table.tabledrag-processed").trigger("columnschange","show")},Drupal.tableDrag.prototype.rowSettings=function(t,n){var r=e("."+t,n);for(var i in this.tableSettings[t]){var s=this.tableSettings[t][i].target;if(r.is("."+s)){var o={};for(var u in this.tableSettings[t][i])o[u]=this.tableSettings[t][i][u];return o}}},Drupal.tableDrag.prototype.makeDraggable=function(t){var n=this,r=e('<a href="#" class="tabledrag-handle"><div class="handle">&nbsp;</div></a>').attr("title",Drupal.t("Drag to re-order"));e("td:first .indentation:last",t).length?(e("td:first .indentation:last",t).after(r),n.indentCount=Math.max(e(".indentation",t).length,n.indentCount)):e("td:first",t).prepend(r),r.hover(function(){n.dragObject==null?e(this).addClass("tabledrag-handle-hover"):null},function(){n.dragObject==null?e(this).removeClass("tabledrag-handle-hover"):null}),r.mousedown(function(r){return n.dragObject={},n.dragObject.initMouseOffset=n.getMouseOffset(t,r),n.dragObject.initMouseCoords=n.mouseCoords(r),n.indentEnabled&&(n.dragObject.indentMousePos=n.dragObject.initMouseCoords),n.rowObject&&e("a.tabledrag-handle",n.rowObject.element).blur(),n.rowObject=new n.row(t,"mouse",n.indentEnabled,n.maxDepth,!0),n.table.topY=e(n.table).offset().top,n.table.bottomY=n.table.topY+n.table.offsetHeight,e(this).addClass("tabledrag-handle-hover"),e(t).addClass("drag"),e("body").addClass("drag"),n.oldRowElement&&e(n.oldRowElement).removeClass("drag-previous"),navigator.userAgent.indexOf("MSIE 6.")!=-1&&e("select",this.table).css("display","none"),n.safeBlur=!1,n.onDrag(),!1}),r.click(function(){return!1}),r.focus(function(){e(this).addClass("tabledrag-handle-hover"),n.safeBlur=!0}),r.blur(function(t){e(this).removeClass("tabledrag-handle-hover"),n.rowObject&&n.safeBlur&&n.dropRow(t,n)}),r.keydown(function(i){i.keyCode!=9&&!n.rowObject&&(n.rowObject=new n.row(t,"keyboard",n.indentEnabled,n.maxDepth,!0));var s=!1;switch(i.keyCode){case 37:case 63234:s=!0,n.rowObject.indent(-1*n.rtl);break;case 38:case 63232:var o=e(n.rowObject.element).prev("tr").get(0);while(o&&e(o).is(":hidden"))o=e(o).prev("tr").get(0);if(o){n.safeBlur=!1,n.rowObject.direction="up",s=!0;if(e(t).is(".tabledrag-root")){var u=0;while(o&&e(".indentation",o).length)o=e(o).prev("tr").get(0),u+=e(o).is(":hidden")?0:o.offsetHeight;o&&(n.rowObject.swap("before",o),window.scrollBy(0,-u))}else if(n.table.tBodies[0].rows[0]!=o||e(o).is(".draggable"))n.rowObject.swap("before",o),n.rowObject.interval=null,n.rowObject.indent(0),window.scrollBy(0,-parseInt(t.offsetHeight,10));r.get(0).focus()}break;case 39:case 63235:s=!0,n.rowObject.indent(1*n.rtl);break;case 40:case 63233:var a=e(n.rowObject.group).filter(":last").next("tr").get(0);while(a&&e(a).is(":hidden"))a=e(a).next("tr").get(0);if(a){n.safeBlur=!1,n.rowObject.direction="down",s=!0;if(e(t).is(".tabledrag-root")){var u=0,f=new n.row(a,"keyboard",n.indentEnabled,n.maxDepth,!1);if(f){e(f.group).each(function(){u+=e(this).is(":hidden")?0:this.offsetHeight});var l=e(f.group).filter(":last").get(0);n.rowObject.swap("after",l),window.scrollBy(0,parseInt(u,10))}}else n.rowObject.swap("after",a),n.rowObject.interval=null,n.rowObject.indent(0),window.scrollBy(0,parseInt(t.offsetHeight,10));r.get(0).focus()}}n.rowObject&&n.rowObject.changed==1&&(e(t).addClass("drag"),n.oldRowElement&&e(n.oldRowElement).removeClass("drag-previous"),n.oldRowElement=t,n.restripeTable(),n.onDrag());if(s)return!1}),r.keypress(function(e){switch(e.keyCode){case 37:case 38:case 39:case 40:return!1}})},Drupal.tableDrag.prototype.dragRow=function(e,t){if(t.dragObject){t.currentMouseCoords=t.mouseCoords(e);var n=t.currentMouseCoords.y-t.dragObject.initMouseOffset.y,r=t.currentMouseCoords.x-t.dragObject.initMouseOffset.x;if(n!=t.oldY){t.rowObject.direction=n>t.oldY?"down":"up",t.oldY=n;var i=t.checkScroll(t.currentMouseCoords.y);clearInterval(t.scrollInterval),(i>0&&t.rowObject.direction=="down"||i<0&&t.rowObject.direction=="up")&&t.setScroll(i);var s=t.findDropTargetRow(r,n);s&&(t.rowObject.direction=="down"?t.rowObject.swap("after",s,t):t.rowObject.swap("before",s,t),t.restripeTable())}if(t.indentEnabled){var o=t.currentMouseCoords.x-t.dragObject.indentMousePos.x,u=Math.round(o/t.indentAmount*t.rtl),a=t.rowObject.indent(u);t.dragObject.indentMousePos.x+=t.indentAmount*a*t.rtl,t.indentCount=Math.max(t.indentCount,t.rowObject.indents)}return!1}},Drupal.tableDrag.prototype.dropRow=function(t,n){if(n.rowObject!=null){var r=n.rowObject.element;if(n.rowObject.changed==1){n.updateFields(r);for(var i in n.tableSettings){var s=n.rowSettings(i,r);if(s.relationship=="group")for(var o in n.rowObject.children)n.updateField(n.rowObject.children[o],i)}n.rowObject.markChanged(),n.changed==0&&(e(Drupal.theme("tableDragChangedWarning")).insertBefore(n.table).hide().fadeIn("slow"),n.changed=!0)}n.indentEnabled&&n.rowObject.removeIndentClasses(),n.oldRowElement&&e(n.oldRowElement).removeClass("drag-previous"),e(r).removeClass("drag").addClass("drag-previous"),n.oldRowElement=r,n.onDrop(),n.rowObject=null}n.dragObject!=null&&(e(".tabledrag-handle",r).removeClass("tabledrag-handle-hover"),n.dragObject=null,e("body").removeClass("drag"),clearInterval(n.scrollInterval),navigator.userAgent.indexOf("MSIE 6.")!=-1&&e("select",this.table).css("display","block"))},Drupal.tableDrag.prototype.mouseCoords=function(e){return e.pageX||e.pageY?{x:e.pageX,y:e.pageY}:{x:e.clientX+document.body.scrollLeft-document.body.clientLeft,y:e.clientY+document.body.scrollTop-document.body.clientTop}},Drupal.tableDrag.prototype.getMouseOffset=function(t,n){var r=e(t).offset(),i=this.mouseCoords(n);return{x:i.x-r.left,y:i.y-r.top}},Drupal.tableDrag.prototype.findDropTargetRow=function(t,n){var r=e(this.table.tBodies[0].rows).not(":hidden");for(var i=0;i<r.length;i++){var s=r[i],o=0,u=e(s).offset().top;if(s.offsetHeight==0)var a=parseInt(s.firstChild.offsetHeight,10)/2;else var a=parseInt(s.offsetHeight,10)/2;if(n>u-a&&n<u+a){if(this.indentEnabled){for(var i in this.rowObject.group)if(this.rowObject.group[i]==s)return null}else if(s==this.rowObject.element)return null;if(!this.rowObject.isValidSwap(s))return null;while(e(s).is(":hidden")&&e(s).prev("tr").is(":hidden"))s=e(s).prev("tr").get(0);return s}}return null},Drupal.tableDrag.prototype.updateFields=function(e){for(var t in this.tableSettings)this.updateField(e,t)},Drupal.tableDrag.prototype.updateField=function(t,n){var r=this.rowSettings(n,t);if(r.relationship=="self"||r.relationship=="group")var i=t;else if(r.relationship=="sibling"){var s=e(t).prev("tr").get(0),o=e(t).next("tr").get(0),i=t;e(s).is(".draggable")&&e("."+n,s).length?this.indentEnabled?e(".indentations",s).length==e(".indentations",t)&&(i=s):i=s:e(o).is(".draggable")&&e("."+n,o).length&&(this.indentEnabled?e(".indentations",o).length==e(".indentations",t)&&(i=o):i=o)}else if(r.relationship=="parent"){var s=e(t).prev("tr");while(s.length&&e(".indentation",s).length>=this.rowObject.indents)s=s.prev("tr");if(s.length)i=s[0];else{i=e(this.table).find("tr.draggable:first").get(0),i==this.rowObject.element&&(i=e(this.rowObject.group[this.rowObject.group.length-1]).next("tr.draggable").get(0));var u=!0}}this.copyDragClasses(i,t,n),r=this.rowSettings(n,t),u&&(r.relationship="sibling",r.source=r.target);var a="."+r.target,f=e(a,t).get(0);if(f){var l="."+r.source,c=e(l,i).get(0);switch(r.action){case"depth":f.value=e(".indentation",e(c).closest("tr")).length;break;case"match":f.value=c.value;break;case"order":var h=this.rowObject.findSiblings(r);if(e(f).is("select")){var p=[];e("option",f).each(function(){p.push(this.value)});var d=p[p.length-1];e(a,h).each(function(){p.length>0?this.value=p.shift():this.value=d})}else{var v=parseInt(e(a,h[0]).val(),10)||0;e(a,h).each(function(){this.value=v,v++})}}}},Drupal.tableDrag.prototype.copyDragClasses=function(t,n,r){var i=e("."+r,t),s=e("."+r,n);i.length&&s.length&&(s[0].className=i[0].className)},Drupal.tableDrag.prototype.checkScroll=function(e){var t=document.documentElement,n=document.body,r=this.windowHeight=window.innerHeight||(t.clientHeight&&t.clientWidth!=0?t.clientHeight:n.offsetHeight),i=this.scrollY=document.all?t.scrollTop?t.scrollTop:n.scrollTop:window.pageYOffset?window.pageYOffset:window.scrollY,s=this.scrollSettings.trigger,o=0;if(e-i>r-s)return o=s/(r+i-e),o=o>0&&o<s?o:s,o*this.scrollSettings.amount;if(e-i<s)return o=s/(e-i),o=o>0&&o<s?o:s,-o*this.scrollSettings.amount},Drupal.tableDrag.prototype.setScroll=function(e){var t=this;this.scrollInterval=setInterval(function(){t.checkScroll(t.currentMouseCoords.y);var n=t.scrollY>t.table.topY,r=t.scrollY+t.windowHeight<t.table.bottomY;(e>0&&r||e<0&&n)&&window.scrollBy(0,e)},this.scrollSettings.interval)},Drupal.tableDrag.prototype.restripeTable=function(){e("> tbody > tr.draggable:visible, > tr.draggable:visible",this.table).removeClass("odd even").filter(":odd").addClass("even").end().filter(":even").addClass("odd")},Drupal.tableDrag.prototype.onDrag=function(){return null},Drupal.tableDrag.prototype.onDrop=function(){return null},Drupal.tableDrag.prototype.row=function(t,n,r,i,s){this.element=t,this.method=n,this.group=[t],this.groupDepth=e(".indentation",t).length,this.changed=!1,this.table=e(t).closest("table").get(0),this.indentEnabled=r,this.maxDepth=i,this.direction="";if(this.indentEnabled){this.indents=e(".indentation",t).length,this.children=this.findChildren(s),this.group=e.merge(this.group,this.children);for(var o=0;o<this.group.length;o++)this.groupDepth=Math.max(e(".indentation",this.group[o]).length,this.groupDepth)}},Drupal.tableDrag.prototype.row.prototype.findChildren=function(t){var n=this.indents,r=e(this.element,this.table).next("tr.draggable"),i=[],s=0;while(r.length){var o=e(".indentation",r).length;if(!(o>n))break;s++,i.push(r[0]),t&&e(".indentation",r).each(function(t){s==1&&t==n&&e(this).addClass("tree-child-first"),t==n?e(this).addClass("tree-child"):t>n&&e(this).addClass("tree-child-horizontal")}),r=r.next("tr.draggable")}return t&&i.length&&e(".indentation:nth-child("+(n+1)+")",i[i.length-1]).addClass("tree-child-last"),i},Drupal.tableDrag.prototype.row.prototype.isValidSwap=function(t){if(this.indentEnabled){var n,r;this.direction=="down"?(n=t,r=e(t).next("tr").get(0)):(n=e(t).prev("tr").get(0),r=t),this.interval=this.validIndentInterval(n,r);if(this.interval.min>this.interval.max)return!1}return this.table.tBodies[0].rows[0]==t&&e(t).is(":not(.draggable)")?!1:!0},Drupal.tableDrag.prototype.row.prototype.swap=function(t,n){Drupal.detachBehaviors(this.group,Drupal.settings,"move"),e(n)[t](this.group),Drupal.attachBehaviors(this.group,Drupal.settings),this.changed=!0,this.onSwap(n)},Drupal.tableDrag.prototype.row.prototype.validIndentInterval=function(t,n){var r,i;return r=n?e(".indentation",n).length:0,!t||e(t).is(":not(.draggable)")||e(this.element).is(".tabledrag-root")?i=0:(i=e(".indentation",t).length+(e(t).is(".tabledrag-leaf")?0:1),this.maxDepth&&(i=Math.min(i,this.maxDepth-(this.groupDepth-this.indents)))),{min:r,max:i}},Drupal.tableDrag.prototype.row.prototype.indent=function(t){if(!this.interval){var n=e(this.element).prev("tr").get(0),r=e(this.group).filter(":last").next("tr").get(0);this.interval=this.validIndentInterval(n,r)}var i=this.indents+t;i=Math.max(i,this.interval.min),i=Math.min(i,this.interval.max),t=i-this.indents;for(var s=1;s<=Math.abs(t);s++)t<0?(e(".indentation:first",this.group).remove(),this.indents--):(e("td:first",this.group).prepend(Drupal.theme("tableDragIndentation")),this.indents++);return t&&(this.changed=!0,this.groupDepth+=t,this.onIndent()),t},Drupal.tableDrag.prototype.row.prototype.findSiblings=function(t){var n=[],r=["prev","next"],i=this.indents;for(var s=0;s<r.length;s++){var o=e(this.element)[r[s]]();while(o.length){if(!e("."+t.target,o))break;if(this.indentEnabled)var u=e(".indentation",o).length;if(!this.indentEnabled||u==i)n.push(o[0]);else if(u<i)break;o=e(o)[r[s]]()}r[s]=="prev"&&(n.reverse(),n.push(this.element))}return n},Drupal.tableDrag.prototype.row.prototype.removeIndentClasses=function(){for(var t in this.children)e(".indentation",this.children[t]).removeClass("tree-child").removeClass("tree-child-first").removeClass("tree-child-last").removeClass("tree-child-horizontal")},Drupal.tableDrag.prototype.row.prototype.markChanged=function(){var t=Drupal.theme("tableDragChangedMarker"),n=e("td:first",this.element);e("span.tabledrag-changed",n).length==0&&n.append(t)},Drupal.tableDrag.prototype.row.prototype.onIndent=function(){return null},Drupal.tableDrag.prototype.row.prototype.onSwap=function(e){return null},Drupal.theme.prototype.tableDragChangedMarker=function(){return'<span class="warning tabledrag-changed">*</span>'},Drupal.theme.prototype.tableDragIndentation=function(){return'<div class="indentation">&nbsp;</div>'},Drupal.theme.prototype.tableDragChangedWarning=function(){return'<div class="tabledrag-changed-warning messages warning">'+Drupal.theme("tableDragChangedMarker")+" "+Drupal.t("Changes made in this table will not be saved until the form is submitted.")+"</div>"}})(jQuery);