<?php
/**
 * Implements hook_form_alter().
 */
function image_field_url_replacer_form_alter(&$form, &$form_state, $form_id){
  if (isset($form_state['node']->type) && variable_get('image_field_url_replacer_' . $form_state['node']->type, 0) == 1 && $form_id == $form_state['node']->type . '_node_form') {
    static $counter = 0;
    $counter++;
    drupal_add_js(drupal_get_path('module','image_field_url_replacer') . '/image_field_url_replacer_change_image_links.js', 'file');
    if(array_key_exists('body', $form)){
      $link_button['image_field_url_replacer_fieldset'] = array(
          '#type' => 'fieldset',
          '#collapsible' => TRUE,
          '#collapsed' => FALSE,
          '#title' => t('Replace image links'),
          '#weight' => $form['body']['#weight'],
      );
      $link_button['image_field_url_replacer_fieldset']['image_field_url_replacer_button'] = array(
      '#type' => 'button',
      '#value' => t('Replace links'),
      '#executes_submit_callback' => FALSE,
      '#attributes' => array(
        'class' => array('image-field-url-replace-button'),
        'rel' => 'body',
        'id' => array("image-field-url-replace-button"),
        ),
      );
      $link_button['image_field_url_replacer_fieldset']['image_field_url_replacer_description'] = array(
          '#type' => 'markup',
          '#markup' => '<div class="description">' . t('Upload all images included in the html of your newsletter and press
                        "Replace links" to replace the links in the HTML to the links to the files you just uploaded.') . '</div>',
      );
      $index = array_search('body', array_keys($form));
      $end = array_splice($form, $index+1);
      $form = array_merge($form, $link_button, $end);
      if(array_key_exists('class', $form['body']['#attributes'])){
        $form['body']['#attributes']['class'][] = "image-field-url-replace-body-$counter";
      }
      else{
        $form['body']['#attributes']['class'] = array("image-field-url-replace-body-$counter");
      }
    }
  }
}

/**
 * Implements hook_form_node_type_form_alter().
 */
function image_field_url_replacer_form_node_type_form_alter(&$form, $form_state) {
  $form['image_field_url_replacer'] = array(
    '#type' => 'fieldset',
    '#title' => t("Image Field URL Replace settings"),
    '#group' => 'additional_settings',
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
  );
  $form['image_field_url_replacer']['image_field_url_replacer_' . $form['#node_type']->type] = array(
    '#type' => 'checkbox',
    '#title' => t('Enable Image Field URL Replace on this content type'),
    '#default_value' => variable_get('image_field_url_replacer_' . $form['#node_type']->type, 0),
  );
  $form['#submit'][] = "image_field_url_replacer_node_type_form_submit";
}

function image_field_url_replacer_node_type_form_submit(&$form, $form_state){
  variable_set('image_field_url_replacer_' . $form['#node_type']->type, $form_state['values']['image_field_url_replacer_' . $form['#node_type']->type]);
}



?>
