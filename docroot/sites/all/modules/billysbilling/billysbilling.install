<?php

/**
 * @file
 */

/**
 * Implements hook_requirements().
 */
function billysbilling_requirements($phase) {
  if ($phase == 'runtime') {

    $library = libraries_detect('billysbilling-php');

    // Prepare the download instructions.
    $description = t('The php-sdk for BillysBilling is required for the BillysBilling module to function.
      Download the library from !url and place it in <em>!path</em>.', array('!path' => libraries_get_path('billysbilling-php'), '!url' => l('Github', 'https://github.com/billysbilling/billysbilling-php')));

    return array(
      'billysbilling-php' => array(
        'title' => t('BillysBilling PHP-SDK library'),
        'value' =>  $library['installed'] ? t('Available') : t('Unavailable'),
        'description' => !$library['installed'] ? $description : NULL,
        'severity' => $library['installed'] ? REQUIREMENT_OK : REQUIREMENT_ERROR,
      ),
    );
  }
}

/**
 * Implements hook_uninstall().
 */
function billysbilling_uninstall() {
  variable_del('billysbilling_api_key');
  variable_del('billysbilling_vat_model_id');
  variable_del('billysbilling_state_account_id');
  variable_del('billysbilling_shipping_product_id');
  variable_del('billysbilling_discount_product_id');
  variable_del('billysbilling_invoice_message');
  // TODO What to do about the created fields?
}

/**
 * Implements hook_enable().
 */
function billysbilling_enable() {
  // Adds invoice reference field on order entity.
  _billysbilling_create_field('billysbilling_invoice_id', 'commerce_order', 'commerce_order', 'BillysBilling Invoice ID');
  // Adds product reference field on product entity.
  foreach (commerce_product_types() as $product_type => $type_array) {
    _billysbilling_create_field('billysbilling_product_id', 'commerce_product', $product_type, 'BillysBilling Product ID');
  }
  // Adds customer reference field on customer entity.
  _billysbilling_create_field('billysbilling_contact_id', 'commerce_customer_profile', 'billing', 'BillysBilling Contact ID');
}

/**
 * Utility function to create fields
 */
function _billysbilling_create_field($field_name, $entity_type, $bundle_name, $label) {
  $field = field_read_field($field_name);
  if (empty($field)) {
    $field = array(
      'field_name' => $field_name,
      'type' => 'text', 
      'cardinality' => 1,
      'locked' => TRUE,
    );
    field_create_field($field);
  }

  $instance = field_info_instance($entity_type, $field_name, $bundle_name);
  if (empty($instance)) {
    // Create the instance on the bundle.
    $instance = array(
      'field_name' => $field_name, 
      'entity_type' => $entity_type, 
      'label' => $label,
      'bundle' => $bundle_name,
      'required' => FALSE,
      'settings' => array(),
      'widget' => array(
        'type' => 'text_textfield',
      ),
      'display' => array(
        'default' => array(
          'label' => 'hidden',
          'type' => 'hidden',
        ),
      ),
    );
    field_create_instance($instance);
  }
}
