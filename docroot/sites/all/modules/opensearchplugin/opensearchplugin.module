<?php

/**
 * @file
 * Module file for the opensearchplugin module.
 */

/**
 * Implements hook_init().
 */
function opensearchplugin_init() {
  drupal_add_html_head_link(array(
    'rel' => 'search',
    'type' => 'application/opensearchdescription+xml',
    'href' => url('opensearch.xml', array('absolute' => TRUE)),
    'title' => variable_get('site_name', 'Drupal'),
  ));
}

/**
 * Implements hook_menu().
 */
function opensearchplugin_menu() {
  $items = array();
  $items['opensearch.xml'] = array(
    'title' => 'OpenSearch Plugin',
    'page callback' => 'opensearchplugin_output',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK
  );
  $items['admin/config/search/opensearchplugin'] = array(
    'title' => 'OpenSearch Plugin',
    'description' => 'Allows cusomization of the OpenSearch Plugin.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('opensearchplugin_admin'),
    'access arguments' => array('administer site configuration'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'opensearchplugin.admin.inc',
  );
  return $items;
}

/**
 * Implements hook_theme().
 */
function opensearchplugin_theme() {
  // Farm the variables
  $variables = array();
  if (variable_get('opensearchplugin_custom_path', FALSE)) {
    global $base_url;
    $variables['htmlsearch'] = $base_url . '/' . variable_get('opensearchplugin_search_path', '');
    $variables['searchform'] = $base_url . '/' . variable_get('opensearchplugin_search_form', '');
  }
  else {
    $variables['htmlsearch'] = url('search/node/', array('absolute' => TRUE)); // search query
    $variables['searchform'] = url('search', array('absolute' => TRUE)); // search page url
  }
  $variables['shortname'] = variable_get('opensearchplugin_short_name', variable_get('site_name', 'Drupal'));
  $variables['longname'] = variable_get('opensearchplugin_long_name', variable_get('site_name', 'Drupal'));
  $variables['description'] = variable_get('site_slogan', '');
  $variables['tags'] = ''; // associated meta tags
  $variables['contact'] = ''; // contact email address
  $variables['language'] = '*'; // website language
  $variables['adultcontent'] = 'false'; // if website contains adult material
  $variables['syndicationright'] = 'open';  // open, limited, private or closed
  $variables['attribution'] = ''; // copyright information
  $variables['developer'] = ''; // who developed the website
  $variables['icon'] = variable_get('opensearchplugin_image', '');
  if (empty($variables['icon'] )) {
    $variables['icon']  = theme_get_setting('favicon'); // the icon to use
  }
  $variables['iconwidth'] = variable_get('opensearchplugin_image_width', 16);
  $variables['iconheight'] = variable_get('opensearchplugin_image_height', 16);

  return array(
    'opensearchplugin' => array(
      'variables' => $variables,
      'template' => 'opensearchplugin',
    ),
  );
}

/**
 * Outputs the definition of the OpenSearch plugin
 */
function opensearchplugin_output() {
  drupal_add_http_header('Content-Type', 'text/xml;charset=UTF-8', $append = FALSE);
  echo theme('opensearchplugin', array());
  module_invoke_all('exit');
  exit;
}
