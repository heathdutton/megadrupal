<?php

/* 
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
function simplyhired_listing_install() {
	// Add a body field.
	node_types_rebuild();
	$types = node_type_get_types();
	node_add_body_field($types['job_listing']);
}

function simplyhired_listing_uninstall() {
	$ournewtype = 'job_listing';
  $sql = 'SELECT nid FROM {node} n WHERE n.type = :type';
  $result = db_query($sql, array(':type' => $ournewtype));
  $nodeids = array();
  foreach ($result as $row) {
    $nodeids[] = $row->nid;
  }
  node_delete_multiple($nodeids);
  node_type_delete($ournewtype);
}

function simplyhired_listing_schema() {
	$schema = array();
	
	$schema['simplyhired_listing'] = array(
		'description' => 'Stores search settings for job_listing nodes',
		'fields' => array(
			'cid' => array(
				'type' => 'serial',
				'unsigned' => TRUE,
				'not null' => TRUE,
				'description' => 'The primary configuration identifier.'
			),
			'nid' => array(
				'type' => 'int',
				'unsigned' => TRUE,
				'not null' => TRUE,
				'default' => 0,
				'description' => 'The node ID for which this configuration belongs.'
			),
			'source' => array(
				'type' => 'varchar',
				'length' => 2,
				'not null' => TRUE,
				'default' => 'us',
				'description' => 'The SimplyHired XML API country for which the API calls will be made against.'
			),
			'search_text' => array(
				'type' => 'text',
				'size' => 'medium',
				'not null' => TRUE,
				'description' => 'The default search criteria submitted to SimplyHired for this node.'
			),
			'location' => array(
				'type' => 'text',
				'size' => 'small',
				'not null' => TRUE,
				'description' => 'The default location to restrict the job search to.'
			),
			'distance' => array(
				'type' => 'int',
				'unsigned' => TRUE,
				'not null' => TRUE,
				'default' => 0,
				'description' => 'The radius to restrict the job search to.'
			),
			'sort_by' => array(
				'type' => 'varchar',
				'length' => 2,
				'not null' => TRUE,
				'default' => 'rd',
				'description' => 'How the default search results will be sorted.'
			),
			'results_per_page' => array(
				'type' => 'int',
				'unsigned' => TRUE,
				'not null' => TRUE,
				'default' => 10,
				'description' => 'How many search results per page will be displayed.'
			),
			'exerpt_only' => array(
				'type' => 'int',
				'size' => 'tiny',
				'unsigned' => TRUE,
				'default' => 0,
				'description' => 'Retrieve only an experpt of the job description.'
			),
			'fsr' => array(
				'type' => 'varchar',
				'length' => 10,
				'not null' => TRUE,
				'default' => 'all',
				'description' => 'A parameter indicating the job source type.'
			),
			'fbd' => array(
				'type' => 'varchar',
				'length' => 5,
				'not null' => TRUE,
				'default' => '',
				'description' => 'A parameter indicating the date posted filter to use on the result set.'
			),
			'fjt' => array(
				'type' => 'varchar',
				'length' => 50,
				'not null' => TRUE,
				'default' => '',
				'description' => 'A parameter indicating the job type filter to use on the result set.'
			),
			'fem' => array(
				'type' => 'varchar',
				'length' => 15,
				'not null' => TRUE,
				'default' => '',
				'description' => 'A parameter indicating the employer type.'
			),
			'frl' => array(
				'type' => 'varchar',
				'length' => 50,
				'not null' => TRUE,
				'default' => '',
				'description' => 'A parameter indicating the special filter to use on the result set.'
			),
			'fed' => array(
				'type' => 'int',
				'unsigned' => TRUE,
				'not null' => TRUE,
				'default' => 0,
				'description' => 'A parameter indicating the education filter to use on the result set. Valid values are 0, 1-2, 5-10.'
			),
			'date_format' => array(
				'type' => 'varchar',
				'length' => 20,
				'not null' => TRUE,
				'default' => 'short',
				'description' => 'The date format that will be used when displaying jobs.'
			),
		),
		'unique keys' => array('cid_nid' => array('cid', 'nid')),
		'primary key' => array('cid'),
	);
	
	return $schema;
}

/**
 * Add the new job search options provided by the API.
 */
function simplyhired_listing_update_7100(&$sandbox) {
	$table = 'simplyhired_listing';
	$schema = drupal_get_schema($table);
	$fields = $schema['fields'];
  $new_columns = array('fbd', 'fjt', 'fem', 'frl', 'fed');
	foreach ( $fields as $key => $value ) {
    if ( in_array( $key, $new_columns ) ) {
			db_add_field( $table, $key, $fields[$key]);
		}
	}
  // Set the default values in our new columns for every record.
  db_update($table)
    ->fields(array(
      'fbd' => '',
      'fjt' => '',
      'fem' => '',
      'frl' => '',
      'fed' => 0,
    ))->execute();
}
