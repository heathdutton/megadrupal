<?php
/**
 * @file
 * Provides the functionality to use and export json script files.
 */

/**
 * Implements hook_restore_scripts_alter().
 */
function restore_file_restore_scripts_alter(&$scripts) {
  foreach (module_list() as $module) {
    $files = glob(drupal_get_path('module', $module) . '/scripts/*.script.json');
    foreach ($files as $filename) {
      $name = str_replace('.script.json', '', basename($filename));
      $json = json_decode(file_get_contents($filename), TRUE);
      if ($json) {
        $json['module'] = 'restore_file';
        $script = restore_import($json, $name);
        if ($script) {
          $scripts[$script->name()] = $script;
        }
      }
    }
  }
}

/**
 * Implements hook_restore_export_format().
 */
function restore_file_restore_export_format() {
  $items = array();

  $items['restore_file'] = array(
    'title' => t('Export as "script.json" file'),
    'callback' => 'restore_file_export__restore_file',
  );

  return $items;
}

/**
 * Provides the restore script file output.
 */
function restore_file_export__restore_file(RestoreScript $script) {
  $json = restore_export_export__json($script);

  return t('Filename') . ': ' . $script->name() . '.script.json' .
    "\n--------------------------------------------< " . t('file contents') . " >-------\n" . $json;
}
