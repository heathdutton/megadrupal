<?php

/**
 * @file hijri.module
 * This module convert to Hijri date in nodes,comments and a block.
 *  */

/**
 * Implements hook_help().
 */
function hijri_help($path, $arg) {
  switch ($path) {
    case 'admin/config/regional/date-time/hijri':
      return '<p>' . t('Hijri module helps Islamic community to use the Islamic date') . '</p>';
  }
}

/**
 * Implements hook_block_info().
 */
function hijri_block_info() {
  // This example comes from node.module.
  $blocks['hijri'] = array(
    'info' => t('Hijri Date Block'),
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function hijri_block_view($delta = '') {
  // This example is adapted from node.module.
  $block = array();

  switch ($delta) {
    case 'hijri':
      $block['subject'] = t('Hijri Date');
      $block['content'] = _hijri_date_block();
      break;
  }
  return $block;
}

/**
 * The callback of Hijri date block to display the type of date selected.
 */
function _hijri_date_block() {
  $correction = variable_get('hijri_correction_value', 0);
  $hijri_value = variable_get('hijri_display_block');
  $format = hijri_format_date(time(), $hijri_value, NULL, $correction);
  $content = theme('hijri_date', array('data' => $format));
  return $content;
}

/**
 * Implements hook_theme().
 */
function hijri_theme($existing, $type, $theme, $path) {
  $item = array();
  $item = array('hijri_date' => array('variables' => array('data' => Null),
      'template' => 'hijri-date',
      'path' => drupal_get_path('module', 'hijri') . '/theme',
    ),
  );
  return $item;
}

/**
 * Form builder.
 */
function hijri_settings_form($form, &$form_state) {

  $correction = variable_get('hijri_correction_value', 0);
  $hijri_types = array(
    'full' => t('Hijri full format: @date', array('@date' =>  t('@hijri on @gregorian', array('@hijri' => hijri('l j F  Y', time(), $correction), '@gregorian' => format_date(time(), 'custom', 'F j, Y'))))),
    'long' => t('Hijri long format: @date', array('@date' => hijri_format_date(time(), 'long', NULL, $correction))),
    'medium' => t('Hijri medium format: @date', array('@date' => hijri_format_date(time(), 'medium', NULL, $correction))),
    'short' => t('Hijri short format: @date', array('@date' => hijri_format_date(time(), 'short', NULL, $correction))),
  );
  // content types settings.
  $form['hijri_settings'] = array(
    '#type' => 'vertical_tabs',
  );
  $form['hijri_settings']['correction'] = array(
    '#type' => 'fieldset',
    '#title' => t('Hijri Correction'),
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
    '#group' => 'hijri_settings',
    '#weight' => 0,
  );
  $form['hijri_settings']['correction']['hijri_correction_value'] = array(
    '#type' => 'select',
    '#title' => t('Correction days'),
    '#options' => array(-2 => -2, -1 => -1,
      0 => 0, + 1 => + 1, + 2 => + 2,
    ),
    '#default_value' => variable_get('hijri_correction_value', 0),
  );


  // Per-path visibility.
  $form['hijri_settings']['node_type'] = array(
    '#type' => 'fieldset',
    '#title' => t('Content types'),
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
    '#group' => 'hijri_settings',
    '#weight' => 0,
  );
  $form['hijri_settings']['node_type']['hijri_types'] = array(
    '#type' => 'checkboxes',
    '#title' => t('Hijri date Correction field for specific content types'),
    '#default_value' => variable_get('hijri_types',array()),
    '#options' => node_type_get_names(),
    '#description' => t('Add/Remove the Correction field for content type.'),
  );

  $form['hijri_settings']['node_display'] = array(
    '#type' => 'fieldset',
    '#title' => t('Node Display'),
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
    '#group' => 'hijri_settings',
    '#weight' => 0,
  );

  $form['hijri_settings']['node_display']['hijri_display'] = array(
    '#type' => 'radios',
    '#title' => t('Hijri date on the node view'),
    '#default_value' => variable_get('hijri_display', 'full'),
    '#options' => $hijri_types,
    '#description' => t('Select the display type you want to be in the node view page'),
  );


  $form['hijri_settings']['hijri_comment_display'] = array(
    '#type' => 'fieldset',
    '#title' => t('Comment Display'),
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
    '#group' => 'hijri_settings',
    '#weight' => 0,
  );

  $form['hijri_settings']['hijri_comment_display']['hijri_comment_display'] = array(
    '#type' => 'radios',
    '#title' => t('Hijri date on the comment area'),
    '#default_value' => variable_get('hijri_comment_display', 'full'),
    '#options' => $hijri_types,
    '#description' => t('Select the display type you want to be in the comment area'),
  );


  $form['hijri_settings']['block_display'] = array(
    '#type' => 'fieldset',
    '#title' => t('Block Display'),
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
    '#group' => 'hijri_settings',
    '#weight' => 0,
  );

  $form['hijri_settings']['block_display']['hijri_display_block'] = array(
    '#type' => 'radios',
    '#title' => t('Hijri date on Hijri block'),
    '#default_value' => variable_get('hijri_display_block', 'full'),
    '#options' => $hijri_types,
    '#description' => t('Select the display type you want in Hijri block'),
  );


  $form['#submit'][] = 'hijri_settings_form_submit';
  return system_settings_form($form);
}

/**
 * Form submit handler.
 */
function hijri_settings_form_submit($form, &$form_state) {
  // Check if our field is not already created.
  if (!field_info_field('field_hijri_correction')) {
    // Create the field base.
    $field = array(
      'field_name' => 'field_hijri_correction',
      'type' => 'number_integer',
    );
    field_create_field($field);
  }
  foreach ($form_state['values']['hijri_types'] as $key => $type) {
    // Create the instance.
    $instance = array(
      'field_name' => 'field_hijri_correction',
      'entity_type' => 'node',
      'bundle' => $key,
      'label' => t('Hijri Date Correction'),
      'description' => t('This field will save the Correction and different between months'),
      'required' => FALSE,
    );
    if ((string)$type == (string)$key) {
      $prior_instance = field_read_instance($instance['entity_type'], $instance['field_name'], $instance['bundle']);
      if (empty($prior_instance)) {
        field_create_instance($instance);
      }
    }
    else {
      $prior_instance = field_read_instance($instance['entity_type'], $instance['field_name'], $instance['bundle']);
      if (!empty($prior_instance)) {
        field_delete_instance($instance, FALSE);
      }
    }
  }
}

/**
 * Implements hook_node_presave().
 */
function hijri_node_presave($node) {
  $node_types = variable_get('hijri_types', array());
  foreach ($node_types as $type) {
    if ($node->type == $type) {
      $node->field_hijri_correction[$node->language][0]['value'] = variable_get('hijri_correction_value', 0);
    }
  }
}

/**
 * Implements hook_menu().
 */
function hijri_menu() {
  $items = array();

  $items['admin/config/regional/date-time/hijri'] = array(
    'title' => 'Hijri Settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('hijri_settings_form'),
    'access arguments' => array('administer hijri'),
    'type' => MENU_LOCAL_TASK,
  );

  return $items;
}

/**
 * Implements hook_views_api().
 */
function hijri_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'hijri') . '/views',
  );
}

/**
 * Processes variables for node.tpl.php
 *
 * The $variables array contains the following arguments:
 * - $node
 * - $view_mode
 * - $page
 *
 * @see node.tpl.php
 */
function hijri_preprocess_node(&$variables) {
  $node = $variables['node'];
  $node_types = variable_get('hijri_types', array());
  if (isset($node_types[$node->type]) && (string)$node_types[$node->type] == $node->type) {
  $correction = isset($node->field_hijri_correction[$node->language][0]['value']);
  switch (variable_get('hijri_display')) {
    case 'full':
    case 'long':
    case 'medium':
    case 'short':
      $format = hijri_format_date($node->created, variable_get('hijri_display'), NULL, $correction);
      break;
      default:
      $format = $variables['date'];
      break;
  }
    // Display post information only on certain node types.
    if (variable_get('node_submitted_' . $node->type, TRUE)) {
      $variables['display_submitted'] = TRUE;
      $variables['submitted'] = t('Submitted by !username on !datetime', array('!username' => $variables['name'], '!datetime' => $format));
    }
    else {
      $variables['display_submitted'] = FALSE;
      $variables['submitted'] = '';
    }
  }
}

/**
 * Process variables for comment.tpl.php.
 *
 * @see comment.tpl.php
 */
function hijri_preprocess_comment(&$variables) {
  $comment = $variables['elements']['#comment'];
  $node = $variables['elements']['#node'];
  $variables['comment'] = $comment;
  $variables['author'] = theme('username', array('account' => $comment));
  $variables['created'] = format_date($comment->created);
  $correction = $node->field_hijri_correction[$node->language][0]['value'];
  switch (variable_get('hijri_comment_display')) {
    case 'full':
    case 'long':
    case 'medium':
    case 'short':
      $format = hijri_format_date($node->created, variable_get('hijri_comment_display'), NULL, $correction);
       break;
    default:
      $format = $variables['created'];
      break;
  }
  $node_types = variable_get('hijri_types', array());

  if ((string)$node_types[$node->type] == $node->type) {
    $variables['submitted'] = t('Submitted by !username on !datetime', array('!username' => $variables['author'], '!datetime' => $format));
    $variables['created'] = $format;
  }
}

/**
 * Implements hook_permission().
 */
function hijri_permission() {
  return array(
    'administer hijri' => array(
      'title' => t('administer hijri'),
      'description' => t('Perform administration to Hijri Settings.'),
    ),
  );
}

/**
 * Implements hook_node_view().
 */
function hijri_node_view($node) {
  unset($node->content['field_hijri_correction']);
}


/**
 * * @file hijri.inc
 * Retrive Hijri date like Drupal format_date function.
 */
function hijri_format_date($timestamp, $type = 'medium', $format = '', $correction = 0) {
  switch ($type) {
    case 'full':
      return t('@hijri on @gregorian', array('@hijri' => hijri('l j F  Y', time(), $correction), '@gregorian' => format_date(time(), 'custom', 'F j, Y')));

    case 'long':
      $format = variable_get('date_format_long', 'l, F j, Y - H:i');
      break;

    case 'medium':
      $format = variable_get('date_format_medium', 'D, m/d/Y - H:i');
      break;

    case 'short':
      $format = variable_get('date_format_short', 'm/d/Y - H:i');
      break;

    case 'custom':
      // No change to format.
      break;
  }

  return hijri($format, $timestamp, $correction);
}

/**
 * Retrive Hijri date from given format and timestamp.
 */
function hijri($format, $timestamp = NULL, $correction = 0) {
  $timestamp = ($timestamp == NULL ? time() : $timestamp);
  $hijri_month_name = hijri_month_names();
  $hijri_day_name = hijri_day_names();

  // 0. Preparing timestamp if there is increments?
  if ($correction != 0) {
    $timestamp = $timestamp + (60 * 60 * 24 * $correction);
  }

  // 1. $calc_hijri_date to retrive Hijri Year, Hijri Month and Hijri day in numbers.
  $year = format_date($timestamp, 'custom', 'Y');
  $month = format_date($timestamp, 'custom', 'n');
  $day = format_date($timestamp, 'custom', 'j');
  $calc_hijri_date = hijri_calc($year, $month, $day);

  // 2. Reserve constants that able to convert to Hijri.
  $replacements = array('x01', 'x02', 'x03', 'x04', 'x05', 'x06', 'x07', 'x08', 'x09', 'x10', 'x11');
  $patterns = array('Y', 'y', 'M', 'F', 'm', 'n', 'L', 'l', 'D', 'd', 'j');
  $format = str_replace($patterns, $replacements, $format);

  // 3. Converting user given date.
  $date_result = format_date($timestamp, 'custom', $format);

  // 4. Replacing reserved constants with Hijri results.
  $patterns = $replacements = array();
  // Y
  $patterns[] = 'x01';
  $replacements[] = $calc_hijri_date[0];

  // y
  $patterns[] = 'x02';
  $replacements[] = substr($calc_hijri_date[0], -2);

  // M .. There is no shortname in Hijri month names.
  $patterns[] = 'x03';
  $replacements[] = $hijri_month_name[$calc_hijri_date[1]];
  // F
  $patterns[] = 'x04';
  $replacements[] = $hijri_month_name[$calc_hijri_date[1]];

  // m
  $patterns[] = 'x05';
  $replacements[] = sprintf('%02d', $calc_hijri_date[1]);
  // n
  $patterns[] = 'x06';
  $replacements[] = $calc_hijri_date[1];

  // L
  $patterns[] = 'x07';
  $replacements[] = $hijri_day_name[format_date($timestamp, 'custom', 'N')];
  // l .. There is no lowercase in Arabic day names.
  $patterns[] = 'x08';
  $replacements[] = $hijri_day_name[format_date($timestamp, 'custom', 'N')];
  // D .. There is no shortnames in Arabic day names.
  $patterns[] = 'x09';
  $replacements[] = $hijri_day_name[format_date($timestamp, 'custom', 'N')];

  // d
  $patterns[] = 'x10';
  $replacements[] = sprintf('%02d', $calc_hijri_date[2]);

  // j
  $patterns[] = 'x11';
  $replacements[] = $calc_hijri_date[2];


  return str_replace($patterns, $replacements, $date_result);
}

/**
 * Retrive Hijri months names.
 */
function hijri_month_names() {

  // This Arabic names should written in English with t() function.
  return array(
    '1' => t('Muharram'),
    '2' => t('Safar'),
    '3' => t('Rabia al-Awwal'),
    '4' => t('Rabia ath-Thani'),
    '5' => t('Jumada al-Ula'),
    '6' => t('Jumada ath-Thaniya'),
    '7' => t('Rajab'),
    '8' => t('Shaban'),
    '9' => t('Ramadan'),
    '10' => t('Shawwal'),
    '11' => t('Dhu al-Qada'),
    '12' => t('Dhu al-Hijja'),
  );
}

/**
 * Retrive day names to replace the N in date function.
 */
function hijri_day_names() {

  return array(
    '1' => t('Monday'),
    '2' => t('Tuesday'),
    '3' => t('Wednesday'),
    '4' => t('Thursday'),
    '5' => t('Friday'),
    '6' => t('Saturday'),
    '7' => t('Sunday'),
  );
}

/**
 * Calculate Hijri date from the given Gregorian by converting through Julian day.
 * For more checkout these links:
 * http://php.net/manual/en/ref.calendar.php#54234
 * http://sourceforge.net/p/ar-php/code/47/tree/I18N/Arabic/Date.php#l442
 */
function hijri_calc($y, $m, $d) {

  $jd = cal_to_jd(CAL_GREGORIAN, $m, $d, $y);
  $jd = $jd - 1948440 + 10632;
  $n = (int)(($jd - 1) / 10631);
  $jd = $jd - 10631 * $n + 354;
  $j = ((int)((10985 - $jd) / 5316)) * ((int)(50 * $jd / 17719)) + ((int)($jd / 5670)) * ((int)(43 * $jd / 15238));
  $jd = $jd - ((int)((30 - $j) / 15)) * ((int)((17719 * $j) / 50)) - ((int)($j / 16)) * ((int)((15238 * $j) / 43)) + 29;
  $m = (int)(24 * $jd / 709);
  $d = $jd - (int)(709 * $m / 24);
  $y = 30 * $n + $j - 30;

  return array($y, $m, $d);
}
