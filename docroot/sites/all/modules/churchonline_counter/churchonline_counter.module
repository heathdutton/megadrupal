<?php

/**
 * @file
 * Display ChurchOnline.org Countdown clock.
 */

/**
 * Implements hook_block_info().
 */
function churchonline_counter_block_info() {
  return array(
    'counter' => array(
      'info' => t('ChurchOnline Countdown'),
      'cache' => DRUPAL_CACHE_GLOBAL,
    ),
  );
}

/**
 * Implements hook_block_configure().
 */
function churchonline_counter_block_configure($delta = '') {
  $form = array();
  switch ($delta) {
    case 'counter':
      $form['churchonline_counter_platform_id'] = array(
        '#type' => 'textfield',
        '#title' => t('ChurchOnline Platform Domain'),
        '#default_value' => variable_get('churchonline_counter_platform_id', NULL),
        '#description' => t('Enter the domain name for your ChurchOnline platform. Do not include leading http:// or trailing slashes.'),
        // '#size' => 60,
      );
      break;
  }
  return $form;
}

/**
 * Implements hook_block_save().
 */
function churchonline_counter_block_save($delta = '', $edit = array()) {
  switch ($delta) {
    case 'counter':
      variable_set('churchonline_counter_platform_id', $edit['churchonline_counter_platform_id']);
      break;
  }
}

/**
 * Implements hook_block_view().
 */
function churchonline_counter_block_view($delta = '') {
  $block = array();
  switch ($delta) {
    case 'counter':
      $platform_id = variable_get('churchonline_counter_platform_id', NULL);
      if (!empty($platform_id)) {
        drupal_add_css(drupal_get_path('module', 'churchonline_counter') . '/churchonline_counter.css');
        drupal_add_js(churchonline_counter_headtext($platform_id), 'inline');
        $block['subject'] = t('Countdown');
        $block['content'] = array(
          '#type' => 'item',
          '#markup' => churchonline_counter_blocktext(),
        );
      }
  }
  return $block;
}

/**
 * Build header content string.
 */
function churchonline_counter_headtext($platform_id) {
  $countdown_script = <<<ENDSCRIPT
    //<![CDATA[
  jQuery(document).ready(function($) {
    var days;
    var hours;
    var minutes;
    var seconds;
    var intervalId;

    function goLive() {
      $('#churchonline_counter .live').show();
      $('#churchonline_counter .time, #churchonline_counter .info').hide();
    }

    $.ajax({
ENDSCRIPT;
  $countdown_script .= 'url: "http://' . $platform_id . '/event_times/next",';
  $countdown_script .= <<<ENDSCRIPT

      dataType: "jsonp",
      success: function (data) {
        $('#churchonline_counter').show();

        if (typeof(data.current_timestamp) !== "undefined") {
          goLive();
        }
        else if (typeof(data.next_timestamp) !== "undefined") {
          $("#churchonline_counter .title").html(data.next_title);
          $("#churchonline_counter .description").html(data.next_description);

          var seconds_till = data.next_timestamp - (new Date().getTime() / 1000);

          days = Math.floor(seconds_till / 86400);
          hours = Math.floor((seconds_till % 86400) / 3600);
          minutes = Math.floor((seconds_till % 3600) / 60);
          seconds = Math.floor(seconds_till % 60);

          intervalId = setInterval(function () {
            if (--seconds < 0) {
              seconds = 59;
              if (--minutes < 0) {
                minutes = 59;
                if (--hours < 0) {
                  hours = 23;
                  if (--days < 0) {
                    days = 0;
                  }
                }
              }
            }

            $("#churchonline_counter .days").html((days.toString().length < 2) ? "0"+days : days);
            $("#churchonline_counter .hours").html((hours.toString().length < 2) ? "0"+hours : hours);
            $("#churchonline_counter .minutes").html((minutes.toString().length < 2) ? "0"+minutes : minutes);
            $("#churchonline_counter .seconds").html((seconds.toString().length < 2) ? "0"+seconds : seconds);

            if (seconds == 0 && minutes == 0 && hours == 0 && days == 0) {
              goLive();
              clearInterval(intervalId);
            }
          }, 1000);
        }
      }
    });
  });
    //]]>
ENDSCRIPT;
  return $countdown_script;
}

/**
 * Build block content string.
 */
function churchonline_counter_blocktext() {

  $block_data = <<<ENDSCRIPT
<div id="churchonline_counter">
  <div class="live">Live Now</div>
  <div class="info">
    <div class="title"></div>
    <div class="description"></div>
  </div>
  <ul class="time">
    <li><span class="days"></span> <br /><span class="label">days</span></li>
    <li><span class="hours"></span> <br /><span class="label">hrs</span></li>
    <li><span class="minutes"></span> <br /><span class="label">mins</span></li>
    <li><span class="seconds"></span> <br /><span class="label">secs</span></li>
  </ul>
</div>
ENDSCRIPT;
  return $block_data;
}
