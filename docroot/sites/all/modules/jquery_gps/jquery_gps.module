<?php
/**
 * @file
 * The main module file for the jQuery GPS module.
 */

/**
 * Implementation of hook_block_info().
 */
function jquery_gps_block_info() {
  $blocks['jquery_gps'] = array(
    'info' => t('jQuery GPS'),
  );
  return $blocks;
}

/**
 * Implementation of hook_block_view().
 */
function jquery_gps_block_view($delta = '') {
  $blocks = array();
  // Load settings
  $settings = variable_get('jquery_gps');
  if (!$settings['api_key']) {
    drupal_set_message(t("You must have a Google Maps ID for the jQuery GPS module. You can get it from <a href='@url' target='_blank'>here</a>", array("@url" => "http://code.google.com/intl/en/apis/maps/signup.html")),"error");
  } else {
    // Clearly declare the API location
    $apipath = "http://maps.google.com/maps?file=api&v=2&sensor=true&key=" . $settings['api_key'];

    // Load the JS files and functions
    drupal_add_js($apipath, "external");
    drupal_add_js(drupal_get_path("module","jquery_gps") . "/js/gps.jquery.js", "file");
    drupal_add_js('jQuery(document).ready(function () { jQuery("#map").googleMap().load(); });', 'inline');

    // Prepare the output
    $output = "<div id='directions'></div>";
    $output .= "<div id='map' style='height: " . $settings['height'] . "px;width: " . $settings['width'] . "px;position:relative;'></div>";
    $output .= t("From") . " : <input type='text' id='start' />";
    $output .= "<input type='hidden' id='end' value='" . $settings['to'] . "' />";
    $output .= "<input type='submit' id='getdirections' value='". t('Get Directions!') . "' />";

    // Show the output!
    switch ($delta) {
      case 'jquery_gps':
        $blocks['subject'] = t('jQuery GPS');
        $blocks['content'] = $output;
    }
    return $blocks;
  }
}

/**
 * Implementation of hook_menu().
 */
function jquery_gps_menu() {
  $items = array();
  $items['admin/config/user-interface/jquery_gps_settings'] = array(
    'title' => 'jQuery GPS Settings',
    'description' => 'Configure jQuery GPS settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('jquery_gps_settings_form'),
    'access callback' => 'user_access',
    'access arguments' => array('administer jQuery GPS'),
  );
  return $items;
}

/**
 * jQuery GPS settings form.
 */
function jquery_gps_settings_form() {
  $form = array();
  $form['#tree'] = TRUE;
  $settings = variable_get('jquery_gps');
  $form['jquery_gps']['api_key'] = array(
    '#title' => t('Google Maps API Key'),
    '#type' => 'textfield',
    '#default_value' => ($settings['api_key']) ? $settings['api_key'] : array(),
    '#description' => t('You can get it <a href="@url" target="_blank">here</a>', array("@url" => "http://code.google.com/intl/en/apis/maps/signup.html")),
  );
  $form['jquery_gps']['width'] = array(
    '#title' => t('Map Width'),
    '#type' => 'textfield',
    '#default_value' => ($settings['width']) ? $settings['width'] : array("300"),
    '#description' => t('Set the width of the map (e.g. 300 for 300px)'),
  );
  $form['jquery_gps']['height'] = array(
    '#title' => t('Map Height'),
    '#type' => 'textfield',
    '#default_value' => ($settings['height']) ? $settings['height'] : array("200"),
    '#description' => t('Set the height of the map (e.g 200 for 200px)'),
  );
  $form['jquery_gps']['to'] = array(
    '#title' => t('Default "To" Field'),
    '#type' => 'textfield',
    '#default_value' => ($settings['to']) ? $settings['to'] : array("2000 Florida Ave NW Washington, DC 20009-1231"),
    '#description' => t('Set the default "to" field. (Generally your address)'),
  );
  
  return system_settings_form($form);
}