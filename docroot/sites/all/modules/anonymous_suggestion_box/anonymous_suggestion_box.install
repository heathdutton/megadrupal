<?php
/**
 * @file
 * Install, update and uninstall functions for anonymous_suggestion_box.
 */

/**
 * Implements hook_install().
 *
 * Set default values for variables used elsewhere.
 */
function anonymous_suggestion_box_install() {
  $site_email = variable_get('site_mail');
  // Set to and from email to site_mail.
  variable_set('anonymous_suggestion_box_to_email', $site_email);
  variable_set('anonymous_suggestion_box_from_email', $site_email);
  variable_set('anonymous_suggestion_box_form_intro', 'Please fill out the Anonymous Suggestion Box form below.');
  variable_set('anonymous_suggestion_box_min_textarea', 2);
  variable_set('anonymous_suggestion_box_max_textarea', 21845);
  // Set default method to save to database only as this is contained
  // to only Drupal functions and does not rely on external resources
  // such as an MTA or sendmail. Also prevents emails from being sent
  // without the administrator from having a chance to set the email
  // addresses to something other than site_mail.
  variable_set('anonymous_suggestion_box_method_email', 0);
  variable_set('anonymous_suggestion_box_method_db', 1);
}

/**
 * Implements hook_requirements().
 */
function anonymous_suggestion_box_requirements($phase) {
  $t = get_t();
  // Warn if the site as the core tracker module or the Google Analytics
  // module enabled as this could present a breach in true anonymity if
  // paired with permissions to view the submissions.
  if ($phase == 'runtime' && (module_exists('tracker') ||
  module_exists('googleanalytics'))) {
    $requirements = array();
    $requirements['user_tracking']['title'] = $t('Anonymous Suggestion User Tracking');
    $requirements['user_tracking']['value'] = $t('Manual Check Required');
    $requirements['user_tracking']['description'] = $t('Ensure users who have access to anonymous suggestion box submissions do not have access to tracking information from Tracker module, Google Analytics or other contributed modules.');
    // Uses severity of info, as having the tracker or googleanalytics
    // modules enabled does not necessarily indicate an issue.
    $requirements['user_tracking']['severity'] = REQUIREMENT_INFO;
    return $requirements;
  }
}
/**
 * Implements hook_schema().
 *
 * Create a table to store submissions later. This might not be used if
 * the administrator disables method_db.
 */
function anonymous_suggestion_box_schema() {
  $schema['anonymous_suggestion_box'] = array(
    'description' => 'Stores suggestions from the anonymous suggestion module.',
    'fields' => array(
      'sid'  => array(
        'type' => 'serial',
        'not null' => TRUE,
        'description' => 'Primary Key: Unique suggestion ID.',
      ),
      'location' => array(
        'type' => 'text',
        'size' => 'normal',
        'description' => 'Locations',
      ),
      'observation' => array(
        'type' => 'text',
        'size' => 'normal',
        'description' => 'observations',
      ),
      'suggested' => array(
        'type' => 'text',
        'size' => 'normal',
        'description' => 'Suggestions',
      ),
    ),
    'primary key' => array('sid'),
  );

  return $schema;
}
/**
 * Implements hook_uninstall().
 *
 * Get rid of all the variables on uninstall.
 */
function anonymous_suggestion_box_uninstall() {
  variable_del('anonymous_suggestion_box_method_db');
  variable_del('anonymous_suggestion_box_method_email');
  variable_del('anonymous_suggestion_box_to_email');
  variable_del('anonymous_suggestion_box_from_email');
  variable_del('anonymous_suggestion_box_form_intro');
  variable_del('anonymous_suggestion_box_min_textarea');
  variable_del('anonymous_suggestion_box_max_textarea');
}
