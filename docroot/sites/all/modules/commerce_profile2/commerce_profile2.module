<?php
/**
 * @file
 * Allows profile2 checkouts with drupal commerce.
 */

module_load_include('inc', 'commerce_profile2', 'includes/commerce_profile2.checkout_page');
module_load_include('inc', 'commerce_profile2', 'includes/commerce_profile2.checkout_pane');
module_load_include('inc', 'commerce_profile2', 'includes/commerce_profile2.field');

/**
 * Implements hook_commerce_checkout_page_info_alter().
 *
 * Here we can change the definitions of pages that have been provided by this
 * or other modules.
 *
 * @param array $pages
 *   All the pages that have been defined.
 */
function commerce_profile2_commerce_checkout_page_info_alter(&$pages) {
  // $pages['review']['submit_value'] = 'Custom text';
}

/**
 * Implements hook_commerce_checkout_complete().
 *
 * This is for business logic after the order completes.
 *
 * @param object $order
 *   The current order.
 */
function commerce_profile2_commerce_checkout_complete($order) {
  global $user;
  $order_data = (array) $order->data['checkout_pane'];
  if (!empty($order_data)) {
    foreach ($order_data as $profile2_sku => $profile2_index) {
      foreach ($profile2_index as $key => $value) {
        $data = $order_data[$profile2_sku][$key];
        $account = user_load_by_mail($data['profile2_email']);
        if ($account) {
          $member_account = $account;
        }
        else {
          $account->is_new = TRUE;
          $account->status = TRUE;

          $edit = array(
            'name' => $data['profile2_email'],
            'mail' => $data['profile2_email'],
            'status' => 1,
            'init' => $data['profile2_email'],
            'roles' => array(
              DRUPAL_AUTHENTICATED_RID => TRUE,
              $data['hidden']['user_role'] => TRUE,
            ),
          );
          $member_account = user_save($account, $edit);

          // Send email to profile user.
          _user_mail_notify($data['hidden']['created_email'], $member_account);
        }

        // Create profile object.
        $profile = profile2_create(array('user' => $member_account, 'type' => $data['hidden']['profile2_type']));

        // Unset info from the order data array that isn't in the field bundle.
        unset($data['profile2_email']);
        unset($data['hidden']);
        // Populate profile fields.
        if (isset($data)) {
          foreach ($data as $field_key => $value) {
            $profile->$field_key = $data[$field_key];
          }
        }

        profile2_save($profile);
      }
    }
  }
}
