<?php
/**
 * @file
 * Tests for the Data URI Creator module.
 */

/**
 * Test the API for the detection, encoding and decoding of Data URIs.
 */
class DataUriCreatorTestCase extends DrupalUnitTestCase {

  /**
   * Implement getInfo().
   */
  public static function getInfo() {
    return array(
      'name' => 'Data URI coding',
      'description' => 'Tests proper detection, encoding and decoding of Data URIs.',
      'group' => 'Data URI API',
    );
  }

  /**
   * Implement setUp().
   */
  protected function setUp() {
    require_once 'string_class.inc';
    require_once 'data_uri_creator_class.inc';
    drupal_load('module', 'data_uri_creator');
    parent::setUp();
  }

  /**
   * Test DataUriCreator::isDataUri().
   */
  protected function testIsDataUri() {
    // These values must NOT be categorized as Data URI schemes.
    $this->assertIdentical(FALSE, DataUriCreator::isDataUri(NULL));
    $this->assertIdentical(FALSE, DataUriCreator::isDataUri(''));
    $this->assertIdentical(FALSE, DataUriCreator::isDataUri('http://example.com/'));
    $this->assertIdentical(FALSE, DataUriCreator::isDataUri('zzz'));
    $this->assertIdentical(FALSE, DataUriCreator::isDataUri('xy:'));
    $this->assertIdentical(FALSE, DataUriCreator::isDataUri('c:/d'));
    $this->assertIdentical(FALSE, DataUriCreator::isDataUri('c:/,'));
    $this->assertIdentical(FALSE, DataUriCreator::isDataUri('data'));
    $this->assertIdentical(FALSE, DataUriCreator::isDataUri('data,'));
    $this->assertIdentical(FALSE, DataUriCreator::isDataUri('data;'));
    $this->assertIdentical(FALSE, DataUriCreator::isDataUri('data;,'));

    // These values MUST be categorized as Data URI schemes,
    // despite the fact that they are actually invalid Data URIs.
    $this->assertIdentical(TRUE, DataUriCreator::isDataUri('data:'));
    $this->assertIdentical(TRUE, DataUriCreator::isDataUri('data://'));
    $this->assertIdentical(TRUE, DataUriCreator::isDataUri('data:ABC'));

    // These values MUST be categorized as Data URI schemes (mostly valid URIs).
    $this->assertIdentical(TRUE, DataUriCreator::isDataUri('data:,'));
    $this->assertIdentical(TRUE, DataUriCreator::isDataUri('data:,abc'));
    $this->assertIdentical(TRUE, DataUriCreator::isDataUri('data:text/plain,def'));
    $this->assertIdentical(TRUE, DataUriCreator::isDataUri('data:text/plain;charset=utf-8,ghi'));
    $this->assertIdentical(TRUE, DataUriCreator::isDataUri('data:;base64,REVG'));
    $this->assertIdentical(TRUE, DataUriCreator::isDataUri('data:base64,REVG'));
    $this->assertIdentical(TRUE, DataUriCreator::isDataUri('data:text/plain;base64,R0hJ'));
    $this->assertIdentical(TRUE, DataUriCreator::isDataUri('data:text/plain;charset=utf-8;base64,SktM'));
    foreach ($this->blobs as $blob_id => &$blob) {
      $this->assertIdentical(TRUE, DataUriCreator::isDataUri($blob['uri']), format_string('Detect @label (@id) as a Data URI.', array('@id' => $blob_id, '@label' => $blob['label'])));
    }
  }

  /**
   * Test DataUriCreator::decode() with invalid Data URIs.
   */
  protected function testInvalidDataUri() {
    // These values must NOT be categorized as valid Data URIs.
    $this->assertIdentical(NULL, DataUriCreator::decode(NULL));
    $this->assertIdentical(NULL, DataUriCreator::decode(''));
    $this->assertIdentical(NULL, DataUriCreator::decode('http://example.com/'));
    $this->assertIdentical(NULL, DataUriCreator::decode('zzz'));
    $this->assertIdentical(NULL, DataUriCreator::decode('xy:'));
    $this->assertIdentical(NULL, DataUriCreator::decode('c:/d'));
    $this->assertIdentical(NULL, DataUriCreator::decode('c:/,'));
    $this->assertIdentical(NULL, DataUriCreator::decode('data'));
    $this->assertIdentical(NULL, DataUriCreator::decode('data,'));
    $this->assertIdentical(NULL, DataUriCreator::decode('data;'));
    $this->assertIdentical(NULL, DataUriCreator::decode('data;,'));
    $this->assertIdentical(NULL, DataUriCreator::decode('data:'));
    $this->assertIdentical(NULL, DataUriCreator::decode('data://'));
    $this->assertIdentical(NULL, DataUriCreator::decode('data:ABC'));
  }

  /**
   * Test DataUriCreator::decode() in general.
   */
  protected function testDecode() {
    // Verify that output variables are cleared for invalid input.
    $mime_type = 'text/plain';
    $is_base64 = FALSE;
    $media_type_parts = array('dummy');
    $data = DataUriCreator::decode('', $mime_type, $is_base64, FALSE, TRUE, $media_type_parts);
    $this->assertIdentical(NULL, $data);
    $this->assertIdentical(NULL, $mime_type);
    $this->assertIdentical(NULL, $is_base64);
    $this->assertIdentical(NULL, $media_type_parts);

    // These values MUST be categorized as Data URIs (that is, not return NULL).
    $this->assertIdentical('', DataUriCreator::decode('data:,'));
    $this->assertIdentical('abc', DataUriCreator::decode('data:,abc'));
    $this->assertIdentical('def', DataUriCreator::decode('data:text/plain,def'));
    $this->assertIdentical('ghi', DataUriCreator::decode('data:text/plain;charset=utf-8,ghi'));
    $this->assertIdentical('DEF', DataUriCreator::decode('data:;base64,REVG'));
    $this->assertIdentical('REVG', DataUriCreator::decode('data:base64,REVG'));
    $this->assertIdentical('GHI', DataUriCreator::decode('data:text/plain;base64,R0hJ'));
    $this->assertIdentical('JKL', DataUriCreator::decode('data:text/plain;charset=utf-8;base64,SktM'));
    foreach ($this->blobs as $blob_id => &$blob) {
      $this->assertIdentical($blob['data'], DataUriCreator::decode($blob['uri']), format_string('Decode data of @label (@id).', array('@id' => $blob_id, '@label' => $blob['label'])));
    }

    // RFC 2397: Text example.
    $uri = 'data:,A%20brief%20note';
    $mime_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($uri, $mime_type, $is_base64);
    $this->assertIdentical($data, 'A brief note');
    $this->assertIdentical($mime_type, 'text/plain');
    $this->assertIdentical($is_base64, FALSE);
    $media_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($uri, $media_type, $is_base64, TRUE);
    $this->assertIdentical($media_type, 'text/plain;charset=US-ASCII');

    // RFC 2397: "Larry" image (RFC was authored by Larry Masinter).
    $blob = $this->blobs['larry_image'];
    $mime_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($blob['uri'], $mime_type, $is_base64);
    $this->assertIdentical($data, $blob['data'], 'Compare "Larry" GIF image data.');
    $this->assertIdentical($mime_type, $blob['mime_type']);
    $this->assertIdentical($is_base64, $blob['is_base64']);
    $media_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($blob['uri'], $media_type, $is_base64, TRUE);
    $this->assertIdentical($media_type, $blob['media_type']);

    // RFC 2397, corrected with Errata ID 2009: "sequence of greek characters".
    $uri = 'data:text/plain;charset=iso-8859-7,%be%d3%be';
    $mime_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($uri, $mime_type, $is_base64);
    $this->assertIdentical($data, "\xBE\xD3\xBE", 'Compare greek characters (RFC 2397, Errata ID: 2009).');
    $this->assertIdentical($mime_type, 'text/plain');
    $this->assertIdentical($is_base64, FALSE);
    $media_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($uri, $media_type, $is_base64, TRUE);
    $this->assertIdentical($media_type, 'text/plain;charset=iso-8859-7');

    // RFC 2397, original bad encoding: "sequence of greek characters".
    $uri = 'data:text/plain;charset=iso-8859-7,%be%fg%be';
    $mime_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($uri, $mime_type, $is_base64);
    $this->assertIdentical($data, "\xBE%fg\xBE", 'Compare greek characters (RFC 2397, faulty original).');
    $this->assertIdentical($mime_type, 'text/plain');
    $this->assertIdentical($is_base64, FALSE);
    $media_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($uri, $media_type, $is_base64, TRUE);
    $this->assertIdentical($media_type, 'text/plain;charset=iso-8859-7');

    // Alternative "sequence of greek characters" (that can be represented in
    // HTML as "&#904;&#967;&#974;" or equivalently "&#x0388;&#x03C7;&#x03CE;").
    $uri = 'data:text/plain;charset=iso-8859-7,%b8%f7%fe';
    $mime_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($uri, $mime_type, $is_base64);
    $this->assertIdentical($data, "\xB8\xF7\xFE", 'Compare greek characters (alternative test).');
    $this->assertIdentical($mime_type, 'text/plain');
    $this->assertIdentical($is_base64, FALSE);
    $media_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($uri, $media_type, $is_base64, TRUE);
    $this->assertIdentical($media_type, 'text/plain;charset=iso-8859-7');

    // RFC 2397: "Hypothetical helper app" example.
    $uri = 'data:application/vnd-xxx-query,select_vcount,fcol_from_fieldtable/local';
    $mime_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($uri, $mime_type, $is_base64);
    $this->assertIdentical($data, 'select_vcount,fcol_from_fieldtable/local');
    $this->assertIdentical($mime_type, 'application/vnd-xxx-query');
    $this->assertIdentical($is_base64, FALSE);
    $media_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($uri, $media_type, $is_base64, TRUE);
    $this->assertIdentical($media_type, 'application/vnd-xxx-query');

    $blob = $this->blobs['red_dot'];
    $mime_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($blob['uri'], $mime_type, $is_base64);
    $this->assertIdentical($data, $blob['data'], 'Compare red-dot PNG image data.');
    $this->assertIdentical($mime_type, $blob['mime_type']);
    $this->assertIdentical($is_base64, $blob['is_base64']);
    $media_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($blob['uri'], $media_type, $is_base64, TRUE);
    $this->assertIdentical($media_type, $blob['media_type']);

    $blob = $this->blobs['html_element'];
    $mime_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($blob['uri'], $mime_type, $is_base64);
    $this->assertIdentical($data, $blob['data']);
    $this->assertIdentical($mime_type, $blob['mime_type']);
    $this->assertIdentical($is_base64, $blob['is_base64']);
    $media_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($blob['uri'], $media_type, $is_base64, TRUE);
    $this->assertIdentical($media_type, $blob['media_type']);

    // Scheme only: No data, no error.  From standards based testing at...
    // http://www-archive.mozilla.org/quality/networking/testing/datatests.html
    $uri = 'data:';
    $mime_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($uri, $mime_type, $is_base64);
    $this->assertIdentical($data, NULL);
    $this->assertIdentical($mime_type, NULL);
    $this->assertIdentical($is_base64, NULL);
    $media_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($uri, $media_type, $is_base64, TRUE);
    $this->assertIdentical($media_type, NULL);

    // Data without data segment: No data, no error.
    $uri = 'data:,';
    $mime_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($uri, $mime_type, $is_base64);
    $this->assertIdentical($data, '');
    $this->assertIdentical($mime_type, 'text/plain');
    $this->assertIdentical($is_base64, FALSE);
    $media_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($uri, $media_type, $is_base64, TRUE);
    $this->assertIdentical($media_type, 'text/plain;charset=US-ASCII');

    $uri = 'data:;base64,';
    $mime_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($uri, $mime_type, $is_base64);
    $this->assertIdentical($data, '');
    $this->assertIdentical($mime_type, 'text/plain');
    $this->assertIdentical($is_base64, TRUE);
    $media_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($uri, $media_type, $is_base64, TRUE);
    $this->assertIdentical($media_type, 'text/plain;charset=US-ASCII');

    $uri = 'data:text/plain,';
    $mime_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($uri, $mime_type, $is_base64);
    $this->assertIdentical($data, '');
    $this->assertIdentical($mime_type, 'text/plain');
    $this->assertIdentical($is_base64, FALSE);
    $media_type = 'N/A';
    $is_base64 = NULL;
    $data = DataUriCreator::decode($uri, $media_type, $is_base64, TRUE);
    $this->assertIdentical($media_type, 'text/plain');
  }

  /**
   * Test DataUriCreator::encode().
   */
  protected function testEncode() {
    $this->assertIdentical('data:,', DataUriCreator::encode('', '', FALSE));
    $this->assertIdentical('data:;base64,', DataUriCreator::encode('', '', TRUE));
    $this->assertIdentical('data:;base64,', DataUriCreator::encode('', ';base64', FALSE));
    $this->assertIdentical('data:;base64,', DataUriCreator::encode('', ';base64', TRUE));

    foreach ($this->blobs as $blob_id => &$blob) {
      $uri = DataUriCreator::encode($blob['data'], $blob['media_type'], $blob['is_base64']);
      $this->assertIdentical($uri, $blob['uri'], format_string('Encode @label (@id).', array('@id' => $blob_id, '@label' => $blob['label'])));
    }
  }

  /**
   * Registry of some larger Data URIs that are used for testing.
   */
  protected $blobs = array(
    'red_dot' => array(
      'label' => 'red-dot PNG image',
      'uri' => 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg==',
      'data' => "\x89PNG\x0D\x0A\x1A\x0A\x00\x00\x00\x0DIHDR\x00\x00\x00\x05\x00\x00\x00\x05\x08\x06\x00\x00\x00\x8Do\x26\xE5\x00\x00\x00\x1CIDAT\x08\xD7c\xF8\xFF\xFF?\xC3\x7F\x06\x20\x05\xC3\x20\x12\x84\xD01\xF1\x82X\xCD\x04\x00\x0E\xF55\xCB\xD1\x8E\x0E\x1F\x00\x00\x00\x00IEND\xAEB\x60\x82",
      'is_base64' => TRUE,
      'media_type' => 'image/png',
      'mime_type' => 'image/png',
    ),
    'larry_image' => array(
      'label' => '"Larry" GIF image from RFC 2397 by Larry Masinter',
      'uri' => 'data:image/gif;base64,R0lGODdhMAAwAPAAAAAAAP///ywAAAAAMAAwAAAC8IyPqcvt3wCcDkiLc7C0qwyGHhSWpjQu5yqmCYsapyuvUUlvONmOZtfzgFzByTB10QgxOR0TqBQejhRNzOfkVJ+5YiUqrXF5Y5lKh/DeuNcP5yLWGsEbtLiOSpa/TPg7JpJHxyendzWTBfX0cxOnKPjgBzi4diinWGdkF8kjdfnycQZXZeYGejmJlZeGl9i2icVqaNVailT6F5iJ90m6mvuTS4OK05M0vDk0Q4XUtwvKOzrcd3iq9uisF81M1OIcR7lEewwcLp7tuNNkM3uNna3F2JQFo97Vriy/Xl4/f1cf5VWzXyym7PHhhx4dbgYKAAA7',
      'data' => "GIF87a0\x000\x00\xF0\x00\x00\x00\x00\x00\xFF\xFF\xFF,\x00\x00\x00\x000\x000\x00\x00\x02\xF0\x8C\x8F\xA9\xCB\xED\xDF\x00\x9C\x0EH\x8Bs\xB0\xB4\xAB\x0C\x86\x1E\x14\x96\xA64.\xE7*\xA6\x09\x8B\x1A\xA7+\xAFQIo8\xD9\x8Ef\xD7\xF3\x80\x5C\xC1\xC90u\xD1\x0819\x1D\x13\xA8\x14\x1E\x8E\x14M\xCC\xE7\xE4T\x9F\xB9b\x25*\xADqyc\x99J\x87\xF0\xDE\xB8\xD7\x0F\xE7\x22\xD6\x1A\xC1\x1B\xB4\xB8\x8EJ\x96\xBFL\xF8;\x26\x92G\xC7\x27\xA7w5\x93\x05\xF5\xF4s\x13\xA7(\xF8\xE0\x078\xB8v(\xA7Xgd\x17\xC9\x23u\xF9\xF2q\x06We\xE6\x06z9\x89\x95\x97\x86\x97\xD8\xB6\x89\xC5jh\xD5Z\x8AT\xFA\x17\x98\x89\xF7I\xBA\x9A\xFB\x93K\x83\x8A\xD3\x934\xBC94C\x85\xD4\xB7\x0B\xCA;:\xDCwx\xAA\xF6\xE8\xAC\x17\xCDL\xD4\xE2\x1CG\xB9D\x7B\x0C\x1C.\x9E\xED\xB8\xD3d3\x7B\x8D\x9D\xAD\xC5\xD8\x94\x05\xA3\xDE\xD5\xAE,\xBF\x5E\x5E?\x7FW\x1F\xE5U\xB3\x5F,\xA6\xEC\xF1\xE1\x87\x1E\x1Dn\x06\x0A\x00\x00;",
      'is_base64' => TRUE,
      'media_type' => 'image/gif',
      'mime_type' => 'image/gif',
    ),
    'html_element' => array(
      'label' => 'basic HTML',
      'uri' => 'data:text/plain;charset=us-ascii;base64,PGgxPlNpbXBsZVRlc3QgSFRNTDwvaDE+',
      'data' => '<h1>SimpleTest HTML</h1>',
      'is_base64' => TRUE,
      'media_type' => 'text/plain;charset=us-ascii',
      'mime_type' => 'text/plain',
    ),
  );
}
