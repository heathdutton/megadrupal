<?php

/**
 * @file
 * Adds user agent, IP address, and HTTP referrer information at the end of 
 * email messages generated by Drupal's Contact module.
 */

/**
 * Implements hook_form_alter().
 */
function contact_environment_form_alter(&$form, &$form_state, $form_id) {

  switch ($form_id) {

    case 'contact_site_form':
      $form['http_referer'] = array(
        '#type' => 'hidden',
        '#title' => t('HTTP Referer'),
        '#value' => $_POST ? $_POST['http_referer'] : $_SERVER['HTTP_REFERER'],
        '#description' => NULL,
      );

      $form['remote_addr'] = array(
        '#type' => 'hidden',
        '#title' => t('Remote Addr'),
        '#value' => contact_environment_user_ip(),
        '#description' => NULL,
      );

      $form['http_user_agent'] = array(
        '#type' => 'hidden',
        '#title' => t('HTTP User Agent'),
        '#value' => empty($_SERVER['HTTP_USER_AGENT']) ? 'none' : $_SERVER['HTTP_USER_AGENT'],
        '#description' => NULL,
      );

      break;

  }

}


/**
 * Implements hook_mail_alter().
 */
function contact_environment_mail_alter(&$message) {

  switch ($message['id']) {

    case 'contact_page_mail':
      $message['body'][] = "<hr><hr>" . t("HTTP Referer:") . " " . $message['params']['http_referer'] .
      "<br />" . t("Remote Addr:") . " " . $message['params']['remote_addr'] . "<br />" . t("HTTP User Agent:") . " " .
      $message['params']['http_user_agent'] . "<hr><hr>";

      break;

  }
}

/**
 * Finds the user IP.
 */
function contact_environment_user_ip() {

  $user_ip = ip_address();

  if (isset($_SERVER['HTTP_X_REAL_IP'])) {
    if ($user_ip != $_SERVER['HTTP_X_REAL_IP']) {
      $user_ip = $_SERVER['HTTP_X_REAL_IP'];
    }
  }

  return $user_ip;
}
