<?php

/**
 * @filesource
 *   Implements hook for defining settings and showing share link
 */

/**
 * Implements hook_permission().
 */
function facebook_you_share_permission() {
  return array(
    'Share on Facebook' => array(
      'title' => t('Share on Facebook'),
      'description' => t('Allow user to share content on Facebook using Facebook You Share'),
    ),
    'administer Facebook share settings' => array(
      'title' => t('administer Facebook share settings'),
      'description' => t('Administer Facebook you Share settings'),
    ),
  );
}

/**
 * Implements hook_menu().
 *
 * Defines menu callback for admin settings and sharing with facebook.
 */
function facebook_you_share_menu() {
  $items = array();
  $items['admin/config/share-on-facebook'] = array(
    'title' => 'Facebook You Share',
    'page callback' => 'facebook_admin',
    'page arguments' => array('general'),
    'access arguments' => array('administer Facebook share settings'),
    'description' => 'Allows administrators to configure facebook post',
    'file' => 'includes/facebook_you_share.admin.inc',
  );

  // General Settings to associate with the facebook sharing
  $items['admin/config/share-on-facebook/general'] = array(
      'title' => 'General Settings',
      'type' => MENU_DEFAULT_LOCAL_TASK,
  );

  // Advanced Settings to customize the facebook share details for every content type
  $items['admin/config/share-on-facebook/advanced'] = array(
      'title' => 'Advanced Settings',
      'page callback' => 'facebook_admin',
      'page arguments' => array('advanced'),
      'access arguments' => array('administer Facebook share settings'),
      'weight' => 1,
      'type' => MENU_LOCAL_TASK,
      'file' => 'includes/facebook_you_share.admin.inc',
  );
  $items['facebook_share/%node'] = array(
    'title' => 'Share on Facebook',
    'description' => 'Thank you for sharing on Facebook',
    'page callback' => 'facebook_share',
    'page arguments' => array(1),
    'type' => MENU_NORMAL_ITEM,
    'access arguments' => array('Share on Facebook'),
    'file' => 'includes/facebook_you_share.pages.inc',
  );
  return $items;
}

/**
 * Implements hook_node_view().
 */
function facebook_you_share_node_view($node, $view_mode = 'full') {
  global $base_url;

  drupal_add_css(drupal_get_path('module', 'facebook_you_share') . '/css/facebook_you_share.css');
  //  || $node->build_mode != NODE_BUILD_NORMAL
  if (!in_array($node->type, variable_get('fb_content_types', array()), TRUE)) {
    return NULL;
  }

  // We only render the button on full pages and on teasers
  if (($view_mode != 'teaser') && ($view_mode != 'full')) {
    return NULL;
  }

  // check if the user has permissions to access the faceok share URL
  if (!user_access('Share on Facebook')) {
    return NULL;
  }

  // Retrieve the location where we should show it
  $location = variable_get('share_location', array());

  // Check if the current $view_mode has content to show
  if (($view_mode == 'teaser' && !empty($location['teasers'])) ||
    ($view_mode == 'full' && !empty($location['content']))) {

    //adding the link
    $link = '<a href = "' . $base_url . '/facebook_share/' . $node->nid . '">' .
               '<div class="facebook_custom"></div></a>';

    $node->content['facebook_custom_share'] = array(
      '#type' => 'item',
      '#markup' => $link,
      '#weight' => 10,
    );
  }
}