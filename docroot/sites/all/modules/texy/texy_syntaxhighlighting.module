<?php

/**
 * @file
 * Syntaxhighlighting support for Texy! filter module.
 */

/**
 * Implements hook_menu()
 */
function texy_syntaxhighlighting_menu() {
  $items = array();
  
  $items['admin/config/content/texy/syntaxhighlighting'] = array(
    'title' => 'Syntaxhighlighting',
    'description' => 'Customize the Texy! syntaxhighlighting settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('texy_form_syntaxhighlighting_settings'),
    'access arguments' => array('administer site configuration'),
    'type' => MENU_LOCAL_TASK,
    'file' => 'texy_syntaxhighlighting.admin.inc',
  );
    
  return $items;
}

/**
 * Implements hook_help().
 */
function texy_syntaxhighlighting_help($path, $arg) {
  switch ($path) {
    case 'admin/help#texy_syntaxhighlighting':
      return '<p>'. t('Texy! Syntaxhighlighting allows you to use code syntaxhighlighting together with Texy! filter module.') .'</p>';
    case 'admin/config/content/texy/syntaxhighlighting':
      return '<p>'. t('Below is a list of syntaxhighlighting settings for the Texy! filter module. Basic syntaxhighlighting module for <em>PHP, HTML, CSS, JavaScript, CPP, Java, SQL, Python</em> and <em>Texy</em> languages <a href="@fshl-url">FSHL (Fast Syntax Highlighter)</a> is already installed and preconfigured, you only need enable it.', array('@fshl-url' => url('http://code.google.com/p/fshl/'))) .'</p>';
  }
}

/**
 * Implements hook_texy_handler()
 */
function texy_syntaxhighlighting_texy_handler(&$texy) {
  // get base module path
  $module_path = drupal_get_path('module', 'texy_syntaxhighlighting');

  // check for use syntax highlighter
  if (variable_get('texy_syntaxhighlighting_use', FALSE)) {
    $syntaxhighlighter_name = variable_get('texy_syntaxhighlighting_name', 'fshl');
    // check name of syntax highlighter
    if ($syntaxhighlighter_name != '') {
      $syntaxhighlighter = $module_path . '/lib/' . $syntaxhighlighter_name . '.php';
      $syntaxhighlighter_dir = $module_path . '/lib/' . $syntaxhighlighter_name;
      if (file_exists($syntaxhighlighter) && file_exists($syntaxhighlighter_dir)) {
        // set user callback function for the /--- code blocks (for the syntax highlighter)
        require_once $syntaxhighlighter;
        $texy->addHandler('block', $syntaxhighlighter_name.'BlockHandler');

        // add new syntax: <?php ... ? >
        $texy->registerBlockPattern(
          'fshlPatternBlockHandler',
          '#^<\\?php\n.+?\n\\?>$#ms', // block patterns must be multiline and line-anchored
          'phpBlockSyntax'
        );

        // add new syntax: <script ...> ... </script>
        $texy->registerBlockPattern(
          'fshlPatternBlockHandler',
          '#^<script(?: type=.?text/javascript.?)?>\n.+?\n</script>$#ms', // block patterns must be multiline and line-anchored
          'scriptBlockSyntax'
        );

        // add new syntax: <...> ... </...>
        $texy->registerBlockPattern(
          'fshlPatternBlockHandler',
          '#^<(php|html|css|cpp|java|js|javascript|sql|py|python|texy)>\n.+?\n</\1>$#ms', // block patterns must be multiline and line-anchored
          'tagBlockSyntax'
        );

        // add new syntax: [...] ... [/...]
        $texy->registerBlockPattern(
          'fshlPatternBlockHandler',
          '#^\[(php|html|css|cpp|java|js|javascript|sql|py|python|texy)\]\n.+?\n\[/\1\]$#ms', // block patterns must be multiline and line-anchored
          'squareBlockSyntax'
        );

        // add new syntax: <code type="..."> ... </code>
        $texy->registerBlockPattern(
          'fshlPatternBlockHandler',
          '#^<code type="(php|html|css|cpp|java|js|javascript|sql|py|python|texy)">\n.+?\n</code>$#ms', // block patterns must be multiline and line-anchored
          'codeBlockSyntax'
        );    
      }
      else {
        drupal_set_message(t('Syntax highlighter <em>!syntaxhighlighter_name</em> is not ready...', array('!syntaxhighlighter_name' => $syntaxhighlighter_name)),'error');
      }
    }
  }
}

/**
 * Theme preprocess function for nodes. Add CSS for syntaxhighlighting.
 */
function texy_syntaxhighlighting_preprocess_node(&$vars) {
  // attach a stylesheet for the syntax highlighter
  if ( variable_get('texy_syntaxhighlighting_use', FALSE) ) {
    $path = drupal_get_path('module', 'texy_syntaxhighlighting');
    $css_path = variable_get('texy_syntaxhighlighting_css_path', 'fshl/styles/COHEN_style.css');
    drupal_add_css($path .'/lib/'. $css_path);
  }
}
