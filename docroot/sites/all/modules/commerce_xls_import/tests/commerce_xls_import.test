<?php

/**
 * @file
 * Commerce_xls_import.test.
 *
 * Tests.
 */

/**
 * Class CommerceXlsImportTestCase.
 */
class CommerceXlsImportTestCase extends DrupalWebTestCase {
  protected $adminUser;
  protected $privilegedUser;
  protected $normalUser;

  /**
   * GetInfo().
   */
  public static function getInfo() {
    return array(
      'name' => 'Commerce XLS Import Tests',
      'description' => 'Ensure Commerce XLS Import functions properly',
      'group' => 'Drupal Commerce',
    );
  }

  /**
   * Setup().
   */
  public function setUp() {

    parent::setUp(array('commerce_product_ui', 'commerce_xls_import'));

    $this->adminUser = $this->drupalCreateUser(array(
      'administer users',
      'administer permissions',
    ));

    $this->privilegedUser = $this->drupalCreateUser(array(
      'administer commerce import',
    ));

    $this->normalUser = $this->drupalCreateUser();
  }

  /**
   * Test permissions.
   */
  public function testCommerceXlsImportPermissions() {
    $this->drupalLogin($this->privilegedUser);
    $this->drupalGet('admin/commerce/products/import_commerce');
    $this->assertResponse('200', 'Privileged user was able to correctly access the admin page');

    $this->drupalLogin($this->normalUser);
    $this->drupalGet('admin/commerce/products/import_commerce');
    $this->assertResponse('403', 'Unprivileged user was unable to access the admin page');
  }

  /**
   * Test product types
   */
  public function testCommerceXlsImportProductTypes() {
    $this->drupalLogin($this->privilegedUser);
    $this->drupalGet('admin/commerce/products/import_commerce');
    $this->assertFieldByXPath("//select[@name='product_type']/option[@value='product']", 'Product', 'Product type \'Product\' found');
  }

  /**
   * Test xls upload
   */
  public function testCommerceXlsImportUpload() {
    $this->drupalLogin($this->privilegedUser);

    $edit = array(
      'product_type' => 'product',
      'files[import_file]' => drupal_get_path('module', 'commerce_xls_import') . '/sample_files/sample_tops.xls',
    );
    $this->drupalPost('admin/commerce/products/import_commerce', $edit, 'Begin Full Import');
    $this->assertText('You are currently running an import or validation, you will not be able to run another until it is finished or stopped manually', 'XLS is importing');
  }

  /**
   * Test xls import
   */
  public function testCommerceXlsImportImport() {
    //Import products from sample_tops.xls
    $file = array(
      'uri' => drupal_get_path('module', 'commerce_xls_import') . '/sample_files/sample_tops.xls',
      'product_type' => 'product',
    );
    commerce_xls_import_import($file);

    //Set admin user to have admin privileges
    $this->drupalLogin($this->adminUser);
    $this->drupalPost('user/2/edit', array('roles[3]' => TRUE), t('Save'));

    $this->drupalGet('admin/commerce/products');

    //Loop thru xls and check if all skus are in the product page, make sure #18 and above do not appear (no sku)
    $result = phpexcel_import(drupal_get_path('module', 'commerce_xls_import') . '/sample_files/sample_tops.xls');
    foreach ($result[0] as $index => $row) {
      if ($index < 18) {
        //Valid Sku
        $this->assertText($row['sku'], $row['title'] . ':' . $row['sku'] . ' found');
      } else {
        //Invalid Sku
        $this->assertNoText($row['title'], $row['title'] . ':' . $row['sku'] . ' not found');
      }
    }
  }
}
