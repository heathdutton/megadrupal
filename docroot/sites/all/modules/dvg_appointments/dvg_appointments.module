<?php

/**
 * @todo:
 * - strtotime>timestamp>strtotime>etc
 * - date is niet nodig: is date van start time
 * - helper tabel verwijderen? -> data in submission?
 * - encryptie
 * - verplichte volgorde velden, page-breaks, etc
 * - verwijderen velden verhinderen voor de afspraak-forms
 * - configureerbare middag/avond tijden
 * - product/email componenten niet emailen/tonen/selecteerbaar in preview/submission/etc
 * - appointment submission niet editten
 */

define('DVG_APPOINTMENTS_ERRORCODE_UNKNOWN', 1);
define('DVG_APPOINTMENTS_ERRORCODE_DATE_TIME', 2);

/**
 * Implements hook_menu().
 */
function dvg_appointments_menu() {
  $items = array();

  $items['admin/config/services/dvg_appointments'] = array(
    'title' => 'DvG Appointments',
    'description' => 'Configure the back-end for the appointment module',
    'access arguments' => array('administer site config'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('dvg_appointments_admin_form'),
    'file' => 'dvg_appointments.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_module_implements_alter().
 */
function dvg_appointments_module_implements_alter(&$implementations, $hook) {
  _dvg_global_module_implements_first('dvg_appointments', array('webform_submission_presave'), $implementations, $hook);
  _dvg_global_module_implements_last('dvg_appointments', array('webform_submission_load', 'form_alter'), $implementations, $hook);
}

/**
 * Factory method that asks sub-modules for an api client object.
 *
 * @return AppointmentsClientApi
 */
function dvg_appointments_get_client_api() {
  $modules = module_invoke_all('dvg_appointments_api_client');
  $api_client = variable_get('dvg_appointments_api_client', FALSE);

  if (!$api_client || !isset($modules[$api_client])) {
    throw new Exception('No appointment API client found.');
  }

  return new $modules[$api_client]['class']();
}

/**
 * Implements hook_functional_content().
 */
function dvg_appointments_functional_content() {
  return array(
    '#group' => array(
      'label' => t('DvG Appointments'),
    ),
    'dvg_appointments_create' => array(
      'label' => t('Create appointment'),
      'description' => t('The webform to create an appointment'),
    ),
    'dvg_appointments_cancel' => array(
      'label' => t('Cancel appointment'),
      'description' => t('The webform to cancel an appointment'),
    ),
  );
}

/**
 * Helper function that checks if the current form is an appointment-webform.
 */
function _dvg_appointments_is_appointment($nid, $type) {
  $type = 'dvg_appointments_' . $type;
  $fc_types = dvg_appointments_functional_content();
  unset($fc_types['#group']);
  if (isset($fc_types[$type])) {
    return $nid == functional_content_nid($type);
  }

  return FALSE;
}

/**
 * Implements hook_dvg_requirements().
 */
function dvg_appointments_dvg_requirements() {
  $requirements = array();

  $requirements['dvg_appointments_client_api'] = array(
    'title' => t('Appointments Client API'),
  );

  $modules = module_implements('dvg_appointments_api_client');
  $num_modules = count($modules);
  if ($num_modules == 1) {
    $module_info = system_get_info('module', $modules[0]);
    $requirements['dvg_appointments_client_api']['value'] = $module_info['name'];
    $requirements['dvg_appointments_client_api']['severity'] = REQUIREMENT_OK;
  }
  elseif ($num_modules > 1) {
    $requirements['dvg_appointments_client_api']['value'] = t('There are multiple modules enabled which implement the appointments api. Only 1 should be enabled.');
    $requirements['dvg_appointments_client_api']['severity'] = REQUIREMENT_ERROR;
  }
  else {
    $requirements['dvg_appointments_client_api']['value'] = t('There are no modules enabled which implement the appointments api.');
    $requirements['dvg_appointments_client_api']['severity'] = REQUIREMENT_ERROR;
  }

  $fc_forms = array(
    'dvg_appointments_create' => array(
      'label' => t('Create appointment'),
      'has_mapping' => TRUE,
      'req_components' => array(
        'wa_product',
        'wa_date_time',
      ),
    ),
    'dvg_appointments_cancel' => array(
      'label' => t('Cancel appointment'),
      'has_mapping' => FALSE,
      'req_components' => array(
        'wa_appointment',
      ),
    ),
  );

  foreach ($fc_forms as $fc_key => $fc_info) {
    $requirements['dvg_appointments_' . $fc_key] = array(
      'title' => $fc_info['label'],
      'value' => t('Ok'),
      'severity' => REQUIREMENT_OK,
    );

    $nid = functional_content_nid($fc_key);
    if (empty($nid)) {
      $requirements['dvg_appointments_' . $fc_key]['value'] = t('No webform node found. !create_link and !fc_link.', array(
        '!create_link' => l(t('Create a webform'), 'node/add/webform'),
        '!fc_link' => l(t('configure functional content'), 'admin/config/content/functional-content'),
      ));
      $requirements['dvg_appointments_' . $fc_key]['severity'] = REQUIREMENT_ERROR;
    }
    else {
      if (count($fc_info['req_components'])) {
        $node = node_load($nid);
        $components = array();
        foreach ($node->webform['components'] as $component) {
          $components[] = $component['type'];
        }
        $not_included_components = array_diff($fc_info['req_components'], $components);
        if (!empty($not_included_components)) {
          $requirements['dvg_appointments_' . $fc_key]['value'] = t('No appointment components configured in the !configure_link.', array(
            '!configure_link' => l(t('webform'), 'node/' . $nid . '/webform'),
          ));
          $requirements['dvg_appointments_' . $fc_key]['severity'] = REQUIREMENT_ERROR;
        }
        elseif ($fc_info['has_mapping'] && (empty($node->webform['appointment_enabled']) || empty($node->webform['appointment_mapping']))) {
          $requirements['dvg_appointments_' . $fc_key]['value'] = t('No field mapping configured in the !configure_link.', array(
            '!configure_link' => l(t('webform'), 'node/' . $nid . '/webform/configure'),
          ));
          $requirements['dvg_appointments_' . $fc_key]['severity'] = REQUIREMENT_ERROR;
        }
      }
    }
  }

  return $requirements;
}

/**
 * Implements hook_webform_component_info().
 */
function dvg_appointments_webform_component_info() {
  $components = array();

  $components['wa_product'] = array(
    'label' => t('Appointment product'),
    'description' => t('Appointment product selection.'),
    'features' => array(
    ),
  );
  $components['wa_date_time'] = array(
    'label' => t('Appointment date/time'),
    'description' => t('Appointment date/time selection.'),
    'features' => array(
      'required' => FALSE,
    ),
  );
  $components['wa_appointment'] = array(
    'label' => t('Appointment'),
    'description' => t('Loads an appointment.'),
    'features' => array(
    ),
  );
  $components['wa_email'] = array(
    'label' => t('Appointment email'),
    'description' => t('Loads an email address from an appointment.'),
    'features' => array(
      'email_address' => TRUE,
    ),
  );

  return $components;
}

/**
 * Implements hook_wfm_compatible_components().
 *
 * Replaces all other compatible components with just the wa_product component.
 */
function dvg_appointments_wfm_compatible_components_alter(&$types) {
  $types = array('wa_product');
}

/**
 * Implements _webform_defaults_COMPONENT().
 */
function _webform_defaults_wa_product() {
  return array(
    'name' => '',
    'form_key' => NULL,
    'required' => 0,
    'pid' => 0,
    'weight' => 0,
    'extra' => array(
      'options' => '',
      'questions' => '',
      'optrand' => 0,
      'qrand' => 0,
      'description' => '',
      'private' => FALSE,
      'analysis' => TRUE,
    ),
  );
}

/**
 * Implements _webform_defaults_COMPONENT().
 */
function _webform_defaults_wa_date_time() {
  return array(
    'name' => '',
    'form_key' => NULL,
    'required' => 0,
    'pid' => 0,
    'weight' => 0,
    'extra' => array(
      'options' => '',
      'questions' => '',
      'optrand' => 0,
      'qrand' => 0,
      'description' => '',
      'private' => FALSE,
      'analysis' => TRUE,
    ),
  );
}

/**
 * Implements _webform_edit_COMPONENT().
 */
function _webform_defaults_wa_appointment() {
  return array(
    'name' => '',
    'form_key' => NULL,
    'required' => 0,
    'pid' => 0,
    'weight' => 0,
    'extra' => array(
      'options' => '',
      'questions' => '',
      'optrand' => 0,
      'qrand' => 0,
      'description' => '',
      'private' => FALSE,
      'analysis' => TRUE,
    ),
  );
}

/**
 * Implements _webform_edit_COMPONENT().
 */
function _webform_edit_wa_product($component) {
  $form = array();

  // Disabling the description if not wanted.
  $form['extra']['description'] = array();

  return $form;
}

/**
 * Implements _webform_edit_COMPONENT().
 */
function _webform_edit_wa_date_time($component) {
  return array('extra' => array());
}

/**
 * Implements _webform_edit_COMPONENT().
 */
function _webform_edit_wa_appointment($component) {
  return array('extra' => array());
}

/**
 * Implements _webform_edit_COMPONENT().
 */
function _webform_edit_wa_email($component) {
  return array('extra' => array());
}

/**
 * Implements _webform_submit_COMPONENT().
 */
function _webform_submit_wa_product($component, $value) {
  if (!module_exists('wfm') || !_wfm_is_multiple($component)) {
    $value = array($value);
  }

  return $value;
}

/**
 * Implements _webform_submit_COMPONENT().
 */
function _webform_submit_wa_date_time($component, $value) {
  return $value['wa_date_time'];
}

/**
 * Implements _webform_submit_COMPONENT().
 */
function _webform_submit_wa_appointment($component, $value) {
  return $value['wa_appointment'];
}

/**
 * Implements _webform_display_COMPONENT().
 */
function _webform_display_wa_product($component, $values, $format = 'html') {
  if (isset($values['product'])) {
    $values = array($values);
  }

  $client = dvg_appointments_get_client_api();
  $products = $client->get_available_products();
  $display = array();
  foreach ($values as $value) {
    $product = $products[$value['product']];
    if ($format == 'html') {
      $display_value = theme('table', array(
        'rows' => array(
          array(t('Product'), $product['name']),
          array(t('Number of persons'), $value['count']),
        ),
      ));
    }
    else {
      $display_value = t('Product') . ' = ' . $product['name'] . "\n" . t('Number of persons') . ' = ' . $value['count'];
    }

    $display[] = array(
      '#title' => $component['name'],
      '#weight' => $component['weight'],
      '#theme_wrappers' => $format == 'html' ? array('webform_element') : array('webform_element_text'),
      '#post_render' => array('webform_element_wrapper'),
      '#component' => $component,
      '#format' => $format,
      '#markup' => $display_value,
      '#parents' => array(FALSE),
      '#value' => $value,
    );
  }

  if (count($display) == 1) {
    $display = $display[0];
  }

  return $display;
}

/**
 * Implements _webform_display_COMPONENT().
 */
function _webform_display_wa_date_time($component, $value, $format = 'html') {
  return array(
    '#title' => $component['name'],
    '#weight' => $component['weight'],
    '#theme' => 'webform_display_textfield',
    '#theme_wrappers' => $format == 'html' ? array('webform_element') : array('webform_element_text'),
    '#post_render' => array('webform_element_wrapper'),
    '#component' => $component,
    '#format' => $format,
    '#value' => isset($value[0]) ? dvg_appointments_format_date($value[0], 'Y-m-d G:i:s') : '',
  );
}

/**
 * Implements _webform_display_COMPONENT().
 */
function _webform_display_wa_appointment($component, $value, $format = 'html') {
  return array(
    '#title' => $component['name'],
    '#weight' => $component['weight'],
    '#theme' => 'dvg_appointments',
    '#theme_wrappers' => $format == 'html' ? array('webform_element') : array('webform_element_text'),
    '#post_render' => array('webform_element_wrapper'),
    '#component' => $component,
    '#format' => $format,
    '#value' => $value,
  );
}

/**
 * Implements _webform_display_COMPONENT().
 */
function _webform_display_wa_email($component, $value, $format = 'html') {
  return array(
    '#title' => $component['name'],
    '#weight' => $component['weight'],
    '#theme' => 'webform_display_textfield',
    '#theme_wrappers' => $format == 'html' ? array('webform_element') : array('webform_element_text'),
    '#post_render' => array('webform_element_wrapper'),
    '#component' => $component,
    '#format' => $format,
    '#value' => isset($value[0]) ? $value[0] : '',
  );
}

/**
 * Implements _webform_render_COMPONENT().
 */
function _webform_render_wa_product($component, $value = NULL, $filter = TRUE) {
  $form_item = array(
    '#type' => 'wa_product',
    '#title' => $filter ? webform_filter_xss($component['name']) : $component['name'],
    '#required' => $component['required'],
    '#weight' => $component['weight'],
    '#description'   => $filter ? webform_filter_descriptions($component['extra']['description']) : $component['extra']['description'],
    '#default_value' => $filter ? webform_replace_tokens($component['value']) : $component['value'],
    '#prefix' => '<div class="webform-component-textfield" id="webform-component-' . $component['form_key'] . '">',
    '#suffix' => '</div>',
  );

  if (!empty($value)) {
    $form_item['#default_value'] = $value;
  }

  return $form_item;
}

/**
 * Implements _webform_render_COMPONENT().
 */
function _webform_render_wa_date_time($component, $value = NULL, $filter = TRUE) {
  $form_item['wa_date_time'] = array(
    '#type' => 'wa_date_time',
    '#title' => $filter ? webform_filter_xss($component['name']) : $component['name'],
    '#required' => $component['required'],
    '#weight' => $component['weight'],
    '#description'   => $filter ? webform_filter_descriptions($component['extra']['description']) : $component['extra']['description'],
    '#default_value' => $filter ? webform_replace_tokens($component['value']) : $component['value'],
    '#prefix' => '<div class="webform-component-textfield" id="webform-component-' . $component['form_key'] . '">',
    '#suffix' => '</div>',
  );

  if (isset($value) && !empty($value[0])) {
    $form_item['wa_date_time']['#default_value'] = $value[0];
  }

  return $form_item;
}

/**
 * Implements _webform_render_COMPONENT().
 */
function _webform_render_wa_appointment($component, $value = NULL, $filter = TRUE) {
  $form_item['wa_appointment'] = array(
    '#type' => 'wa_appointment',
    '#title' => $filter ? webform_filter_xss($component['name']) : $component['name'],
    '#required' => $component['required'],
    '#weight' => $component['weight'],
    '#description'   => $filter ? webform_filter_descriptions($component['extra']['description']) : $component['extra']['description'],
    '#default_value' => $filter ? webform_replace_tokens($component['value']) : $component['value'],
    '#prefix' => '<div class="webform-component-textfield" id="webform-component-' . $component['form_key'] . '">',
    '#suffix' => '</div>',
  );

  if (isset($value)) {
    $form_item['wa_appointment']['#default_value'] = $value;
  }

  return $form_item;
}

/**
 * Implements _webform_render_COMPONENT().
 */
function _webform_render_wa_email($component, $value = NULL, $filter = TRUE) {
  return array('#type' => 'value');
}

/**
 * Implements hook_webform_submission_presave().
 *
 * Serializes the data of the wa_product component.
 */
function dvg_appointments_webform_submission_presave($node, &$submission) {
  $wa_product = dvg_appointments_get_cid($node, 'wa_product');
  $wa_appointment = dvg_appointments_get_cid($node, 'wa_appointment');
  $wa_email = dvg_appointments_get_cid($node, 'wa_email');

  if ($wa_product) {
    foreach ($submission->data[$wa_product] as $dcid => $data) {
      $submission->data[$wa_product][$dcid] = serialize($data);
    }
  }
  if ($wa_appointment && $wa_email) {
    $submission->data[$wa_email][0] = $submission->data[$wa_appointment]['email'];
  }
}

/**
 * Tie the appointment to a webform submission.
 *
 * Implements hook_webform_submission_insert().
 */
function dvg_appointments_webform_submission_insert($node, $submission) {
  if ($wa_product = dvg_appointments_get_cid($node, 'wa_product')) {
    $data = unserialize($submission->data[$wa_product]['appointments']);
    /** @var DvGAppointment $appointment */
    $appointment = $data['appointment'];
    $appointment->setNodeId($submission->nid);
    $appointment->setSubmissionId($submission->sid);
    dvg_appointments_store_appointment($appointment);
  }
}

/**
 * Save an appointment.
 *
 * Updates the appointment when it has a local id, inserts otherwise.
 *
 * @param \DvgAppointment $appointment
 *   The appointment.
 */
function dvg_appointments_store_appointment(DvgAppointment $appointment) {
  $UTC = new DateTimeZone('UTC');

  $start = clone $appointment->getStart();
  $end = clone $appointment->getEnd();

  $record = (object) array(
    'nid' => $appointment->getNodeId(),
    'sid' => $appointment->getSubmissionId(),
    'id' => $appointment->getId(),
    'appointment_start' => $start->setTimezone($UTC)->format('Y-m-d H:i:s'),
    'appointment_end' => $end->setTimezone($UTC)->format('Y-m-d H:i:s'),
  );

  $keys = array();
  if ($appointment->getId()) {
    $keys = array('id');
  }

  if (drupal_write_record('dvg_appointments_appointments', $record, $keys) == SAVED_NEW) {
    $appointment->setId($record->id);
  }
  else if (count($keys)) {
    db_delete('dvg_appointments_products')
      ->condition('local_id', $appointment->getId())
      ->execute();
    db_delete('dvg_appointments_remote_ids')
      ->condition('local_id', $appointment->getId())
      ->execute();
  }

  foreach ($appointment->getRemoteAppointmentIds() as $remote_id) {
    $record = (object) array(
      'local_id' => $appointment->getId(),
      'remote_id' => $remote_id,
    );
    drupal_write_record('dvg_appointments_remote_ids', $record);
  }

  foreach ($appointment->getProductIds() as $product_id) {
    $record = (object) array(
      'local_id' => $appointment->getId(),
      'product' => $product_id,
      'count' => $appointment->getProductCount($product_id),
      'duration' => $appointment->getProductDuration($product_id),
    );
    drupal_write_record('dvg_appointments_products', $record);
  }
}

/**
 * Load an appointment.
 *
 * @param int $id
 *   Local id of the appointment to load.
 *
 * @return bool|\DvgAppointment
 *   FALSE if not found a DvgAppointment otherwise.
 */
function dvg_appointments_load_appointment($id) {
  $appointment = FALSE;
  $result = db_query('SELECT id, nid, sid, appointment_start, appointment_end FROM {dvg_appointments_appointments} WHERE id = :id', array(':id' => $id))
    ->fetch();
  if ($result) {
    $appointment = new DvgAppointment();

    $appointment->setId($result->id);
    $appointment->setNodeId($result->nid);
    $appointment->setSubmissionId($result->sid);

    $UTC = new DateTimeZone('UTC');
    $appointment->setStart(DateTime::createFromFormat('Y-m-d?H:i:s', $result->appointment_start, $UTC));
    $appointment->setEnd(DateTime::createFromFormat('Y-m-d?H:i:s', $result->appointment_end, $UTC));
    // Add remotes.
    $remotes = db_query('SELECT remote_id FROM {dvg_appointments_remote_ids} WHERE local_id = :id', array(
      ':id' => $id,
    ));
    foreach ($remotes as $remote) {
      $appointment->addRemoteAppointmentId($remote->remote_id);
    }
    // Add products.
    $products = db_query('SELECT product, count, duration FROM {dvg_appointments_products} WHERE local_id = :id', array(
      ':id' => $id,
    ));
    foreach ($products as $product) {
      $appointment->addProduct($product->product, $product->count, $product->duration);
    }
  }
  return $appointment;
}

/**
 * Delete a local appointment.
 *
 * @param int $id
 *   The local appointment id.
 */
function dvg_appointments_delete_appointment($id) {
  db_delete('dvg_appointments_products')
    ->condition('local_id', $id)
    ->execute();
  db_delete('dvg_appointments_remote_ids')
    ->condition('local_id', $id)
    ->execute();
  db_delete('dvg_appointments_appointments')
    ->condition('id', $id)
    ->execute();
}


/**
 * Implements hook_webform_submission_load().
 *
 * Unserializes the data of the wa_product component.
 */
function dvg_appointments_webform_submission_load(&$submissions) {
  foreach ($submissions as $submission) {
    $node = node_load($submission->nid);
    if (!$node) {
      continue;
    }

    foreach ($node->webform['components'] as $cid => $component) {
      if ($component['type'] == 'wa_product' && !empty($submission->data[$cid])) {
        foreach ($submission->data[$cid] as $dcid => $data) {
          $submission->data[$cid][$dcid] = unserialize($data);
        }
      }
      if ($component['type'] == 'wa_appointment' && !empty($submission->data[$cid])) {
        $submission->data[$cid]['appointment'] = unserialize($submission->data[$cid]['appointment']);
      }
    }
  }
}

/**
 * Implements hook_field_info().
 */
function dvg_appointments_field_info() {
  return array(
    'wa_product' => array(
      'label' => 'Appointment product',
      'description' => 'add todo', // todo description
      'default_widget' => 'wa_product',
      'default_formatter' => 'wa_product', // todo
      'default_token_formatter' => 'wa_product', // todo
    ),
    'wa_date_time' => array(
      'label' => 'Appointment date/time',
      'description' => 'add todo', // todo description
      'default_widget' => 'wa_date_time',
      'default_formatter' => 'wa_date_time', // todo
      'default_token_formatter' => 'wa_date_time', // todo
    ),
    'wa_appointment' => array(
      'label' => 'Appointment date/time',
      'description' => 'add todo', // todo description
      'default_widget' => 'wa_appointment',
      'default_formatter' => 'wa_appointment', // todo
      'default_token_formatter' => 'wa_appointment', // todo
    ),
  );
}

/**
 * Implements hook_field_widget_info().
 */
function dvg_appointments_field_widget_info() {
  return array(
    'wa_product' => array(
      'label' =>  t('Appointment product'),
      'field types' => array('wa_product'),
      'settings' => array(),
      'behaviors' => array(
        'multiple values' => FIELD_BEHAVIOR_DEFAULT,
        'default value' => FIELD_BEHAVIOR_NONE,
      ),
    ),
    'wa_date_time' => array(
      'label' =>  t('Appointment date/time'),
      'field types' => array('wa_date_time'),
      'settings' => array(),
      'behaviors' => array(
        'multiple values' => FIELD_BEHAVIOR_DEFAULT,
        'default value' => FIELD_BEHAVIOR_NONE,
      ),
    ),
    'wa_appointment' => array(
      'label' =>  t('Appointment'),
      'field types' => array('wa_appointment'),
      'settings' => array(),
      'behaviors' => array(
        'multiple values' => FIELD_BEHAVIOR_DEFAULT,
        'default value' => FIELD_BEHAVIOR_NONE,
      ),
    ),
  );
}

/**
 * Implements hook_element_info().
 */
function dvg_appointments_element_info() {
  return array(
    'wa_product' => array(
      '#input' => TRUE,
      '#delta' => 0,
      '#columns' => array('product', 'count'),
      '#process' => array('dvg_appointments_product_element_process'),
      '#element_validate' => array('dvg_appointments_product_element_validate'),
      '#theme_wrappers' => array('dvg_appointments_product'),
    ),
    'wa_date_time' => array(
      '#input' => TRUE,
      '#delta' => 0,
      '#process' => array('dvg_appointments_date_time_element_process'),
      '#element_validate' => array('dvg_appointments_date_time_element_validate'),
      '#theme_wrappers' => array('dvg_appointments_date_time'),
    ),
    'wa_appointment' => array(
      '#input' => TRUE,
      '#delta' => 0,
      '#process' => array('dvg_appointments_load_element_process'),
      '#element_validate' => array('dvg_appointments_load_element_validate'),
    ),
  );
}

/**
 * Element process callback for the wa_product elements.
 */
function dvg_appointments_product_element_process($element, &$form_state, $form) {
  $client = dvg_appointments_get_client_api();
  $product_options = array('' => t('Select a product'));
  foreach ($client->get_available_products() as $product) {
    $product_options[$product['id']] = $product['name'];
  }

  $element['product'] = array(
    '#type' => 'select',
    '#title' => t('Product'),
    '#required' => TRUE,
    '#options' => $product_options,
  );

  if (!empty($element['#default_value']['product'])) {
    $element['product']['#default_value'] = $element['#default_value']['product'];
  }
  elseif (isset($_GET['product_code']) && isset($product_options[$_GET['product_code']])) {
    $element['product']['#default_value'] = $_GET['product_code'];
  }

  $element['count'] = array(
    '#type' => 'textfield',
    '#title' => t('Number of persons'),
    '#required' => TRUE,
    '#size' => 4,
    '#maxlength' => 4,
    '#default_value' => !empty($element['#default_value']['count']) ? $element['#default_value']['count'] : 1,
    '#element_validate' => array('element_validate_integer_positive', '_dvg_appointments_element_validate_person_count'),
  );

  return $element;
}

/**
 * Form element validation handler for a maximum person count.
 */
function _dvg_appointments_element_validate_person_count($element, &$form_state) {
  $max_persons = 10;
  $value = $element['#value'];
  if ($value !== '' && is_numeric($value) && (int)$value > $max_persons) {
    form_error($element, t('%name has a maximum of %max_persons.', array('%name' => $element['#title'], '%max_persons' => $max_persons)));
  }
}

/**
 * Helper for formatting dates and times in the Appointments module.
 */
function dvg_appointments_format_date($time, $type, $format = '') {
  $api_client = dvg_appointments_get_client_api();

  switch ($type) {
    case 'time':
      $date_formatted = format_date($time, 'custom', 'H:i', $api_client->get_timezone());
      break;
    case 'date':
      $date_formatted = format_date($time, 'custom', 'd-m-Y', $api_client->get_timezone());
      break;
    case 'day_date':
      $date_formatted = format_date($time, 'custom', 'l, j F Y', $api_client->get_timezone());
      break;
    case 'year':
      $date_formatted = format_date($time, 'custom', 'Y', $api_client->get_timezone());
      break;
    default:
      $date_formatted = format_date($time, $type, $format, $api_client->get_timezone());
      break;
  }

  return $date_formatted;
}

/**
 * Helper for formatting dates and times in the Appointments module.
 */
function dvg_appointments_format_date_for_display($time, $type, $format = '') {
  $api_client = dvg_appointments_get_client_api();

  switch ($type) {
    case 'time':
      $date_formatted = format_date($time, 'custom', 'H:i');
      break;
    case 'date':
      $date_formatted = format_date($time, 'custom', 'd-m-Y');
      break;
    case 'day_date':
      $date_formatted = format_date($time, 'custom', 'l, j F Y');
      break;
    case 'year':
      $date_formatted = format_date($time, 'custom', 'Y');
      break;
    default:
      $date_formatted = format_date($time, $type, $format);
      break;
  }

  return $date_formatted;
}

/**
 * Helper function that fetches the selected products from the form_state.
 */
function dvg_appointments_get_selected_products($form_state, $form) {
  $client_api = dvg_appointments_get_client_api();
  $products = array();

  $cid = dvg_appointments_get_cid($form['#node'], 'wa_product');
  if ($cid && !empty($form_state['storage']['submitted'][$cid])) {
    $available_products = $client_api->get_available_products();
    foreach ($form_state['storage']['submitted'][$cid] as $value) {
      if (isset($value['product']) && !empty($value['product'])) {
        $products[] = $available_products[$value['product']] + array('count' => $value['count']);
      }
    }
    return $products;
  }

  return array();
}

/**
 * Helper function that fetches the selected products from the form_state.
 */
function dvg_appointments_get_selected_slot($form_state, $form) {
  $cid = dvg_appointments_get_cid($form['#node'], 'wa_date_time');
  if ($cid && !empty($form_state['storage']['submitted'][$cid][0])) {
    return $form_state['storage']['submitted'][$cid][0];
  }

  return FALSE;
}

/**
 * Element process callback for the wa_date_time elements.
 */
function dvg_appointments_date_time_element_process($element, &$form_state, $form) {
  $client_api = dvg_appointments_get_client_api();
  $selected_products = dvg_appointments_get_selected_products($form_state, $form);

  $product_link_ids = $product_names = $products_durations = $persons = array();
  foreach ($selected_products as $selected_product) {
    $product_id = $selected_product['id'];

    $product_link_ids[] = $product_id;
    $product_names[] = '<strong>' . check_plain($selected_product['name']) . '</strong>';
    $persons[$product_id] = $selected_product['count'];
    $total_product_duration = $selected_product['duration'] * $selected_product['count'];
    $products_durations[$product_id] = $total_product_duration;

    $rows[] = array(
      'product_name' => $selected_product['name'],
      'duration' => $total_product_duration,
    );
  }

  $last_product = array_pop($product_names);
  $product_text = $product_names ? implode(', ', $product_names) . ' ' . t('and') . ' ' . $last_product : $last_product;
  $total_duration = array_sum($products_durations);

  $output_info = '<p>' . t('You are booking an appointment for !product_text. This appointment takes about <strong>@total_duration minutes</strong>.', array(
    '!product_text' => $product_text,
    '@total_duration' => $total_duration,
  )) . '</p>';

  $element['header'] = array(
    '#markup' => '<h2>' . t("Choose a date and time") . '</h2>' . $output_info,
  );

  $dates_all = $client_api->get_dates_times($product_link_ids, $products_durations, $persons);
  $dates = array();
  foreach ($dates_all as $unic_id => $date_array) {
    if ($unic_id == 0 || $date_array[0]['date'] != $dates_all[$unic_id - 1][0]['date']) {
      $dates[$date_array[0]['date']] = array();
    }
    $dates[$date_array[0]['date']][$unic_id] = $date_array[0]['time'];
  }
  ksort($dates);

  $full_date = $element['slots'] = array();
  foreach ($dates as $date => $time_array) {
    $unix_date = strtotime($date);
    $morning_time = array();
    $midday_time = array();
    $evening_time = array();
    $full_time = array();

    $options = array('' => t('-- Select time --'));

    foreach ($time_array as $time) {
      $unix_time = strtotime($time);

      $timezone = new DateTimeZone($client_api->get_timezone() ? $client_api->get_timezone() : drupal_get_user_timezone());
      $date = new DateTime('1970-01-01 12:00', $timezone);
      $midday = $date->getTimestamp();

      $date = new DateTime('1970-01-01 17:00', $timezone);
      $evening = $date->getTimestamp();

      $index = $unix_time;
      if ($unix_time < $unix_date) {
        $index += $unix_date;
      }
      if ($unix_time < $midday) {
        $morning_time[$index] = dvg_appointments_format_date($unix_time, 'time');
      }
      elseif ($unix_time < $evening) {
        $midday_time[$index] = dvg_appointments_format_date($unix_time, 'time');
      }
      else {
        $evening_time[$index] = dvg_appointments_format_date($unix_time, 'time');
      }

      if (!empty($morning_time)) {
        $full_time['morning'] = TRUE;
        $options[t('Morning')] = $morning_time;
      }
      if (!empty($midday_time)) {
        $full_time['midday'] = TRUE;
        $options[t('Midday')] = $midday_time;
      }
      if (!empty($evening_time)) {
        $full_time['evening'] = TRUE;
        $options[t('Evening')] = $evening_time;
      }
    }

    $element['slots'][] = array(
      '#title' => t('Time'),
      '#title_display' => 'invisible',
      '#type' => 'select',
      '#options' => $options,
      '#default_value' => $element['#default_value'],
    );

    $full_date[] = array(
      'date' => $unix_date,
      'date_time' => $full_time,
    );
  }

  $element['appointments_full_date'] = array(
    '#type' => 'value',
    '#value' => $full_date,
  );

  return $element;
}

/**
 * Element process callback for the wa_appointment elements.
 */
function dvg_appointments_load_element_process($element, &$form_state, $form) {
  $element['appointment_id'] = array(
    '#type' => 'textfield',
    '#title' => t('Appointment id'),
    '#required' => TRUE,
    '#default_value' => isset($element['#default_value']['appointment_id']) ? $element['#default_value']['appointment_id'] : '',
  );

  $element['email'] = array(
    '#type' => 'textfield',
    '#title' => t('Email address'),
    '#required' => TRUE,
    '#default_value' => isset($element['#default_value']['email']) ? $element['#default_value']['email'] : '',
  );

  return $element;
}

/**
 * Element validate callback for the wa_product elements.
 */
function dvg_appointments_product_element_validate($element, &$form_state) {
  $clash_found = FALSE;
  $products = array();
  $form_key = $element['#webform_component']['form_key'];

  if (module_exists('wfm') && _wfm_is_multiple($element['#webform_component']) && !empty($form_state['values']['submitted'][$form_key])) {
    foreach ($form_state['values']['submitted'][$form_key] as $index => $product) {
      if (isset($product['product']) && !empty($product['product'])) {
        if (isset($products[$product['product']])) {
          $clash_found = TRUE;
        }
        $products[$product['product']] = $product;
      }
    }
    if ($clash_found) {
      form_error($element['product'], t('Product must be unique'));
    }
  }
}

/**
 * Helper to set the error state on all slots.
 */
function _dvg_appointments_date_time_error(&$element, $message, $ignore_value = TRUE) {
  form_set_error('wa_date_time', $message);

  foreach (element_children($element['slots']) as $child) {
    $slot = $element['slots'][$child];

    if (!empty($slot['#value']) || $ignore_value) {
      form_error($element['slots'][$child]);
    }
  }
}

/**
 * Element validate callback for the wa_date_time elements.
 */
function dvg_appointments_date_time_element_validate($element, &$form_state) {
  if (end($form_state['clicked_button']['#parents']) == 'previous') {
    return;
  }

  $slots = array();
  foreach ($element['slots'] as $index => $slot) {
    if (isset($slot['#value'])) {
      if (is_numeric($slot['#value'])) {
        $slots[$index] = $slot['#value'];
      }
    }
  }

  // Validate, and set errors.
  $slot_count = count($slots);
  if (!$slot_count) {
    _dvg_appointments_date_time_error($element, t('No time selected.'));
  }
  elseif ($slot_count > 1) {
    _dvg_appointments_date_time_error($element, t('Only one selection possible.'), FALSE);
  }

  // Set the selected values as element value.
  drupal_array_set_nested_value($form_state['values'], $element['#array_parents'], array_values($slots));
}

function dvg_appointments_load_element_validate($element, &$form_state) {
  if (!valid_email_address($element['email']['#value'])) {
    form_error($element['email'], t('Invalid e-mail address.'));
  }

  // Flood control.
  $threshold = variable_get('dvg_appointments_flood_threshold', FALSE);
  $timeout = variable_get('dvg_appointments_flood_timeout', 15) * 60;
  if ($threshold) {
    if (!flood_is_allowed('dvg_appointments_cancel', $threshold, $timeout)) {
      form_error($element['appointment_id'], t('Too many failed attempts. Please try again later.'));
      return;
    }
  }

  // Don't check the appointment if there are already errors present.
  if (form_get_errors()) {
    return;
  }


  $appointment = dvg_appointments_load_appointment($element['appointment_id']['#value']);

  $client_api = dvg_appointments_get_client_api();

  $remote_appointment = FALSE;

  if ($appointment) {
    $remote_ids = $appointment->getRemoteAppointmentIds();
    $remote_id = current($remote_ids);

    // Validate email in one of the remote appointments.
    $remote_appointment = $client_api->get_customer_appointments(array(
      'email' => $element['email']['#value'],
      'appointment_id' => $remote_id,
    ));
  }

  if (!$remote_appointment) {
    form_error($element['appointment_id'], t('There are no appointment with this ID or the entered email is not correct.'));

    // Flood control.
    if ($threshold) {
      flood_register_event('dvg_appointments_cancel', $timeout);
    }
  }
  else {
    drupal_array_set_nested_value($form_state['values'], $element['#array_parents'], array(
      'appointment_id' => $element['appointment_id']['#value'],
      'email' => $element['email']['#value'],
      'appointment' => serialize($appointment),
    ));
  }
}

/**
 * Implements hook_theme().
 */
function dvg_appointments_theme() {
  return array(
    'dvg_appointments_product' => array(
      'render element' => 'element',
    ),
    'dvg_appointments_date_time' => array(
      'render element' => 'element',
    ),
    'dvg_appointments' => array(
      'render element' => 'element',
    ),
  );
}

/**
 * Returns HTML for the product/count fields on form.
 */
function theme_dvg_appointments_product($variables) {
  $element = $variables['element'];

  // Group start/end items together in fieldset.
  $fieldset = array(
    '#title' => t($element['#title']) . ' ' . ($element['#delta'] > 0 ? intval($element['#delta'] + 1) : ''),
    '#value' => '',
    '#description' => !empty($element['#fieldset_description']) ? $element['#fieldset_description'] : '',
    '#attributes' => array(),
    '#children' => $element['#children'],
  );

  // Add marker to required date fields.
  if ($element['#required']) {
    $fieldset['#title'] .= ' ' . theme('form_required_marker');
  }

  return theme('fieldset', array('element' => $fieldset));
}

/**
 * Returns HTML for a start/end date combination on form.
 */
function theme_dvg_appointments_date_time($variables) {
  $output = render($variables['element']['header']);
  $slots = $variables['element']['slots'];
  $appointments_full_date = $variables['element']['appointments_full_date'];

  $day_parts = array(
    'morning' => t('Morning'),
    'midday' => t('Midday'),
    'evening' => t('Evening'),
  );

  if (isset($appointments_full_date['#value']) && !empty($appointments_full_date['#value'])) {
    $table_data = array(
      'header' => array(
        array('data' => t('Date')),
        array('data' => $day_parts['morning']),
        array('data' => $day_parts['midday']),
        array('data' => $day_parts['evening']),
        array('data' => '<span class="element-invisible">' . t('Time') . '</span>'),
      ),
      'rows' => array(),
      'attributes' => array(
        'class' => array('appointments-date-selection-table'),
      ),
      'sticky' => FALSE,
    );

    foreach ($appointments_full_date['#value'] as $index => $date) {
      $table_row = array();

      $table_row[] = array(
        'data' => drupal_ucfirst(dvg_appointments_format_date($date['date'], 'day_date')),
        'class' => 'date',
        'header' => TRUE,
      );

      foreach ($day_parts as $day_part_key => $day_part_label) {
        $day_part_available = isset($date['date_time'][$day_part_key]) ? TRUE : FALSE;
        $image_class = $day_part_available ? 'available' : 'unavailable';
        $day_part_prefix = '<span class="day-part-label">' . $day_part_label . '</span>';
        $day_part_status = array(
          TRUE => array(
            'icon' => 'icon-tick.png',
            'alt' => t('available'),
          ),
          FALSE => array(
            'icon' => 'icon-cross.png',
            'alt' => t('unavailable'),
          ),
        );
        $image = array(
          'path' => drupal_get_path('module', 'appointments') . '/images/' . $day_part_status[$day_part_available]['icon'],
          'alt' => $day_part_status[$day_part_available]['alt'],
        );
        $day_part_image = '<span class="day-part-image ' . $image_class . '">' . theme('image', $image) . '</span>';
        $day_part_content = '<div class="day-part">' . $day_part_prefix . ' ' . $day_part_image . '</div>';
        $table_row[] = array(
          'data' => $day_part_content,
          'class' => array('time-appointments', $day_part_key)
        );
      }

      $table_row[] = array('data' => render($slots[$index]), 'class' => 'time-selector-appointments');

      $table_data['rows'][] = $table_row;
    }

    $output .= theme('table', $table_data);
  }
  else {
    $markup = array(
      '#markup' => t('No suitable date and time for this request. Please register appointments separately.'),
      '#prefix' => '<div class="time_error_step2">',
      '#suffix' => '</div>',
      '#weight' => 4,
    );
    $output .= render($markup);
  }

  return $output;
}

/**
 * Theming function for info table.
 */
function theme_dvg_appointments($variables) {
  $appointment = $variables['element']['#value']['appointment'];
  if (is_string($appointment)) {
    $appointment = unserialize($appointment);
  }
  return _dvg_appointments_table($appointment);
}

/**
 * Helper function for loading the Task node by product code.
 */
function _dvg_appointments_get_task_by_product_code($product_code) {
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', 'task')
    ->propertyCondition('status', 1)
    ->propertyOrderBy('created', 'ASC')
    ->fieldCondition('field_product_code_appointment', 'value', $product_code)
    ->range(0, 1);
  $result = $query->execute();
  if (isset($result['node'])) {
    $nids = array_keys($result['node']);
    return node_load(reset($nids));
  }

  return FALSE;
}

/**
 * Helper function that generates a table of an appointment.
 */
function _dvg_appointments_table(DvgAppointment $appointment, $table = TRUE) {
  $start_time = $appointment->getStart()->format('U');
  $end_time = $appointment->getEnd()->format('U');

  $product_rows = array();

  $count = 0;
  $product_ids = $appointment->getProductIds();
  foreach ($product_ids as $product_id) {
    $count++;
    if ($count == 1) {
      $product_rows[] = array(
        array(
          'rowspan' => count($product_ids),
          'class' => array('info-label'),
          'data' => $count == 1 ? t('Subject') : '',
        ),
        $appointment->getProductCount($product_id) . 'x ' . check_plain(dvg_appointments_get_product_name($product_id)),
      );
    }
    else {
      $product_rows[] = array(
        $appointment->getProductCount($product_id) . 'x ' . check_plain(dvg_appointments_get_product_name($product_id)),
      );
    }
  }

  $additional_rows = array(
    array(
      array('class' => array('info-label'), 'data' => t('Date')),
      drupal_ucfirst(dvg_appointments_format_date_for_display($start_time, 'day_date')),
    ),
    array(
      array('class' => array('info-label', 'time'), 'data' => t('Time')),
      t('@start till @end', array(
        '@start' => dvg_appointments_format_date_for_display($start_time, 'time'),
        '@end' => dvg_appointments_format_date_for_display($end_time, 'time'),
      )),
    ),
  );

  $rows = array_merge($product_rows, $additional_rows);

  if ($appointment->getId()) {
    $rows[] = array(
      array('class' => array('info-label'), 'data' => t('Appointment id')),
      check_plain($appointment->getId()),
    );
  }

  if ($table) {
    return theme('table', array('rows' => $rows, 'attributes' => array('class' => array('appointments-info-table'))));
  }
  else {
    $output = array();
    foreach ($rows as $row) {
      $output[] = t('!label: !value', array(
        '!label' => is_array($row[0]) ? $row[0]['data'] : $row[0],
        '!value' => is_array($row[1]) ? $row[1]['data'] : $row[1],
      ));
    }
    return implode("\n", $output) . "\n&nbsp;";
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function dvg_appointments_form_webform_client_form_alter(&$form, &$form_state) {
  $node = $form['#node'];
  $nid = $node->nid;
  $is_app_create = _dvg_appointments_is_appointment($nid, 'create');
  $is_app_cancel = _dvg_appointments_is_appointment($nid, 'cancel');
  $preview_enabled = $form['#node']->webform['preview'];
  $last_page = $form_state['webform']['page_num'] == $form_state['webform']['page_count'];

  if ($is_app_create) {
    $form['#attributes']['class'][] = 'appointment-webform';

    $wa_products = dvg_appointments_get_selected_products($form_state, $form);

    if ($wa_products && $last_page) {
      $form['#validate'][] = 'dvg_appointments_book_appointment';
    }

    $wa_product = dvg_appointments_get_cid($form['#node'], 'wa_product');
    if ($wa_product && $form_state['webform']['page_num'] == $node->webform['components'][$wa_product]['page_num']) {
      $form['#validate'][] = 'dvg_appointments_validate_available_date_time';
    }

    if ($wa_products && $preview_enabled && $last_page) {
      $start_time = dvg_appointments_get_selected_slot($form_state, $form);
      $product_tables = array();
      $fake_appointment = new DvgAppointment();
      $fake_appointment->setStart(DateTime::createfromformat('U', $start_time));
      foreach ($wa_products as $product) {
        $fake_appointment->addProduct($product['id'], $product['count'], $product['duration'] * 60);
      }

      $duration = $fake_appointment->getAppointmentDurationEstimate();
      $fake_appointment->setEnd(DateTime::createfromformat('U', $start_time + $duration));
      $product_tables[] = _dvg_appointments_table($fake_appointment);

      $form['wa_product'] = array(
        '#weight' => -10,
        '#markup' => '<h2>' . t('Check and confirm your appointment(s)') . '</h2>' . implode("\n", $product_tables),
      );
      unset($form['preview_message']);

      $rows = array();
      foreach (element_children($form['preview']) as $preview) {
        if (!isset($form['preview'][$preview]['#title'])) {
          continue;
        }
        $title = $form['preview'][$preview]['#title'];
        $form['preview'][$preview]['#title'] = '';
        $form['preview'][$preview]['#theme_wrappers'] = array();
        $value = render($form['preview'][$preview]);
        if (trim(strip_tags($value)) != '') {
          $rows[] = array(
            array('class' => 'info-label', 'data' => check_plain($title)),
            $value,
          );
        }
      }

      if (!empty($rows)) {
        $form['wa_preview_values'] = array(
          '#markup' => '<h2>' . t('Your information') . '</h2>' . theme('table', array('rows' => $rows, 'attributes' => array('class' => array('appointments-info-table')))),
        );
      }
    }
  }

  if ($is_app_cancel) {
    $form['#attributes']['class'][] = 'appointment-webform';

    $wa_appointment = dvg_appointments_get_cid($form['#node'], 'wa_appointment');
    if ($wa_appointment && $last_page) {
      $form['#validate'][] = 'dvg_appointments_cancel_appointment';
      $form['#submit'][] = 'dvg_appointments_webform_cancel_submit';
      if ($preview_enabled) {
        unset($form['preview_message']);
      }
    }
  }
}

/**
 * Validation handler that checks available times for the selected product(s).
 */
function dvg_appointments_validate_available_date_time(&$form, &$form_state) {
  // Only validate when the next-button is pressed.
  if ($form['actions']['next']['#value'] != $form_state['triggering_element']['#value']) {
    return;
  }

  if (!form_get_errors()) {
    $client_api = dvg_appointments_get_client_api();

    $cid = dvg_appointments_get_cid($form['#node'], 'wa_product');
    $form_key = $form['#node']->webform['components'][$cid]['form_key'];
    $products = array();
    if (isset($form_state['values'])) {
      foreach ($form_state['values']['submitted'][$form_key] as $key => $value) {
        if (is_numeric($key) && is_array($value)) {
          $products[] = $value;
        }
      }
    }

    $form_state['storage']['submitted'][$cid] = $products;
    $selected_products = dvg_appointments_get_selected_products($form_state, $form);

    $product_link_ids = $products_durations = $persons = array();
    foreach ($selected_products as $selected_product) {
      $product_id = $selected_product['id'];

      $product_link_ids[] = $product_id;
      $persons[$product_id] = $selected_product['count'];
      $total_product_duration = $selected_product['duration'] * $selected_product['count'];
      $products_durations[$product_id] = $total_product_duration;
    }
    $dates_all = $client_api->get_dates_times($product_link_ids, $products_durations, $persons);
    if (empty($dates_all)) {
      form_set_error('wa_product', t('No suitable date and time for this request. Please register appointments separately.'));
    }
  }
}

/**
 * Validation handler for webforms.
 */
function dvg_appointments_book_appointment(&$form, &$form_state) {
  $node = $form['#node'];
  $client_api = dvg_appointments_get_client_api();
  $mapping = unserialize($node->webform['appointment_mapping']);
  $products = dvg_appointments_get_selected_products($form_state, $form);
  $start_time = dvg_appointments_get_selected_slot($form_state, $form);
  $wa_product = dvg_appointments_get_cid($node, 'wa_product');

  $book_data = array();
  foreach ($mapping as $field => $cid) {
    $book_data[$field] = '';
    if (isset($form_state['storage']['submitted'][$cid])) {
      $book_data[$field] = $client_api->set_booking_value($field, $form_state['storage']['submitted'][$cid]);
    }
  }

  foreach ($products as $idx => $product) {
    $products[$idx]['confirm_text'] = _dvg_appointments_get_task_confirm_text_by_product_code($product['id']);
  }

  $app_data = array(
    'datetime' => $start_time,
    'products' => $products,
  );

  try {
    $booked_appointment = $client_api->book_appointment($app_data, $book_data);

    // Store the appointment to make sure it already has a local id
    // in the webform submission data. dvg_appointments_submission_insert
    // will update nid and sid.
    dvg_appointments_store_appointment($booked_appointment);

    $apps = array(
      'app_data' => $app_data,
      'book_data' => $book_data,
      'appointment' => $booked_appointment,
    );

    $form_state['storage']['submitted'][$wa_product]['appointments'] = $apps;
  } catch (Exception $e) {
    switch ($e->getCode()) {
      case DVG_APPOINTMENTS_ERRORCODE_DATE_TIME:
        drupal_set_message(t('The selected time slot isn\'t available anymore. Please select an other date or time.'), 'error');

        // Redirect the user to the page with the wa_date_time component.
        $cid = dvg_appointments_get_cid($node, 'wa_date_time');
        unset($form_state['storage']['submitted'][$cid]);
        $form_state['storage']['page_num'] = $node->webform['components'][$cid]['page_num'];

        // Rebuild the form.
        $form_state['rebuild'] = TRUE;
        break;

      default:
        form_set_error('appointments', t('An unknown error occurred while booking your appointment. Please try again later.'));
    }

  }
}

/**
 * Validation handler for webforms.
 */
function dvg_appointments_cancel_appointment(&$form, &$form_state) {
  $cid = dvg_appointments_get_cid($form['#node'], 'wa_appointment');

  $appointment = unserialize($form_state['storage']['submitted'][$cid]['appointment']);

  $client_api = dvg_appointments_get_client_api();

  if (!$client_api->delete_appointment($appointment)) {
    form_set_error('wa_appointment', t('Unable to cancel the appointment, please try again later.'));
  }

  $form_state['values']['appointment'] = $appointment;
}

/**
 * Submit handler for canceling appointments.
 */
function dvg_appointments_webform_cancel_submit(&$form, &$form_state) {
  $appointment = $form_state['values']['appointment'];
  // Delete the submission tied to the appointment. This will also delete
  // the local appointment.
  if ($appointment) {
    $node = node_load($appointment->getNodeId());
    $submission = webform_get_submission($appointment->getNodeId(), $appointment->getSubmissionId());
    webform_submission_delete($node, $submission);
  }
}

/**
 * Implements hook_webform_submission_delete().
 */
function dvg_appointments_webform_submission_delete($node, $submission) {
  if ($appointment = dvg_appointments_get_appointments($node->nid, $submission->sid)) {
    dvg_appointments_delete_appointment($appointment->getId());
  }
}

/**
 * Helper function that gets the component id of a component type.
 */
function dvg_appointments_get_cid($node, $component_type) {
  foreach ($node->webform['components'] as $cid => $component) {
    if ($component['type'] == $component_type) {
      return $cid;
    }
  }

  return FALSE;
}

/**
 * Helper function that gets the submission appointments from db.
 */
function dvg_appointments_get_appointments($nid, $sid) {
  $appointment = FALSE;

  $id = db_query("SELECT id FROM {dvg_appointments_appointments} WHERE nid = :nid AND sid = :sid", array(
    ':nid' => $nid,
    ':sid' => $sid,
  ))->fetchField();

  if ($id) {
    $appointment = dvg_appointments_load_appointment($id);
  }
  return $appointment;
}

/**
 * Helper function that renders additional confirmation text for the products.
 */
function _dvg_appointments_get_task_confirm_text_by_product_code($product_code) {
  if ($task = _dvg_appointments_get_task_by_product_code($product_code)) {
    $field_confirm_appointment = field_get_items('node', $task, 'field_confirm_appointment', $task->language);
    if (!empty($field_confirm_appointment)) {
      $markup = array(
        '#markup' => check_markup($field_confirm_appointment[0]['value'], $field_confirm_appointment[0]['format']),
        '#prefix' => '<div class="appointments-confirmation-text">',
        '#suffix' => '</div>',
      );
      return render($markup);
    }
  }

  return '';
}


/**
 * @param DvgAppointment $appointment
 *   The appointment.
 * @param bool $html
 *   Whether to generate HTML (TRUE) or text (FALSE).
 *
 * @return string
 *   Rendered output.
 */
function _dvg_appointments_create_info($appointment, $html = TRUE) {
  $confirm_text = $appointment_tables = $output = array();

  $markup = array(
    '#markup' => _dvg_appointments_table($appointment),
    '#prefix' => '<div class="appointments-info-table-container">',
    '#suffix' => '</div>',
  );
  $output[] = render($markup);


  foreach ($appointment->getProductIds() as $product_id) {
    $confirm_text[] = _dvg_appointments_get_task_confirm_text_by_product_code($product_id);
  }

  $output[] = implode('<br />', $confirm_text);

  $output = implode("\n", $output);

  return ($html) ? $output : drupal_html_to_text($output);
}

/**
 * Implements template_preprocess_webform_confirmation().
 *
 * Add the appointment info to the confirmation message.
 */
function dvg_appointments_preprocess_webform_confirmation(&$vars) {
  $nid = $vars['node']->nid;
  $is_app_create = _dvg_appointments_is_appointment($nid, 'create');
  $is_app_cancel = _dvg_appointments_is_appointment($nid, 'cancel');

  // Appointment created.
  if ($is_app_create) {
    $vars['confirmation_message'] .= _dvg_appointments_create_info(dvg_appointments_get_appointments($vars['node']->nid, $vars['sid']));
  }

  // Appointment canceled.
  elseif ($is_app_cancel) {
    $wa_appointment_cid = dvg_appointments_get_cid($vars['node'], 'wa_appointment');
    if ($wa_appointment_cid) {
      $submission = webform_get_submission($vars['node']->nid, $vars['sid']);
      $appointment = $submission->data[$wa_appointment_cid]['appointment'];

      $markup = array(
        '#markup' => _dvg_appointments_table($appointment),
      );
      $vars['confirmation_message'] .= render($markup);
    }
  }
}

/**
 *  Implements hook_form_alter().
 */
function dvg_appointments_form_webform_component_edit_form_alter(&$form, &$form_state) {
  $components = dvg_appointments_webform_component_info();
  if (isset($components[$form['type']['#value']]) && isset($form['encryption']) && module_exists('webform_encrypt')) {
    $form['encryption']['#access'] = FALSE;
    $form['encryption']['encrypt']['#default_value'] = 0;
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function dvg_appointments_form_webform_configure_form_alter(&$form, &$form_state) {
  $node = &$form['#node'];

  $form['dvg_appointments'] = array(
    '#type' => 'fieldset',
    '#title' => t('Appointment'),
    '#collapsible' => TRUE,
    '#collapsed' => !$node->webform['appointment_enabled'],
  );
  $form['dvg_appointments']['appointment_enabled'] = array(
    '#type' => 'checkbox',
    '#title' => t('Enable appointment'),
    '#default_value' => $node->webform['appointment_enabled'],
    '#id' => 'webform-appointment-enabled',
  );
  $form['dvg_appointments']['mapping'] = array(
    '#type' => 'container',
    '#tree' => TRUE,
    '#states' => array(
      'visible' => array(
        '#webform-appointment-enabled' => array(
          'checked' => TRUE,
        ),
      ),
    ),
  );

  $mapping = !empty($node->webform['appointment_mapping']) ? unserialize($node->webform['appointment_mapping']) : array();
  try {
    $client_api = dvg_appointments_get_client_api();

    $book_fields = $client_api->get_book_fields();
    $components = array(
      '' => t('Select a component'),
    );
    $component_type_blacklist = array('wa_product', 'wa_date_time', 'wa_appointment', 'pagebreak', 'markup', 'fieldset');
    foreach ($node->webform['components'] as $cid => $component) {
      if (!in_array($component['type'], $component_type_blacklist)) {
        $components[$cid] = $component['name'];
      }
    }

    foreach ($book_fields as $field => $label) {
      $form['dvg_appointments']['mapping'][$field] = array(
        '#type' => 'select',
        '#title' => $label,
        '#options' => $components,
        '#default_value' => isset($mapping[$field]) ? $mapping[$field] : '',
      );
    }

    array_unshift($form['#submit'], 'dvg_appointments_webform_configure_form_submit');
  }
  catch (Exception $e) {
    drupal_set_message(t('Unable to load the Webform Appointment API: %message', array( // @todo: add link to config page.
      '%message' => $e->getMessage(),
    )), 'error');
  }
}

/**
 * Submit handler for webform_configure_form().
 */
function dvg_appointments_webform_configure_form_submit(&$form, &$form_state) {
  $node = &$form['#node'];
  $node->webform['appointment_enabled'] = (int) $form_state['values']['appointment_enabled'];
  if ($node->webform['appointment_enabled']) {
    $node->webform['appointment_mapping'] = serialize($form_state['values']['mapping']);
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function dvg_appointments_form_dvg_global_texts_alter(&$form, &$form_state) {
  if (!empty($form['dvg_custom__contact_information'])) {
    $create_nid = functional_content_nid('dvg_appointments_create');
    $cancel_nid = functional_content_nid('dvg_appointments_cancel');

    $form['dvg_custom__contact_information']['button_1']['#default_value']['url'] = 'node/' . $create_nid;
    $form['dvg_custom__contact_information']['button_2']['#default_value']['url'] = 'node/' . $cancel_nid;

    $form['dvg_custom__contact_information']['button_1']['#after_build'][] =
      $form['dvg_custom__contact_information']['button_2']['#after_build'][] = 'dvg_appointments_contact_buttons_remove_url';

    $form['dvg_custom__contact_information']['button_1']['#element_validate'][] =
      $form['dvg_custom__contact_information']['button_2']['#element_validate'][] = 'dvg_appointments_contact_buttons_validate';
  }
}

/**
 * After_build callback that hides the url-field of a link-field.
 */
function dvg_appointments_contact_buttons_remove_url(&$element) {
  $element['url']['#access'] = FALSE;
  return $element;
}

/**
 * Validation handler that fixes the contact-buttons url value.
 */
function dvg_appointments_contact_buttons_validate(&$element, &$form_state) {
  $element['#value'] += $element['#default_value'];
  form_set_value($element, $element['#value'], $form_state);
}

/**
 * Implements hook_token_info().
 */
function dvg_appointments_token_info() {
  $info['tokens']['submission']['dvg_appointments_info'] = array(
    'name' => t('Appointment info'),
    'description' => t('Information about the loaded appointment'),
  );
  $info['tokens']['submission']['dvg_appointments_create_info'] = array(
    'name' => t('Appointment confirmation info'),
    'description' => t('Information about the booked appointments'),
  );
  $info['tokens']['submission']['dvg_appointments_create_products'] = array(
    'name' => t('Appointment confirmation products'),
    'description' => t('Information about the booked appointment products'),
  );
  $info['tokens']['submission']['dvg_appointments_date'] = array(
    'name' => t('Appointment confirmation date'),
    'description' => t('The date of the appointment'),
  );

  return $info;
}

/**
 * Implements hook_tokens().
 */
function dvg_appointments_tokens($type, $tokens, array $data = array(), array $options = array()) {
  $replacements = array();

  if ($type == 'submission' && !empty($data['webform-submission'])) {
    $submission = $data['webform-submission'];
    $node = node_load($submission->nid);

    foreach ($tokens as $name => $original) {
      switch ($name) {
        case 'dvg_appointments_info':
          $cid = dvg_appointments_get_cid($node, 'wa_appointment');
          $appointment = $submission->data[$cid]['appointment'];

          $replacements[$original] = drupal_html_to_text(_dvg_appointments_table(
            $appointment,
            FALSE
          ));
          break;

        case 'dvg_appointments_create_info':
          $appointments = dvg_appointments_get_appointments($submission->nid, $submission->sid);
          $replacements[$original] = _dvg_appointments_create_info($appointments, FALSE);
          break;

        case 'dvg_appointments_create_products':
          $appointment = dvg_appointments_get_appointments($submission->nid, $submission->sid);

          $product_names = dvg_appointments_get_products_names($appointment->getProductIds());

          $end = array_pop($product_names);

          if (!empty($product_names)) {
            $replacements[$original] = implode(', ', $product_names) . t(' and ') . $end;
          }
          else {
            $replacements[$original] = $end;
          }
          break;

        case 'dvg_appointments_date':
          if ($wa_appointment = dvg_appointments_get_cid($node, 'wa_appointment')) {
            $appointment = $submission->data[$wa_appointment]['appointment'];
          }
          else {
            $appointment = dvg_appointments_get_appointments($submission->nid, $submission->sid);
          }
          $timestamp = $appointment->getStart()->format('U');

          $replacements[$original] = dvg_appointments_format_date_for_display($timestamp, 'date');
          break;
      }
    }
  }

  return $replacements;
}

/**
 * Implements hook_dvg_appointments_api_client().
 */
function dvg_appointments_dvg_appointments_api_client() {
  return array(
    'gplan' => array(
      'name' => t('JCC G-Plan / G-Bos'),
      'class' => 'AppointmentsGplanClient',
    ),
    'gplan_multiple' => array(
      'name' => t('JCC G-Plan / G-Bos multiple products per appointment'),
      'class' => 'AppointmentsGplanMultipleClient',
    ),
    'qmatic' => array(
      'name' => t('Qmatic'),
      'class' => 'AppointmentsQmaticClient',
    ),
  );
}

/**
 * Get a product name for a given product code.
 *
 * @param string $product_id
 *   Product code.
 *
 * @return string
 *   The product name, or an empty string if not found.
 *
 * @throws \Exception
 */
function dvg_appointments_get_product_name($product_id) {
  static $products;

  if (!isset($products)) {
    $client = dvg_appointments_get_client_api();
    $products = $client->get_available_products();
  }

  if (isset($products[$product_id])) {
    return $products[$product_id]['name'];
  }

  return '';
}

/**
 * Get names for an array of product ids.
 *
 * @param array $product_ids
 *   An array of product ids.
 *
 * @return array
 *   An array of names, keyed by product id.
 */
function dvg_appointments_get_products_names($product_ids) {
  $names = array();
  foreach ($product_ids as $product_id) {
    $name = dvg_appointments_get_product_name($product_id);
    if ($name !== '') {
      $names[$product_id] = $name;
    }
  }
  return $names;
}
