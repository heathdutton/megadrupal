<?php

function sqlbuddy_menu() {
    $items['admin/structure/sqlbuddy'] = array(
        'title' => t('SQL Buddy'),
        'page callback' => 'sqlbuddy_admin',
        'access callback' => 'user_access',
        'access arguments' => array('administer sqlbuddy'),
    );
    $items['sqlbuddy'] = array(
        'page callback' => 'sqlbuddy_page',
        'page arguments' => array('index'),
        'access callback' => 'user_access',
        'access arguments' => array('administer sqlbuddy'),
    );
    $items['sqlbuddy/images/%'] = array(
        'page callback' => 'sqlbuddy_images',
        'page arguments' => array(2),
        'access callback' => 'user_access',
        'access arguments' => array('administer sqlbuddy'),
    );

    $pages = array('ajaxfulltext', 'ajaximportfile', 'ajaxquery', 'ajaxsavecolumnedit', 'ajaxsaveedit', 'ajaxsaveuseredit',
                   'browse', 'config', 'dboverview', 'editcolumn', 'edit', 'edituser', 'export', 'functions', 'home', 'import',
                   'index', 'insert', 'login', 'logout', 'query', 'serve', 'structure', 'users');

    foreach ($pages as $page) {
        $items["sqlbuddy/$page"] = array(
            'page callback' => 'sqlbuddy_page',
            'page arguments' => array(1),
            'access callback' => 'user_access',
            'access arguments' => array('administer sqlbuddy'),
        );
    }

    return $items;
}

function sqlbuddy_permission() {
 return array(
    'administer sqlbuddy' => array(
      'title' => t('Administer SQL Buddy'),
      'restrict access' => TRUE,
    ),
  );
}

function sqlbuddy_admin() {
    drupal_goto('sqlbuddy');
}

function sqlbuddy_page($file) {
    sqlbuddy_filter_xss();
    global $lib_path;
    $lib_path = '/' . drupal_get_path('module', 'sqlbuddy') . '/lib/sqlbuddy';
    module_load_include('inc', 'sqlbuddy', "lib/sqlbuddy/$file");
    exit;
}

function sqlbuddy_filter_xss() {
    foreach ($_GET as $key => $value) {
        $_GET[$key] = filter_xss($value);
    }
}

function sqlbuddy_images($file) {
    drupal_goto(drupal_get_path('module', 'sqlbuddy') . "/lib/sqlbuddy/images/$file");
}
