<?php

/**
 * @file cps_path.module
 */

/**
 * Implements hook_node_validate().
 */
function cps_path_node_validate($node) {
  if (empty($node->path['alias'])) {
    return;
  }
  $select = db_select('cps_changeset', 'c');
  $select->addField('c', 'uid');
  $select->join('cps_entity', 'ce', 'c.changeset_id = ce.changeset_id');
  $select->join('path_revision', 'pr', 'ce.entity_type = pr.entity_type AND ce.revision_id = pr.revision_id');
  $select
    ->condition('c.changeset_id', cps_get_current_changeset(), '!=')
    ->condition('c.status', array_keys(cps_get_states_by_type('open')))
    ->condition('pr.alias', $node->path['alias']);
  if (!empty($node->nid)) {
    $or = db_or()
      ->condition('ce.entity_type', 'node', '!=')
      ->condition('ce.entity_id', $node->nid, '!=');
    $select->condition($or);
  }
  $other_user = $select->execute()->fetchField();
  if ($other_user) {
    $args = array('@user' => format_username(user_load($other_user)));
    form_set_error('path][alias', t('This alias is used in a changeset by @user', $args));
  }
}
