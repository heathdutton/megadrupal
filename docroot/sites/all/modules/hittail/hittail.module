<?php

/**
 * Implements hook_help().
 */

function hittail_help($path, $arg) {
  switch ($path) {
    case 'admin/help#hittail':
      return '<p>' . t('HitTail.com keyword suggestion tool. In order to use this module, you must first sign up for an account at <a href="http://hittail.com">http://hittail.com</a>.') . '</p>';
    break;
  }
}

/**
 * Implements hook_menu().
 */

function hittail_menu() {
  $items['admin/config/system/hittail'] = array(
    'title' => 'HitTail.com',
    'description' => 'Configure tracking behavior to drive targeted search visitors to your website by focusing on the most promising organic keywords in your existing traffic.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('hittail_admin_settings_form'),
    'access arguments' => array('administer site configuration'),
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * Administration form callback.
 */

function hittail_admin_settings_form() {
  $form = array();

  $form['hittail_id'] = array(
    '#title' => t('HitTail.com Site ID'),
    '#description' => t('The application id. You can find this in the code provided by HitTail.com.'),
    '#type' => 'textfield',
    '#default_value' => variable_get('hittail_id', ''),
  );

  return system_settings_form($form);
}

/**
 * Implements hook_page_alter().
 *
 * This is where the magic happens. Magic being adding the tracking
 *   code to every page.
 */

function hittail_page_alter() {
  $hittail_id = variable_get('hittail_id', '');

  if (!empty($hittail_id)) {
    drupal_add_js("(function(){
      var ht = document.createElement('script');
      ht.async = true;
      ht.type='text/javascript';
      ht.src = '//" . $hittail_id . ".hittail.com/mlt.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(ht, s);
      })();", array(
      'type' => 'inline',
      'scope' => 'footer',
    ));
  }
}
