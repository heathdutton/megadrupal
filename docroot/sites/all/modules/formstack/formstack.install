<?php
/**
 * @file
 * Install, update, and uninstall functions for the formstack module.
 */

/**
 * Implements hook_field_schema().
 *
 * The data we will store here is just one form id from Formstack.
 */
function formstack_field_schema($field) {
  $columns = array(
    'formstack_id' => array('type' => 'varchar', 'length' => 32, 'not null' => FALSE),
    'formstack_title' => array('type' => 'text', 'not null' => FALSE),
    'formstack_js' => array('type' => 'text', 'size' => 'big', 'not null' => FALSE),
  );
  $indexes = array(
    'formstack_id' => array('formstack_id'),
  );
  return array(
    'columns' => $columns,
    'indexes' => $indexes,
  );
}

/**
 * Implements hook_uninstall().
 */
function formstack_uninstall() {
  variable_del('formstack_access_token');
}

/**
  * Returns all fields created on the system of the type defined in mymodule.
  */
function formstack_get_mymodule_fields() {
  $types = array_keys(formstack_field_info()); // field types defined in mymodule
  $fields = array();
  foreach (field_info_fields() as $field) {
    if (in_array($field['type'], $types)) {
      $fields[] = $field;
    }
  }

  return $fields;
}

/**
 * Add database columns for title and js embed code.
 */
function formstack_update_7201() {
  $fields = formstack_get_mymodule_fields();

  foreach ($fields as $field) {
    $tables = array(
      _field_sql_storage_tablename($field),
      _field_sql_storage_revision_tablename($field)
    );
    foreach ($tables as $table) {
      $field_name = $field['field_name'];
      $column1 = $field_name . '_formstack_title';
      $column2 = $field_name . '_formstack_js';
      $spec1 = array('type' => 'text');
      $spec2 = array('type' => 'text', 'size' => 'big');
      db_add_field($table, $column1, $spec1);
      db_add_field($table, $column2, $spec2);
    }
  }
  return t('Added database columns for title and js embed code.');
}

/**
 * Resaves all nodes with values in formstack fields.
 */
function formstack_update_7202() {
  $fields = formstack_get_mymodule_fields();

  foreach ($fields as $field) {
    $tables = array(
      _field_sql_storage_tablename($field),
    );
    foreach ($tables as $table) {
      $nids = db_select($table, 'f')
        ->distinct()
        ->fields('f', array('entity_id'))
        ->execute()
        ->fetchCol();
    }
    $nodes = node_load_multiple($nids);
    foreach ($nodes as $node) {
      node_save($node);
    }
  }
  return t('All Formstack fields have been updated.');
}
