<?php

/**
 * Implements hook_perm().
 */
function deloreanipsum_permissions() {
  return array(
    'use DeLorean Ipsum' => array(
      'title' => t("Use DeLorean Ipsum"),
      'description' => t("Use the DeLorean Ipsum functionnality on textareas.")
    )
  );
}

/**
 * Implements form_alter().
 */
function deloreanipsum_form_alter(&$form, &$form_state, $form_id) {
  if (user_access('use DeLorean Ipsum')) {
      if (_deloreanipsum_element_alter($form)) {
        $path = drupal_get_path('module', 'deloreanipsum');
        $settings = array('imgpath' => url($path.'/images/delorean.png'));
        drupal_add_js(array('deloreanipsum' => $settings), 'setting');
        drupal_add_css($path . '/css/delorean.css');
        drupal_add_js($path . '/js/jquery.delorean.ipsum.min.js');
        drupal_add_js($path . '/js/deloreanipsum.js');
      }
  }
}

/**
 * Helper function.
 */
function _deloreanipsum_element_alter(&$element) {
  $found = FALSE;
  foreach (element_children($element) as $key) {

    if (_deloreanipsum_element_alter($element[$key])) {
      $found = TRUE;
    }

    if (isset($element[$key]['#type']) && $element[$key]['#type'] == 'textarea') {
      if (isset($element[$key]['#attributes']['class'])) {
        $element[$key]['#attributes']['class'][] = 'deloreanipsum';
      }
      else {
        $element[$key]['#attributes']['class'] = array('deloreanipsum');
      }
      $found = TRUE;
    }
  }
  return $found;
}
