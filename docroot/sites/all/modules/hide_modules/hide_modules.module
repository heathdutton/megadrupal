<?php
/**
 * @file
 * Hide Modules main module file.
 *
 * Allows selected modules not being listed at the module administration
 * page except for users with 'view hidden modules' permission.
 */

/*
 * Implements hook_system_info_alter()
 *
 * Should return ASAP if module is allowed to be listed.
 * Sets $info['hidden'] to TRUE if module should not be listed.
 */
function hide_modules_system_info_alter(&$info, $file, $type) {
  if ($type != 'module') {
    return;
  }

  if (user_access('administer hide_modules')) {
    return;
  }

  /*
   * Only users with 'administer hide_modules' permission will be able
   * to see Hide Modules listed regardless of their 'view hidden modules'
   * permission.
   */
  if ($file->name == 'hide_modules') {
    $info['hidden'] = TRUE;
    return;
  }

  if (user_access('view hidden modules')) {
    return;
  }

  $hide_modules = explode(',', variable_get('hide_modules_list'));
  $hide_modules = array_map('trim', $hide_modules);
  if (in_array($file->name, $hide_modules)) {
    $info['hidden'] = TRUE;
  }
}

/*
 * Implements hook_menu()
 */
function hide_modules_menu() {
  $items['admin/modules/hide'] = array(
    'title' => 'Hide',
    'type' => MENU_LOCAL_TASK,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('hide_modules_settings_form'),
    'access arguments' => array('administer hide_modules'),
  );
  return $items;
}

/*
 * Implements hook_permission()
 */
function hide_modules_permission() {
  $items = array(
    'administer hide_modules' => array(
      'title' => t('Administer Hide Modules'),
      'description' => t('Change Hide Modules settings. This permission implies listing hidden modules.'),
    ),
    'view hidden modules' => array(
      'title' => t('View hidden modules'),
      'description' => t('Bypass hidden modules list. <em>Note: \'Hidden Modules\' module will be listed only to users with \'Administer Hide Modules\' permission.</em>'),
    ),
  );
  return $items;
}

/*
 * Hide Modules settings form
 */
function hide_modules_settings_form() {
  $form = array(
    'hide_modules_list' => array(
      '#type' => 'textfield',
      '#title' => t('Module list'),
      '#default_value' => variable_get('hide_modules_list'),
      '#description' => t('Comma-separated list of modules to hide.'),
    ),
  );
  return system_settings_form($form);
}
