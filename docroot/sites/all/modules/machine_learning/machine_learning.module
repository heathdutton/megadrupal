<?php

/**
 * This module does not expose hook_computing_data().
 * It supports these command:
 * 1. check_python: handles Python environment
 * 2. check_java; handles Java environment.
 */

/**
 * Implements hook_menu().
 */
function machine_learning_menu() {
  $items = array();

  $items[COMPUTING_MODULE_ADMIN_PATH .'/machine_learning'] = array(
    'type' => MENU_LOCAL_TASK,
    'title' => 'Machine Learning Libraries',
    'description' => 'Display the list of machine learning libraries in Java and Python.',
    'page callback' => 'machine_learning_report',
    'access arguments' => array('administer computing module'),
  );

  return $items;
}


function _machine_learning_report_table($output) {
  $requirements = array();
  foreach ($output as $lib_name => $lib_data) {
    if ($lib_name == 'agent') continue; // skip agent field.
    $req = array('title' => $lib_data['title']);
    if ($lib_data['installed']) {
      $req['value'] = @$lib_data['version'] ?: t('Installed, but version not available.');
    }
    else {
      $req['value'] = t('Not installed or not found.');
      $req['severity'] = REQUIREMENT_WARNING;
    }
    $requirements[] = $req;
  }
  return theme('status_report', array('requirements' => $requirements));
}

/**
 * See hook_requirements().
 */
function machine_learning_report() {
  $java_record = computing_last_success('computing', 'check_java');
  $python_record = computing_last_success('computing', 'check_python');

  return array(
    'java_lib_title' => array(
      '#markup' => '<h3>'. t('Java Libraries (agent: %agent)', array('%agent' => @$java_record->output['agent'] ?: t('N/A'))) .'</h3>',
    ),
    'java_lib_content' => array(
      '#markup' => ($java_record && is_array($java_record->output))
          ? _machine_learning_report_table($java_record->output)
          : '<p>'. t('Please run the Java agent program that comes with the module to get Java libraries info. Make sure the CLASSPATH is set correctly.') .'</p>',
    ),
    'python_lib_title' => array(
      '#markup' => '<h3>'. t('Python Libraries (agent: %agent)', array('%agent' => @$python_record->output['agent'] ?: t('N/A'))) .'</h3>',
    ),
    'python_lib_content' => array(
      '#markup' => ($python_record && is_array($python_record->output))
          ? _machine_learning_report_table($python_record->output)
          : '<p>'. t('Please run the Python agent program that comes with the module to get Python libraries info. Make sure the PYTHONPATH is set correctly.') .'</p>',
    ),
  );
}

/**
 * Implements hook_help().
 */
function machine_learning_help($path, $arg) {
  if ($path == COMPUTING_MODULE_ADMIN_PATH .'/machine_learning') {
    return '<p>'. t('Here you will find a list of of Java and Python machine learning libraries installed on the system where you run the agent programs.') .'</p>';
  }
}
