<?php
/***
 * @file
 * node usage report
 */

require_once DRUPAL_ROOT . '/' . drupal_get_path('module', 'node_usage') . '/node_usage.blocks.inc';


/**
 * Implements hook_menu().
 */
function node_usage_menu() {
  $items['admin/reports/nodes'] = array(
    'title' => 'Node usage',
    'description' => 'Distribution of nodes.',
    'page callback' => 'node_usage_node_usage',
    'access callback' => 'user_access',
    'access arguments' => array('node usage'),
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}


function node_usage_permission() {
  return array(
    'node usage' => array(
      'title' => t('View node usage report'),
    ),
  );
}

/**
 * Displays node usage as a page.
 *
 * @return
 *   page
 */
function node_usage_node_usage() {
  $title = 'Node Usage by Type';
  drupal_set_title($title);

  $output = _node_usage_node_get_usage();

  return $output;
}


/**
 * Create node usage display; may be used as a page or a block
 *
 * @return
 *   content for page or block
 */
function _node_usage_node_get_usage() {
  $header = array('Type', 'Name', 'Count');

  $header = array(
    array(
      'data' => t('Type'),
      'field' => 'n.type',
      'sort' => 'asc',
      'class' => array('h-type'),
    ),
    array(
      'data' => t('Name'),
      'field' => 'nt.name',
      'sort' => 'asc',
      'class' => array('h-name'),
    ),
    array(
      'data' => t('Count'),
      'field' => 'node_count',
      'sort' => 'asc',
      'class' => array('h-count'),
    ),
  );

  $rows = array();

  $query = db_select('node', 'n');
  $query->leftJoin('node_type', 'nt', 'n.type=nt.type');
  $query->addField('n', 'type', 'Type');
  $query->addField('nt', 'name', 'Name');
  $query->addExpression('COUNT(Name)', 'node_count');
  $query->groupBy('Name');
  $query = $query->extend('TableSort')->orderByHeader($header);

  $result = $query->execute();
  foreach ($result as $record) {
    $type = $record->Type;
    $name = $record->Name;
    $count = $record->node_count;
    $rows[] = array(
      array('data' => $type,  'class' => array('c-type')),
      array('data' => $name,  'class' => array('c-name')),
      array('data' => $count, 'class' => array('c-count')),
    );
  }

  $output = theme('table', array(
    'header' => $header,
    'rows' => $rows,
    'attributes' => array('class' => array('node-usage'))
  ));

  // apply style sheet
  drupal_add_css(drupal_get_path('module', 'node_usage') . '/css/node_usage.css');

  return $output;
}

