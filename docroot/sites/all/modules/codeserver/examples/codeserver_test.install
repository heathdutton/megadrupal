<?php

/*
 * @file
 * CodeServer module for Drupal.
 * http://netgenius.co.uk
 */

function codeserver_test_enable() {
  codeserver_test_create_config();
  drupal_set_message(t('Created CodeServer configuration "codeserver_test".'));
  $tvars = array('!click_here' => l(t('Click here'), 'codeserver/test'));
  codeserver_set_message('!click_here to view the test page.', $tvars);
}

// Create a Code Server configuration to use.
function codeserver_test_create_config() {

  // Load any existing CodeServer configurations.
  $configs = codeserver_configs();

  // Get local site URL, e.g. http://mysite.com/drupal
  $local_site = $GLOBALS['base_url'];

  // If running under drush (etc)
  if (codeserver_test_is_cli()) {
    $tvars = array(
      '%base_url' => '$base_url',
      '%site_url' => $local_site,
    );
    $msg = 'Enabling this module from drush (etc.) will only work if the global %base_url value is correct.';
    codeserver_set_message($msg, $tvars, 'warning');
    $msg = 'If %site_url is not the correct URL for the site, try enabling this module via the module admin page instead.';
    codeserver_set_message($msg, $tvars, 'warning');
  }

  // Get the IP addresses that the server may use to connect to itself.
  $server_ips = array(
    '127.0.0.1',
    gethostbyname(parse_url($local_site, PHP_URL_HOST)),
    $_SERVER['SERVER_ADDR'],
  );
  // Remove any blank values and duplicates.
  $server_ips = array_unique(array_filter($server_ips));

  // Set up a new configuration named 'codeserver_test'.
  $configs['codeserver_test'] = array(
    'service_id' => 'codeserver_test',
    'service_name' => 'CodeServer Test',
    'server' => $local_site,
    'allowed_ips' => $server_ips,
    'allowed_functions' => array('codeserver_test', 'microtime', 'sleep'),
    'encrypt_key' => openssl_random_pseudo_bytes(16),
    'encrypt_iv' => openssl_random_pseudo_bytes(16),
  );
  // Save the updated configs.
  codeserver_configs($configs);
}

function codeserver_test_disable() {
  $configs = codeserver_configs();
  // Remove 'codeserver_test' configuration.
  if (isset($configs['codeserver_test'])) {
    unset($configs['codeserver_test']);
    // Save.
    codeserver_configs($configs);
    drupal_set_message(t('Deleted CodeServer configuration "codeserver_test"'));
  }
}

function codeserver_test_is_cli() {
  if (function_exists('drupal_is_cli')) {
    return drupal_is_cli();
  }
  else {
    // From https://api.drupal.org/api/drupal/includes%21bootstrap.inc/function/drupal_is_cli/7
    return (!isset($_SERVER ['SERVER_SOFTWARE']) && (php_sapi_name() == 'cli' || (is_numeric($_SERVER ['argc']) && $_SERVER ['argc'] > 0)));
  }
}
