<?php
/**
 * @file
 * Main module file, containing File field formatter, global configuration form
 * functions, formatter configuration functions and helper functions for
 * conversion pdf files to swf and json.
 */

/**
 * Implements hook_menu().
 */
function flexpaper_menu() {
  $items['admin/config/flexpaper'] = array(
    'title' => 'Flexpaper settings',
    'description' => 'Global settings for flexpaper module',
    'page callback' => 'drupal_get_form',
    'access arguments' => array('administer site configuration'),
    'page arguments' => array('flexpaper_settings_page_form'),
    'file' => 'flexpaper.admin.inc',
    'file path' => drupal_get_path('module', 'flexpaper'),
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}

/**
 * Implements hook_permission().
 */
function flexpaper_permission() {
  return array(
    'generate swf files' => array(
      'title' => t('Generate swf files'),
      'description' => t('Generate swf files from pdf.'),
    ),
  );
}

/**
 * Implements hook_field_formatter_info().
 */
function flexpaper_field_formatter_info() {
  return array(
    'flexpaper_formatter' => array(
      'label' => t('Flexpaper formatter'),
      'descrition' => t('Provides a way to show pdf files using flexpaper'),
      'field types' => array('file'),
      'settings' => array(
        'version_switcher' => 'free',
        'commercial_version_settings' => array(
          'rendering_order' => 'html5,flash',
          'view_mode_tools_visible' => 1,
          'zoom_tools_visible' => 1,
          'nav_tools_visible' => 1,
          'cursor_tools_visible' => 1,
          'search_tools_visible' => 1,
        ),
        'page_loading_mode' => 'split',
        'show_file_link' => TRUE,
        'scale' => 0.6,
        'zoom_transition' => 'easeOut',
        'zoom_time' => 0.5,
        'zoom_interval' => 0.2,
        'fit_page_on_load' => FALSE,
        'fit_width_on_load' => TRUE,
        'full_screen_as_max_window' => FALSE,
        'progressive_loading' => FALSE,
        'min_zoom_size' => 0.2,
        'max_zoom_size' => 5,
        'search_match_all' => FALSE,
        'init_view_mode' => 'TwoPage',
      ),
    ),
  );
}

/**
 * Implements hook_field_formatter_settings_summary().
 */
function flexpaper_field_formatter_settings_summary($field, $instance, $view_mode) {
  $summary = '';
  $display = $instance['display'][$view_mode];
  if ($display['type'] = 'flexpaper_formatter') {
    $summary = t('Click to change flexpaper settings');
  }
  return $summary;
}

/**
 * Implements hook_field_formatter_settings_form().
 */
function flexpaper_field_formatter_settings_form($field, $instance, $view_mode, $form, &$form_state) {
  $display = $instance['display'][$view_mode];
  $settings = $display['settings'];
  $element = array();
  if ($display['type'] == 'flexpaper_formatter') {
    $element['version_switcher'] = array(
      '#type' => 'radios',
      '#title' => t('Choose viewer version'),
      '#default_value' => $settings['version_switcher'],
      '#options' => array(
        'free' => t('Free version'),
        'commercial' => t('Commercial version')
      ),
      '#description' => t('Choose what version do you want to use.'),
      '#ajax' => array(
        'callback' => 'flexpaper_formatter_settings_ajax_callback',
        'wrapper' => 'flexpaper-commercial-settings-wrapper',
      ),
    );
    $element['commercial_version_settings'] = array(
      '#type' => 'fieldset',
      '#title' => t('Commercial version settings'),
      '#collapsible' => TRUE,
      '#collapsed' => TRUE,
      '#prefix' => '<div id="flexpaper-commercial-settings-wrapper">',
      '#suffix' => '</div>',
    );

    $is_commercial_version_chosen = FALSE;
    $field_name = $instance['field_name'];
    if (isset($form_state['values']['fields'][$field_name]['settings_edit_form']['settings']['version_switcher'])){
      $form_state['flexpaper_field_name'] = $field_name;
      if($form_state['values']['fields'][$field_name]['settings_edit_form']['settings']['version_switcher'] == 'commercial') {
        $is_commercial_version_chosen = TRUE;
      }
    }
    elseif ($settings['version_switcher'] == 'commercial') {
      $is_commercial_version_chosen = TRUE;
    }
    $element['commercial_version_settings']['#disabled'] = !$is_commercial_version_chosen;
    $element['commercial_version_settings']['rendering_order'] = array(
      '#type' => 'select',
      '#title' => t('Rendering order'),
      '#default_value' => $settings['commercial_version_settings']['rendering_order'],
      '#options' => array(
        'html5,flash' => t('html5,flash'),
        'flash,html5' => t('flash,html5'),
        'flash,html' => t('flash,html'),
        'html5,html' => t('html5,html'),
        'html,flash' => t('html,flash'),
        'html,html5' => t('html,html5'),
      ),
      '#description' => t('Choose how flexpaper should try to render content.')
    );
    $element['commercial_version_settings']['view_mode_tools_visible'] = array(
      '#type' => 'checkbox',
      '#title' => t('View mode tools visible'),
      '#default_value' => $settings['commercial_version_settings']['view_mode_tools_visible'],
    );
    $element['commercial_version_settings']['zoom_tools_visible'] = array(
      '#type' => 'checkbox',
      '#title' => t('View mode tools visible'),
      '#default_value' => $settings['commercial_version_settings']['zoom_tools_visible'],
    );
    $element['commercial_version_settings']['nav_tools_visible'] = array(
      '#type' => 'checkbox',
      '#title' => t('Navigation tools visible'),
      '#default_value' => $settings['commercial_version_settings']['nav_tools_visible'],
    );
    $element['commercial_version_settings']['cursor_tools_visible'] = array(
      '#type' => 'checkbox',
      '#title' => t('Cursor tools visible'),
      '#default_value' => $settings['commercial_version_settings']['cursor_tools_visible'],
    );
    $element['commercial_version_settings']['search_tools_visible'] = array(
      '#type' => 'checkbox',
      '#title' => t('Search tools visible'),
      '#default_value' => $settings['commercial_version_settings']['search_tools_visible'],
    );
    $element['page_loading_mode'] = array(
      '#type' => 'select',
      '#title' => t('Page loading mode'),
      '#options' => array(
        'split' => t('Split'),
        'one file' => t('One file'),
      ),
      '#default_value' => $settings['page_loading_mode'],
      '#description' => t("You can select how your documents will be loaded. If you choose split mode, flexpaer will download other pages when needed. It's preferable for large pdfs."),
    );
    $element['show_file_link'] = array(
      '#type' => 'checkbox',
      '#title' => t('Show file link'),
      '#default_value' => $settings['show_file_link'],
      '#description' => t('Show file link above the flexpaper viewer.'),
    );
    $element['scale'] = array(
      '#type' => 'textfield',
      '#title' => t('Scale'),
      '#default_value' => $settings['scale'],
      '#required' => TRUE,
    );
    // @TODO not all possible Tweener zoom transition elements are added here.
    $element['zoom_transition'] = array(
      '#type' => 'select',
      '#title' => t('Page loading mode'),
      '#options' => array(
        'easeOut' => t('easeOut'),
        'linear' => t('linear'),
        'easenone' => t('easenone'),
        'easeInSine' => t('easeInSine'),
        'easeOutQuad' => t('easeOutQuad'),
      ),
      '#default_value' => $settings['zoom_transition'],
    );
    $element['zoom_time'] = array(
      '#type' => 'textfield',
      '#title' => t('Zoom time'),
      '#default_value' => $settings['zoom_time'],
      '#required' => TRUE,
    );
    $element['zoom_interval'] = array(
      '#type' => 'textfield',
      '#title' => t('Zoom interval'),
      '#default_value' => $settings['zoom_interval'],
      '#required' => TRUE,
    );
    $element['fit_page_on_load'] = array(
      '#type' => 'checkbox',
      '#title' => t('Fit page on load'),
      '#default_value' => $settings['fit_page_on_load'],
    );
    $element['fit_width_on_load'] = array(
      '#type' => 'checkbox',
      '#title' => t('Fit width on load'),
      '#default_value' => $settings['fit_width_on_load'],
    );
    $element['full_screen_as_max_window'] = array(
      '#type' => 'checkbox',
      '#title' => t('Use full screen as max window'),
      '#default_value' => $settings['full_screen_as_max_window'],
    );
    $element['progressive_loading'] = array(
      '#type' => 'checkbox',
      '#title' => t('Progressive loading'),
      '#default_value' => $settings['progressive_loading'],
    );
    $element['min_zoom_size'] = array(
      '#type' => 'textfield',
      '#title' => t('Min zoom size'),
      '#default_value' => $settings['min_zoom_size'],
      '#required' => TRUE,
    );
    $element['max_zoom_size'] = array(
      '#type' => 'textfield',
      '#title' => t('Max zoom size'),
      '#default_value' => $settings['max_zoom_size'],
      '#required' => TRUE,
    );
    $element['search_match_all'] = array(
      '#type' => 'checkbox',
      '#title' => t('Search match all'),
      '#default_value' => $settings['search_match_all'],
    );
    $element['init_view_mode'] = array(
      '#type' => 'select',
      '#title' => t('Initial view mode'),
      '#options' => array(
        'Portrait' => t('Portrait'),
        'TwoPage' => t('Two pages'),
        'Tile' => t('Tile'),
      ),
      '#default_value' => $settings['init_view_mode'],
    );
  }
  return $element;
}

/**
 * Ajax callback for flexpaper formatter settings.
 */
function flexpaper_formatter_settings_ajax_callback($form, $form_state) {
  $field_name = $form_state['flexpaper_field_name'];
  return $form['fields'][$field_name]['format']['settings_edit_form']['settings']['commercial_version_settings'];
}

/**
 * Implements hook_field_formatter_view().
 */
function flexpaper_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  global $base_url;
  $element = array();
  if ($display['type'] == 'flexpaper_formatter') {
    $files = array();
    foreach ($items as $delta => $item) {
      if ($file = file_load($item['fid'])) {
        $files[$file->fid] = $file;
      }
    }
    // Check if all files have corresponding swfs.
    $status = flexpaper_check_files_status($files);
    if (!empty($status)) {
      $settings = $display['settings'];
      $js_settings = _flexpaper_prepare_settings($settings);
      $delta = 0;
      foreach ($status as $fid => $conversion_done) {
        if ($conversion_done) {
          $file = file_load($fid);
          $folder_uri = _flexpaper_get_files_folder_path($file);
          $folder_absolute_path = drupal_realpath($folder_uri);
          $folder_relative_path = str_replace(DRUPAL_ROOT, '', $folder_absolute_path);
          $files_directory_info = & drupal_static('flexpaper_files_directory_info');
          $files_arr = $files_directory_info[$fid];
          // Check if we have json.
          if (in_array($fid . '.js', $files_arr)) {
            $js_settings['jsonFiles'][] = $folder_relative_path . '/' . $fid . '.js';
            $swf_number = (count($files_arr) - 4)/2;
          }
          else {
            $js_settings['jsonFiles'][] = '';
            $swf_number = (count($files_arr) - 3)/2;
          }
          if ($settings['page_loading_mode'] == 'split') {
            $js_settings['swfFiles'][] = $folder_relative_path . '/{' . $fid . '_[*,0].swf,' . $swf_number . '}';
          }
          else {
            $js_settings['swfFiles'][] = $folder_relative_path . '/' . $fid . '.swf';
          }
          $js_settings['pngFiles'][] = $folder_relative_path . '/' . $fid . '_{page}.png';
          $path = drupal_realpath($file->uri);
          $drupal_folder = realpath('.');
          $relative_path = str_replace($drupal_folder, "", $path);
          $relative_path = $base_url . $relative_path;
          $js_settings['pdfFiles'][] = $relative_path;
          $element[$delta]['#show_flexpaper'] = TRUE;
        }
        else {
          $element[$delta]['#show_flexpaper'] = FALSE;
        }
        $element[$delta] += array(
          '#theme' => 'flexpaper_container',
          '#show_file_link' => $settings['show_file_link'],
          '#file' => $files[$fid],
        );
        $delta++;
      }
      $library_path = libraries_get_path('flexpaper');
      drupal_add_js($library_path . '/js/flexpaper.js');
      drupal_add_js($library_path . '/js/flexpaper_handlers.js');
      drupal_add_js($library_path . "/js/jquery.extensions.min.js");
      drupal_add_js($library_path . "/js/FlexPaperViewer.js");
      drupal_add_js(drupal_get_path('module', 'flexpaper') . '/js/flexpaper_init.js');
      drupal_add_css(drupal_get_path('module', 'flexpaper') . '/css/flexpaper_init.css');
      drupal_add_css($library_path . '/css/flexpaper.css');
      drupal_add_js(array('flexpaper' => $js_settings), 'setting');
    }
  }
  return $element;
}

/**
 * Helper function. Prepare flexpaper js settings using formatter settings values.
 */
function _flexpaper_prepare_settings($settings) {
  global $base_url;
  $js_settings = array();
  $js_settings['scale'] = $settings['scale'];
  $js_settings['zoomTransition'] = $settings['zoom_transition'];
  $js_settings['zoomTime'] = $settings['zoom_time'];
  $js_settings['zoomInterval'] = $settings['zoom_interval'];
  $js_settings['fitPageOnLoad'] = $settings['fit_page_on_load'];
  $js_settings['fullScreenAsMaxWindow'] = $settings['full_screen_as_max_window'];
  $js_settings['progressiveLoading'] = $settings['progressive_loading'];
  $js_settings['minZoomSize'] = $settings['min_zoom_size'];
  $js_settings['maxZoomSize'] = $settings['max_zoom_size'];
  $js_settings['searchMatchAll'] = $settings['search_match_all'];
  $js_settings['initViewMode'] = $settings['init_view_mode'];
  $js_settings['version'] = $settings['version_switcher'];
  if ($js_settings['version'] == 'free') {
    $js_settings['renderOrder'] = 'flash';
  } else {
    $js_settings['renderOrder'] = $settings['commercial_version_settings']['rendering_order'];
  }
  $js_settings['licenseKey'] = variable_get('flexpaper_license_key', '');
  $js_settings['viewModeToolsVisible'] = $settings['commercial_version_settings']['view_mode_tools_visible'];
  $js_settings['zoomToolsVisible'] = $settings['commercial_version_settings']['zoom_tools_visible'];
  $js_settings['navToolsVisible'] = $settings['commercial_version_settings']['nav_tools_visible'];
  $js_settings['cursorToolsVisible'] = $settings['commercial_version_settings']['cursor_tools_visible'];
  $js_settings['searchToolsVisible'] = $settings['commercial_version_settings']['search_tools_visible'];

  $library_path = libraries_get_path('flexpaper');
  $js_settings['desktopHtmlPath'] = url('flexpaper/desktop_toolbar');
  $js_settings['mobileHtmlPath'] = url('flexpaper/mobile_toolbar');
  $js_settings['jsDirectory'] = $base_url . '/' . $library_path . '/js/';
  $js_settings['cssDirectory'] = $base_url . '/' . $library_path . '/css/';
  $js_settings['localeDirectory'] = $base_url . '/' . $library_path . '/locale/';

  $js_settings['flexpaperKey'] = variable_get('flexpaper_license_key', '');
  return $js_settings;
}

/**
 * Check if flexpaper files were created.
 */
function flexpaper_check_files_status($files) {
  $status = array();
  $batch = array(
    'title' => t('Generating swf files'),
    'operations' => array(),
    'finished' => 'flexpaper_generate_files_batch_finish'
  );
  foreach ($files as $fid => $file) {
    if ($file->filemime == 'application/pdf') {
      $files_directory = _flexpaper_get_files_folder_path($file);
      if (!is_dir($files_directory)) {
        $status[$fid] = FALSE;
        $batch['operations'][] = array(
          'flexpaper_generate_files_batch_process',
          array($file),
        );
      }
      else {
        // Assume that if main swf file is in place, everything is good.
        $files_arr = scandir(drupal_realpath($files_directory));
        // Put it in static cache, because we need it later.
        $files_directory_info = & drupal_static('flexpaper_files_directory_info');
        $files_directory_info[$fid] = $files_arr;
        if (in_array($fid . '.swf', $files_arr)) {
          $status[$fid] = TRUE;
        }
        else {
          $status[$fid] = FALSE;
        }
      }
    }
    else {
      $status[$fid] = FALSE;
    }
  }
  if (count($batch['operations']) > 0 && user_access('generate swf files')) {
    batch_set($batch);
    batch_process();
  }
  return $status;
}

/**
 * Flexpaper processor - Batch API process callback.
 */
function flexpaper_generate_files_batch_process($file, &$context) {
  //@TODO make conversion to json optional
  $fid = $file->fid;
  $context['results']['fid'] = $fid;
  $pdf_path = drupal_realpath($file->uri);
  $files_directory = drupal_realpath(_flexpaper_get_files_folder_path($file));
  if (empty($context['sandbox'])) {
    $context['sandbox']['progress'] = 0;
    $pages_number = _flexpaper_get_pdf_pages_number(drupal_realpath($file->uri));
    if ($pages_number != 0) {
      // It means that our function was able to count number of pages.
      // So, we can show progress info for user.
      $context['sandbox']['progress_info'] = TRUE;
      $context['sandbox']['max'] = _flexpaper_get_pdf_pages_number(drupal_realpath($file->uri)) + 1;
      $context['sandbox']['last_swf'] = FALSE;
      $context['sandbox']['success'] = FALSE;
    }
    else {
      // We don't have number of pages. One attempt to make all operations.
      $context['sandbox']['progress_info'] = FALSE;
    }
    if(!file_prepare_directory($files_directory, FILE_CREATE_DIRECTORY)) {
      watchdog('flexpaper', 'Error in the attempt to create %directory folder. Check flexpaper folder permissions.',
        array('%directory' => $files_directory), WATCHDOG_ERROR);
      $context['message'] = t('Error in the attempt to create %directory folder.',
        array('%directory' => $files_directory));
      $context['results']['create_folder_error'] = TRUE;
      return;
    }
  }
  if ($context['sandbox']['progress_info']) {
    if (!$context['sandbox']['last_swf']) {
      $first_page_number = $context['sandbox']['progress'] + 1;
      $last_page_number = $context['sandbox']['progress'] + 5;
      $context['sandbox']['success'] = _flexpaper_generate_files($files_directory, $fid, $pdf_path, $first_page_number, $last_page_number);
      $context['sandbox']['progress'] = $last_page_number;
    }
    if ($context['sandbox']['success']) {
      if ($context['sandbox']['progress'] < $context['sandbox']['max'] - 1) {
        $context['finished'] = $context['sandbox']['progress'] / $context['sandbox']['max'];
        $context['message'] = t("@progress of @max files are processed", array(
          '@progress' => $context['sandbox']['progress'],
          '@max' => $context['sandbox']['max'],
        ));
      }
      elseif ($context['sandbox']['last_swf'] == FALSE) {
        $context['finished'] = ($context['sandbox']['max'] - 1) / $context['sandbox']['max'];
        $context['sandbox']['last_swf'] = TRUE;
        $context['message'] = t('Last swf is processing');
      }
      else {
        // Create common swf.
        $command = variable_get('flexpaper_path_to_pdf2swf', 'pdf2swf') . " '" . $pdf_path . "' -o '" . $files_directory . '/' . $fid . ".swf' -f -T 9 -t -s storeallcharacters";
        $success1 = _flexpaper_exec_conversion_command($command);
        // Create json file if pdf2json is available.
        $command = '"' . variable_get('flexpaper_path_to_pdf2json', 'pdf2json') . '" "' . $pdf_path . '" -enc UTF-8 -compress -hidden "' . $files_directory . "/" . $fid . '.js"';
        $success2 = _flexpaper_exec_conversion_command($command);
        if ($success1 && $success2) {
          $context['message'] = t("@max of @max files are processed", array('@max' => $context['sandbox']['max']));
        }
        else {
          $context['results']['error'] = TRUE;
        }
        $context['finished'] = 1;
      }
    }
    else {
      $context['finished'] = 1;
      $context['results']['error'] = TRUE;
    }
  }
  else {
    $success1 = _flexpaper_generate_files($files_directory, $fid, $pdf_path);
    $command = '"' . variable_get('flexpaper_path_to_pdf2swf', 'pdf2swf') . '" "' . $pdf_path . '" -o "' . $files_directory . '/' . $fid . '.swf" -f -T 9 -t -s storeallcharacters';
    $success2 = _flexpaper_exec_conversion_command($command);
    $command = '"' . variable_get('flexpaper_path_to_pdf2json', 'pdf2json') . '" "' . $pdf_path . '" -enc UTF-8 -compress -hidden "' . $files_directory . "/" . $fid . '.js"';
    $success3 = _flexpaper_exec_conversion_command($command);
    if(!($success1 && $success2 && $success3)) {
      $context['results']['error'] = TRUE;
    }
    $context['finished'] = 1;
  }
}

/**
 * Flexpaper batch 'finished' callback.
 */
function flexpaper_generate_files_batch_finish($success, $results, $operations) {
  if(isset($results['create_folder_error'])) {
    $message = t('An error occurred while creating the folder for the flexpaper files. See log messages for details.');
    drupal_set_message($message, 'error');
    drupal_goto('');
  }
  if ((isset($results['error']) && $results['error']) || !$success) {
    $message = t('An error occurred while processing generating flexpaper files. See log messages for details.');
    drupal_set_message($message, 'error');
  }
  else {
    $message = t('Generating flexpaper files was succesfully completed.');
    drupal_set_message($message);
  }
}

/**
 * Return folder path for flexpaper files by the given original file
 */
function _flexpaper_get_files_folder_path($file) {
  return file_default_scheme() . '://flexpaper/' . $file->fid . '_files';
}

/**
 * Execute conversion command. Return FALSE if there was an error.
 */
function _flexpaper_exec_conversion_command($command) {
  $output = shell_exec($command);
  return !_flexpaper_check_error_in_conversion($output);
}

/**
 * Create swf and png files for the given range of pdf pages. If start page number is not specified,
 * consider that we need conversion for all pages.
 * Return FALSE if there was an error.
 */
function _flexpaper_generate_files($files_directory, $name_root, $pdf_path, $start_page_number = 0, $end_page_number = 0) {
  //@TODO maybe we could add better error handling here based on comparing file number and page number.
  if ($start_page_number) {
    $swf_output_path = $files_directory . '/' . $name_root . "_%.swf";
    $command = variable_get('flexpaper_path_to_pdf2swf', 'pdf2swf') . ' "' . $pdf_path . '" -o "' . $swf_output_path . '" -p ' . $start_page_number . '-' . $end_page_number . ' -f -T 9 -t -s storeallcharacters';
    $success = _flexpaper_exec_conversion_command($command);
    // If there was no error, then proceed with png files.
    for ($i = $start_page_number; $i <= $end_page_number; $i++) {
      if ($success) {
        $command = variable_get('flexpaper_path_to_swfrender', 'swfrender') . ' "' . $files_directory . '/' . $name_root . '_' . $i . '.swf" -o "' . $files_directory . '/' . $name_root . '_' . $i . '.png" -X 1024 -s keepaspectratio';
        $success = _flexpaper_exec_conversion_command($command);
      }
      else {
        return FALSE;
      }
    }
  }
  else {
    $command = '"' . variable_get('flexpaper_path_to_pdf2swf', 'pdf2swf') . '" "' . $pdf_path . '" -o "' . $files_directory . '/' . $name_root . '_%.swf" -f -T 9 -t -s storeallcharacters';
    $success = _flexpaper_exec_conversion_command($command);
    if ($success) {
      $swf_files = file_scan_directory($files_directory, '/\.swf$/');
      $swf_number = count($swf_files);
      for ($i = 1; $i <= $swf_number; $i++) {
        $command = variable_get('flexpaper_path_to_swfrender', 'swfrender') . ' "' . $files_directory . '/' . $name_root . '_' . $i . '.swf" -o "' . $files_directory . '/' . $name_root . '_' . $i . '.png" -X 1024 -s keepaspectratio';
        $success = _flexpaper_exec_conversion_command($command);
        if (!$success) {
          return FALSE;
        }
      }
    }
    else {
      return FALSE;
    }
  }
  return $success;
}

/**
 * Check if there was an error in conversion. Return TRUE if error appeared.
 */
function _flexpaper_check_error_in_conversion($output) {
  //@TODO this function is not tested with swfrender and pdf2json tools. We don't know how do error messages look like here.
  $pattern = '/(FATAL|ERROR)/i';
  preg_match($pattern, $output, $m);
  if (!empty($m)) {
    watchdog('flexpaper', 'Error in conversion pdf to swf process.
    Log info: %info', array('%info' => $output), WATCHDOG_ERROR);
    return TRUE;
  }
  else {
    return FALSE;
  }
}

/**
 * Implements hook_file_delete().
 */
function flexpaper_file_delete($file) {
  // We should delete all flexpaper files.
  $files_directory = _flexpaper_get_files_folder_path($file);
  if (file_prepare_directory($files_directory)) {
    file_unmanaged_delete_recursive($files_directory);
  }
}

/**
 * Implements hook_theme().
 */
function flexpaper_theme() {
  return array(
    'flexpaper_container' => array(
      'template' => 'theme/flexpaper-container',
      'variables' => array(
        'show_file_link' => NULL,
        'file' => NULL,
        'show_flexpaper' => NULL,
      ),
    ),
  );
}

/**
 * Implements template_preprocess_HOOK() for theme_flexpaper_container().
 */
function template_preprocess_flexpaper_container(&$variables) {
  $file = $variables['file'];
  if ($variables['show_file_link']) {
    $variables['file_link'] = theme('file_link', array(
      'file' => $file,
      'icon_directory' => variable_get('file_icon_directory', drupal_get_path('module', 'file') . '/icons'),
    ));
  }
  else {
    $variables['file_link'] = FALSE;
  }
}

/**
 * Helper function. Count number of pages in PDF file.
 */
function _flexpaper_get_pdf_pages_number($filepath) {
  // This is a helper function. So, if something goes wrong here we can continue
  // without knowledge about the exact number of pages. That's why @ operator is
  // here.
  $stream = @fopen($filepath, "r");
  $pdf_content = @fread($stream, filesize($filepath));
  $first_value = 0;
  $second_value = 0;
  if (preg_match("/\/N\s+([0-9]+)/", $pdf_content, $matches)) {
    $first_value = $matches[1];
  }

  if (preg_match_all("/\/Count\s+([0-9]+)/s", $pdf_content, $matches)) {
    $second_value = max($matches[1]);
  }
  $max = (($second_value != 0) ? $second_value : max($first_value, $second_value));
  @fclose($stream);
  if ($max == 0) {
    if (extension_loaded('imagick')) {
      try {
        $im = new imagick($filepath);
        $max = $im->getNumberImages();
      }
      catch (Exception $ex) {
        watchdog('flexpaper', 'Error in attempt to count number of pages using imagick. Exception: %info', array('%info' => $ex->getMessage()), WATCHDOG_ERROR);
      }
    }
  }
  return $max;
}
