<?php


function openerp_debug_menu(){
 $items = array();

 $items['admin/config/openerp/debug'] = array(
    'title' => 'OpenERP debug',
    'description' => 'OpenERP debug page.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('openerp_debug_config_form'),
    'access arguments' => array('access content'),
);
return $items;
}

function openerp_debug_config_form($form, &$form_state){
 $form = array();
$models = _openerp_get_models();
 $form['openerp_debug'] = array(
  '#type' => 'fieldset',
  '#title' => t('Debug'),
);
 $form['openerp_debug']['models'] = array(
  '#type' => 'select',
  '#title' => t('OpenERP models'),
  '#options' => $models,
);
 $form['submit'] = array(
     '#type' => 'button',
     '#value' => t('Get info'),
     '#ajax' => array(
      'callback' => 'openerp_debug_get_info',
      'wrapper' => 'openerp_info',
      'method' => 'replace',
      'effect' => 'fade',
      '#suffix' => '<br>',
     ),
 );
 $form['openerp_info_markup'] = array(
     '#markup' => '<p id="openerp_info"></p>',
 );
 return $form;
}


function openerp_debug_get_info($form, &$form_state){
// new OpenERP connection
$proxy = OpenERPProxy::getProxy();
if ( ($r = $proxy->page($form_state['values']['models'], array(), 0, 500)) === FALSE ) {
//if ( ($r = $proxy->search('ir.model.fields', array('&' => array('model','=',$form_state['values']['models'])), 0, 40)) === FALSE ) {
  // error, print error message
$ret= OpenERPProxy::message();
   return '<p id="openerp_info"><pre>'.print_r($ret, TRUE).'</pre></p>';
}
else {

$ret = '<table id="openerp-'.$delta.'">';
$ret .= '<tr>';
  foreach ( $r[0] as $name => $val ) {
     $ret .=   '<th>'.$name.'</th>';
  }

$ret .= '</tr>';
  // data
  foreach ( $r as $data ) {
$ret .= '<tr>';
    foreach ( $data as $name => $val ) {
      $ret .= '<td>'. ( is_array($val) ? implode(', ', $val) :  $val ) .'</td>';
    }
    $ret .= '</tr>';
  }

$ret .= '</table>';


//watchdog('table', print_r($ret, TRUE));
        return '<p id="openerp_info">'.$ret.'</p>';
}
}
