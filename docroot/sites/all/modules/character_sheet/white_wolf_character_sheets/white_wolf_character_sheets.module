<?php
/**
 * @file
 * Code for the White Wolf Character Sheets feature.
 */

include_once 'white_wolf_character_sheets.features.inc';

/**
 * Implements hook_node_view().
 */
function white_wolf_character_sheets_node_view($node, $view_mode = 'full', $langcode) {
  if (_white_wolf_character_sheets_type($node->type) && $view_mode == 'full' ) {
    drupal_add_css(drupal_get_path('module', 'white_wolf_character_sheets') .
      '/css/white_wolf_character_sheets.css');
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function white_wolf_character_sheets_form_node_form_alter(&$form, &$form_state, $form_id) {
  // Check to see if this node type is a rpg chatroom.
  if (_white_wolf_character_sheets_type($form['#node']->type) ) {
    $form['#after_build'][] = '_white_wolf_character_sheets_form_node_form_alter_after_build';
  }
}

/**
 * After build handler.
 */
function _white_wolf_character_sheets_form_node_form_alter_after_build($form, $form_state) {
  drupal_add_css(drupal_get_path('module', 'white_wolf_character_sheets') .
    '/css/white_wolf_character_sheets.css');
  return $form;
}

/**
 * Helper function, determine if this type is a WW sheet.
 */
function _white_wolf_character_sheets_type($type) {
  $types = array(
    'changeling_character_sheet',
    'hunter_character_sheet',
    'mage_character_sheet',
    'vampire_character_sheet',
    'werewolf_character_sheet',
  );
  if (in_array($type, $types)) {
    return TRUE;
  }
  return FALSE;
}

/**
 * Implements hook_character_sheet_register_systems().
 */
function white_wolf_character_sheets_character_sheet_register_systems() {
  $xp_types = array('xp'); // Only the one type.
  foreach ($xp_types as $key => $type) {
    $xp_types[$key] = trim($type);
  }
  $system['white_wolf_character_sheets'] = array(
    'name' => 'White Wolf character sheet',
    'description' => 'White Wolf system featuring a XP tracker for attribute and skill fields.',
    'xp' => array(
      'types' => $xp_types,
    ),
  );
  return $system;
}

/**
 * Implements hook_form_FORMID_alter().
 */
function white_wolf_character_sheets_form__character_sheet_owner_form_alter(&$form, &$form_state) {
  $form['change_ownership'] = array(
    '#type' => 'fieldset',
    '#title' => 'Change Ownership',
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
  );
  if (isset($form['owner_name'])) {
    $form['change_ownership']['owner_name'] = $form['owner_name'];
    unset($form['owner_name']);
  }
  if (isset($form['submit'])) {
    $form['change_ownership']['submit'] = $form['submit'];
    unset($form['submit']);
  }
  if (isset($form['character_sheet_log'])) {
    $form['moderation_log'] = array(
      '#type' => 'fieldset',
      '#title' => 'Moderation Log',
      '#collapsible' => TRUE,
      '#collapsed' => TRUE,
    );
    $form['moderation_log']['character_sheet_log'] = $form['character_sheet_log'];
    unset($form['character_sheet_log']);
  }
}

/**
 * Implements hook_character_sheet_field_info().
 */
function white_wolf_character_sheets_character_sheet_field_info() {
  return array(
    'title' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
        'other' => DISABLE_SHEET,
      ),
    ),
    'field_nature' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_demeanor' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_strength' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 4,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_dexterity' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 4,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_stamina' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 4,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_charisma' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 4,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_manip' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 4,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_appear' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 4,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_percep' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 4,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_intel' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 4,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_wits' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 4,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_talent_name' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_talent_value' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'new' => 3,
        'cost' => 2,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_skill_name' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_skill_value' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'new' => 3,
        'cost' => 2,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_know_name' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_know_value' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'new' => 3,
        'cost' => 2,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_merit_flaw' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_willpower' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 1,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_back_name' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_back_value' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 3,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_gear' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_additional' => array( // Property
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_st_notes' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
/* Changeling */
    'field_court' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_legacies' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_house' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_glamour' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_banality' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_other_trait' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 1,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_realm_name' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_realm_value' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 1,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_art_name' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_art_value' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 1,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
/* Hunter */
    'field_virtue' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_creed' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_conviction' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_convict' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_mercy' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_vision' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_zeal' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_derangement' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_edge_name' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_edge_creed' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_edge_value' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 1,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_edge_trigger' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
/* Mage */
    'field_essence' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_tradition' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_sphere_corr' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'new' => 10,
        'cost' => 8,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_sphere_ent' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'new' => 10,
        'cost' => 8,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_sphere_for' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'new' => 10,
        'cost' => 8,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_sphere_lif' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'new' => 10,
        'cost' => 8,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_sphere_mat' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'new' => 10,
        'cost' => 8,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_sphere_min' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'new' => 10,
        'cost' => 8,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_sphere_prim' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'new' => 10,
        'cost' => 8,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_sphere_spi' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'new' => 10,
        'cost' => 8,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_sphere_time' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'new' => 10,
        'cost' => 8,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_arete' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 8,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_quint' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_paradox' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_res_dyn' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_res_ent' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_res_stat' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
/* Vampire */
    'field_clan' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_generation' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_hum_path' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 2,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_con_con' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 2,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_self_instinct' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 2,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_courage' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 2,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_disc_name' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_disc_value' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'new' => 10,
        'cost' => 7,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
/* Werewolf */
    'field_breed' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_auspice' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_tribe' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_gift' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 5,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_rage' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 1,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_gnosis' => array(
      'permissions' => array(
        'owner' => LIMIT_SHEET,
      ),
      'costs' => array(
        'xp_type' => 'xp',
        'cost' => 2,
        'value_callback' => '_white_wolf_character_sheet_field_value',
      ),
    ),
    'field_glory' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_honor' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_wisdom' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
    'field_rank' => array(
      'permissions' => array(
        'owner' => DISABLE_SHEET,
      ),
    ),
  );
}

 
/**
 * Value callback for determining costs. Modified from _character_sheet_calculate_field_value().
 */
function _white_wolf_character_sheet_field_value($field_info, $value) {
  if (!isset($value)) { return 0; }
  if (!is_numeric($value)) { return 0; }
  if (isset($field_info['costs']['cost_mode']) && $field_info['costs']['cost_mode'] == 'flat') {
    $total = $value * $field_info['costs']['cost'];
  }
  else {
    $total = 0;
    $current = 0;
    $cost_modifier = isset($field_info['costs']['cost']) ? $field_info['costs']['cost'] : 1;
    $step = isset($field_info['costs']['step']) ? $field_info['costs']['step'] : 1;
    $new = isset($field_info['costs']['new']) ? $field_info['costs']['new'] : $cost_modifier;
    while ($current < $value) {
      $current += $step;
      if ($current == 1) {
        $total += $current * $new;
      }
      else {
        $total += $current * $cost_modifier;
      }
    }
  }
  return $total;
}