<?php

/**
 * @file
 * Allows Extra validation with contact form.
 */

/**
 * Implements hook_help().
 *
 * Form help contact form validation.
 */
function contact_extra_validation_help($path, $arg) {
  switch ($path) {
    case 'admin/help#contact_extra_validation':
      // Return a line-break version of the module README.txt
      return check_markup(file_get_contents(dirname(__FILE__) . "/README.txt"));
  }
}

/**
 * Implements hook_menu().
 *
 * Define new menu item.
 * Existing menu items are modified through hook_menu_alter().
 */
function contact_extra_validation_menu() {
  $items = array();
  // Start with the config menu item, put under Content form.
  $items['admin/structure/contact/validation'] = array(
    'title' => 'Contact Form Extra Validation',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('contact_extra_validation_admin_configure'),
    'access arguments' => array('administer site configuration'),
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Form alter to add contact form validation.
 */
function contact_extra_validation_form_contact_site_form_alter(&$form, &$form_state, $form_id) {
  $form['#validate'][] = 'contact_extra_validation_validate_contact_request';
  $contact_extra_validation_body = variable_get('contact_extra_validation_body_field', 0);
  if (isset($contact_extra_validation_body['body_limit']) && $contact_extra_validation_body['body_limit'] > 1) :
    $form['message']['#description'] = t('Word limit for this text-area is <span id="chars">@limit</div>', array('@limit' => $contact_extra_validation_body['body_limit']));
    $form['message']['#attached']['js'] = array(array('contact_validation' => array('limit' => $contact_extra_validation_body['body_limit'])), array('type' => 'setting'));
    $form['message']['#attached']['js'][] = array(drupal_get_path('module', 'contact_extra_validation') . '/js/admin.js');
  endif;
}

/**
 * Callback for _contact_validation_validation_extra().
 */
function contact_extra_validation_validate_contact_request(&$form, &$form_state) {
  $contact_extra_validation_title = variable_get('contact_extra_validation_title_field', 0);
  if (isset($contact_extra_validation_title['numeric']) && $contact_extra_validation_title['numeric'] == 1) :
    if (preg_match('/[0-9]+/', $form_state['values']['name'])) :
      form_set_error('name', t('Numeric letters are not allowed in this field.'));
    endif;
  endif;
  if ($contact_extra_validation_title['special'] == 1) :
    if (preg_match('/[\'^£$%&*()}{@#~?><>,|=_+¬-]/', $form_state['values']['name'])) :
      form_set_error('name', t('Special characters are not allowed in this field.'));
    endif;
  endif;
}

/**
 * Implements contact_validation_admin_configure().
 */
function contact_extra_validation_admin_configure() {
  $contact_extra_validation_title = variable_get('contact_extra_validation_title_field', 0);
  $contact_extra_validation_body = variable_get('contact_extra_validation_body_field', 0);
  $contact_extra_validation_numeric = ($contact_extra_validation_title['numeric']) ? $contact_extra_validation_title['numeric'] : 0;
  $contact_extra_validation_special = ($contact_extra_validation_title['special']) ? $contact_extra_validation_title['special'] : 0;
  $contact_extra_validation_body_limit = ($contact_extra_validation_body['body_limit']) ? $contact_extra_validation_body['body_limit'] : '';
  $form['contact_extra_validation_title_field'] = array(
    '#type' => 'fieldset',
    '#title' => t('Title field validation'),
    '#collapsible' => TRUE,
    '#collapsed' => FALSE,
    '#tree' => TRUE,
  );

  // Set on/off for numeric check.
  $form['contact_extra_validation_title_field']['numeric'] = array(
    '#type' => 'checkbox',
    '#title' => t('Numeric latters are not allow.'),
    '#default_value' => $contact_extra_validation_numeric,
  );

  // Set on/off for special char check.
  $form['contact_extra_validation_title_field']['special'] = array(
    '#type' => 'checkbox',
    '#title' => t('special characters are not allow.'),
    '#default_value' => $contact_extra_validation_special,
  );
  $form['contact_extra_validation_body_field'] = array(
    '#type' => 'fieldset',
    '#title' => t('Body field validation'),
    '#collapsible' => TRUE,
    '#collapsed' => FALSE,
    '#tree' => TRUE,
  );

  // Set Limit of body.
  $form['contact_extra_validation_body_field']['body_limit'] = array(
    '#type' => 'textfield',
    '#title' => t('Limit for body text area'),
    '#default_value' => $contact_extra_validation_body_limit,
  );
  return system_settings_form($form);
}
