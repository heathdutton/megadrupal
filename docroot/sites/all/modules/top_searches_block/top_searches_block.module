<?php
/**
 * Implementation of hook_block_info().
 */
function top_searches_block_block_info() {
  // Define the block.
  $blocks['top_searches'] = array(
    'info' => t('Top searches'),
  );
  return $blocks;
}

/**
 * Implementation of hook_block_view().
 */
function top_searches_block_block_view($delta='') {
  // Display the block.
  $block = array();
  switch ($delta) {
    case 'top_searches':
      $timestamp = db_select('watchdog', 'w');
      $timestamp->addExpression('MIN(timestamp)');
      $timestamp = $timestamp
        ->condition('type', 'search')
        ->execute()
        ->fetchAssoc();

      $query = db_select('watchdog', 'w')->extend('PagerDefault')->extend('TableSort');
      $query->addExpression('COUNT(wid)', 'count');
      $query = $query
        ->fields('w', array('message', 'variables'))
        ->condition('w.type', 'search')
        ->groupBy('message')
        ->groupBy('variables')
        ->limit(10)
        ->orderByHeader(array(
          array('data' => t('Count'), 'field' => 'count', 'sort' => 'desc'),
          array('data' => t('Message'), 'field' => 'message'),
        ));

      $result = $query->execute();
      $items = array();
      foreach ($result as $dblog) {
        $v = unserialize($dblog->variables);
        $keys = $v['%keys'];
        if (isset($v['%type']) && $v['%type'] == 'Content') {
          $keys = l($keys, 'search/node/' . $keys);
        }
        else if (isset($v['%type']) && $v['%type'] == 'Files') {
          $keys = l($keys, 'search/file/' . $keys);
        }
        else if (isset($v['%type']) && $v['%type'] == 'Users') {
          $keys = l($keys, 'search/user/' . $keys);
        }
        $items[] = $keys . ' <span class="count">(' . $dblog->count . ')</span>';
      }

      if (!empty($items)) {
        $block = array(
          'subject' => t('Top searches') . ' <em>' . t('since') . ' ' . format_date($timestamp['expression'], 'short') . '</em>',
          'content' => theme('item_list', array('items' => $items, 'type' => 'ol')),
        );
      }
      break;
  }
  return $block;
}
