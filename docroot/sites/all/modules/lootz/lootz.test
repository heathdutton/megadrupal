<?php


/**
 * @file
 * Tests for the Lootz module.
 */

/**
 * Test 3rd party DB functionality.
 */
class LootzTestCase extends DrupalWebTestCase {
  public static function getInfo() {
    return array(
      'name' => t('Item DB functionality'),
      'description' => t('Test the ability to grab data from available 3rd-party services.'),
      'group' => t('Lootz'),
    );
  }

  function setUp() {
    parent::setUp('lootz');
  }

  /**
   * Test high-level filter functionality.
   */
  function testItemDb() {
    // Enable Lootz filter.
    $admin = $this->drupalCreateUser(array('administer filters', 'create article content'));
    $this->drupalLogin($admin);
    $this->drupalGet('admin/settings/filter/1');
    $this->drupalPost('admin/settings/filter/1', array('filters[lootz/0]' => TRUE), t('Save configuration'));

    // Set to Wowhead.
    variable_set('lootz_item_database', 'wowhead');

    // Make sure [item][/item] is properly converted to a link.
    $node = $this->createLootzNode('Earthwarden');
    $this->drupalGet('node/' . $node->nid);
    $this->assertRaw('<a href="http://www.wowhead.com/?item=29171" id="item_29171" class="lootz lootz-epic"><span class="lootz lootz-epic">[Earthwarden]</span></a>', t('Properly converted [item][/item] tag to a link to Wowhead.'));

    // Clear caches.
    cache_clear_all('lootz_ids', 'cache');
    cache_clear_all('1:', 'cache_filter', TRUE);

    // Set to WowDB.
    variable_set('lootz_item_database', 'wowdb');
    $node = $this->createLootzNode('Small Egg');
    $this->drupalGet('node/' . $node->nid);
    $this->assertRaw('<a href="http://www.wowdb.com/item.aspx?id=6889" id="item_6889" class="lootz lootz-common"><span class="lootz lootz-common">[Small Egg]</span></a>', t('Properly converted [item][/item] tag to a link to WoWDB.'));
  }

  /**
   * Create a node with [item][/item] elements in the body.
   */
  function createLootzNode($item) {
  
    // Create content.
    return $this->drupalCreateNode(array('body' => 'TEST TEST TEST [item]' . $item . '[/item] TEST TEST'));
  }
}