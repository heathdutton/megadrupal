<?php

/**
 * @file
 * Unit and Web testcases for the Admin UI.
 */

require_once 'views_fast_forward_test_case.php';

/**
 * @class
 *
 * This suite tests this module's Admin UI when editing an actual View.
 */
class ViewsFastForwardAdminUI extends ViewsFastForwardTestCase {
  private $view;

  static public function getInfo () {
    return array(
      'name' => 'Views Fast Forward Unit Tests - Admin UI',
      'description' => 'Unit Tests for the Views Admin UI of Views Fast Forward',
      'group' => 'Views Fast Forward',
    );
  }

  /**
   * Setup function
   *
   * Create some nodes and a view based upon those nodes.
   */
  public function setUp ($modules = array()) {
    parent::setUp();
    $this->view = $this->create_node_view();
  }

  function tearDown() {
    parent::tearDown();
    $this->view->delete();
  }

  // View UI tests below.

  /**
   * See if the default settings are there when we first setup Views Fast Forward.
   */
  public function testDefaultSettings() {
    // Load the basic View to be altered.
    $view = views_get_view('auto-view', TRUE);

    // Add preset page display to the View.
    $handler = $this->create_page_display_fields($view);
    views_save_view($view);

    // Now login as Admin.
    $user = $this->drupalCreateUser(array('administer views'));
    $this->drupalLogin($user);

    // Navigate to the display
    $this->drupalGet('/admin/structure/views/view/auto-view/edit/page_1');

    // Check if "disabled" is present (not water-proof).
    $this->assertLink('Disabled');
    $this->assertLinkByHref('/admin/structure/views/nojs/display/auto-view/page_1/views_fast_forward');

    // Open the Views Fast Forward settings page.
    $this->drupalGet('/admin/structure/views/nojs/display/auto-view/page_1/views_fast_forward');

    // Verify defaults
    $this->assertCheckbox('edit-ff-enabled', FALSE);
    $this->assertCheckbox('edit-ff-manual', FALSE);
    $this->assertCheckbox('edit-ff-tokenize', FALSE);
    $this->assertTextbox('edit-ff-path', '');
  }

  public function testEditingSettings() {
    // Load the basic View to be altered.
    $view = views_get_view('auto-view', TRUE);

    // Add preset page display to the View.
    $handler = $this->create_page_display_fields($view);
    views_save_view($view);

    // Now login as Admin.
    $user = $this->drupalCreateUser(array('administer views'));
    $this->drupalLogin($user);

    // Open the Views Fast Forward settings page and save some new data.
    $data = array(
      'ff_enabled' => '1',
      'ff_manual' => '1',
      'ff_path' => 'test'
    );
    $this->drupalPost('/admin/structure/views/nojs/display/auto-view/page_1/views_fast_forward', $data, t('Apply'));

    // Re-open the Views Fast Forward settings page for inspection.
    $this->drupalGet('/admin/structure/views/nojs/display/auto-view/page_1/views_fast_forward');

    // Enabled it and set a manual path.
    $this->assertCheckbox('edit-ff-enabled', TRUE);
    $this->assertCheckbox('edit-ff-manual', TRUE);
    $this->assertCheckbox('edit-ff-tokenize', FALSE);
    $this->assertTextbox('edit-ff-path', 'test');
  }
}