<?php

/**
 * @package    d4os_ui_empty_trash
 * @copyright Copyright (C) 2015 Wene - ssm2017 Binder ( S.Massiaux ). All rights reserved.
 * @link      http://www.d4os.org
 * @license   GNU/GPL, http://www.gnu.org/licenses/gpl-2.0.html
 * D4os is free software. This version may have been modified pursuant
 * to the GNU General Public License, and as distributed it includes or
 * is derivative of works licensed under the GNU General Public License or
 * other free or open source software licenses.
 */

/**
 * Implementation of hook help
 */
function d4os_ui_empty_trash_help($path, $arg) {
  switch ($path) {
    case 'admin/help#d4os_ui_empty_trash':
      return '<p>' . t('Allow the users to delete their trash can when inventory is locked by Robust.') . '</p>';
  }
}

/**
 * Implements hook_block_info().
 */
function d4os_ui_empty_trash_block_info() {
  $blocks = array();
  $blocks['d4os_ui_empty_trash'] = array(
    'info' => t('Empty trash')
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function d4os_ui_empty_trash_block_view($delta = '') {
  $block = array();
  switch ($delta) {
    case 'd4os_ui_empty_trash':
      if (arg(1) == $GLOBALS['user']->uid) {
        $block['subject'] = t('Empty trash');
        $block['content'] = drupal_get_form('d4os_ui_empty_trash_form');
      }
      break;
  }
  return $block;
}

function d4os_ui_empty_trash_form($form, &$form_state) {
  $form['select'] = array(
    '#type' => 'checkboxes',
    '#title' => t('Folders'),
    '#options' => array(
      'lost_and_found' => t('Lost and found'),
      'trash' => t('Trash'),
    )
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Empty'),
  );
  $form['info'] = array(
    '#markup' => '<div class="messages warning">'. t('You need to clear your cache in the viewer after emptying the folders.'). '</div>'
  );

  return $form;
}

function d4os_ui_empty_trash_form_validate($form, &$form_state) {
  if (!$form_state['values']['select']['lost_and_found'] &&
    !$form_state['values']['select']['trash']) {
    form_set_error('select', t('You must select one folder to empty'));
  }
}

function d4os_ui_empty_trash_form_submit($form, &$form_state) {
  global $user;
  // get the user uuid
  $uuid = db_query("SELECT UUID FROM {d4os_ui_users} WHERE uid=:uid", array(':uid' => $user->uid))->fetchField();
  if ($uuid !== FALSE) {
    $params = array(
      'uuid' => $uuid,
      'select' => $form_state['values']['select']
    );
    $inventory = D4OS_IO::create('Inventory');
    $inventory->empty_trash($params);
  }
}