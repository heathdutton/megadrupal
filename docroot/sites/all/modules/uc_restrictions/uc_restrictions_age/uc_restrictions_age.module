<?php
// $Id$

/**
 * @file
 * Allows a site to limit the sale of goods to people below a given age.
 *
 */

/******************************************************************************
 * Drupal Hooks                                                               *
 */

/**
 * Implements hook_form().
 *
 * @param string $form_id
 * @param array $form
 */
function uc_restrictions_age_form_alter(&$form, $form_state, $form_id) {
  switch ($form_id) {
    case 'uc_restrictions_admin_settings':
      // Admin Settings
      $form['age'] = array(
        '#title' => t('Age Requirement'),
        '#type' => 'fieldset',
        '#collapsible' => TRUE,
        '#collapsed' => TRUE,
        '#weight' => -5,
      );

      $form['age']['uc_restrictions_age_required'] = array(
        '#title' => t('Age'),
        '#type' => 'textfield',
        '#default_value' => variable_get('uc_restrictions_age_required', ''),
        '#description' => t('To enable age requirement, enter the required age.'),
      );
      
      if ($vid = variable_get('uc_catalog_vid','')) {
        $form['age']['uc_restrictions_age_tid'] = array(
          '#key_type' => 'associative',
          '#multiple_toggle' => '1',
          '#type' => 'select',
          '#options' => _uc_restrictions_get_terms_for_select(),
          '#title' => t('Affected Product Categories for Age Restriction'),
          '#default_value' => variable_get('uc_restrictions_age_tid', NULL),
          '#multiple' => TRUE,
          '#description' => t('Categories associated with items that cannot be ordered by persons under the age restriction.
           <br />NOTE: Selecting a category that has descendents will affect all child categories; it is therefore not necessary to select child categories of an affected parent.'),
        );
      }

      $form['age']['uc_restrictions_age_redirect'] = array(
        '#title' => t('Age Requirement Redirection Path'),
        '#type' => 'textfield',
        '#default_value' => variable_get('uc_restrictions_age_redirect', ''),
        '#description' => t('Enter the path to the page to which you want to redirect if the user does not meet age requirements.  You must ' . l('create', 'node/add/page', array('target' => '_new')) . ' this page.'),
      );

      break;

    /*case 'uc_cart_checkout_form':
      // Checkout Form
      // This should probably be done with a checkout pane hook instead.
      //$form['#validate'][] = 'uc_restrictions_age_checkout_form_validate';

      if (variable_get('uc_restrictions_age_required', FALSE)
           && uc_restrictions_contains_restricted('uc_restrictions_age_tid', unserialize($form['cart_contents']['#value']))) {

        //if ($form['#post']['panes']['customer']['age'][1] || $_COOKIE['uc_restrictions_age_pass'] == 1) {
          //$default_checked = 1;
        //}
        if ($_COOKIE['uc_restrictions_age_pass'] == 1) {
          $default_checked = 1;
        }

        $form['panes']['customer']['age'] = array(
          '#title' => t('Only persons ' . variable_get('uc_restrictions_age_required', '') . ' years of age or older may complete this order'),
          '#type' => 'checkboxes',
          '#options' => array(1 => t('I am ' . variable_get('uc_restrictions_age_required', '') . ' years of age or older')),
          '#required' => TRUE,
          '#description' => $link,
          '#default_value' => array($default_checked),
        );

      }
      break;*/

    case 'uc_restrictions_user_form':
      // User "Overlay" Form
      if (variable_get('uc_restrictions_age_required', FALSE)) {
        $form['age'] = array(
          '#title' => t('Are you ' . variable_get('uc_restrictions_age_required', '') . ' years of age or older?'),
          '#type' => 'select',
          '#options' => array(
            1 => 'Yes',
            0 => 'No',
          ),
          '#required' => TRUE,
        );
        // put this one first
        $form['#submit'][] = 'uc_restrictions_age_user_form_submit';
      }
      break;
  }
}

function uc_restrictions_age_uc_checkout_pane() {
  $panes['age_requirement'] = array(
    'callback' => 'uc_restrictions_age_uc_checkout_pane_callback',
    'title' => t('Age Requirement'),
    'desc' => t('Only persons ' . variable_get('uc_restrictions_age_required', '') . ' years of age or older may complete this order'),
    'weight' => 1,
    'collapsible' => FALSE,
  );
  return $panes;
}

function uc_restrictions_age_uc_checkout_pane_callback($op, $order, $form = NULL, &$form_state = NULL) {
  if (is_object($order)) {
    $products = $order->products;
  }
  else {
    $products = array();
  }
  if (variable_get('uc_restrictions_age_required', FALSE)
  && uc_restrictions_contains_restricted('uc_restrictions_age_tid', $products)) {
    switch ($op) {
      case 'view':
        $default_checked = 0;
        if (isset($_COOKIE['uc_restrictions_age_pass'])) {
          $default_checked = 1;
        }
        
        ctools_include('modal');
        ctools_include('ajax');
        $link = ctools_modal_text_button(t('(details)'), variable_get('uc_restrictions_age_redirect', '') .'/nojs', 'details');
        
        $contents['age'] = array(
            '#type' => 'checkboxes',
            '#options' => array(1 => t('I am ' . variable_get('uc_restrictions_age_required', '') . ' years of age or older')),
            '#required' => TRUE,
            '#description' => $link,
            '#default_value' => array($default_checked),
        );
        return array('description' => '', 'contents' => $contents);

      case 'process':
        $pane = $form_state['values']['panes']['age_requirement'];
        if ($pane['age'][1] == '0') {
          form_set_error('panes][age_requirement', t('You must be '. variable_get('uc_restrictions_age_required', '') . ' years of age or older.'));
        }
        break;
    }
  }
}


/*******************************************************************************
 * Module and Helper Functions
 */

/**
 * Submit handler callback for the "overlay" form
 *
 * @param array $form
 * @param array $form_values
 */
function uc_restrictions_age_user_form_submit($form, &$form_state) {
  if (variable_get('uc_restrictions_age_required', FALSE) & !$form_state['values']['age']) {
    $form_state['values']['redirect'] = variable_get('uc_restrictions_age_redirect', 'age-requirement');
  }
  else {
    setcookie('uc_restrictions_age_pass', '1', 0, '/');
    $form_state['values']['message'] .= '<p>'. t('Thank you for confirming your age.') .'</p>';
  }
}
