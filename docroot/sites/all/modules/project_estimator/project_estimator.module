<?php

/**
 * @file
 * module to display the statistics in a Web page.
 *
 * This module can be used to count the number of lines and characters contained
 * in the files of a project. It can traverse a given project directory
 * recursively and process files that match a given file name pattern. The
 * module counts the number of lines of the matched files and the total number
 * characters excluding white space or just considering alphabetic characters.
 * The module can also display the statistics in a Web page.
 */

/*
 * Implements of hook_perm().
 */
function project_estimator_perm() {
  return array('access project estimator',);
}

/**
 * Implements hook_menu().
 */
function project_estimator_menu() {
  $items = array();
  $items['admin/settings/project-estimator'] = array(
    'title' => 'Project Estimator',
    'description' => 'See your project ',
    'page callback' => 'project_estimator_display_project_statistic',
    'access arguments' => array('access project estimator'),
    'type' => MENU_NORMAL_ITEM,
  );
  $items['admin/settings/project-estimator/statistic'] = array(
    'title' => 'Statistics',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => 0,
  );
  $items['admin/settings/project-estimator/settings'] = array(
    'title' => 'Settings',
    'description' => 'Configure your project estimator.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('project_estimator_admin_settings'),
    'access arguments' => array('access project estimator'),
    'type' => MENU_LOCAL_TASK,
    'weight' => 1,
  );
  return $items;
}

/**
 * function to display the statistics in a Web page
 * @return string
 *   a tabular format data of statistics containing number of lines, number of
 * characers, file size
 */
function project_estimator_display_project_statistic() {
  require_once dirname(__FILE__) .'/includes/project_estimator.php';
  drupal_add_css(drupal_get_path('module', 'project_estimator') . '/css/project-estimator-style.css', 'module');
  $pe = new ProjectEstimator();

  $pe->root = getcwd();
  $pe->checkSubdirs = TRUE;
  $options = project_estimator_file_extension_explode("\n", variable_get('project_estimator_file_extension', project_estimator_file_default_extensions()));
  $pe->filters = $options;

  $pe->getInfo();

  return theme('display_project_statistic', array('pe' => $pe));
}

/**
 * Project Estimator admin settings
 */
function project_estimator_admin_settings() {
  $form = array();
  $form['extensions'] = array(
    '#type' => 'fieldset',
    '#title' => t('File extensions'),
    '#description' => t('Here you can map specific file extension type.'),
  );
  $form['extensions']['file_extension'] = array(
    '#type' => 'textarea',
    '#title' => t('Available extensions for searching files'),
    '#description' => t('Enter one extension per line. Each resolution must be in the form of <code>*.</code><code>extension</code>. Example dimensions: <code>*.module</code>.'),
    '#default_value' => variable_get('project_estimator_file_extension', project_estimator_file_default_extensions()),
    '#wysiwyg' => FALSE,
  );
  return system_settings_form($form);
}

/**
 * Implements hook_theme().
 */
function project_estimator_theme($existing, $type, $theme, $path) {
  return array(
    'display_project_statistic' => array(
      'template' => 'display-project-statistic',
      'variables' => array('pe' => NULL),
    ),
  );
}

/**
 * Default file extensions.
 */
function project_estimator_file_default_extensions() {
  return "*.module\n*.info\n";
}

/**
 * #options helper function to set our key=value for the form api.
 */
function project_estimator_file_extension_explode($delimeter, $extension) {
  $options = array();
  $values = explode($delimeter, $extension);
  foreach ($values as $value) {
    // Lets check we have a value and its in the right format.
    if (!empty($value) && project_estimator_file_extension_format_right($value)) {
      $format = explode('.', $value, 2);
      $options[] = "#\." . trim($format[1]) . '#i';
    }
  }
  return $options;
}

/**
 * function to check extension format
 */
function project_estimator_file_extension_format_right($value) {
  $format = explode('.', $value, 2);
  if (!isset($format[0]) || trim($format[0] != '*')) {
    return FALSE;
  }
  return TRUE;
}
