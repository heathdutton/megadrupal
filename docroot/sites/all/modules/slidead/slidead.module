<?php
/**
 * @file
 * Functions and forms for SlideAd.
 */

/**
 * Implements hook_help().
 */
function slidead_help($path, $arg) {
  switch($path) {
    case 'admin/help#slidead':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('<strong>Slide Ad</strong> is a simple module that allows show a little box with your system or custom blocks content in the bottom of page while user is scrolling.') . '</p>';
      $output .= '<p>' . t('You can configure the design, width or more using CSS and HTML.') . '</p>';
      return $output;

    case 'admin/config/user-interface/slidead':
      return '<p>' . t('In this page you can configure the width of "Slide Ad" Box. The content that "Slide Ad" show is inside block assigned to "Slide Ad" region.') . '</p>';
  }
}

/**
 * Implements hook_permission().
 */
function slidead_permission() {
  return array(
    'administer slidead' => array(
      'title' => t('Administer Slide Ad'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function slidead_menu() {
  $items = array();
  $items['admin/config/user-interface/slidead'] = array(
    'title' => 'Slide Ad',
    'description' => 'Config values for Slide Ad',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('slidead_admin'),
    'access arguments' => array('administer slidead'),
  );
  return $items;
}

/**
 * Create the form for the Slide Ad settings.
 */
function slidead_admin() {
  $form = array();
  $form['slidead_width'] = array(
    '#type' => 'textfield',
    '#title' => t('The width in pixels'),
    '#size' => 30,
    '#maxlength' => 30,
    '#default_value' => variable_get('slidead_width', 300),
    '#required' => TRUE,
  );
  return system_settings_form($form);
}

/**
 * Implements hook_system_info_alter().
 */
function slidead_system_info_alter(&$info, $file, $type) {
  if ($type == 'theme' && isset($info['regions'])) {
    $info['regions'] += array(
      'slidead' => t('Slide Ad'),
    );
  }
}

/**
 * Implements hook_page_build().
 *
 * Show the ad.
 */
function slidead_page_build(&$page) {
    drupal_add_js(array('slideAd' => array('width' => variable_get('slidead_width', 300))), 'setting');

    // Place the ad on page_bottom.
    $page['page_bottom']['slidead'] = array(
      '#type' => 'markup',
      '#markup' => theme("slidead"),
    );
}

/**
 * Implements hook_theme().
 */
function slidead_theme($existing, $type, $theme, $path) {
  return array(
    'slidead' => array(
      'arguments' => array(),
    ),
  );
}

/**
 * Theming the slidead-region.
 */
function theme_slidead() {
  $block_list = block_list('slidead');

  if (empty($block_list)) {
    return '';
  }

  // The HTML.
  $output = '<div id="slidead-popup" class="block">
      <div id="pop-close"><span>X</span></div>';

  foreach ($block_list as $block) {
    $output .= "\n<h2>" . $block->subject . "</h2>\n" .
       render($block->content);
  }
  $output .= '</div>';
  return $output;
}
