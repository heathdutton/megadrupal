<?php

// $Id$

/**
 * @file
 * A module to allow Richland Library users to auto register for a new library card
 *
 * After a user enters the required information, the module will do the following:
 *
 * 1.  Check to see if the address is in the specified county (via Smarty Streets module)
 * 2.  (Phase II) If address is not in the specified county, direct client to payment portal to collect $65 yearly fee
 * 3.  Register user and issue library card number
 * 4.  Update Polaris with new library card record
 *
*/

/**
 * Implements hook_help().
*/
function polaris_auto_register_help($path, $arg) {
  if ($path == 'admin/help#polaris_auto_register') {
    return t('Allow new library users to self register for a library card using the Polaris API.');
  }
}

/**
 * Implements hook_menu().
 */
function polaris_auto_register_menu() {
  $items['admin/config/content/polaris_auto_register_settings'] = array(
    'title' => 'Polaris Auto Register Settings',
    'description' => 'Settings for Polaris Auto Register module',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('polaris_auto_register_settings_form'),
    'access arguments' => array('manage Polaris API settings'),
    'file' => '/inc/polaris_auto_register.admin.inc',
  );
  $items['polaris_auto_register'] = array(
    'title' => 'Library Card Registration',
    'description' => 'Register for a library card',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('polaris_auto_register_form'),
    'access arguments' => array('Register for a Library Card'),
    'file' => '/inc/polaris_auto_register.page.inc',
  );
  $items['polaris-auto-register/lost-card-number'] = array(
    'title' => 'Recover A Lost Library Card Number',
    'description' => 'Recover a lost library card number',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('polaris_auto_register_form'),
    'access arguments' => array('Register for a Library Card'),
    'file' => '/inc/polaris_auto_register.page.inc',
  );
  $items['polaris-auto-register/successful-registration'] = array(
    'title' => 'Congratulations!',
    'description' => 'Thank you message after successful registration',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('polaris_auto_register_thank_you'),
    'access arguments' => array('Register for a Library Card'),
    'file' => '/inc/polaris_auto_register_thank_you.page.inc',
  );
  $items['admin/reports/online_registration'] = array(
    'title' => 'Polaris Online Registration Count',
    'description' => 'View number of online registrations by month',
    'page callback' => 'polaris_online_registration_counts',
    'page arguments' => array('polaris_auto_register_counts'),
    'access arguments' => array('access site reports'),
    'file' => '/inc/polaris_auto_register_counts_page.inc',
  );
  $items['polaris-auto-register/reprint-card'] = array(
    'title' => 'Reprint My Library Card',
    'description' => 'Reprint a card',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('polaris_auto_register_reprint_barcode'),
    'access callback' => 'user_is_logged_in',
    'file' => '/inc/polaris_auto_register_reprint_barcode.page.inc',
  );
  // for AJAX call to check for existing registration
  $items['polaris-auto-register/check-email'] = array(
    'title' => 'Check Polaris for Existing Email',
    'page callback' => 'check_email',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    'file' => 'inc/polaris_auto_register_validate_email.inc',
  );
  // for AJAX call to send email for existing registration
  $items['polaris-auto-register/send-email'] = array(
    'title' => 'Send Email for Existing Barcode',
    'page callback' => 'send_email',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    'file' => 'inc/polaris_auto_register_validate_email.inc',
  );
  $items['polaris-auto-register/telephone-lookup'] = array(
    'title' => 'Library Card Number Lookup',
    'description' => 'Look up a library card number by telephone number',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('polaris_auto_register_form'),
    'access arguments' => array('lookup customers by telephone'),
    'file' => '/inc/polaris_auto_register.page.inc',
  );
  // for AJAX call to do telephone lookups
  $items['polaris-auto-register/telephone-lookup-ajax'] = array(
    'title' => 'Library Card Number Lookup',
    'page callback' => 'telephone_lookup',
    'access arguments' => array('lookup customers by telephone'),
    'type' => MENU_CALLBACK,
    'file' => 'inc/polaris_auto_register_validate_email.inc',
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function polaris_auto_register_permission() {
  return array(
    'manage Polaris API settings' => array(
      'title' => t('Manage Polaris API settings'),
      'description' => t('Set PAPI Access Key and Access ID for Polaris API.'),
    ),
    'Register for a Library Card' => array(
      'title' => t('Register online for a library card'),
      'description' => t('Register online for a library card.'),
    ),
    'lookup customers by telephone' => array(
      'title' => t('Lookup customers by telephone number'),
    ),
  );
}

function polaris_auto_register_cron() {

  // Housekeeping. Delete any existing .png files in the tmp directory
  $path = drupal_get_path('module', 'polaris_auto_register');
  $files = glob($path . '/tmp/*'); // get all file names

  foreach ($files as $file) { // iterate files
    if (is_file($file)) {
      unlink($file); // delete file
    }
  }

  // make note in watchdog
  watchdog('Polaris Auto Register', 'Barcode images deleted from /polaris_auto_register/tmp');

}

/**
 * Implements hook_form_alter().
 */
function polaris_auto_register_form_alter(&$form, &$form_state, $form_id) {
  switch($form_id) {
    case 'polaris_auto_register_form':
      $current_path = current_path();
      $custom_cards_path_images = '/'. drupal_get_path('module', 'custom_cards') . '/images/';
      if ($current_path == 'polaris-auto-register/lost-card-number') { // Only do this for the single instance of this form that we need.
        // Remove some of the original markup that was part of the form.
        $form['polaris_markup1']['#markup'] = '<p>Please fill out the form below in order to find and recover your lost library card number.</p>';
        unset($form['polaris_subtitle'], $form['polaris_markup3']);
        // Remove fields that were part of registration but not used for lost card numbers.
        unset($form['polaris_auto_register_phone_voice_2'], $form['polaris_auto_register_phone2_validation_msg'], $form['polaris_auto_register_add_phone_num'], $form['polaris_auto_register_street_one'], $form['clear_float4'], $form['polaris_auto_register_street_two'], $form['clear_float5'], $form['polaris_auto_register_city'], $form['polaris_auto_register_state'], $form['polaris_auto_register_postal_code'], $form['polaris_auto_register_zip_plus_four'], $form['polaris_auto_register_county'], $form['polaris_auto_register_country'], $form['clear_float7'], $form['clear_float8'], $form['polaris_auto_register_phone_voice_1'], $form['clear_float1a'], $form['polaris_auto_register_phone1_validation_msg'], $form['clear_float1b'], $form['polaris_auto_register_dob'], $form['clear_float3'], $form['polaris_auto_register_dob_warning']);
        // Change what the submit button does. See polaris_auto_register.js file for more modifications to how it works.
        $form['submit']['#attributes'] = array(
          'id' => 'polaris-auto-register-lost-card-lookup',
        );
        // Change the markup2 element to be just hidden.
        $form['polaris_markup2']['#prefix'] = '<div id="polaris_markup2" style="display: none;">';
        $form['polaris_markup2']['#markup'] = strip_tags($form['polaris_markup2']['#markup'], '<a>');
        $form['polaris_markup2']['#suffix'] = '</div>';
      }
      else if ($current_path == 'polaris-auto-register/telephone-lookup') { // Only do this for the single instance of this form that we need.
        // Remove some of the original markup that was part of the form.
        unset(
          $form['polaris_auto_register_name_first'],
          $form['polaris_auto_register_name_middle'],
          $form['polaris_auto_register_name_last'],
          $form['polaris_auto_register_email'],
          $form['polaris_markup1'],
          $form['polaris_markup2'],
          $form['polaris_subtitle'],
          $form['polaris_markup3'],
          $form['polaris_auto_register_phone_voice_2'],
          $form['polaris_auto_register_phone2_validation_msg'],
          $form['polaris_auto_register_add_phone_num'],
          $form['polaris_auto_register_street_one'],
          $form['clear_float2'],
          $form['clear_float3'],
          $form['clear_float4'],
          $form['clear_float5'],
          $form['polaris_auto_register_street_two'],
          $form['polaris_auto_register_city'],
          $form['polaris_auto_register_state'],
          $form['polaris_auto_register_postal_code'],
          $form['polaris_auto_register_zip_plus_four'],
          $form['polaris_auto_register_county'],
          $form['polaris_auto_register_country'],
          $form['clear_float7'],
          $form['clear_float8'],
          $form['clear_float1a'],
          $form['polaris_auto_register_phone1_validation_msg'],
          $form['clear_float1b'],
          $form['polaris_auto_register_dob'],
          $form['polaris_auto_register_dob_warning']
        );
        $form['polaris_auto_register_phone_voice_1']['#description'] = ''; // Just remove the description on this one.
        // Change what the submit button does. See polaris_auto_register.js file for more modifications to how it works.
        $form['submit']['#attributes'] = array(
          'id' => 'polaris-auto-register-staff-telephone-lookup',
        );
      }
      break;
    }
}
