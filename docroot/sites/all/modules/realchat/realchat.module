<?php
// $Id: realchat.module,v 1.2 2010/06/21 19:13:48 crotown Exp $
/**
 * @file
 * Module that allows users of a site to chat via a RealChat server
 */

/**
 * Implementation of hook_help()
 */
function realchat_help($path, $arg) {
  if ($path == 'admin/help#realchat') {
    $txt = 'This module provides a link to allow users to chat using a RealChat server.';
    return '<p>' . t($txt) . '</p>';
  }
}

/**
 * Implementation of hook_menu()
 */
function realchat_menu() {
  $items['chatnow_link'] = array(
   'title' => 'Chat now!',
   'page callback' => 'realchat_chatnow_link',
   'access arguments' => array('access content'),
   'type' => MENU_NORMAL_ITEM,
   );

  $items['admin/settings/realchat'] = array(
    'title' => 'RealChat',
    'description' => 'Configure chatting with RealChat',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('realchat_settings'),
    'access arguments' => array('administer site configuration'),
    'file' => 'realchat.admin.inc',
  );
  return $items;
}

/**
 * Callback to handle the Chat Now link
 */
function realchat_chatnow_link() {
  global $user, $base_url;

  // sanitize all components of the URL we are writing
  $auth_key = check_plain(variable_get('realchat_auth_key', ''));
  $chat_url = check_url(variable_get('realchat_chat_url', ''));
  $close_url = rawurlencode(check_url(sprintf("%s/%s", $base_url, variable_get('realchat_close_url', ''))));
  if (isset($user->name)) {
    $nickname = rawurlencode(check_plain($user->name));
  } else {
    $nickname = t('anonymous');
  }
  $profile_url = rawurlencode(check_url(sprintf("%s/?q=user/%d", $base_url, $user->uid)));
  // make avatarURL non-empty only if pictures support is enabled in user profiles
  $avatar_url = '';
  $picture_support = variable_get('user_pictures', 0);
  if ($picture_support && $user->picture) {
    $picture = file_load($user->picture);
    if ($style = variable_get('user_picture_style', '')) {
      $avatar_url = rawurlencode(check_url(image_style_url($style, $picture->uri)));
    }
  }
  // use HMAC authentication if and only if  the authorization key is given in admin settings
  $use_hmac = FALSE;
  if (isset($auth_key) && strlen($auth_key) > 0) {
    $use_hmac = TRUE;
  }

  if ($use_hmac) {
    $cp_id = substr(strrchr($chat_url, ','), 1);
    $auth_string = $cp_id . $nickname . $profile_url . $avatar_url . $auth_key . date('Ymd');
    $query = sprintf("&nn=%s&pu=%s&cu=%s&au=%s&hmac=%s", $nickname, $profile_url, $close_url, $avatar_url, md5($auth_string));
  }
  else {
    $query = sprintf("&nn=%s&pu=%s&cu=%s&au=%s", $nickname, $profile_url, $close_url, $avatar_url);
  }

//  $options = array();
//  $options['query'] = Array('q'=>Array($query));
  drupal_goto($chat_url.$query, Array('q'=>'')/*$options*/);
  return;
}
