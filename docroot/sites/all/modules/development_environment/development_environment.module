<?php

function development_environment_menu()
{
	$menu['admin/config/development/environment'] = array
	(
		'title' => 'Environment',
		'description' => 'Settings for development environments',
		'page callback' => 'drupal_get_form',
		'page arguments' => array('development_environment_admin_form'),
		'access arguments' => array('administer site configuration'),
	);

	return $menu;
}

function development_environment_admin_form($form, &$form_state)
{
	$defaults = variable_get('development_environment_elements', array());

	$form['development_environment_elements'] = array
	(
		'#tree' => TRUE,
	);
	$form['development_environment_elements']['suppress_email'] = array
	(
		'#type' => 'checkbox',
		'#title' => t('Suppress Email'),
		'#default_value' => isset($defaults['suppress_email']) ? $defaults['suppress_email'] : 1,
		'#description' => t('Checking this box will prevent the system from sending emails, and will log all emails to the !watchdog', array('!watchdog', l(t('Drupal log'), 'admin/reports/watchdog'))),
	);

	return system_settings_form($form);
}

function development_environment_init()
{
	$development_environment_defaults = 	variable_get('development_environment_elements', array());

	// Emails are suppressed by default, or when a user selects the suppress emails option on the module settings page
	if(!isset($development_environment_defaults['suppress_email']) || (isset($development_environment_defaults['suppress_email']) && $development_environment_defaults['suppress_email']))
	{
		if(isset($_SESSION['messages'], $_SESSION['messages']['status']))
		{
			for($i = 0; $i < count($_SESSION['messages']['status']); $i++)
			{
				if(strpos($_SESSION['messages']['status'][$i], 'A welcome message with further instructions has been e-mailed to the new user ') === 0)
				{
					unset($_SESSION['messages']['status'][$i]);
				}
			}
		}
	}
}

function development_environment_mail_alter(&$message)
{
	$development_environment_defaults = 	variable_get('development_environment_elements', array());

	// Emails are suppressed by default, or when a user selects the suppress emails option on the module settings page
	if(!isset($development_environment_defaults['suppress_email']) || (isset($development_environment_defaults['suppress_email']) && $development_environment_defaults['suppress_email']))
	{
		$message['send'] = FALSE;
		$message_body = '';
		foreach($message['body'] as $body_row)
		{
			$message_body .= nl2br($body_row) . '<br />';
		}
		watchdog('Development Environment', 'The following email was not sent because this instance is a development environment:<br /><br /><hr />!message_body<br /><hr />Full message:!message_data', array('!message_body' => $message_body, '!message_data' => '<pre>' . print_r($message, TRUE) . '</pre>'), WATCHDOG_NOTICE);

		$status_message = t('The email to !email was not sent, as this is a development environment.', array('!email' => $message['to']));
		if(user_access('access site reports'))
		{
			$status_message .= '<br />' . t('The mail details can be viewed in the !watchdog.', array('!watchdog' => l(t('Drupal log'), 'admin/reports/dblog')));
		}
		if(user_access('administer site configuration'))
		{
			$status_message .= '<br />' . t('You can turn off this behavior on the !development_environment_settings_page.', array('!development_environment_settings_page' => l(t('development environment settings page'), 'admin/config/development/environment')));
		}
		drupal_set_message($status_message);
	}
}
