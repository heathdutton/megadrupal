<?php
/**
 * @file
 * Functions to pull up unsaved views.
 */

/**
 * Check for unsaved views.
 *
 * If there is a view object entry in the ctools_object_cache that does not
 * have a matching entry in the views_view table, the view is unsaved.
 * Alternatively, if the cached entry has its `changed' property set to
 * TRUE then it is an unsaved (but existing and edited) view.
 */
function views_unsaved_list() {
  $items = array();

  $query = db_select('ctools_object_cache', 'o');
  $query->leftJoin('views_view' ,'v', 'o.name = v.name');
  $query->join('sessions', 's', 'o.sid = s.sid');

  $query->fields('o', array('name', 'updated', 'data', 'sid'))
    ->fields('s', array('uid'))
    ->condition('o.obj', 'view', '=');

  $or = db_or();
  $or->isNull('v.name');
  $or->condition('o.data', '%' . db_like('s:7:"changed";b:1;') . '%', 'LIKE');
  $query->condition($or);

  $result = $query->execute();

  foreach ($result as $row) {
    $view = unserialize($row->data);
    $account = user_load($row->uid);
    $title = (empty($view->human_name)) ? $view->name : $view->human_name . ' (' . $view->name . ')';
    $items[] = l($title, 'admin/structure/views/view/' . $view->name) . t(' by %user', array('%user' => format_username($account)));
  }

  if (!empty($items)) {
    drupal_set_message(t('There are unsaved views: !items.', array('!items' => implode(', ', $items))), 'warning');
  }
}

/**
 * Implements hook_form_alter().
 */
function views_unsaved_form_alter(&$form, $form_state, $form_id) {
  if ($form_id == 'ctools_export_ui_list_form') {
    if ($form_state['object']->plugin['name'] == 'views_ui') {
      views_unsaved_list();
    }
  }
}
