<?php
// $Id: sentry_client_userhash.module,v 1.1.2.1 2010/12/17 19:44:06 nevergone Exp $

/**
 * @file
 */

/**
 * Implements hook_menu().
 */
function sentry_client_userhash_menu() {
  $items = array();
  $items['admin/config/system/sentry_client_userhash'] = array(
    'title' => 'Sentry user hash client configuration',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('sentry_client_userhash_settings_form'),
    'access arguments' => array('administer sentry client'),
  );
  return $items;
}

/**
 * Implements hook_xmlrpc().
 */
function sentry_client_userhash_xmlrpc() {
  module_load_include('inc', 'sentry_client_userhash', 'sentry_client_userhash_xmlrpc');
  $methods[] = array(
    'drupalSentry.userHash',
    'xmlc_sentry_client_userhash',
    array('struct', 'string'), // return struct, argument: string
    t('Return hash of Drupal account'),
  );
  return $methods;
}

/**
 * Module settings form.
 */
function sentry_client_userhash_settings_form() {
  // Roles list.
  $roles = user_roles(TRUE);
  unset($roles[DRUPAL_AUTHENTICATED_RID]); // Don't list authorized role.
  // variable get value
  $setting = variable_get('sentry_client_userhash_settings', 0);
  $form = array();
  $form['sentry_client_userhash_settings'] = array(
    '#type' => 'radios',
    '#title' => t('Monitorig user or group'),
    '#default_value' => $setting ? '1' : '0',
    '#options' => array(
                         'admin user (uid = 1)',
                         'selected group',
                        ),
  );
  $form['sentry_client_userhash_settings_group'] = array(
    '#type' => 'select',
    '#title' => t('Selected group name:'),
    '#default_value' => $setting,
    '#options' => $roles,
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save configuration'),
  );
  return $form;
}

/**
 * Module settings form submit.
 */
function sentry_client_userhash_settings_form_submit($form, $form_state) {
  if ($form_state['values']['sentry_client_userhash_settings'] == 0) {
    $setting = 0; // Monitoring: Admin user (uid = 1)
  }
  else {
    $setting = $form_state['values']['sentry_client_userhash_settings_group']; // Monitoring: Selected group.
  }
  variable_set('sentry_client_userhash_settings', $setting);
  drupal_set_message(t('The configuration options have been saved.'));
}
