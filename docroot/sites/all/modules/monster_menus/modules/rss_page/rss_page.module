<?php

/**
 * @file
 * Allow the user to create a single page that aggregates multiple RSS feeds.
 */

/**
Installation instructions:

  cd /var/www
  mkdir drupal-rss-cache
  chmod 700 drupal-rss-cache
  chown apache drupal-rss-cache
 */

define('RSS_PAGE_CACHE_PATH_DEFAULT', '/var/www/drupal-rss-cache');
define('RSS_PAGE_CACHE_DURATION_DEFAULT', 3600);

/**
 * Implements hook_help().
 */
function rss_page_help($path, $args = NULL) {
  switch ($path) {
    case 'admin/modules#description':
      return t('Aggregates the contents of multiple RSS feeds in one location.');

    case 'admin/help#rss_page':
      return t('<p>This is the help text.</p>');

    case 'node/add#rss_page':
      // This description shows up when users click "create content."
      return t('Displays the content of an RSS feed, CMS page, or CMS tag');

    case 'node/add#portal_page':
      return t('Create a single page which shows the contents of multiple articles based on certain rules.');
  }
}

/**
 * Implements hook_theme().
 */
function rss_page_theme() {
  $themes = array(
    'rss_feed_list' => array(
      'render element' => 'elt',
    ),
  );
  return $themes;
}

/**
 * Implements hook_node_info().
 */
function rss_page_node_info() {
  return array(
    'rss_page' => array('name' => t('RSS feed'), 'base' => 'rss_page',
      'description' => rss_page_help('node/add#rss_page')),
    'portal_page' => array('name' => t('portal page'), 'base' => 'rss_page',
      'description' => rss_page_help('node/add#portal_page')));
}

/**
 * Implements hook_menu().
 */
function rss_page_menu() {
  $items = array();

  $items['admin/config/rss_page'] = array(
    'title' => 'RSS page',
    'description' => 'Manage RSS Page settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('rss_page_configure'),
    'access callback' => 'user_access',
    'access arguments' => array('administer site configuration'),
    'type' => MENU_NORMAL_ITEM);
  $items['rss-page-taxonomy-auto'] = array(
    'title' => 'Autocomplete taxonomy',
    'page callback' => 'rss_page_taxonomy_autocomplete',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK);

  if (module_exists('homebox_amherst')) {
    $items['myportal/add/%/%rss_page_intval'] = array(
      'page callback' => '_rss_page_add_to_portal',
      'page arguments' => array(2, 3),
      'access callback' => '_rss_page_menu_access_add_portal',
      'access arguments' => array(2),
      'type' => MENU_CALLBACK);
    $items['rss_page_block_form/%homebox_amherst_page/%rss_page_block'] = array(
      'page callback' => '_rss_page_block_form',
      'page arguments' => array(2, 1),    // second parameter is used in rss_page_block_form_submit()
      'load arguments' => array(1),  // in addition to default arg
      'access callback' => TRUE,
      'type' => MENU_CALLBACK);
  }

  return $items;
}

/* Menu load callback */
function rss_page_block_load($block_key, $page_name) {
  $page = homebox_amherst_page_load($page_name);
  if (!$page) return FALSE;
  $user_settings = _homebox_get_user_settings($page);
  if ($user_settings !== FALSE && isset($user_settings[$block_key])) {
    $user_settings[$block_key]['key'] = $block_key;
    return $user_settings[$block_key];
  }
  return FALSE;
}

/**
 * Implements hook_block_info().
 */
function rss_page_block_info() {
  $out = array(
    'nav' => array(
      'info' => t('RSS page navigation'),
      'cache' => DRUPAL_CACHE_PER_PAGE|DRUPAL_CACHE_PER_USER),
    'content' => array(
      'info' => t('RSS feeds'),
      'cache' => DRUPAL_CACHE_PER_PAGE|DRUPAL_CACHE_PER_USER),
    'untitled' => array(
      'info' => t('Portal Page: !title', array('!title' => variable_get('rss_page_untitled_feeds_title', t('Amherst College Feeds')))),
      'cache' => DRUPAL_CACHE_PER_USER),
  );

  $result = db_query("SELECT nid FROM {node} WHERE type = 'portal_page' AND status = 1 AND title <> ''");
  foreach ($result as $n) {
    $node = node_load($n->nid);
    if ($node->nid && mm_content_user_can_node($node, MM_PERMS_READ)) {
      $out[$node->nid] = array(
        'info' => t('Portal Page: !name (node/!nid)', array('!name' => trim($node->title), '!nid' => $node->nid)),
        'cache' => DRUPAL_CACHE_PER_USER
      );
    }
  }

  return $out;
}

/**
 * Implements hook_block_view().
 */
function rss_page_block_view($delta = 'nav', $edit = NULL) {
  if ($delta == 'untitled') {
    $content = array();
    $result = db_query("SELECT nid FROM {node} WHERE type = 'portal_page' AND status = 1 AND title = '' ORDER BY sticky DESC, changed DESC");
    foreach ($result as $n) {
      $node = node_load($n->nid);
      if (!empty($node) && $node->nid && mm_content_user_can_node($node, MM_PERMS_READ) && _rss_page_conditional($node)) {
        $block = _rss_page_block('content', $node, $rss_link);
        $content[] = $block['content'];
      }
    }
    if ($content) {
      return array(
        'content' => $content,
        'subject' => variable_get('rss_page_untitled_feeds_title', t('Amherst College Feeds')),
      );
    }
  }
  else {
    $node = NULL;
    if (is_numeric($delta)) {
      $node = node_load($delta);
      if (empty($node) || !$node->nid || !mm_content_user_can_node($node, MM_PERMS_READ) || $node->type == 'portal_page' && !_rss_page_conditional($node)) return array('content' => '', 'subject' => '');
      $delta = 'content';
    }
    $block = _rss_page_block($delta, $node, $rss_link, FALSE, $edit);
    if ($node && !empty($node->title)) {
      $block['subject'] = check_plain(_rss_page_add_vars($node->title, $node));
    }
    if (!empty($node->nid) && mm_content_user_can_node($node, MM_PERMS_WRITE)) {
      $block['content'][] = array('#weight' => -1, '#markup' => '<div class="portal-page-setup">' . l(t('setup'), 'node/' . $node->nid) . '</div>');
    }
    $weight = 0;
    foreach ($block['content'] as $index => $content) {
      if (!isset($content['#weight'])) {
        $block['content'][$index]['#weight'] = $weight++;
      }
    }
    // Allow this block to be hidden in homebox_amherst.
    if (!$block['count'] && isset($edit['homebox']) && empty($edit['homebox']->closable)) {
      $block['content'] = array();
    }
    return $block;
  }
}

/**
 * Implements hook_access().
 */
function rss_page_access($op, $node, $account) {
  if ($node == 'portal_page') {
    return user_access('create portal pages', $account);
  }
  elseif ($op == 'create') {
    // Only users with permission to do so may create this node type.
    return user_access('create rss pages', $account);
  }

  // Users who create a node may edit or delete it later, assuming they have the
  // necessary permissions.
  if ($op == 'update' || $op == 'delete') {
    if (user_access('edit own rss pages', $account) && ($account->uid == $node->uid)) {
      return TRUE;
    }
  }
}

/**
 * Implements hook_exit().
 */
function rss_page_exit() {
  $_rss_page_future_goto = &drupal_static('_rss_page_future_goto');

  if (!empty($_rss_page_future_goto)) {
    header('Location: ' . $_rss_page_future_goto);
    exit();
  }
}

/**
 * Implements hook_node_view().
 */
function rss_page_node_view($node, $view_mode) {
  $_mm_mmtid_of_node = &drupal_static('_mm_mmtid_of_node');

  $node_types = array_keys(node_type_get_names());
  _mm_menu_active_item();
  if (isset($node) && isset($_mm_mmtid_of_node[$node->nid]) && in_array($node->type, $node_types)) {
    if (variable_get('rss_page_show_node_permalink', FALSE) && isset($node->content['#entity_type'])) {
      // Show the permalink for everything but the 403 & 404 pages
      $external = $_GET['q'];
      _rss_page_rewrite_outbound($external);
      if ($external != variable_get('site_404', '') && $external != variable_get('site_403', '') && $external != variable_get('httpauth_site_403', '')) {
        $defaults = array();
        if (!empty($_GET['destination'])) {
          $defaults = array('query' => array('destination' => $_GET['destination']));
        }
        $link = $defaults + array('title' => t('Permalink'), 'href' => 'node/' . $node->nid, 'attributes' => array('rel' => 'permalink', 'title' => 'The permanent location of this content'));

        $node->content['links'][$node->content['#entity_type']]['#links']['rss_page_permalink'] = $link;
      }
    }
  }
}

function _rss_page_rewrite_outbound(&$path) {
  $original_path = $path;
  $options = array();
  drupal_alter('url_outbound', $path, $options, $original_path);
}

/**
 * Menu callback; presents general node configuration options.
 */
function rss_page_configure($form, &$form_state) {
  $form = rss_page_form_options($form, t('Default options'));
  $form['mm_enable_rss'] = array(
    '#type' => 'checkbox',
    '#title' => t('Enable the "Add this page to My Portal" button'),
    '#default_value' => variable_get('mm_enable_rss', FALSE),
    '#weight' => 1,
  );
  $form['rss_page_untitled_feeds_title'] = array(
    '#type' => 'textfield',
    '#title' => t('Default portal page widget title'),
    '#description' => t('Untitled portal page feeds are grouped together into a single widget. This is that widget\'s title.'),
    '#default_value' => variable_get('rss_page_untitled_feeds_title', t('Feeds')),
    '#weight' => 2,
  );
  $form['rss_page_cache_path'] = array(
    '#type' => 'textfield',
    '#title' => t('RSS cache path'),
    '#description' => t('The location of the cache used to keep from fetching the same remote RSS data repeatedly.'),
    '#default_value' => variable_get('rss_page_cache_path', RSS_PAGE_CACHE_PATH_DEFAULT),
    '#weight' => 3,
  );
  $form['rss_page_cache_duration'] = array(
    '#type' => 'select',
    '#title' => t('RSS cache duration'),
    '#description' => t('After this length of time, cached remote RSS data will be discarded.'),
    '#default_value' => variable_get('rss_page_cache_duration', RSS_PAGE_CACHE_DURATION_DEFAULT),
    '#options' => array(
      30   => t('30 seconds'),
      60   => t('1 minute'),
      300  => t('5 minutes'),
      600  => t('10 minutes'),
      1800 => t('30 minutes'),
      3600 => t('1 hour'),
      7200 => t('2 hours'),
    ),
    '#weight' => 4,
  );
  $form['#submit'][] = 'rss_page_configure_submit';
  return system_settings_form($form);
}

function rss_page_configure_submit($form, &$form_state) {
  $values = $form_state['values'];
  if ($values['submit'] == $values['op']) {
    variable_set('node_settings_rss_page', array(
      'show_descr' => $values['rss_checks']['show_descr'],
      'show_image' => $values['rss_checks']['show_image'],
      'show_feed_img' => $values['rss_checks']['show_feed_img'],
      'group_by_key' => 0,
      'sort' => $values['rss_sort'],
      'items' => $values['rss_items'],
      'display' => $values['rss_display'],
    ));
  }
}

function rss_page_mm_config_alter(&$form) {
  if (isset($form['mm_page']['mm_enable_rss'])) {
    $form['mm_page']['mm_enable_rss']['#title'] = t('Allow content creators to control the %add button and the availability of RSS feeds on a per-page basis', array('%add' => t('Add this page to my portal')));
  }

  if (isset($form['mm_node'])) {
    $form['mm_node']['rss_page_show_add_tag_to_portal'] = array(
      '#type' => 'checkbox',
      '#title' => t('Enable the %add button after each tag', array('%add' => t('Add this tag to my portal'))),
      '#default_value' => variable_get('rss_page_show_add_tag_to_portal', FALSE),
    );
    $form['mm_node']['rss_page_show_node_permalink'] = array(
      '#type' => 'checkbox',
      '#title' => t('Show a permalink icon with every node'),
      '#default_value' => variable_get('rss_page_show_node_permalink', FALSE),
    );
  }

  if (isset($form['mm_page'])) {
    $form['mm_page']['rss_page_show_page_permalink'] = array(
      '#type' => 'checkbox',
      '#title' => t('Show a permalink icon on every page'),
      '#default_value' => variable_get('rss_page_show_page_permalink', FALSE),
    );

    $form['mm_page']['menu'] = array(
      '#type' => 'fieldset',
      '#title' => t('RSS/Permalink Menu'),
      '#description' => t('These values can contain HTML.'),
      '#collapsible' => TRUE,
      '#collapsed' => TRUE
    );
    $form['mm_page']['menu']['rss_page_subscribe_menu_portal'] = array(
      '#type' => 'textfield',
      '#maxlength' => 1024,
      '#title' => t('Text of the %add link', array('%add' => t('Add to my portal'))),
      '#default_value' => variable_get('rss_page_subscribe_menu_portal', t('Add to my portal')),
    );
    $form['mm_page']['menu']['rss_page_subscribe_menu_rss'] = array(
      '#type' => 'textfield',
      '#maxlength' => 1024,
      '#title' => t('Text appearing above the RSS link'),
      '#default_value' => variable_get('rss_page_subscribe_menu_rss', t('Copy this URL to add this page to an external news reader:')),
    );
    $form['mm_page']['menu']['rss_page_subscribe_menu_rss_warn'] = array(
      '#type' => 'textfield',
      '#maxlength' => 1024,
      '#title' => t('Warning that appears if the RSS link requires authentication'),
      '#default_value' => variable_get('rss_page_subscribe_menu_rss_warn', t("This URL may not work with all readers; some readers can't subscribe to password-protected pages.")),
    );
    $form['mm_page']['menu']['rss_page_subscribe_menu_permalink'] = array(
      '#type' => 'textfield',
      '#maxlength' => 1024,
      '#title' => t('Text appearing above the permalink'),
      '#default_value' => variable_get('rss_page_subscribe_menu_permalink', t('Copy this URL to bookmark this page or send the link to someone:')),
    );
    $form['mm_page']['access_denied']['#weight'] = 100;
  }
}

function rss_page_form_mm_ui_content_edit_alter(&$form, $form_state) {
  if (isset($form['settings_appearance']['rss'])) {
    $form['settings_appearance']['rss']['#title'] = t('Show the %add button and enable the RSS feed', array('%add' => t('Add this page to my portal')));
  }
}

function rss_page_get_options() {
  return variable_get('node_settings_rss_page', array(
    'show_descr' => TRUE,
    'show_image' => TRUE,
    'show_feed_img' => TRUE,
    'group_by_key' => 0,
    'sort' => 'feed-weight',
    'items' => 10,
    'display' => '1-col',
    'view_condition' => '',
  ));
}

function rss_page_form_options($form, $title, $node = NULL) {
  if (isset($node) && !empty($node->rss_page) && !empty($node->nid)) {
    $opts = (array)$node->rss_page;
    foreach (array('show_descr', 'show_image', 'show_feed_img', 'group_by_key') as $opt) {
      if ($opts[$opt]) {
        $opts[$opt] = $opt;
      }
    }
  }
  else {
    $opts = rss_page_get_options();
  }

  $form['opts'] = array(
    '#type' => 'fieldset',
    '#title' => $title,
    '#collapsible' => FALSE,
  );

  $ilist = drupal_map_assoc(array(0, 1, 2, 3, 4, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50));
  $ilist[0] = t('(none)');
  $ilist[-1] = t('(all)');

  $form['opts']['rss_items'] = array(
    '#type' => 'select',
    '#title' => t('News items per feed'),
    '#default_value' => $opts['items'],
    '#options' => $ilist
  );
  $form['opts']['rss_checks'] = array(
    '#type' => 'checkboxes',
    '#default_value' => $opts,
    '#options' => array(
      'show_feed_img' => t('Show the feed logo, if it exists'),
      'show_descr' => t('Show full item text; otherwise just show link to item'),
      'show_image' => t('Show images in items')
    )
  );
  if (isset($node->type) && $node->type != 'rss_page') {
    $form['opts']['rss_checks']['#options']['group_by_key'] = t('Group query results by nid or mmtid. Requires name column to be returned.');
  }
  $form['opts']['rss_sort'] = array(
    '#type' => 'radios',
    '#default_value' => $opts['sort'],
    '#title' => t('News item sort order'),
    '#options' => array(
      'date' => t('by date'),
      'feed-alpha' => t('grouped by feed, alphabetically'),
      'feed-weight' => t('grouped by feed, in the order they appear above'),
    )
  );
//   $form['opts']['rss_display'] = array(
//     '#type' => 'radios',
//     '#default_value' => $opts['display'],
//     '#title' => t('Navigation'),
//     '#options' => array(
//         '1-col' => t('Show above feed content'),
//         'block' => t('Show navigation and content in separate areas of the page'),
//   ));
  $form['opts']['rss_display'] = array(
    '#type' => 'value',
    '#value' => '1-col',
  );
  return $form;
}

/**
 * Implements hook_form().
 */
function rss_page_form($node, &$form_state) {
  $xvars = rss_page_get_xvars();
  $form = array();

  if ($node->type != 'rss_page') {
    drupal_set_title(!empty($node->nid) ? t('Edit a portal page') : t('Create a portal page'));

    $form['vars-help'] = mm_ui_vars_help(-10, array(t('Condition'), t('Title'), t('Feed name'), t('SQL query')), array_keys($xvars));
    $form['view_condition'] = array(
      '#type' => 'textfield',
      '#title' => t('Condition'),
      '#size' => 50, '#maxlength' => 255,
      '#default_value' => isset($node->rss_page['view_condition']) ? $node->rss_page['view_condition'] : '',
      '#weight' => -7,
      '#description' => t('This page will only be displayed if the above criterion is met. Use a piece of executable PHP code that evaluates to a boolean result. Leave blank to always show this page. Do not include the keyword "if". Example: <code>"${class_year}" != ""</code>'),
    );
  }
  else {
    drupal_set_title(!empty($node->nid) ? t('Edit an RSS feed') : t('Create an RSS feed'));
  }

  return _rss_page_main_form($form, $node);
}

function _rss_page_block_form($block, $page) {
  $render = drupal_get_form('rss_page_block_form', $block, $page);
  print drupal_render($render);
  // Only output some of the JS
  $temp_js = array();
  $scopes = array();
  foreach (drupal_add_js() as $key => $js) {
    // autocomplete or generated by theme_rss_feed_list()
    if ($key == 'misc/autocomplete.js' || $js['type'] == 'inline' && strpos($js['data'], 'mmListInit') !== FALSE) {
      $temp_js[] = $js;
      $scopes[$js['scope']] = TRUE;
    }
  }
  foreach (array_keys($scopes) as $scope) {
    print drupal_get_js($scope, $temp_js, TRUE);
  }

  $GLOBALS['devel_shutdown'] = FALSE; // prevent the devel module from outputting
  exit();
}

function rss_page_block_form($form, $form_state, $block) {
  $node = rss_page_default_block_options((object)$block);
  $form = _rss_page_main_form($form, $node, FALSE);
  $form['opts']['#collapsible'] = $form['opts']['#collapsed'] = TRUE;
  return $form;
}

function rss_page_block_form_submit($form, $form_state) {
  $vals = $form_state['values'];
  $block = $form_state['build_info']['args'][0];
  $page = $form_state['build_info']['args'][1];

  $block['rss_feeds'] = array();
  $weight = 0;
  foreach (_rss_page_split_feed_list($vals['rss_feeds']) as $m)
    $block['rss_feeds'][] = (object)array('type' => $m->type, 'name' => $m->name, 'data' => $m->data, 'weight' => $weight++);

  foreach (array('rss_items', 'rss_sort', 'rss_display') as $field)
    $block[$field] = check_plain($vals[$field]);

  foreach (array('show_descr', 'show_image', 'show_feed_img') as $field)
    $block[$field] = !empty($vals['rss_checks'][$field]);

  $block['title'] = $block['subject'] = check_plain($vals['title']);

  $user_blocks = _homebox_get_user_settings($page, TRUE);
  if ($user_blocks === FALSE) {
    drupal_json_output(array('error' => t('Could not load the widget'), 'html' => ''));
  }
  else {
    $user_blocks[$block['key']] = $block;
    homebox_amherst_save_user_blocks($page, $user_blocks);

    $block = homebox_amherst_prepare_block($block['key'], $page);

    drupal_json_output(array('html' => theme('homebox_block', array('block' => $block, 'page' => $page))));

    homebox_amherst_clear_block_cache($page, $block);
  }

  exit;
}

/**
 * Implements hook_mm_fix_node_urls_info().
 */
function rss_page_mm_fix_node_urls_info() {
  return array(
    'rss_feed_data' => array(
      'table' => 'rss_page_feed',
      'join on' => "%alias.vid = node.vid AND %alias.`type` = 'url'",
      'table field' => 'data',
      'get' => '_rss_page_mm_fix_node_urls_get',
      'set' => '_rss_page_mm_fix_node_urls_set',
    ),
  );
}

function _rss_page_mm_fix_node_urls_get($node) {
  if (isset($node->rss_feeds)) {
    // There's no provision to modify data in a one-to-many relationship as an
    // array, so concatenate it all into a string instead.
    $out = array();
    foreach ($node->rss_feeds as $n => $rss) {
      if ($rss->type == 'url') {
        $out[] = "$n::" . $rss->data;
      }
    }
    return implode('||', $out);
  }
  return NULL;
}

function _rss_page_mm_fix_node_urls_set($value, $node) {
  if (isset($node->rss_feeds)) {
    // Split the string back out into multiple rows.
    foreach (explode('||', $value) as $row) {
      list($n, $data) = explode('::', $row);
      if (isset($node->rss_feeds[$n]) && $node->rss_feeds[$n]->type == 'url') {
        $node->rss_feeds[$n]->data = $data;
      }
    }
  }
}

function rss_page_taxonomy_autocomplete($string = '') {
  $string = trim($string);
  $matches = array();
  if ($string != '') {
    $result = db_query_range("SELECT t.tid, t.name FROM {taxonomy_term_data} t WHERE t.name LIKE :string", 0, 10, array(':string' => "%$string%"));

    foreach ($result as $tag) {
      $matches[$tag->tid] = check_plain($tag->name);
    }
  }

  drupal_json_output($matches);
}

function _rss_page_main_form($form, $node, $required = TRUE) {
  $form['title'] = array(
    '#type' => 'textfield',
    '#title' => t('Title'),
    '#required' => $node->type == 'rss_page' && $required,
    '#size' => 50,
    '#default_value' => $node->title,
    '#weight' => -5
  );

  $form['feeds-url'] = array(
    '#type' => 'fieldset',
    '#title' => t('Enter a URL'),
    '#attributes' => array('style' => 'display: none', 'id' => 'edit-feeds-url')
  );
  $form['feeds-url']['feed-url'] = array(
    '#type' => 'textfield',
    '#title' => t('URL of RSS feed'),
    '#description' => t('Enter the full URL, starting with <code>http://</code>, <code>feed://</code>, etc. The feed\'s title will be set automatically the first time you view the resulting page. Click on either button below to return to the main list.'),
    '#size' => 50, '#maxlength' => 255,
  );
  $form['feeds-url']['clear'] = array(
    '#type' => 'markup',
    '#prefix' => '<div class="tax-clear">',
    '#suffix' => '</div>',
  );
  $form['feeds-url']['clear']['feed-ok'] = array(
    '#type' => 'submit',
    '#value' => t('Done'),
  );
  $form['feeds-url']['clear']['feed-cancel'] = array(
    '#type' => 'submit',
    '#value' => t('Cancel'),
  );

  if ($node->type != 'rss_page') {
    $form['feeds-query'] = array(
      '#type' => 'fieldset',
      '#title' => t('Enter a query'),
      '#attributes' => array('style' => 'display: none', 'id' => 'edit-feeds-query')
    );
    $form['feeds-query']['feed-name'] = array(
      '#type' => 'textfield',
      '#title' => t('Feed name'),
      '#size' => 50, '#maxlength' => 255
    );
    $form['feeds-query']['feed-url'] = array(
      '#type' => 'textarea',
      '#title' => t('SQL query'),
      '#description' => t('Must return an "mmtid" or "nid" column; if both, "nid" takes precedence.'),
      '#attributes' => array('spellcheck' => 'false'),
      '#wysiwyg' => FALSE,
      '#cols' => 50, '#maxlength' => 512,
    );
    $form['feeds-query']['clear'] = array(
      '#type' => 'markup',
      '#prefix' => '<div class="tax-clear">',
      '#suffix' => '</div>',
    );
    $form['feeds-query']['clear']['feed-ok'] = array(
      '#type' => 'submit',
      '#value' => t('Done'),
    );
    $form['feeds-query']['clear']['feed-cancel'] = array(
      '#type' => 'submit',
      '#value' => t('Cancel'),
    );
  }

  $have_tax = module_exists('taxonomy');
  if ($have_tax) {
    $form['feeds-tax'] = array(
      '#type' => 'fieldset',
      '#title' => t('Choose a term or free tag'),
      '#attributes' => array('style' => 'display: none', 'id' => 'edit-feeds-tax')
    );
    $form['feeds-tax']['tax-id'] = array(
      '#type' => 'hidden',
    );
    $form['feeds-tax']['tax-sample'] = array(
      '#markup' => '<div id="tax-sample-wrapper"><label for="edit-tax-text">' . t('Term/tag:') . '</label><div id="tax-sample"></div></div>',
    );
    $form['feeds-tax']['tax-text'] = array(
      '#type' => 'textfield',
      '#autocomplete_path' => 'rss-page-taxonomy-auto',
      '#size' => 35,
      '#maxlength' => 100,
      '#description' => t('Type part of the tag, then choose a tag from the list of matches.'),
    );
    $form['feeds-tax']['clear'] = array(
      '#type' => 'markup',
      '#prefix' => '<div class="tax-clear">',
      '#suffix' => '</div>',
    );
    $form['feeds-tax']['clear']['tax-ok'] = array(
      '#type' => 'submit',
      '#value' => t('Done'),
    );
    $form['feeds-tax']['clear']['tax-cancel'] = array(
      '#type' => 'submit',
      '#value' => t('Cancel'),
    );
  }

  $desc = '';
  if ($node->type == 'rss_page') {
    $desc = t('%url displays the content of a standard URL-based feed. %page displays the content of a CMS page. %tag displays any CMS content labeled with the indicated tag. After entering a URL or selecting a page or tag, click Done.', array(
      '%url' => t('RSS feed'),
      '%page' => t('Page feed'),
      '%tag' => t('Tag feed'),
    ));
  }
  $form['rss_feeds'] = array(
    '#type' => 'rss_feed_list',
    '#required' => $required,
    '#rss_list_url_form_ID' => 'edit-feeds-url',
    '#rss_list_tax_form_ID' => $have_tax ? 'edit-feeds-tax' : '',
    '#rss_list_query_form_ID' => $node->type != 'rss_page' ? 'edit-feeds-query' : '',
    '#rss_list_subtype' => $node->type,
    '#description' => $desc,
    '#default_value' => serialize(isset($node->rss_feeds) ? $node->rss_feeds : array()),
  );

  return rss_page_form_options($form, t('Feed display options'), $node);
}

/**
 * Implements hook_validate().
 */
function rss_page_validate(&$node) {
  $feeds = _rss_page_split_feed_list($node->rss_feeds);
  if (!count($feeds)) {
    form_set_error('rss_feeds', t('You must add at least one feed.'));
  }
  else {
    foreach ($feeds as $m) {
      if ($m->type == 'cat') {
        if (!mm_content_user_can($m->data, MM_PERMS_READ)) {
          form_set_error('rss_feeds', t('You are not allowed to read the page %cat.',
              array('%cat' => $m->name)));
        }
      }
      elseif ($node->type == 'rss_page' && $m->type == 'url' && !valid_url($m->data, TRUE)) {
        form_set_error('rss_feeds', t('%url does not seem to be a valid URL.', array('%url' => $m->data)));
      }
    }
  }

  if ($node->type != 'rss_page') {
    foreach ($feeds as $m) {
      if ($m->type == 'query' && $m->data != '') {
        $q = _rss_page_add_vars($m->data, $node);
        unset($row);
        try {
          $row = db_query($q)->fetchObject();
        }
        catch (Exception $e) {
          form_set_error('members', t('There was an error testing the query.<br /><strong>Query:</strong> @query<br /><strong>Error:</strong> @error', array('@query' => $q, '@error' => $e->getMessage())));
        }

        if (isset($row) && !isset($row->mmtid) && !isset($row->nid)) {
          form_set_error('members', t('The query:<br />@query<br />did not return an mmtid or nid column', array('@query' => $q)));
        }
      }
    }
  }
}

/**
 * Implements hook_insert().
 */
function rss_page_insert($node) {
  if (isset($node->rss_checks) && is_array($node->rss_checks)) {
    $record = array(
      'nid' => $node->nid,
      'items' => $node->rss_items,
      'sort' => $node->rss_sort,
      'show_descr' => !empty($node->rss_checks['show_descr']),
      'show_image' => !empty($node->rss_checks['show_image']),
      'show_feed_img' => !empty($node->rss_checks['show_feed_img']),
      'group_by_key' => !empty($node->rss_checks['group_by_key']),
      'display' => $node->rss_display,
      'view_condition' => !empty($node->view_condition) ? $node->view_condition : '',
    );
    drupal_write_record('rss_page', $record, empty($node->original) ? array() : 'nid');
  }

  if (!is_array($node->rss_feeds)) {
    $feeds = $node->rss_feeds;
    $node->rss_feeds = array();
    $weight = 0;

    foreach (_rss_page_split_feed_list($feeds) as $m) {
      $node->rss_feeds[] = (object)array('type' => $m->type, 'name' => $m->name, 'data' => $m->data, 'weight' => $weight++);
    }
  }

  foreach ($node->rss_feeds as $feed) {
    $record = array(
      'nid' => $node->nid,
      'vid' => $node->vid,
      'type' => $feed->type,
      'data' => $feed->data,
      'name_isset' => 0,
      'name' => $feed->name,
      'weight' => $feed->weight,
    );
    drupal_write_record('rss_page_feed', $record);
  }
}

/**
 * Implements hook_update().
 */
function rss_page_update($node) {
  db_query('DELETE {rss_page_feed}, {rss_page_last_read} FROM {rss_page_feed} ' .
    'LEFT JOIN {rss_page_last_read} ON {rss_page_feed}.fid={rss_page_last_read}.fid ' .
    'WHERE vid=:vid', array(':vid' => $node->vid));

  rss_page_insert($node);
}

/**
 * Implements hook_node_revision_delete().
 *
 * When a node revision is deleted, we need to remove the corresponding record
 * from our table.
 */
function rss_page_node_revision_delete($node) {
  // Notice that we're matching a single revision based on the node's vid.
  db_delete('rss_page_feed')
    ->condition('vid', $node->vid)
    ->execute();
}

/**
 * Implements hook_mm_delete() from mm_content.inc.
 */
function rss_page_mm_delete($mmtids, $nids) {
  if (count($nids)) {
    db_query("DELETE f, r FROM {rss_page_feed} f LEFT JOIN {rss_page_last_read} r ON f.fid = r.fid WHERE f.nid IN(:nids)", array(':nids' => $nids));
  }

  if (count($mmtids)) {
    db_query("DELETE f, r FROM {rss_page_feed} f LEFT JOIN {rss_page_last_read} r ON r.fid = f.fid WHERE f.type = 'cat' AND f.data IN(:mmtids)", array(':mmtids' => $mmtids));
  }
}

/**
 * Implements hook_delete().
 */
function rss_page_delete($node) {
  // Notice that we're matching all revision, by using the node's nid.
  db_delete('rss_page')
    ->condition('nid', $node->nid)
    ->execute();
  db_query('DELETE f, r FROM {rss_page_feed} f LEFT JOIN {rss_page_last_read} r ON r.fid = f.fid WHERE nid = :nid', array(':nid' => $node->nid));
}

/**
 * Implements hook_load().
 */
function rss_page_load($nodes) {
  $result = db_query('SELECT nid, items, sort, show_descr, show_image, show_feed_img, group_by_key, display, view_condition FROM {rss_page} WHERE nid IN (:nids)', array(':nids' => array_keys($nodes)));
  foreach ($result as $rss_page) {
    $feeds = array();
    $select = db_select('rss_page_feed', 'f');
    $select->fields('f', array('fid', 'type', 'data', 'name', 'name_isset', 'weight'));
    $select->condition('f.vid', $nodes[$rss_page->nid]->vid);
    $select->orderBy('f.weight');
    $feed_result = $select->execute();
    foreach ($feed_result as $feed) {
      $feeds[] = $feed;
    }

    $nodes[$rss_page->nid]->rss_page = (array)$rss_page;
    $nodes[$rss_page->nid]->rss_items = $rss_page->items;
    $nodes[$rss_page->nid]->rss_sort = $rss_page->sort;
    $nodes[$rss_page->nid]->rss_display = $rss_page->display;
    $nodes[$rss_page->nid]->view_condition = $rss_page->view_condition;
    $nodes[$rss_page->nid]->rss_feeds = $feeds;
  }
}

function rss_page_as_user_submit($form, &$form_state) {
  $uid = mm_ui_mmlist_key0($form_state['values']['user']);
  if (isset($uid) && mm_content_uid2name($uid) !== FALSE && user_access('create portal pages')) {
    $_SESSION['vars_uid'] = $uid;
  }
}

function rss_page_as_user($form, &$form_state) {
  global $user;

  if (!isset($_SESSION['vars_uid'])) {
    $_SESSION['vars_uid'] = $user->uid;
  }

  $form['as-user'] = array(
    '#type' => 'fieldset',
    '#title' => t('View portal pages as a different user'),
    '#collapsible' => TRUE,
    '#collapsed' => $_SESSION['vars_uid'] == $user->uid,
  );
  $form['as-user']['user-choose'] = array(
    '#type' => 'textfield',
    '#title' => t('Choose the user'),
    '#autocomplete_path' => 'mm-auto',
    '#description' => theme('mm_autocomplete_desc'),
    '#size' => 30, '#maxlength' => 40,
  );
  $form['as-user']['user'] = array(
    '#type' => 'mm_userlist',
    '#description' => t('Because you are an administrator, you can see the portal page contents as another user would. You will still not be able to see data you would not otherwise have access to, however. Any added feeds (non-portal pages) are your own.'),
    '#title' => ' ',
    '#default_value' => array($_SESSION['vars_uid'] => mm_content_uid2name($_SESSION['vars_uid'])),
    '#mm_list_autocomplete_ID' => 'edit-user-choose', // this can eventually be removed
    '#mm_list_autocomplete_name' => 'user-choose',
    '#mm_list_min' => 1,
    '#mm_list_max' => 1,
  );
  $form['as-user']['submit'] = array(
    '#type' => 'submit',
    '#value' => t('View'),
  );

  return $form;
}

/**
 * Implements hook_view().
 */
function rss_page_view($node, $teaser = FALSE, $page = FALSE) {
  static $have_user_form; // just in case this function is called more than once per page

  $user_form = '';
  if ($node->type != 'rss_page' && user_access('create portal pages') && !$have_user_form++) {
    $user_form = drupal_get_form('rss_page_as_user');
  }

  $skip_display = FALSE;
  if (isset($node->rss_page) && ($cond = trim($node->rss_page['view_condition'])) != '') {
    $cond = _rss_page_add_vars($cond, $node);
    if (empty($cond) || eval("return ($cond);") == FALSE) {
      if (user_access('create portal pages')) {
        if (isset($user_form)) {
          $node->content['body'] = $user_form;
        }
        $skip_display = TRUE;
      }
      elseif (isset($user_form)) {
        $node->content['body'] = $user_form;
        return;
      }
      else {
        $node->content = array();
        $node->no_display = TRUE;
        return;
      }
    }
  }

  $node->title = _rss_page_add_vars($node->title, $node);
  if (!$skip_display) {
    $nav = _rss_page_block('nav', $node, $rss_link);
    $body = _rss_page_block('content', $node, $rss_link, TRUE);
    $node->content['body'] = array(
      'user_form' => $user_form,
      'nav' => $nav['content'],
      'body' => $body['content'],
    );
    $node->rss_link = $rss_link;
  }

  return $node;
}

/**
 * Implements hook_user_delete().
 */
function rss_page_user_delete($account) {
  if ($account->uid) {
    db_delete('rss_page_last_read')
      ->condition('uid', $account->uid)
      ->execute();
    db_delete('rss_page_settings')
      ->condition('uid', $account->uid)
      ->execute();
  }
}

/**
 * Implements hook_form_alter().
 */
function rss_page_form_alter(&$form, &$form_state, $form_id) {
  if (isset($form['type']) && isset($form['type']['#value']) &&
      ($form['type']['#value'] == 'rss_page' || $form['type']['#value'] == 'portal_page')) {
    unset($form['preview']);
  }
}

/**
 * Implements hook_element_info().
 *
 * This hook declares to Drupal what form elements are provided by the module.
 */
function rss_page_element_info() {
  $type['rss_feed_list'] = array(
    '#theme' => 'rss_feed_list',
    '#input' => TRUE,
  );
  return $type;
}

/**
 * Implements hook_cron().
 *
 * Periodically remove old RSS cache files
 */
function rss_page_cron() {
  $rss_cache = variable_get('rss_page_cache_path', RSS_PAGE_CACHE_PATH_DEFAULT);
  foreach (file_scan_directory($rss_cache, '/\.spc$/') as $file) {
    if (is_file($file->uri) && REQUEST_TIME - filemtime($file->uri) > 30 * 24 * 60 * 60) {
      file_unmanaged_delete($file->uri);
    }
  }
}

/**
 * Theme a form element allowing the user to add RSS pages.
 */
function theme_rss_feed_list($variables) {
  $_mmlist_instance = &drupal_static('_mmlist_instance', 0);
  $elt = $variables['elt'];
  module_load_include('inc', 'monster_menus', 'mm_theme');
  $labelAddURL = t('Add RSS feed...');
  if ($elt['#rss_list_subtype'] == 'rss_page') {
    $is_portal = FALSE;
    $flags = '{}';
    $labelAboveInfo = t('Location:');
    $labelAddQuery = '';
  }
  else {
    $is_portal = TRUE;
    $flags = drupal_json_encode(array('is_portal' => TRUE));
    $labelAboveInfo = '';
    $labelAddQuery = t('Add a query...');
  }
  $labelAboveList = t('Feed:');
  $labelAboveActions = t('Action:');
  $labelAddCat = t('Add page feed...');
  $labels = mm_ui_mmlist_labels();

  $delConfirm = t("Are you sure you want to delete this feed?\\n\\n(You can skip this alert in the future by holding the Shift key while clicking the Delete icon.)");

  $popup_base = base_path() . "mm-browser-load/1-rss-$_mmlist_instance-r-r/";
  $popup_URL = mm_home_mmtid();

  $adds = array();
  if (substr($elt['#value'], 0, 2) == 'a:') {
    foreach (unserialize($elt['#value']) as $obj) {
      $url = '';
      _rss_page_info($obj->type, $obj->data, $obj->name, $url, $info, $popup_URL, $is_portal);
      $adds[] = _mm_theme_add_row_js(array($obj->name, $obj->type, $url, $info));
    }
  }
  else {
    foreach (_rss_page_split_feed_list($elt['#value']) as $m) {
      $name = $m->name;
      $url = !$is_portal && $m->type == 'cat' ? '' : $m->data;
      _rss_page_info($m->type, $m->data, $name, $url, $info, $popup_URL, $is_portal);

      $adds[] = _mm_theme_add_row_js(array($name, $m->type, $url, $info));
    }
  }

  if (!isset($popup_URL)) {
    $popup_URL = 1;
  }
  $popup_label = t('Select a page');

  drupal_add_library('monster_menus', 'mm');
  $imgpath = base_path() . drupal_get_path('module', 'monster_menus') . '/images';

  $url_form = $elt['#rss_list_url_form_ID'];
  $tax_form = $elt['#rss_list_tax_form_ID'];
  $query_form = $elt['#rss_list_query_form_ID'];
  $labelAddTax = t('Add tag feed...');

  $name = $elt['#parents'][0];
  if (count($elt['#parents']) > 1) {
    $name .= '[' . join('][', array_slice($elt['#parents'], 1)) . ']';
  }

  $labelAboveList .= !empty($elt['#required']) ? ' <span class="form-required" title="' . t('This field is required.') . '">*</span>' : '';
  $labelAboveList = drupal_json_encode($labelAboveList);
  $class = _mm_theme_add_class($elt);
  $desc = $elt['#description'] ? "\n" . '<div class="description">' . $elt['#description'] . '</div>' : '';

  $adds = join("\n    ", $adds);
  $js = <<<EOJ
(function (\$) {
mmListInit$_mmlist_instance = function() {
  var obj = mmListGetObj(null,
    'div[name=rss_list_obj$_mmlist_instance]',
    'div[name=rss_list_obj$_mmlist_instance] + div[class="$class"]',
    '$name',
    null, {
      popupBase: '$popup_base',
      popupURL: '$popup_URL',
      popupLabel: '$popup_label',
      flags: $flags,
      addCallback: rssAddCallback,
      replaceCallback: rssReplCallback,
      selectCallback: rssSelectCallback,
      dataCallback: rssDataCallback,
      labelAboveList: $labelAboveList,
      labelAboveActions: '$labelAboveActions',
      labelAddCat: '$labelAddCat',
      labelAddURL: '$labelAddURL',
      labelAddQuery: '$labelAddQuery',
      labelAddList: '$labelAddTax',
      labelAboveInfo: '$labelAboveInfo',
      imgPath: '$imgpath',
      inputDivID: '$url_form',
      inputDivID2: '$tax_form',
      inputDivID3: '$query_form',
      delConfirmMsg: "$delConfirm",
      labelTop: '$labels[0]',
      labelUp: '$labels[1]',
      labelX: '$labels[2]',
      labelBott: '$labels[3]',
      labelDown: '$labels[4]',
      labelEdit: '$labels[5]'
    }
  );
  if (obj && obj.addItem) {
    $adds
    obj.enableOpts();
    obj.setHiddenElt();
  }
};
\$(document).ready(mmListInit$_mmlist_instance);
})(jQuery);
EOJ;
  drupal_add_js($js, 'inline');
  $output = <<<EOJ
\n<div name="rss_list_obj$_mmlist_instance" style = "display: none; height: 30px; margin: 0 5px 0 0"><a></a></div><div class="$class"></div>$desc
EOJ;
  $_mmlist_instance++;

  return $output;
}

function _rss_page_add_row_js($row) {
  $list = '';
  foreach ($row as $col) {
    $list .= ', ' . drupal_json_encode($col);
  }

  return "    obj.addItem(false$list);\n";
}

function _rss_page_load_feeds($node, $one_feed = '', $mark, &$rss_link, $raw = FALSE) {
  global $user;
  $feeds = &drupal_static(__FUNCTION__, array());

  if (isset($feeds[$node->nid])) {
    unset($rss_link);
    return $feeds[$node->nid];
  }
  $feeds[$node->nid] = array();

  if (!isset($node->rss_feeds) || !is_array($node->rss_feeds)) {
    return array();
  }

  foreach ($node->rss_feeds as $f) {
    if ($one_feed && $f->fid != $one_feed) {
      continue;
    }

    $out = array();
    $newest = 0;
    $atime = NULL;
    $new_rss_link = NULL;
    if (!$mark && $node->type == 'rss_page') {
      $atime = 0;
      if (isset($f->fid)) {
        $atime = db_select('rss_page_last_read', 'r')
          ->fields('r', array('atime'))
          ->condition('r.fid', $f->fid)
          ->condition('r.uid', $user->uid)
          ->execute()->fetchField();
      }
    }

    if ($f->type == 'cat') {     // MM category
      $link = '';
      if (!mm_content_user_can($f->data, MM_PERMS_READ)) {
        $out['error'] = t('You are not allowed to read the page %cat.',
            array('%cat' => $f->name));
      }
      else {
        $cat = mm_content_get($f->data);
        if ($cat) {
          $link = url(mm_content_get_mmtid_url($f->data), array('absolute' => TRUE));
          $out = array(
            'items' => array(),
            'feed_title' => $cat->name,
            'show_item_title' => !$node->rss_page['show_descr'],
            'feed_link' => $link,
            'fid' => isset($f->fid) ? $f->fid : 0,
          );
          _rss_page_feed_from_cat($f->data, NULL, $node, count($feeds[$node->nid]), $mark, $atime, $link, $raw, $newest, $out);
        }
      }
      $new_rss_link = $link . '/feed';
    }

    elseif ($f->type == 'taxon') {     // free tag/term
      $taxon_tids = array_keys(_rss_page_get_taxon($f->data));
      module_load_include('inc', 'monster_menus', 'mm_taxonomy');
      $nids = array();
      foreach ($taxon_tids as $taxon_tid) {
        $result = mm_taxonomy_select_nodes($taxon_tid, FALSE, FALSE);
        foreach ($result as $nid) {
          $nids[] = $nid;
        }
      }
      $nids = array_unique($nids);

      $link = '';
      if (count($nids)) {
        $link = url('taxonomy/term/' . join(',', $taxon_tids), array('absolute' => TRUE));
        $out = array(
          'items' => array(),
          'feed_title' => $f->name,
          'show_item_title' => !$node->rss_page['show_descr'],
          'feed_link' => $link,
          'fid' => isset($f->fid) ? $f->fid : 0,
        );
        _rss_page_feed_from_cat(NULL, $nids, $node, count($feeds[$node->nid]), $mark, $atime, '', $raw, $newest, $out);
      }
      $new_rss_link = $link . '/feed';
    }

    elseif ($f->type == 'query') {  // admin-defined query
      if ($node->rss_page['group_by_key']) {
        $result = db_query(_rss_page_add_vars($f->data, $node));
        foreach ($result as $row) {
          $out = array(
            'items' => array(),
            'feed_title' => $row->name,
            'show_item_title' => !$node->rss_page['show_descr'],
            'feed_link' => '',
            'fid' => $f->fid,
          );
          _rss_page_feed_from_cat(isset($row->mmtid) ? $row->mmtid : NULL, isset($row->nid) ? $row->nid : NULL, $node, count($feeds[$node->nid]), $mark, $atime, '', $raw, $newest, $out);
          if (count($out)) {
            $feeds[$node->nid][] = (object) $out;
          }
        }
        $out = array();
      }
      else {
        $out = array(
          'items' => array(),
          'feed_title' => _rss_page_add_vars($f->name, $node),
          'show_item_title' => !$node->rss_page['show_descr'],
          'feed_link' => '',
          'fid' => $f->fid,
          'expanded' => TRUE,
        );

        $result = db_query(_rss_page_add_vars($f->data, $node));
        foreach ($result as $row) {
          _rss_page_feed_from_cat(isset($row->mmtid) ? $row->mmtid : NULL, isset($row->nid) ? $row->nid : NULL, $node, count($feeds[$node->nid]), $mark, $atime, '', $raw, $newest, $out);
        }
      }
    }

    elseif ($f->type == 'url') {  // external URL
      rss_page_load_simplepie();
      // avoid some errors in SimplePie
      $old_reporting = error_reporting(error_reporting() & ~(E_STRICT|E_USER_NOTICE));
      $feed = new SimplePie();
      $feed->set_feed_url($f->data);
//      $feed->enable_cache(FALSE);
      $feed->set_cache_location(variable_get('rss_page_cache_path', RSS_PAGE_CACHE_PATH_DEFAULT));
      $feed->set_cache_duration(variable_get('rss_page_cache_duration', RSS_PAGE_CACHE_DURATION_DEFAULT));
      $feed->init();
      if (!$feed->error) {
        $feed->handle_content_type();
      }

      if (!$feed->error && $feed->data) {
        $title = SimplePie_Misc::entities_decode($feed->get_title());
        if (empty($f->name_isset) && $title) {
          $f->name_isset = 1;
          db_update('rss_page_feed')
            ->fields(array('name_isset' => 1, 'name' => $title))
            ->condition('name_isset', 1, '<>')
            ->condition('type', 'url')
            ->condition('data', $f->data)
            ->execute();
        }
        if (!$title) {
          $title = $f->name;
        }

        $out = array(
          'items' => array(),
          'feed_title' => $title,
          'show_title' => TRUE,
          'feed_link' => $feed->get_link(),
          'fid' => isset($f->fid) ? $f->fid : 0,
          'img' => $node->rss_page['show_feed_img'] ? $feed->get_image_url() : '',
          'img_title' => $feed->get_image_title(), 'img_width' => $feed->get_image_width(),
          'img_height' => $feed->get_image_height(),
        );

        for ($i = 0; ; $i++) {
          if ($node->rss_page['items'] >= 0 && count($out['items']) >= $node->rss_page['items']) {
            break;
          }

          if (($item = $feed->get_item($i)) == FALSE) {
            break;
          }

          // Take the max of the updated and published fields
          if ($updated = $item->get_item_tags(SIMPLEPIE_NAMESPACE_ATOM_10, 'updated')) {
            $parser = SimplePie_Parse_Date::get();
            $updated = $parser->parse($updated[0]['data']);
          }
          $date = max($item->get_date('U'), $updated);

          if ($mark == 'read' && $node->type == 'rss_page') {
            if ($date > $newest) {
              $newest = $date;
            }
          }
          elseif (is_null($atime) || $atime === FALSE || $date > $atime) {
            $perma = html_entity_decode($item->get_permalink(), ENT_QUOTES);
            $desc = $item->get_description();
            if ($raw) {
              $perma = array('value' => $perma, 'permalink' => 'true');
            }
            else {
              $desc = _rss_page_fix_descr($desc, $node);
              if ($node->rss_page['show_image']) {
                $enclosures = $item->get_enclosures();
                if (is_array($enclosures)) {
                  $enc_html = '';
                  foreach ($enclosures as $enclosure) {
                    $enc_title = check_plain(SimplePie_Misc::entities_decode($item->get_title()));
                    if (stripos($enclosure->type, "image") !== FALSE ) { //image file
                      $enc_html .= '<img src="' . check_url($enclosure->link) . '" alt="' . $enc_title .
                        '" title="' . $enc_title . '" ' . drupal_attributes(array('class' => array('image', 'icon'))) . ' />';
                    }
                    elseif (function_exists('_media_get_icon')) {
                      $icon = _media_get_icon($enclosure->type);
                      if (empty($icon)) {
                        $icon = 'genericdoc.gif';
                      }
                      $url = base_path() . drupal_get_path('module', 'media') . '/icons/' . $icon;
                      $enc_html .= '<a href="' . check_url($enclosure->link) . '"><img src="' . check_url($url) . '" alt="' . $enc_title .
                          '" title="' . $enc_title . '" /></a>';
                    }
                  }
                  if ($enc_html) {
                    $desc = "<p>$desc</p>$enc_html";
                  }
                }
              }
              $desc = '<div class="content">' . $desc . '</div>';
            }

            $out['items'][] = (object)array(
              'feed_index' => count($feeds[$node->nid]),
              'description' => $desc,
              'date' => $date,
              'title' => SimplePie_Misc::entities_decode($item->get_title()),
              'link' => $perma,
              'categories' => $item->get_category(),
            );
          }
        }
        $new_rss_link = $f->data;
      }
      else {    // !$feed->data
        $out = array('error' => _rss_page_rss_error($f->data, $feed), 'feed_title' => $f->name);
      }
      error_reporting($old_reporting);
    }

    if (empty($f->name_isset) && $f->type == 'url') {
      $out['feed_title'] = '';
    }

    if (count($out)) {
      if ($node->type == 'rss_page' && (!isset($out['error']) || !$out['error']) && $user->uid)
        if ($mark == 'read') {
          db_merge('rss_page_last_read')
            ->key(array(
              'fid' => $out['fid'],
              'uid' => $user->uid,
            ))
            ->fields(array(
              'atime' => $newest,
            ))
            ->execute();
        }
        elseif ($mark == 'unread') {
          db_delete('rss_page_last_read')
            ->condition('fid', $out['fid'])
            ->execute();
        }

      $feeds[$node->nid][] = (object)$out;
    }

    $rss_link = !is_null($new_rss_link) && is_null($rss_link) ? $new_rss_link : FALSE;
  }
  return $feeds[$node->nid];
}

function _rss_page_get_taxon($tid) {
  $result = db_select('taxonomy_term_data', 't')
    ->fields('t', array('tid', 'name'))
    ->condition('t.tid', $tid)
    ->execute();
  $taxon_tids = array(); // array only contains terms the user has access to
  foreach ($result as $term) {
    $taxon_tids[$term->tid] = $term->name;
  }
  return $taxon_tids;
}

// split result generated by setHiddenElt in rss_list.js
function _rss_page_split_feed_list($str) {
  if (is_array($str)) return $str;   // trying to split something already in the right format (rss_page_insert)

  $out = array();
  foreach (mm_ui_parse_repeatlist($str, 3) as $m) {
    $data = $m[2];
    if ($m[1] == 'cat') {
      $data = array_slice(explode('/', $data), -1);
      $data = $data[0];
    }
    $out[] = (object)array('name' => $m[0], 'type' => $m[1], 'data' => $data);
  }

  return $out;
}

function _rss_page_info($type, $data, &$name, &$url, &$info, &$popup_URL, $is_portal) {
  if ($type == 'cat') {
    $parents = mm_content_get_parents($data);
    array_shift($parents);  // skip root
    $url = implode('/', $parents) . "/$data";
    if (!isset($popup_URL)) {
      $popup_URL = $url;
    }

    $path = array();
    foreach ($parents as $par) {
      if (!($tree = mm_content_get($par))) {
        break;
      }
      $path[] = mm_content_get_name($tree);
    }

    $path[] = $name;
    $info = implode('&nbsp;&raquo; ', $path);
  }
  elseif ($is_portal && $type == 'query') {
    $info = $name;
    $url = $data;
  }
  elseif ($type == 'taxon') {
    $info = '';
    $url = $data;
  }
  else {  // URL
    $u = preg_replace('/\/(?!\/)/', '/&#8203;', $data);
    $info = strpos($url, str_replace('...', '', $name)) ? $u : $name . '<br />' . $u;
    $url = $data;
  }
}

function _rss_page_item($item, $feed = NULL, $base_url = NULL) {
  $source = '';
  if ($feed && !empty($feed->feed_title) && $base_url && empty($feed->show_item_title)) {
    $source = l($feed->feed_title, $base_url, array(
        'attributes' => array('class' => array('feed-item-source')),
        'query' => _rss_page_get_query_parameters(array('byfeed' => $feed->fid), 'bydate'),
      )) . ' - ';
  }

  if (!$item->date) {
    $source_date = '';
  }
  elseif (date('Ymd', $item->date) == date('Ymd')) {
    $source_date = t('@ago ago', array('@ago' => format_interval(REQUEST_TIME - $item->date)));
  }
  else {
    $source_date = format_date($item->date, 'custom', variable_get('date_format_medium', 'D, Y-m-d H:i'));
  }

  $out = '';
  if ($feed && (!empty($feed->show_title) || !empty($feed->show_item_title))) {
    // l() and check_plain() affect &entities; so don't use them here
    $t = str_replace(array('<', '>'), array('&lt;', '&gt;'), $item->title);
    $out .= '<h3 class="feed-item-title">' . l($t, $item->link, array('html' => TRUE)) .
        "</h3>\n<div class=\"feed-item-meta\">" .
        "$source<span class=\"feed-item-date\">$source_date</span></div>\n";
  }

  if ($item->description) {
    $desc = preg_replace('/(<img [^>]*?\b)alt=/i', '${1}title=', $item->description);
    $out .= "<div class=\"feed-item-body\">$desc</div>\n";
  }

//  if ($item->categories) {
//    $out .= '<div class="feed-item-categories">'. t('Tags') .': '. implode(', ', $item->categories) ."</div>\n";
//  }

  if (!empty($out)) {
    return '<div class="feed-item">' . $out . '</div>';
  }

  return '';
}

function _rss_page_alpha_sort($a, $b) {
  return strcasecmp($a->feed_title, $b->feed_title);
}

function _rss_page_date_sort($a, $b) {
  return strcasecmp($b->date, $a->date);
}

function _rss_page_conditional($node) {
  if (($cond = trim($node->rss_page['view_condition'])) != '') {
    $cond = _rss_page_add_vars($cond, $node);
    if (empty($cond) || eval("return ($cond);") == FALSE) {
      return FALSE;
    }
  }
  return TRUE;
}

/* hook_homebox_amherst_init() */
function rss_page_homebox_amherst_init() {
  // We don't know in advance if the first tab will need these, so always add
  // them
  drupal_add_js('misc/collapse.js');
  drupal_add_library('monster_menus', 'mm');
  drupal_add_js(drupal_get_path('module', 'rss_page') . '/rss_page_homebox.js');
  drupal_add_css(drupal_get_path('module', 'rss_page') . '/rss_page.css');
}

/* hook_homebox_amherst_create_init_tabs() */
function rss_page_homebox_amherst_create_init_tabs() {
  global $user;
  $blocks = array();

  if (!empty($user->user_portal_mmtid)) {
    $default_page = homebox_amherst_get_default_page();

    $q = db_query("SELECT n.nid FROM {mm_node2tree} t INNER JOIN {node} n ON n.nid = t.nid AND n.type = 'rss_page' WHERE mmtid = :mmtid", array(':mmtid' => $user->user_portal_mmtid));
    foreach ($q as $n) {
      $node = node_load($n->nid);
      if ($node->nid && mm_content_user_can_node($node, MM_PERMS_READ) && $node->rss_feeds) {
        $title = trim($node->title);
        if ($title == '') {
          $title = t('Untitled');
        }
        $count = count($blocks);
        $block = array(
          'title' => $title,
          'module' => 'rss_page',
          'delta' => 'content',
          'open' => 1,
          'color' => 'default',
          'status' => 1,
          'region' => ($count % $default_page->settings['regions']) + 1,
          'movable' => 1,
          'closable' => 1,
          'weight' => intval($count / $default_page->settings['regions']),
        );
        foreach (array('rss_items', 'rss_sort', 'rss_display', 'rss_feeds', 'show_descr', 'show_image', 'show_feed_img', 'group_by_key') as $key) {
          $block[$key] = isset($node->$key) ? $node->$key : '';
        }
        $blocks["rss_page_content_$count"] = $block;
      }
    }

    if ($blocks) {
      $name = homebox_amherst_create_tab(t('My RSS'), $default_page->settings['regions'], $blocks);
      return array($name => homebox_amherst_page_load($name));
    }
  }
}

/* Implements hook_homebox_block_keys() */
function rss_page_homebox_block_keys($block) {
  return array('rss_page', 'rss_items', 'rss_sort', 'rss_display', 'rss_feeds', 'show_descr', 'show_image', 'show_feed_img');
}

/* Implements hook_homebox_block_edit_form() */
function rss_page_homebox_block_edit_form($block) {
  // If this is the main config for the page, return the form
  if (homebox_amherst_is_admin_page()) {
    return rss_page_block_form(array(), array(), $block);
  }

  // Otherwise, return a dummy form, so that Homebox will add the gear icon to
  // the widget. It also supplies .js files needed by rss_page_block_form().
  if (!is_numeric($block->delta) && $block->delta != 'untitled') {
    drupal_add_library('monster_menus', 'mm');
    return array();
  }

  return array(array(
    '#markup' => '<div class="homebox-amherst-no-settings"></div>',
  ));
}

function rss_page_load_simplepie() {
  static $loaded;
  if (!empty($loaded)) {
    return;
  }
  $loaded = TRUE;
  if (module_exists('feeds') && feeds_include_simplepie()) {
    return;
  }
  if (module_exists('libraries')) {
    $lib_path = libraries_get_path('simplepie');
  }
  foreach (array('simplepie.mini.php', 'simplepie.php') as $file) {
    if (!empty($lib_path) && file_exists("$lib_path/$file")) {
      require "$lib_path/$file";
      return;
    }
    $path = DRUPAL_ROOT . '/sites/all/libraries/' . $file;
    if (file_exists($path)) {
      require $path;
      return;
    }
  }
  // Last chance: autoload simplepie.inc in the same directory as this module.
  if (!class_exists('SimplePie')) {
    throw new Exception('Could not load simplepie.inc');
  }
}

function rss_page_fix_portal_page_title($title) {
  return preg_replace('{^Portal Page:\s+(.*?)(\s+\(node/\d+\))?$}', '\1', $title);
}

function rss_page_default_block_options($in = NULL) {
  global $user;

  if (empty($in)) $in = (object)array();
  $opts = rss_page_get_options();
  if (isset($in->rss_page)) {
    $rss_page = $in->rss_page;
  }
  else {
    $rss_page = $opts;
    foreach (array_keys($opts) as $key) {
      $inkey = $key;
      if (in_array($key, array('items', 'sort', 'display'))) {
        $inkey = "rss_$key";
      }

      if (isset($in->$inkey)) {
        $rss_page[$key] = $in->$inkey;
      }
    }
  }

  return (object)array(
    'nid' => isset($in->key) ? $in->key : 'undefined',
    'uid' => $user->uid,
    'type' => 'rss_page',
    'rss_page' => $rss_page,
    'rss_items' => isset($in->rss_items) ? $in->rss_items : $opts['items'],
    'rss_sort' => isset($in->rss_sort) ? $in->rss_sort : $opts['sort'],
    'rss_display' => isset($in->rss_display) ? $in->rss_display : $opts['display'],
    'rss_feeds' => isset($in->rss_feeds) ? $in->rss_feeds : array(),
    'title' => isset($in->title) ? $in->title : (isset($in->subject) ? $in->subject : ''),
    'show_descr' => isset($in->show_descr) ? $in->show_descr : $opts['show_descr'],
    'show_image' => isset($in->show_image) ? $in->show_image : $opts['show_image'],
    'show_feed_img' => isset($in->show_feed_img) ? $in->show_feed_img : $opts['show_feed_img'],
    'group_by_key' => isset($in->group_by_key) ? $in->group_by_key : $opts['group_by_key'],
    'condition' => '',
  );
}

function _rss_page_block($delta, $node, &$rss_link, $show_add_link = FALSE, $edit = NULL) {
  global $user;

  $collapsible = TRUE;

  $block = array('content' => array(), 'subject' => '', 'count' => 0);

  mm_parse_args($mmtids, $oarg_list, $this_tid);
  if ($node == NULL) {
    if (is_array($edit) && isset($edit['homebox'])) {
      $node = rss_page_default_block_options($edit['homebox']);
      $node->dups_in_node = TRUE;   // only crunch duplicates within this "node"
      if ($delta == 'content') {
        $block['content'][] = array('#markup' => '<input type="hidden" name="rss-page-block-key" value="' . $edit['homebox']->key . '" />');
      }
    }
    else if (count($oarg_list) < 2 || $oarg_list[0] != 'node' ||
        (count($oarg_list) > 2 && $oarg_list[2] == 'contents') ||
        !is_numeric($oarg_list[1]) || !($node = node_load($oarg_list[1])) ||
        !$node->nid || ($node->type != 'rss_page' && $node->type != 'portal_page')) {
      return $block;
    }
  }

  if ($node->type != 'rss_page' && $delta == 'nav') {   // no nav unless rss_page
    return $block;
  }

  $base_url = "mm/$this_tid";
  if (isset($oarg_list[0]) && $oarg_list[0] == 'node') {
    $base_url .= "/node/$node->nid";
  }

  $sort = isset($node->rss_page) && isset($node->rss_page['sort']) ? $node->rss_page['sort'] : 'date';
  if (isset($_GET['bydate'])) {
    $sort = 'date';
  }

  $one_feed = '';
  if (isset($_GET['byfeed'])) {
    $sort = 'feed-alpha';
    if (intval($_GET['byfeed']))
      $one_feed = intval($_GET['byfeed']);
  }

  $mark = '';
  if (isset($_GET['read'])) {
    $mark = 'read';
  }
  elseif (isset($_GET['unread'])) {
    $mark = 'unread';
  }

  if (isset($node->rss_feeds) && is_string($node->rss_feeds)) {
    $node->rss_feeds = _rss_page_split_feed_list($node->rss_feeds);
  }

  $feeds = _rss_page_load_feeds($node, $one_feed, $mark, $rss_link);

  if ($mark) {
    $_rss_page_future_goto = &drupal_static('_rss_page_future_goto');
    $_rss_page_future_goto = url($base_url, array(
      'absolute' => TRUE,
      'query' => _rss_page_get_query_parameters(NULL, array('read', 'unread')))
    );
  }

  if (count($feeds)) {
    if ($sort == 'feed-alpha') {
      usort($feeds, '_rss_page_alpha_sort');
    }

    if ($delta == 'nav') {
      $menu = '';
      if ($user->uid) {
        $menu .= '<li>' . l(t('(mark all read)'), $base_url, array('query' => _rss_page_get_query_parameters('read'))) . "</li>\n";
        $menu .= '<li>' . l(t('(mark all unread)'), $base_url, array('query' => _rss_page_get_query_parameters('unread'))) . "</li>\n";
      }

      if ($sort == 'date') {
        $query = $node->rss_page['sort'] == 'feed-alpha' || $node->rss_page['sort'] == 'feed-weight' ? array() : _rss_page_get_query_parameters('byfeed', 'bydate');
        $menu .= '<li>' . l(t('(sort by feed)'), $base_url, array('query' => $query)) . "</li>\n";
      }
      else {
        if (!$collapsible) {
          foreach ($feeds as $f) {
            if (!$f->error) {
              $menu .= "<li><a href=\"#$f->fid\">" . _rss_page_feed_title($f) . "</a></li>\n";
            }
          }
        }
        $menu .= '<li>' . l(t('(sort by date)'), $base_url, array('query' => _rss_page_get_query_parameters('bydate', 'byfeed'))) . "</li>\n";
      }

      if ($menu) {
        $block['content'] = array('#markup' => "<div class=\"item-list\"><ul>$menu</ul></div>");
        $block['subject'] = check_plain(_rss_page_add_vars($node->title, $node));
      }
    }
    elseif ($delta == 'content') {
      drupal_add_css(drupal_get_path('module', 'rss_page') . '/rss_page.css');
      $block['content'][] = array('#markup' => '<div id="rss-page">');

      if ($sort == 'date') {
        $items = array();
        foreach ($feeds as $f) {
          if (!empty($f->error)) {
            $block['content'][] = array('#markup' => '<div class="feed-source2">' . _rss_page_feed_title($f) .
                '</div><div class="feed-item"><div class="feed-item-meta">' .
                $f->error . '</div></div>');
          }
          else {
            $items = array_merge($items, $f->items);
          }
        }

        usort($items, '_rss_page_date_sort');
        $found = array();

        foreach ($items as $item) {
          if ($item->link) {   // remove duplicates, favoring newer
            if (!empty($found[$item->link])) {
              continue;
            }
            $found[$item->link] = TRUE;
          }

          if ($item->title) {
            if (!empty($found[$item->title])) {
              continue;
            }
            $found[$item->title] = TRUE;
          }

          $out = _rss_page_item($item, $feeds[$item->feed_index], $base_url);
          $non_html = trim(strip_tags($out));
          if (!empty($non_html)) {
            $block['content'][] = array('#markup' => $out);
            $block['count']++;
          }
        }
      }
      else {    // $sort != 'date'
        $index = 0;
        foreach ($feeds as $f) {
          if ($collapsible) {
            if (!empty($f->error)) {
              $block['content'][] = array('#markup' => '<fieldset class="collapsible"><legend>' . _rss_page_feed_title($f) . '</legend><div class="feed-item"><div class="feed-item-meta">' . $f->error . '</div></div></fieldset>');
            }
            elseif ($node->type == 'rss_page' || count($f->items)) {
              $fieldset = array(
                '#type' => 'fieldset',
                '#title' => _rss_page_feed_title($f),
                '#collapsible' => TRUE,
                '#collapsed' => $node->type != 'rss_page' || !is_numeric($node->nid),
                '#parents' => array(),
              );
              if ($show_add_link && !empty($f->fid)) {
                $fieldset[] = rss_page_subscribe_button($f->fid);
              }

              if (!empty($f->feed_link)) {
                $fieldset[] = array('#markup' => '<div class="feed-source">' . l(t('source'), $f->feed_link) . '</div>');
              }

              if (!empty($f->img)) {
                $fieldset[] = array('#markup' => "<div class=\"feed-icon\"><img src=\"$f->img\" alt=\"$f->img_title\"></div>");
              }

              foreach ($f->items as $item) {
                $out = _rss_page_item($item, $feeds[$item->feed_index]);
                $non_html = trim(strip_tags($out));
                if (!empty($non_html)) {
                  $fieldset[] = array('#markup' => $out);
                  $block['count']++;
                }
              }

              $state = array();
              form_process_fieldset($fieldset, $state);
              $block['content'][] = $fieldset;
            }
          }
          else {    // !$collapsible
            if ($index++ || $node->rss_page['display'] == '1-col') {
              $block['content'][] = array('#markup' => '<hr>');
            }
            $block['content'][] = array('#markup' => "<a name=\"$f->fid\"></a><div class=\"feed-source2\">");
            if ($f->img) {
              $block['content'][] = array('#markup' => "<div class=\"feed-icon\"><img src=\"$f->img\" alt=\"$f->img_title\"></div>");
            }
            $block['content'][] = array('#markup' => _rss_page_feed_title($f) . '</div>');

            if ($f->error) {
              $block['content'][] = array('#markup' => '<div class="feed-item"><div class="feed-item-meta">' . $f->error . '</div></div>');
            }
            else {
              foreach ($f->items as $item) {
                $out = _rss_page_item($item, $feeds[$item->feed_index]);
                $non_html = trim(strip_tags($out));
                if (!empty($non_html)) {
                  $block['content'][] = array('#markup' => $out);
                  $block['count']++;
                }
                $block['count']++;
              }
            }
          }
        }
      }
      $block['content'][] = array('#markup' => '</div>');  // aggregator
    }
  }
  else if (isset($edit['homebox'])) {
    drupal_add_css(drupal_get_path('module', 'rss_page') . '/rss_page.css');
    $block['subject'] = t('(untitled)');
    // Arguments to format_plural() don't need t()
    $block['content'][] = array('#markup' => count($node->rss_feeds) ? format_plural(count($node->rss_feeds), 'This feed is empty.', 'The feeds are empty.') : t('Click on the gear icon to add a feed'));
    $block['count']++;
  }
  return $block;
}

function _rss_page_fix_descr($desc, $node) {
  if (!$node->rss_page['show_descr']) {
    return '';
  }
  // Remove IMG and TABLE tags. This has to be done here, not in SimplePie,
  // because SP caches the change so it affects all readers of that feed.
  if (!$node->rss_page['show_image']) {
    $desc = preg_replace("{<(img|table|tr|td|th|tbody)((\s*((\w+:)?\w+)\s*=\s*(\"([^\"]*)\"|'([^']*)'|(.*)))*)\s*(/>|>)|</(table|tr|td|th|tbody)>}msiU", ' ', $desc);
  }
  return $desc;
}

function _rss_page_feed_title($feed) {
  if (empty($feed->feed_title)) {
    return t('Unknown feed');
  }
  return check_plain($feed->feed_title) . ' (' . (isset($feed->items) ? count($feed->items) : '0') . ')';
}

function rss_page_load_as_user() {
  global $user;
  $loaded = &drupal_static(__FUNCTION__);

  // Substitute vars based on $_SESSION['vars_uid']. The current user can't see
  // posts he doesn't have permission to; instead, this just lets the user see
  // how it would look.
  if (!isset($loaded)) {
    if (user_access('create portal pages') && isset($_SESSION['vars_uid'])) {
      $vu = $_SESSION['vars_uid'];
    }

    if (!isset($vu)) {
      $vu = $user->uid;
    }

    $loaded = user_load($vu);
  }

  return $loaded;
}

function _rss_page_add_vars($str, $node) {
  $xvars = rss_page_get_xvars();
  $loaded = rss_page_load_as_user();
  // The /e switch is deprecated in PHP >= 5.5, but anonymous functions are
  // only available in PHP >= 5.3.
  if (PHP_MAJOR_VERSION == 5 && PHP_MINOR_VERSION < 3) {
    return preg_replace('/\$\{([A-Za-z_]\w*)\}/e',
      'isset($loaded->\1) && is_scalar($loaded->\1) ? $loaded->\1 : ' .
      '(isset($xvars["\1"]) ? eval("return(".$xvars["\1"].");") : "")', $str);
  }
  return preg_replace_callback('/\$\{([A-Za-z_]\w*)\}/',
    function ($matches) use ($xvars, $loaded, $node) {
      return isset($loaded->$matches[1]) && is_scalar($loaded->$matches[1]) ? $loaded->$matches[1] : (isset($xvars[$matches[1]]) ? eval("return(" . $xvars[$matches[1]] . ");") : "");
    }, $str);
}

function _rss_page_feed_from_cat($tid, $nid, $node, $index, $mark, $atime, $link, $raw, &$newest, &$out) {
  $showed = &drupal_static(__FUNCTION__);

  if (isset($nid)) {
    $arr = is_array($nid) ? $nid : array($nid);
  }
  elseif (is_null($tid)) {
    return;
  }
  else {
    $out['feed_link'] = mm_content_get_mmtid_url($tid);
    $arr = db_query(mm_content_get_accessible_nodes_by_mmtid_query($tid, $count_sql))->fetchCol();
  }

  foreach ($arr as $n) {
    $showed_key = !empty($node->dups_in_node) ? "$node->nid/$n" : $n;
    if (!empty($showed[$showed_key]) || !mm_content_user_can_node($n, MM_PERMS_READ)) {
      continue;
    }

    if ($node->rss_page['items'] >= 0 && count($out['items']) >= $node->rss_page['items']) {
      return;
    }

    $kidnode = node_load($n);
    if ($kidnode && $kidnode->nid && $kidnode->type != 'rss_page' &&
        $kidnode->type != 'portal_page' && $kidnode->type != 'redirect') {
      if ($mark == 'read') {
        if ($kidnode->changed > $newest) {
          $newest = $kidnode->changed;
        }
      }
      elseif (is_null($atime) || $kidnode->changed > $atime) {
        $cats = array();
        if (isset($kidnode->taxonomy)) {
          foreach ($kidnode->taxonomy as $t) {
            $cats[] = $t->name;
          }
        }

        $ln = $link != '' ? "$link/node/$kidnode->nid" : url("node/$kidnode->nid", array('absolute' => TRUE));
        if ($raw) {
          $ln = array('value' => $ln, 'permalink' => 'true');
        }

        $extra = array();
        $kidnode->title = mm_ui_hide_node_title($kidnode->title);
        if ($raw) {
          $desc = _rss_page_raw_node($kidnode, $raw, $extra);
        }
        else {
          $viewed = node_view($kidnode, 'teaser');
          if (empty($viewed['#node']->body)) {
            // If the body is empty, remove any Read More link.
            unset($viewed['links']['node']['#links']['node-readmore']);
          }
          $desc = drupal_render($viewed);
        }
        $out['items'][] = (object)array(
          'extra' => $extra,
          'feed_index' => $index,
          'uid' => mm_ui_show_author($kidnode->type) ? $kidnode->uid : NULL,
          'description' => $raw ? $desc : _rss_page_fix_descr($desc, $node),
          'date' => $kidnode->changed,
          'title' => $kidnode->title,
          'link' => $ln,
          'categories' => $cats,
        );
        $showed[$showed_key] = TRUE;
      }
    }
    else $showed[$showed_key] = TRUE;    // slight speed-up
  }
}

function _rss_page_raw_node($item, $item_length, &$extra) {
  $item_text = '';

  if ($item_length != 'title') {
    $teaser = $item_length == 'teaser';

    // Filter and prepare node teaser
    if (node_hook($item, 'view')) {
      $item = node_invoke($item, 'view', $teaser, FALSE);
    }

    // Allow modules to change $node->teaser before viewing.
    module_invoke_all('node_' . $item, 'view', $teaser, FALSE);
  }

  // Allow modules to add additional item fields and/or modify $item
  $extra = module_invoke_all('node_' . $item, 'rss item');

  // Prepare the item description
  switch ($item_length) {
    case 'fulltext':
      $item_text = $item->body;
      break;

    case 'teaser':
      $item_text = $item->teaser;
      if ($item->readmore) {
        $item_text .= '<p>' . l(t('read more &raquo;'), 'node/' . $item->nid, array('absolute' => TRUE, 'html' => TRUE)) . '</p>';
      }
      break;

    case 'title':
      break;
  }

  return $item_text;
}

/*
 * Called by template.php to add a 'Subscribe to this tag' link
 */
function rss_page_tag_feed_link($link) {
  $path = explode('/', $link['href']);
  if ($path[0] == 'taxonomy' && $path[1] == 'term' && intval($path[2])) {
    $title = t('Add this tag to my portal');
    $img = &drupal_static(__FUNCTION__);
    if (!isset($img)) {
      $img = '<img src="' . url(drupal_get_path('module', 'rss_page') . '/subscribe_to_tag.gif') . '" title="' . $title . '">';
    }

    return l($img,
      'myportal/add/taxon/' . $path[2], array(
        'html' => TRUE,
        'attributes' => array(
          'class' => array('thickbox', 'addtag'),
          'title' => $title),
        'query' => array('width' => 300, 'height' => 130),
      )
    );
  }
}

function _rss_page_add_to_portal($type, $data) {
  drupal_add_http_header('Content-type', 'text/html');
  drupal_add_http_header('x-devel-off', 'true');

  $render = drupal_get_form('_rss_page_add_to_portal_form', $type, $data);
  print drupal_render($render);
  $alert1 = drupal_json_encode(t('You must enter a name for the new tab.'));
  $alert2 = drupal_json_encode(t('You must enter a name for the new widget.'));
  drupal_add_js(<<<EOJ
(function (\$) {
rssAddToPortal = function(form, go) {
  if (!go) {
    var matches = \$('#edit-existing', form).val().split('/');
    if (!matches[1]) {
      \$('#outerdiv-existing', form).hide();
      \$('#outerdiv-newcat', form).show().find('#edit-newcat')[0].focus();
      if (!matches[0]) \$('#outerdiv-newtab', form).show().find('#edit-newtab')[0].focus();
      return false;
    }
  }
  var parms = \$(':input', form).serialize();
  var action = form.action.split('?', 2);
  \$('#TB_ajaxContent').html('');
  tb_show('', action[0] + '?' + parms + '&' + action[1], false);
  return false;
};

rssAddToPortalSubmit = function(form) {
  var tmp = \$("#edit-newtab:not(:hidden)", form);
  if (tmp.length && tmp.val().search(/\S/) == -1) {
    alert($alert1);
    return false;
  }
  tmp = \$("#edit-newcat", form);
  if (tmp.length && tmp.val().search(/\S/) == -1) {
    alert($alert2);
    return false;
  }
  return rssAddToPortal(form, true);
};
})(jQuery);
EOJ
    , array('type' => 'inline', 'scope' => 'rss_page'));
  print drupal_get_js('rss_page');
  exit();
}

function _rss_page_add_to_portal_alert($msg, $button) {
  $form['msg'] = array(
    '#prefix' => '<div id="message">',
    '#markup' => $msg,
    '#suffix' => '</div>',
  );
  $form['cancel'] = array(
    '#type' => 'submit',
    '#value' => $button,
    '#attributes' => array('onclick' => '(function ($) {$("#TB_overlay").click();})(jQuery);return false;')
  );
  return $form;
}

function _rss_page_add_to_portal_form($form, &$form_state, $type, $data) {
  $user_pages = homebox_amherst_init_user_tabs();

  if ($type == 'dup') {
    $old = db_query('SELECT type, data FROM {rss_page_feed} WHERE fid = :fid', array(':fid' => $data))->fetchObject();
  }
  $exists = FALSE;
  $tabs = array('' => t('(choose)'));
  foreach ($user_pages as $page) {
    $page = homebox_amherst_merge_settings($page);
    if (empty($page->settings['enabled']) || !empty($page->settings['other_name']) || !empty($page->settings['no_access'])) continue;
    $tindex = t('!title tab', array('!title' => $page->settings['title']));
    $tabs[$tindex] = array();
    foreach ($page->settings['blocks'] as $bindex => $block) {
      if ($block['module'] == 'rss_page' && $block['delta'] == 'content') {
        if (!$exists) {
          foreach ($block['rss_feeds'] as $feed) {
            if ($type == 'dup') {
              $exists = $feed->type == $old->type && $feed->data == $old->data;
            }
            else {
              $exists = $feed->type == $type && $feed->data == $data;
            }

            if ($exists) {
              break;
            }
          }
        }

        $tabs[$tindex][$page->tabid . '/' . $bindex] = trim($block['title']) == '' ? t('(untitled)') : $block['title'];
      }
    }

    $tabs[$tindex][$page->tabid . '/'] = t('(create a new widget on this tab)');
  }

  $tabs['/'] = t('(create a new tab)');

  if ($exists) {
    return _rss_page_add_to_portal_alert(t('This subscription is already present in your portal.'), t('Cancel'));
  }

  if (isset($_GET['form_build_id'])) {
    return _rss_page_add_to_portal_form_submitted($_GET);
  }

  $form = array();
  $form['feed_type'] = array(
    '#type' => 'hidden',
    '#value' => $type
  );
  $form['data'] = array(
    '#type' => 'hidden',
    '#value' => $data
  );

  $form['outerdiv-existing'] = array(
    '#prefix' => '<div id="outerdiv-existing">',
    '#suffix' => '</div>'
  );
  $form['outerdiv-existing']['existing'] = array(
    '#type' => 'select',
    '#title' => t('Choose a feed widget'),
    '#options' => $tabs,
    '#attributes' => array('onchange' => 'return rssAddToPortal(this.form)')
  );
  $form['outerdiv-newtab'] = array(
    '#prefix' => '<div id="outerdiv-newtab" style="display: none">',
    '#suffix' => '</div>'
  );
  $form['outerdiv-newtab']['newtab'] = array(
    '#type' => 'textfield',
    '#title' => t('Name of new tab'),
    '#size' => 20, '#maxlength' => 128,
  );
  $form['outerdiv-newcat'] = array(
    '#prefix' => '<div id="outerdiv-newcat" style="display: none">',
    '#suffix' => '</div>'
  );
  $form['outerdiv-newcat']['newcat'] = array(
    '#type' => 'textfield',
    '#title' => t('Name of new widget'),
    '#size' => 20, '#maxlength' => 128,
  );
  $form['outerdiv-newcat']['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Create'),
    '#attributes' => array('onclick' => 'return rssAddToPortalSubmit(this.form)'),
  );
  $form['outerdiv-newcat']['cancel'] = array(
    '#type' => 'submit',
    '#value' => t('Cancel'),
    '#attributes' => array('onclick' => 'return tb_remove()'),
  );

  return $form;
}

/*
 * Add an RSS page to a portal
 */
function _rss_page_add_to_portal_form_submitted($form_values) {
  if ($err = _rss_page_add_to_portal_create($form_values['feed_type'], $form_values['data'], $form_values['existing'], check_plain(trim($form_values['newtab'])), check_plain(trim($form_values['newcat'])))) {
    return _rss_page_add_to_portal_alert($err, t('Cancel'));
  }

  $form['unload'] = array(
    '#prefix' => '<script type="text/javascript">',
    '#markup' => '(function ($) {$("#TB_overlay").click();})(jQuery);',
    '#suffix' => '</script>',
  );
  return $form;
}

function _rss_page_add_to_portal_create($type, $data, $existing, $new_tab_name, $new_cat_name) {
  if ($type == 'cat') {
    $data = intval($data);
    if ($data) {
      $mmtree = mm_content_get($data);
    }

    if (!$mmtree || !mm_content_user_can($mmtree->mmtid, MM_PERMS_READ)) {
      return t('You are not allowed to read the page you tried to add to your portal.');
    }

    $feed_data = $mmtree->mmtid;
    $feed_name = $mmtree->name;
  }
  elseif ($type == 'taxon') {
    $data = intval($data);
    $taxon = _rss_page_get_taxon($data);
    if (!$taxon) {
      return t('You are not allowed to read the feed you tried to add to your portal.');
    }

    $feed_data = $data;
    $feed_name = $taxon[$data];
  }
  elseif ($type == 'dup') {
    $data = intval($data);
    $a = db_select('rss_page_feed', 'f')
      ->fields('f', array('type', 'data', 'name', 'nid'))
      ->condition('f.fid', $data)
      ->execute()->fetchAssoc();
    if ($a) {
      list($type, $feed_data, $feed_name, $nid) = array_values($a);
    }

    if (!$a || !mm_content_user_can_node($nid, MM_PERMS_READ)) {
      return t('You are not allowed to read the feed you tried to add to your portal.');
    }
  }
  else {
    $feed_name = $feed_data = $data;
  }

  $user_pages = homebox_amherst_init_user_tabs();

  // Validate the tabid/blockid. If tabid is empty, test for existing tab with
  // the same name before creating.
  list($tabid, $bindex) = explode('/', $existing);
  $tabid_ok = empty($tabid);
  $bindex_ok = empty($bindex);
  foreach ($user_pages as $pindex => $page) {
    $page = homebox_amherst_merge_settings($page);
    if (empty($page->settings['enabled']) || !empty($page->settings['other_name']) || !empty($page->settings['no_access'])) continue;

    if (empty($tabid)) {
      if (strtoupper($page->settings['title']) == strtoupper($new_tab_name)) {
        return t('A tab with this name already exists on your portal.');
      }
    }
    else if ($tabid == $page->tabid) {
      $tabid_ok = TRUE;
      $edit_page = &$user_pages[$pindex];
    }

    if (!$bindex_ok && in_array($bindex, array_keys($page->settings['blocks']))) {
      // Use a reference, for $edit_block, later
      $edit_block = &$user_pages[$pindex]->settings['blocks'][$bindex];
      if ($edit_block['module'] == 'rss_page' && $edit_block['delta'] == 'content') {
        $bindex_ok = TRUE;
      }
    }
  }

  if (!$tabid_ok || !$bindex_ok) {
    return t('An error occurred. Please try reloading this page.');
  }

  if ($type == 'url') {
    rss_page_load_simplepie();
    // avoid some errors in SimplePie
    $old_reporting = error_reporting(error_reporting() & ~(E_STRICT|E_USER_NOTICE));
    $feed = new SimplePie();
    $feed->set_feed_url($feed_data);
    $feed->set_cache_location(variable_get('rss_page_cache_path', RSS_PAGE_CACHE_PATH_DEFAULT));
    $feed->set_cache_duration(variable_get('rss_page_cache_duration', RSS_PAGE_CACHE_DURATION_DEFAULT));
    $feed->init();
    if (!$feed->error) {
      $feed->handle_content_type();
    }
    error_reporting($old_reporting);

    if (!$feed->error && $feed->data) {
      $feed_name = SimplePie_Misc::entities_decode($feed->get_title());
    }
    else {
      return _rss_page_rss_error($feed_data, $feed);
    }
  }

  $feed = (object)array(
    'type' => $type,
    'data' => $feed_data,
    'name' => $feed_name,
    'name_isset' => TRUE,
  );

  if (empty($tabid) || empty($bindex)) {
    $edit_block = (array)rss_page_default_block_options();
    $edit_block['title'] = $edit_block['subject'] = $new_cat_name;
    $edit_block['rss_feeds'][] = $feed;
    if (empty($tabid)) {
      $edit_page = homebox_amherst_homebox_user_tab(homebox_amherst_create_tab($new_tab_name, 3, array($edit_block)));
    }
    homebox_amherst_add_block($edit_page, $new_cat_name, 'rss_page', 'content', 1, 0, $edit_block);
  }
  else {
    // Modify using reference
    $edit_block['rss_feeds'][] = $feed;
    homebox_amherst_save_user_blocks($edit_page, $edit_page->settings['blocks']);
  }

  return FALSE;
}

function _rss_page_rss_error($url, $feed) {
  // Truncate a needlessly confusing message.
  $feed->error = preg_replace('{A feed with an invalid mime.*$}', '', $feed->error);

  $eurl = array('%url' => $url, '@err' => $feed->error);
  if (!strncmp($feed->error, 'A feed could not be found at ', 29) && strpos($url, $_SERVER['SERVER_NAME']) !== FALSE)
    return $feed->error . ". \n" . t('To subscribe to a password-protected page inside this site, you should use a "Page Feed", not a URL.');

  return strcmp($feed->error, 'Operation timed out') ?
      (strpos($feed->error, $url) === FALSE ? t('Error when accessing %url:<br />@err', $eurl) : $feed->error) :
      t('The RSS server at %url took too long to respond.', $eurl);
}

function rss_page_intval_load($val) {
  $val = intval($val);
  return $val ? $val : FALSE;
}

function rss_page_get_xvars() {
  static $xvars;
  if (empty($xvars)) {
    $xvars = array(
      'url' => '"' . request_path() . '"',
      'nid' => '$node->nid',
    );
  }
  return $xvars;
}

function _rss_page_menu_access_add_portal($type) {
  return module_exists('homebox_amherst') && module_exists('amherstprofile') && user_access('create rss pages') && variable_get('mm_enable_rss', FALSE) && in_array($type, array('cat', 'taxon', 'dup'));
}

function _rss_page_get_query_parameters($add = '', $exclude = array()) {
  $get = $_GET;
  unset($get['q']);

  if (!is_array($exclude)) $exclude = array($exclude);

  if (isset($add)) {
    if (!is_array($add)) $add = array($add => '');
    $get += $add;
  }

  return drupal_get_query_parameters($get, $exclude);
}

function rss_page_subscribe_button($rss_key = NULL) {
  $_mm_page_subscribe_item = &drupal_static('_mm_page_subscribe_item');

  $imgpath = drupal_get_path('theme', 'default');
  $allow_portal = module_exists('homebox_amherst') && module_exists('amherstprofile') && user_access('create rss pages') && variable_get('mm_enable_rss', FALSE);
  if ($rss_key) {
    if ($allow_portal) {
      return '<div class="add-portal-rss">' . l(
        '<img src="' . url("$imgpath/images/add_to_my_portal.gif") . '" alt="' . t('Add this RSS feed to my portal') . '">',
        "myportal/add/dup/$rss_key",
        array(
          'attributes' => array(
            'class' => array('thickbox'),
            'title' => t('Add this RSS feed to my portal')
          ),
          'query' => array('width' => 300, 'height' => 150),
          'html' => TRUE
        )) . '</div>';
    }
  }
  elseif ($_mm_page_subscribe_item) {
    $mmtid = $_mm_page_subscribe_item->mmtid;
    $output = '';
    $data = array();
    if ($_mm_page_subscribe_item->rss) {
      if ($allow_portal) {
        $output .= _rss_page_subscribe_button_img($imgpath, 'portal');
        $data['portal'] = "myportal/add/cat/$mmtid";
      }

      $anon_can_see = mm_content_user_can($mmtid, MM_PERMS_READ, user_load(0));
      if ($anon_can_see || module_exists('httpauth')) {
        $output .= _rss_page_subscribe_button_img($imgpath, 'rss');
        $auth = $anon_can_see ? '' : 'authenticate';
        $data['rss'] = url("mm/$mmtid/feed", array('absolute' => TRUE, 'query' => (!empty($auth) ? array($auth => 'true') : array())));
        $data['rss_auth'] = $auth;
      }
    }

    if (variable_get('rss_page_show_page_permalink', FALSE)) {
      $external = $permalink = "mm/$mmtid";
      _rss_page_rewrite_outbound($external);
      if ($external != variable_get('site_404', '') && $external != variable_get('site_403', '') && $external != variable_get('httpauth_site_403', '')) {
        $output .= _rss_page_subscribe_button_img($imgpath, 'permalink');
        $data['permalink'] = url('', array('absolute' => TRUE)) . $permalink;
      }
    }

    if ($output) {
      return '<div id="add-to-small" class="mm-subscribe">' . $output . '</div>' . _rss_page_subscribe_html($data);
    }
  }
}

/* Referenced by rss_page_subscribe_button */
function rss_page_subscribe_js() {
  return <<<EOJ
(function ($) {
Drupal.behaviors.MMSubscribe = {
  attach: function (context, settings) {
    \$('.mm-subscribe', context).once('mm-subscribe', function () {
        var parent = this.parentNode;
        \$(document).keypress(function(e) {
          if (e.keyCode == 27) {
            \$('#mm-subscribe-menu-close:visible', parent).click();
          }
        });
        var reposition = function() {
          var buttns = \$('#add-to-small');
          var menu = \$('#mm-subscribe-menu', parent);
          menu.css('left', buttns.offset().left + buttns.width() - menu.width() - 10);
        };
        \$(window).resize(reposition);
        \$('a', this).click(function() {
          reposition();
          \$('#mm-subscribe-menu', parent)
            .animate({
                'height': 'toggle' },
              'fast');
          return false;
        });
        \$('#mm-subscribe-menu-portal a', parent).mouseup(function() {
          \$('#mm-subscribe-menu', parent).hide();
          return false;
        });
        \$('#mm-subscribe-menu-close', parent).click(function() {
          \$('#mm-subscribe-menu', parent)
            .animate({
                'height': 'hide' },
              'fast');
          return false;
        });
        \$('#mm-subscribe-menu-rss input', parent)
          .focus(function() {
            \$('#mm-subscribe-menu-rss-warn', parent)
              .animate({
                  'height': 'show' },
                'fast');
            \$(this).select();
            return false;
          })
          .blur(function() {
            \$('#mm-subscribe-menu-rss-warn', parent)
              .animate({
                  'height': 'hide' },
                'fast');
          })
          .mousedown(function() {   // needed for Safari
            \$(this).focus();
            \$(this).select();
            return false;
          });
        \$('#mm-subscribe-menu-permalink input', parent)
          .focus(function() {
            \$(this).select();
            return false;
          })
          .mouseup(function() {   // needed for Safari
            \$('#mm-subscribe-menu-rss input', parent).blur();
            \$(this).focus();
            \$(this).select();
            return false;
          });
      });
  }
};
})(jQuery);
EOJ
  ;
}

/* Referenced by rss_page_subscribe_button */
function _rss_page_subscribe_html($data) {
  $imgpath = drupal_get_path('theme', 'default') . '/images/add_widget_icons';
  $close = t('Close');
  $output = <<<EOH
<div id="mm-subscribe-menu" style="display: none">
<div id="mm-subscribe-menu-close"><a href="#">$close</a></div>
EOH;

  if (!empty($data['portal'])) {
    $portal_img = '<img src="' . url("$imgpath/amherst_a_tiny.png") . '" alt="">';
    $portal = l(
      variable_get('rss_page_subscribe_menu_portal', t('Add to my portal')),
      $data['portal'],
      array(
        'attributes' => array(
          'class' => array('thickbox'),
        ),
        'query' => array(
          'width' => 300,
          'height' => 150,
        ),
        'html' => TRUE
      ));
    $output .= <<<EOH
<div id="mm-subscribe-menu-portal"><p>$portal_img$portal</p></div>
EOH;
  }

  if (!empty($data['rss'])) {
    $rss_img = '<img src="' . url("$imgpath/rss.png") . '" alt="">';
    $rss = variable_get('rss_page_subscribe_menu_rss', t('Copy this URL to add this page to an external news reader:'));
    $rss_text = '<input type="text" size="15" value="' . check_plain($data['rss']) . '">';
    $rss_warn = empty($data['rss_auth']) ? '' : '<div id="mm-subscribe-menu-rss-warn" style="display: none">' . variable_get('rss_page_subscribe_menu_rss_warn', t("This URL may not work with all readers; some readers can't subscribe to password-protected pages.")) . '</div>';
    $output .= <<<EOH
<div id="mm-subscribe-menu-rss"><p>$rss</p>$rss_img$rss_text$rss_warn</div>
EOH;
  }

  if ($data['permalink']) {
    $permalink_img = '<img src="' . url("$imgpath/permalink.png") . '" alt="">';
    $permalink = variable_get('rss_page_subscribe_menu_permalink', t('Copy this URL to bookmark this page or send the link to someone:'));
    $permalink_text = '<input type="text" size="15" value="' . check_plain($data['permalink']) . '">';
    $output .= <<<EOH
<div id="mm-subscribe-menu-permalink"><p>$permalink</p>$permalink_img$permalink_text</div>
EOH;
  }

  return $output . '</div>';
}

function _rss_page_subscribe_button_img($imgpath, $type) {
  $xref = array('portal' => 'amherst_a_tiny.png', 'rss' => 'rss.png', 'permalink' => 'permalink.png');
  return l(
    '<img src="' . url("$imgpath/images/add_widget_icons/" . $xref[$type]) . '" alt="' . t('Subscription options') . '">',
    '',
    array(
      'attributes' => array(
        'title' => t('Subscription options'),
        'id' => "add-to-{$type}-small",
      ),
      'html' => TRUE,
    )
  );
}
