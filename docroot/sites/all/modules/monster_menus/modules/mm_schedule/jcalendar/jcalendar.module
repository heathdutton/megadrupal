<?php

/**
 * @file
 * jQuery Calendar UI features.
 */

/**
* Display help and module information
* @param section which section of the site we're displaying help
* @return help text for section
*/
function jcalendar_help($path, $arg) {
  $output = '';
  switch ($path) {
    case 'admin/help#jcalendar':
      $output = '<p>' . t('Creates a popup for calendar dates.') . '</p>';
      break;
  }
  return $output;
}

/**
* Get calendar node for popup
* @param integer nid Node id.
* @param string id Date field unique id.
* @return string HTML for node
*/
function jcalendar_get_calendar_node($node, $id) {
  $GLOBALS['devel_shutdown'] = FALSE;
  $node->date_id = $id;
  $node->date_repeat_show = FALSE;
  print theme('jcalendar_view', array('node' => $node));
}

/**
* Implements hook_menu()
*/
function jcalendar_menu() {
  $items['jcalendar/getnode/%node'] = array(
    'title' => 'Get Calendar Node',
    'page callback' => 'jcalendar_get_calendar_node',
    'page arguments' => array(2, 3),
    'access callback' => 'node_access',
    'access arguments' => array('view', 2),
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Implements hook_views_pre_execute().
 */
function jcalendar_views_pre_execute(&$view) {
  if ($view->style_plugin->definition['name'] == 'calendar_style') {
    $path = drupal_get_path('module', 'jcalendar');
    drupal_add_js('Drupal.settings.jcalendarPath = ' . drupal_json_encode(base_path() . $path) . ';', 'inline');
    drupal_add_js($path . '/jcalendar.js');
    drupal_add_css($path . '/jcalendar.css');
  }
}

/**
 * Implements hook_theme().
 */
function jcalendar_theme() {
  return array(
    'jcalendar_view' => array('variables' => array('node' => NULL)),
  );
}

/**
 * Overrideable theme for the jcalendar popup view.
 *
 * Defaults to show the standard teaser view of the node.
 */
function theme_jcalendar_view($variables) {
  $node = $variables['node'];
  $output = drupal_render(node_view($node, 'teaser'));
  $output .= '<div id="nodelink">' . l(t('More'), 'node/' . $node->nid) . '</div>';
  return $output;
}
