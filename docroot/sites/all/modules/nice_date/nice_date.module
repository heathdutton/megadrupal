<?php

/**
 * @file
 *
 * Adds a "Nice Date" element to nodes and comments. See:
 * http://www.thingy-ma-jig.co.uk/blog/10-05-2011/nice-dates-a-how-to
 */


/**
 * Implements hook_theme().
 */
function nice_date_theme() {
  return array(
    'nice_date' => array(
      'arguments' => array('timestamp' => NULL),
      'template' => 'nice-date',
    ),
  );
}


/**
 * Implements hook_preprocess_nice_date().
 */
function template_preprocess_nice_date(&$variables) {
  // Add CSS
  drupal_add_css(drupal_get_path('module', 'nice_date') . '/nice_date.css');

  // Convenicence Variable
  $timestamp = &$variables['timestamp'];

  // Define the day, month and year attributes in an array.
  // This way, other modules can intercept and add classes if needed
  // See template_process_nice_date() for implosion.
  $variables['day_attributes_array']   = array('day',   'd-' . format_date($timestamp, 'custom', 'd'));
  $variables['month_attributes_array'] = array('month', 'm-' . format_date($timestamp, 'custom', 'm'));
  $variables['year_attributes_array']  = array('year',  'y-' . format_date($timestamp, 'custom', 'y'));

  // Make nice names for year, month and day
  $variables['year_long']  = format_date($timestamp, 'custom', 'Y');
  $variables['month_long'] = format_date($timestamp, 'custom', 'M');
  $variables['day_long']   = format_date($timestamp, 'custom', 'd');
}


/**
 * Implements hook_process_nice_date().
 */
function template_process_nice_date(&$variables) {
  // This implodes the attributes array, ready for printing in the template.
  $variables['day_attributes']   = implode(' ', $variables['day_attributes_array']);
  $variables['month_attributes'] = implode(' ', $variables['month_attributes_array']);
  $variables['year_attributes']  = implode(' ', $variables['year_attributes_array']);
}


/**
 * Implements hook_preprocess_node().
 */
function nice_date_preprocess_node(&$variables) {
  $variables['nice_date'] = theme('nice_date', array('timestamp' => $variables['created']));
}


/**
 * Implements hook_preprocess_comment().
 */
function nice_date_preprocess_comment(&$variables) {
  $variables['nice_date'] = theme('nice_date', array('timestamp' => $variables['comment']->created));
}
