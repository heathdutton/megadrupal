<?php

/**
 * @file personalize_ga.module
 * This module provides integration of the Personalize module with Google Analytics.
 */

/**
 * Implements hook_help().
 */
function personalize_ga_help($path, $arg) {
  switch ($path) {
    // Help for Google Analytics Integration
    case 'admin/config/content/personalize/google_analytics':
      return '<p>' . t('This module provides integration between the Personalize module (and related modules) and Google Analytics.') . '</p>';
  }
}

/**
 * Implements hook_menu().
 */
function personalize_ga_menu() {
  $items = array();
  $items['admin/config/content/personalize/google_analytics'] = array(
    'type' => MENU_LOCAL_TASK,
    'title' => 'Google Analytics Integration',
    'description' => 'Configuration settings for the Personalize Google Analytics Integration module',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('personalize_ga_admin_form'),
    'access arguments' => array('administer personalize configuration'),
    'file' => 'personalize_ga.admin.inc',
  );
  return $items;
}

/**
 * Implements hook_page_build().
 */
function personalize_ga_page_build(&$page) {
  $tracking_id = variable_get('personalize_ga_tracking_id');

  // Don't load the js if the tracking id is not set.
  if (!$tracking_id) {
    return;
  }

  $send_personalize_decisions = variable_get('personalize_ga_send_personalize_decisions', 'all');
  $tracked_personalize_decisions = array_filter(variable_get('personalize_ga_tracked_personalize_decisions', array()));
  $send_visitor_actions = variable_get('personalize_ga_send_visitor_actions', 'all');
  $tracked_visitor_actions = array_filter(variable_get('personalize_ga_tracked_visitor_actions', array()));

  // Check if we are sending any personalize decisions or visitor actions, at all.
  $send_no_personalize_decisions = $send_personalize_decisions === 'none' || $send_personalize_decisions === 'some' && empty($tracked_personalize_decisions);
  $send_no_visitor_actions = $send_visitor_actions === 'none' || $send_visitor_actions === 'some' && empty($tracked_visitor_actions);

  // Don't load the js if nothing is being sent.
  if ($send_no_personalize_decisions && $send_no_visitor_actions) {
    return;
  }

  // Add the necessary JavaScript for Google Analytics integration.
  $path = drupal_get_path('module', 'personalize_ga');
  $settings = array(
    'trackingId' => $tracking_id,
    'sendPersonalizeDecisions' => $send_personalize_decisions,
    'trackedPersonalizeDecisions' => $tracked_personalize_decisions,
    'sendVisitorActions' => $send_visitor_actions,
    'trackedVisitorActions' => $tracked_visitor_actions,
  );

  $options = array(
    'scope' => 'footer',
  );

  $page['page_top']['personalize_ga'] = array(
    '#attached' => array(
      'js' => array(
        $path . '/js/personalize_ga.js' => $options,
        array(
          'data' => array('personalize_ga' => $settings),
          'type' => 'setting',
        ),
      ),
    ),
  );
}
