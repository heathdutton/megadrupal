<?php
/**
 * @file
 * The core Subfolders Domain module.
 */

/**
 * The host of the main site,
 * $_SERVER['HTTP_HOST'] can cause some security issues.
 */
global $base_root;
$subfolders_domain_url_site = parse_url($base_root);
define('SUBFOLDERS_DOMAIN_HTTPHOST', $subfolders_domain_url_site['host']);

/**
 * Implements hook_module_implements_alter().
 */
function subfolders_domain_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'boot') {
    // Try to ensure that subfolders_domain_boot() gets invoked last.
    $group = $implementations['subfolders_domain'];
    unset($implementations['subfolders_domain']);
    $implementations['subfolders_domain'] = $group;
  }
}

/**
 * Implements hook_user_load().
 *
 * Attached domain_id records to all registering users.  These
 * are used to determine which 'domain_editor' group that users
 * with the 'edit domain content' and 'delete domain content' permissions are in.
 */
function subfolders_domain_user_load($users) {
  foreach ($users as $uid => $account) {
    $users[$uid]->domain_user = domain_get_user_domains($account, FALSE);
  }
}

/**
 * Implements hook_boot().
 */
function subfolders_domain_boot() {
  $domain_id = subfolders_domain_resolve_host(TRUE);
  if ((int) $domain_id) {
    domain_set_domain($domain_id, TRUE);
  }
  // Assign roles and domains by refferant the configuration performed on the
  // current user.
  global $user;
  if ((int) $user->uid !== 1) {
    $_domain = domain_get_domain();
    $user->domain_user = domain_get_user_domains($user, FALSE);
    $user->domain_user += _subfolders_domain_fetch_domains($user);
    if (_subfolders_domain_active($_domain, $user)) {
      $user->roles = _subfolders_domain_fetch_roles($_domain, $user);
    }
    elseif ($user->uid) {
      $user->roles = array(DRUPAL_AUTHENTICATED_RID => 'authenticated user');
    }
    else {
      $user->roles = array(DRUPAL_ANONYMOUS_RID => 'anonymous user');
    }
  }
}

/**
 * Implements hook_menu().
 */
function subfolders_domain_menu() {

  $items = array();

  $items['admin/structure/domain/view/%domain/subfolders'] = array(
    'title' => 'Subfolders settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('subfolders_domain_admin', 4),
    'access arguments' => array('administer domains'),
    'weight' => 5,
    'type' => MENU_LOCAL_TASK | MENU_NORMAL_ITEM,
    'file' => 'subfolders_domain.admin.inc',
  );

  $items['user/%user/subfolders-domain-roles'] = array(
    'title' => 'Subfolders Roles',
    'description' => 'This will allow user to administer Domain based roles settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('subfolders_domain_roles_form', 1),
    'access arguments' => array('administer subfolders roles'),
    'type' => MENU_LOCAL_TASK,
    'file' => 'subfolders_domain.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_admin_paths().
 */
function subfolders_domain_admin_paths() {
  $paths = array(
    'admin/structure/domain/view/*/subfolders' => TRUE,
    'user/*/subfolders-domain-roles' => TRUE,
  );
  return $paths;
}

/**
 * Implements hook_menu_alter().
 */
function subfolders_domain_menu_alter(&$items) {
  $items['admin/content']['page arguments'] = array('subfolders_domain_admin_content');
  $items['admin/structure/domain/view/%domain']['access callback'] = 'subfolders_domain_manage_domains_access';
  $items['admin/structure/domain/view/%domain/edit']['access callback'] = 'subfolders_domain_manage_domains_access';
  $items['admin/structure/domain/view/%domain/delete']['access callback'] = 'subfolders_domain_manage_domains_access';
  /*if (module_exists('locale')) {
    $items['admin/config/regional/language/configure']['access callback'] = FALSE;
  }*/
}

/**
 * Is the current domain default.
 */
function subfolders_domain_manage_domains_access() {
  $_domain = domain_get_domain();
  return ($_domain['domain_id'] == domain_default_id() && user_access('administer domains'));
}

/**
 * Implements hook_cron().
 */
function subfolders_domain_cron() {
  // The cron will perform not in web mode. Because we need a full right to
  // create the news alias in Drupal root.
  if (!isset($_SERVER['HTTP_REFERER']) || (isset($_SERVER['HTTP_REFERER']) && trim($_SERVER['HTTP_REFERER']) == '')) {
    subfolders_domain_create_alias();
  }
}

/**
 * Implements hook_permission().
 */
function subfolders_domain_permission() {
  return array(
    'administer subfolders roles' => array(
      'title' => t('administer subfolders roles'),
      'description' => t('This will allow attribute user roles per domain'),
      'restrict access' => TRUE,  
    ),
    'affect admin role on a domain' => array(
      'title' => t('Can affect admin role on a domain'),
      'description' => t('This will allow attribute admin role to a user on a domain'),
      'restrict access' => TRUE,  
    ),
    'affect role on all domains' => array(
      'title' => t('Can affect role on all domains'),
      'description' => t('This will allow attribute user roles on all domains'),
      'restrict access' => TRUE,  
    ),
  );
}

/**
 * Implements hook_domain_delete().
 *
 * Delete the entry corresponding to the deleted domain.
 */
function subfolders_domain_domain_delete($domain, $values) {
  if (isset($domain['domain_id'])) {
    db_delete('subfolders_domain')->condition('domain_id', $domain['domain_id'])->execute();
  }
}

/**
 * Implements hook_domain_load().
 */
function subfolders_domain_domain_load(&$domain) {
  $subfolders_domain = subfolders_domain_infos($domain['domain_id']);
  if ($subfolders_domain != NULL && $subfolders_domain != FALSE && isset($subfolders_domain->site)) {
    $pre_subfolder = substr(str_replace(SUBFOLDERS_DOMAIN_HTTPHOST, '', $subfolders_domain->site), 1);
    $subfolder = $pre_subfolder ? trim($pre_subfolder) : '';
    $domain['subfolders_domain'] = (array) $subfolders_domain + array('subfolder' => $subfolder);
  }
}

/**
 * Implements hook_url_outbound_alter().
 */
function subfolders_domain_url_outbound_alter(&$path, &$options, $original_path) {
  global $base_path;
  $testpath = explode('/', $base_path);
  if (isset($testpath[1]) && trim($testpath[1]) != '') {
    $base_path = '/' . $testpath[1] . '/';
  }
  $domain = domain_get_domain();
  // Try to modify internal links properly.
  if (isset($domain['subfolders_domain']['subfolder']) && trim($domain['subfolders_domain']['subfolder']) != '') {
    $find = explode('/' . $domain['subfolders_domain']['subfolder'], $path, 1);
    if (count($find) === (int) 2) {
      $path = implode('', $find);
    }
    elseif (count($find) === (int) 3) {
      $path = $base_path . variable_get('site_frontpage', 'node');
    }
    // Handle destination=foo.
    /* if (isset($domain['subfolders_domain']['subfolder']) && isset($options['query']['destination'])) {
      $options['query']['destination'] = $domain['subfolders_domain']['subfolder'] . '/' . $options['query']['destination'];
    }*/
  }
}

/**
 * Resolve an HTTP_HOST to a registered domain.
 * 
 * @param bool $bootstrap
 *   Is For bootstrap.
 * 
 * @return int/string
 *   Domain_id matching the current domain name.
 */
function subfolders_domain_resolve_host($bootstrap = FALSE) {
  $cache = &drupal_static(__FUNCTION__, array());
  if ($bootstrap &&  isset($cache[SUBFOLDERS_DOMAIN_HTTPHOST])) {
    return $cache[SUBFOLDERS_DOMAIN_HTTPHOST];
  }
  $subdomain = '';
  $cache[$subdomain] = '';
  $other_domain = db_query("SELECT * FROM {subfolders_domain} WHERE other_domain = :other_domain", array(':other_domain' => SUBFOLDERS_DOMAIN_HTTPHOST))->fetchObject();
  if (isset($other_domain->domain_id) && (int) $other_domain->domain_id > 1) {
    $subdomain = SUBFOLDERS_DOMAIN_HTTPHOST;
    $cache[$subdomain] = (int) $other_domain->domain_id;
  }
  $request_uri = request_uri();
  if (!isset($cache[SUBFOLDERS_DOMAIN_HTTPHOST]) && $request_uri != '' || isset($_SERVER['REDIRECT_URL'])) {
    if ($request_uri != '') {
      $uri = explode('/', request_uri());
    }
    elseif (isset($_SERVER['REDIRECT_URL'])) {
      $uri = explode('/', $_SERVER['REDIRECT_URL']);
    }
    $subdomain = isset($uri[1]) && trim($uri[1]) != '' ? $uri[1] : '';
    if ($bootstrap && isset($subdomain) &&  isset($cache[$subdomain])) {
      return $cache[$subdomain];
    }
    if (isset($subdomain) && !isset($cache[$subdomain]) && $bootstrap && trim($subdomain) != '') {
      $subdomains = subfolders_domain_symbolic_links();
      if (array_key_exists($subdomain, $subdomains)) {
        $cache[$subdomain] = (int) $subdomains[$subdomain];
      }
    }
  }
  return !empty($cache[$subdomain]) ? $cache[$subdomain] : '';
}

/**
 * Function to return 'active' state for this user-domain combination.
 */
function _subfolders_domain_active($domain, $user) {
  return $user->uid && 1 != (int) $user->uid && (int) $user->uid > 0 && isset($user->domain_user[$domain['domain_id']]);
}

/**
 * Function to get user roles by domain.
 */
function _subfolders_domain_fetch_roles($domain, $user, $membersonly = FALSE) {
  $defaults = variable_get('subfolders_domain_roles', array());
  $assigned_role = array();

  if (isset($defaults[$user->uid]['all']) && !empty($defaults[$user->uid]['all'])) {
    $assigned_role += $defaults[$user->uid]['all'];
  }

  if (isset($defaults[$user->uid][$domain['domain_id']]) && !empty($defaults[$user->uid][$domain['domain_id']])) {
    $assigned_role += $defaults[$user->uid][$domain['domain_id']];
  }

  if (!$membersonly) {
    $assigned_role[DRUPAL_AUTHENTICATED_RID] = 'authenticated user';
  }

  // If this subdomain allow the heritage let's check
  // the parent subdomain's roles.
  $subfolders_domain_infos = subfolders_domain_infos();
  if (isset($subfolders_domain_infos->inherit_parent_roles) && (int) $subfolders_domain_infos->inherit_parent_roles) {
    // Parent domains.
    $parent_domains = subfolders_domain_parent($domain['domain_id']);
    if (!empty($parent_domains)) {
      foreach ($parent_domains as $id_domain => $value) {
        if (isset($defaults[$user->uid][$id_domain]) && !empty($defaults[$user->uid][$id_domain])) {
          $assigned_role += $defaults[$user->uid][$id_domain];
        }
      }
    }
    // END parent domains.
  }

  return $assigned_role;
}

/**
 * Function to get user domains by domain.
 */
function _subfolders_domain_fetch_domains($user) {
  $cache = &drupal_static(__FUNCTION__, array());
  if (isset($cache[$user->uid])) {
    return $cache[$user->uid];
  }
  $domains = array();
  if (isset($user->domain_user)) {
    foreach ($user->domain_user as $domain_id => $value) {
      $domains[$domain_id] = $domain_id;
      $subfolders_domain_infos = subfolders_domain_infos();
      // Children domains.
      if (isset($subfolders_domain_infos->inherit_parent_roles) && (int) $subfolders_domain_infos->inherit_parent_roles) {
        $children_domains = subfolders_domain_children($domain_id);
        if (!empty($children_domains)) {
          foreach ($children_domains as $id_domain => $valuebis) {
            $domains[$id_domain] = $id_domain;
          }
        }
      }
      // END children domains.
    }
  }
  $cache[$user->uid] = $domains;
  return $cache[$user->uid];
}

/**
 * Get the infos on the domain.
 */
function subfolders_domain_infos($domain_id = NULL) {
  if ($domain_id == NULL) {
    $_domain = domain_get_domain();
    if (isset($_domain['domain_id'])) {
      $domain_id = $_domain['domain_id'];
    }
  }

  $cache = &drupal_static(__FUNCTION__, array());
  if (isset($cache[$domain_id])) {
    return $cache[$domain_id];
  }

  // DOMAINS.
  $domain = db_query("SELECT * FROM {subfolders_domain} d WHERE d.domain_id = :domain_id", array(':domain_id' => $domain_id))->fetchObject();
  $cache[$domain_id] = $domain;
  return isset($cache[$domain_id]) ? $cache[$domain_id] : (object) array();
}

/**
 * Get the domain settings.
 */
function subfolders_domain_get_domain_conf($domain_id = NULL) {
  $settings = array();
  if (!empty($domain_id)) {
    $data = db_query("SELECT settings FROM {domain_conf} WHERE domain_id = :domain_id", array(':domain_id' => $domain_id))->fetchField();
    if (!empty($data)) {
      $settings = domain_unserialize($data);
    }
  }
  return $settings;
}

/**
 * Implements hook_custom_theme().
 */
function subfolders_domain_custom_theme() {
  $admin_themes = variable_get('subfolders_domain_admin_theme', array());
  $_domain = domain_get_domain();
  if (path_is_admin($_GET['q']) && !empty($admin_themes) && isset($admin_themes[$_domain['domain_id']]) && trim($admin_themes[$_domain['domain_id']]) != '') {
    return trim($admin_themes[$_domain['domain_id']]);
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function subfolders_domain_form_domain_conf_form_alter(&$form, &$form_state, $form_id) {
  $form['#submit'][] = 'subfolders_domain_conf_form_submit';
}

/**
 * Custom submit action of domain configuration form.
 */
function subfolders_domain_conf_form_submit($form, &$form_state) {
  if (isset($form_state['values']['domain_id']) && (int) $form_state['values']['domain_id'] > 0 && isset($form_state['values']['admin_theme']) && trim($form_state['values']['admin_theme']) != '') {
    $admin_themes = variable_get('subfolders_domain_admin_theme', array());
    $admin_themes[$form_state['values']['domain_id']] = $form_state['values']['admin_theme'];
    ksort($admin_themes);
    variable_set('subfolders_domain_admin_theme', $admin_themes);
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function subfolders_domain_form_domain_form_alter(&$form, &$form_state, $form_id) {
  if (isset($form['domain_id']['#value']) && (int) $form['domain_id']['#value']) {
    $subdomain = str_replace('/', '.', $form['subdomain']['#default_value']);
    $form['subdomain']['#default_value'] = $subdomain;
  }
  $form['subdomain']['#description'] .= '<br />' . t('Here is an example for subfolders domain : if you want have <em>@example2</em> you should fill <em>@example1</em>', array('@example1' => SUBFOLDERS_DOMAIN_HTTPHOST . '.site-2', '@example2' => SUBFOLDERS_DOMAIN_HTTPHOST . '/site-2'));
  $form['#validate'][] = 'subfolders_domain_form_validate';
  $form['#submit'][] = 'subfolders_domain_form_submit';
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function subfolders_domain_form_domain_alias_form_alter(&$form, &$form_state, $form_id) {
  $form['#validate'][] = 'subfolders_domain_form_validate';
}

/**
 * Custom validate action of domain setting form.
 */
function subfolders_domain_form_validate($form, &$form_state) {
  $error_list = array();
  if ($form['#form_id'] == 'domain_form') {
    $subdomain = $form_state['values']['subdomain'];
    $check_subdomain = subfolders_domain_valid($subdomain, $error_list, $form['#form_id']);
  }
  elseif ($form['#form_id'] == 'domain_alias_form') {
    $field_name = 'domain_alias';
    // Domain_alias.
    $subdomains = $form_state['values']['domain_alias'];
    if (!empty($subdomains)) {
      foreach ($subdomains as $key => $value) {
        $subdomain = $value['pattern'];
        $check_subdomain = subfolders_domain_valid($subdomain, $error_list, $form['#form_id']);
        if (isset($check_subdomain['error_list']) && !empty($check_subdomain['error_list'])) {
          $field_name = 'domain_alias';
          break;
        }
      }
    }
    // Domain_alias_new.
    $subdomains = $form_state['values']['domain_alias_new'];
    if (!empty($subdomains)) {
      foreach ($subdomains as $key => $value) {
        $subdomain = $value['pattern'];
        $check_subdomain = subfolders_domain_valid($subdomain, $error_list, $form['#form_id']);
        if (isset($check_subdomain['error_list']) && !empty($check_subdomain['error_list'])) {
          $field_name = 'domain_alias_new';
          break;
        }
      }
    }
  }

  $error_list = $check_subdomain['error_list'];
  // Return the errors, if any.
  if (!empty($error_list)) {
    drupal_set_message(t('The domain string is invalid for @sub', array('@sub' => $subdomain)), 'error');
    if ($form['#form_id'] == 'domain_form') {
      form_set_error('subdomain', implode('<br />', $error_list));
    }
    elseif ($form['#form_id'] == 'domain_alias_form') {
      form_set_error($field_name, implode('<br />', $error_list));
    }
  }
}

/**
 * Custom submit action for domain admin form.
 */
function subfolders_domain_form_submit($form, &$form_state) {
  $rs = db_select('domain', 'd')->fields('d')->condition('domain_id', 1, '<>')->condition('subdomain', db_like(SUBFOLDERS_DOMAIN_HTTPHOST . '.') . '%', 'LIKE')->execute();
  if (!empty($rs)) {
    foreach ($rs as $domain) {
      if ((int) $domain->domain_id) {
        // Update subdomain column in domain table.
        if (strpos($domain->subdomain, '/') === FALSE) {
          $subdomain = explode('.', $domain->subdomain);
          $new_subdomain = end($subdomain);
          $subdomain = SUBFOLDERS_DOMAIN_HTTPHOST . '/' . trim($new_subdomain);
          db_update('domain')
            ->condition('domain_id', $domain->domain_id)
            ->fields(array(
                'subdomain' => trim($subdomain),
            ))
            ->execute();
        }
        // Checks and update a path if exists.
        $rs = db_select('url_alias', 'a')->fields('a')->condition('alias', trim($new_subdomain))->execute();
        if (!empty($rs)) {
          foreach ($rs as $url_alias) {
            $path = path_load((int) $url_alias->pid);
            $alias = _subfolders_domain_get_new_alias(trim($new_subdomain));
            $path['alias'] = $alias;
            path_save($path);
          }
        }
      }
    }
  }
}

/**
 * Is the domain choice valid.
 */
function subfolders_domain_valid($subdomain, $error_list = array(), $form_id = '') {
  if ($subdomain != drupal_strtolower($subdomain)) {
    $error_list[] = t('Only lower-case characters are allowed.');
  }

  if ($form_id == 'domain_form' && empty($error_list) && $subdomain != SUBFOLDERS_DOMAIN_HTTPHOST && strpos($subdomain, SUBFOLDERS_DOMAIN_HTTPHOST . '.') === FALSE) {
    $error_list[] = t('Your main domain should appear in your sub-domain followed by a dot.');
  }

  $subdomain = str_replace(SUBFOLDERS_DOMAIN_HTTPHOST . '.', '', $subdomain);
  $pattern = '/^[a-z0-9\-:]*$/i';
  if (empty($error_list) && $subdomain != SUBFOLDERS_DOMAIN_HTTPHOST && !preg_match($pattern, $subdomain)) {
    $error_list[] = t('Only alphanumeric characters and dashes are allowed for your subdomain @sub', array('@sub' => $subdomain));
  }
  if ($form_id == 'domain_alias_form') {
    $checks = explode('.', $subdomain);
    if (empty($error_list) && $subdomain != SUBFOLDERS_DOMAIN_HTTPHOST && !empty($checks) && count($checks) > 1) {
      $error_list[] = t('Only alphanumeric characters and dashes are allowed for your subdomain @sub', array('@sub' => $subdomain));
    }
  }
  return array('error_list' => $error_list, 'subdomain' => $subdomain);
}

/**
 * Implements hook_node_insert().
 */
function subfolders_domain_node_insert($node) {
  if (isset($node->path)) {
    $path = $node->path;
    $path['alias'] = trim($path['alias']);
    // Only save a non-empty alias.
    if (!empty($path['alias']) && _subfolders_domain_alias_exists($path['alias'], $node->nid)) {
      $original_alias = $path['alias'];
      // Change an url to avoid collisions alias url.
      $path['alias'] = _subfolders_domain_get_new_alias($path['alias']);
      if ($original_alias != $path['alias']) {
        // Alert the user why this happened.
        drupal_set_message(t('The automatically generated alias %original_alias conflicted with an existing alias. Alias changed to %alias.', array(
          '%original_alias' => $original_alias,
          '%alias' => $path['alias'],
        )));
      }
      // Checks and update a path if exists in url_alias.
      $rs = db_select('url_alias', 'a')->fields('a')->condition('alias', $original_alias)->execute();
      if (!empty($rs)) {
        foreach ($rs as $url_alias) {
          $path = path_load((int) $url_alias->pid);
          $path['alias'] = $path['alias'];
          path_save($path);
        }
      }
    }
  }
}

/**
 * Implements hook_node_update().
 */
function subfolders_domain_node_update($node) {
  if (isset($node->path)) {
    subfolders_domain_node_insert($node);
  }
}

/**
 * Edit an url to avoid collisions alias url.
 */
function _subfolders_domain_get_new_alias($alias) {
  // If the alias already exists, generate a new, hopefully unique, variant.
  $maxlength = min(variable_get('subfolders_domain_path_max_length', 100), _subfolders_domain_get_schema_alias_maxlength());
  $separator = variable_get('subfolders_domain_path_separator', '-');
  $original_alias = $alias;

  $i = 0;
  do {
    // Append an incrementing numeric suffix until we find a unique alias.
    // $unique_suffix = $separator . $i;
    if ((int) $i > 0) {
      $unique_suffix = $separator . $i;
    }
    else {
      $unique_suffix = '';
    }
    $alias_tmp = truncate_utf8($original_alias, $maxlength - drupal_strlen($unique_suffix, TRUE)) . $unique_suffix;
    $alias_tmp = subfolders_stripaccents($alias_tmp);
    $new_alias = explode(' ', strtolower($alias_tmp));
    $alias = implode('-', $new_alias);
    $i++;
  } while (_subfolders_domain_alias_exists($alias));
  return $alias;
}

/**
 * Check to see if there is already a subdomain or content pointing to given alias.
 */
function _subfolders_domain_alias_exists($alias, $nid = NULL) {
  $rs = db_select('subfolders_domain_sites', 's')->fields('s')->condition('site', trim($alias))->execute();
  if (!empty($rs)) {
    foreach ($rs as $url_alias) {
      return isset($url_alias->domain_id) && (int) ($url_alias->domain_id);
    }
  }
  $arg_q = "";
  $arg = array();
  if ($nid != NULL) {
    $arg_q = " AND source != :source ";
    $arg = array(':source' => 'node/' . $nid);
  }
  
  $pid = db_query_range("SELECT pid FROM {url_alias} WHERE alias = :alias " . $arg_q, 0, 1, array(
    ':alias' => $alias,
  ) + $arg)->fetchField();

  return !empty($pid) ? TRUE : FALSE;
}

/**
 * Fetch the maximum length of the {url_alias}.alias field from the schema.
 *
 * @return int
 *   An integer of the maximum URL alias length allowed by the database.
 */
function _subfolders_domain_get_schema_alias_maxlength() {
  $maxlength = &drupal_static(__FUNCTION__);
  if (!isset($maxlength)) {
    $schema = drupal_get_schema('url_alias');
    $maxlength = $schema['fields']['alias']['length'];
  }
  return $maxlength;
}

function subfolders_stripaccents($string, $encoding = 'utf-8'){
  // transformer les caractères accentués en entités HTML
  $string = htmlentities($string, ENT_NOQUOTES, $encoding);

  // remplacer les entités HTML pour avoir juste le premier caractères non accentués
  // Exemple : "&ecute;" => "e", "&Ecute;" => "E", "Ã " => "a" ...
  $string = preg_replace('#&([A-za-z])(?:acute|grave|cedil|circ|orn|ring|slash|th|tilde|uml);#', '\1', $string);

  // Remplacer les ligatures tel que : Œ, Æ ...
  // Exemple "Å“" => "oe"
  $string = preg_replace('#&([A-za-z]{2})(?:lig);#', '\1', $string);
  // Supprimer tout le reste
  $string = preg_replace('#&[^;]+;#', '', $string);

  return $string;
}

/**
 * Implements hook_form_alter().
 */
function subfolders_domain_form_alter(&$form, &$form_state, $form_id) {
  if (($form_id == 'subfolders_domain_admin' || $form_id == 'subfolders_domain_roles_form') && isset($form['domain_settings'])) {
    if (isset($form['domain_settings']['domain_id'])) {
      $site = $form['domain_settings']['domain_id']['#options'][DOMAIN_SETTINGS_ALL_DOMAINS];
      $form['domain_settings']['#prefix'] = '<div style="display: none;">';
      $form['domain_settings']['#suffix'] = '</div>';
      $form['domain_settings']['domain_id'] = array(
        '#prefix' => $site,
        '#type' => 'hidden',
        '#disabled' => TRUE,
        '#value' => DOMAIN_SETTINGS_ALL_DOMAINS,
        '#default_value' => DOMAIN_SETTINGS_ALL_DOMAINS,
      );
    }
  }
  // Edit language.
  if ($form_id == 'locale_languages_edit_form') {
    $form['prefix']['#access'] = FALSE;
    $form['domain']['#access'] = FALSE;
  }
}

/**
 * Get domains tree.
 */
function subfolders_domain_tree() {
  $domain_tree = subfolders_domain_pre_tree();
  $domains = domain_domains();
  foreach ($domains as $domain_id => $value) {
    if (!array_key_exists($domain_id, $domain_tree)) {
      $domain_tree += array($domain_id => filter_xss_admin($domains[$domain_id]['sitename']));
    }
  }
  return $domain_tree;
}

/**
 * Check all domains tree.
 */
function subfolders_domain_pre_tree($first_domain_id = 1, $prefix = '--- ') {
  $domains = domain_domains();
  $parents = array();
  $rs = db_select('subfolders_domain', 'd')->fields('d')->condition('parent_id', $first_domain_id)->execute();
  if (!empty($rs)) {
    foreach ($rs as $item) {
      $parents += array($first_domain_id => filter_xss_admin($domains[$first_domain_id]['sitename']), $item->domain_id => $prefix . filter_xss_admin($domains[$item->domain_id]['sitename']));
      $parents += subfolders_domain_pre_tree($item->domain_id, '---' . $prefix);
    }
  }
  return $parents;
}

/**
 * Get the parent of domain.
 */
function subfolders_domain_parent($domain_id = NULL, $loop = FALSE) {
  static $domain_ids = array();
  if (!$loop && isset($domain_ids) && isset($domain_ids[$domain_id]) && (int) $domain_ids[$domain_id] > 0) {
    return $domain_ids;
  }

  if ($domain_id == NULL) {
    $_domain = domain_get_domain();
    if (isset($_domain['domain_id'])) {
      $domain_id = $_domain['domain_id'];
    }
    else {
      return $domain_ids[1] = 1;
    }
  }

  $rs = db_select('subfolders_domain', 'd')->fields('d', array('parent_id', 'site'))->condition('d.domain_id', $domain_id)->execute();
  if (!empty($rs)) {
    foreach ($rs as $domain) {
      $domain_ids[$domain->parent_id] = (int) $domain->parent_id;
      $domain_ids += subfolders_domain_parent($domain->parent_id, TRUE);
    }
  }
  return $domain_ids;
}

/**
 * Get the children of a domain.
 */
function subfolders_domain_children($domain_id = NULL) {
  $cache = &drupal_static(__FUNCTION__, array());
  if ($domain_id != NULL && isset($cache) && isset($cache[$domain_id]) && intval($cache[$domain_id]) > 0) {
    return $cache;
  }

  if ($domain_id == NULL) {
    $_domain = domain_get_domain();
    if (isset($_domain['domain_id'])) {
      $domain_id = $_domain['domain_id'];
    }
    else {
      return $domain_ids[1] = array(1 => 1);
    }
  }

  $domain_ids = array();
  $rs = db_select('subfolders_domain', 'd')->fields('d', array('domain_id', 'site'))->condition('d.parent_id', $domain_id)->execute();
  if (!empty($rs)) {
    $cpt = 0;
    foreach ($rs as $domain) {
      $domain_ids[$domain->domain_id] = (int) $domain->domain_id;
      $domain_ids += subfolders_domain_children($domain->domain_id);
    }
  }

  $cache = isset($domain_ids) ? $domain_ids : array();
  return $cache;
}

/**
 * Symbolic Links created, this function may be provided by other modules.
 */
function subfolders_domain_symbolic_links($symbolic_link = NULL) {
  static $sites = array();
  if ($symbolic_link != NULL && isset($sites[$symbolic_link])) {
    return $sites;
  }

  $rs = db_select('subfolders_domain_sites', 's')->fields('s', array('domain_id', 'site'))->execute();
  $sites[1] = '';
  if (!empty($rs)) {
    foreach ($rs as $domain) {
      $sites[$domain->site] = $domain->domain_id;
    }
  }
  return $sites;
}

/**
 * Is the current user admin.
 */
function subfolders_domain_is_admin() {
  global $user;
  return intval($user->uid) === 1 ? TRUE : FALSE;
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function subfolders_domain_form_user_profile_form_alter(&$form, &$form_state, $form_id) {
  if (isset($form['#user']) && isset($form['#user']->uid) && (int) $form['#user']->uid !== 1) {
    $form['account']['roles']['#access'] = FALSE;
  }
}

/**
 * Implements hook_theme().
 */
function subfolders_domain_theme($existing, $type, $theme, $path) {
  $themes = array(
    'subfolders_domain_roles_form' => array(
      'render element' => 'form',
    ),
  );
  return $themes;
}

/**
 * FormsAPI theming.
 */
function theme_subfolders_domain_roles_form($variables) {
  $form = $variables['form'];
  $form['domain_settings']['#access'] = FALSE;
  $output = '';
  $header = array(t('Domains'));
  $roles = array();
  $roles = user_roles();
  unset($roles[1]);
  $rows = array();
  ksort($roles);
  $domains = domain_domains();
  foreach ($roles as $rid => $role) {
    $header[] = $role;
  }
  $row = array();
  
  if (user_access('affect role on all domains')) {
    $row[] = 'All Domains';
    foreach ($roles as $rid => $role) {
      $form['subfolders_domain_role'][$rid]['all']['#title'] = '';
      $row[] = drupal_render($form['subfolders_domain_role'][$rid]['all']);
    }
  }
  $rows[] = $row;
  if ((int) $form['subfolders_domain_role'][0]['all']['#value']) {
    $account = user_load((int) $form['subfolders_domain_role'][0]['all']['#value']);
  }
  
  $domain_get_user_domains = domain_get_user_domains($account, FALSE);
  foreach (subfolders_domain_tree() as $domain_id => $domain) {
    if ((int) $account->uid !== 1 && !isset($domain_get_user_domains[$domain_id])) {
      continue;
    }
    $row = array();
    if (isset($domains[$domain_id])) {
      if (isset($account) && ((int) $account->uid === 1 || (isset($account->domain_user) && array_key_exists($domain_id, $account->domain_user)))) {
        $row[] = '<span style="color: green;">' . $domain . '</span>';
      }
      else {
        $row[] = '<span style="color: red;">' . $domain . '</span>';
      }
    }
    else {
      $row[] = '';
    }
    foreach ($roles as $rid => $role) {
      $form['subfolders_domain_role'][$rid][$domain_id]['#title'] = '';
      $row[] = drupal_render($form['subfolders_domain_role'][$rid][$domain_id]);
    }
    $rows[] = $row;
  }
  $output = '<p>' . t('Subfolders Roles Settings Allows you to save user roles per domain.') . '</p>';
  $output .= theme('table', array('header' => $header, 'rows' => $rows));
  $output .= drupal_render_children($form);
  return $output;
}

/**
 * Page callback: Form constructor for the content administration form.
 *
 * @see node_admin_nodes()
 * @see node_admin_nodes_submit()
 * @see node_admin_nodes_validate()
 * @see node_filter_form()
 * @see node_filter_form_submit()
 * @see node_menu()
 * @see node_multiple_delete_confirm()
 * @see node_multiple_delete_confirm_submit()
 * @ingroup forms
 */
function subfolders_domain_admin_content($form, $form_state) {
  module_load_include('inc', 'node', 'node.admin');
  if (isset($form_state['values']['operation']) && $form_state['values']['operation'] == 'delete') {
    return node_multiple_delete_confirm($form, $form_state, array_filter($form_state['values']['nodes']));
  }
  $form['filter'] = node_filter_form();
  $form['#submit'] = array('node_filter_form_submit');
  $form['admin'] = subfolders_domain_admin_nodes();

  return $form;
}

/**
 * Form builder: Builds the node administration overview.
 *
 * @see node_admin_nodes_submit()
 * @see node_admin_nodes_validate()
 * @see node_filter_form()
 * @see node_filter_form_submit()
 * @see node_multiple_delete_confirm()
 * @see node_multiple_delete_confirm_submit()
 *
 * @ingroup forms
 */
function subfolders_domain_admin_nodes() {
  global $language;
  $_domain = domain_get_domain();
  if (!user_access('access the domain content page') && !user_access('review content for all domains')) {
    drupal_set_title(t('Content affiliated to @domain', array('@domain' => $_domain['sitename'])));
  }
  $admin_access = user_access('administer nodes');

  // Build the 'Update options' form.
  $form['options'] = array(
    '#type' => 'fieldset',
    '#title' => t('Update options'),
    '#attributes' => array('class' => array('container-inline')),
    '#access' => $admin_access,
  );
  $options = array();
  foreach (module_invoke_all('node_operations') as $operation => $array) {
    $options[$operation] = $array['label'];
  }
  $form['options']['operation'] = array(
    '#type' => 'select',
    '#title' => t('Operation'),
    '#title_display' => 'invisible',
    '#options' => $options,
    '#default_value' => 'approve',
  );
  $form['options']['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Update'),
    '#validate' => array('node_admin_nodes_validate'),
    '#submit' => array('node_admin_nodes_submit'),
  );

  // Enable language column if translation module is enabled or if we have any
  // node with language.
  $multilanguage = (module_exists('translation') || db_query_range("SELECT 1 FROM {node} WHERE language <> :language", 0, 1, array(':language' => LANGUAGE_NONE))->fetchField());
  // Build the sortable table header.
  $header = array(
    'title' => array('data' => t('Title'), 'field' => 'n.title'),
    'type' => array('data' => t('Type'), 'field' => 'n.type'),
    'author' => t('Author'),
    'status' => array('data' => t('Status'), 'field' => 'n.status'),
    'changed' => array(
      'data' => t('Updated'),
      'field' => 'n.changed',
      'sort' => 'desc',
    ),
  );
  if ($multilanguage) {
    $header['language'] = array('data' => t('Language'), 'field' => 'n.language');
  }
  $header['operations'] = array('data' => t('Operations'));
  $query = db_select('node', 'n')->extend('PagerDefault')->extend('TableSort');
  node_build_filter_query($query);

  if (!user_access('bypass node access')) {
    // If the user is able to view their own unpublished nodes, allow them
    // to see these in addition to published nodes. Check that they actually
    // have some unpublished nodes to view before adding the condition.
    if (user_access('view own unpublished content') && $own_unpublished = db_query('SELECT nid FROM {node} WHERE uid = :uid AND status = :status', array(':uid' => $GLOBALS['user']->uid, ':status' => 0))->fetchCol()) {
      $query->condition(db_or()
        ->condition('n.status', 1)
        ->condition('n.nid', $own_unpublished, 'IN')
      );
    }
    else {
      // If not, restrict the query to published nodes.
      $query->condition('n.status', 1);
      $query->condition('n.language', array($language->language, LANGUAGE_NONE));
    }
  }
  $nids = $query
    ->condition('n.nid', array_keys(subfolders_domain_domain_nodes()))
    ->fields('n', array('nid'))
    ->limit(50)
    ->orderByHeader($header)
    ->addTag('node_access')
    ->execute()
    ->fetchCol();
  $nodes = node_load_multiple($nids);

  // Prepare the list of nodes.
  $languages = language_list();
  $destination = drupal_get_destination();
  $options = array();
  foreach ($nodes as $node) {
    $langcode = entity_language('node', $node);
    $l_options = $langcode != LANGUAGE_NONE && isset($languages[$langcode]) ? array('language' => $languages[$langcode]) : array();
    $options[$node->nid] = array(
      'title' => array(
        'data' => array(
          '#type' => 'link',
          '#title' => $node->title,
          '#href' => 'node/' . $node->nid,
          '#options' => $l_options,
          '#suffix' => ' ' . theme('mark', array('type' => node_mark($node->nid, $node->changed))),
        ),
      ),
      'type' => check_plain(node_type_get_name($node)),
      'author' => theme('username', array('account' => $node)),
      'status' => $node->status ? t('published') : t('not published'),
      'changed' => format_date($node->changed, 'short'),
    );
    if ($multilanguage) {
      if ($langcode == LANGUAGE_NONE || isset($languages[$langcode])) {
        $this_lang = isset($languages[$langcode]->name) ? $languages[$langcode]->name : '';
        $options[$node->nid]['language'] = $langcode == LANGUAGE_NONE ? t('Language neutral') : $this_lang;
      }
      else {
        $options[$node->nid]['language'] = t('Undefined language (@langcode)', array('@langcode' => $langcode));
      }
    }
    // Build a list of all the accessible operations for the current node.
    $operations = array();
    if (node_access('update', $node)) {
      $operations['edit'] = array(
        'title' => t('edit'),
        'href' => 'node/' . $node->nid . '/edit',
        'query' => $destination,
      );
    }
    if (node_access('delete', $node)) {
      $operations['delete'] = array(
        'title' => t('delete'),
        'href' => 'node/' . $node->nid . '/delete',
        'query' => $destination,
      );
    }
    $options[$node->nid]['operations'] = array();
    if (count($operations) > 1) {
      // Render an unordered list of operations links.
      $options[$node->nid]['operations'] = array(
        'data' => array(
          '#theme' => 'links__node_operations',
          '#links' => $operations,
          '#attributes' => array('class' => array('links', 'inline')),
        ),
      );
    }
    elseif (!empty($operations)) {
      // Render the first and only operation as a link.
      $link = reset($operations);
      $options[$node->nid]['operations'] = array(
        'data' => array(
          '#type' => 'link',
          '#title' => $link['title'],
          '#href' => $link['href'],
          '#options' => array('query' => $link['query']),
        ),
      );
    }
  }

  // Only use a tableselect when the current user is able to perform any
  // operations.
  if ($admin_access) {
    $form['nodes'] = array(
      '#type' => 'tableselect',
      '#header' => $header,
      '#options' => $options,
      '#empty' => t('No content available.'),
    );
  }
  // Otherwise, use a simple table.
  else {
    $form['nodes'] = array(
      '#theme' => 'table',
      '#header' => $header,
      '#rows' => $options,
      '#empty' => t('No content available.'),
    );
  }

  $form['pager'] = array('#markup' => theme('pager'));
  return $form;
}

/**
 * Get the nodes allowed for the current domain and current user.
 */
function subfolders_domain_domain_nodes($domain_id = NULL, $node_type = 'all') {
  global $language;
  $cache = &drupal_static(__FUNCTION__, array());
  $node_type = trim($node_type);
  if ($domain_id == NULL) {
    $_domain = domain_get_domain();
    if (isset($_domain['domain_id'])) {
      $domain_id = $_domain['domain_id'];
    }
    else {
      $domain_id = 1;
    }
  }
  if (isset($cache[$domain_id]) && isset($cache[$domain_id][$node_type])) {
    return $cache[$domain_id][$node_type];
  }

  $children_domains = $parents_domains = array();
  if (user_access('access the domain content page') || user_access('review content for all domains')) {
    $children = subfolders_domain_children($domain_id);
    if (!empty($children)) {
      foreach ($children as $child_id => $id_child_domain) {
        $children_domains[$child_id] = $child_id;
      }
    }
    $parents = subfolders_domain_children($domain_id);
    if (!empty($parents)) {
      foreach ($parents as $parent_id => $id_parent_domain) {
        $parents_domains[$parent_id] = $parent_id;
      }
    }
  }

  $domain_ids = array(0 => (int) 0, $domain_id => (int) $domain_id) + $children_domains + $parents_domains;
  $nids = array(0 => 0);

  $query = db_select('domain_access', 'da');
  $query->join('node', 'n', 'da.nid = n.nid');
  $query->distinct();
  $query->fields('da', array('nid'))->fields('n', array('title', 'vid'));
  if (!user_access('access the domain content page') && !user_access('review content for all domains')) {
    $query->condition('da.gid', $domain_ids);
  }
  if (trim($node_type) != 'all') {
    $query->condition('n.type', trim($node_type));
  }
  
  if (!user_access('bypass node access')) {
    if (user_access('view own unpublished content') && $own_unpublished = db_query('SELECT nid FROM {node} WHERE uid = :uid AND status = :status', array(':uid' => $GLOBALS['user']->uid, ':status' => 0))->fetchCol()) {
      $query->condition(db_or()
        ->condition('n.status', 1)
        ->condition('n.nid', $own_unpublished, 'IN')
      );
    }
    else {
      $query->condition('n.status', NODE_PUBLISHED);
      $query->condition('n.language', array($language->language, LANGUAGE_NONE));
    }
  }
  $result = $query->execute();
  while ($node = $result->fetchObject()) {
    $nids[$node->nid] = $node;
  }

  $cache[$domain_id][$node_type] = $nids;
  return $cache[$domain_id][$node_type];
}

/**
 * Cron callback function.
 */
function subfolders_domain_create_alias() {
  $rs = db_select('subfolders_domain_sites', 'd')->fields('d')->execute();
  if (!empty($rs)) {
    foreach ($rs as $domain) {
      $file_exists = file_exists(DRUPAL_ROOT . "/" . trim($domain->site));
      if ($file_exists) {
        drupal_unlink(DRUPAL_ROOT . "/" . trim($domain->site));
      }
      db_delete('subfolders_domain_sites')->condition('domain_id', $domain->domain_id)->execute();
    }
  }

  // DOMAINS.
  $rs = db_select('domain', 'd')->fields('d')->condition('domain_id', 1, '<>')->execute();
  if (!empty($rs)) {
    foreach ($rs as $domain) {
      if (isset($domain->subdomain) && trim($domain->subdomain) != '') {
        $match_domain = explode('/', $domain->subdomain);
        if ((int) $domain->valid > 0) {
          db_insert('subfolders_domain_sites')->fields(array('site' => end($match_domain), 'domain_id' => $domain->domain_id))->execute();
          symlink(DRUPAL_ROOT, DRUPAL_ROOT . "/" . end($match_domain));
        }
        elseif ($match_domain) {
          db_delete('subfolders_domain_sites')->condition('domain_id', $domain->domain_id)->execute();
          drupal_unlink(DRUPAL_ROOT . "/" . end($match_domain));
        }
      }
    }

    $root_folder = explode('/', DRUPAL_ROOT);
    $file_exists = file_exists(DRUPAL_ROOT . "/" . end($root_folder));
    if ($file_exists) {
      drupal_unlink(DRUPAL_ROOT . "/" . end($root_folder));
    }
  }

  // ALIASIES.
  $select = db_select('domain_alias', 'ad')->extend('PagerDefault')->range(0, variable_get('feed_default_items', 10));
  $select->join('domain', 'd', 'd.domain_id = ad.domain_id');
  $select->fields('ad', array('domain_id', 'pattern', 'redirect'));
  $select->fields('d', array('valid'));

  $rs = $select->execute();
  if (!empty($rs)) {
    foreach ($rs as $domain) {
      if (isset($domain->pattern) && trim($domain->pattern) != '') {
        if ((int) $domain->valid > 0 && isset($domain->redirect) && (int) $domain->redirect > 0) {
          db_insert('subfolders_domain_sites')->fields(array('site' => $domain->pattern, 'domain_id' => $domain->domain_id))->execute();
          symlink(DRUPAL_ROOT, DRUPAL_ROOT . "/" . $domain->pattern);
        }
        else {
          db_delete('subfolders_domain_sites')->condition('domain_id', $domain->domain_id)->execute();
          drupal_unlink(DRUPAL_ROOT . "/" . $domain->pattern);
        }
      }
    }
  }
}
