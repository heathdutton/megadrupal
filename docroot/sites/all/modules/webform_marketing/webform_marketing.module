<?php

/*
 * hook_init()
 */
function webform_marketing_init(){
  drupal_add_js(drupal_get_path('module', 'webform_marketing') . '/js/webform_marketing.js');
  drupal_add_js(array('webform_marketing' => array('hours' => variable_get('webform_marketing_cookie_life_time', 6))), 'setting');
  $url_params = variable_get('webform_marketing_param', array());
  drupal_add_js(array('webform_marketing' => array('url_params' => $url_params)), 'setting');
}

/*
 * hook_webform_component_info()
 */
function webform_marketing_webform_component_info() {  
  $components = array();
  $components['wmarketing'] = array(
    'label' => t('Webform marketing field'),
    'description' => t('Create a hidden field that will be filled from cookies'),
    'features' => array(
      'csv' => TRUE,
      'email' => TRUE,
      'email_address' => FALSE,
      'email_name' => FALSE,
      'required' => FALSE,
      'title_display' => FALSE,
      'title_inline' => FALSE,
      'conditional' => FALSE,
      'group' => FALSE,
      'spam_analysis' => FALSE,
      'attachment' => FALSE,
    ),
    'file' => 'includes/webform_marketing.webform.inc',
  );
  return $components;
}

/*
 * hook_menu()
 */
function webform_marketing_menu() {
  $items = array();
  $items['admin/config/webform_marketing'] = array(
    'title' => t('Auto fill webform fields settings'),
    'description' => t('Here you can add parameters prefix'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('webform_marketing_admin'),
    'access arguments' => array('administer webform marketing'),
    'type' => MENU_NORMAL_ITEM,
  );
  $items['admin/help/webform_marketing'] = array(
    'title' => t('Auto fill webform fields help'),
    'description' => t('Here you can read help info'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('webform_marketing_help_page'),
    'access arguments' => array('administer webform marketing'),
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}

/*
 * hook_permission()
 */
function webform_marketing_permission() {
  return array(
    'administer webform marketing' => array(
      'title' => t('Administer webform marketing'),
      'description' => t('Perform administration tasks for webformmarketing.'),
    ),
  );
}

/*
 * This function will return administration form
 */
function webform_marketing_admin() {
  $form = array();
  $form['webform_marketing_cookie_life_time'] = array(
    '#type' => 'textfield',
    '#title' => t('Cookies life time'),
    '#default_value' => variable_get('webform_marketing_cookie_life_time', 6),
    '#description' => t('Set cookies life time in hours.'),
    '#required' => FALSE,
  );
  return system_settings_form($form);
}

/*
 * This function will return help page
 */
function webform_marketing_help_page(){
  $form = array();
  $form['about'] = array(
    '#type' => 'item',
    '#title' => t('About'),
    '#markup' => 'With the Webform marketing module you are able to fetch url parameters and external site refer in webform fields with the \'Webform marketing\' field type. The data is stored in a cookie, so you can have a different landing page then your webform.',
  );
  $form['legal'] = array(
    '#type' => 'item',
    '#title' => t('Legal'),
    '#markup' => 'HINT: Please respect your local cookie law. If you need to inform the visitor by a privacy policy, please do so.
',
  );
  $form['howto'] = array(
    '#type' => 'item',
    '#title' => t('Howto'),
    '#markup' => 'Create or edit a webform and add one or more \'Webform marketing field\' fields. Give each ‘Parameter name’ field the name of the URL parameter that you want to fetch. If you want to fetch the external site refer, please enter ‘sitereferrer’ in the ‘Parameter name’ field.
We suggest to hidden the field, which is done by default. Only make the field private if you are using the webform for authenticated users, it won’t work for anonymous users.

After a user filled in the form, please take a look at the webform results to see the webform data combined with UTM parameters and site refer.

The default lifetime of the cookie is 6 hours. You can configure this to another lifetime at the module configuration page at admin/config/webform_marketing
',
  );
  return $form;
}

/*
 * hook_webform_component_update()
 * 
 * Respond to a Webform component being updated into the database..
 */
function webform_marketing_webform_component_update($component) {  
  if($component['type'] === 'wmarketing') {
    webform_marketing_update_params_array($component['extra']['url_param']);
  }
}

/*
 * hook_webform_component_insert()
 * 
 * Respond to a Webform component being inserted into the database..
 */
function webform_marketing_webform_component_insert($component) {
  if($component['type'] === 'wmarketing') {
    webform_marketing_update_params_array($component['extra']['url_param']);
  }
}


/*
 * This function will check new parameter and will save it if needed.
 */
function webform_marketing_update_params_array($value) {
  $params = variable_get('webform_marketing_param', array());
  if (!in_array($value, $params)) {
    $params[$value] = $value;
    variable_set('webform_marketing_param', $params);
  }
}
