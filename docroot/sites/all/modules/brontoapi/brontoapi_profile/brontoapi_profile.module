<?php

/**
 * @file
 * Updates Bronto data when a user is created or updated in Drupal.
 */

/**
 * Implements hook_menu().
 */
function brontoapi_profile_menu() {
  $items = array();

  $items['admin/config/brontoapi/settings/mapping'] = array(
    'type' => MENU_NORMAL_ITEM,
    'title' => 'Bronto API Mapping',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('brontoapi_profile_page'),
    'access arguments' => array('administer bronto'),
  );

  return $items;
}

/**
 * Bronto API mapping page for users.
 */
function brontoapi_profile_page() {
  $form = array();

  foreach (brontoapi_read_fields() as $field) {
    $form["brontoapi_profile_" . $field->name] = array(
      "#type" => "textfield",
      "#title" => $field->label,
      "#default_value" => variable_get("brontoapi_profile_" . $field->name, ""),
    );
  }

  $form['tokens'] = array(
    '#theme' => 'token_tree_link',
    '#token_types' => array('user'),
    '#global_types' => TRUE,
    '#click_insert' => TRUE,
  );

  return system_settings_form($form);
}

/**
 * Updates Bronto API fields based on data provided when a user is updated.
 */
function brontoapi_profile_user_update(&$edit, $account, $category) {

  $fields = brontoapi_read_fields();

  foreach ($fields as $field) {
    $field->content = token_replace(variable_get("brontoapi_profile_" . $field->name));
  }

  brontoapi_add_email($account->mail, NULL, $fields);
}

/**
 * Updates Bronto API fields based on data provided when a user is created.
 */
function brontoapi_profile_user_insert(&$edit, $account, $category) {

  $fields = brontoapi_read_fields();

  foreach ($fields as $field) {
    $field->content = token_replace(variable_get("brontoapi_profile_" . $field->name));
  }

  brontoapi_add_email($account->mail, NULL, $fields);
}
