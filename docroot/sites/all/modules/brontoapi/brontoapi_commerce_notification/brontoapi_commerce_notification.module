<?php

/**
 * @file
 * Integrates Bronto APi with Commerce Notification/Abandon Cart.
 */

/**
 * Implements hook_brontoapi_drupal_template_info_alter().
 */
function brontoapi_commerce_notification_brontoapi_drupal_template_info_alter(&$brontoapi_drupal_template_info) {
  $brontoapi_drupal_template_info["commerce_abandoned_cart_notification_config_form"] = array(
    array(
      "container" => "",
      "id" => "message_notify_abandoned",
      "element_create" => "brontoapi_commerce_notification_element",
      "machine_name" => "commerce_notification",
      "label" => "Commerce Notification",
      "elements" => array(
        "message_type",
      ),
    ),
  );
}

/**
 * Creates element for Abandon Cart.
 */
function brontoapi_commerce_notification_element($form_item, &$form, $form_id) {
  $element = brontoapi_commerce_notification_hash_element($form['#action']) . "_" . $form_id;
  return $element;
}

/**
 * Hashes the path to the Commerce Notification form - ensures uniqueness.
 */
function brontoapi_commerce_notification_hash_element($path) {
  // Remove all arguments passed to this url.
  $path = substr($path, 0, strpos($path, "?"));
  $hash = md5($path);
  return $hash;
}

/**
 * Saves Abandon Cart information with unique values in the variable table.
 */
function brontoapi_commerce_notification_save($form, &$form_state) {
  $values = $form_state['values'];
  $hash = brontoapi_commerce_notification_hash_element($form['#action']);
  $value = $values[$hash . "_" . $form['#form_id']];
  $element = $hash . "_" . $form['#form_id'];
  variable_set($element, $value);
}

/**
 * Implements hook_FORM_ID_alter().
 */
function brontoapi_commerce_notification_form_commerce_abandoned_cart_notification_config_form_alter(&$form, &$form_state, $form_id) {
  $form['#submit'][] = 'brontoapi_commerce_notification_save';
}
