(function($){var State=function($){var self=this,_init,_={cookieDomain:"",cookiePath:"/",cookieSecure:false,cookieNamespace:"",pageRespNo:undefined,prolong:0,checkFirst:60*1000,checkInterval:0,lastCheckTime:null,sessWarnTimeout:0,sessTimeout:0,sessExpireTime:null,sessWarnTime:null,sessCurrent:true,sessExpired:false,sessProlongedTime:null,activitySensed:false,revive:false,formExpireTime:null,formWarnTime:null,formExpired:false,autoRedirect:false,redirectTarget:"",sid:undefined,errors:[],infoCurrent:"",infoLife:60000},_jqUiDial,_localEn,_errorHandler,_local,_o,_check,_ajax,_ajaxCompleted,_url,_redirect,_info;
_errorHandler=function(error,variable,options){var u=options,o={},t;
if(typeof window.inspect==="function"&&inspect.tcepsni){if(typeof inspect.errorHandler==="function"){if(u){if((t=typeof u)==="string"){o.message=u;
}else{if(t==="object"){o=u;
}}}o.category="State";
inspect.errorHandler(error,variable,o);
}else{inspect.console("Please update Inspect.");
}}};
_local=function(nm){var s;
if(!(s=_o(_localEn,nm))){switch(nm){case"preExpire":s=Drupal.t("This page is about to expire!newline!newlinePlease save now, if you have made any changes.!newlineOtherwise, please !link_startreload the page!link_end.");
break;
case"expired_redirect":s=Drupal.t("This page has expired!newline!newlinePlease !link_startproceed to the start page!link_end.");
break;
case"expired_reload":s=Drupal.t("This page has expired!newline!newlinePlease !link_startreload the page!link_end.");
break;
default:s="[LOCAL: "+nm+"]";
}}return s.replace(/\!newline/g,"\n");
};
_o=function(o,k0,k1){var t=typeof o;
return o&&(t==="object"||t==="function")&&o.hasOwnProperty(k0)?(k1===undefined?o[k0]:((o=o[k0])&&((t=typeof o)==="object"||t==="function")&&o.hasOwnProperty(k1)?o[k1]:undefined)):undefined;
};
_check=function(evt,action){var u,u1,d,to,act=action,ci,f;
if(!_.sessCurrent&&!_.sessExpired&&!_.formExpired){return;
}d=_.lastCheckTime=new Date();
if(!(_.sessCurrent=(_.sid===self.cookieGet("state__sid")))){_.sessCurrent=false;
_info("expired");
if(_.autoRedirect){_redirect(_url(),_.infoLife);
}return;
}if(action==="getTimeout"){if(_.prolong===2){$(document.documentElement).bind("click mousemove keyup",f=function(){_.activitySensed=true;
if(!_.revive){return;
}_.revive=false;
if(new Date()<_.formWarnTime){_check(null,"check");
}});
$(window).scroll(f);
}}else{if(action==="check"){if((u=self.cookieGet("state__ssprlngd"))&&u){u=u.split(",");
if(u.length===2&&u[1]===_.sid&&/^\d{13,14}$/.test(u[0])&&(u=parseInt(u[0],10))&&(u1=new Date(u))&&u1>_.sessProlongedTime){_.sessProlongedTime=u1;
_.sessExpireTime=new Date(u+_.sessTimeout);
_.sessWarnTime=new Date(u+_.sessWarnTimeout);
}}ci=_.checkInterval;
if(d>=_.sessExpireTime){_.sessExpired=true;
_info("expired");
to=setTimeout(function(){if(_.sid===self.cookieGet("state__sid")){_ajax("destroySession");
}},ci=Math.floor(ci/2));
if(_.autoRedirect){_redirect(_url(),ci+_.infoLife);
}return;
}else{if((u=_.formExpireTime)&&d>=u){_.formExpired=true;
_info("expired");
if(_.autoRedirect){_redirect(_url(),_.infoLife);
}return;
}else{if((u=_.formWarnTime)&&d>=u&&_.infoCurrent!=="preExpire_form"){_info("preExpire_form");
}}}act=null;
switch(_.prolong){case 3:act="prolong";
break;
case 2:if(_.activitySensed){_.activitySensed=false;
if(_.infoCurrent==="preExpire_sess"){_info();
}act="prolong";
}break;
}if((u=_.sessProlongedTime)&&u.getTime()>d.getTime()-(ci*0.8)){act="skip";
ci=Math.floor((ci*0.6)+((Math.random()*((ci*0.4)+1))+1)-1);
}if((u=new Date(d.getTime()+ci))>_.sessExpireTime||u>_.formExpireTime){ci=Math.floor(ci/2);
}to=setTimeout(function(){_check(null,"check");
},ci);
if(!act){if(!_.infoCurrent&&d>=_.sessWarnTime){_info("preExpire_sess");
if(_.prolong===2){_.revive=true;
}}return;
}}}if(act==="prolong"||act==="getTimeout"){_ajax(act);
}};
_ajax=function(act){$.ajax({url:"/state/ajax/"+_.pageRespNo,type:"POST",data:{action:act,arg:act!=="destroySession"?null:_.sid},dataType:"json",cache:false,success:function(oResp,textStatus,jqXHR){var u,d,t,st,sw,ci,to,to1;
if(textStatus==="success"&&$.type(oResp)==="object"){if(oResp.success){if(oResp.action==="destroySession"||!_.sessCurrent||_.sessExpired){return;
}if(_.sid!==self.cookieGet("state__sid")){_.sessCurrent=false;
_info("expired");
if(_.autoRedirect){_redirect(url(),_.infoLife);
}return;
}t=(d=new Date()).getTime();
switch(oResp.action){case"prolong":_.sessExpireTime=new Date(t+_.sessTimeout);
_.sessWarnTime=new Date(t+_.sessWarnTimeout);
break;
case"getTimeout":if((st=oResp.sessionTimeout)){st*=1000;
if((ci=_.checkInterval)>st/6){_.checkInterval=ci=Math.floor(st/6);
}_.sessTimeout=st=st-ci;
_.sessExpireTime=new Date(t+st);
if((sw=Math.floor(st/10))<ci){sw=ci;
}_.sessWarnTime=new Date(t+(_.sessWarnTimeout=st-sw));
to=setTimeout(function(){_check(null,"check");
},ci);
to1=setTimeout(function(){$("body").ajaxComplete(_ajaxCompleted);
},1000);
}break;
default:try{throw new Error("Unknown action["+oResp.action+"]");
}catch(er){_errorHandler(er,null,"State._check()");
}return;
}_.sessProlongedTime=d;
self.cookieSet("state__ssprlngd",""+t+","+_.sid);
}else{if(oResp.error==="no_session"){_.sessCurrent=false;
}else{_errorHandler(oResp,null,"State._check()");
}}}else{_.errors.push("response: "+textStatus);
_errorHandler(null,{textStatus:textStatus,response_data:oResp},"State._check()");
}},error:function(jqXHR,textStatus,errorThrown){if(jqXHR&&jqXHR.status===403){_.sessCurrent=false;
}else{_.errors.push("response: "+textStatus);
_errorHandler(null,{textStatus:textStatus,errorThrown:errorThrown},"State._check()");
}}});
};
_ajaxCompleted=function(e,xhr,settings){var u;
if(xhr.status===200&&typeof(u=_o(settings,"url"))==="string"&&u.indexOf("/")===0&&u.indexOf("/state/ajax/")!==0){self.sessionProlonged();
}};
_url=function(reload){var url,loc=window.location,v;
if(reload||!(url=_.redirectTarget)){return loc.href.replace(/#.*$/,"");
}return url.charAt(0)==="/"?(loc.protocol+"//"+loc.hostname+(!(v=loc.port)?"":(":"+v))+url):url;
};
_redirect=function(url,delay){var to=setTimeout(function(){window.location.href=url;
},delay||20);
};
_info=function(type){var ms,url,a,ttl,dial,to;
_.infoCurrent=type||"";
if(type){if(type==="expired"){url=_url();
ms=!_.redirectTarget?"expired_reload":"expired_redirect";
}else{url=_url(true);
ms="preExpire";
}ms=_local(ms).replace(/\!link_start/,'<a href="'+(url||"")+'">').replace(/\!link_end/,"</a>");
}if(_jqUiDial){if(type){a=ms.split(/\n\n/);
ttl=a[0].replace(/\n/g,"").replace(/\.$/,"");
a.splice(0,1);
ms="<p>"+a.join("</p><p>").replace(/\n/g,"<br/>")+"</p>";
}if(!(dial=document.getElementById("state_info"))){if(!type){return;
}if(!document.getElementById("state_info_container")){$(document.body).append('<div id="state_info">'+ms+"</div>");
}dial=document.getElementById("state_info");
$(dial).dialog({stack:true,modal:true,autoOpen:false,closeOnEscape:type!=="expired",resizable:false,position:["center","center"],title:ttl,buttons:[{text:Drupal.t("OK"),click:type!=="expired"?function(){$(this).dialog("close");
}:function(){}}],beforeClose:function(){_.infoCurrent="";
}});
$(dial.parentNode).css("position","fixed").addClass("module-state-dialog-container");
}else{if(!type){$(dial).dialog("close");
return;
}else{$(dial).dialog("option","title",ttl);
$(dial).html(ms);
}}if(type==="expired"){$("a.ui-dialog-titlebar-close","div.module-state-dialog-container").unbind().hide();
$(dial).dialog("option","buttons",[{text:Drupal.t("OK"),click:function(){_redirect(_url());
}}]);
}to=setTimeout(function(){$(dial).dialog("open");
},5000);
}else{if(type){alert(ms.replace(/\!link_[a-z]+/g,""));
}}};
this.init=function(cookieDomain,cookiePath,cookieNamespace,pageRespNo,options){var o=options,u,v,t=new Date().getTime(),fx;
if(_init){return;
}_init=true;
_.cookieDomain=cookieDomain;
_.cookiePath=cookiePath;
_.cookieNamespace=cookieNamespace;
_.pageRespNo=pageRespNo;
if(!o||typeof o!=="object"||!(_.sid=_o(o,"sid"))||!(_.formExpireTime=(fx=_o(o,"formExpire"))?new Date(t+(fx*1000)):null)){return;
}_.prolong=(u=_o(o,"prolong"))||0;
_.checkInterval=((u=_o(o,"checkInterval"))?u:300)*1000;
_.formWarnTime=fx?new Date(t+(fx*900)):null;
_.autoRedirect=_o(o,"autoRedirect")?true:false;
_.redirectTarget=(u=_o(o,"redirectTarget"))?u:"";
_localEn=(u=_o(o,"localEn"))?u:{};
_.cookieSecure=window.location.protocol==="https:";
_jqUiDial=typeof _o($,"ui","dialog")==="function";
if(_.prolong){t=setTimeout(function(){_check(null,"getTimeout");
},_.checkFirst=(u=_.checkFirst)<(v=_.checkInterval)?u:v);
}};
this.cookieDefaults=function(){return{path:_.cookiePath,domain:_.cookieDomain,secure:_.cookieSecure,namespace:_.cookieNamespace};
};
this.cookieSet=function(name,value,options){var u=options,v,t,le,n,o={path:_.cookiePath,domain:_.cookieDomain,secure:_.cookieSecure};
if(u){if((v=_o(u,"expire"))&&((t=typeof v)==="date"||(t==="number"&&v>0))){o.expire=v;
}if((v=_o(u,"path"))&&(v=$(trim(v)))!=="/"&&(le=v.length)){if(v.charCodeAt(le-1)==="/"){v=v.substr(0,le-1);
--le;
}if(o.path==="/"){if(v.charCodeAt(0)==="/"){v=v.substr(1);
}}else{if(v.charCodeAt(0)!=="/"){v="/"+v;
}}o.path+=v;
}}$.cookie(name+_.cookieNamespace,!(n=value)&&n!==0?"":n,o);
};
this.cookieIncrease=function(name,increment,options){var u=increment||1,v=$.cookie(name+_.cookieNamespace)||0,a=[u,v],i,n,t,em;
try{for(i=0;
i<2;
i++){if((n=!i?u:v)){em=!i?"arg increment":"cookie value";
if((t=typeof n)==="string"){if(n.indexOf(".")>-1){if(!isFinite(a[i]=parseFloat(n))){throw new Error(em+"["+n+"] isnt float-like");
}}else{if(!isFinite(a[i]=parseInt(n,10))){throw new Error(em+"["+n+"] isnt integer-like");
}}}else{if(t!=="number"){throw new Error(em+"["+n+"] isnt number|string|falsy");
}}}}self.cookieSet(name,a[1]+=a[0],options);
return a[1];
}catch(er){em="State.cookieIncrease()";
_errorHandler(er,null,em);
}return false;
};
this.cookieGet=function(name){return $.cookie(name+_.cookieNamespace);
};
this.cookieRemove=function(name,options){var o=options||{},v;
o.expire=new Date(1);
v=self.cookieGet(name);
self.cookieSet(name,"",o);
return v;
};
this.alive=function(){return !_.sid?undefined:((!_.sessCurrent||_.sessExpired||_.formExpired)?false:(_.sessCurrent=(_.sid===self.cookieGet("state__sid"))));
};
this.pageResponseNumber=function(){return _.pageRespNo;
};
this.sessionProlonged=function(date){if(this.alive()){self.cookieSet("state__ssprlngd",""+(_.sessProlongedTime=date||new Date()).getTime()+","+_.sid);
return true;
}return false;
};
this.inspect=function(){if(typeof window.inspect==="function"&&inspect.tcepsni===true){inspect(_,"State");
}};
this.testCheck=function(){if(_.sessTimeout&&typeof window.inspect==="function"&&inspect.tcepsni===true){_check("check");
}};
this.testInfo=function(){var s,to,to1;
if(typeof window.inspect==="function"&&inspect.tcepsni===true){s=_.infoCurrent;
_info("preExpire_sess");
to=setTimeout(function(){_info("preExpire_form");
},10000);
to1=setTimeout(function(){_info("expired");
},20000);
_.infoCurrent=s;
delete this.testInfo;
}};
};
Drupal.State=window.State=new State($);
})(jQuery);
