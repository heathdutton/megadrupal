<?php

/**
 * @file
 * My Episodes module.
 */

/**
 * Refresh time variable name.
 */
define('MYEPISODES_ENABLED_LINKS_VAR', 'myepisodes_links');

/**
 * Refresh time variable name.
 */
define('MYEPISODES_REFRESH_DELAY_VAR', 'myepisodes_refresh_delay');

/**
 * Default refresh time for feeds is two days.
 */
define('MYEPISODES_REFRESH_DELAY_DEFAULT', 172800);

/**
 * My Episodes site URL.
 */
define('MYEPISODES_BASE_URL', 'http://myepisodes.com');

/**
 * My Episodes feed relative URL.
 */
define('MYEPISODES_FEED_URL', '/rss.php');

// hook_hook_info() does not seem to do its job correctly.
require_once dirname(__FILE__) . '/myepisodes.field.inc';

/**
 * Implements hook_permission().
 */
function myepisodes_permission() {
  if (module_exists('field_permissions')) {
    return array();
  }

  return array(
    'myepisode bypass' => array(
      'title' => t("Bypass public display settings"),
      'description' => t("Allow users to see all My Episode data belonging to other users, whatever is the display setting"),
      'restrict access' => TRUE,
    ),
    'myepisode view' => array(
      'title' => t("My Episodes field view"),
      'description' => t("Allow users to view My Episodes field display as long as it is in public display mode"),
    ),
    'myepisode edit' => array(
      'title' => t("My Episodes field edit"),
      'description' => t("Allow users to edit their own My Episode information"),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function myepisodes_menu() {
  $items = array();
  $items['admin/config/services/myepisodes'] = array(
    'title' => "My Episodes",
    'description' => "Access My Episode network access global settings.",
    'page callback' => 'drupal_get_form',
    'page arguments' => array('myepisodes_admin_services_settings'),
    'access arguments' => array('administer site configuration'),
    'file' => 'myepisodes.admin.inc',
  );
  return $items;
}

/**
 * Implements hook_theme().
 */
function myepisodes_theme($existing, $type, $theme, $path) {
  $common = array(
    'file' => 'myepisodes.field.inc',
    'path' => drupal_get_path('module', 'myepisodes'),
  );
  return array(
    'myepisodes_mylist' => array(
      'render element' => 'elements',
      'template' => 'myepisodes-mylist',
    ) + $common,
    'myepisodes_mylist_item' => array(
      'render element' => 'elements',
      'template' => 'myepisodes-mylist-item',
    ) + $common,
  );
}


/**
 * Get site wide enabled links.
 * 
 * @return array
 */
function myepisodes_get_links() {
  $cache = &drupal_static(__FUNCTION__, array());

  if (empty($cache)) {
    $cache['myepisodes'] = t("My Episode site links");
    $cache['torrentz'] = t("Torrentz search links");
    drupal_alter('myepisodes_links', $cache);
  }

  return $cache;
}

/**
 * Implements hook_cron().
 * 
 * This implementation is not scalable and may fail if you have a lot of
 * entities with refresh enabled.
 */
function myepisodes_cron() {
  module_load_include('inc', 'myepisodes', 'myepisodes.fetch');
  myepisodes_refresh_all();
}
