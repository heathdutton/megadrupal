<?php

/**
 * @file
 * Display an overlay bubble on mouse hover, showing a hyperlink target
 * thumbnail, using the WebSnapr service.
 */

/**
 * Implements hook_help().
 */
function websnapr_help($page, $arg) {
  $output = '';
  switch ($page) {
    case 'admin/help#websnapr':
      $output .= '<p>' . t('The WebSnapr Preview Bubble module is a simple, unobtrusive script used to display an overlay bubble showing a hyperlink target thumbnail using WebSnapr. It is a snap to setup and works on all modern browsers. Check the demo at: <a href="http://www.websnapr.com/previewbubble/">http://www.websnapr.com/previewbubble/</a>');
      $output .= '<p>' . t('WebSnapr - Preview Bubble Javascript by Juan Xavier Larrea') . '</p>';
      break;

    case 'admin/config/user-interface/websnapr':
      $output .= '<p>' . t('Bubbles are always enabled for hyperlinks having class <em>previewlink</em>, irrespective of any configuration below.<br /><a href="!url" />Configure permissions</a> for user roles to view WebSnapr Preview Bubbles.', array('!url' => url('admin/user/permissions', array('fragment' => 'module-websnapr')))) . '</p>';
      break;

  }

  return $output;
}

/**
 * Implements of hook_init().
 */
function websnapr_init() {
  if (user_access('view websnapr preview bubble')) {
    // Load the JS for WebSnapr.
    websnapr_load_script();
  }
}

/**
 * Implements of hook_menu().
 */
function websnapr_menu() {
  $items = array();

  $items['admin/config/user-interface/websnapr'] = array(
    'title' => 'WebSnapr Preview Bubble',
    'description' => 'Toggle site-wide usage of WebSnapr Preview Bubbles.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('websnapr_settings'),
    'access callback' => 'user_access',
    'access arguments' => array('administer site configuration'),
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * Implements of hook_permission().
 */
function websnapr_permission() {
  return array(
    'view websnapr preview bubble' => array(
      'title' => t('View Websnapr preview bubble'),
      'description' => t('View Websnapr preview bubble'),
    ),
  );
}

/**
 * Menu callback; Return a form for WebSnapr module settings.
 */
function websnapr_settings() {
  $form = array();

  $form['websnapr'] = array(
    '#type' => 'fieldset',
    '#title' => t('Basic settings'),
  );
  $form['websnapr']['websnapr_developer_key'] = array(
    '#type' => 'textfield',
    '#title' => t('WebSnapr Developer Key'),
    '#default_value' => variable_get('websnapr_developer_key', NULL),
    '#size' => 50,
    '#maxlength' => 250,
    '#required' => TRUE,
    '#description' => t("No key? !link - It's free and there is no catch!", array('!link' => l(t('Get yours here'), 'http://www.websnapr.com/'))),
  );
  $form['websnapr']['websnapr_preview_selector'] = array(
    '#type' => 'textfield',
    '#title' => t('CSS Selector'),
    '#default_value' => variable_get('websnapr_preview_selector', 'div.node a'),
    '#size' => 50,
    '#maxlength' => 250,
    '#description' => t(
      'Enter <a href="http://www.w3.org/TR/css3-selectors/" title="Click to learn more about CSS Selectors"/>CSS Selectors</a> for HTML hyperlink tags, as implemented in jQuery, to enable WebSnapr Preview Bubble for. Separate multiple by comma.<br />For example:<br />
      <ul>
        <li>External links: <strong>a[@href^=http://]:not([@href*=!url])</strong></li>
        <li>Links with class <em>websnapr</em>: <strong>a.websnapr</strong></li>
        <li>Links only within nodes: <strong>div.node a</strong></li>
        <li>All links on site web pages: <strong>a</strong></li>
      </ul>!test',
      array(
        '!test' => '[' . l(t('Hover to test the drupal.org snap.'), 'http://drupal.org/', array('attributes' => array('class' => 'previewlink'))) . ']', '!url' => $_SERVER['HTTP_HOST'],
      )
    ),
  );

  return system_settings_form($form);
}

/**
 * Load required JS and settings for WebSnapr Bubble Previews.
 */
function websnapr_load_script() {
  static $loaded;

  if (!$loaded) {
    $path = drupal_get_path('module', 'websnapr');
    $settings = array(
      'websnapr' => array(
        'previewBubbleSelector' => variable_get('websnapr_preview_selector', 'div.node a'),
        'previewBubbleBG' => (base_path() . $path . '/images/bg.png'),
        'developerKey' => variable_get('websnapr_developer_key', NULL),
      ),
    );
    drupal_add_js($settings, 'setting');

    // Add the WebSnapr service JS.
    drupal_add_js('http://www.websnapr.com/js/websnapr.js', 'external');
    drupal_add_js($path . '/js/websnapr.js');

    $loaded = TRUE;
  }
  return;
}
