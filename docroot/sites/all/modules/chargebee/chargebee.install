<?php
/**
 * @file
 * Module install hooks.
 */

/**
 * Implements hook_schema().
 */
function chargebee_schema() {
  $schema = array();
  $schema['chargebee_subscription'] = array(
    'description' => 'Base table for ChargeBee subscription entities.',
    'fields' => array(
      'uid' => array(
        'description' => 'User identifier.',
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE,
      ),
      'subscription_id' => array(
        'description' => 'Subscription ChargeBee identifier.',
        'type' => 'varchar',
        'length' => '255',
        'not_null' => TRUE,
      ),
      'plan_id' => array(
        'description' => 'Subscription plan identifier.',
        'type' => 'int',
        'not_null' => TRUE,
      ),
      'status' => array(
        'description' => 'Subscription status.',
        'type' => 'varchar',
        'length' => '255',
        'not_null' => TRUE,
      ),
      'current_term_start' => array(
        'type' => 'int',
      ),
      'current_term_end' => array(
        'type' => 'int',
      ),
    ),
    'primary key' => array('uid'),
  );
  $schema['chargebee_customer'] = array(
    'description' => 'Base table for ChargeBee customer entities.',
    'fields' => array(
      'uid' => array(
        'description' => 'User identifier.',
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE,
      ),
      'customer_id' => array(
        'description' => 'Customer ChargeBee identifier.',
        'type' => 'varchar',
        'length' => '255',
        'not_null' => TRUE,
      ),
      'first_name' => array(
        'description' => 'Customer first name.',
        'type' => 'varchar',
        'length' => '255',
      ),
      'last_name' => array(
        'description' => 'Customer last name.',
        'type' => 'varchar',
        'length' => '255',
      ),
      'email' => array(
        'description' => 'Customer email.',
        'type' => 'varchar',
        'length' => '255',
      ),
      'phone' => array(
        'description' => 'Customer phone.',
        'type' => 'varchar',
        'length' => '255',
      ),
      'company' => array(
        'description' => 'Customer company.',
        'type' => 'varchar',
        'length' => '255',
      ),
    ),
    'primary key' => array('uid'),
  );
  $schema['chargebee_card'] = array(
    'description' => 'Base table for ChargeBee card entities.',
    'fields' => array(
      'uid' => array(
        'description' => 'User identifier.',
        'type' => 'int',
        'unsigned' => TRUE,
        'not null' => TRUE,
      ),
      'status' => array(
        'description' => 'Card status.',
        'type' => 'varchar',
        'length' => '20',
        'not_null' => TRUE,
      ),
      'gateway' => array(
        'description' => 'Payment gateway.',
        'type' => 'varchar',
        'length' => '20',
        'not_null' => TRUE,
      ),
      'first_name' => array(
        'description' => 'First name of cardholder.',
        'type' => 'varchar',
        'length' => '255',
      ),
      'last_name' => array(
        'description' => 'Last name of cardholder.',
        'type' => 'varchar',
        'length' => '255',
      ),
      'last4' => array(
        'description' => 'Last 4 card number symbols.',
        'type' => 'varchar',
        'length' => '10',
        'not_null' => TRUE,
      ),
      'card_type' => array(
        'description' => 'Card type.',
        'type' => 'varchar',
        'length' => '10',
        'not_null' => TRUE,
      ),
      'expiry_month' => array(
        'description' => 'Card expiry month.',
        'type' => 'varchar',
        'length' => '10',
        'not_null' => TRUE,
      ),
      'expiry_year' => array(
        'description' => 'Card expiry year.',
        'type' => 'varchar',
        'length' => '10',
        'not_null' => TRUE,
      ),
    ),
    'primary key' => array('uid'),
  );
  $schema['chargebee_plan'] = array(
    'description' => 'Base table for ChargeBee plans entities.',
    'fields' => array(
      'id' => array(
        'description' => 'Local identifier',
        'type' => 'serial',
        'unsigned' => TRUE,
        'not_null' => TRUE,
      ),
      'plan_id' => array(
        'description' => 'Plan identifier.',
        'type' => 'varchar',
        'length' => '255',
        'not_null' => TRUE,
      ),
      'name' => array(
        'description' => 'Plan human-readable name.',
        'type' => 'varchar',
        'length' => '255',
        'not_null' => TRUE,
      ),
      'price' => array(
        'description' => 'Plan price',
        'type' => 'int',
        'not_null' => TRUE,
      ),
      'period' => array(
        'description' => 'Plan billing frequency.',
        'type' => 'int',
        'not_null' => TRUE,
      ),
      'period_unit' => array(
        'description' => 'Plan billing frequency unit.',
        'type' => 'varchar',
        'length' => '10',
        'not_null' => TRUE,
      ),
      'trial_period' => array(
        'description' => 'Plan trial period',
        'type' => 'int',
      ),
      'trial_period_unit' => array(
        'description' => 'Plan trial period unit.',
        'type' => 'varchar',
        'length' => '10',
      ),
      'free_quantity' => array(
        'description' => 'Plan free quantity',
        'type' => 'int',
      ),
      'status' => array(
        'description' => 'Plan status.',
        'type' => 'varchar',
        'length' => '10',
        'not_null' => TRUE,
      ),
      'description' => array(
        'description' => 'Plan description',
        'type' => 'text',
      ),
    ),
    'primary key' => array('id'),
  );
  return $schema;
}

// @TODO Get additional tests with cache tables.

/**
 * Implements hook_install().
 */
function chargebee_install() {
  if (module_exists('entitycache')) {
    $tables = array(
      'cache_entity_chargebee_subscription',
      'cache_entity_chargebee_customer',
      'cache_entity_chargebee_card',
      'cache_entity_chargebee_plan',
    );
    $cache_schema = drupal_get_schema_unprocessed('system', 'cache');
    $cache_schema['description'] = 'ChargeBee entity cache.';
    foreach ($tables as $table) {
      if (!db_table_exists($table)) {
        db_create_table($table, $cache_schema);
      }
    }
  }
}

/**
 * Implements hook_uninstall().
 */
function chargebee_uninstall() {
  $tables = array(
    'cache_entity_chargebee_subscription',
    'cache_entity_chargebee_customer',
    'cache_entity_chargebee_card',
    'cache_entity_chargebee_plan',
  );
  foreach ($tables as $table) {
    db_drop_table($table);
  }
  variable_del('chargebee_api_site_name');
  variable_del('chargebee_api_key');
  variable_del('chargebee_webhook_hash');
  variable_del('chargebee_plans_roles');
}
