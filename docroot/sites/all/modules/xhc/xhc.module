<?php

/**
 *
 * @file XML sitemap Http Cache module.
 */

/**
 * Implements hook_menu();
 * @return array $items
 */
function xhc_menu() {
  $items['admin/config/search/xmlsitemap/http-cache'] = array(
    'title' => 'Http Cache',
    'page callback' => 'xhc_admin_link',
    'access arguments' => array('administer xmlsitemap'),
    'type' => MENU_LOCAL_TASK,
  );
  $items['xhc/cache_sitemap/%'] = array(
    'page callback' => 'xhc_generate',
    'page arguments' => array(2),
    'access arguments' => array('administer nodes'),
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}

/**
 * The xhc administration menu page.
 *
 * @return array (Drupal render array)
 */
function xhc_admin_link() {
  $sitemaps = xmlsitemap_sitemap_load_multiple(FALSE);
  $sitemap_admin_links = array();
  foreach ($sitemaps as $sitemap) {
    $sitemap_url = url($sitemap->uri['path'], $sitemap->uri['options']);
    $admin_url = 'xhc/cache_sitemap/' . $sitemap->smid;
    $link = array(
      'title' => preg_replace('/^http:\/\/[^\/]*/', '', $sitemap_url),
      'href' => $admin_url,
    );
    $sitemap_admin_links['links'][] = $link;
  }
  $render_array = array(
    'Title' => array(
      '#markup' => '<h3>Xmlsitemap Http Cache links:</h3><div>Generates your http-cache with PHP Curl requests</div>',
    ),
    'links' => array(
      '#markup' => theme('links', $sitemap_admin_links)
    )
  );
  if (module_exists('xhc_cron')) {
    $render_array['tasks_list'] = xhc_cron_form_list();
  }
  return $render_array;
}

/**
 * Generate the http cache from the xmlsitmap smid parameter.
 *
 * @param type $smid
 * @param boll $cron
 */
function xhc_generate($smid, $cron = FALSE) {

  $sitemap = xmlsitemap_sitemap_load($smid);

  $sitemap = simplexml_load_file(url($sitemap->uri['path'], $sitemap->uri['options']));

  $urls = array();
  foreach ($sitemap->url as $url) {
    $batch['operations'][] = array('xhc_path', array($url->loc->__toString()));
  }

  batch_set($batch);

  if ($cron === TRUE) {
    $batch =& batch_get();
    $batch['progressive'] = FALSE;
  }

  batch_process('');
}

/**
 * Cache a single page with a PHP Curl request.
 *
 * @param type $path
 * @param array $context
 */
function xhc_path($path, &$context) {
  $c = curl_init();
  curl_setopt($c, CURLOPT_URL, $path);
  curl_setopt($c, CURLOPT_FRESH_CONNECT, TRUE);
  curl_setopt($c, CURLOPT_RETURNTRANSFER, 1);
  curl_exec($c);
  curl_close($c);
  $context['message'] = 'Caching ' . $path;
}