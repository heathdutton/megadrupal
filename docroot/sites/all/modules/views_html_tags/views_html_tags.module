<?php

/**
 * @file
 * This is the main module file for the Views HTML tags  module.
 */

/**
 * Implements hook_permission().
 */
function views_html_tags_permission() {
  return array(
    'administer views html tags' => array(
      'title' => t('Administer views HTML tags'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function views_html_tags_menu() {
  $items = array();
  $items['admin/config/user-interface/views-html-tags'] = array(
    'title' => 'Views HTML tags',
    'description' => 'Manage html tags available in the style settings section of views field configuration.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('views_html_tags_settings'),
    'access arguments' => array('administer views html tags'),
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}

/**
 * Form to manage views html tags.
 *
 * @see views_html_tags_settings_submit()
 *
 * @ingroup forms
 */
function views_html_tags_settings($form, &$form_state) {
  $form['views_html_tags'] = array(
    '#type' => 'textarea',
    '#title' => t('HTML tags'),
    '#required' => TRUE,
    '#default_value' => views_html_tags_get_default(),
    '#weight' => 0,
    '#description' => t('Enter HTML tags available in the style settings section of views field configuration, separated by commas.(Example:div,span,p,h1)'),
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Submit',
  );
  return $form;
}

/**
 * Submit handler for views_html_tag_settings form.
 *
 * @see views_html_tags_settings()
 */
function views_html_tags_settings_submit($form, &$form_state) {
  module_load_include('inc', 'views', 'views_handler_field');
  if (!empty($form_state['values']['views_html_tags'])) {
    $views_html_tags = trim($form_state['values']['views_html_tags']);
    $tags = explode(',', $views_html_tags);
    $vals = array();
    $default_item = new views_handler_field();
    $default_elements = $default_item->get_elements();
    if (count($default_elements)) {
      $vals = array_slice($default_elements, 0, 2);
    }

    foreach ($tags as $val) {
      $val   = trim($val, " ");
      $value = strtolower($val);
      $label = strtoupper($val);
      if ($value) {
        $vals[$value] = $label;
      }
    }
    variable_set('views_field_rewrite_elements', $vals);
  }
  else {
    variable_del('views_field_rewrite_elements');
  }
  drupal_set_message(t('The views html tags have been saved.'));
}

/**
 * Helper function to get default tag entries.
 */
function views_html_tags_get_default() {
  module_load_include('inc', 'views', 'views_handler_field');
  $tag_item = new views_handler_field();
  $tag_elements = $tag_item->get_elements();
  $tags = '';
  if (count($tag_elements)) {
    $tags = implode(',', array_filter(array_keys($tag_elements)));
  }
  return $tags;
}

/**
 * Validate function for views_html_tag_settings form.
 */
function views_html_tags_settings_validate($form, &$form_state) {
  if (!preg_match('/^[-a-zA-Z0-9, .]+$/', $form['views_html_tags']['#value'])) {
    form_set_error('views_html_tags', 'Special characters are not allowed in HTML tags.');
  }
}

