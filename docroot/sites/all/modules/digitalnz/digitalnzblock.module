<?php
/**
 * @file
 * Display search results from DigitalNZ API http://digitalnz.org in block,
 * intended to be displayed beside normal Drupal search results.
 *
 * This module sponsored by the Ministry of Culture and Heritage.
 *
 * @author digitalnzblock.module@huntdesign.co.nz
 *
 * Normally this block would be configured to appear on search/* paths only.
 *
 * @todo:
 * - resolve potential conflict between # of results for block vs digitalnzsearch module
 * - consider caching, esp. for additional pages of same search keys.
 */

/**
 * Implements hook_theme().
 */
function digitalnzblock_theme() {
  return array(
    'digitalnzblock_results' => array(
      'function' => 'theme_digitalnzblock_results',
    ),
  );
}

/**
 * Implements hook_block_info().
 */
function digitalnzblock_block_info() {
  $blocks['digitalnz_results'] = array(
    'info' => t('DigitalNZ: Results'),
  );
  return $blocks;
}

/**
 * Implements hook_block_configure().
 */
function digitalnzblock_block_configure($delta) {
  switch ($delta) {
    case 'digitalnz_results':
      $form = array();
      $form['digitalnz_block_num_thumbnails'] = array(
        '#type' => 'select',
        '#title' => t('Number of thumbnails to display'),
        '#default_value' => variable_get('digitalnz_block_num_thumbnails', 2),
        '#options' => range(0, 10),
      );

      $form['digitalnz_block_num_results'] = array(
        '#type' => 'select',
        '#title' => t('Total number of results to display'),
        '#default_value' => variable_get('digitalnz_block_num_results', 7),
        '#options' => range(0, 10),
        '#description' => t('Includes thumbnails as specified above.'),
      );
      return $form;
  }
}

/**
 * Implements hook_block_save().
 */
function digitalnzblock_block_save($delta = '', $edit = array()) {
  switch ($delta) {
    case 'digitalnz_results':
      variable_set('digitalnz_block_num_thumbnails', (int)$edit['digitalnz_block_num_thumbnails']);
      variable_set('digitalnz_block_num_results', (int)$edit['digitalnz_block_num_results']);
      break;
  }
}

/**
 * Implements hook_block_view().
 */
function digitalnzblock_block_view($delta = '') {

  switch ($delta) {
    case 'digitalnz_results':
      $block = array();
      // Only generate block if we have some content to show.
      $content = digitalnzblock_content();
      if (!empty($content)) {
        $block['subject'] = t('Results from DigitalNZ');
        $block['content'] = array('#markup' => $content);
        return $block;
      }
      break;
  }
}

/**
 * Generate content based on current search or page title.
 * @param $keys Search text
 */
function digitalnzblock_content($keys = '') {
  $output = '';

  // If no search keys provided, try and get them from path.
  if (empty($keys)) {
    if (arg(0) == 'search' && arg(1) == 'node') {
      $keys = arg(2);
    }
  }
  // We have something to search on?
  if (!empty($keys)) {
    // @todo: check cache?
    $num_per_page = variable_get('digitalnz_block_num_results', 5);
    $xml = digitalnzapi_do_search($keys, 0, $num_per_page);

    $results = digitalnzapi_results($xml);

    // Did we get a useful response?
    if (digitalnz_has_searched()) {
      $output = theme('digitalnzblock_results', array('results' => $results, 'keys' => $keys));
    }
  }

  return $output;
}

/**
 * Theme results from DigitalNZ as a list thumbnails, followed by a list of other results.
 * Thumbnails and other results both have a 'more' link following them.
 */
function theme_digitalnzblock_results($variables) {
  flog_it(__FUNCTION__ . ': variables=' . print_r($variables, TRUE));
  $results = $variables['results'];
  $keys = $variables['keys'];
  drupal_add_css(drupal_get_path('module', 'digitalnzblock') .'/digitalnzblock.css');

  $output = '';
  $num_images = variable_get('digitalnz_block_num_thumbnails', 2);

  if (count($results) > 0) {
    $images = array();
    $items = array();

    // Iterate through results, splitting images out into separate list.
    foreach ($results as $result) {
      if ($result['type'] == 'Images' && !empty($result['node']['thumbnail-url']) && $num_images > 0) {
        $title = $result['title'] .' - '. $result['extra']['provider'];
        // Force variable size thumbnails into a more useful size. Could use imagecache here.
        $attributes = array('height' => 85, 'width' => 85);
        $image = theme('image', array(
          'path' => $result['node']['thumbnail-url'],
          'title' => $title,
          'alt' => $title,
          'attributes' => $attributes,
        ));
        $item = l(
          $image,
          $result['node']['source-url'],
          array('html' => TRUE, 'attributes' => array('title' => $title))
        );
        $images[] = $item;
        $num_images--;
      }
      else {
        $items[] = t('!title - !content_provider', array(
          '!title' => l($result['title'], $result['link']),
          '!content_provider' => $result['extra']['provider'],
        ));
      }
    }

    if (count($images)) {
      $output .= theme('item_list', array('items' => $images, 'attributes' => array('class' => 'digitalnz-images')));
      $more_images_url = DIGITALNZ_SEARCH_URL .'?search_text='. urlencode($keys .' AND category:Images');
      $output .= '<p>'. l('More images >', $more_images_url) .'</p>';
    }

    if (count($items)) {
      $output .= theme('item_list', array('items' => $items, 'attributes' => array('class' => 'digitalnz-results')));
      $more_results_url = DIGITALNZ_SEARCH_URL .'?search_text='. urlencode($keys);
      $output .= '<p>'. l('More results >', $more_results_url) .'</p>';
    }
  }
  else {
    $output = t('No results for %keys', array('%keys' => $keys));
  }

  return $output;
}
