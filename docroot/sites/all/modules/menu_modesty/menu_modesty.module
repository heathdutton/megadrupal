<?php

/**
 * Implements hook_menu().
 */
function menu_modesty_menu() {
    $items = array();
    $items['admin/structure/menu/manage/%/modesty'] = array(
        'title' => 'Modesty',
        'description' => 'Link modesty',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('menu_modesty_admin', 4),
        'access arguments' => array('administer menu'),
        'type' => MENU_LOCAL_TASK,
        'file' => 'menu_modesty.admin.inc',
    );

    return $items;
}

/**
 * Implements hook_menu_alter().
 */
function menu_modesty_menu_alter(&$items) {
    $menu_items = db_query("SELECT path, type FROM {menu_modesty}");
    foreach ($menu_items as $menu_item) {
        $items[$menu_item->path]['type'] = (int)$menu_item->type;
    }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function menu_modesty_form_menu_edit_item_alter(&$form, &$form_state, $form_id) {
    $menu_item = menu_get_item($form['link_path']['#value']);
    $type = $menu_item['type'];

    if ($type == MENU_NORMAL_ITEM || $type == MENU_LOCAL_TASK) {
        $value = menu_modesty_menu_item_type($menu_item);
        
        $form['menu_type_submit'] = array(
            '#type' => 'button',
            '#value' => 'This menu requires modesty, oh my!',
            '#validate' => array('menu_modesty_form_menu_edit_item_submit'),
        );
    }
}

function menu_modesty_menu_item_type($menu_item) {
    $type = db_query("SELECT type FROM {menu_modesty} WHERE path = :path", array(':path' => $menu_item['path']))->fetchField();
    return ($type !== false) ? $type : $menu_item['type'];
}

function menu_modesty_form_menu_edit_item_submit(&$form, &$form_state) {
    $path = $form['link_path']['#value'];
    $type = MENU_LOCAL_TASK;

    db_query("REPLACE INTO {menu_modesty} (path, type) VALUES (:path, :type)", array(':type' => $type, ':path' => $path));
    db_query("UPDATE {menu_router} SET type = :type WHERE path = :path", array(':type' => $type, ':path' => $path));
    menu_rebuild();

    drupal_set_message('Thank you, this menu item has regained its modesty.');
}
