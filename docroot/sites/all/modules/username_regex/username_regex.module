<?php
/**
 * @file
 * Module functions for the collapser module.
 */

/**
 * Implements hook_variable_info().
 */
function username_regex_variable_info($options) {
  $variables['username_regex_pattern'] = array(
    'type' => 'string',
    'title' => t('Username regex', array(), $options),
    'default' => '',
    'description' => t("A valid regex pattern, including delimiters and flags (like one that you would pass to php's preg_match() function) that validates user account names. If empty, no validation will happen. Be careful, regex is powerful.", array(), $options),
  );
  return $variables;
}

/**
 * Implements hook_form_alter().
 */
function username_regex_form_alter(&$form, &$form_state, $form_id) {
  switch ($form_id) {
    case 'user_profile_form':
    case 'user_register_form':
      $form['#validate'][] = '_username_regex_user_validate';
      break;
  }
}

/**
 * Validation callback.
 */
function _username_regex_user_validate($form, &$form_state) {
  if ($regex = variable_get_value('username_regex_pattern')) {
    if (!preg_match($regex, $form_state['values']['name'])) {
      form_set_error('name', 'Invalid username, please consider your site admin.');
    }
  }
}
