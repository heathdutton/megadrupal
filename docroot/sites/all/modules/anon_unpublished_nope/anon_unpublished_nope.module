<?php
/**
 * @file
 * Anonymouse unpublished nope module file.
 *
 * Returns a 404 for anonymous users trying to access a unpublished node.
 * It could be done with the rules module.
 * But is a bit overkill for this small feature.
 */

/**
 * Implements hook_node_access().
 *
 * Allow users to view unpublished nodes, but modify them later to return 404
 * in hook_view_node_alter().
 */
function anon_unpublished_nope_node_access($node, $op, $account) {
  if ($op == 'view') {
    return NODE_ACCESS_ALLOW;
  }
  return NODE_ACCESS_IGNORE;
}

/**
 * Implements hook_node_view_alter().
 *
 * Provide a 404 page on unpublished nodes for anonymous users.
 * Access is allowed through hook_node_access().
 */
function anon_unpublished_nope_node_view_alter(&$build) {
  $node = $build['#node'];
  if ($node->status == NODE_NOT_PUBLISHED && !user_is_logged_in()) {
    drupal_not_found();
    drupal_exit();
  }
}
