<?php
/*
 * @file The main code of the syntaxhighlighter_to_pre module.
 */

/**
 * Implements hook_menu().
 */
function syntaxhighlighter_to_pre_menu() {
  $items = array();

  $items['syntaxhighlighter_to_pre'] = array(
    'title' => ' Convert {syntaxhighlighter} to PRE',
    'description' => 'Convert old {syntaxhighlighter} tags to PRE.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('syntaxhighlighter_to_pre_convert_form'),
    'access arguments' => array('convert old syntaxhighlighter tag to pre'),
    'type' => MENU_NORMAL_ITEM
  );

  return $items;
}

/**
 * Implementation of hook_permission().
 */
function syntaxhighlighter_to_pre_permission() {
  return array(
    'convert old syntaxhighlighter tag to pre' => array(
      'title' => t('Convert old syntaxhighlighter tag to PRE')
    )
  );
}

/**
 * Menu callback; Converter form.
 */
function syntaxhighlighter_to_pre_convert_form() {
  $form['notice'] = array(
    '#type' => 'markup',
    '#markup' => '<i style="color:red;">' . t('It is strongly recommended to backup your database before converting.') . '</i><br/>'
  );

  $options = array();
  $types = node_type_get_types();
  foreach ($types as $type => $info) {
    $options[$type] = check_plain($info->name);
  }

  $type_machine_names = array_keys($options);

  $form['type'] = array(
    '#title' => t('Content type'),
    '#type' => 'select',
    '#options' => $options,
    '#description' => t('Choose a content type for converting.'),
    '#default_value' => $type_machine_names[0],
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Convert',
  );

  return $form;
}

/**
 * Submit handler for syntaxhighlighter_to_pre_convert_form.
 *
 * @param $form
 * @param $form_state
 */
function syntaxhighlighter_to_pre_convert_form_submit($form, &$form_state) {
  if (form_get_errors()) {
    return;
  }

  $_SESSION['http_request_count'] = 0;

  // Start processing.
  $batch = syntaxhighlighter_to_pre_batch($form_state['values']['type']);
  batch_set($batch);
}


/**
 * Batch definition.
 */
function syntaxhighlighter_to_pre_batch($type) {

  $nodes = node_load_multiple(array(), array('type' => $type));

  drupal_set_message(t('Loading @num nodes of @type content type..', array('@num' => count($nodes), '@type' => $type)));

  $operations = array();

  foreach ($nodes as $node) {
    $operations[] = array('syntaxhighlighter_to_pre_operation', array($node, t('(Node @title)', array('@title' => check_plain($node->title)))));
  }

  $batch = array(
    'operations' => $operations,
    'finished' => 'syntaxhighlighter_to_pre_finished',
  );
  return $batch;
}

/**
 * Convert {syntaxhighlighter} to <pre> tag.
 */
function _syntaxhighlighter_to_pre_replace_old_tags($text) {
  $old_tag = 'syntaxhighlighter';
  $new_tag = 'pre';

  $pattern = '/\{' . $old_tag . '\s*([^\}]*)\}([^\{]*)\{\/' . $old_tag . '\}/';

  $matches = array();

  preg_match_all($pattern, $text, $matches, PREG_SET_ORDER);

  foreach ($matches as $match) {
    $replacement =
      '<' . $new_tag . ' class="' . $match[1] . '">' .
      str_replace('<', '&lt;', $match[2]) .
      '</' . $new_tag . '>';
    $text = str_replace($match[0], $replacement, $text);
  }

  return $text;
}

/**
 * Batch operation for syntaxhighlighter_to_pre_batch: process one node.
 * This is the function that is called on each operation in syntaxhighlighter_to_pre_batch bach.
 */
function syntaxhighlighter_to_pre_operation($node, $operation_details, &$context) {

  // We have single item in array $node->body[LANGUAGE_NONE] in case we translate content by nodes.
  // If entity translation mechanism is enabled then we have to process all translations.
  foreach ($node->body as $language => $item) {
    $node->body[$language][0]['value'] = _syntaxhighlighter_to_pre_replace_old_tags($node->body[$language][0]['value']);
  }

  node_save($node);

  // Store some result for post-processing in the finished callback.
  $context['results'][] = $node->nid . ' : ' . check_plain($node->title);

  // Optional message displayed under the progressbar.
  $context['message'] = t('Processing node "@title"', array('@title' => $node->title)) . ' ' . $operation_details;

  _syntaxhighlighter_to_pre_update_http_requests();
}

/**
 * Batch 'finished' callback used by syntaxhighlighter_to_pre_batch batch.
 */
function syntaxhighlighter_to_pre_finished($success, $results, $operations) {
  if ($success) {
    drupal_set_message(t('@count results processed in @requests HTTP requests.',
      array('@count' => count($results), '@requests' => _syntaxhighlighter_to_pre_get_http_requests())));
  }
  else {
    // An error occurred.
    // $operations contains the operations that remained unprocessed.
    $error_operation = reset($operations);
    drupal_set_message(t('An error occurred while processing @operation with arguments : @args', array('@operation' => $error_operation[0], '@args' => print_r($error_operation[0], TRUE))));
  }
}

/**
 * Utility function to count the HTTP requests in a session variable.
 */
function _syntaxhighlighter_to_pre_update_http_requests() {
  $_SESSION['http_request_count']++;
}

function _syntaxhighlighter_to_pre_get_http_requests() {
  return !empty($_SESSION['http_request_count']) ? $_SESSION['http_request_count'] : 0;
}