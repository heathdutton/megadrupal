<?php

/**
 * @file
 * Client-side redirect based GeoIP from Telize API.
 */

/**
 * Implements hook_menu().
 */
function telize_menu() {
  $items = array();
  $items['admin/config/system/telize'] = array(
    'title' => 'Telize Redirect',
    'description' => 'Telize Redirect settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('telize_settings'),
    'access callback' => 'user_access',
    'access arguments' => array('administer site configuration'),
  );

  return $items;
}

/**
 * Settings page.
 */
function telize_settings() {
  $form['telize_redirections'] = array(
    '#type' => 'textarea',
    '#title' => t('Redirections'),
    '#default_value' => variable_get('telize_redirections', ''),
    '#description' => t('List of Redirections in the format of COUNTRYCODE|URL <br/>'
        . 'One per Line. Example : IN|http://www.google.co.in <br/>'
        . 'Use full url with http.'),
  );

  return system_settings_form($form);
}

/**
 * Implements hook_init().
 */
function telize_init() {
  global $user;
  if (!$user->uid) {
    $redirection_rules = explode("\r\n", variable_get('telize_redirections', ''));
    $redirection_country_rules = array();
    foreach ($redirection_rules as $redirection_rule_string) {
      $redirection_rule_set = explode("|", $redirection_rule_string);
      $redirection_country_rules[$redirection_rule_set[0]] = $redirection_rule_set[1];
    }
    $redirect_urls = drupal_json_encode($redirection_country_rules);
    $javascript = "var telize_redirect_urls = $redirect_urls;";
    drupal_add_js($javascript, 'inline');
    $path = drupal_get_path('module', 'telize');
    drupal_add_js($path . '/telize.js');
  }
}
