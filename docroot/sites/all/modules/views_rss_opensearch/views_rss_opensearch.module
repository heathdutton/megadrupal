<?php
/**
 * @file
 * 
 * Module to add OpenSearch (namespace opensearch) item elements to Views RSS
 * http://drupal.org/node/1346506
 */

/**
 * Implements hook_views_rss_namespaces().
 */
function views_rss_opensearch_views_rss_namespaces() {
  $namespaces['opensearch'] = array(
    'prefix' => 'xmlns',
    'uri' => 'http://a9.com/-/spec/opensearch/1.1/',
  );

  return $namespaces;
}

/**
 * Implementation of hook_views_rss_channel_elements().
 */
function views_rss_opensearch_views_rss_channel_elements() {
  $elements['opensearch:itemsPerPage'] = array(
    'description' => t('The number of search results returned per page. This value will be extracted from the View results.'),
    'help' => 'http://www.opensearch.org/Specifications/OpenSearch/1.1#The_.22itemsPerPage.22_element',
    'preprocess functions' => array('_views_rss_opensearch_itemsPerPage'),
    'settings form' => array(
      '#type' => 'item',
      '#title' => 'itemsPerPage',
    ),
  );
  $elements['opensearch:startIndex'] = array(
    'description' => t('The index of the first search result in the current set of search results. This value will be extracted from the View results.'),
    'help' => 'http://www.opensearch.org/Specifications/OpenSearch/1.1#The_.22startIndex.22_element',
    'preprocess functions' => array('_views_rss_opensearch_startIndex'),
    'settings form' => array(
      '#type' => 'item',
      '#title' => 'startIndex',
    ),
  );
  $elements['opensearch:totalResults'] = array(
    'description' => t('The number of search results available for the current search. This value will be extracted from the View results.'),
    'help' => 'http://www.opensearch.org/Specifications/OpenSearch/1.1#The_.22totalResults.22_element',
    'preprocess functions' => array('_views_rss_opensearch_totalResults'),
    'settings form' => array(
      '#type' => 'item',
      '#title' => 'totalResults',
    ),
  );

  return $elements;
}

/**
 * Preprocess callback for channel element opensearch:itemsPerPage
 */
function _views_rss_opensearch_itemsPerPage(&$element) {
  $view = $element['view'];
  $element['value'] = ($view->pager['items_per_page']) ? $view->pager['items_per_page'] : count($view->result);
}

/**
 * Preprocess callback for channel element opensearch:startIndex
 */
function _views_rss_opensearch_startIndex(&$element) {
  $view = $element['view'];
  $element['value'] = $view->pager['offset'] + 1;
}

/**
 * Preprocess callback for channel element opensearch:totalResults
 */
function _views_rss_opensearch_totalResults(&$element) {
  $view = $element['view'];
  $element['value'] = count($view->result);
}
