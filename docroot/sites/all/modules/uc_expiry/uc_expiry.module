<?php

/**
 * @file
 */

/**
 * Instance of hook_help().
 */
function uc_expiry_help($path, $arg) {
  switch ($path) {
    case "admin/help#uc_expiry":
      return "<p>". t("Displays user's role expiry date.") ."</p>";
      break;
  }
}

/**
 * Instance of hook_block().
 */
function uc_expiry_block($op = "list", $delta = 0, $edit = array()) {
  // The $op parameter determines what piece of information is being requested.
  switch ($op) {
    case 'list':
      // If $op is "list", we just need to return a list of block descriptions.
      // This is used to provide a list of possible blocks to the administrator,
      // end users will not see these descriptions.
      $blocks[0] = array(
        'info' => t('Displays user\'s role expiry date.'),
      );
      // A block can provide default settings. In this case we'll enable the 
      // block and make it visible only on the 'node/*' pages. 
      $blocks[1] = array(
        'info' => t('Example: empty block'),
        'status' => TRUE,
        'weight' => 0,
        'visibility' => 1,
        'pages' => 'node/*',
      );
      return $blocks;
    case 'configure':
      // If $op is "configure", we need to provide the administrator with a
      // configuration form. The $delta parameter tells us which block is being
      // configured. In this example, we'll allow the administrator to customize
      // the text of the first block.
      $form = array();
      if ($delta == 0) {
        // All we need to provide is a text field, Drupal will take care of
        // the other block configuration options and the save button.
        $form['block_example_string'] = array(
          '#type' => 'textfield',
          '#title' => t('Block contents'),
          '#size' => 60,
          '#description' => t('This string will appear in the example block.'),
          '#default_value' => variable_get('block_example_string',  t('Some example content.')),
        );
      }
      return $form;
    case 'save':
      // If $op is "save", we need to save settings from the configuration form.
      // Since the first block is the only one that allows configuration, we
      // need to check $delta to make sure we only save it.
      if ($delta == 0) {
        // Have Drupal save the string to the database.
        variable_set('block_example_string', $edit['block_example_string']);
      }
      return;
    case 'view': default:
      // If $op is "view", then we need to generate the block for display
      // purposes. The $delta parameter tells us which block is being requested.
      switch ($delta) {
        case 0:
          // The subject is displayed at the top of the block. Note that it
          // should be passed through t() for translation.
          $block['subject'] = t('Account Expiry');
          // The content of the block is typically generated by calling a custom
          // function.
          $block['content'] = uc_expiry_block_content(1);
          break;
      }
      return $block;
  }
}

/**
 * Instance of hook_block_contents().
 */
function uc_expiry_block_content($block) {
  global $user;
  $output = "";
  
  // print time();
  
  // print "<pre>";
  // print_r($user);
  // print "<pre>";
  
  switch ($block) {
    case 1:
      $result = db_query_range('select u.reid, u.uid, u.rid, u.expiration, u.notified from {uc_roles_expirations} u where u.uid = %d', $user->uid, 0, 1);
      
      while ($expiry = db_fetch_object($result)) {
        $result2 = db_query_range('select r.rid, r.name from {role} r where r.rid = %d', $expiry->rid, 0, 1);
        
        while ($roles = db_fetch_object($result2)) {
          $output .= "<div class=\"uc_expiry\">";
          $output .= t("You registered on ". date("d F, Y", $user->created)) ." ";
          if (time() < $expiry->expiration) {
            $output .= t("and your account (". $roles->name .") expires on ". date("d F, Y", $expiry->expiration) .".");
          }
          else {
            $output .= t("and your account (". $roles->name .") expired on ". date("d F, Y", $expiry->expiration) .".  See all our ". l("products here", "products") .".");
          }
          $output .= "</div>";
        }
      }
      break;
  }
  return $output;
}
