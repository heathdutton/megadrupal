<?php
// $Id: asciidoc.module,v 1.2 2010/12/18 23:03:13 marvil07 Exp $

/**
 * Implements hook_filter_info().
 */
function asciidoc_filter_info() {
  return array(
    'asciidoc_simple' => array(
      'title'            => t('Simple AsciiDoc filter'),
      'description'      => t('Allows users to use AsciiDoc syntax.'),
      'process callback' => '_asciidoc_filter_asciidoc_simple_process',
      'tips callback'    => '_asciidoc_asciidoc_simple_tips',
    ),
  );
}

/**
 * Implements hook_filter_tips().
 */
function _asciidoc_asciidoc_simple_tips($filter, $format, $long) {
  return t('You can use <a href="@user_guide">AsciiDoc syntax</a> to format and style the text. For a quick reference see the <a href="@cheatsheet">cheatsheet</a>.', array('@user_guide' => 'http://www.methods.co.nz/asciidoc/userguide.html', '@cheatsheet' => 'http://powerman.name/doc/asciidoc'));
}

/**
 * Process callback for asccidoc_simple filter.
 *
 * @return
 *   As defined by hook_filter_FILTER_process().
 */
function _asciidoc_filter_asciidoc_simple_process($text, $filter, $format, $langcode, $cache, $cache_id) {
  return _asciidoc_process($text);
}

/**
 * Return asciidoc formatted text.
 */
function _asciidoc_process($text) {
  if (empty($text)) {
    return '';
  }

  // we use basically asciidoc defaults: --doctype article --backend xhtml11
  $command = sprintf('echo %s | asciidoc --no-header-footer -o - -', escapeshellarg($text));
  exec($command, $lines);
  $output = implode("\n", $lines);

  return $output;
}
