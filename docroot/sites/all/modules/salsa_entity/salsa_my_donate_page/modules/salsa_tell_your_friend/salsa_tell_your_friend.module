<?php

/**
 * @file
 * This is My Donate Page specific Tell A Friend module.
 */

/**
 * Implements hook_permission().
 */
function salsa_tell_your_friend_permission() {
  return array(
    'view salsa tell your friend page' => array(
      'title' => t('View Salsa Tell Your Friend Page'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function salsa_tell_your_friend_menu() {
  $items['salsa/tell_your_friends/%'] = array(
    'title' => 'Tell your friends',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('salsa_tell_your_friend_form', 2),
    'access arguments' => array('view salsa tell your friend page'),
  );
  return $items;
}

/**
 * Tell Your Friend form callback.
 */
function salsa_tell_your_friend_form($form, &$form_state, $page) {
  global $user;
  global $base_root;

  $form_state['page'] = $page;
  $form_state['my_donate_page'] = $my_donate_page = entity_load_single('salsa_my_donate_page', entity_load_single('salsa_supporter_my_donate_page', $page)->my_donate_page_KEY);
  $form_state['supporter'] = $supporter = salsa_entity_get_supporter();

  $form['view_this_donation_page_link'] = array(
    '#markup' => '<div>' . l(t('View this donation page'), $base_root . '/salsa/supporter_my_donate_page/' . $page) . '</div>',
  );

  $form['modify_your_page'] = array(
    '#markup' => '<div>' . l(t('Modify your page'), 'user/' . $user->uid . '/salsa_my_donate_page/' . $page) . '</div>',
  );

  $form['view_all_your_pages'] = array(
    '#markup' => '<div>' . l(t('View all your pages'), 'user/' . $user->uid . '/salsa_my_donations/campaigns') . '</div><br />',
  );

  $fromName  = $supporter ? $supporter->First_Name . ' ' : '';
  $fromName .= $supporter ? $supporter->Last_Name : '';
  $form['fromName'] = array(
    '#type' => 'textfield',
    '#title' => t('Your Name'),
    '#default_value' => $fromName,
    '#required' => TRUE,
  );

  $form['from'] = array(
    '#type' => 'textfield',
    '#title' => t('Your Email'),
    '#default_value' => $supporter ? $supporter->Email : '',
    '#required' => TRUE,
  );

  $form['subject_label'] = array(
    '#markup' => t('Subject:') . '&nbsp;' . $my_donate_page->Tell_a_Friend_Subject,
  );

  $form['subject'] = array(
    '#type' => 'hidden',
    '#value' => $my_donate_page->Tell_a_Friend_Subject,
  );

  $form['content'] = array(
    '#type' => 'textarea',
    '#title' => t('Your Message'),
    '#default_value' => $my_donate_page->Suggested_Tell_a_Friend_Message,
  );

  $form['to'] = array(
    '#type' => 'textarea',
    '#title' => t('Enter your friends email addresses'),
    '#description' => t('Use (;) to separate E-mail addresses.'),
    '#required' => TRUE,
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Send your message'),
  );

  return $form;
}

/**
 * Tell Your Friend form validate callback.
 */
function salsa_tell_your_friend_form_validate($form, &$form_state) {
  $to = explode(';', $form_state['values']['to']);
  foreach ($to as $mail) {
    if (!valid_email_address(trim($mail))) {
      form_set_error('to', t('The e-mail address(es) you specified for friends email address(es) field is not valid.'));
    }
  }

  if (!valid_email_address($form_state['values']['from'])) {
    form_set_error('from', t('The e-mail address you specified is not valid.'));
  }
}

/**
 * Tell Your Friend form submit callback.
 */
function salsa_tell_your_friend_form_submit($form, &$form_state) {
  global $base_root;

  $query = array(
    '#script' => 'processSpread.jsp',
    '#fields' => array(
      'fromName' => urlencode($form_state['values']['fromName']),
      'from' => urlencode($form_state['values']['from']),
      'subject' => urlencode($form_state['values']['subject']),
      'content' => urlencode($form_state['values']['content'] . "\n"
        . l(t('Check out my fundraising page!'), $base_root . "/salsa/supporter_my_donate_page/" . $form_state['page'])),
      'to' => urlencode($form_state['values']['to']),
    ),
  );

  // @todo It seems that the API doesn't return any message,
  // check once again if we can get a message status.
  salsa_api_query($query);
  drupal_set_message(t('E-mail sent successfully.'));

  if ($form_state['my_donate_page']->Tell_a_Friend_Redirect) {
    drupal_goto($form_state['my_donate_page']->Tell_a_Friend_Redirect);
  }
}
