<?php
/**
 * @file
 * Adds a block with a series of icons which link Instant Messengers.
 */

  module_load_include('inc', 'reach_us', 'reach_us');
/**
 * Implements hook_help().
 */
function reach_us_help($path, $arg) {
  $output = '';
  switch ($path) {
    case 'admin/config/services/reachus':
      $output = t('Please enter your communication services IDs. And move the Reach us Block in block management admin page.');
      break;

    case 'admin/help#reach_us':
      $output .= '<p>';
      $output .= t('Reach us module helps your visitors to contact you easily from various services. Especially in the era of more mobile Internet adaption, its easy for your client to reach you via various services such as whatsapp, skype, email, Yahoo messenger, AIM, facetime, Facebook messenger etc.');
      $output .= '</p><p>';
      $output .= t('There are 2 ways to show your reach icons.');
      $output .= '<ul><li>';
      $output .= t('By enable the Reach us block in admin page.');
      $output .= '</li><li>';
      $output .= t('print this php code in PHP filter or in templates : <code>print reach_us_output(); </code>');
      $output .= '</li></ul></p>';
      break;

  }
  return $output;
}

/**
 * Implements hook_menu().
 */
function reach_us_menu() {
  $items = array();
  $items['admin/config/services/reachus'] = array(
    'title' => 'Reach us',
    'description' => 'Configure the site-wide messaging service IDs',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('reach_us_form'),
    'access arguments' => array('edit reach us'),
    'file' => 'reach_us.admin.inc',
  );
  return $items;
}

/**
 * Implements hook_permission().
 */
function reach_us_permission() {
  return array(
    'edit reach us' => array(
      'title' => t('Reach us Settings'),
      'description' => t('Allow users to set reach us form settings'),
    ),
  );
}

/**
 * Implements hook_theme().
 */
function reach_us_theme() {
  $items = array();
  // Theme admin form.
  $items['reach_us_form'] = array(
    'render element' => 'form',
  );
  // Theme admin form.
  $items['reach_us_content'] = array(
    'arguments' => array(
      'content' => array(),
    ),
    'template' => 'reach_us_content',
  );
  return $items;
}

/**
 * Helper function to sort the services array based on the weight in database.
 */
function _reach_us_sort_services() {
  // Get all the services from inc.
  $services = reach_us_services();
  // Set the respective weight from db.
  foreach ($services as $key => $service) {
    $varweight = 'reach_us_serv_' . $key . '_weight';
    $varid = 'reach_us_serv_' . $key . '_id';
    if (trim(variable_get($varid, ''))) {
      $services[$key]['weight'] = variable_get($varweight, 10);
    }
    else {
      // Set the weight of empty ID to 50 to push down.
      $services[$key]['weight'] = 50;
    }
  }
  $sort = array();
  foreach ($services as $k => $v) {
    $sort['weight'][$k] = $v['weight'];
  }
  array_multisort($sort['weight'], SORT_ASC, $services);
  // Sort the array of services.
  return $services;
}

/**
 * Implements hook_block_info().
 */
function reach_us_block_info() {
  $blocks[0] = array(
    'info' => t('Reach Us'),
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function reach_us_block_view($delta = 0) {
  // Get the appropriate name to use in links.
  $display = variable_get('reach_us_display', 'icon');
  $visibility = variable_get('reach_us_visibility', 'horizontal');
  $iconsize = variable_get('reach_us_iconsize', 'sm');
  $message = variable_get('reach_us_message', '');
  // Build the array for theming.
  $content = _reach_us_content($display, $visibility, $iconsize, $message);
  // Return false of if no services are configured.
  if (!$content) {
    return FALSE;
  }
  $block['subject'] = t('Reach Us On');
  $block['content']['#markup'] = theme('reach_us_content', $content);
  $block['content']['#attached']['css'][] = drupal_get_path('module', 'reach_us') . '/reachus.css';
  return $block;
}

/**
 * Outputs the rendered HTML of list of contact services.
 *
 * @display
 * 	  get either "icon" or "link" or "both", icon give list of icons as
 *    click-able, link give list of text to click
 * @visibility
 * 	  pass either "vertical" or "horizontal", default is "vertical" it
 *    orders the items either vertical or horizontal based on this parameter.
 * @iconsize
 * 	  size of the icon "sm" for small, "md" for medium size and "lg" for
 *    large size icon, it has no effect if @linktype set to "link".
 * @return array
 *    return array of services and setting understand by the tpl file.
 */
function _reach_us_content($display = 'icon', $visibility = 'vertical', $iconsize = 'sm', $message = "") {
  $output = array();
  $services = _reach_us_sort_services();
  $count = 0;
  $message = filter_xss($message);
  foreach ($services as $key => $value) {
    $varlinktext = 'reach_us_serv_' . $key . '_linktext';
    $varid = 'reach_us_serv_' . $key . '_id';
    $temp_varid = variable_get($varid, '');
    if (trim($temp_varid)) {
      $output['services'][$key]['text'] = filter_xss(variable_get($varlinktext, ''));
      if (isset($services[$key]['schemamsg']) && trim($message)) {
        $href = str_replace("!id", $temp_varid, $services[$key]['schemamsg']);
        $output['services'][$key]['href'] = str_replace("!message", $message, $href);
      }
      else {
        $output['services'][$key]['href'] = str_replace("!id", $temp_varid, $services[$key]['schema']);
      }
      $count++;
    }
  }
  if ($count) {
    $output['settings']['display'] = filter_xss($display);
    $output['settings']['message'] = $message;
    $output['settings']['visibility'] = filter_xss($visibility);
    $output['settings']['iconsize'] = filter_xss($iconsize);
    $output['settings']['count'] = $count;
    return $output;
  }
  else {
    return FALSE;
  }
}

/**
 * Outputs the rendered HTML of list of contact services.
 *
 * @linktype
 * 	  get either "icon" or "link", icon give list of icons as click-able,
 *    link give list of text to click.
 * @return array
 *    Rendered array.
 */
function reach_us_output($display = 'icon', $visibility = 'vertical', $iconsize = 'sm', $message = "") {
  $content = _reach_us_content($display, $visibility, $iconsize, $message);
  if (!$content) {
    return FALSE;
  }
  $output = array();
  $output['#prefix'] = '<div class = "reachus-container">';
  $output['#markup'] = theme('reach_us_content', $content);
  $output['#suffix'] = '</div>';
  $output['#attached']['css'][] = drupal_get_path('module', 'reach_us') . '/reachus.css';
  return $output;
}
