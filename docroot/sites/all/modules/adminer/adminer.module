<?php
/**
 * @file
 * Provides database management using Adminer.
 */

/**
 * Helper functions.
 */
module_load_include('inc', 'adminer', 'adminer.functions');

/**
 * Implements hook_help().
 */
function adminer_help($path, $arg) {
  switch ($path) {
    case 'admin/help#adminer':
      // Return a line-break version of the module README.txt
      return _filter_autop(file_get_contents(dirname(__FILE__) . '/README.txt'));
      break;
  }
}

/**
 * Implements hook_permission().
 */
function adminer_permission() {
  return array(
    'use adminer' => array(
      'title' => t('Use Adminer'),
      'description' => t('Use Adminer to manage the database.'),
      'restrict access' => TRUE,
    ),
    'use adminer without login' => array(
      'title' => t('Use Adminer without DB credentials'),
      'description' => t('Manage DB through Adminer without specifying DB username/password.'),
      'restrict access' => TRUE,
    ),
  );
}

/**
 * Implements hook_menu().
 */
function adminer_menu() {
  $items['admin/config/development/adminer'] = array(
    'title' => 'Adminer',
    'description' => 'Manage DB through Adminer.',
    'page callback' => 'adminer_main_page',
    'access arguments' => array('use adminer'),
    'file' => 'adminer.pages.inc',
    'type' => MENU_NORMAL_ITEM,
  );
  $items['admin/config/development/adminer/adminer'] = array(
    'title' => 'Adminer',
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  $items['admin/config/development/adminer/settings'] = array(
    'title' => 'Settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('adminer_settings_form'),
    'access arguments' => array('use adminer'),
    'file' => 'adminer.admin.inc',
    'type' => MENU_LOCAL_TASK,
  );
  $items['admin/config/development/adminer/callback'] = array(
    'page callback' => 'adminer_get_adminer',
    'access arguments' => array('use adminer'),
    'file' => 'adminer.pages.inc',
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Implements hook_theme().
 */
function adminer_theme($existing, $type, $theme, $path) {
  return array(
    'adminer' => array(
      'variables' => array(
        'src' => NULL,
        'text' => t('Your browser does not support embedded frames.'),
      ),
      'template' => 'adminer',
    ),
  );
}

/**
 * Function to initialize Adminer. It is called by Adminer itself (adminer-*.php).
 */
function adminer_object() {
  $all_plugins = adminer_get_all_plugins();
  $plugins = adminer_get_plugins();
  $params = array();
  foreach ($plugins as $plugin) {
    include_once $all_plugins[$plugin]['path'];
    if (isset($all_plugins[$plugin]['class']) && $all_plugins[$plugin]['class']) {
      $params[] = new $all_plugins[$plugin]['class']();
    }
  }
  return new AdminerPlugin($params);
}
