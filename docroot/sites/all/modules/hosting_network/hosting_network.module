<?php

/* TODO:
 * * Locked platforms do not appear.
 * * Wishlist: Revamp server overview: Horizontal display
 * * Wishlist: Allow direct login through 
 *   https://www.drupal.org/project/oauth2_login or
 *   https://www.drupal.org/project/oauth2_authentication ??
 */

/**
 * Implements hook_menu
 */
function hosting_network_menu() {
  $items = array();
  $items['admin/hosting/network'] = array(
    'title' => 'Server Network settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('hosting_network_settings'),
    'access arguments' => array('administer hosting network'),
    'type' => MENU_LOCAL_TASK,
  );

  $items['hosting_network/nodes'] = array(
    'title' => 'Aegir network',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('hosting_network_nodes_form'),
    'access arguments' => array('administer hosting network'),
    'menu_name' => 'main-menu',
    'weight' => 20,
  );

  // server/platform
  $items['hosting_network/platform/%/%'] = array(
    'title' => 'Aegir network platform',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('hosting_network_platform_page_form', 2, 3),
    'access arguments' => array('administer hosting network'),
  );

  // server/site
  $items['hosting_network/site/%/%'] = array(
    'title' => 'Aegir network site',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('hosting_network_site_page_form', 2, 3),
    'access arguments' => array('administer hosting network'),
  );

  // server/task
  $items['hosting_network/task/%/%'] = array(
    'title' => 'Aegir network task',
    'page callback' => 'hosting_network_view_task',
    'page arguments' => array(2, 3),
    'access arguments' => array('administer hosting network'),
  );

  // server/node/target_type/task_type
  $items['hosting_network/run/%/%/%/%'] = array(
    'title' => 'Confirm task',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('hosting_network_run_task_form', 2, 3, 4, 5),
    'access callback' => 'hosting_network_task_menu_access_csrf',
  );


  // server/site
  $items['hosting_network/login/%/%'] = array(
    'title' => 'Aegir network login link',
    'page callback' => 'hosting_network_site_login',
    'page arguments' => array(2, 3),
    'access arguments' => array('administer hosting network'),
  );

  return $items;
}

/**
 * Implements hook_permission()
 */
function hosting_network_permission() {
  return array(
    'administer hosting network' => array(
      'title' => t('Administer Aegir network'),
      'description' => t('Manage Aegir Network sites and platforms.'),
    ),
  );
}

function hosting_network_theme($existing, $type, $theme, $path) {
  return array(
    'hosting_network_platform_list' => array(
      'variables' => array('platforms' => NULL, 'server_nid' => NULL),
      'file' => 'hosting_network.theme.inc',
    ),
    'hosting_network_task_list' => array(
      'variables' => array('tasks' => NULL, 'server_nid' => NULL, 'target_node' => NULL, 'display_run_buttons' => NULL),
      'file' => 'hosting_network.theme.inc',
    ),
    'hosting_network_platform_page' => array(
      'variables' => array('server_nid' => NULL, 'platform' => NULL, 'sites' => NULL, 'tasks' => NULL),
      'file' => 'hosting_network.theme.inc',
    ),
    'hosting_network_site_list' => array(
      'variables' => array('server_nid' => NULL, 'platform' => NULL, 'sites' => NULL),
      'file' => 'hosting_network.theme.inc',
    ),
    'hosting_network_site_page' => array(
      'variables' => array('server_nid' => NULL, 'platform' => NULL, 'site' => NULL, 'tasks' => NULL),
      'file' => 'hosting_network.theme.inc',
    ),
  );
}

function hosting_network_view_task($server_nid, $task_nid) {
  $node = hosting_network_get_task($server_nid, $task_nid);

  if ($node) {
    $log = hosting_network_get_task_log($server_nid, $task_nid);

    $html = _hosting_network_task_log_table($log);
    return drupal_render($html);
  }
}

function hosting_network_run_task_form($form, &$form_state, $server_nid, $target_nid, $target_type, $task_type) {
  if ($target_type == 'site') {
    $node = hosting_network_rest_call($server_nid, 'hosting_site/get_by_nid', array('nid' => $target_nid), 'POST');
  }
  else {
    $node = hosting_network_rest_call($server_nid, 'hosting_' . $target_type . '/' . $target_nid);
  }

  $server = node_load($server_nid);

  if ($node && $server) {
    $handlers = hosting_network_get_task_handlers($server_nid, $node);

    if (isset($handlers[$task_type]) && !empty($handlers[$task_type])) {
      $handler = $handlers[$task_type];

      switch ($handler) {
        case 'run':
          _hosting_network_run_and_message($server_nid, $target_nid, $task_type);
          $goto = 'hosting_network/' . $target_type . '/' . $server_nid . '/' . $target_nid;
          drupal_goto($goto);
          break;

        case 'confirm':
          $form['server_nid'] = array(
            '#type' => 'value',
            '#value' => $server_nid,
          );
          $form['target_nid'] = array(
            '#type' => 'value',
            '#value' => $target_nid,
          );
          $form['target_type'] = array(
            '#type' => 'value',
            '#value' => $target_type,
          );
          $form['task_type'] = array(
            '#type' => 'value',
            '#value' => $task_type,
          );
          $question = t("Aegir Network: @task remote object @object on @server?", array('@task' => $task_type, '@object' => $target_nid, '@server' => $server->title));
          $path = !empty($_REQUEST['destination'])? $_REQUEST['destination']: 'hosting_network/nodes';
          $form = confirm_form($form, $question, $path, '', $task_type);

          return $form;
          break;

        default:
          // TODO: Implement task form here. @see hosting_task_confirm_form

          break;
      }
    }
    else {
      $form['unhandled'] = array(
        '#markup' => t('Task "@task" has not yet been implemented for this object type.', array('@task' => $task_type)),
      );

      return $form;
    }
  }
  else {
    throw new Exception("Server unreachable.");
  }

  return $form;
}

function hosting_network_run_task_form_submit(&$form, &$form_state) {
  $server_nid = $form['server_nid']['#value'];
  $target_nid = $form['target_nid']['#value'];
  $task_type = $form['task_type']['#value'];
  $target_type = $form['target_type']['#value'];

  _hosting_network_run_and_message($server_nid, $target_nid, $task_type);

  $goto = 'hosting_network/' . $target_type . '/' . $server_nid . '/' . $target_nid;
  drupal_goto($goto);
}

/**
 * Helper function to run a simple task and display the appropriate message.
 */
function _hosting_network_run_and_message($server_nid, $target_nid, $task_type, &$debug = array()) {
  $task = hosting_network_rest_call($server_nid, 'hosting_task', array('type' => $task_type, 'nid' => $target_nid), 'POST', $debug);

  if (!empty($task)) {
    drupal_set_message(t('Task @task added successfully', array('@task' => $task_type)));
  } else {
    drupal_set_message(t('Task @task could not be added. Check server settings.', array('@task' => $task_type)), 'error');
  }
}

/**
 *  Helper function to get a task's info.
 */
function hosting_network_get_task($server_nid, $task_nid) {
  return hosting_network_rest_call($server_nid, 'hosting_task/' . $task_nid);
}

function hosting_network_get_task_log($server_nid, $task_nid) {
  return hosting_network_rest_call($server_nid, 'hosting_task/get_task_log', array('nid' => $task_nid), 'POST');
}

function hosting_network_nodes_form($form, &$form_state) {
  $network_nodes = hosting_get_servers('network_node');

  foreach($network_nodes as $nid => $hostname) {
    $node = node_load($nid);

    $link_to_server = '[' . l('Go to', 'http://' . $hostname, array('attributes' => array('target'=>'_blank'))) . ']';
    $prefix = '<fieldset class="collapsible" id="hosting-network-server-"' . $nid . '">';
    $prefix .= '<div><h2>' . $hostname . '</h2> ' . $link_to_server . '</div>';
    $prefix .= '<br/>';

    $form['hosting_network_' . $nid] = array(
      '#type' => 'markup',
      '#title' => t('Platform'),
      '#markup' => _hosting_network_get_server_markup($nid),
      '#prefix' => $prefix,
      '#suffix' => '</fieldset>',
    );
  }

  return $form;
}

function hosting_network_platform_page_form($form, &$form_state, $server_nid, $platform_nid) {
  $platform = hosting_network_rest_call($server_nid, 'hosting_platform/' . $platform_nid);
  $sites = (array) hosting_network_rest_call($server_nid, 'hosting_platform/sites', array('nid' => $platform_nid), 'POST');
  $tasks = hosting_network_get_task_list($server_nid, $platform, TRUE);

  if (empty($platform)) {
    return '<p>Server unreachable, please check that the OAuth server settings are correct.</p>';
  }

  $form['platform_info'] = array(
    '#type' => 'markup',
    '#title' => t('Server'),
    '#markup' => theme('hosting_network_platform_page', array('server_nid' => $server_nid, 'platform' => $platform, 'sites' => $sites, 'tasks' => $tasks)),
  );

  return $form;
}

function hosting_network_site_page_form($form, &$form_state, $server_nid, $site_nid) {
  $site = hosting_network_rest_call($server_nid, 'hosting_site/get_by_nid', array('nid' => $site_nid), 'POST');
  $platform = hosting_network_rest_call($server_nid, 'hosting_platform/' . $site->platform);

  // This is just to check if there is a login link
  $login_link = implode('', hosting_network_rest_call($server_nid, 'hosting_site/login_link', array('nid' => $site_nid), 'POST', $debug));
  if (!empty($login_link)) {
    $site->login_link = 'hosting_network/login/' . $server_nid . '/' . $site_nid;
  }

  $tasks = hosting_network_get_task_list($server_nid, $site, TRUE);

  if (empty($site)) {
    return '<p>Server unreachable or site doesn\'t exist, please check that the OAuth server settings are correct.</p>';
  }

  $form['site_info'] = array(
    '#type' => 'markup',
    '#title' => t('Site'),
    '#markup' => theme('hosting_network_site_page', array('server_nid' => $server_nid, 'platform' => $platform, 'site' => $site, 'tasks' => $tasks)),
  );

  return $form;
}

function hosting_network_site_login($server_nid, $site_nid) {
  $login_link = implode('', hosting_network_rest_call($server_nid, 'hosting_site/login_link', array('nid' => $site_nid), 'POST'));

  $debug = array();
  $expire = hosting_network_rest_call($server_nid, 'hosting_site/expire_login_link', array('nid' => $site_nid), 'POST', $debug);
  if (!empty($login_link)) {
    drupal_goto($login_link);
  }
  else {
    drupal_goto('hosting_network/site/' . $server_nid . '/' . $site_nid);
  }
}

/**
 * Shows the platforms and recent tasks ther server identified through $nid.
 */
function _hosting_network_get_server_markup($nid) {
  $platforms = hosting_network_get_platform_list($nid, TRUE);

  if (empty($platforms)) {
    return '<p>Server unreachable, please check that the OAuth server settings are correct.</p>';
  }

  $tasks = hosting_network_get_server_task_list($nid, variable_get('hosting_network_overview_tasks_per_server', 3));

  $html = '';
  $html .= '<div>';
  $html .= '<p><strong>Recent tasks</strong></p>';
  $html .= theme('hosting_network_task_list', array('tasks' => $tasks, 'server_nid' => $nid, 'display_run_buttons' => FALSE));
  $html .= '</div>';
  $html .= '<div>';
  $html .= '<p><strong>Platforms</strong></p>';
  $html .= theme('hosting_network_platform_list', array('platforms' => $platforms, 'server_nid' => $nid));
  $html .= '</div>';

  return $html;
}

/**
 * Returns a list of all platforms on a server with (option) all their sites.
 */
function hosting_network_get_platform_list($server_nid, $get_site_details = FALSE) {
  // GET call for the list of platforms
  // TODO: hosting_services a function to get all the details...
  $raw_platforms = hosting_network_rest_call($server_nid, 'hosting_platform');
  $platforms = array();

  if ($get_site_details && !empty($raw_platforms)) {
    foreach ($raw_platforms as $raw_platform) {
      $platform = hosting_network_rest_call($server_nid, 'hosting_platform/' . $raw_platform->nid);

      $platform->sites = (array) hosting_network_rest_call($server_nid, 'hosting_platform/sites', array('nid' => $platform->nid), 'POST');

      $platforms[$platform->nid] = $platform;
    }
  }

  return $platforms;
}

/**
 * Gets the list of available tasks with the status of the latest run.
 *
 * $object needs to be fully loaded to get the right task handlers.
 */
function hosting_network_get_task_list($server_nid, $node, $assign_handlers = TRUE) {
  $tasks = (array) hosting_network_rest_call($server_nid, 'hosting_task/get_task_list', array('nid' => $node->nid), 'POST');

  $handlers = hosting_network_get_task_handlers($server_nid, $node);

  // We know $handlers isn't empty because we assign some ourselves...
  foreach ($tasks as $type => $task) {
    if (isset($handlers[$type])) {
      $task->hosting_network_handler = $handlers[$type];
    }
  }

  return (array) $tasks;
}

/**
 * Gets the list of most a server's most recent tasks (as in sidebar).
 *
 * Setting the $limit higher than 5 won't work as index returns 5 tasks.
 */
function hosting_network_get_server_task_list($server_nid, $limit = 5) {
  $tasks = hosting_network_rest_call($server_nid, 'hosting_task');

  if (count($tasks) > $limit) {
    $tasks = array_slice($tasks, 0, $limit);
  }

  return (array) $tasks;
}

/**
 *  Authenticates and sends an OAuth-authenticated request based on the server.
 *
 * Only supports GET and POST requests for now:
 *  * https://www.drupal.org/node/2137333
 *  * https://www.drupal.org/node/2137349
 */
function hosting_network_rest_call($server_nid, $command, $command_params = array(), $method = 'GET', &$debug_info = array()) {
  $node = node_load($server_nid);

  // Only supports GET and POST, see function doc text.
  if ($method != 'GET' && $method != 'POST') {
    throw new Exception("HTTP method error: Only POST and GET requests are currently supported.");
  }

  if ($node) {
    // Wouldn't work with SSL, core bug:  https://www.drupal.org/node/1879970
    $base_url = 'http://' . $node->title . '/hosting_network_node';
  }
  else {
    return;
  }
  $conskey = $node->services['network_node']->oauth_key;
  $conssec = $node->services['network_node']->oauth_secret;

  $consumer = new OAuthConsumer($conskey, $conssec, NULL);
  $api_url = $base_url . '/' . $command;
  $params = array();
  $request = OAuthRequest::from_consumer_and_token($consumer, NULL, $method, $api_url, $params);
  $test = $request->sign_request(new OAuthSignatureMethod_HMAC_SHA1(), $consumer, NULL);
  $data = http_build_query($command_params, '', '&');
  $options = array(
    'headers' => array(
      'Accept' => 'application/json',
    ),
    'method' => $method,
    'data' => $data,
  );

  $response = drupal_http_request($request->to_url(), $options);

  $debug_info = array(
    'api_url' => $api_url,
    'consumer' => $consumer,
    'response' => $response,
    'request' => $request,
    'options' => $options,
  );

  if($response->code == 200){
    return json_decode($response->data);
  }
}

function hosting_network_settings($form, &$form_state) {
/*
  TODO:

  $tasks = hosting_network_get_server_task_list($nid, variable_get('hosting_network_overview_tasks_per_server', 3));
  $show_sites = variable_get('hosting_network_show_sites', TRUE);
  $max_sites = variable_get('hosting_network_max_sites_to_display', 10);
*/

  $form['hosting_network_show_sites'] = array(
    '#type' => 'checkbox',
    '#title' => t('Display sites in network overview'),
    '#default_value' => variable_get('hosting_network_show_sites', TRUE),
  );
  return system_settings_form($form);
}

/**
 * Implements hook_hosting_service_type().
 */
function hosting_network_hosting_service_type() {
  return array(
    'network_node' => array(// Machine name
      'title' => t('Network node'), // Human-readable name
      'weight' => 0, // Optional, defaults to 0
    ),
  );
}

/**
 * Implements hook_hosting_service().
 */
function hosting_network_hosting_service() {
  return array('hostmaster' => 'network_node'); // Service implementation => service type.
}

/**
 * Display table containing the logged information for this task
 */
function _hosting_network_task_log_table($log) {
  if (!empty($log)) {
    $headers = array('data' => 'Log message', 'execution_time' => 'Execution time');
    $rows = array();
    $last_timestamp = 0;
    $exec_time = '';
    $row_count = -1;
    foreach ($log as $entry) {
      if (strlen($entry->message) > 300) {
        $summary = "<span class='hosting-task-summary'>" . filter_xss(substr($entry->message, 0, 75), array()) . "... <a href='javascript:void(0)' class='hosting-summary-expand modalframe-exclude'>(" . t('Expand') . ')</a></span>';
        $message = $summary . "<span class='hosting-task-full'>" . filter_xss($entry->message) . '</span>';
      }
      else {
        $message = filter_xss($entry->message);
      }

      // Add error and warning anchors, so we can provide a quick link to them.
      if ($entry->type == 'error') {
        $message = '<a name="error"></a>' . $message;
      }
      elseif ($entry->type == 'warning') {
        $message = '<a name="warning"></a>' . $message;
      }

      // Add the exec_time to the previous row
      $exec_time = $entry->timestamp - $last_timestamp;

      // "1" is unreliable because timestamps don't allow sub-second granularity
      if ($exec_time < 1) {
        $exec_time = '<div>-</div>';
      }
      else if ($exec_time == 1) {
        $exec_time = '<div title="Many tasks take less than 1 second to perform. This duration represents an aggregate of the preceding tasks\' duration."><strong>' . $exec_time . ' s.</strong></div>';
      }
      else {
        $exec_time = '<div><strong>' . $exec_time . ' s.</strong></div>';
      }

      if ($row_count > -1) {
        $rows[$row_count]['data'][] = array(
          'data' => $exec_time,
        );
      }

      $row_count++;
      $last_timestamp = $entry->timestamp;

      $row = array(
        array(
          'data' => $message,
          'class' => array('hosting-status'),
        ),
      );

      $rows[] = array(
        'data' => $row,
        'class' => array(_hosting_task_log_class($entry->type)),
      );

      // Record that we've seen this log row.
      $last_lid = $entry->lid;
    }

    return array(
      '#theme' => "table",
      '#header' => $headers,
      '#rows' => $rows,
      '#attributes' => array(
        'id' => 'hosting-task-log',
        'class' => array(
          'hosting-table',
        ),
      ),
    );
  }

  return FALSE;
}

/**
 * Optional arguments: Form
 *  Form options: run, confirm OR method
 *
 *  * run just runs the task without asking for confirmation.
 *  * confirm displays a "ok/cancel" style confirmation page.
 *  * anything else (except empty) is considered the method to get the
 *    (underedred) form for confirmation.
 *  * task types without a handler will display a message instead of running.
 *
 *  Only the handlers for displayed tasks will be used.
 *
 * @see hosting_network_hosting_network_handlers().
 */
function hosting_network_get_task_handlers($server_nid, $node) {
  $task_handlers = module_invoke_all('hosting_network_handlers', $server_nid, $node);

  // TODO: hook_alter to allow modifications to the basic handlers.

  return $task_handlers;
}

/**
 * Implements hook_hosting_network_handlers();
 *
 * @see hosting_network_get_task_handlers().
 */
function hosting_network_hosting_network_handlers($server_nid, $node) {
  switch ($node->type) {
    case 'site':
      $handlers = array(
        'verify' => 'run',
        'backup' => 'run',
        'login-reset' => 'run',
        'disable' => 'confirm',
        'delete' => 'confirm',
        'enable' => 'confirm',
      );
      break;
    case 'platform':
      $handlers = array(
        'verify' => 'run',
        'lock' => 'run',
        'unlock' => 'run',
        'delete' => 'confirm',
      );
      break;
  }

  return $handlers;
}

/**
 * @see hosting_task_menu_access_csrf
 */
function hosting_network_task_menu_access_csrf() {
  global $user;

  if ((!isset($_GET['token']) || !drupal_valid_token($_GET['token'], $user->uid))) {
    return FALSE;
  }
  else {
    return user_access('administer hosting network');
  }
}
