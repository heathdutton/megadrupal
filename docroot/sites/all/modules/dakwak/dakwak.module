<?php

define('DAKWAK_DOMAIN', 'http://widget.dakwak.com/api/');

/**
 * Implementation of hook_menu().
 */

function dakwak_menu() {
  return array(
    'admin/config/regional/dakwak' => array(
      'title' => t('Dakwak settings'),
      'description' => 'Administer localization settings through Dakwak',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('dakwak_settings_form'),
      'access arguments' => array('administer dakwak settings'),
      'type' => MENU_NORMAL_ITEM | MENU_DEFAULT_LOCAL_TASK,
    ),
    'admin/config/regional/dakwak/new-user' => array(
      'title' => t('Create new user'),
      'description' => 'Administer localization settings through Dakwak',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('dakwak_settings_form'),
      'access arguments' => array('administer dakwak settings'),
      'type' => MENU_LOCAL_TASK,
    ),
  );
}

/**
 * Dakwak settings form used for administration.
 */

function dakwak_settings_form() {
  $settings = variable_get('dakwak_settings', array());

  $form['mode'] = array(
    '#type' => 'checkbox',
    '#title' => t('Development mode'),
    '#description' => '',
    '#default_value' => (isset($settings['mode']) ? $settings['mode'] : false),
  );

  $form['website_apikey'] = array(
    '#type' => 'textarea',
    '#title' => t('Dakwak API key'),
    '#description' => t('Paste your Dakwak API key here.'),
    '#default_value' => (isset($settings['website_apikey']) ? $settings['website_apikey'] : ''),
  );

  $form['generate_apikey'] = array(

  );

  $form['actions']['generate_apikey'] = array(
    '#type' => 'submit',
    '#description' => t('API Key will be emailed to you.'),
    '#value' => t('Generate API Key'),
    '#submit' => array('dakwak_generate_apikey'),
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save settings'),
  );

  return $form;
}

/**
 * Implementation of form_validate().
 */

function dakwak_settings_form_validate($form, &$form_state) {
  $values = $form_state['values'];
}

/**
 * Implementation of form_submit().
 */

function dakwak_settings_form_submit($form, &$form_state) {
  variable_set('dakwak_settings', $form_state['values']);
}


function dakwak_generate_apikey($form, &$form_state){
  drupal_set_message('API Key will be emailed to you.');
}

/**
 * Implementation of hook_block_info().
 */

function dakwak_block_info(){
  $blocks['language_menu'] = array(
    'info' => t('Dakwak Language Menu'),
  );

  return $blocks;
}

/**
 * Implementation of hook_block_view().
 */

function dakwak_block_view($delta = '') {
    // This example is adapted from node.module.
  $block = array();
  $content = 'Dakwak yohooo';
  $settings = variable_get('dakwak_settings', array());

  if(isset($settings['website_apikey'])) {
    $mode = $settings['mode'];
    $domain = dakwak_get_domain($mode);
    $url = "{$domain}websites/{$settings['website_apikey']}/widget";

    $options = array(
      'headers' => array('Content-Type' => 'application/x-www-form-urlencoded'),
      'method' => 'GET',
      'data' => http_build_query($settings, '', '&')
    );

    $request = drupal_http_request($url, $options);

    if (in_array( $request->code, array(200, 304))) {
      $content = (isset($request->data) ? json_decode($request->data) : 'Dakwak menu should appear here');
    } else {
      form_set_error('', "Something went wrong. " . $request->code .': '. $request->error);
    }
  } else {
      drupal_set_message(t('Dakwak needs confiugration.'), 'warning');
  }

  if($delta == 'language_menu') {
    $block['subject'] = '';
    $block['content'] = $content;
  }

  return $block;
}


function dakwak_get_domain($mode) {
  $domain = DAKWAK_DOMAIN;
  if($mode == 'development') {
  }
  
  return $domain;
}