<?php

/**
 * @file
 * Provides views integration for AUL module.
 */

module_load_include('inc', 'aul_views', 'includes/common');

/**
 * Implements of hook_views_api().
 */
function aul_views_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'aul_views') . '/views',
  );
}

/**
 * Implements hook_views_post_build().
 * Run query in context of user access.
 */
function aul_views_views_post_build($view) {

  if (empty($view->filter['aul_user_context'])) {
    return;
  }

  if (!($view->filter['aul_user_context'] instanceof views_handler_aul_user_context_filter)) {
    return;
  }
  
  if (empty($view->field)) {
    return;
  }
  
  foreach ($view->field as $key => $grants_field) {
    if (strpos($key, 'aul_grants') === FALSE) {
      continue;
    }
    
    if (!($grants_field instanceof views_handler_aul_user_grants_field)) {
      continue;
    }

    // Get user context.
    if(!$user_context = _aul_views_get_user_context($grants_field)) {
      return;
    }
    if(empty($user_context['uid'])) {
      return;
    }
    
    // Set user context.
    $query = $view->build_info['query'];
    $query->addMetaData('account', user_load($user_context['uid']));
  }
}
