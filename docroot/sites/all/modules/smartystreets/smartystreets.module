<?php

/**
 * Implements hook_permission().
 */
function smartystreets_permission() {
  return array(
      'administer smartystreets' => array(
          'title' => t('Administer SmartyStreets Settings'),
      ),
  );
}

/**
 * Implements hook_menu().
 */
function smartystreets_menu() {
  $items = array();

  $items['admin/config/services/smartystreets'] = array(
      'title' => 'SmartyStreets API',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('smartystreets_admin_settings_form'),
      'access arguments' => array('administer smartystreets'),
  );

  return $items;
}

/**
 * Implements hook_library().
 */
function smartystreets_library() {
  $libraries = array();

  // Library One.
  $libraries['liveaddress'] = array(
      'title' => 'SmartyStreets.com LiveAddress',
      'website' => 'http://smartystreets.com/kb/liveaddress-api/javascript',
      'version' => '1.0',
      'js' => array(
          drupal_get_path('module', 'smartystreets') . '/js/liveaddress.min.js' => array(),
      ),
  );

  return $libraries;
}

/**
 * Administrative settings form for SmartyStreets module
 */
function smartystreets_admin_settings_form() {
  $form = array();

  $form['smartystreets_secret_auth_token'] = array(
      '#type' => 'textfield',
      '#title' => t('Secret Auth Token'),
      '#default_value' => variable_get('smartystreets_secret_auth_token', ''),
  );


  $form['smartystreets_log_api_calls'] = array(
      '#type' => 'checkbox',
      '#title' => t('Log all SmartyStreets API calls'),
      '#default_value' => variable_get('smartystreets_log_api_calls', ''),
  );


  $form['smartystreets_log_api_responses'] = array(
      '#type' => 'checkbox',
      '#title' => t('Log all SmartyStreets API responses'),
      '#default_value' => variable_get('smartystreets_log_api_responses', ''),
  );

  return system_settings_form($form);
}

/**
 * Initiates a GET request to the SmartyStreets LiveAddress API
 * @param string $location A string representing an unparsed address
 * @return array Array of standardized address objects from the LiveAddress API
 */
function smartystreets_liveaddress_api_call($location) {
  $url_template = 'https://api.qualifiedaddress.com/street-address/?street=%s&auth-token=%s';

  // Auth token is stored in a variable in the Drupal variables framework
  $auth_token = urlencode(variable_get('smartystreets_secret_auth_token', ''));
  // URL-encode the location function parameter
  $location = urlencode($location);

  // Build the URL
  $url = sprintf($url_template, $location, $auth_token);

  $log_calls = variable_get('smartystreets_log_api_calls', '');
  $log_responses = variable_get('smartystreets_log_api_responses', '');

  // When logging requests and responses, the "token" allows us to match requests
  // to responses in the log
  $token = uniqid();

  if ($log_calls) {
    watchdog('smartystreets', 'SmartyStreets API Call !token: !url', array('!token' => $token, '!url' => $url));
  }

  // GET request and turn into associative array
  $result = json_decode(file_get_contents($url));


  if ($log_responses) {
    watchdog('smartystreets', 'SmartyStreets API Response !token: !response', array('!token' => $token, '!response' => print_r($result, TRUE)));
  }

  return $result;
}

/**
 * Generates an MD5 hash from the given SmartyStreets LiveAddress API return object
 * @param object $obj An object containing a "components" object 
 * @return string An MD5 checksum comprised of the key elements from the "components" object
 */
function smartystreets_generate_hash($result_obj) {
  $obj = $result_obj->components;
  $string = sprintf("%s_%s_%s_%s_%s_%s_%s_%s_%s", $obj->primary_number, $obj->street_name, $obj->street_suffix, $obj->city_name, $obj->state_abbreviation, $obj->zipcode, $obj->plus4_code, $obj->delivery_point, $obj->delivery_point_check_digit);

  return hash('md5', $string);
}