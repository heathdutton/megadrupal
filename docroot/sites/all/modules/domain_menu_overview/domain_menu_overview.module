<?php
/**
 * @file
 * Domain menu overview module file
 * displays menus per domain
 */

define('DOMAIN_MENU_OVERVIEW_DEFAULT_NAME', 'default');
define('DOMAIN_MENU_OVERVIEW_LOCAL_ACTION', 'local_action');
define('DOMAIN_MENU_OVERVIEW_MENU_LISTING', 'menu_listing');
define('DOMAIN_MENU_OVERVIEW_ADMIN_SETTING_DETAIL_MENU', 'domain_menu_overview_type_of_detail_overview');
define('DOMAIN_MENU_OVERVIEW_ADMIN_SETTING_STUCTURE_OVERVIEW', 'domain_menu_overview_type_of_structure_overview');

define('DOMAIN_MENU_OVERVIEW_TYPE_SWITCH', 'domain');
define('DOMAIN_MENU_OVERVIEW_NAME', 'domain_menu_overview');

include_once 'domain_menu_overview.permissions.inc';

function _domain_menu_overview_get_enabled_types() {
  return domain_id_list();
}

/**
 * Implements hook_permission().
 */
function domain_menu_overview_permission() {
  $menus = _domain_menu_overview_get_enabled_menus();
  $enabled_domain_menu_overviews = _domain_menu_overview_get_enabled_types();
  $permissions = array();
  // Make permissions for all the enabled languages.
  foreach ($enabled_domain_menu_overviews as $menu_domain => $domain_name) {
    if (!empty($menus)) {
      foreach ($menus as $menu) {
        $permissions['administer ' . $menu . '_' . $menu_domain]
          = array('title' => t('Administer the menu:') . $menu . ' '
          . t('in') . ' ' . $menu_domain
        );
      }
    }
  }
  return $permissions;
}

/**
 * Implements hook_menu().
 *
 * @return array
 *   arr menu items
 */
function domain_menu_overview_menu() {
  global $_domain;
  
  $menus = _domain_menu_overview_get_enabled_menus();
  $enabled_domain_menu_overviews = _domain_menu_overview_get_enabled_types();
  $type_of_menu_listing = variable_get(DOMAIN_MENU_OVERVIEW_ADMIN_SETTING_STUCTURE_OVERVIEW, DOMAIN_MENU_OVERVIEW_LOCAL_ACTION);
  $domain_menu_overview_type_of_detail_overview =
    variable_get(DOMAIN_MENU_OVERVIEW_ADMIN_SETTING_DETAIL_MENU,
      DOMAIN_MENU_OVERVIEW_DEFAULT_NAME);

  // Shows all the enabled menus in the enabled languages.
  foreach ($enabled_domain_menu_overviews as $menu_domain => $domain_id) {
    if (!empty($menus)) {
      foreach ($menus as $localized_menu_name => $menu) {
        $items['admin/structure/' . $menu . '_' . $menu_domain] = array(
          'title' => ucfirst($localized_menu_name) . ' : ' . $menu_domain,
          'description' => 'This is the ' . $localized_menu_name . ' edit
          page for domain : ' . $menu_domain,
          'page callback' => 'drupal_get_form',
          'page arguments' => array(
            'domain_menu_overview_form',
            $menu,
            $domain_id
          ),
          'file' => 'domain_menu_overview.form.inc',
          'access arguments' => array('administer ' . $menu . '_' . $menu_domain),
          'type' => MENU_NORMAL_ITEM,
        );
        if ($type_of_menu_listing != DOMAIN_MENU_OVERVIEW_DEFAULT_NAME) {
          if ($type_of_menu_listing == DOMAIN_MENU_OVERVIEW_LOCAL_ACTION) {
            $items['admin/structure/' . $menu . '_' . $menu_language]['type'] = MENU_LOCAL_ACTION;
          }
          else {
            $items['admin/structure/' . $menu . '_' . $menu_domain]['type'] = MENU_SUGGESTED_ITEM;
            // Just on menu item on the structure page.
            if ($menu_domain == $_domain['machine_name']) {
              $items['admin/structure/' . $menu . '_' . $menu_domain] = array(
                'title' => t('Domain:') . ' ' . ucfirst($localized_menu_name),
                'description' => 'This is the domain ' . $localized_menu_name
                  . ' edit page',
                'page callback' => 'drupal_get_form',
                'page arguments' => array(
                  'domain_menu_overview_form',
                  $menu,
                  $domain_id
                ),
                'file' => 'domain_menu_overview.form.inc',
                'access arguments' => array('administer ' . $menu . '_' . $menu_domain),
                'type' => MENU_NORMAL_ITEM,
              );
            }
          }
        }
        // Shows tabs on the per language menu page to switch to other domains.
        foreach ($enabled_domain_menu_overviews as $other_domain => $domain_name) {
          if ($other_domain != $menu_domain) {
            $items['admin/structure/' . $menu . '_' . $menu_domain . '/tab_' . $menu . '_' . $other_domain] = array(
              'title' => ucfirst($localized_menu_name) . ' : ' . $other_domain,
              'page callback' => '_domain_menu_overview_goto_menu',
              'page arguments' => array($menu, $other_domain),
              'access arguments' => array('administer ' . $menu . '_' . $other_domain),
              'type' => MENU_LOCAL_TASK,
            );
            if ($domain_menu_overview_type_of_detail_overview == DOMAIN_MENU_OVERVIEW_MENU_LISTING) {
              $items['admin/structure/' . $menu . '_' . $menu_domain . '/tab_' . $menu . '_' . $other_domain]['type'] = MENU_NORMAL_ITEM;
            }
            if ($domain_menu_overview_type_of_detail_overview == DOMAIN_MENU_OVERVIEW_LOCAL_ACTION) {
              $items['admin/structure/' . $menu . '_' . $menu_domain . '/tab_' . $menu . '_' . $other_domain]['type'] = MENU_LOCAL_ACTION;
            }
          }
          else {
            // The lang where you are in.
            $items['admin/structure/' . $menu . '_' . $menu_domain . '/tab_' . $menu . '_' . $menu_domain] = array(
              'title' => ucfirst($localized_menu_name) . ' : ' . $other_domain,
              'type' => MENU_DEFAULT_LOCAL_TASK,
            );
            if ($domain_menu_overview_type_of_detail_overview == DOMAIN_MENU_OVERVIEW_LOCAL_ACTION) {
              $items['admin/structure/' . $menu . '_' . $menu_domain . '/tab_' . $menu . '_' . $menu_domain]['type'] = MENU_LOCAL_ACTION;
            }
          }
        }
      }
    }
  }
  // Admin section.
  $menu_path_admin = 'admin/structure/domain/domain_menu_overview';
  $menu_title = 'Domain menu overview';
  $items[$menu_path_admin . '/config'] = array(
    'title' => $menu_title . ' configuration',
    'type' => MENU_IS_LOCAL_TASK,
    'description' => 'Configure ' . $menu_title . ' module.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('domain_menu_overview_settings'),
    'access arguments' => array('administer site configuration'),
    'file' => 'domain_menu_overview.admin.inc',
  );
  return $items;
}

/**
 * Implements hook_theme().
 */
function domain_menu_overview_theme() {
  return array(
    'domain_menu_overview_form' => array(
      'render element' => 'form',
      'file' => 'domain_menu_overview.form.inc',
    ),
    'domain_menu_overview_page' => array(
      'variables' => array(
        'domain_id' => NULL,
        'menu' => NULL,
        'table' => NULL,
        'remaining_form_elements' => NULL
      ),
      'template' => 'theme/domain_menu_overview_page',
    ),
  );
}

/**
 * Gets the given menu for the given domain using the Q builder.
 *
 * Array @param $enabled_language
 *   enabled langs
 *
 * @param string $which_menu
 *   which menu u want to use
 *
 * Defaults  * menu = main-menu
 */
function domain_menu_overview_get_menu_links($which_menu = "main-menu") {
  $query = db_select('menu_links', 'ml');
  // Fields: which fields I need: see below which fields..
  $query->fields('m', array(
      'load_functions',
      'to_arg_functions',
      'access_callback',
      'access_arguments',
      'page_callback',
      'page_arguments',
      'delivery_callback',
      'title',
      'title_callback',
      'title_arguments',
      'type',
      'description',
  ));
  $query->fields('ml');

  $query->condition('ml.menu_name', $which_menu, '=');
  // Joins: join with the menu router..
  $query->leftJoin('menu_router', 'm', 'm.path = ml.router_path');

  // Ordering my query based on the tree (the menu tree).
  $query->orderBy('p1', 'ASC');
  $query->orderBy('p2', 'ASC');
  $query->orderBy('p3', 'ASC');
  $query->orderBy('p4', 'ASC');
  $query->orderBy('p5', 'ASC');
  $query->orderBy('p6', 'ASC');
  $query->orderBy('p7', 'ASC');
  $query->orderBy('p8', 'ASC');
  $query->orderBy('p9', 'ASC');

  // Execute it.
  return $query->execute();
}

/**
 * Gets all the enabled menus.
 * @return array
 *   arr language enabled menus
 */
function _domain_menu_overview_get_enabled_menus() {
  $menus = menu_get_menus();
  $domain_menu_overview_enabled_menus = NULL;
  foreach ($menus as $menu => $localized_menu_name) {
    $is_enabled_menu = variable_get('domain_menu_overview_' . str_replace(' ', '_', $menu), FALSE);
    if ($is_enabled_menu) {
      $domain_menu_overview_enabled_menus[$localized_menu_name] = $menu;
    }
  }
  return $domain_menu_overview_enabled_menus;
}

/**
 * MenuItem @param $menu LanguageString @param $enabled_mnu_language.
 */
function _domain_menu_overview_goto_menu($menu, $enabled_domain_menu) {
  drupal_goto('admin/structure/' . $menu . '_' . $enabled_domain_menu);
}

/**
 * Implementation of hook_menu_alter()
 */
function domain_menu_overview_menu_alter(&$items) {
  $items['admin/structure/menu']['page callback'] = '_domain_menu_overview_menu_overview_page';
  $items['admin/structure/menu']['access callback'] = '_domain_menu_overview_access';
  unset($items['admin/structure/menu']['access arguments']);
  $items['admin/structure/menu/manage/%menu']['access callback'] = '_domain_menu_overview_menu_access';
  $items['admin/structure/menu/manage/%menu']['access arguments'] = array(4);
  $items['admin/structure/menu/manage/%menu/add']['access callback'] = '_domain_menu_overview_menu_access';
  $items['admin/structure/menu/manage/%menu/add']['access arguments'] = array(4);
  $items['admin/structure/menu/manage/%menu/translate']['access callback'] = '_domain_menu_overview_menu_access';
  $items['admin/structure/menu/manage/%menu/translate']['access arguments'] = array(4);
  $items['admin/structure/menu/item/%menu_link/edit']['access callback'] = '_domain_menu_overview_menu_link_access';
  $items['admin/structure/menu/item/%menu_link/edit']['access arguments'] = array(4);
  $items['admin/structure/menu/item/%menu_link/reset']['access callback'] = '_domain_menu_overview_menu_link_access';
  $items['admin/structure/menu/item/%menu_link/reset']['access arguments'] = array(4);
  $items['admin/structure/menu/item/%menu_link/delete']['access callback'] = '_domain_menu_overview_menu_link_access';
  $items['admin/structure/menu/item/%menu_link/delete']['access arguments'] = array(4);
  $items['admin/structure/menu/item/%menu_link/translate']['access callback'] = '_domain_menu_overview_menu_link_access';
  $items['admin/structure/menu/item/%menu_link/translate']['access arguments'] = array(4);
}

/**
 * Implements hook_form_ID_alter().
 *
 * Alters the add a link form to change the domain to the domain of the
 * menu your are editing.
 */
function domain_menu_overview_form_menu_edit_item_alter(&$form, $form_state) {

  $query_params = drupal_get_query_parameters();

  if (empty($query_params['domain_id'])) {
    return;
  }

  $form['domain_menu_access']['manage']['domain_menu_access_show']['#default_value']
    = array('d' . $query_params['domain_id']);
}

/**
 * Alter the menu_edit_item form so that my hook runs last.
 *
 * @param $implementations
 * @param $hook
 */
function domain_menu_overview_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'form_alter') {
    $module_name = 'domain_menu_overview';

    if (isset($implementations[$module_name])) {
      $group = $implementations[$module_name];
      unset($implementations [$module_name]);
      $implementations[$module_name] = $group;
    }
  }
}
