<?php
/**
 * @file
 * Install and update functions for vk_openapi module
 */

/**
 * Implements hook_uninstall().
 */
function vk_openapi_uninstall() {
  variable_del('vk_openapi_app_id');
  variable_del('vk_openapi_secret_key');
  variable_del('vk_openapi_url');
  variable_del('vk_openapi_base_url');
  variable_del('vk_openapi_redirect_url');
  variable_del('vk_openapi_alter_login_form');
  variable_del('vk_openapi_username');
  variable_del('vk_openapi_nickname_lq');
  variable_del('vk_openapi_nickname_rq');
  variable_del('vk_openapi_allow_users_unite_accounts');
  variable_del('vk_openapi_oblige_users_to_enter_email');
}

/**
 * Updates data from Drupal 6.
 */
function vk_openapi_update_7001() {
  if (db_table_exists('vkontakte_users')) {
    $rows = db_select('vkontakte_users', 'v')->fields('v', array('uid', 'vkuid'))->execute();
    foreach ($rows as $row) {
      $count = db_select('authmap', 'a')
        ->condition('a.module', 'vk_openapi')
        ->condition('a.authname', $row->vkuid)
        ->countQuery()
        ->execute()
        ->fetchField();
      if ($count == 0) {
        db_insert('authmap')->fields(array('uid' => $row->uid, 'authname' => $row->vkuid, 'module' => 'vk_openapi'))->execute();
      }
    }
    return t('VK openapi data successfully moved.');
  }
}
