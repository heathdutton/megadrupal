<?php
/**
 * @file
 * The module allows site administartor put VK share button to nodes.
 */

/**
 * Implements hook_permission()
 */
function vk_share_permission() {
  return array(
    'use vkontakte share button' => array(
      'title' => t('Use VK share button'), 
    ),
  );
}

/**
 * Implements hook_menu()
 */
function vk_share_menu() {
  $items['admin/config/user-interface/vk_share'] = array(
    'title' => 'VKontakte share-button settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('vk_share_admin_settings'),
    'access arguments' => array('administer site configuration'),
    'file' => 'vk_share.admin.inc',
  );
  return $items;
}

/**
 * Implements hook_node_view()
 */
function vk_share_node_view($node, $view_mode, $langcode) {
  $links = array();
  $node_types = variable_get('vk_share_node_types', array('page' => 'page'));

  $access = user_access('use vkontakte share button');
  if ($node_types[$node->type] && $access) {
    $links['vk_share_link'] = _render_vk_share_button($node, ($view_mode == 'teaser') ? TRUE : FALSE);

    $node->content['links']['vk_share'] = array('#links' => $links);
  }
}

/**
 * Implements hook_init()
 */
function vk_share_init() {
  if (arg(0) != 'admin') {
    $element = array(
      '#type' => 'markup',
      '#markup' => '<script type="text/javascript" src="http://vkontakte.ru/js/api/share.js?9" charset="windows-1251"></script>',
    );
    drupal_add_html_head($element, 'vk_share_button');
  }
}

/**
 * Function draws the VK share button.
 */
function _render_vk_share_button($node, $teaser = FALSE) {
  $type = variable_get('vk_share_button_style', 'button_count');

  $text = preg_replace("!<script(.*?)</script>!si", "", $node->body['und'][0]['summary']);
  $text = str_replace("\n", "", $text);
  $text = str_replace('"', '\"', $text);
  $text = strip_tags($text);
  $text = trim($text);
  $text = substr($text, 0, 255);

  if ((!$teaser && variable_get('vk_share_display_page', 1)) || ($teaser && variable_get('vk_share_display_teaser', 1))) {
    drupal_add_css(drupal_get_path('module', 'vk_share') . '/vk_share.css');

    switch ($type) {
      case 'button_count':
        return array(
          'title' => '<script type="text/javascript"><!--
document.write(VK.Share.button({url:"' . url('node/' . $node->nid, array('absolute' => TRUE)) . '", title:"' . $node->title . '", description: "' . $text . '"},{type: "round", text: "Сохранить"}));
--></script>',
          'html' => TRUE,
        );
        break;
      case 'button':
        return array(
          'title' => '<script type="text/javascript"><!--
document.write(VK.Share.button({url:"' . url('node/' . $node->nid, array('absolute' => TRUE)) . '", title:"' . $node->title . '", description: "' . $text . '"},{type: "round_nocount", text: "Сохранить"}));
--></script>',
          'html' => TRUE,
        );
        break;
      case 'link':
        return array(
          'title' => '<script type="text/javascript"><!--
document.write(VK.Share.button({url:"' . url('node/' . $node->nid, array('absolute' => TRUE)) . '", title:"' . $node->title . '", description: "' . $text . '"},{type: "link", text: "Сохранить"}));
--></script>',
          'html' => TRUE,
        );
        break;
    }
  }
}