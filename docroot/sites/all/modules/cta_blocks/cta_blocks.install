<?php

/**
 * @file
 * Install file for CTA Blocks module.
 */

/**
 * Implements hook_schema().
 */
function cta_blocks_schema() {
  $schema['cta_blocks'] = array(
    'description' => 'Base table for cta blocks.',
    'export' => array( // Expose to ctools export
      'key'          => 'machine_name',
      'identifier'   => 'cta_block',
      'default hook' => 'default_cta_blocks',
      'api'          => array(
        'owner'           => 'cta_blocks',
        'api'             => 'default_cta_blocks',
        'minimum_version' => 1,
        'current_version' => 1,
      ),
    ),
    'fields' => array(
      'machine_name' => array(
        'description' => 'primary key',
        'type'        => 'varchar',
        'length'      => 28,
      ),
      'name' => array(
        'description' => 'Human readable name',
        'type'        => 'varchar',
        'length'      => 255,
      ),
      'title' => array(
        'description' => 'Title of call to action block',
        'type'        => 'varchar',
        'length'      => 255,
      ),
      'subtitle' => array(
        'description' => 'Optional subtitle text',
        'type'        => 'varchar',
        'length'      => 1024,
      ),
      'link' => array(
        'description' => 'Full link, or internal path',
        'type'        => 'varchar',
        'length'      => 512,
      ),
    ),
    'primary key' => array('machine_name'),
  );

  return $schema;
}

/**
 * Alter schema, truncate machine_name field.
 */
function cta_blocks_update_7101() {
  $query = db_select('cta_blocks', 'c');
  $query->fields('c', array('machine_name'));
  $result = $query->execute();
  $machine_names = [];
  while ($record = $result->fetchAssoc()) {
    $truncated = substr($record['machine_name'], 0, 28);
    if (!in_array($truncated, $machine_names)) {
      $machine_names[$record['machine_name']] = $truncated;
    }
    else {
      $exists = TRUE;
      $i = 1;
      while ($exists) {
        $len = 28 - (strlen($i + 1));
        $truncated = substr($record['machine_name'], 0, $len) . '_' . $i;
        if (!in_array($truncated, $machine_name)) {
          $machine_names[$record['machine_name']] = $truncated;
          $exists = FALSE;
        }
        else {
          $i++;
        }
      }
    }
  }
  foreach ($machine_names as $old => $new) {
    db_update('cta_blocks')
    ->fields(array('machine_name' => $new))
    ->condition('machine_name', $old)
    ->execute();
  }

  db_change_field(
    'cta_blocks',
    'machine_name',
    'machine_name',
    array(
      'description' => 'primary key',
      'type'        => 'varchar',
      'length'      => 28,
    ),
    array()
  );

  ctools_include('export');
  ctools_export_load_object_reset('cta_blocks');
}
