<?php

/**
 * @file
 * WebformPermit class for Webform per Email module.
 */

/**
 * WebformPermit Class.
 */
class WebformPermit {
  private $email = NULL;
  private $nid = NULL;
  private $hash = NULL;

  /**
   * Constructor for WebformPermit objects.
   *
   * You can provide the either the hash value or both email and nid.
   * If providing email and nid, please set NULL for hash, it will be generated.
   */
  public function __construct($hash = NULL, $email = NULL, $nid = NULL) {
    $this->hash = $hash;
    if ($email != NULL && $nid != NULL) {
      $this->email = $email;
      $this->nid = $nid;
      $this->hash = sha1($nid . '#' . $email);
    }
  }

  /**
   * Returns the hash value.
   */
  public function getHash() {
    return $this->hash;
  }

  /**
   * Saves the permit in the db.
   */
  public function save() {
    db_merge('webform_per_email_permit')
      ->key(array('permit' => $this->hash))
      ->fields(array(
        'permit' => $this->hash,
        'nid' => $this->nid,
        'email' => $this->email,
        'status' => 'VALID',
      ))
      ->execute();
  }

  /**
   * Validates the permit.
   *
   * Returns TRUE or FALSE.
   */
  public static function validate($hash, $nid) {
    $result = db_select('webform_per_email_permit', 'w')
      ->fields('w', array('permit'))
      ->condition('permit', $hash, '=')
      ->condition('nid', $nid, '=')
      ->condition('status', 'VALID', '=')
      ->range(0, 1)
      ->execute()
      ->rowCount();

    return $result ? TRUE : FALSE;
  }

  /**
   * Deletes the permit from the db.
   */
  public function destroy() {
    db_merge('webform_per_email_permit')
      ->key(array('permit' => $this->hash))
      ->fields(array(
        'status' => 'INVALID',
      ))
      ->execute();
  }

}
