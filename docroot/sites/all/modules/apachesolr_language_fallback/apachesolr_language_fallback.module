<?php

/**
 * Implement hook_apachesolr_index_document_build_node().
 */
function apachesolr_language_fallback_apachesolr_index_document_build_node($document, $node, $env_id) {

  //For all nodes, add the node's language as an applicable language.
  $document->addField('sm_applicable_languages', $node->language);

  //Get language list - List of all enabled languages on the site.
  $language_list = array_keys(language_list());

  //For the current Node, get all the languages that it is translated to.
  $node_language_objects = translation_node_get_translations($node->tnid);
  $node_languages = array();
  if (count($node_language_objects)) {
    foreach ($node_language_objects as $language_object) {
      $node_languages[] = $language_object->language;
    }
  }

  //Check if the node belongs to a translation set.
  if ($node->tnid) {
    //And if this is the default language fallback node
    if ($node->language == language_default('language') || $node->language == LANGUAGE_NONE) {
      //This means this node has translations
      //Now get all the languages that this node has got
      //For each of the enabled languages, if the node has not got a translation in that language,
      //we shall set the applicable language so it appears in that language results as well.
      foreach ($language_list as $enabled_language) {
        //we already added the node language, so exclude it
        if ($enabled_language != $node->language) {
          //check if the enabled language is not available in list of node languages
          if (!in_array($enabled_language, $node_languages)) {
            $document->addField('sm_applicable_languages', $enabled_language);
          }
        }
      }
    }
  }
  else {
    //This node does not have any translation. So it applies to all languages!
    foreach ($language_list as $enabled_language) {
      //again skip the node langiage since its already added.
      if ($enabled_language != $node->language) {
        $document->addField('sm_applicable_languages', $enabled_language);
      }
    }
  }
}

/**
 * Implement hook_apachesolr_query_alter().
 */
function apachesolr_language_fallback_apachesolr_query_alter($query) {
  //Alter the query such that the current results are shown only if the current
  //user's language is in the list of applicable languages for each result.
  //get current user language
  global $language;

  //Build an OR query
  $compiled_filter = new SolrFilterSubQuery('OR');
  //Language of result can be current user language 
  $compiled_filter->addFilter('sm_applicable_languages', $language->language);
  //Or it can be language neutral.
  $compiled_filter->addFilter('sm_applicable_languages', LANGUAGE_NONE);
  $query->addFilterSubQuery($compiled_filter);
}
