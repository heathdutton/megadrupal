<?php
/**
 * @file
 * Provide a headbar to attract user.
 */

/**
 * Implements hook_permission().
 *
 * To create a permission to view the header bar.
 */
function headbar_permission() {
  return array(
    'administer headbar' => array(
      'title' => t('Administer headbar'),
      'description' => t('Perform administration tasks for Headbar.'),
    ),
    'view headbar' => array(
      'title' => t('View Headbar'),
      'description' => t('Headbar will be visible.'),
    ),
  );
}


/**
 * Implements of hook_menu().
 */
function headbar_menu() {
  $items['admin/config/user-interface/headbar'] = array(
    'title' => 'Headbar',
    'description' => 'Change the text and appearance of headbar.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('headbar_admin_settings'),
    'access arguments' => array('administer headbar'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'headbar.admin.inc',
  );
  return $items;
}


/**
 * Implements hook_init().
 *
 * To load css and js file for header bar for every pages.
 */
function headbar_init() {
  // Check user permssion.
  if (!user_access("view headbar")) {
    return;
  }
  // Skip this entirely for AJAX requests or Admin pages.
  if (strpos($_GET['q'], 'js/') === 0 || strpos($_GET['q'], 'admin/') === 0) {
    return;
  }

  $path = drupal_get_path('module', 'headbar');
  drupal_add_css($path . '/css/headbar.css');

  drupal_add_js(array(
    'headbar_settings' => array(
      'color' => variable_get('headbar_color', '#EB593C'),
      'color_hover' => variable_get('headbar_color_hover', '#EB593C'),
      'delaytime' => variable_get('headbar_delaytime', '5000'),
    ),
  ),
  'setting');
  drupal_add_js($path . '/headbar.js', array('defer' => TRUE));
}

/**
 * Implements  hook_block_info().
 */
function headbar_block_info() {
  $block = array();
  $blocks['headbar_block'] = array(
    'info' => t('Headbar'),
    'cache' => DRUPAL_NO_CACHE,
  );
  return $blocks;
}


/**
 * Implements hook_block_view(). 
 */
function headbar_block_view($block_name = '') {
    $block=array();
 switch ($block_name) {
     case 'headbar_block':
       $block['subject'] = '';
       $block['content'] = _headbar_output();
     break;
      }
  return ($block);
}


/**
 * Load the text to show on header bar and the custom structure.
 *
 * @return string
 *   A html structurewhich contain the text to display and buttons to hide and
 *   show the header bar.
 * @see headbar_page_alter()
 */
function _headbar_output() {
   if (!user_access("view headbar")) {
    return false;
  }
  
  global $base_url;
  $path = $base_url . "/" . drupal_get_path('module', 'headbar');
  $text = variable_get('headbar_text', 'This text will appear on header bar');
  if(empty($text)) return false;
  $content = '<div class="headbar" style="display:none">
   <span>' . $text . '</span>
   <a class="close-notify" ><img class="headbar-up-arrow" src="' . $path .
   '/css/headbar-up-arrow.png"></a></div>
   <div class="headbar-stub" style="display:none">
    <a class="show-notify" ><img class="headbar-down-arrow"
    src="' . $path . '/css/headbar-down-arrow.png"></a></div>';
  return $content;
}
