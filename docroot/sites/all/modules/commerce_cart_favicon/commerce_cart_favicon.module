<?php

/**
 * @file
 * Defines features and functions.
 */

/**
 * Implements hook_library().
 *
 * For the file packaged with the module.
 */
function commerce_cart_favicon_library() {
  $libraries['favicojs'] = array(
    'title' => "Favico.js",
    'website' => 'http://lab.ejci.net/favico.js/',
    'version' => '0.3.4',
    'js' => array(
      drupal_get_path('module', 'commerce_cart_favicon') . '/js/favico.min.js' => array(),
    ),
  );
  return $libraries;
}

/**
 * Implements hook_page_build().
 */
function commerce_cart_favicon_page_build() {
  if ( path_is_admin(current_path()) ) {
    return;
  }

  drupal_add_library('commerce_cart_favicon', 'favicojs', TRUE);
  drupal_add_js(drupal_get_path('module', 'commerce_cart_favicon') .'/js/commerce_cart_favicon.js');

  global $user;
  $quantity = 0;
  $order = commerce_cart_order_load($user->uid);

  if ($order) {
      $wrapper = entity_metadata_wrapper('commerce_order', $order);
      $line_items = $wrapper->commerce_line_items;
      $quantity = commerce_line_items_quantity($line_items, commerce_product_line_item_types());
      $total = commerce_line_items_total($line_items);
      $currency = commerce_currency_load($total['currency_code']);
  }

  $settings = array(
    'count' => $quantity, 
    'settings' => variable_get('commerce_cart_favicon_settings', array())
  );
  drupal_add_js(array('commerceCartFavicon' => $settings), 'setting');
}

/**
 * Implements hook_menu().
 */
function commerce_cart_favicon_menu() {
  $items = array();
  $items['admin/commerce/config/cart-favicon'] = array(
    'title' => 'Cart favicon counter settings',
    'description' => 'Add the cart items counter on favicon.',
    'access arguments' => array('administer site configuration'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('commerce_cart_favicon_admin'),
    'file' => 'commerce_cart_favicon.admin.inc',
  );
  return $items;
}