<?php
/**
 * @file
 * WURFL installation functions.
 */

/**
 * Implementation of hook_requirements().
 * @param $phase
 * @return array
 */
function wurfl_requirements($phase) {
  $requirements = array();
  // Ensure translations don't break at install time.
  $t = get_t();

  if ($phase == 'runtime') {

    drupal_load('module', 'common');
    drupal_load('module', 'libraries');
    $library_path = libraries_get_path('wurfl-php');
    $bootstrap = DRUPAL_ROOT . '/' . $library_path . '/WURFL/Application.php';
    $resources_dir = $library_path . '/resources';
    $wurfl_repository_path = $resources_dir . '/wurfl.zip';

    //error messages
    $missed_or_wrong_package = $t('Please download the <a href="@url">WURFL PHP API package >= 1.5</a>, extract the archive and copy the contents to the following location:<br /><code>@path</code> . Make sure the main file, Application.php, is located at<br /><code>@class</code>.',
      array(
        '@url' => 'http://scientiamobile.com/downloads',
        '@path' => 'sites/all/libraries/wurfl-php',
        '@class' => 'sites/all/libraries/wurfl-php/WURFL/Application.php'
      ));

    //Check for the WURFL API library
    if (!$library_path || !file_exists($bootstrap)) {
      $description = $missed_or_wrong_package;
      $value = $t('Missing');
      $severity = REQUIREMENT_ERROR;
    }
    else {

      include_once $bootstrap;

      $value = WURFL_Constants::API_VERSION;
      if (version_compare($value, '1.5', '<')) {
        $severity = REQUIREMENT_ERROR;
        $description = $missed_or_wrong_package;
      } else {
        $severity = REQUIREMENT_OK;
        $description = null;
      }
    }

    $requirements['wurfl-php-api'] = array(
      'title' => $t('WURFL PHP API'),
      'value' => $value,
      'severity' => $severity,
      'description' => $description,
    );

    if ( !file_exists($wurfl_repository_path) ) {
      $value = $t('Missing');
      $severity = REQUIREMENT_ERROR;

      $description = $t('Please download the <a href="@url">WURFL Repository file (wurfl.zip)</a> and copy the contents to the following location:<br /><code>@path</code>',
        array(
          '@url' => 'http://scientiamobile.com/downloads',
          '@path' => 'sites/all/libraries/wurfl-php/resources',
        ));
    } else {
      global $wurfl_manager;
      wurfl_bootstrap();
      $severity = REQUIREMENT_OK;
      $value = t('Version: @version<br />Last Updated: @last_updated',
        array(
          '@version' => $wurfl_manager->getWURFLInfo()->version,
          '@last_updated' => $wurfl_manager->getWURFLInfo()->lastUpdated,
        )
      );
      $description = null;
    }

    $requirements['wurfl-repository'] = array(
      'title' => $t('WURFL Repository'),
      'value' => $value,
      'severity' => $severity,
      'description' => $description,
    );
  }
  return $requirements;
}
