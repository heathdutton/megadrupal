RBK Money simple payment

Краткое описание
----------------

Модуль позволяет принимать платежи через платежную систему RBK Money без
привязки к модулю интернет-магазина. Функциональность:

- создание платежей на странице rbk_money_simple/payment или программно
- вывод формы оплаты на странице rbk_money_simple/payment/PID или программно
- страница управления платежами admin/config/rbk_money_simple/payments
- автоматическая обработка оповещений RBK Money и зачисление платежей
- возможность подписывания формы запроса платежа контрольным хешем
- шаблоны страниц успешной и неуспешной оплаты
- страница настроек модуля admin/config/rbk_money_simple/settings


Установка
---------

- копируем папку с модулем в каталог sites/all/modules, включаем его на
странице /admin/build/modules, раздел Payments
- в настройках разрешений ролей admin/people/permissions отмечаем нужные
разрешения для модуля.


Настройка
---------

- настройка модуля осуществляется по адресу admin/config/rbk_money_simple/settings
- копируем url из поля "URL оповещения о платеже" и вставляем его в поле
"Оповещение о платеже" в личном кабинете RBK Money в настройках магазина
- прописываем ID сайта (берем из личного кабинета)
- указываем в настройках магазина в личном кабинете RBK Money cекретный ключ
и прописываем его же в поле "Секретный ключ", выбираем кодировку "UTF-8".


Создание платежа
----------------

Создать платеж можно двумя способами:
- на странице rbk_money_simple/payment. В этом случае платеж создается
с одним обязательным параметром суммы платежа и опциональным - описание платежа.

- с помощью функции rbk_money_simple_payment_save($params), принимающей массив
с параметрами платежа, например:

	$params['amount'] = 10; // сумма платежа, обязательный параметр
	$params['description'] = 'Описание услуги'; // описание платежа
	$params['uid'] = 12; // ID пользователя, для которого создается платеж
	$params['user_email'] = user@example.com // емейл пользователя
	$params['preference'] = 'banckard'; // предпочитаемый способ оплаты

и прочими параметрами формы запроса платежа, описанными в RBK Money API.
Функция возвращает ID созданного платежа.


Форма оплаты платежа
--------------------------

Форму оплаты платежа можно получить, если:
- перейти на страницу rbk_money_simple/payment/PID, где PID - ID платежа.

- вызвать ее программно:
print render(drupal_get_form('rbk_money_simple_form_render', $payment, $silent));

где $payment - ID платежа, или массив с параметрами платежа
$silent - флаг, позволяющий скрывать детали платежа и выводить только кнопку
оплаты, по умолчанию false.


Программное получение информации о платеже
------------------------------------------

Загрузка платежа осуществляется через вызов rbk_money_simple_payment_load($pid),
 где $pid - ID платежа.

$payment = rbk_money_simple_payment_load($pid);

В результате будет получен массив с деталями платежа:

    $payment['pid'] => 123;
    $payment['amount'] => 100;
    $payment['description'] => test payment;
    $payment['status'] => 5;
    // статус платежа. (0 - в ожидании, 3 - в обработке, 5 - успешно зачислен)
    $payment['advanced']['language'] => en;
    $payment['advanced']['user_email'] => user@example.com;

В элементе массива $payment['advanced'] содержатся дополнительные
пользовательские параметры, если они были использованы при создании платежа.


Программное зачисление платежа
------------------------------

Осуществляется с помощью функции rbk_money_simple_payment_enroll($pid),
где $pid - ID платежа.


Программное удаление платежа
----------------------------

Осуществляется с помощью функции rbk_money_simple_payment_enroll($pid),
где $pid - ID платежа.