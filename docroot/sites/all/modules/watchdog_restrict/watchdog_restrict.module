<?php
function watchdog_restrict_module_implements_alter(&$implementations, $hook) {
    if ($hook === 'watchdog') {
        unset($implementations['watchdog_restrict']);
        cache_set('watchdog_queue',$implementations,'cache_bootstrap',CACHE_PERMANENT);
        $implementations=array('watchdog_restrict' => "");
    }
}

function watchdog_restrict_watchdog(array $log_entry) {
    if ($log_entry["severity"] <= variable_get('watchdog_min_level', WATCHDOG_DEBUG)) {
        $cache = cache_get('watchdog_queue','cache_bootstrap');
        if ($cache) {
            $implementations = $cache->data;
            foreach ($implementations as $module => $dummy) {
                module_invoke($module, 'watchdog', $log_entry);
            }
        }
    }

}

function watchdog_restrict_form_system_logging_settings_alter(&$form, &$form_state) {
    $form1['watchdog_min_level'] = array(
            '#type'          => 'select',
            '#title'         => t('Minimal severity logging'),
            '#options'       => watchdog_severity_levels(),
            '#default_value' => variable_get('watchdog_min_level', WATCHDOG_DEBUG),
            '#description'   => t('Select minimal severity to log. All messages with a severity lower than selected will not be sent to watchdog'),
    );
    $index = array_search('error_level', array_keys($form));
    if ($index === FALSE) {
        $index = count($form); // insert @ end of array if $key not found
    } else {
         $index ++;
    }
    $end = array_splice($form, $index);
    $form = array_merge($form, $form1, $end);
    
}