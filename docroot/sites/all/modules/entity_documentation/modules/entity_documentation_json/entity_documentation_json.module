<?php

/**
 * @file
 * Main file for Entity Documentation JSON module.
 */

/**
 * Implements hook_ed_exporter().
 */
function entity_documentation_json_ed_exporter($exporters) {

  $exporters['json'] = array(
    'name' => 'JSON',
  );

  return $exporters;
}

/**
 * Implements hook_ed_documentation_export().
 */
function entity_documentation_json_ed_documentation_export($exporter, $entity, $bundle) {

  if ($exporter == 'json') {

    $json = _entity_documentation_json_get($entity, $bundle);

    // Tell the browser that this is not an HTML file to show, but a json file to
    // download.
    header('Content-Type: application/json');
    header('Content-Length: ' . strlen($json));
    header('Content-Disposition: attachment; filename="' . $entity . '-' . $bundle . '.json"');

    print $json;

    return NULL;
  }
}

/**
 * Implements hook_ed_documentation_file_export().
 */
function entity_documentation_json_ed_documentation_file_export($exporter, $entity, $bundle, $file) {
  if ($exporter == 'json') {
    $json = _entity_documentation_json_get($entity, $bundle);
    file_unmanaged_save_data($json, $file, FILE_EXISTS_REPLACE);
  }
}

/**
 * Get JSON string.
 *
 * @return string
 *   JSON string.
 */
function _entity_documentation_json_get($entity, $bundle) {
  // Get documentation array.
  module_load_include('inc', 'entity_documentation', 'includes/entity_documentation.functions');
  $documentation_array = ed_bundle_array($entity, $bundle);

  return json_encode($documentation_array[$entity][$bundle]);
}
