<?php

/**
 * @file
 * Creates Drupal blocks to render ZeitConnect widgets on the site.
 */

/**
 * Implements hook_menu().
 */
function zeitconnect_menu() {
  $items['admin/config/media/zeitconnect'] = array(
    'title' => 'ZeitConnect',
    'description' => 'Creates Drupal blocks to render ZeitConnect widgets on the site.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('zeitconnect_admin_settings_form'),
    'access arguments' => array('administer zeitconnect'),
    'file' => 'zeitconnect.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_help().
 */
function zeitconnect_help($path, $arg) {
  switch ($path) {
    case 'admin/config/media/zeitconnect':
      return t('!url is a service for rendering widgets based on data pulled from a customers Mindbody Online account.', array('!url' => l(t('ZeitConnect'), 'http://www.zeitconnect.com')));
  }
}

/**
 * Implements hook_permission().
 */
function zeitconnect_permission() {
  return array(
    'administer zeitconnect' => array(
      'title' => t('Administer ZeitConnect'),
      'description' => t('Perform maintenance tasks for ZeitConnect.'),
    ),
  );
}

/**
 * Implements hook_block_info().
 *
 * This hook declares what blocks are provided by the module.
 */
function zeitconnect_block_info() {
  $blocks = array();
  $query = db_select('zeitconnect', 'zc')
    ->fields('zc', array('wkey', 'name'));
  $widgets = $query->execute();
  foreach ($widgets as $widget) {
    $blocks[$widget->wkey] = array(
      'info' => $widget->name,
      'cache' => DRUPAL_CACHE_PER_ROLE,
    );
  }
  return $blocks;
}

/**
 * Implements hook_block_view().
 *
 * This hook generates the contents of the blocks themselves.
 */
function zeitconnect_block_view($delta = '') {
  $block = array();
  $query = db_select('zeitconnect', 'zc')
    ->fields('zc', array('wkey'))
    ->condition('wkey', $delta)
    ->execute();
  $widget = $query->fetchObject();
  if (isset($widget->wkey) > 0) {
    $block['subject'] = '';
    $block['content'] = '<script type="text/javascript" src="http://www.zeitconnect.com/run/' . $widget->wkey . '.js"></script>';
  }
  return $block;
}
