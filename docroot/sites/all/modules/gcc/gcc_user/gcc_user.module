<?php

/**
 * @file
 * Groupe user module.
 */

/**
 * Implements hook_entity_info_alter().
 */
function gcc_user_entity_info_alter(&$entity_info) {

  $entity_info['user']['gcc'] = array(

    'path' => 'user/%user',
    'entity position' => 1,
    'group' => TRUE,
    'group content' => FALSE,
  );
}

/* GCC Core Implementation */

/**
 * Implements hook_gcc_entity_info().
 */
function gcc_user_gcc_entity_info() {

  $entity_types = array();

  $entity_types['user'] = array(

    'path' => 'user/%user',
    'entity position' => 1,
    'group' => TRUE,
    'group content' => FALSE,
  );

  return $entity_types;
}

/**
 * Implements hook_gcc_entity_features().
 */
function gcc_user_gcc_entity_features($entity_type, $bundle) {

  $features = array();

  if ($entity_type == 'user') {

    $features['group'] = array(

      'description' => t('When enabled, %entity_type : %bundle can be used as group.', array('%entity_type' => $entity_type, '%bundle' => $bundle)),
    );

    $features['membership_type'] = array(

      'description' => t('When enabled, group of type %entity_type : %bundle can choose what set of membership informations to use for their new member.', array('%entity_type' => $entity_type, '%bundle' => $bundle)),
    );

    $features['theme'] = array(

      'description' => t('When enabled, entity of type %entity_type : %bundle can choose a custom theme to display their pages.', array('%entity_type' => $entity_type, '%bundle' => $bundle)),
    );

    $features['menu'] = array(

      'description' => t('When enabled, entity of type %entity_type : %bundle can create menu.', array('%entity_type' => $entity_type, '%bundle' => $bundle)),
    );

    $features['contextual_block'] = array(

      'description' => t('When enabled, entity of type %entity_type : %bundle can configure the block layout.', array('%entity_type' => $entity_type, '%bundle' => $bundle)),
    );

    $features['domain'] = array(

      'description' => t('When enabled, %entity_type : %bundle can choose a custom domain.', array('%entity_type' => $entity_type, '%bundle' => $bundle)),
    );
  }

  return $features;
}

/* GCC Context Implementation */

/**
 * Implements hook_gcc_context_entity_detector().
 */
function gcc_user_gcc_context_entity_detector() {

  $detectors = array();

  $detectors['user'] = array(

    'title' => t('User'),
    'description' => t('Allow to detecte user entity.'),
    'callback' => 'gcc_user_gcc_context_user_detector',
  );

  return $detectors;
}

/**
 * Entity detector for nodes.
 */
function gcc_user_gcc_context_user_detector($menu_item) {

  $path = substr($menu_item['path'], 0, strlen('user/%'));

  if ($path == 'user/%') {

    $user = user_load($menu_item['original_map'][1]);
    if ($user) {
      return array(

        'entity_type' => 'user',
        'entity' => $user,
      );
    }
  }
}
