<?php

/**
 * @file
 * Used to allow site admin to know the mood of a user who created the node.
 */

/**
 * Implements hook_help().
 */
function cmood_help($path, $arg) {
  $output = '';
  switch ($path) {
    case 'admin/help#cmood':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('This module allows site admin to know about the mood of the user who post the content in the site. Node moods can be detected by the help of this module. For every node created, this module calculates a mood for the particular node and stores it or updates it.') . '</p>';
      $output .= '<p>' . t('Site admin must add mood words for which he wants the mood of content can be calculated. He must also add rank words for increasing the mode by rank number of times.') . '</p>';
      $output .= '<p>' . t('Site admin can <a href="@manage-mood-words">Manage mood words</a>. Site admin can <a href="@manage-rank-words">Manage rank words</a>.', array('@manage-mood-words' => url('admin/cmood/mood_word'), '@manage-rank-words' => url('admin/cmood/rank_word'))) . '</p>';
      $output .= '<p>' . t('Site admin can <a href="@choose-content-type">Choose content type</a> for calculation of mood and <a href="@view-node-moods">View node moods</a>.', array('@view-node-moods' => url('admin/cmood'), '@choose-content-type' => url('admin/cmood/settings'))) . '</p>';
      $output .= '<h3>' . t('Ussage example') . '</h3>';
      $output .= '<p>' . t('If site admin adds a mood word "good" with a weigth of +2 and a rank word "very" with weight of +3, Then if a node title or body contains a word or phrase with "very good" then a mood is calculated which equals to 6 (3 * 2 = 6). If the title and body contains only word "good" then a mood will be calculated which equals to 2. Sample: If a user creates a node which contains a text of "Hi, I am a very good boy. And I have a good smile.", then taking into the above word and rank weights the mood is calculated which equals to (3 * 2) + 2 = 8.') . '</p>';
      return $output;
  }
}

/**
 * Implements hook_permission().
 */
function cmood_permission() {
  return array(
    'administer cmood' => array(
      'title' => t('Administer cmood'),
      'description' => t('Perform administration tasks for cmood.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function cmood_menu() {
  $items['admin/cmood'] = array(
    'title' => 'Cmood',
    'description' => 'Shows list of nodes with mood values.',
    'page callback' => 'cmood_node_mood_listing',
    'access arguments' => array('administer cmood'),
    'file' => 'cmood.admin.inc',
  );
  $items['admin/cmood/nodes'] = array(
    'title' => 'Cmood node listing',
    'description' => 'Shows list of nodes with mood values.',
    'page callback' => 'cmood_node_mood_listing',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => 0,
  );
  $items['admin/cmood/mood_word'] = array(
    'title' => 'Mannage mood words',
    'description' => 'Manage Content mood.',
    'page callback' => 'cmood_admin',
    'page arguments' => array('list'),
    'access arguments' => array('administer cmood'),
    'type' => MENU_LOCAL_TASK,
    'weight' => 1,
    'file' => 'cmood.admin.inc',
  );
  $items['admin/cmood/mood_word/add'] = array(
    'title' => 'Add Mood Word',
    'description' => 'Add cmood word with weight.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('cmood_form'),
    'access arguments' => array('administer cmood'),
    'type' => MENU_LOCAL_ACTION,
    'file' => 'cmood.admin.inc',
  );
  $items['admin/cmood/mood_word/%/edit'] = array(
    'title' => 'Edit Cmood Word',
    'description' => 'Edit cmood word with weight.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('cmood_form', 3, 4),
    'access arguments' => array('administer cmood'),
    'file' => 'cmood.admin.inc',
  );
  $items['admin/cmood/mood_word/%/delete'] = array(
    'title' => 'Delete Cmood Word',
    'description' => 'Delete cmood word with weight.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('cmood_word_delete_confirm', 3),
    'access arguments' => array('administer cmood'),
    'file' => 'cmood.admin.inc',
  );
  $items['admin/cmood/rank_word'] = array(
    'title' => 'Manage Rank Words',
    'description' => 'Ranks Word.',
    'page callback' => 'cmood_rank_words',
    'access arguments' => array('administer cmood'),
    'type' => MENU_LOCAL_TASK,
    'weight' => 1,
    'file' => 'cmood.admin.inc',
  );
  $items['admin/cmood/rank_word/add'] = array(
    'title' => 'Add Rank Word',
    'description' => 'Add cmood word with weight.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('cmood_rank_word_form'),
    'access arguments' => array('administer cmood'),
    'type' => MENU_LOCAL_ACTION,
    'file' => 'cmood.admin.inc',
  );
  $items['admin/cmood/rank_word/%/edit'] = array(
    'title' => 'Edit Cmood Word',
    'description' => 'Edit cmood word with weight.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('cmood_rank_word_form', 3, 4),
    'access arguments' => array('administer cmood'),
    'file' => 'cmood.admin.inc',
  );
  $items['admin/cmood/rank_word/%/delete'] = array(
    'title' => 'Delete Cmood Word',
    'description' => 'Delete cmood word with weight.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('cmood_rank_word_delete_confirm', 3),
    'access arguments' => array('administer cmood'),
    'file' => 'cmood.admin.inc',
  );
  $items['admin/cmood/settings'] = array(
    'title' => 'Cmood Settings',
    'description' => 'Choose content types for calculating mood.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('cmood_settings_form'),
    'access arguments' => array('administer cmood'),
    'type' => MENU_LOCAL_ACTION,
    'file' => 'cmood.admin.inc',
  );
  return $items;
}

/**
 * Function to delete mood word.
 *
 * @param int $wid
 *   Word id to be deleted.
 */
function cmood_word_delete($wid) {
  db_delete('word_with_weight')
    ->condition('wid', $wid)
    ->execute();
}

/**
 * Function to delete rank word.
 *
 * @param int $rwid
 *   Rank word id to be deleted.
 */
function cmood_rank_word_delete($rwid) {
  db_delete('rank_word_with_weight')
    ->condition('rwid', $rwid)
    ->execute();
}

/**
 * Implements hook_node_presave().
 *
 * Here we update node_mood table to store mood of nodes.
 * Mood is calculated considering title and body of nodes.
 */
function cmood_node_presave($node) {
  $sdefault_type_options = variable_get('cmood_settings', '');
  if ($sdefault_type_options == '') {
    $default_type_options = array('all');
  }
  else {
    $default_type_options = unserialize($sdefault_type_options);
  }
  if ($default_type_options['all'] === 'all'
    || $default_type_options[$node->type] === $node->type) {
    // Calculate mood for only content types chosen in the
    // cmood settings form.
    $string_to_calculate_mood = cmood_get_string_from_node($node);
    $mood = cmood_calculate($string_to_calculate_mood);
    // Update mood.
    if (isset($node->nid)) {
      db_merge('node_mood')
        ->key(array('nid' => $node->nid))
        ->fields(array(
          'mood' => $mood,
        ))
        ->execute();
    }
  }
}

/**
 * Implements hook_node_insert().
 *
 * Here we insert node_mood table to store mood of nodes.
 * Mood is calculated considering title and body of nodes.
 */
function cmood_node_insert($node) {
  $sdefault_type_options = variable_get('cmood_settings', '');
  if ($sdefault_type_options == '') {
    $default_type_options = array('all');
  }
  else {
    $default_type_options = unserialize($sdefault_type_options);
  }
  if ($default_type_options['all'] === 'all'
    || $default_type_options[$node->type] === $node->type) {
    // Calculate mood for only content types chosen in the cmood
    // settings form.
    $string_to_calculate_mood = cmood_get_string_from_node($node);
    $mood = cmood_calculate($string_to_calculate_mood);
    // Insert mood.
    db_insert('node_mood')
      ->fields(array(
        'nid' => $node->nid,
        'mood' => $mood,
      ))
      ->execute();
  }
}

/**
 * Implements hook_node_delete().
 *
 * Here we delete node mood of nodes.
 */
function cmood_node_delete($node) {
  db_delete('node_mood')->condition('nid', $node->nid)->execute();
}

/**
 * Function to calculate the mood of nodes.
 *
 * @param string $scalc_mood
 *   String whose mood needs to be determined and can be any length long.
 *
 * @return int $mood
 *   This variable contains the mood calculated for the string passed.
 */
function cmood_calculate($scalc_mood = NULL) {
  $mood = 0;
  $sentances = array();
  $matches = array();
  $trank = array();
  $acmood_words = db_select('word_with_weight', 'www')
    ->fields('www', array('wid', 'name', 'weight'))
    ->execute()->fetchAll();
  // Splitting text into sentances by splitting text by ".", "!"
  // and "?" so that we can match mood words precede by rank words.
  preg_match_all('([^\.\!\?]+[\.\?\!]*)', $scalc_mood, $sentances);
  $asentances = $sentances[0];
  $arank_multiplier = db_select('rank_word_with_weight', 'rwww')
    ->fields('rwww', array('rwid', 'name', 'weight'))
    ->execute()->fetchAll();
  foreach ($asentances as $svalue) {
    foreach ($acmood_words as $wvalue) {
      $word_pattern = '/\b' . $wvalue->name . '\b/';
      // Checking if the sentance has any mood words in it if yes then simply
      // add mood weight value and then check for rank words,
      // if no then skip to next mood word.
      $cword_mood = preg_match_all($word_pattern, $svalue, $matches);
      unset($matches);
      if ($cword_mood > 0) {
        $mood += $wvalue->weight;
        foreach ($arank_multiplier as $var) {
          $multi_pattern = '/\b' . $var->name . " " . $wvalue->name . '\b/';
          // Checking if the mood word precede by rank word exists in the
          // sentance if yes then subtract the mood weight added earlier
          // and add mood weight which equals to product of rank word weight
          // and mood word weight and number of occurrences.
          $phrase_mood = preg_match_all($multi_pattern, $svalue, $trank);
          unset($trank);
          if ($phrase_mood > 0) {
            $mood -= $wvalue->weight;
            $mood += ($phrase_mood * ($wvalue->weight * $var->weight));
          }
        }
      }
      else {
        // This word not found in this sentance.
      }
    }
  }
  return $mood;
}

/**
 * Function to return string to calculate the mood of node.
 *
 * @param object $node
 *   Complete node object to fetch the string to calculate the mood.
 *
 * @return string $string_to_calculate_mood
 *   This variable contains the concatinated value of title and body strings
 */
function cmood_get_string_from_node($node) {
  if (isset($node->body[LANGUAGE_NONE][0]['value'])) {
    $string_to_calculate_mood = $node->title . '. '
    . $node->body[LANGUAGE_NONE][0]['value'];
  }
  elseif (isset($node->body[$node->language][0]['value'])) {
    $string_to_calculate_mood = $node->title . '. '
    . $node->body[$node->language][0]['value'];
  }
  else {
    $string_to_calculate_mood = $node->title . '.';
  }
  return $string_to_calculate_mood;
}

/**
 * Function to return array of weights for add / edit forms.
 *
 * @return array $weight
 *   This variable contains array of values -20 to 20
 */
function cmood_get_weights() {
  $weight = array();
  for ($i = -20; $i <= 20; $i++) {
    $weight[$i] = $i;
  }
  return $weight;
}

/**
 * Implements hook_views_api().
 */
function cmood_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'cmood'),
  );
}
