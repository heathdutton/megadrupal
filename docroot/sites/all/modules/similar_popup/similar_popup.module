<?php

/**
 * @file
 * Primarily Drupal hooks.
 *
 * This is the main module file for Similar Entries Popup.
 */

/**
 * Implements hook_page_menu().
 */
function similar_popup_menu() {
  $items = array();

  $items['admin/config/user-interface/similar-popup'] = array(
    'title' => 'Similar Entries Popup',
    'description' => 'Administer Similar Entries Popup settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('similar_popup_settings'),
    'access arguments' => array('access similar popup settings'),
    'file' => 'similar_popup.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function similar_popup_permission() {
  return array(
    'access similar popup settings' => array(
      'title' => t('Access Similar Entries Popup settings'),
      'description' => t('Access Similar Entries Popup settings.'),
      'restrict access' => TRUE,
    ),
  );
}

/**
 * Implements hook_views_api().
 */
function similar_popup_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'similar_popup') . '/views',
  );
}

/**
 * Implements hook_theme().
 */
function similar_popup_theme() {
  return array(
    'similar_popup' => array(
      'variables' => array('title' => NULL, 'view' => NULL),
      'template' => 'templates/similar-popup',
    ),
    'similar_popup_sound_notification' => array(
      'variables' => array(),
      'file' => 'similar_popup.theme.inc',
    ),
  );
}

/**
 * Implements hook_page_build().
 */
function similar_popup_page_build(&$page) {
  // Performance: Skip this entirely for AJAX requests.
  if (strpos($_GET['q'], 'js/') === 0) {
    return;
  }

  if (arg(0) == 'node' && is_numeric(arg(1)) && arg(2) == NULL) {
    $view_data = similar_popup_embed_view();
    $page['page_bottom']['similar_popup'] = array(
      '#theme' => 'similar_popup',
      '#title' => $view_data['title'],
      '#view' => $view_data['view'],
    );
  }
}

/**
 * Preprocess variables for similar-popup.tpl.php
 */
function template_preprocess_similar_popup(&$variables) {
  drupal_add_css(drupal_get_path('module', 'similar_popup') . '/css/similar-popup.css');
  drupal_add_js(drupal_get_path('module', 'similar_popup') . '/js/similar-popup.js', array('scope' => 'footer'));
  $variables['classes_array'][] = drupal_html_class(variable_get('similar_popup_position', 'top_left'));

  if (variable_get('similar_popup_sound_notification', FALSE)) {
    $sound_notification = array('#theme' => 'similar_popup_sound_notification');
    $variables['sound_notification'] = render($sound_notification);
  }
}

/**
 * Renders a View for display in some other element.
 *
 * @return array
 *   An array contains a view title and rendered output of the chosen View display.
 */
function similar_popup_embed_view() {
  // Load the specified View.
  $view = views_get_view('similar_popup');
  $view->set_display('master');

  // Prepare and execute the View query.
  $view->pre_execute();
  $view->execute();

  // Return the view title and rendered View.
  return array('title' => $view->get_title(), 'view' => $view->render());
}
