<?php

/**
 * Implements hook_user_view().
 * Adds the qwerly profile list to the user profile page.
 */
function qwerly_profile_user_view($account, $view_mode, $langcode) {
  if (!isset($account->qwerly) || $account->qwerly === false) {
    $account->qwerly = module_invoke('qwerly', 'get_user_data', $account->uid, false);
  }

  $accounts = array();
  if (is_object($account->qwerly) && isset($account->qwerly->services) && count($account->qwerly->services)) {
    $accounts = $account->qwerly->services;
  }

  if (count($accounts) > 0) {
    $accounts = theme('qwerly', array('services' => $accounts));

    $account->content['qwerly'] = array(
      '#type' => 'user_profile_category',
      '#title' => t('Social Accounts'),
      '#children' => $accounts,
      '#attributes' => array(
        'class' => array(
          'qwerly',
        ),
      ),
    );
  }
}

/**
 * Implements hook_theme().
 */
function qwerly_profile_theme() {
  return array(
    'qwerly' => array(
      'variables' => array('title' => NULL, 'services' => NULL),
    ),
  );
}

/**
 * Base theme function for the "qwerly" type.
 */
function theme_qwerly($parameters) {
  $services = $parameters['services'];

  $output = '<dl class="qwerly-profiles">';
  foreach ($services as $service) {
    $output .= '<dt>' . ucwords($service->type) . '</dt><dd>' . l($service->username, $service->url) . '</dd>';
  }
  $output .= '</dl>';

  return $output;
}
