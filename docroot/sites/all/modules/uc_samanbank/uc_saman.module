<?php

/**
 * 
 */
function uc_saman_load_dependenies() {      
  @include('saman.class.inc');
  if (!class_exists('soapclient') and !file_exists('nusoap.php')) {
    drupal_set_message(t('NuSoap was not found.'));
  }
  elseif (file_exists('nusoap.php')) {
    @include('nusoap.php');
  }
}

/**
 * Implements hook_menu()
 */
function uc_saman_menu() {
  $items = array();

  $items['cart/saman/complete'] = array(
    'title' => 'Order complete',
    'page callback' => 'uc_saman_complete_page',
    'access callback' => 'uc_saman_completion_access',
    'type' => MENU_CALLBACK,
  );
  
  return $items;
}

/**
 * 
 */
function uc_saman_completion_access() {
  return TRUE;
}

/**
 * Implements hook_init()
 */
function uc_saman_init() {
  global $conf;
  $conf['i18n_variables'][] = 'uc_saman_website_language';
  
  //Load SMAN API and NuSoap
  uc_saman_load_dependenies();
}

/**
 * Menu callback for cart/saman/complete
 */
function uc_saman_complete_page($cart_id = 0) {
  $MerchantID = variable_get('uc_saman_MerchantID', '');
  $Password = variable_get('uc_saman_password', '');
  $output = '';
  
  $sb = new SBPayment($MerchantID, $Password);
  $State  = isset($_POST['State']) ? $_POST['State'] : '';
  $RefNum = isset($_POST['RefNum']) ? $_POST['RefNum'] : '';
  $ResNum = isset($_POST['ResNum']) ? $_POST['ResNum'] : '';
  
  if ($sb->receiverParams($ResNum, $RefNum, $State)) {
    //$dnumber = db_result(db_query("SELECT id FROM {uc_payment_saman} WHERE res_num = '%s'" , $ResNum ) );
    $dnumber_arr = db_select('uc_payment_saman', 'ps')
      ->fields('ps', array('id'))
      ->condition('res_num', $ResNum)
      ->execute()
      ->fetchCol();
    $dnumber = $dnumber_arr[0];
    
    $order = uc_order_load($dnumber);
    
    //$order->order_status = 'payment_received';//'completed';//
    uc_payment_enter($order->order_id, $order->payment_method, $order->order_total, 0, NULL, 'Paid Successfully'); 
    //uc_cart_empty( $cart_id);
    //uc_order_save( $order);
    $output = uc_cart_complete_sale($order, variable_get('uc_new_customer_login', FALSE));
    $page = variable_get('uc_cart_checkout_complete_page', '');
    if (!empty($page)) {
      drupal_goto($page);
    }
  }
  
  
  //dpm($sb->getMsg('display'));
  //dpm($output);
  
  return $sb->getMsg('display') . drupal_render($output);
}

/**
 * Implements hook_uc_payment_method().
 */
function uc_saman_uc_payment_method() {
  $path = drupal_get_path('module', 'uc_saman') . "/Saman.gif";
  
  //$title = theme_image($path , t("Saman Bank") , t("Saman Bank") , array('style' => 'margin-bottom: -5px;position: relative;top: 2px;'));
  $title = theme('image', array(
    'path' => $path,
    'alt' => t('Saman Bank'),
    'title' => t('Saman Bank'),
    'attributes' => array(
      'style' => 'margin-bottom: -5px; position: relative; top: 2px;',
    ),
  ));  
  
  $title .= t('Saman Bank');
  
  $methods = array();
  $methods['saman'] = array(
    'name'     => t('Saman Bank'),
    'title'    => $title,
    'desc'     => t('Redirect to Saman Bank to pay by credit card.'),
    'callback' => 'uc_payment_method_saman',
    'weight'   => 1,
    'checkout' => TRUE,
    'redirect' => 'uc_saman_form',
  );
  
  return $methods;
}

/**
 * Payment method callback
 */
function uc_payment_method_saman($op, &$order, $form = NULL, &$form_state = NULL) {
  switch ($op) {
    case 'cart-process':
      $_SESSION['pay_method'] = 'saman'; //$_POST['pay_method'];
      return;

    case 'settings':
      $form['uc_saman_MerchantID'] = array(
        '#type'          => 'textfield',
        '#title'         => t('MerchantID'),
        '#description'   => t('Your SamanBank account merchantID.'),
        '#default_value' => variable_get('uc_saman_MerchantID', ''),
        '#size'          => 16,
      );
      
      $form['uc_saman_password'] = array(
        '#type'          => 'textfield',
        '#title'         => t('Your secret password'),
        '#default_value' => variable_get('uc_saman_password', ''),
        '#size'          => 16,
      );
      
      $form['uc_saman_website_language'] = array(
        '#type'          => 'radios',
        '#title'         => t('Saman bank website language'),
        '#default_value' => 'Fa',
        '#options'       => array(
          'Fa' => t('Farsi'),
          'En' => t('English')
        ),
      );
      
      $form['uc_saman_app'] = array(
        '#type'        => 'fieldset',
        '#title'       => t('Saman Bank Appearance'),
        '#weight'      => 10,
        '#collapsible' => TRUE,
        '#collapsed'   => TRUE,
      );
      
      $form['uc_saman_app']['saman_bank_TableBorderColor'] = array(
        '#type'          => 'textfield',
        '#title'         => t('Color of tables border'),
        '#default_value' => variable_get('saman_bank_TableBorderColor', ''),
        '#size'          => 9,
      );
      
      $form['uc_saman_app']['saman_bank_TableBGColor'] = array(
        '#type'          => 'textfield',
        '#title'         => t('Color of tables background'),
        '#default_value' => variable_get('saman_bank_TableBGColor', ''),
        '#size'          => 9,
      );
      
      $form['uc_saman_app']['saman_bank_PageBGColor'] = array(
        '#type'          => 'textfield',
        '#title'         => t('Color of page background'),
        '#default_value' => variable_get('saman_bank_PageBGColor', ''),
        '#size'          => 9,
      );
      
      $form['uc_saman_app']['saman_bank_PageBorderColor'] = array(
        '#type'          => 'textfield',
        '#title'         => t('Color of page border'),
        '#default_value' => variable_get('saman_bank_PageBorderColor', ''),
        '#size'          => 9,
      );
      
      $form['uc_saman_app']['saman_bank_TitleFont'] = array(
        '#type'          => 'textfield',
        '#title'         => t('Title font'),
        '#default_value' => variable_get('saman_bank_TitleFont', ''),
        '#size'          => 9,
      );
      
      $form['uc_saman_app']['saman_bank_TitleColor'] = array(
        '#type'          => 'textfield',
        '#title'         => t('Color of title'),
        '#default_value' => variable_get('saman_bank_TitleColor', ''),
        '#size'          => 9,
      );
      
      $form['uc_saman_app']['saman_bank_TitleSize'] = array(
        '#type'          => 'textfield',
        '#title'         => t('Size Of title'),
        '#default_value' => variable_get('saman_bank_TitleSize', ''),
        '#size'          => 9,
      );
      
      $form['uc_saman_app']['saman_bank_TextFont'] = array(
        '#type'          => 'textfield',
        '#title'         => t('Text Font'),
        '#default_value' => variable_get('saman_bank_TextFont', ''),
        '#size'          => 9,
      );
      
      $form['uc_saman_app']['saman_bank_TextColor'] = array(
        '#type'          => 'textfield',
        '#title'         => t('Text color'),
        '#default_value' => variable_get('saman_bank_TextColor', ''),
        '#size'          => 9,
      );
      
      $form['uc_saman_app']['saman_bank_TextSize'] = array(
        '#type'          => 'textfield',
        '#title'         => t('Text size'),
        '#default_value' => variable_get('saman_bank_TextSize', ''),
        '#size'          => 9,
      );
      
      $form['uc_saman_app']['saman_bank_TypeTextColor'] = array(
        '#type'          => 'textfield',
        '#title'         => t('Type text color'),
        '#default_value' => variable_get('saman_bank_TypeTextColor', ''),
        '#size'          => 9,
      );
      
      $form['uc_saman_app']['saman_bank_TypeTextSize'] = array(
        '#type'          => 'textfield',
        '#title'         => t('Type text size'),
        '#default_value' => variable_get('saman_bank_TypeTextSize', ''),
        '#size'          => 9,
      );
      
      $form['uc_saman_app']['saman_bank_LogoURI'] = array(
        '#type'          => 'textfield',
        '#title'         => t('Logo URI'),
        '#default_value' => variable_get('saman_bank_LogoURI', ''),
        '#size'          => 30,
      );
      
      return $form;
  }
}

/**
 * Form Builder.
 * 
 * The payment form which will be submitted to the bank e-gateway.
 */
function uc_saman_form($form_state, $order) {
  $MerchantID = variable_get('uc_saman_MerchantID', '');
  $Password = variable_get('uc_saman_password', '');
  
  $sb = new SBPayment($MerchantID, $Password);
  
  $context = array(
    'revision' => 'formatted-original',
    'type'     => 'order_total',
    'subject'  => array(
      'order'  => $order,
    ),
  );
  
  $options = array(
    'sign' => FALSE,
    'dec'  => '.',
    'thou' => FALSE,
  );
  
  //if ($sb->saveStoreInfo(uc_price($order->order_total, $context, $options), $order->order_id)) {
  //dpm($order);
  //dpm("if (\$sb->saveStoreInfo({$order['build_info']['args'][0]->order_total}, {$order['build_info']['args'][0]->order_id})) {");
  
  //TODO: Bug: Inserts duplicate records and fails.
  if ($sb->saveStoreInfo($order['build_info']['args'][0]->order_total, $order['build_info']['args'][0]->order_id)) {
    $data = $sb->sendParams();
  }
  
  //dpm(var_dump($data));
  
//  $form['#action'] = 'https://acquirer.samanepay.com/payment.aspx';
  $form['#action'] = 'https://sep.shaparak.ir/Payment.aspx'; 
  foreach ($data as $name => $value) {
    $form[$name] = array(
      '#type' => 'hidden',
      '#value' => $value
    );
  }
  
  $form['submit'] = array(
    '#type'  => 'submit',
    '#value' => t('Submit Order')
  );
  
  return $form;
}

/**
 * Implements hook_form_FORM_ID_alter()
 *
function uc_saman_form_uc_cart_checkout_review_form_alter(&$form, &$form_state, $form_id) {
  $order_id = intval($_SESSION['cart_order']);
  
  if ($order_id > 0) {
    $order = uc_order_load($order_id);
    if ($order->payment_method == 'saman') {
      unset( $form['submit']);
      $form['#prefix'] = '<table id="two-checkout-review-table"><tr><td>';
      $form['#suffix'] = '</td><td>'. drupal_get_form('uc_saman_form', $order) .'</td></tr></table>';
    }
  }
}
*/
