<?php

/**
 * @file
 * Savvior module install file.
 */

/**
 * Implements hook_install().
 */
function savvior_install() {
  variable_set('savvior_use_min_js','1');
  variable_set('savvior_load_default_css','0');
}

/**
 * Implements hook_uninstall().
 */
function savvior_uninstall() {
  variable_del('savvior_use_min_js');
  variable_del('savvior_load_default_css');
}

/**
 * Implements hook_requirements().
 *
 * Changes its status based on ability to locate JS library.
 * Changes its instructions based on Libraries API being enabled.
 */
function savvior_requirements($phase) {
  $requirements = array();

  switch ($phase) {
    case 'runtime':

      /*
       * Test for conditions
       */

      // Test if Libraries module is being used.
      if (module_exists('libraries')) {
        $savvior_path = libraries_get_path('savvior');
        $enquire_path = libraries_get_path('enquire.js');
        $using_libraries = TRUE;
        $savvior_version = savvior_get_version();
        $enquire_version = enquire_get_version();
      }
      else {
        $using_libraries = FALSE;
      }

      /*
       * Generate status message and severity
       */

      // Savvior / Enquire / Libraries API installed and working correctly.
      // Do the Drupal happy dance!
      if ($savvior_path && $enquire_path && $using_libraries) {
        $description = FALSE;
        $severity = REQUIREMENT_OK;
      }
      // Savvior installed, but Libraries API not installed. Still acceptable, but nudge them.
      elseif ($path && !$using_libraries) {
        $description = t('Savvior JS library is installed but you aren\'t using !libraries-api. You should use it.',
          array(
            '!libraries-api' => l(t('Libraries API'), 'http://drupal.org/project/libraries'),
          )
        );
        $severity = REQUIREMENT_WARNING;
      }
      // Savvior not installed, Libraries API is installed.
      // Supply instructions recommending Libraries module.
      elseif (!$path && module_exists('libraries')) {
        $description = t('Savvior JS library cannot be found. Download it from !savvior-site, copy it into !path and rename it to savvior.min.js.',
          array(
            '!savvior-site' => l(t('savvior.org'), 'http://savvior.org/'),
            // !path has a hardcoded default because the libraries_get_path() function might not return
            // the correct path when conditions lead to this block of code being executed
            '!path' => 'sites/all/libraries/savvior/dist',
          )
        );
        $severity = REQUIREMENT_ERROR;
      }
      // savvior not installed, Libraries API not installed.
      // Supply generic instructions
      else {
        $description = t('Savvior and Libraries API cannot be found. Download Savvior from !savvior-site, copy it into !path and rename it to savvior.min.js. You should also use the !libraries-api by installing from drupal.org.',
          array(
            '!savvior-site' => l(t('savvior.com'), 'http://savvior.org/'),
            '!path' => 'sites/all/libraries/savvior/dist',
            '!libraries-api' => l(t('Libraries API'), 'http://drupal.org/project/libraries'),
          )
        );
        $severity = REQUIREMENT_ERROR;
      }

      /*
       * Declare requirement to Drupal
       */
      $requirements[] = array(
        'title' => t('Savvior'),
        'value' => $savvior_version ? $savvior_version : t('Not installed'),
        'description' => $description,
        'severity' => $severity,
      );
      $requirements[] = array(
        'title' => t('Enquire.JS'),
        'value' => $enquire_version ? $enquire_version : t('Not installed'),
        'description' => $description,
        'severity' => $severity,
      );
      break;
  }

  return $requirements;
}

