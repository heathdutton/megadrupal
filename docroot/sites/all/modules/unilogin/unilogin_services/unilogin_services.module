<?php
/**
 * @file
 * Handles UNI•Login info SOAP requests.
 *
 * @author Mikkel Jakobsen <mikkel@adapt.dk>
 */

/**
 * The watchdog type used for common UNI•Login info entries.
 */
define('UNILOGIN_SERVICES_WD_ID', 'unilogin_services');

/**
 * The url to the UNI•Login info service.
 */
define('UNILOGIN_SERVICES_DEFSET_URL_WS_INFOTJENESTE', 'https://ws02.infotjeneste.uni-c.dk/infotjeneste-ws/ws?WSDL');

/**
 * Implements hook_menu().
 */
function unilogin_services_menu() {
  $path = drupal_get_path('module', 'unilogin');
  $items = array();

  $items['admin/config/services/unilogin-services'] = array(
    'title' => 'UNI•Login Services',
    'description' => 'Configure URLs and parameters for UNI•Login services.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('unilogin_services_configuration_form'),
    'access arguments' => array('administer site configuration'),
  );

  return $items;
}

/**
 * Retreive information from one ore more w02 web services.
 *
 * @param string $unilogin_id
 *   UNI•Login id.
 * @param mixed $services
 *   string/array. The name of one or more web services to request.
 *
 * @return object
 *   An object with response data from one or more services.
 */
function unilogin_services_w02_load($unilogin_id, $services) {
  // We want to know which service(s). Otherwise do nothing.
  if (empty($services)) {
    return FALSE;
  }
  // If services is just one entry then arrayfy it.
  if (is_string($services)) {
    $services = array($services);
  }

  // Create soap client.
  $client = unilogin_services_initialize_client(
    variable_get('unilogin_services_url_ws02_infotjeneste', '')
  );
  if (!$client) {
    return;
  }
  // Webservice credentials.
  $ws_credentials = array(
    'brugerid' => $unilogin_id,
    'wsPassword' => variable_get('unilogin_services_ws02_password', ''),
    "wsBrugerid" => variable_get('unilogin_services_ws02_brugerid', ''),
  );

  $info = new stdClass();
  $info->unilogin_id = $unilogin_id;

  foreach ($services as $service) {
    try {
      $response = $client->{$service}($ws_credentials);
      // $data = $response->return;
      $info->{$service} = $response->return;
    } catch (SoapFault $ex) {
      watchdog(
        UNILOGIN_SERVICES_WD_ID,
        '%ex',
        array('%ex' => $ex),
        WATCHDOG_ERROR
      );
    }
  }

  return $info;
}

/**
 * Create soap client object.
 *
 * @param string $webservice_url
 *   The request URL.
 *
 * @return boolean|\SoapClient
 *   Webservice client on success / FALSE on failure.
 */
function unilogin_services_initialize_client($webservice_url) {
  try {
    $client = new SoapClient($webservice_url);
  } catch (SoapFault $ex) {
    watchdog(UNILOGIN_SERVICES_WD_ID, '%ex', array('%ex' => $ex), WATCHDOG_ERROR);
    return FALSE;
  }

  return $client;
}

/**
 * Alter the unilogin configuration form with info service credentials.
 */
function unilogin_services_configuration_form($form, &$form_state) {
  $form['ws02'] = array(
    '#type' => 'fieldset',
    '#title' => t('Webservice ws-02'),
    '#description' => t(
      'Info about the Unilogin ws-02 webservice: !ws02.',
      array(
        '!ws02' => l(
          t('webservice ws-02'),
          'http://www.uni-c.dk/produkter/infrastruktur/uni-login/infotjenestenswebservice_ws02.pdf'
        ),
      )
    ),
  );
  $form['ws02']['unilogin_services_url_ws02_infotjeneste'] = array(
    '#type' => 'textfield',
    '#title' => t('Url'),
    '#description' => t('Ws02 webservice url.'),
    '#default_value' => variable_get(
      'unilogin_services_url_ws02_infotjeneste',
      UNILOGIN_SERVICES_DEFSET_URL_WS_INFOTJENESTE
    ),
    '#maxlength' => 127,
    '#required' => TRUE,
  );
  $form['ws02']['unilogin_services_ws02_brugerid'] = array(
    '#type' => 'textfield',
    '#title' => t('Username'),
    '#description' => t('Username for the ws02 webservice.'),
    '#default_value' => variable_get('unilogin_services_ws02_brugerid', ''),
    '#maxlength' => 127,
    '#required' => TRUE,
  );
  $form['ws02']['unilogin_services_ws02_password'] = array(
    '#type' => 'textfield',
    '#title' => t('Password'),
    '#description' => t('Password for the ws02 webservice.'),
    '#default_value' => variable_get('unilogin_services_ws02_password', ''),
    '#maxlength' => 127,
    '#required' => TRUE,
  );

  return system_settings_form($form);

}
