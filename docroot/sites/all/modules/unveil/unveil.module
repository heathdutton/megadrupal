<?php
/**
 * @file
 * Provides main functionality for the unveil module.
 */

/**
 * Implements hook_form_FORM_ID_alter().
 */
function unveil_form_system_performance_settings_alter(&$form, $form_state) {
  $form['bandwidth_optimization']['unveil_preprocess_image'] = array(
    '#type' => 'checkbox',
    '#title' => t('Enable Unveil.js lazyloading'),
    '#default_value' => variable_get('unveil_preprocess_image', 1),
  );

  $form['#submit'][] = 'unveil_form_system_performance_settings_alter_submit';
}

/**
 * Implements hook_menu().
 */
function unveil_menu() {
  // Simulate default task for performance tab to enable tab system.
  $items['admin/config/development/performance/default'] = array(
    'title' => 'Performance',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'file path' => drupal_get_path('module', 'system'),
    'weight' => -5,
  );

  $items['admin/config/development/performance/unveil'] = array(
    'title' => 'Unveil.js',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('unveil_settings_form'),
    'access arguments'  => array('administer site configuration'),
    'type' => MENU_LOCAL_TASK,
  );

  return $items;
}

/**
 * Settings form for unveil.js.
 */
function unveil_settings_form($form, $form_state) {
  $form['unveil_preprocess_image'] = array(
    '#type' => 'checkbox',
    '#title' => t('Enable Unveil.js lazyloading'),
    '#default_value' => variable_get('unveil_preprocess_image', 1),
  );

  $form['unveil_preprocess_image_unveiled'] = array(
    '#type' => 'textfield',
    '#title' => t('Unveiled distance'),
    '#description' => 'The distance from viewport when images are unveiled.',
    '#default_value' => variable_get('unveil_preprocess_image_unveiled', 200),
    '#required' => TRUE,
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save settings'),
  );

  return $form;
}

/**
 * Validate method for the settings form.
 * @see unveil_settings_form
 */
function unveil_settings_form_validate($form, $form_state) {
  if (!preg_match('/^([0-9]+)$/', $form_state['values']['unveil_preprocess_image_unveiled'])) {
    form_set_error('unveil_preprocess_image_unveiled', t('Unveiled distance must be numeric'));
  }
}

/**
 * Submit method for the settings form.
 * @see unveil_settings_form
 */
function unveil_settings_form_submit($form, $form_state) {
  variable_set('unveil_preprocess_image', $form_state['values']['unveil_preprocess_image']);
  variable_set('unveil_preprocess_image_unveiled', $form_state['values']['unveil_preprocess_image_unveiled']);
}
/**
 * Submit handler for setting the variable controlling if unveil is used.
 */
function unveil_form_system_performance_settings_alter_submit($form, $form_state) {
  variable_set('unveil_preprocess_image', $form_state['values']['unveil_preprocess_image']);
}

/**
 * Implements hook_preprocess_HOOK().
 */
function unveil_preprocess_image(&$vars) {
  if (variable_get('unveil_preprocess_image', 1) && empty($vars['unveil_exclude']) && !path_is_admin(current_path())) {
    $vars['theme_hook_suggestions'][] = 'unveil_image';
  }
}

/**
 * Implements hook_theme().
 */
function unveil_theme($existing, $type, $theme, $path) {
  $items['unveil_image'] = array(
    'variables' => array('vars' => NULL),
    'function' => 'theme_unveil_image',
  );
  return $items;
}

/**
 * Theme hook called to make sure images are formatted correct for unveil.js.
 *
 * On purpose we're excluding the image size, because we want to allow the
 *   theme full control over the image. Adding image size attributes to the
 *   image can interfere with responsive web design.
 */
function theme_unveil_image(&$variables) {
  unveil_add_js();

  $attributes = array('title' => $variables['title'], 'alt' => $variables['alt']);
  // Attributes.
  $attributes += $variables['attributes'];
  $attributes['src'] = file_create_url(drupal_get_path('module', 'unveil') . '/image_placeholder.gif');
  $attributes['data-src'] = file_create_url($variables['path']);

  // Add unveil class to unveil.js processed img only
  $attributes['class'] = 'unveil';

  // No script attributes.
  $noscript_attributes = $attributes;
  $noscript_attributes['src'] = file_create_url($variables['path']);
  unset($noscript_attributes['data-src']);

  // Return unveil HTML.
  $noscript = '<noscript><img' . drupal_attributes($noscript_attributes) . ' /></noscript>';
  return '<img' . drupal_attributes($attributes) . ' />' . $noscript;
}

/**
 * Add required js for unveil.js to work.
 */
function unveil_add_js() {
  $js_added = &drupal_static('unveil_js_added', FALSE);
  if (!$js_added) {
    if ($path = libraries_get_path('unveil')) {
      drupal_add_js($path . '/jquery.unveil.min.js');
      drupal_add_js(
        array(
          'Unveil' => array(
            'unveil_distance' => variable_get('unveil_preprocess_image_unveiled', 200),
          ),
        ),
        'setting'
      );
      drupal_add_js(drupal_get_path('module', 'unveil') . '/js/unveil.behavior.js');
    }

    $js_added = TRUE;
  }
}
