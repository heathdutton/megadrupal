<?php

/**
 * @file
 * TARDIS Internationalization module file.
 *
 * Alters the TARDIS query, filtering and organizing it by language.
 */

/**
 * Implements hook_form_alter().
 *
 * This function is preferred over hook_form_FORM_ID_alter() because it's
 * written once for use by both the TARDIS block and page creation forms.
 */
function tardisi18n_form_alter(&$form, &$form_state, $form_id) {
  // If the form is a TARDIS creation one - either block or page - alter it.
  if ($form_id == 'tardis_page_settings' || $form_id == 'tardis_block_settings') {

    // Which language is being used to filter nodes? Default current language or
    // another one?
    $tardisi18n_lang = $form['tardisi18n_update']['#value'];

    // TARDIS Internationalization vertical tab.
    $form['tardis_modules_tardisi18n'] = array(
      '#type' => 'fieldset',
      '#title' => t('TARDIS Internationalization'),
      '#group' => 'tardis_submodules',
    );

    // Get a list of all available languages:
    $tardisi18n_options = language_list();

    // Create an array of languages starting with the current one and undefined.
    // That allows users to see either nodes without a defined language, or
    // nodes that match the current language easily.
    $options = array(
      'cur_lang' => 'Current language',
      'und' => 'Undefined',
    );
    foreach ($tardisi18n_options as $tardisi18n_option) {
      $options[$tardisi18n_option->language] = $tardisi18n_option->name;
    }

    // Then render as a set of checkboxes.
    $form['tardis_modules_tardisi18n']['tardisi18n_lang'] = array(
      '#type' => 'checkboxes',
      '#title' => t('Languages'),
      '#description' => t('In which language(s) should the TARDIS display results?'),
      '#options' => $options,
      '#default_value' => $tardisi18n_lang,
    );
  }

  return (system_settings_form($form));
}

/**
 * This function alters the TARDIS processing, allowing multilingual queries.
 */
function _tardisi18n_join_query($query, $tardisi18n_lang) {
  // This function alters the query to change the results' language.
  // $tardisi18n_lang stores an array that may have "Current language" in it:
  // that means users want to see nodes in the same language
  // they're accessing - whichever it is.
  if ($tardisi18n_lang['cur_lang'] === 'cur_lang') {
    global $language;
    // Each option in the $tardisi18n_general_languages array is represented as
    // 'language code' => 'language code' if it's on, or 'language code' => 0
    // if it's off. We turn it on for the actual current language.
    $tardisi18n_lang[$language->language] = $language->language;
  }

  // And finally, we alter the query.
  $query->addField('n', 'language');
  $query->condition('language', $tardisi18n_lang);
}
