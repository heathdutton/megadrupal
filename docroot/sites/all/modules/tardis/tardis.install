<?php

/**
 * @file
 * Install file.
 *
 * Automatically enables the permission to access the TARDIS
 * by anonymous and authenticated users.
 */

/**
 * Implements hook_enable(). 
 *
 * Gives anonymous users access to the TARDIS. 
 */
function tardis_enable() {
  user_role_change_permissions(
    DRUPAL_ANONYMOUS_RID, array('view TARDIS page' => TRUE)
  );
  user_role_change_permissions(
    DRUPAL_AUTHENTICATED_RID, array('view TARDIS page' => TRUE)
  );
}

/**
 * Implements hook_schema().
 */
function tardis_schema() {
  $schema['tardis_blocks'] = array(
    'description' => 'Stores settings for custom TARDIS blocks.',
    'fields' => array(
      'name' => array(
        'type' => 'varchar',
        'length' => 64,
        'not null' => TRUE,
        'description' => 'A name for the TARDIS block.',
      ),
      'title' => array(
        'type' => 'varchar',
        'length' => 64,
        'not null' => FALSE,
        'description' => 'A title for the TARDIS block.',
      ),
      'node_types' => array(
        'type' => 'blob',
        'size' => 'normal',
        'description' => 'Which node types should be displayed in the TARDIS page.',
      ),
      'current_month' => array(
        'type' => 'int',
        'size' => 'tiny',
        'not null' => TRUE,
        'unsigned' => TRUE,
        'description' => 'Should TARDIS begin a list of nodes from the current month?',
      ),
      'past_months' => array(
        'type' => 'int',
        'size' => 'tiny',
        'not null' => TRUE,
        'unsigned' => TRUE,
        'description' => 'How many months should be displayed in the TARDIS block.',
      ),
      'stop_year' => array(
        'type' => 'int',
        'size' => 'small',
        'not null' => TRUE,
        'unsigned' => TRUE,
        'description' => "TARDIS shouldn't look beyond this year, for performance reasons.",
      ),
      'link_nesting_months_years' => array(
        'type' => 'int',
        'size' => 'tiny',
        'not null' => TRUE,
        'unsigned' => TRUE,
        'description' => 'Should months be nested under years?',
      ),
      'year_link' => array(
        'type' => 'varchar',
        'length' => 24,
        'not null' => TRUE,
        'description' => 'How should TARDIS render years: accordion, normal link or no link.',
      ),
      'month_link' => array(
        'type' => 'varchar',
        'length' => 16,
        'not null' => TRUE,
        'description' => 'Whether months should be displayed as numbers or names.',
      ),
      'block_link' => array(
        'type' => 'varchar',
        'length' => 255,
        'not null' => TRUE,
        'description' => 'An address for the TARDIS block links.',
      ),
    ),
    'indexes' => array(
      'name' => array('name'),
    ),
    'primary_key' => array('name'),
  );

  $schema['tardis_pages'] = array(
    'description' => 'Stores settings for custom TARDIS pages.',
    'fields' => array(
      'name' => array(
        'type' => 'varchar',
        'length' => 64,
        'not null' => TRUE,
        'description' => 'A name for the TARDIS page.',
      ),
      'address' => array(
        'type' => 'varchar',
        'length' => 255,
        'not null' => TRUE,
        'description' => 'An address for the TARDIS page.',
      ),
      'title' => array(
        'type' => 'varchar',
        'length' => 64,
        'not null' => TRUE,
        'description' => 'A title for the TARDIS page.',
      ),
      'title_date' => array(
        'type' => 'varchar',
        'length' => 32,
        'not null' => TRUE,
        'description' => 'Should TARDIS append dates to page titles',
      ),
      'current_month' => array(
        'type' => 'int',
        'size' => 'tiny',
        'not null' => TRUE,
        'unsigned' => TRUE,
        'description' => 'Should TARDIS begin a list of nodes from the current month?',
      ),
      'node_types' => array(
        'type' => 'blob',
        'size' => 'normal',
        'description' => 'Which node types should be displayed in the TARDIS page.',
      ),
      'nodes_per_page' => array(
        'type' => 'int',
        'size' => 'small',
        'not null' => TRUE,
        'unsigned' => TRUE,
        'description' => 'How many nodes should be displayed in the TARDIS page.',
      ),
    ),
    'indexes' => array(
      'name' => array('name'),
      'address' => array('address'),
    ),
    'primary_key' => array('name'),
  );

  return $schema;
}

/**
 * Implements hook_uninstall(). 
 */
function tardis_uninstall() {
  drupal_uninstall_schema('tardis');

  variable_del('tardis_general_modules__active_tab');
}

/**
 * Creates the TARDIS page and block tables.
 */
function tardis_update_7200() {
  $schema['tardis_blocks'] = array(
    'description' => 'Stores settings for custom TARDIS blocks.',
    'fields' => array(
      'name' => array(
        'type' => 'varchar',
        'length' => 64,
        'not null' => TRUE,
        'description' => 'A name for the TARDIS block.',
      ),
      'title' => array(
        'type' => 'varchar',
        'length' => 64,
        'not null' => FALSE,
        'description' => 'A title for the TARDIS block.',
      ),
      'node_types' => array(
        'type' => 'blob',
        'size' => 'normal',
        'description' => 'Which node types should be displayed in the TARDIS page.',
      ),
      'current_month' => array(
        'type' => 'int',
        'size' => 'tiny',
        'not null' => TRUE,
        'unsigned' => TRUE,
        'description' => 'Should TARDIS begin a list of nodes from the current month?',
      ),
      'past_months' => array(
        'type' => 'int',
        'size' => 'tiny',
        'not null' => TRUE,
        'unsigned' => TRUE,
        'description' => 'How many months should be displayed in the TARDIS block.',
      ),
      'stop_year' => array(
        'type' => 'int',
        'size' => 'small',
        'not null' => TRUE,
        'unsigned' => TRUE,
        'description' => "TARDIS shouldn't look beyond this year, for performance reasons.",
      ),
      'link_nesting_months_years' => array(
        'type' => 'int',
        'size' => 'tiny',
        'not null' => TRUE,
        'unsigned' => TRUE,
        'description' => 'Should months be nested under years?',
      ),
      'year_link' => array(
        'type' => 'varchar',
        'length' => 24,
        'not null' => TRUE,
        'description' => 'How should TARDIS render years: accordion, normal link or no link.',
      ),
      'month_link' => array(
        'type' => 'varchar',
        'length' => 16,
        'not null' => TRUE,
        'description' => 'Whether months should be displayed as numbers or names.',
      ),
      'block_link' => array(
        'type' => 'varchar',
        'length' => 255,
        'not null' => TRUE,
        'description' => 'An address for the TARDIS block links.',
      ),
    ),
    'indexes' => array(
      'name' => array('name'),
    ),
    'primary_key' => array('name'),
  );
  db_create_table('tardis_blocks', $schema['tardis_blocks']);

  $schema['tardis_pages'] = array(
    'description' => 'Stores settings for custom TARDIS pages.',
    'fields' => array(
      'name' => array(
        'type' => 'varchar',
        'length' => 64,
        'not null' => TRUE,
        'description' => 'A name for the TARDIS page.',
      ),
      'address' => array(
        'type' => 'varchar',
        'length' => 255,
        'not null' => TRUE,
        'description' => 'An address for the TARDIS page.',
      ),
      'title' => array(
        'type' => 'varchar',
        'length' => 64,
        'not null' => TRUE,
        'description' => 'A title for the TARDIS page.',
      ),
      'title_date' => array(
        'type' => 'varchar',
        'length' => 32,
        'not null' => TRUE,
        'description' => 'Should TARDIS append dates to page titles',
      ),
      'current_month' => array(
        'type' => 'int',
        'size' => 'tiny',
        'not null' => TRUE,
        'unsigned' => TRUE,
        'description' => 'Should TARDIS begin a list of nodes from the current month?',
      ),
      'node_types' => array(
        'type' => 'blob',
        'size' => 'normal',
        'description' => 'Which node types should be displayed in the TARDIS page.',
      ),
      'nodes_per_page' => array(
        'type' => 'int',
        'size' => 'small',
        'not null' => TRUE,
        'unsigned' => TRUE,
        'description' => 'How many nodes should be displayed in the TARDIS page.',
      ),
    ),
    'indexes' => array(
      'name' => array('name'),
      'address' => array('address'),
    ),
    'primary_key' => array('name'),
  );
  db_create_table('tardis_pages', $schema['tardis_pages']);

  return t('TARDIS page and block tables created successfully.');
}

/**
 * Removes outdated variables.
 */
function tardis_update_7201() {
  variable_del('tardis_general_node_types');
  variable_del('tardis_general_current_month');

  variable_del('tardis_block_title');
  variable_del('tardis_block_node_types');
  variable_del('tardis_block_current_month');
  variable_del('tardis_block_past_months');
  variable_del('tardis_block_stop_year');
  variable_del('tardis_block_link_nesting_months_years');
  variable_del('tardis_block_year_link');
  variable_del('tardis_block_month_link');
  variable_del('tardis_block_custom_link');

  variable_del('tardis_page_address');
  variable_del('tardis_page_title');
  variable_del('tardis_page_title_date');
  variable_del('tardis_page_node_types');
  variable_del('tardis_page_current_month');
  variable_del('tardis_page_nodes_per_page');

  return t('Variables removed successfully.');
}
