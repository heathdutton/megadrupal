<?php
/**
 * @file
 *  wildfire_auth.module
 *
 * Manages Wildfire client auth keys
 *
 * @author Craig Jones <craig@tiger-fish.com>
 */

/**
 * Implements hook_permission().
 */
function wildfire_auth_permission() {
  return array(
    // Admin control to amend the auth key
    'administer wildfire auth' => array(
      'title' => t('administer wildfire auth'),
      'description' => t('Allows administration of Wildfire auth keys'),
    ),
  );
}

/**
 * Implements hook_form_alter().
 *
 * This adds a field to the wildfire system settings form for the auth key
 * to be entered into. This is stored as a system var for later use by the
 * wildfire_rpc_client module.
 *
 * @param $form
 * @param $form_state
 * @param $form_id
 */
function wildfire_auth_form_alter(&$form, &$form_state, $form_id) {

  if ($form_id == 'wildfire_settings_form') {

    /**
     * Only add the fields to the form if the user has permission to change
     * auth key settings
     */
    if (user_access('administer wildfire auth')) {

      // Add our custom validator to the chain
      $form['#validate'][] = 'wildfire_auth_form_validate';

      $form['authkey_fieldset'] = array(
        '#type' => 'fieldset',
        '#title' => t('Auth key settings'),
        '#weight' => 99,
      );
      $form['authkey_fieldset']['wildfire_rpc_authkey'] = array(
        '#type' => 'textfield',
        '#title' => t('Auth key'),
        //'#required' => TRUE,
        '#description' => t('Enter the Auth key provided to you by Wildfire HQ, for connection to the master server'),
        '#default_value' => variable_get('wildfire_rpc_authkey', ''),
      );

    }

  }

}

/**
 * Custom form validation for our extra entries in the wildfire settings form
 *
 * @param $form
 * @param $form_state
 */
function wildfire_auth_form_validate($form, &$form_state) {

  // Check that the Auth key entered is valid if one was given.
  if (!empty($form_state['values']['wildfire_rpc_authkey'])) {

    /**
     * Check the quota for the system. If this produces an error,
     * the key isn't valid for the system.
     */
    try {

      module_load_include('inc', 'wildfire', 'wildfire.rpc');
      $quota = wildfire_rpc_send_request(
        'wildfire.system.getQuota',
        array(),
        $form_state['values']['wildfire_rpc_authkey'],
        $form_state['values']['wildfire_system_name']
      );

      if (!empty($quota['error'])) {
        form_set_error(
          'wildfire_rpc_authkey',
          t('The auth key entered does not appear to be valid for the system name given')
        );
      }
      else {
        drupal_set_message(
          t('Auth key given is valid'),
          'status'
        );
      }

    }
    catch (Exception $e) {
      form_set_error(
        'wildfire_rpc_authkey',
        t(
          'Checking auth key raised an error: !message.'
          . ' Please check the auth key given and try again.',
          array(
            '!message' => $e->getMessage()
          )
        )
      );
    }

  }


}
