<?php

/**
 * @file
 * defination of ubercart_funds.module
 * */
function ubercart_funds_permission() {
  return array(
      'view own transactions' => array(
          'title' => t('View Own Transactions'),
          'description' => t('Allow users to view their transactions'),
      ),
      'deposit funds' => array(
          'title' => t('Deposit Funds'),
          'description' => t('Allow users to deposit funds'),
      ),
      'create escrow payment' => array(
          'title' => t('Create Escrow Payment'),
          'description' => t('Allow users to transfer funds'),
      ),
      'transfer funds' => array(
          'title' => t('Transfer Funds'),
          'description' => t('Allow users to transfer funds'),
      ),
      'withdraw funds' => array(
          'title' => t('Withdraw Funds'),
          'description' => t('Allow users to withdraw funds'),
      ),
      'administer withdraw requests' => array(
          'title' => t('Administer Withdraw Requests'),
          'description' => t('Allow users to approve/reject withdraw requests'),
      ),
      'view transactions' => array(
          'title' => t('View All Transactions'),
          'description' => t('Allow users to view all transactions'),
      ),
      'administer funds' => array(
          'title' => t('Administer Funds'),
          'description' => t('Gives users permission to administer all funds operations'),
          'restrict access' => TRUE,
      ),
  );
}

function ubercart_funds_menu() {

  $items['admin/store/funds'] = array(
      'title' => 'Funds Management',
      'description' => 'Administer Store Funds',
      'page callback' => 'system_admin_menu_block_page',
      'access arguments' => array('access administration pages'),
      'file path' => drupal_get_path('module', 'system'),
      'file' => 'system.admin.inc',
      'weight' => -15,
  );

  $items['admin/store/funds/view-transactions'] = array(
      'title' => 'View Transactions',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('ubercart_funds_view_transactions'),
      'access arguments' => array('view transactions'),
      'type' => MENU_NORMAL_ITEM,
  );

  $items['admin/store/funds/view-withdraw-requests'] = array(
      'title' => 'Withdrawal Requests',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('ubercart_funds_view_withdrawal_requests'),
      'access arguments' => array('administer withdraw requests'),
      'type' => MENU_NORMAL_ITEM,
  );

  $items['admin/store/funds/withdrawals/approve/%'] = array(
      'page callback' => 'drupal_get_form',
      'page arguments' => array('ubercart_funds_approve_withdrawal_request', 5),
      'access arguments' => array('view own transactions'),
      'type' => MENU_CALLBACK,
  );

  $items['admin/store/funds/withdrawals/decline/%'] = array(
      'page callback' => 'drupal_get_form',
      'page arguments' => array('ubercart_funds_decline_withdrawal_request', 5),
      'access arguments' => array('view own transactions'),
      'type' => MENU_CALLBACK,
  );

  $items['admin/store/funds/configure'] = array(
      'title' => 'Configuration',
      'description' => 'Configure Store Settings',
      'page callback' => 'system_admin_menu_block_page',
      'access arguments' => array('administer funds'),
      'file path' => drupal_get_path('module', 'system'),
      'file' => 'system.admin.inc',
      'weight' => -15,
  );

  $items['admin/store/funds/configure/fees'] = array(
      'title' => 'Fees',
      'page callback' => 'ubercart_funds_configure_fees',
      'access arguments' => array('administer funds'),
      'type' => MENU_NORMAL_ITEM,
  );

  $items['admin/store/funds/configure/withdraw-methods'] = array(
      'title' => 'Withdrawal Methods',
      'page callback' => 'ubercart_funds_configure_withdraw_methods',
      'access arguments' => array('administer funds'),
      'type' => MENU_NORMAL_ITEM,
  );

  $items['user/funds/transactions'] = array(
      'title' => 'Transactions',
      'page callback' => 'ubercart_funds_get_user_transactions',
      'access arguments' => array('view own transactions'),
      'type' => MENU_CALLBACK,
  );

  $items['user/funds/withdrawals'] = array(
      'title' => 'Withdrawal requests',
      'page callback' => 'ubercart_funds_get_user_withdrawals',
      'access arguments' => array('withdraw funds'),
      'type' => MENU_CALLBACK,
  );

  $items['user/funds/escrow-payments'] = array(
      'title' => 'Escrow Payments',
      'page callback' => 'ubercart_funds_get_user_escrow_payments',
      'access arguments' => array('view own transactions'),
      'type' => MENU_CALLBACK,
  );

  $items['user/funds/deposit'] = array(
      'title' => 'Deposit Funds',
      'page callback' => 'ubercart_funds_deposit_funds',
      'access arguments' => array('deposit funds'),
      'type' => MENU_CALLBACK,
  );

  $items['user/funds/withdraw'] = array(
      'title' => 'Submit a Withdrawal Request',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('ubercart_funds_withdraw_funds'),
      'access arguments' => array('withdraw funds'),
      'type' => MENU_CALLBACK,
  );

  $items['user/funds/manage/withdrawal-methods'] = array(
      'title' => 'Configure Withdrawal Methods',
      'page callback' => 'ubercart_funds_manage_withdrawal_methods',
      'access arguments' => array('withdraw funds'),
      'type' => MENU_CALLBACK,
  );

  $items['user/funds/manage/withdrawal-methods/paypal'] = array(
      'title' => 'Configure Paypal',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('ubercart_funds_manage_withdrawal_method_paypal'),
      'access arguments' => array('withdraw funds'),
      'type' => MENU_CALLBACK,
  );

  $items['user/funds/manage/withdrawal-methods/skrill'] = array(
      'title' => 'Configure Skrill',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('ubercart_funds_manage_withdrawal_method_skrill'),
      'access arguments' => array('withdraw funds'),
      'type' => MENU_CALLBACK,
  );

  $items['user/funds/manage/withdrawal-methods/bank_account'] = array(
      'title' => 'Configure Bank Account',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('ubercart_funds_manage_withdrawal_method_bank_account'),
      'access arguments' => array('withdraw funds'),
      'type' => MENU_CALLBACK,
  );

  $items['user/funds/manage/withdrawal-methods/check'] = array(
      'title' => 'Configure Check',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('ubercart_funds_manage_withdrawal_method_check'),
      'access arguments' => array('withdraw funds'),
      'type' => MENU_LOCAL_TASK,
  );

  $items['user/funds/create-escrow'] = array(
      'title' => 'Create Escrow Payment',
      'page callback' => 'ubercart_funds_escrow_payment',
      'access arguments' => array('transfer funds'),
      'type' => MENU_CALLBACK,
  );

  $items['user/funds/release-escrow/%'] = array(
      'page callback' => 'drupal_get_form',
      'page arguments' => array('ubercart_funds_release_escrow_payment', 3),
      'access arguments' => array('transfer funds'),
      'type' => MENU_CALLBACK,
  );

  $items['user/funds/cancel-escrow/%'] = array(
      'page callback' => 'drupal_get_form',
      'page arguments' => array('ubercart_funds_cancel_escrow_payment', 3),
      'access arguments' => array('transfer funds'),
      'type' => MENU_CALLBACK,
  );

  $items['user/funds/transfer'] = array(
      'title' => 'Transfer Funds',
      'page callback' => 'ubercart_funds_transfer_funds',
      'access arguments' => array('transfer funds'),
      'type' => MENU_CALLBACK,
  );

  return $items;
}

function ubercart_funds_approve_withdrawal_request($form, &$form_state, $request_id) {

  $form['#$request_id'] = $request_id;

  $request = db_query("SELECT * FROM {ubercart_funds_withdraw_requests} WHERE request_id= :request_id", array(':request_id' => $request_id))->fetchAssoc();

  $user = user_load($request['uid']);

  return confirm_form($form, check_plain('Approve Request?'), 'admin/store/funds/view-withdraw-requests', check_plain('Are you sure you want to approve the withdrawal request made by ' . $user->mail . '?'), check_plain('Yes'));
}

function ubercart_funds_approve_withdrawal_request_submit($form, &$form_state) {

  $request_id = $form['#$request_id'];

  $commissions = variable_get('ubercart_funds_commissions', array());

  $request = db_query("SELECT * FROM {ubercart_funds_withdraw_requests} WHERE request_id= :request_id", array(':request_id' => $request_id))->fetchAssoc();

  $request['status'] = t('Approved');

  $user_balance = db_query("SELECT * FROM {ubercart_funds_user_funds} WHERE uid=" . $request['uid'])->fetchAssoc();
  $user_balance['balance'] -= $request['amount'] * (1.0 + $commissions[$request['method']] / 100.0);

  drupal_write_record('ubercart_funds_user_funds', $user_balance, 'uid');
  drupal_write_record('ubercart_funds_withdraw_requests', $request, 'request_id');

  drupal_goto('admin/store/funds/view-withdraw-requests');
}

function ubercart_funds_decline_withdrawal_request($form, &$form_state, $request_id) {

  $form['#$request_id'] = $request_id;

  $form['reason'] = array(
      '#type' => 'textarea',
      '#title' => t('Reason for Decline'),
      '#description' => '',
  );

  $request = db_query("SELECT * FROM {ubercart_funds_withdraw_requests} WHERE request_id= :request_id", array(':request_id' => $request_id))->fetchAssoc();

  $user = user_load($request['uid']);

  return confirm_form($form, check_plain('Decline Request?'), 'admin/store/funds/view-withdraw-requests', check_plain('Are you sure you want to decline the withdrawal request made by ' . $user->mail . '?'), check_plain('Yes'));
}

function ubercart_funds_decline_withdrawal_request_submit($form, &$form_state) {

  $request_id = $form['#$request_id'];

  $request = db_query("SELECT * FROM {ubercart_funds_withdraw_requests} WHERE request_id= :request_id", array(':request_id' => $request_id))->fetchAssoc();

  $request['status'] = t('Declined');
  $request['notes'] = $form_state['values']['reason'];

  drupal_write_record('ubercart_funds_withdraw_requests', $request, 'request_id');

  drupal_goto('admin/store/funds/view-withdraw-requests');
}

function ubercart_funds_cancel_escrow_payment($form, &$form_state, $transaction_id) {

  $form['#$transaction_id'] = $transaction_id;

  $transaction = db_query("SELECT * FROM {ubercart_funds_transactions} WHERE transaction_id= :transaction_id", array(':transaction_id' => $transaction_id))->fetchAssoc();

  $user = user_load($transaction['uid']);

  return confirm_form($form, check_plain('Cancel Escrow Payment?'), 'user/funds/escrow-payments', check_plain('Are you sure you want to cancel this payment and return the funds to ' . $user->mail . '?'), check_plain('Yes'));
}

function ubercart_funds_cancel_escrow_payment_submit($form, &$form_state) {

  $transaction_id = $form['#$transaction_id'];

  $transaction = db_query("SELECT * FROM {ubercart_funds_transactions} WHERE transaction_id= :transaction_id", array(':transaction_id' => $transaction_id))->fetchAssoc();

  $from_user_balance = db_query("SELECT * FROM {ubercart_funds_user_funds} WHERE uid=" . $transaction['uid'])->fetchAssoc();

  $from_user_balance['balance'] += $transaction['amount'];

  drupal_write_record('ubercart_funds_user_funds', $from_user_balance, 'uid');

  $transaction['type'] = 'Cancelled Escrow Payment';

  drupal_write_record('ubercart_funds_transactions', $transaction, 'transaction_id');
  
  drupal_mail('ubercart_funds', 'escrow_cancel_from', user_load($transaction['uid'])->mail, language_default(), array('transaction' => $transaction['transaction_id']));
  drupal_mail('ubercart_funds', 'escrow_cancel_to', user_load($transaction['reference'])->mail, language_default(), array('transaction' => $transaction['transaction_id']));

  drupal_goto('user/funds/escrow-payments');
}

function ubercart_funds_release_escrow_payment($form, &$form_state, $transaction_id) {

  $form['#$transaction_id'] = $transaction_id;

  $transaction = db_query("SELECT * FROM {ubercart_funds_transactions} WHERE transaction_id= :transaction_id", array(':transaction_id' => $transaction_id))->fetchAssoc();

  $user = user_load($transaction['reference']);

  return confirm_form($form, check_plain('Release Escrow Payment?'), 'user/funds/escrow-payments', check_plain('Are you sure you want to release this payment and send the funds to ' . $user->mail . '?'), check_plain('Yes'));
}

function ubercart_funds_release_escrow_payment_submit($form, &$form_state) {

  $transaction_id = $form['#$transaction_id'];

  $commissions = variable_get('ubercart_funds_commissions', array());

  $commission = array_key_exists('escrow', $commissions) ? $commissions['escrow'] : 0;
  $commission_fixed = array_key_exists('escrow_fixed', $commissions) ? $commissions['escrow_fixed'] : 0;

  $transaction = db_query("SELECT * FROM {ubercart_funds_transactions} WHERE transaction_id= :transaction_id", array(':transaction_id' => $transaction_id))->fetchAssoc();

  $to_user_balance = db_query("SELECT * FROM {ubercart_funds_user_funds} WHERE uid=" . $transaction['reference'])->fetchAssoc();

  $escrow_after_commission = $transaction['amount'] * (1.0 - $commission / 100.0);
  $escrow_after_commission_fixed = $transaction['amount'] - $commission_fixed;

  $to_user_balance['balance'] += $escrow_after_commission;

  drupal_write_record('ubercart_funds_user_funds', $to_user_balance, 'uid');

  $transaction['type'] = 'Completed Escrow Payment';

  drupal_write_record('ubercart_funds_transactions', $transaction, 'transaction_id');

  drupal_goto('user/funds/escrow-payments');
}

function ubercart_funds_commerce_product_type_info() {

  return array(
      'deposit' => array(
          'type' => 'deposit',
          'name' => 'Funds Deposit',
          'description' => 'Stores a Funds Deposit Operation',
          'help' => '',
          'revision' => 1
      )
  );
}

function ubercart_funds_view_transactions($form, &$form_state) {

  $transactions = db_query("SELECT * FROM {ubercart_funds_transactions}");

  $types = array('Deposit', 'Transfer', 'Escrow Payment', 'Completed Escrow Payment', 'Cancelled Escrow Payment');

  $header = array('Time', 'Type', 'User', 'Amount', 'Details');

  $rows = array();

  $saved_types = array();

  if (array_key_exists('ubercart_funds_filter_type', $_SESSION)) {
    foreach ($_SESSION['ubercart_funds_filter_type'] as $index) {
      $saved_types[] = $types[$index];
    }
  }

  foreach ($transactions as $transaction) {
    if ((array_key_exists('ubercart_funds_filter_type', $_SESSION) && in_array($transaction->type, $saved_types)) || !array_key_exists('ubercart_funds_filter_type', $_SESSION)) {
      $user = user_load($transaction->uid);
      $to_user = $transaction->type == 'Transfer' ? user_load($transaction->reference) : array();
      $rows[] = array(date('d/m/Y   g:i:s A', $transaction->created), $transaction->type, $user->mail, /*commerce_currency_format*/uc_currency_format($transaction->amount/*, commerce_default_currency()*/), $transaction->type == 'Transfer' ? '<br />To: ' . $to_user->mail : '');
    }
  }

  $form['filter_type'] = array(
      '#type' => 'select',
      '#title' => t('Type'),
      '#options' => $types,
      '#attributes' => array('multiple' => TRUE),
      '#multiple' => TRUE,
      '#size' => 5,
      '#default_value' => array_key_exists('ubercart_funds_filter_type', $_SESSION) ? $_SESSION['ubercart_funds_filter_type'] : '',
  );

  $form['filter'] = array(
      '#type' => 'submit',
      '#value' => t('Filter'),
  );

  $form['reset'] = array(
      '#type' => 'submit',
      '#value' => t('Reset'),
      '#suffix' => theme('table', array('header' => $header, 'rows' => $rows))
  );

  return $form;
}

function ubercart_funds_view_transactions_submit($form, &$form_state) {
  if ($form_state['values']['op'] == 'Filter') {
    if (!empty($form_state['values']['filter_type']))
      $_SESSION['ubercart_funds_filter_type'] = $form_state['values']['filter_type']; else {
      unset($_SESSION['ubercart_funds_filter_type']);
    }
  }
  elseif ($form_state['values']['op'] == 'Reset') {
    unset($_SESSION['ubercart_funds_filter_type']);
  }

  $form_state['redirect'] = 'admin/store/funds/view-transactions';
}

function ubercart_funds_view_withdrawal_requests($form, &$form_state) {

  $requests = db_query("SELECT * FROM {ubercart_funds_withdraw_requests}");

  $header = array('Time', 'User', 'Method', 'Amount', 'Request Status', 'Operations');

  $status = array(
      'Pending Approval', 'Approved', 'Declined'
  );

  $saved_status = array();

  if (array_key_exists('ubercart_funds_filter_status', $_SESSION)) {
    foreach ($_SESSION['ubercart_funds_filter_status'] as $index) {
      $saved_status[] = $status[$index];
    }
  }


  $rows = array();

  foreach ($requests as $request) {
    if ((array_key_exists('ubercart_funds_filter_status', $_SESSION) && in_array($request->status, $saved_status)) || !array_key_exists('ubercart_funds_filter_status', $_SESSION)) {
      if ((array_key_exists('ubercart_funds_filter_method', $_SESSION) && in_array($request->method, $_SESSION['ubercart_funds_filter_method'])) || !array_key_exists('ubercart_funds_filter_method', $_SESSION)) {
        $user = user_load($request->uid);
        $rows[] = array(date('d/m/Y   g:i:s A', $request->created), $user->name, $request->method, /*commerce_currency_format*/uc_currency_format($request->amount/100/*, commerce_default_currency()*/), $request->status == 'Declined' ? $request->status . '<br /><br />Reason: ' . $request->notes : $request->status, '<ul><li>' . l(t('Approve'), 'admin/commerce/funds/withdrawals/approve/' . $request->request_id) . '</li><li>' . l(t('Decline'), 'admin/store/funds/withdrawals/decline/' . $request->request_id) . '</li>');
      }
    }
  }

  $form['filter_method'] = array(
      '#type' => 'select',
      '#title' => t('Method'),
      '#options' => ubercart_funds_get_enabled_withdrawal_methods(),
      '#attributes' => array('multiple' => TRUE),
      '#multiple' => TRUE,
      '#size' => count(ubercart_funds_get_enabled_withdrawal_methods()),
      '#default_value' => array_key_exists('ubercart_funds_filter_method', $_SESSION) ? $_SESSION['ubercart_funds_filter_method'] : '',
  );

  $form['filter_status'] = array(
      '#type' => 'select',
      '#title' => t('Status'),
      '#options' => $status,
      '#attributes' => array('multiple' => TRUE),
      '#multiple' => TRUE,
      '#size' => 3,
      '#default_value' => array_key_exists('ubercart_funds_filter_status', $_SESSION) ? $_SESSION['ubercart_funds_filter_status'] : '',
  );

  $form['filter'] = array(
      '#type' => 'submit',
      '#value' => t('Filter'),
  );

  $form['reset'] = array(
      '#type' => 'submit',
      '#value' => t('Reset'),
      '#suffix' => theme('table', array('header' => $header, 'rows' => $rows))
  );

  return $form;
}

function ubercart_funds_view_withdrawal_requests_submit($form, &$form_state) {
  if ($form_state['values']['op'] == 'Filter') {
    if (!empty($form_state['values']['filter_status']))
      $_SESSION['ubercart_funds_filter_status'] = $form_state['values']['filter_status']; else {
      unset($_SESSION['ubercart_funds_filter_status']);
    }
    if (!empty($form_state['values']['filter_method']))
      $_SESSION['ubercart_funds_filter_method'] = $form_state['values']['filter_method']; else {
      unset($_SESSION['ubercart_funds_filter_method']);
    }
  }
  elseif ($form_state['values']['op'] == 'Reset') {
    unset($_SESSION['ubercart_funds_filter_status']);
    unset($_SESSION['ubercart_funds_filter_method']);
  }

  $form_state['redirect'] = 'admin/store/funds/view-withdraw-requests';
}

function ubercart_funds_configure_fees() {

  $payment_methods = _uc_payment_method_list();/*commerce_payment_methods();*/

  $enabled_methods = array();

  foreach ($payment_methods as $payment_method) {

    $enabled_methods[] = $payment_method;
  }
  //watchdog('methods', print_r($enabled_methods, true));
  return drupal_get_form('ubercart_funds_configure_fees_form', $enabled_methods);
}

function ubercart_funds_configure_fees_form($form, &$form_state, $enabled_methods) {

  $form['#enabledmethods'] = $enabled_methods;

  $commissions = variable_get('ubercart_funds_commissions', array());

  $form['transfer'] = array(
      '#type' => 'textfield',
      '#title' => check_plain('Transfer Fee (%)'),
      '#description' => check_plain('Commission taken on transfers'),
      '#default_value' => array_key_exists('transfer', $commissions) ? $commissions['transfer'] : '0',
      '#size' => 5,
      '#maxlength' => 5,
      '#required' => TRUE,
  );

  $form['transfer_fixed'] = array(
      '#type' => 'textfield',
      '#title' => check_plain('Fixed Transfer Fee (' . variable_get('uc_currency_code', 'USD')/*commerce_default_currency()*/ . ')'),
      '#description' => check_plain('Fixed fee taken on transfers'),
      '#default_value' => array_key_exists('transfer_fixed', $commissions) ? $commissions['transfer_fixed'] / 100 : '0',
      '#size' => 5,
      '#maxlength' => 5,
      '#required' => TRUE,
  );//new
  
  $form['escrow'] = array(
      '#type' => 'textfield',
      '#title' => check_plain('Escrow Fee (%)'),
      '#description' => check_plain('Commission taken on escrows'),
      '#default_value' => array_key_exists('escrow', $commissions) ? $commissions['escrow'] : '0',
      '#size' => 5,
      '#maxlength' => 5,
      '#required' => TRUE,
  );

  $form['escrow_fixed'] = array(
      '#type' => 'textfield',
      '#title' => check_plain('Fixed Escrow Fee (' . variable_get('uc_currency_code', 'USD')/*commerce_default_currency()*/ . ')'),
      '#description' => check_plain('Fixed fee taken on escrows'),
      '#default_value' => array_key_exists('escrow_fixed', $commissions) ? $commissions['escrow_fixed'] / 100 : '0',
      '#size' => 5,
      '#maxlength' => 5,
      '#required' => TRUE,
  );//new
  
  
  $form['deposit'] = array(
      '#type' => 'fieldset',
      '#title' => check_plain('Deposit Fees'),
      '#collapsible' => FALSE,
  );

  foreach ($enabled_methods as $method) {
    $method_id = $method['id'];/*$method['method_id'];*/
    $form['deposit'][$method_id] = array(
        '#type' => 'textfield',
        '#title' => /*check_plain(*/$method['title'] . ' Fee (%)'/*)*/,
        '#description' => /*check_plain(*/'Fee taken for Deposits made using ' . $method['title']/*)*/,
        '#default_value' => array_key_exists($method_id, $commissions) ? $commissions[$method_id] : '0',
        '#size' => 5,
        '#maxlength' => 5,
        '#required' => TRUE,
    );
    
    $form['deposit'][$method_id . '_fixed'] = array(
        '#type' => 'textfield',
        '#title' => /*check_plain(*/'Fixed ' . $method['title'] . ' Fee (' . variable_get('uc_currency_code', 'USD')/*commerce_default_currency()*/ . ')'/*)*/,
        '#description' => /*check_plain(*/'Fixed Fee taken for Deposits made using ' . $method['title']/*)*/,
        '#default_value' => array_key_exists($method_id . '_fixed', $commissions) ? $commissions[$method_id . '_fixed'] / 100 : '0',
        '#size' => 5,
        '#maxlength' => 5,
        '#required' => TRUE,
    );//new
  }

  $form['withdraw'] = array(
      '#type' => 'fieldset',
      '#title' => check_plain('Withdrawal Fees'),
      '#collapsible' => FALSE,
  );

  $enabled_methods = ubercart_funds_get_enabled_withdrawal_methods();

  foreach ($enabled_methods as $key => $method) {
    $method_id = $key;
    $form['withdraw'][$method_id] = array(
        '#type' => 'textfield',
        '#title' => check_plain($method . ' Fee (%)'),
        '#description' => check_plain('Fee taken for Withdrawals made using ' . $method),
        '#default_value' => array_key_exists($method_id, $commissions) ? $commissions[$method_id] : '0',
        '#size' => 5,
        '#maxlength' => 5,
        '#required' => TRUE,
    );
    
    $form['withdraw'][$method_id . '_fixed'] = array(
        '#type' => 'textfield',
        '#title' => check_plain('Fixed ' . $method . ' Fee (' . variable_get('uc_currency_code', 'USD')/*commerce_default_currency()*/ . ')'),
        '#description' => check_plain('Fixed Fee taken for Withdrawals made using ' . $method),
        '#default_value' => array_key_exists($method_id . '_fixed', $commissions) ? $commissions[$method_id . '_fixed'] / 100 : '0',
        '#size' => 5,
        '#maxlength' => 5,
        '#required' => TRUE,
    );//new
  }

  $form['submit'] = array(
      '#type' => 'submit',
      '#value' => check_plain('Save'),
  );

  return $form;
}

function ubercart_funds_configure_fees_form_validate($form, &$form_state) {

  $enabled_methods = $form['#enabledmethods'];

  foreach ($enabled_methods as $method) {
    if (!is_numeric($form_state['values'][/*$method['method_id'*/$method['id']])) {
      form_set_error('amount', t('Value must be Numeric'));
      return FALSE;
    }
  }
}

function ubercart_funds_configure_fees_form_submit($form, &$form_state) {

  $commissions = array();

  $commissions['transfer'] = $form_state['values']['transfer'];
  $commissions['transfer_fixed'] = $form_state['values']['transfer_fixed'] * 100;
  $commissions['escrow'] = $form_state['values']['escrow'];
  $commissions['escrow_fixed'] = $form_state['values']['escrow_fixed'] * 100;

  $enabled_methods = $form['#enabledmethods'];

  foreach ($enabled_methods as $method) {
    $method_id = $method['id'];/*$method['method_id'];*/
    $commissions[$method_id] = $form_state['values'][$method_id];
    $commissions[$method_id . '_fixed'] = $form_state['values'][$method_id . '_fixed'] * 100;
  }

  $enabled_methods = ubercart_funds_get_enabled_withdrawal_methods();

  foreach ($enabled_methods as $key => $method) {
    $method_id = $key;
    $commissions[$method_id] = $form_state['values'][$method_id];
    $commissions[$method_id . '_fixed'] = $form_state['values'][$method_id . '_fixed'] * 100;
  }

  variable_set('ubercart_funds_commissions', $commissions);
}

function ubercart_funds_block_info() {
  $blocks['account_balance'] = array(
      'info' => t('Account Balance'),
      'cache' => DRUPAL_NO_CACHE,
  );

  $blocks['funds_operations'] = array(
      'info' => t('Account Funds Operations'),
      'cache' => DRUPAL_NO_CACHE,
  );

  return $blocks;
}

function ubercart_funds_block_view($delta = '') {

  $block = array();

  switch ($delta) {
    case 'account_balance':
      $block['subject'] = t('Balance');
      $block['content'] = ubercart_funds_get_user_balance();
      break;
    case 'funds_operations':
      $block['subject'] = t('Operations');
      $block['content'] = ubercart_funds_get_user_operations();
      break;
  }

  return $block;
}

function ubercart_funds_theme() {
  return array(
      'account_balance' => array(
          'variables' => array('uid' => NULL),
          'template' => 'theme/ubercart-funds-account-balance',
      ),
      'account_operations' => array(
          'variables' => array('uid' => NULL),
          'template' => 'theme/ubercart-funds-account-operations',
      ),
      'account_transactions' => array(
          'variables' => array('uid' => NULL),
          'template' => 'theme/ubercart-funds-account-transactions',
      ),
      'account_withdrawals' => array(
          'variables' => array('uid' => NULL),
          'template' => 'theme/ubercart-funds-account-withdrawals',
      ),
      'account_outgoing_escrows' => array(
          'variables' => array('uid' => NULL),
          'template' => 'theme/ubercart-funds-account-outgoing-escrows',
      ),
      'account_incoming_escrows' => array(
          'variables' => array('uid' => NULL),
          'template' => 'theme/ubercart-funds-account-incoming-escrows',
      ),
      'escrow_cancel_from' => array(
          'variables' => array('transaction' => NULL),
          'template' => 'theme/emails/commerce-escrow-cancel-from',
      ),
      'escrow_cancel_to' => array(
          'variables' => array('transaction' => NULL),
          'template' => 'theme/emails/commerce-escrow-cancel-to',
      ),
  );
}

function ubercart_funds_get_user_balance() {
  global $user;
  return theme('account_balance', array('uid' => $user->uid));
}

function ubercart_funds_get_user_operations() {
  global $user;
  return theme('account_operations', array('uid' => $user->uid));
}

function ubercart_funds_get_user_transactions() {
  global $user;
  return theme('account_transactions', array('uid' => $user->uid));
}

function ubercart_funds_get_user_withdrawals() {
  global $user;
  return theme('account_withdrawals', array('uid' => $user->uid));
}

function ubercart_funds_get_user_escrow_payments() {
  global $user;
  return theme('account_incoming_escrows', array('uid' => $user->uid)) . theme('account_outgoing_escrows', array('uid' => $user->uid));
}

function ubercart_funds_deposit_funds() {
  return drupal_get_form('ubercart_funds_deposit_funds_form');
}

function ubercart_funds_deposit_funds_form($form, &$form_state) {

  $form['amount'] = array(
      '#type' => 'textfield',
      '#title' => t('Deposit Amount (' . variable_get('uc_currency_code', 'USD') . ')'),
      '#description' => t('Please enter the amount you wish to deposit in ' . variable_get('uc_currency_code', 'USD')),
      '#default_value' => '',
      '#size' => 30,
      '#maxlength' => 128,
      '#required' => TRUE,
  );

  $form['notes'] = array(
      '#type' => 'textarea',
      '#title' => t('Notes'),
      '#description' => '',
  );

  $form['submit'] = array(
      '#type' => 'submit',
      '#value' => t('Next'),
  );

  return $form;
}

function ubercart_funds_default_rules_configuration() {

  $rules = array();
  $rule = rules_reaction_rule();

  $rule->label = t('Adds funds to balance when deposit is completed');
  $rule->active = TRUE;

  $rule->event('uc_checkout_complete'/*'commerce_checkout_complete'*/)
          ->action('ubercart_funds_update_balance', array(
              'uc_order:select' => 'order'/*'commerce-order'*/,
          ));

  $rules['ubercart_funds_add_funds_to_balance'] = $rule;

  return $rules;
}

function ubercart_funds_rules_action_info() {
  $actions = array();

  $actions['ubercart_funds_update_balance'] = array(
      'label' => t('Update user account balance'),
      'parameter' => array(
          'uc_order' => array(
              'type' => 'uc_order',
              'label' => t('Deposit Order'),
          ),
      ),
      'group' => t('Ubercart Funds'),
      'callbacks' => array(
          'execute' => 'ubercart_funds_rules_update_account_balance',
      ),
  );

  return $actions;
}

function ubercart_funds_rules_update_account_balance($order) {
  //watchdog('order', dprint_r($order, true));
  if (array_key_exists('type', $order->data) && $order->data['type'] == 'ubercart_funds_deposit') {
    global $user;

    $user_balance = new stdClass();

    $commissions = variable_get('ubercart_funds_commissions', array());

    $payment_method = explode('|', $order->payment_method/* $order->data['payment_method'] */);

    $commission = array_key_exists($payment_method[0], $commissions) ? $commissions[$payment_method[0]] : 0;
    $commission_fixed = array_key_exists($payment_method[0] . '_fixed', $commissions) ? $commissions[$payment_method[0] . '_fixed'] : 0;
    
    $deposit_after_commission = $order->order_total * (1.0 - $commission / 100.0); /* $order->commerce_order_total['und'][0]['amount'] * (1.0 - $commission / 100.0); */
    $deposit_after_commission_fixed = $order->order_total - $commission;
    
    $user_balance->uid = $user->uid;
    $user_balance->balance = $deposit_after_commission*100;

    $transaction = new stdClass();

    $transaction->uid = $user->uid;
    $transaction->reference = $order->order_id;
    $transaction->type = 'Deposit';
    $transaction->created = $order->created; /* $order->changed; */
    $transaction->amount = min(array($deposit_after_commission, $deposit_after_commission_fixed));
    $transaction->notes = ''/* $order->data['notes'] */;

    $exists = db_query("SELECT * FROM {ubercart_funds_user_funds} WHERE uid= :uid", array(':uid' => $user->uid))->fetchAssoc();

    if (!$exists) {
      drupal_write_record('ubercart_funds_user_funds', $user_balance);
    }
    else {
      $user_balance->balance += $exists['balance'];
      drupal_write_record('ubercart_funds_user_funds', $user_balance, 'uid');
    }

    drupal_write_record('ubercart_funds_transactions', $transaction);
  }
}

function ubercart_funds_deposit_funds_form_validate($form, &$form_state) {

  if (!is_numeric($form_state['values']['amount'])) {
    form_set_error('amount', t('Value must be Numeric'));
    return FALSE;
  }

  if (is_numeric($form_state['values']['amount']) && !(floatval($form_state['values']['amount']) > 0)) {
    form_set_error('amount', t('Value must be greater than 0'));
    return FALSE;
  }
}

function ubercart_funds_deposit_funds_form_submit($form, &$form_state) {

  global $user;

  /*$deposit = commerce_product_new('deposit');

  $deposit->uid = $user->uid;
  $deposit->sku = 'deposit_' . $user->uid . '_' . $form_state['values']['amount'] . '_' . microtime();

  $deposit->commerce_price['und'][0]['amount'] = $form_state['values']['amount'] * 100.0;
  $deposit->commerce_price['und'][0]['currency_code'] = variable_get('uc_currency_code', 'USD');

  $deposit->title = 'Deposit ' . uc_currency_format($form_state['values']['amount']);

  commerce_product_save($deposit);*/
  
  ///////////////////////////////////
  $deposit = new stdClass();
  $deposit->uid = $user->uid;
  $deposit->type = 'deposit';
  $deposit->model = 'deposit_' . $user->uid . '_' . $form_state['values']['amount'] . '_' . microtime();
  $deposit->sell_price = $form_state['values']['amount'];
  $deposit->cost = 0;
  $deposit->list_price = 0;
  $deposit->weight = 0;
  $deposit->weight_units = 'lb';
  $deposit->length = 0;
  $deposit->width = 0;
  $deposit->height = 0;
  $deposit->length_units = 0;
  $deposit->default_qty = 1;
  $deposit->ordering = 0;
  $deposit->shippable = 1;
  $deposit->price = $form_state['values']['amount'];
  $deposit->pkg_qty = 1;
  
  $deposit->title = 'Deposit ' . uc_currency_format($form_state['values']['amount']);
  node_save($deposit);
  $result = db_query("SELECT nid FROM {node} ORDER BY nid DESC LIMIT 1")->fetchAssoc();
  $node_nid = $result['nid'];
  $deposit_node = node_load($node_nid);

  
  $product = new stdClass();
  $product->qty = 1;
  $product->title = $deposit_node->title;
  $product->nid = $deposit_node->nid;
  $product->price = $deposit_node->sell_price;
  ///////////////////////////////////

  //////////////////////////////////
  $order = uc_order_new($user->uid);
      $order_id = $order->order_id;

      // Populate the order
      $addresses = uc_get_addresses($user->uid);
      foreach ($addresses as $address) {
        $first_name = $address['first_name'];
        $last_name = $address['last_name'];
        $company = $address['company'];
        $phone = $address['phone'];
        $city = $address['city'];        
        $street1 = $address['street1'];
        $street2 = $address['street2'];
        $postal_code = $address['postal_code'];  
        $zone = $address['zone'];        
        $country = $address['country'];                                               
      }      
      if (!isset($order->primary_email))
        $order->primary_email = $email;
      $order->billing_first_name = $first_name;
      $order->billing_last_name = $last_name;
      $order->billing_company = $company;
      $order->billing_phone = $phone;
      $order->billing_city = $city;       
      $order->billing_street1 = $street1;        
      $order->billing_street2 = $street2;
      $order->billing_postal_code = $postal_code;
      $order->billing_zone = $zone;          
      $order->billing_country = $country;
      $order->data['type'] = 'ubercart_funds_deposit';
      $order->data['notes'] = $form_state['values']['notes'];
                                
      $order->products[] = $product;
      uc_order_save($order);
      $_SESSION['cart_order'] = $order_id;
      $cid = uc_cart_get_id();
      uc_cart_empty($cid);
      uc_cart_add_item($product->nid, $qty = 1, null, $cid);
      //$order = uc_order_load($order_id); 
      
      drupal_goto('cart/checkout');
  /////////////////////////////////
  /*$deposit_order = ($user->uid) ? commerce_order_new($user->uid, 'checkout_checkout') : commerce_cart_order_new();

  $line_item = commerce_product_line_item_new($deposit, 1, $deposit_order->order_id);

  commerce_line_item_save($line_item);

  $order_wrapper = entity_metadata_wrapper('commerce_order', $deposit_order);

  $order_wrapper->commerce_line_items[] = $line_item;


  $deposit_order->data['type'] = 'ubercart_funds_deposit';
  $deposit_order->data['notes'] = $form_state['values']['notes'];

  commerce_order_save($deposit_order);

  drupal_goto('checkout/' . $deposit_order->order_id);*/
}

function ubercart_funds_withdraw_funds($form, &$form_state) {

  $methods = ubercart_funds_get_enabled_withdrawal_methods();

  $commissions = variable_get('ubercart_funds_commissions', array());

  foreach ($methods as $key => $method) {
    if (array_key_exists($key, $commissions)) {
      $methods[$key] = $method . ' (' . $commissions[$key] . '% Fee)';
    }
  }

  $form['amount'] = array(
      '#type' => 'textfield',
      '#title' => t('Amount to withdraw (' . variable_get('uc_currency_code', 'USD') . ')'),
      '#description' => t('Please enter the amount you wish to withdraw in ' . variable_get('uc_currency_code', 'USD')),
      '#default_value' => '',
      '#size' => 30,
      '#maxlength' => 128,
      '#required' => TRUE,
  );

  $form['methods'] = array(
      '#type' => 'radios',
      '#options' => $methods,
      '#title' => t('Choose a Withdrawal method'),
      '#default_value' => '',
      '#required' => TRUE,
  );

  $form['submit'] = array(
      '#type' => 'submit',
      '#value' => t('Submit Request'),
  );

  return $form;
}

function ubercart_funds_withdraw_funds_validate($form, &$form_state) {

  global $user;

  $commissions = variable_get('ubercart_funds_commissions', array());

  $user_balance = db_query("SELECT * FROM {ubercart_funds_user_funds} WHERE uid=" . $user->uid)->fetchAssoc();

  if (!is_numeric($form_state['values']['amount'])) {
    form_set_error('amount', t('Value must be Numeric'));
    return FALSE;
  }

  if ($form_state['values']['amount'] * 100 > $user_balance['balance']) {
    form_set_error('amount', t('Your available balance is') . ' ' . uc_currency_format($user_balance['balance'] / 100.0));
    return FALSE;
  }

  if (is_numeric($form_state['values']['amount']) && !(floatval($form_state['values']['amount']) > 0)) {
    form_set_error('amount', t('Value must be greater than 0'));
    return FALSE;
  }

  if (!$user->data || !array_key_exists($form_state['values']['methods'], $user->data)) {
    form_set_error('methods', t('Please') . ' ' . l(t('Enter Details'), 'user/funds/manage/withdrawal-methods/' . $form_state['values']['methods']) . ' ' . t('for this withdrawal method first'));
    return FALSE;
  }

  if (array_key_exists($form_state['values']['methods'], $commissions)) {

    $amount_plus_fees = (1.0 + $commissions[$form_state['values']['methods']] / 100.0) * $form_state['values']['amount'] * 100;

    if ($amount_plus_fees > $user_balance['balance']) {
      form_set_error('amount', t('You cannot withdraw more than') . ' ' . uc_current_format/*commerce_currency_format*/($user_balance['balance'] * (1 - $commissions[$form_state['values']['methods']] / 100.0)/*, commerce_default_currency()*/) . ' ' . t('using this method'));
      return FALSE;
    }
  }
}

function ubercart_funds_withdraw_funds_submit($form, &$form_state) {
  global $user;

  $request = new stdClass();
  $request->uid = $user->uid;
  $request->created = time();
  $request->method = $form_state['values']['methods'];
  $request->amount = $form_state['values']['amount'] * 100;
  $request->status = 'Pending Approval';

  drupal_write_record('ubercart_funds_withdraw_requests', $request);

  drupal_set_message(t('Your Withdrawal Request has been sent and will be processed in due order'), 'status');

  drupal_goto('user');
}

function ubercart_funds_transfer_funds() {
  return drupal_get_form('ubercart_funds_transfer_funds_form');
}

function ubercart_funds_escrow_payment() {
  return drupal_get_form('ubercart_funds_escrow_payment_form');
}

function ubercart_funds_escrow_payment_form($form, &$form_state) {

  $form['amount'] = array(
      '#type' => 'textfield',
      '#title' => t('Amount to put in Escrow (' . variable_get('uc_curreny_code', 'USD')/*commerce_default_currency()*/ . ')'),
      '#description' => t('Please enter the amount you wish to assign as an escrow payment in ' . variable_get('uc_curreny_code', 'USD')/*commerce_default_currency()*/),
      '#default_value' => '',
      '#size' => 30,
      '#maxlength' => 128,
      '#required' => TRUE,
  );

  $form['email'] = array(
      '#type' => 'textfield',
      '#title' => t('Allocated To'),
      '#description' => t('Please enter the email of the user you want to allocate the escrow payment to'),
      '#default_value' => '',
      '#size' => 30,
      '#maxlength' => 128,
      '#required' => TRUE,
  );

  $form['notes'] = array(
      '#type' => 'textarea',
      '#title' => t('Notes'),
      '#description' => '',
  );

  $form['submit'] = array(
      '#type' => 'submit',
      '#value' => t('Allocate Funds'),
  );

  return $form;
}

function ubercart_funds_escrow_payment_form_validate($form, &$form_state) {

  global $user;

  if (!is_numeric($form_state['values']['amount'])) {
    form_set_error('amount', t('Value must be Numeric'));
    return FALSE;
  }

  if (is_numeric($form_state['values']['amount']) && !(floatval($form_state['values']['amount']) > 0)) {
    form_set_error('amount', t('Value must be greater than 0'));
    return FALSE;
  }

  if (!filter_var($form_state['values']['email'], FILTER_VALIDATE_EMAIL)) {
    form_set_error('email', t('Please enter a valid email'));
    return FALSE;
  }

  $exists = db_query("SELECT * FROM {users} WHERE mail='" . $form_state['values']['email'] . "'")->fetchAssoc();

  if (!$exists) {
    form_set_error('email', t('We have no record of users with the email') . ' ' . $form_state['values']['email']);
    return FALSE;
  }

  $user_balance = db_query("SELECT * FROM {ubercart_funds_user_funds} WHERE uid=" . $user->uid)->fetchAssoc();

  if ($user_balance['balance'] < intval($form_state['values']['amount'] * 100)) {
    form_set_error('amount', t("You don't have enough funds to cover this transfer"));
    return FALSE;
  }
}

function ubercart_funds_escrow_payment_form_submit($form, &$form_state) {

  global $user;

  $from_user = $user;
  $to_user = db_query("SELECT * FROM {users} WHERE mail='" . $form_state['values']['email'] . "'")->fetchAssoc();
  
  $transfer_amount = intval($form_state['values']['amount'] * 100.0);

  //$commissions = variable_get('ubercart_funds_commissions', array());

  //$commission = array_key_exists('escrow', $commissions) ? $commissions['escrow'] : 0;


  //$transfer_after_commission = intval($form_state['values']['amount'] * 100.0) * (1.0 - $commission / 100.0);

  $transaction = new stdClass();

  $transaction->uid = $from_user->uid;
  $transaction->type = 'Escrow Payment';
  $transaction->reference = $to_user['uid'];
  $transaction->created = time();
  $transaction->amount = $transfer_amount;
  $transaction->notes = $form_state['values']['notes'];

  $from_user_balance = db_query("SELECT * FROM {ubercart_funds_user_funds} WHERE uid=" . $from_user->uid)->fetchAssoc();
  $from_user_balance['balance'] -= $transfer_amount;

  $exists = db_query("SELECT * FROM {ubercart_funds_user_funds} WHERE uid=" . $to_user['uid'])->fetchAssoc();

  if (!$exists) {
    $user_balance = new stdClass();
    $user_balance->uid = $to_user['uid'];
    $user_balance->balance = 0;
    drupal_write_record('ubercart_funds_user_funds', $user_balance);
  }

  drupal_write_record('ubercart_funds_user_funds', $from_user_balance, 'uid');
  drupal_write_record('ubercart_funds_transactions', $transaction);

  drupal_set_message(t('Escrow Payment Created Successfully'), 'status');
}

function ubercart_funds_transfer_funds_form($form, &$form_state) {

  $form['amount'] = array(
      '#type' => 'textfield',
      '#title' => t('Amount to transfer (' . variable_get('uc_curreny_code', 'USD')/*commerce_default_currency()*/ . ')'),
      '#description' => t('Please enter the amount you wish to transfer in ' . variable_get('uc_curreny_code', 'USD')/*commerce_default_currency()*/),
      '#default_value' => '',
      '#size' => 30,
      '#maxlength' => 128,
      '#required' => TRUE,
  );

  $form['email'] = array(
      '#type' => 'textfield',
      '#title' => t('Transfer To'),
      '#description' => t('Please enter the email of the user you want to transfer the funds to'),
      '#default_value' => '',
      '#size' => 30,
      '#maxlength' => 128,
      '#required' => TRUE,
  );

  $form['notes'] = array(
      '#type' => 'textarea',
      '#title' => t('Notes'),
      '#description' => '',
  );

  $form['submit'] = array(
      '#type' => 'submit',
      '#value' => t('Transfer Funds'),
  );

  return $form;
}

function ubercart_funds_transfer_funds_form_validate($form, &$form_state) {

  global $user;

  if (!is_numeric($form_state['values']['amount'])) {
    form_set_error('amount', t('Value must be Numeric'));
    return FALSE;
  }

  if (is_numeric($form_state['values']['amount']) && !(floatval($form_state['values']['amount']) > 0)) {
    form_set_error('amount', t('Value must be greater than 0'));
    return FALSE;
  }

  if (!filter_var($form_state['values']['email'], FILTER_VALIDATE_EMAIL)) {
    form_set_error('email', t('Please enter a valid email'));
    return FALSE;
  }

  $exists = db_query("SELECT * FROM {users} WHERE mail='" . $form_state['values']['email'] . "'")->fetchAssoc();

  if (!$exists) {
    form_set_error('email', t('We have no record of users with the email') . ' ' . $form_state['values']['email']);
    return FALSE;
  }

  $user_balance = db_query("SELECT * FROM {ubercart_funds_user_funds} WHERE uid=" . $user->uid)->fetchAssoc();

  if ($user_balance['balance'] < intval($form_state['values']['amount'] * 100)) {
    form_set_error('amount', t("You don't have enough funds to cover this transfer"));
    return FALSE;
  }
}

function ubercart_funds_transfer_funds_form_submit($form, &$form_state) {

  global $user;

  $from_user = $user;
  $to_user = db_query("SELECT * FROM {users} WHERE mail='" . $form_state['values']['email'] . "'")->fetchAssoc();

  $commissions = variable_get('ubercart_funds_commissions', array());
  

  $commission = array_key_exists('transfer', $commissions) ? $commissions['transfer'] : 0;
  $commission_fixed = array_key_exists('transfer', $commissions) ? $commissions['transfer_fixed'] : 0;

  $transfer_amount = intval($form_state['values']['amount'] * 100.0);

  $transfer_after_commission = intval($form_state['values']['amount'] * 100.0) * (1.0 - $commission / 100.0);
  $transfer_after_commission_fixed = $transfer_amount - $commission;

  $transaction = new stdClass();

  $transaction->uid = $from_user->uid;
  $transaction->type = 'Transfer';
  $transaction->reference = $to_user['uid'];
  $transaction->created = time();
  $transaction->amount = $transfer_amount;
  $transaction->notes = $form_state['values']['notes'];

  $from_user_balance = db_query("SELECT * FROM {ubercart_funds_user_funds} WHERE uid=" . $from_user->uid)->fetchAssoc();
  $from_user_balance['balance'] -= $transfer_amount;

  $exists = db_query("SELECT * FROM {ubercart_funds_user_funds} WHERE uid=" . $to_user['uid'])->fetchAssoc();

  if (!$exists) {
    $user_balance = new stdClass();
    $user_balance->uid = $to_user['uid'];
    $user_balance->balance = 0;
    drupal_write_record('ubercart_funds_user_funds', $user_balance);
  }

  $to_user_balance = db_query("SELECT * FROM {ubercart_funds_user_funds} WHERE uid=" . $to_user['uid'])->fetchAssoc();
  $to_user_balance['balance'] += min(array($transfer_after_commission, $transfer_after_commission_fixed));

  drupal_write_record('ubercart_funds_user_funds', $from_user_balance, 'uid');
  drupal_write_record('ubercart_funds_user_funds', $to_user_balance, 'uid');
  drupal_write_record('ubercart_funds_transactions', $transaction);

  drupal_set_message(t('Transfer Successful'), 'status');
}

function ubercart_funds_configure_withdraw_methods() {
  return drupal_get_form('ubercart_funds_configure_withdraw_methods_form');
}

function ubercart_funds_configure_withdraw_methods_form($form, &$form_state) {

  $methods = ubercart_funds_get_withdrawal_methods();

  $values = variable_get('ubercart_funds_withdrawal_methods', array());

  $form['methods'] = array(
      '#type' => 'checkboxes',
      '#options' => $methods,
      '#default_value' => $values,
      '#title' => t('Choose Payment methods allowed for withdrawals'),
      '#required' => TRUE,
  );

  $form['submit'] = array(
      '#type' => 'submit',
      '#value' => t('Save Configurations'),
  );

  return $form;
}

function ubercart_funds_configure_withdraw_methods_form_submit($form, &$form_state) {
  variable_set('ubercart_funds_withdrawal_methods', $form_state['values']['methods']);
}

function ubercart_funds_manage_withdrawal_methods() {

  $methods = ubercart_funds_get_enabled_withdrawal_methods();

  foreach ($methods as $key => $value) {
    $methods[$key] = l($methods[$key], 'user/funds/manage/withdrawal-methods/' . $key);
  }

  return theme('item_list', array('items' => $methods, 'type' => 'ul'));
}

function ubercart_funds_manage_withdrawal_method_paypal($form, &$form_state) {

  $enabled_methods = variable_get('ubercart_funds_withdrawal_methods', array());

  if (!$enabled_methods['paypal'])
    return FALSE;

  global $user;

  $form['paypal_email'] = array(
      '#type' => 'textfield',
      '#title' => t('Paypal Email'),
      '#description' => t('Withdrawals using Paypal will be sent to this email'),
      '#default_value' => $user->data && array_key_exists('paypal', $user->data) ? $user->data['paypal']['paypal_email'] : '',
      '#size' => 40,
      '#maxlength' => 64,
      '#required' => TRUE,
  );

  $form['submit'] = array(
      '#type' => 'submit',
      '#value' => t('Save'),
  );

  return $form;
}

function ubercart_funds_manage_withdrawal_method_paypal_submit($form, &$form_state) {

  global $user;

  user_save($user, array('data' => array('paypal' => $form_state['values'])));
}

function ubercart_funds_manage_withdrawal_method_skrill($form, &$form_state) {

  $enabled_methods = variable_get('ubercart_funds_withdrawal_methods', array());

  if (!$enabled_methods['skrill'])
    return FALSE;

  global $user;

  $form['skrill_email'] = array(
      '#type' => 'textfield',
      '#title' => t('Skrill Email'),
      '#description' => t('Withdrawals using Skrill will be sent to this email'),
      '#default_value' => $user->data && array_key_exists('skrill', $user->data) ? $user->data['skrill']['skrill_email'] : '',
      '#size' => 40,
      '#maxlength' => 64,
      '#required' => TRUE,
  );

  $form['submit'] = array(
      '#type' => 'submit',
      '#value' => t('Save'),
  );

  return $form;
}

function ubercart_funds_manage_withdrawal_method_skrill_submit($form, &$form_state) {

  global $user;

  user_save($user, array('data' => array('skrill' => $form_state['values'])));
}

function ubercart_funds_manage_withdrawal_method_bank_account($form, &$form_state) {

  include_once DRUPAL_ROOT . '/includes/locale.inc';

  $enabled_methods = variable_get('ubercart_funds_withdrawal_methods', array());

  if (!$enabled_methods['bank_account'])
    return FALSE;

  global $user;

  $form['account_name'] = array(
      '#type' => 'textfield',
      '#title' => t('Name of Account Holder'),
      '#description' => t(''),
      '#default_value' => $user->data && array_key_exists('bank_account', $user->data) ? $user->data['bank_account']['account_name'] : '',
      '#size' => 40,
      '#maxlength' => 128,
      '#required' => TRUE,
  );

  $form['account_number'] = array(
      '#type' => 'textfield',
      '#title' => t('Account Number / IBAN'),
      '#description' => t(''),
      '#default_value' => $user->data && array_key_exists('bank_account', $user->data) ? $user->data['bank_account']['account_number'] : '',
      '#size' => 40,
      '#maxlength' => 128,
      '#required' => TRUE,
  );

  $form['bank_name'] = array(
      '#type' => 'textfield',
      '#title' => t('Bank Name'),
      '#description' => t(''),
      '#default_value' => $user->data && array_key_exists('bank_account', $user->data) ? $user->data['bank_account']['bank_name'] : '',
      '#size' => 40,
      '#maxlength' => 128,
      '#required' => TRUE,
  );

  $form['bank_country'] = array(
      '#type' => 'select',
      '#title' => t('Bank Country'),
      '#options' => country_get_list(),
      '#default_value' => $user->data && array_key_exists('bank_account', $user->data) ? $user->data['bank_account']['bank_country'] : '',
      '#description' => t(''),
      '#required' => TRUE,
  );

  $form['swift_code'] = array(
      '#type' => 'textfield',
      '#title' => t('Swift Code'),
      '#description' => t(''),
      '#default_value' => $user->data && array_key_exists('bank_account', $user->data) ? $user->data['bank_account']['swift_code'] : '',
      '#size' => 40,
      '#maxlength' => 128,
      '#required' => TRUE,
  );

  $form['bank_address'] = array(
      '#type' => 'textfield',
      '#title' => t('Bank Address'),
      '#description' => t(''),
      '#default_value' => $user->data && array_key_exists('bank_account', $user->data) ? $user->data['bank_account']['bank_address'] : '',
      '#size' => 40,
      '#maxlength' => 128,
      '#required' => TRUE,
  );

  $form['bank_address2'] = array(
      '#type' => 'textfield',
      '#title' => t('Bank Address 2'),
      '#description' => t(''),
      '#default_value' => $user->data && array_key_exists('bank_account', $user->data) ? $user->data['bank_account']['bank_address2'] : '',
      '#size' => 40,
      '#maxlength' => 128,
  );

  $form['bank_city'] = array(
      '#type' => 'textfield',
      '#title' => t('Bank City'),
      '#description' => t(''),
      '#default_value' => $user->data && array_key_exists('bank_account', $user->data) ? $user->data['bank_account']['bank_city'] : '',
      '#size' => 20,
      '#maxlength' => 128,
      '#required' => TRUE,
  );

  $form['bank_province'] = array(
      '#type' => 'textfield',
      '#title' => t('Bank Province'),
      '#description' => t(''),
      '#default_value' => $user->data && array_key_exists('bank_account', $user->data) ? $user->data['bank_account']['bank_province'] : '',
      '#size' => 20,
      '#maxlength' => 128,
      '#required' => TRUE,
  );

  $form['bank_postalcode'] = array(
      '#type' => 'textfield',
      '#title' => t('Bank Postal Code'),
      '#description' => t(''),
      '#default_value' => $user->data && array_key_exists('bank_account', $user->data) ? $user->data['bank_account']['bank_postalcode'] : '',
      '#size' => 20,
      '#maxlength' => 128,
      '#required' => TRUE,
  );

  $form['submit'] = array(
      '#type' => 'submit',
      '#value' => t('Save'),
  );

  return $form;
}

function ubercart_funds_manage_withdrawal_method_bank_account_submit($form, &$form_state) {

  global $user;

  user_save($user, array('data' => array('bank_account' => $form_state['values'])));
}

function ubercart_funds_manage_withdrawal_method_check($form, &$form_state) {

  $enabled_methods = variable_get('ubercart_funds_withdrawal_methods', array());

  if (!$enabled_methods['check'])
    return FALSE;

  global $user;

  $form['check_name'] = array(
      '#type' => 'textfield',
      '#title' => t('Full Name'),
      '#description' => t('Full Name to write the Check to'),
      '#default_value' => $user->data && array_key_exists('check', $user->data) ? $user->data['check']['check_name'] : '',
      '#size' => 40,
      '#maxlength' => 128,
      '#required' => TRUE,
  );

  $form['check_address'] = array(
      '#type' => 'textfield',
      '#title' => t('Address'),
      '#description' => t('Detailed address to send the check to'),
      '#default_value' => $user->data && array_key_exists('check', $user->data) ? $user->data['check']['check_address'] : '',
      '#size' => 60,
      '#maxlength' => 128,
      '#required' => TRUE,
  );

  $form['check_address2'] = array(
      '#type' => 'textfield',
      '#title' => t('Address 2'),
      '#description' => t('Detailed address to send the check to'),
      '#default_value' => $user->data && array_key_exists('check', $user->data) ? $user->data['check']['check_address2'] : '',
      '#size' => 60,
      '#maxlength' => 128,
  );

  $form['submit'] = array(
      '#type' => 'submit',
      '#value' => t('Save'),
  );

  return $form;
}

function ubercart_funds_manage_withdrawal_method_check_submit($form, &$form_state) {

  global $user;

  user_save($user, array('data' => array('check' => $form_state['values'])));
}

function ubercart_funds_get_enabled_withdrawal_methods() {

  $methods = ubercart_funds_get_withdrawal_methods();

  $enabled_methods = variable_get('ubercart_funds_withdrawal_methods', array());

  foreach ($enabled_methods as $key => $value) {
    if (!$value)
      unset($methods[$key]);
  }

  return $methods;
}

function ubercart_funds_get_withdrawal_methods() {

  $methods = array(
      'paypal' => 'Paypal',
      'skrill' => 'Skrill',
      'bank_account' => 'Bank Account',
      'check' => 'Check'
  );

  return $methods;
}

function ubercart_funds_mail($key, &$message, $params) {

  $message['headers']['MIME-Version'] = '1.0';
  $message['headers']['Content-Type'] = 'text/html; charset=UTF-8; format=flowed';
  $message['headers']['Content-Transfer-Encoding'] = '8Bit';

  if ($key == 'escrow_cancel_from') {
    $message['subject'] = token_replace('Escrow Payment at [site:name] was Cancelled');
    $message['body'][] = theme('escrow_cancel_from', array('transaction' => $params['transaction']));
  }
  elseif ($key == 'escrow_cancel_to') {

    $message['subject'] = token_replace('Escrow Payment at [site:name] was Cancelled');
    $message['body'][] = theme('escrow_cancel_to', array('transaction' => $params['transaction']));
  }
}