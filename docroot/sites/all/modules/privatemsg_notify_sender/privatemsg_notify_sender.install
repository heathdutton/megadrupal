<?php

/**
 * @file
 * Installation routines for privatemsg_notify_sender module.
 */

/**
 * Implements hook_install().
 */
function privatemsg_notify_sender_install() {
  _privatemsg_notify_sender_set_weight();
}

/**
 * Implements hook_uninstall().
 */
function privatemsg_notify_sender_uninstall() {
  db_delete('variable')
    ->condition('name', 'privatemsg_notify_sender_%', 'LIKE')
    ->execute();
  cache_clear_all('variables', 'cache_bootstrap');
}

/**
 * Implements hook_schema().
 */
function privatemsg_notify_sender_schema() {
  return array(
    'pm_notify_sender' => array(
      'description' => 'Whether users want to show their email address in private message notifications.',
      'fields' => array(
        'uid' => array(
          'type' => 'int',
          'unsigned' => TRUE,
          'not null' => TRUE,
          'description' => 'Primary Key: Unique user ID.',
          'default' => 0,
        ),
        'show_sender_mail' => array(
          'type' => 'int',
          'size' => 'tiny',
          'unsigned' => TRUE,
          'description' => 'Status flag. Treated as boolean.',
        ),
      ),
      'foreign keys' => array(
        'users' => array(
          'table' => 'users',
          'columns' => array('uid' => 'uid'),
        ),
      ),
      'primary key' => array('uid'),
    ),
  );
}

/**
 * Adjust the module's weight.
 */
function _privatemsg_notify_sender_set_weight() {
  // Make sure we will be run after the pm_email_notify.module:
  $weight = db_select('system')
    ->fields('system', array('weight'))
    ->condition('name', 'pm_email_notify', '=')
    ->condition('type', 'module', '=')
    ->execute()
    ->fetchField();
  $weight ++;
  db_update('system')
    ->fields(array(
      'weight' => $weight,
    ))
    ->condition('name', 'privatemsg_notify_sender', '=')
    ->execute();
}

/**
 * Change "hide sender mail" option to "show sender mail" and convert
 * configuration and user data.
 */
function privatemsg_notify_sender_update_7101() {
  db_add_field('pm_notify_sender', 'show_sender_mail', array(
    'type' => 'int',
    'size' => 'tiny',
    'unsigned' => TRUE,
    'description' => 'Status flag. Treated as boolean.',
  ));
  // We will only convert users who have set their value.
  // These with "NULL" stick to global defaults.
  // @todo: Instruct site admins to notify their users.
  db_update('pm_notify_sender')
    ->fields(array('show_sender_mail' => 1))
    ->condition('hide_sender_mail', '0', '=')
    ->execute();
  db_update('pm_notify_sender')
    ->fields(array('show_sender_mail' => 0))
    ->condition('hide_sender_mail', '0', '>')
    ->execute();
  // Remove the old field.
  db_drop_field('pm_notify_sender', 'hide_sender_mail');

  // Change system default variable.
  variable_set('privatemsg_setting_show_sender_mail', !variable_get('privatemsg_notify_sender_hide_sender_mail', 1));
  variable_del('privatemsg_notify_sender_hide_sender_mail');
}
