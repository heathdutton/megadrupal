<?php

/**
 * @file
 * Magento password module.
 */

/**
 * Implements hook_form_alter().
 */
function magento_password_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'user_admin_settings') {

    $fieldset = array(
      '#type'  => 'fieldset',
      '#title' => t('Magento security'),
    );

    $fieldset['magento_password'] = array(
      '#type'          => 'select',
      '#title'         => t('Password algorithm'),
      '#default_value' => (variable_get('magento_password', FALSE) ? 1 : 0),
      '#options'       => array(
        0 => t('Standard (sha512)'),
        1 => t('Magento (md5 + salt)'),
      ),
      '#description'   => t(
        "<strong>Change this value only if you are aware of each repercussion.</strong><br/>Use the 'Magento' algorithm will impact all new generated password.<br/>If you planned to disable 'Magento Password' module, any password generate with this algorithm won't be usable anymore."
      ),
    );

    if ($temp = _magento_password_array_insert_after('personalization', $form, 'magento', $fieldset)) {
      $form = $temp;
    }

    $form['#submit'][] = 'magento_password_user_admin_settings_submit';
  }
}

/*
 * Inserts a new key/value after the key in the array.
 *
 * @param $key
 *   The key to insert after.
 * @param $array
 *   An array to insert in to.
 * @param $new_key
 *   The key to insert.
 * @param $new_value
 *   An value to insert.
 *
 * @return
 *   The new array if the key exists, FALSE otherwise.
 *
 * @see array_insert_before()
 */
function _magento_password_array_insert_after($key, array &$array, $new_key, $new_value) {
  if (array_key_exists($key, $array)) {
    $new = array();
    foreach ($array as $k => $value) {
      $new[$k] = $value;
      if ($k === $key) {
        $new[$new_key] = $new_value;
      }
    }

    return $new;
  }

  return FALSE;
}

/**
 * Implements hook_form_submit().
 */
function magento_password_user_admin_settings_submit($form_id, &$form_state) {
  // Set 'magento_password' variable for 'user_hash_password' function.
  if (isset($form_state['values']['magento_password'])) {
    variable_set('magento_password', $form_state['values']['magento_password'] == 1);
  }
}
