<?php
/**
 * @file wiredocs_field_permissions.module
 * Checks whether a user has editing access to a certain node field.
 */

/**
 * Implements hook_wiredocs_access().
 * 
 * Checks node and field access. This hook relies on the function file_get_file_references()
 * which returns something like this:
 * 
 * array(1) {
 *   ["field_file"]=> array(1) {
 *     ["node"]=> array(1) {
 *       [2]=> object(stdClass)#83 (3) {
 *         ["nid"] => string(1) "2"
 *         ["vid"] => string(1) "2"
 *         ["type"] => string(4) "file"
 *     }
 *   }
 * }
 * 
 * @param $op
 *   file operation
 * @param $file
 *   file object
 * @return boolean
 *   boolean if access is granted
 */
function wiredocs_field_permissions_wiredocs_access($op, $file) {
  switch ($op) {
  	case 'download': // treat operations equally 
  	case 'upload':
  	  $refs = file_get_file_references($file); // get all fields where the file is referenced
  	  foreach ($refs as $field_name => $entities) {
  	    foreach ($entities['node'] as $node) { // get only the node field
  	     $field = field_read_field($field_name);
  	     // check node access, as well ass field access
  	     $access = node_access('update', $node->nid) && field_access('edit', $field, $node->type);
  	     if (!$access) return $access;
  	    }
  	  }
  	  return TRUE;
  	default:
  	  return FALSE;
  }
}