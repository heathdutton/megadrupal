<?php
/**
 * @file
 * Main file for Waveform module.
 */

/**
 * Implements hook_menu().
 */
function waveform_menu() {
  $items= array();

  $items['admin/config/media/waveform'] = array(
    'title' => 'Waveform',
    'description' => 'Manage Waveform settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('waveform_settings_form'),
    'access arguments' => array('administer site configuration'),
    'file' => 'waveform.admin.inc',
  );
  $items['admin/config/media/waveform/settings'] = array(
    'title' => 'Settings',
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  $items['admin/config/media/waveform/batch'] = array(
    'title' => 'Batch',
    'description' => 'Update generated waveforms.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('waveform_update_waveform_form'),
    'access arguments' => array('administer site configuration'),
    'file' => 'waveform.admin.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 10,
  );

  return $items;
}

/**
 * Implements hook_file_insert().
 */
function waveform_file_insert($file) {
  waveform_generate_waveform_image($file);
}

/**
 * Implements hook_file_update().
 */
function waveform_file_update($file) {
  waveform_generate_waveform_image($file);
}

/**
 * Implements hook_file_move().
 */
function waveform_file_move($file, $source) {
  waveform_generate_waveform_image($file);
}

/**
 * Implements hook_file_delete().
 */
function waveform_file_delete($file) {
  waveform_remove_waveform_image($file);
}

function waveform_generate_waveform_image($file) {
  //watchdog('waveform', print_r($file, 1));
  if ($file->filemime = 'audio/mpeg' && $file->status == 1) {
    $scheme = file_uri_scheme($file->uri);
    $target = file_uri_target($file->uri);
    $file_path = drupal_realpath($file->uri);
    $decoded_path = drupal_realpath(file_directory_temp()) . '/' . drupal_basename($target) . '.wav';

    $command = variable_get('waveform_lame_path', 'lame') . ' --decode "' . $file_path . '" "' . $decoded_path . '"';
    shell_exec($command);

    if (file_exists($decoded_path)) {
      $image_uri = $scheme . '://waveform/' . $target . '.png';
      $directory = drupal_dirname($image_uri);
      if (!file_prepare_directory($directory, FILE_CREATE_DIRECTORY)) {
        watchdog('waveform', 'Failed to create waveform directory: %directory', array('%directory' => $directory), WATCHDOG_ERROR);
      }
      $image_path = drupal_realpath($image_uri);
      $command = variable_get('waveform_wav2png_path', 'wav2png')
               . ' --foreground-color=' . variable_get('waveform_wav2png_foreground_color', '508fa200')
               . ' --background-color=' . variable_get('waveform_wav2png_background_color', 'f4f4f4ff')
               . ' -o "' . $image_path . '" "' . $decoded_path . '"';
      shell_exec($command);
      if (!file_exists($image_path)) {
        watchdog('waveform', 'Command failed: ' . $command);
      }
      unlink($decoded_path);
    }
    else {
      watchdog('waveform', 'Command failed: ' . $command);
    }
  }
}

function waveform_remove_waveform_image($file) {
  $scheme = file_uri_scheme($file->uri);
  $target = file_uri_target($file->uri);
  $image_uri = $scheme . '://waveform/' . $target . '.png';
  if (file_exists($image_uri)) {
    unlink($image_uri);
  }
}
