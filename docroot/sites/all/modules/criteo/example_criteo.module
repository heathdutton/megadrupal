<?php
/**
 * @file
 * example_criteo.module
 *
 * Implements Criteo event tracking.
 * @see criteo.module
 *
 * This example imagines an ecommerce module which represents products as
 * Drupal nodes with the node type 'product.' There is assumed to be a
 * cart/basket/check-out form called 'example_cart' and a hook_order_complete
 * that fires at the end of the purchase process. Your ecommerce solution is
 * likely very different, so so you will probably need to use different hooks
 * to add your product information.
 */

/**
 * Implements hook_node_view().
 */
function example_criteo_node_view($node) {
  if ($node->type === 'product') {
    // Are we viewing a product page?
    if ($node == menu_get_object()) {
      _criteo_events(array('event' => 'viewItem', 'product' => $node->nid));
    }
    else {
      _criteo_view_list($node->nid);
    }
  }
}


/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Set the Criteo 'viewBasket' event.
 */
function example_criteo_form_example_cart_alter(&$form) {
  $items= $form['#cart_items'];

  $products = array();
  foreach ($items as $node) {
    $products[] = array(
        'id' => $node->nid,
        'price' => $node->price,
        'quantity' => $node->qty,
    );
  }

  _criteo_events(array(
    'event' => 'viewBasket',
    'product' => $products,
  ));
}

/**
 * Implements hook_example_order_complete().
 *
 * Set the Criteo 'trackTransaction' conversion event.
 */
function example_criteo_example_order_complete($order) {
  $items= $order['#cart_items'];

  $products = array();
  foreach ($items as $node) {
    $products[] = array(
        'id' => $node->nid,
        'price' => $node->price,
        'quantity' => $node->qty,
    );
  }

  _criteo_events(array(
    'event' => 'trackTransaction',
    'id' => $order['id'],
    'product' => $products,
  ));
}
