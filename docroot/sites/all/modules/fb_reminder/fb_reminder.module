<?php

define('FB_REMINDER_FORM_PHP_FILTER', 2);

/* Internal functions */
require_once 'includes/fb_reminder.internal.inc';

/**
 * Implements hook_permission().
 */
function fb_reminder_permission() {
  $items = array();

  $items['fb_reminder_admin'] = array(
    'title' => t('Administer FB Reminder'),
    'description' => t('Perform administration tasks for FB Reminder.'),
  );

  return $items;
}

/**
 * Implements hook_menu().
 */
function fb_reminder_menu() {
  $items = array();
  $module_path = drupal_get_path('module', 'fb_reminder');

  $items['admin/config/services/fb-reminder'] = array(
    'title' => 'FB Reminder settings',
    'description' => t('FB Reminder administration page.'),
    'page callback' => 'fb_reminder_admin_page',
    'access arguments' => array('fb_reminder_admin'),
    'file path' => $module_path . '/includes',
    'file' => 'fb_reminder.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );
  $items['fb-reminder/%ctools_js'] = array(
    'title' => 'Facebook reminder',
    'page callback' => 'fb_reminder_reminder_page',
    'page arguments' => array(1),
    'access arguments' => array('access content'),
    'file' => 'includes/fb_reminder.page.inc',
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implements hook_theme().
 */
function fb_reminder_theme($existing, $type, $theme, $path) {
  $themes = array();

  $themes['fb_reminder_message'] = array(
    'variables' => array('message' => NULL, 'connect' => NULL, 'close' => NULL),
    'path' => $path . '/theme/templates',
    'template' => 'fb_reminder_message',
  );

  return $themes;
}

/**
 * Implements hook_preprocess_HOOK() (HOOK = page).
 */
function fb_reminder_preprocess_page(&$vars) {
  // React with the modal
  // Add modal components
  ctools_include('ajax');
  ctools_include('modal');
  ctools_modal_add_js();

  $message = _fb_reminder_get_message();
  if ($message) {
    global $user;
    $is_visibility = _fb_reminder_check_conditionals($user, $_GET['q']);
    if ($is_visibility) {
      $redirect_uri = url('user/'. $user->uid . '/edit/fb-post/redirect-code', array('absolute' => TRUE));
      $settings = array(
        'fbReminder' => array(
          'path' => 'fb-reminder/ajax',
          'redirect' => $redirect_uri,
        )
      );
      drupal_add_js($settings, 'setting');

      $module_path = drupal_get_path('module', 'fb_reminder');
      drupal_add_js($module_path . '/theme/js/fb_reminder.popup.js');
      drupal_add_css($module_path . '/theme/css/fb_reminder.popup.css');

      // Create our own javascript that will be used to theme a modal.
      $fbReminder = array(
        'CToolsFBReminderModal' => array(
          'modalSize' => array(
            'type' => 'fixed',
            'width' => 480,
            'height' => 90,
            'addWidth' => 15,
            'addHeight' => 50,
            'contentRight' => 0,
            'contentBottom' => 0,
            'closeText' => t('Cancel'),
          ),
          'modalOptions' => array(
            'opacity' => .5,
            'background-color' => '#000',
          ),
          'animation' => 'fadeIn',
          'modalTheme' => 'CToolsFBReminderModal',
          'throbber' => theme('image', array('path' => ctools_image_path('ajax-loader.gif', 'ctools_ajax_sample'), 'alt' => t('Loading...'), 'title' => t('Loading'))),
        ),
      );

      drupal_add_js($fbReminder, 'setting');
    }
  }
}
