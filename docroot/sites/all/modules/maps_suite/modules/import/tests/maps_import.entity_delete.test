<?php

/**
 * @file
 * Tests suite for the automated entity delete process related to
 * MaPS Import module.
 */

/**
 * Performs functional tests on MaPS Import generated entities
 *
 * @see DrupalWebTestCase
 */
class MapsImportEntityDeleteWebTestCase extends MapsImportWebTestCase {

  /**
   * SimpleTest getInfo.
   * @inheritdoc
   */
  public static function getInfo() {
    return array(
      'name' => 'MaPS Import Entity Delete',
      'description' => "Tests the automated deletion of generated entities.",
      'group' => MapsSuiteTestInterface::TEST_GROUP,
    );
  }

  /**
   * Test the deletion of an object converter.
   */
  public function testDeleteObjectConverter() {
    // The automated deletion is triggered when we
    // want to delete a converter.
    $profile = $this->createProfile();
    $this->createLanguages($profile);

    // Create a random converter.
    $converter = $this->createConverter($profile, 'object', array('entity_type' => 'node'));

    // Now, create some custom Drupal entities, as if
    // they have been created by MaPS Suite.
    // We have to distinct two type of entities:
    // Commerce product entities, and all the others.
    // Create a random node.
    $node = new stdClass();
    $node->type = $this->randomName(8);
    node_save($node);

    // Create the entry in database.
    $this->createEntityEntry($profile->getPid(), $converter->getCid(), 'node', $node->type, rand(0, 100), $node->nid);

    $this->drupalGet('admin/maps-suite/profiles/' . $profile->getName() . '/object/' . $converter->getCid() . '/delete');
    $this->assertResponse(200);
    $this->assertRaw(t('Are you sure you want to delete the converter %title ?', array('%title' => $converter->getTitle())), 'Title correctly set.');

    // Assert that the node still exists at this moment.
    $entity = entity_load('node', array($node->nid));
    $this->assertTrue(!empty($entity), 'Entity exists.');

    // Try deleting with the "delete entities" process.
    $edit = array(
      'mode' => 'delete',
    );
    $this->drupalPost('admin/maps-suite/profiles/' . $profile->getName() . '/object/' . $converter->getCid() . '/delete', $edit, t('Delete'));
    $this->assertResponse(200);
    $this->assertRaw(t('The converter @title was successfully deleted!', array('@title' => $converter->getTitle())), 'The converter has been succesfully deleted.');

    $this->drupalGet('admin/maps-suite/profiles/' . $profile->getName() . '/object');
    $this->assertResponse(200);
    $this->assertNoRaw($converter->getTitle(), 'The converter is not shown in the overview list.');

    $entity = entity_load('node', array($node->nid), array(), TRUE);
    $this->assertTrue(empty($entity), 'Entity not exists anymore.');
  }

}
