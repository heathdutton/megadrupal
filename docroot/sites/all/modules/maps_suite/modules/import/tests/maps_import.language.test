<?php

/**
 * @file
 * Tests suite for Languages related to MaPS Import module.
 */

/**
 * Performs functional tests on MaPS Import / Languages.
 *
 * @see DrupalWebTestCase
 */
class MapsImportLanguageWebTestCase extends MapsImportWebTestCase {

  /**
   * SimpleTest getInfo.
   * @inheritdoc
   */
  public static function getInfo() {
    return array(
      'name' => 'MaPS Import Language',
      'description' => 'Tests the language assignement.',
      'group' => MapsSuiteTestInterface::TEST_GROUP,
    );
  }

  /**
   * Test the tab access.
   *
   * Tests if the tab is visible or not, according to the existence
   * of language in the MaPS System® configuration.
   */
  public function testTabAccess() {
    $profile = $this->createProfile();

    $this->drupalGet('admin/maps-suite/profiles/' . $profile->getName() . '/languages');
    $this->assertResponse(403, 'The langauge tab does not appear because there is no language imported');

    $this->createLanguages($profile);

    $this->drupalGet('admin/maps-suite/profiles/' . $profile->getName() . '/languages');
    $this->assertResponse(200);

    // Check if there is languages in the MaPS System® configuration.
    $this->assertNoRaw(t('No language was found in the MaPS System® configuration.'), 'Existing configuration: passed.');
  }

  /**
   * Test the language settings form.
   */
  public function testSettingsForm() {
    $profile = $this->createProfile();
    $langcodes = array_keys($this->createLanguages($profile, 4));

    $keys = array();
    for ($i = 1; $i <= 4; $i++) {
      $keys[] = 'maps_import:languages:' . $profile->getPid() . '[' . $i . ']';
    }

    $tests = array(
      'success' => array(
        array_values($langcodes),
        array('', $langcodes[3], '', ''),
      ),
      'failure' => array(
        array($langcodes[0], $langcodes[1], $langcodes[1], $langcodes[3]),
      ),
    );

    foreach ($tests as $type => $test) {
      $message = $type === 'success' ? t('The configuration options have been saved.') : t('Each Drupal language should only be mapped once.');

      foreach ($test as $values) {
        $edit = array_combine($keys, $values);
        $this->verbose(serialize($values));
        $this->drupalPost('admin/maps-suite/profiles/' . $profile->getName() . '/languages', $edit, t('Save configuration'));
        $this->assertResponse(200);
        $this->assertText($message);
      }
    }
  }
}
