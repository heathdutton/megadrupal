<?php
/**
 * @file
 * System Analytics woopra.
 */

/**
 * Implements hook_help().
 */
function woopra_analytics_help($path, $arg) {
  switch ($path) {
    case 'admin/help#woopra-analytics':
      return '<p>' . t('Woopra documentation.') . '</p>';
      break;

    case 'admin/condif/system/woopra-analytics':
      return '<p>' . t('Woopra Analytics Control Panel.') . '</p>';

      break;
  }
}

/**
 * Implements hook_menu().
 */
function woopra_analytics_menu() {
  $items = array();

  $items['admin/config/system/woopra-analytics'] = array(
    'title'            => 'Woopra Analytics',
    'description'      => 'Control panel setup',
    'page callback'    => 'drupal_get_form',
    'page arguments'   => array('woopra_analytics_control_panel_form'),
    'access arguments' => array('admin woopra analytics control panel'),
    'file'             => 'woopra_analytics.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function woopra_analytics_permission() {
  return array(
    'admin woopra analytics control panel' => array(
      'title'       => t('Administer woopra analytics settings'),
      'description' => t('Give access to the Control Panel area.')
    ),
  );
}

/**
 * Implements hook_page_alter().
 */
function woopra_analytics_page_alter(&$page) {

  if (!path_is_admin(current_path()) && variable_get('woopra_analytics_switch', 0)) {
    $domain = variable_get('woopra_analytics_domain', $_SERVER['SERVER_NAME']);

    $script = <<<EOF
<!-- Start of Woopra Code -->
(function(){
    var t,i,e,n=window,o=document,a=arguments,s="script",r=["config","track","identify","visit","push","call"],c=function(){var t,i=this;for(i._e=[],t=0;r.length>t;t++)(function(t){i[t]=function(){return i._e.push([t].concat(Array.prototype.slice.call(arguments,0))),i}})(r[t])};for(n._w=n._w||{},t=0;a.length>t;t++)n._w[a[t]]=n[a[t]]=n[a[t]]||new c;i=o.createElement(s),i.async=1,i.src="//static.woopra.com/js/w.js",e=o.getElementsByTagName(s)[0],e.parentNode.insertBefore(i,e)
})("woopra");

woopra.config({
    domain: '{$domain}'
});
woopra.track();
<!-- End of Woopra Code -->
EOF;

    drupal_add_js($script, array('scope' => 'footer', 'type' => 'inline'));
  }
}
