<?php
// Custom module to enable yolink search

/**
 * Implementation of hook_init().
 */
function yolink_init() {
    drupal_add_css(drupal_get_path('module', 'yolink') . '/yolink.css', 'module');
}

/**
 * Implementation of hook_menu().
 */
function yolink_menu() {
    $items = array();
    $items['admin/settings/yolink'] = array(
        'title' => 'yolink',
        'description' => 'Set up yolink',
        'page callback' => 'drupal_get_form',
        'page arguments' => array('yolink_settings_form'),
        'access arguments' => array('administer site configuration'),
    );
    return $items;
}

function yolink_settings_form() {
    $form = array();
    $agreed = variable_get('yolink_tos_agree', '');
    if ($agreed) {
        $apikey = variable_get('yolink_api_key', '');
        $description = t("To manage your API key please visit <a href=\"http://www.yolink.com/yolink/pricing/index.jsp?ak=").$apikey.t("\">yolink.com</a>.");
        $options = array('true' => t('Enabled'), 'false' => t('Disabled'));  
        $logos = array('http://tigerlogic.com/tigerlogic/company/legal/images/yolink_enhanced_light_back.png' => t('light'), 'http://tigerlogic.com/tigerlogic/company/legal/images/yolink_enhanced_drk_back.png' => t('dark'), 'http://tigerlogic.com/tigerlogic/company/legal/images/yolink_enhanced_inline_white.png' => t('green'));
        $preview = array('original' => t('show original link'), 'tab' => t('show cached page with pinning to result paragraphs'), 'none' => t('nothing'));
        $form['yolink_api_key'] = array(
            '#type' => 'textfield',
            '#title' => t('yolink API key'),
            '#description' => $description,
            '#default_value' => variable_get('yolink_api_key', yolink_register()),
        );
        $form['yolink_max_results'] = array(
            '#type' => 'textfield',
            '#title' => t('yolink maximum paragraphs'),
            '#description' => t('How many paragraphs containing keywords would you like to display by default?'),
            '#default_value' => variable_get('yolink_max_results', '4'),
        );
        $form['yolink_show_share'] = array(
            '#type' => 'radios',
            '#title' => t('show sharing'),
            '#default_value' =>  variable_get('yolink_show_share', 'true'),
            '#options' => $options,
            '#description' => t('Allow users to easily share search results through email or social networking.'),
        );
        $form['yolink_show_google_docs'] = array(
            '#type' => 'radios',
            '#title' => t('show google docs'),
            '#default_value' =>  variable_get('yolink_show_google_docs', 'true'),
            '#options' => $options,
            '#description' => t('Allow users to easily share search results to Google Docs.'),
        );
        $form['yolink_show_hide'] = array(
            '#type' => 'radios',
            '#title' => t('show toggle link'),
            '#default_value' =>  variable_get('yolink_show_hide', 'true'),
            '#options' => $options,
            '#description' => t('Allow users to hide and show yolink paragraphs.'),
        );
        $form['yolink_logo'] = array(
            '#type' => 'radios',
            '#title' => t('search form background color'),
            '#default_value' =>  variable_get('yolink_logo', 'light'),
            '#options' => $logos,
            '#description' => t('Set form background color so yolink logo shows appropriately.'),
        );  
        $form['yolink_preview'] = array(
            '#type' => 'radios',
            '#title' => t('what happens when user clicks paragraph'),
            '#default_value' =>  variable_get('yolink_preview', 'original'),
            '#options' => $preview,
            '#description' => t('Set form background color so yolink logo shows appropriately.'),
        );
        return system_settings_form($form);
    }
    else {
        $form['yolink_tos_agree'] = array(
            '#type' => 'checkbox',
            '#title' => t('I agree to the <a href="http://www.yolink.com/yolink/legal/yolink_plugin_API_license_agreement.jsp">yolink terms of service</a>.'),
            '#description' => t(''),
            '#default_value' => variable_get('yolink_tos_agree', ''),
        );
        return system_settings_form($form);
    }
}

function yolink_theme_registry_alter(&$theme_registry) {
    $path = drupal_get_path('module', 'yolink');  
    $theme_registry['search_results']['template'] = $path . '/search-results';
    $theme_registry['google_cse_results']['template'] = $path . '/google_cse_results';
}
function yolink_register() {
    $site_email = variable_get('site_mail', '');
    drupal_add_js('https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js');
    drupal_add_js(drupal_get_path('module', 'yolink') . '/yolink.js'); 
    drupal_add_js('$(document).ready(function() {
        getAPIKey(\'' . $site_email . '\');
    });', 'inline');
}