<?php
/**
 * @file
 * This module is meant to integrate bazaarvoice with drupal.
 *
 * This will have all hooks implementations required for the functionality.
 */

/**
 * Implements hook_init().
 */
function sn_bazaarvoice_init() {
  drupal_add_js(array('sn_bazaarvoice' => array('image_path' => drupal_get_path('module', 'sn_bazaarvoice') . '/images')), 'setting');
}

/**
 * Implements hook_perm().
 */
function sn_bazaarvoice_permission() {
  return array(
    'configure bazaarvoice' => array(
      'title' => t('Configure bazaarvoice settings.'),
      'description' => t('Make changes related to bazaarvoice API services.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function sn_bazaarvoice_menu() {
  $items = array();

  // Module configuration link.
  $items['admin/config/system/sn-bazaarvoice'] = array(
    'title' => 'Bazaarvoice configuration',
    'description' => 'Settings for bazaarvoice',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('sn_bazaarvoice_configure'),
    'access arguments' => array('configure bazaarvoice'),
  );

  return $items;
}

/**
 * This method would return configuration page.
 */
function sn_bazaarvoice_configure() {
  module_load_include('inc', 'sn_bazaarvoice', 'admin');
  return sn_bazaarvoice_getConfigurationForm();
}

/**
 * Implements hook_node_view().
 */
function sn_bazaarvoice_node_view($node, $view_mode, $langcode) {
  // Rating enabled content types.
  $selected_content_types = variable_get('sn_bazaarvoice_bzrvoice_rating_content_types');
  module_load_include('inc', 'sn_bazaarvoice', 'rating');

  // Checking if this content type is enabled for rating widget.
  if (isset($selected_content_types[$node->type]) && $selected_content_types[$node->type] === $node->type) {

    switch ($view_mode) {
      case 'teaser':
        $avg = sn_bazaarvoice_get_rating($node->nid);
        $node->content['sn_bazaarvoice_rating_widget']['sn_bazaarvoice_rating_widget'] = array(
          '#markup' => theme('sn_bazaarvoice_rating_widget', array(
            'nid' => $node->nid,
            'rating_value' => $avg,
            'full_node_class' => '',
          )
          ),
        );
        break;

      case 'full':
        global $user;
        $reviews_provided = db_query("
                SELECT nid FROM {sn_bazaarvoice_nodes_rating} WHERE nid=:nid AND uid=:uid",
                array(':nid' => $node->nid, ':uid' => $user->uid));
        $count_reviews = $reviews_provided->rowCount();

        if (!$count_reviews) {
          $node->content['sn_bazaarvoice_review_box']['sn_bazaarvoice_review_box'] = array(
            '#markup' => drupal_get_form('sn_bazaarvoice_review_form'),
          );
        }
        else {
          $node->content['sn_bazaarvoice_reviews']['sn_bazaarvoice_reviews'] = array(
            '#markup' => sn_bazaarvoice_fetch_reviews($node),
          );
        }

        break;
    }

  }

}

/**
 * Implements hook_theme().
 */
function sn_bazaarvoice_theme($theme) {
  $theme = array();

  $theme['sn_bazaarvoice_rating_widget'] = array(
    'variables' => array(
      'nid' => NULL,
      'full_node_class' => NULL,
      'rating_value' => NULL,
    ),
    'template' => 'templates/sn-bazaarvoice-rating-widget',
  );

  $theme['sn_bazaarvoice_review_box'] = array(
    'variables' => array('nid' => NULL, 'full_node_class' => NULL),
    'template' => 'templates/sn-bazaarvoice-review-box',
  );

  $theme['sn_bazaarvoice_review_item'] = array(
    'variables' => array('review' => NULL),
    'template' => 'templates/sn-bazaarvoice-review-item',
  );

  $theme['sn_bazaarvoice_reviews_list'] = array(
    'variables' => array('response' => NULL, 'nid' => NULL),
    'template' => 'templates/sn-bazaarvoice-reviews-list',
  );

  return $theme;
}

/**
 * Implements hook_preprocess().
 */
function sn_bazaarvoice_preprocesss_sn_bazaarvoice_review_box(&$variables) {

  // Creating a new variable to display form.
  $variables['review_form'] = drupal_get_form('sn_bazaarvoice_review_form');
}

/**
 * Implements hook_preprocess().
 */
function sn_bazaarvoice_preprocess_sn_bazaarvoice_reviews_list(&$variables) {
  module_load_include('inc', 'sn_bazaarvoice', 'rating');
  $reviews = drupal_json_decode($variables['reviews']->data);
  $output = '';

  if (!empty($reviews['TotalResults'])) {

    foreach ($reviews['Results'] as $result) {
      $review['title'] = check_plain($result['Title']);
      $review['author'] = check_plain($result['AuthorId']);
      $review['review_text'] = check_plain($result['ReviewText']);
      $review['rating'] = check_plain($result['Rating']);
      $review['submission'] = date('d-M-Y \a\t h:i', strtotime($result['SubmissionTime']));
      $output .= theme('sn_bazaarvoice_review_item', array(
        'review' => $review,
        'nid' => arg(1),
      )
      );
    }

    $variables['reviews_list'] = $output;
    $variables['no_reviews_available'] = '';
  }
  else {
    $variables['reviews_list'] = $output;
    $variables['no_reviews_available'] = t('No reviews available at this moment.');
  }

  // Creating a new variable to display form.
  $variables['review_form'] = drupal_get_form('sn_bazaarvoice_review_form');
}
