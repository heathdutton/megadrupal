<?php
/**
 * @file
 * Gracefully handles Devel module function calls if Devel is not available.
 *
 * Creates warning entries in Drupal's log when unavailable Devel functions are
 * called, or optionally ignores calls completely.
 */

/**
 * Creates admin/settings form.
 */
function no_devel_admin() {

  $form = array();

  $form['no_devel_show_warning_message'] = array(
    '#type' => 'checkbox',
    '#title' => t('Show administrators a warning message for Devel module
      function calls when Devel module is unavailable.'),
    '#default_value' => variable_get('no_devel_show_warning_message', 1),
    '#description' => t("Recommended."),
  );

  $form['no_devel_log_warnings'] = array(
    '#type' => 'checkbox',
    '#title' => t('Log Devel module function calls when Devel module is
      unavailable.'),
    '#default_value' => variable_get('no_devel_log_warnings', 1),
  );

  return system_settings_form($form);
}

/**
 * Implements hook_menu().
 */
function no_devel_menu() {

  $items['admin/config/development/nodevel'] = array(
    'title' => 'No Devel module settings',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('no_devel_admin'),
    'access arguments' => array('access administration pages'),
    'description' =>  'Configure No Devel settings.',
  );

  return $items;
}

/**
 * Sets warnings for Devel function calls if Devel module is not enabled.
 *
 * Only generates warnings if one or both of 'no_devel_log_warnings" and
 * 'no_devel_show_warning_message' are set to true.  If both are false,
 * Devel function calls when Devel is not enabled are effectively ignored.
 */
function no_devel_generate_warning() {

  $backtrace = debug_backtrace();

  $func = $backtrace[1]['function'];
  $line = $backtrace[1]['line'];
  $path = $backtrace[1]['file'];

  // Ensures correct slashes in server root string.
  $server_root = str_replace('/', '\\', $_SERVER['DOCUMENT_ROOT']);

  // Removes server root string from path string.
  $file = str_replace($server_root, '', $path);

  $vars = array('@func' => $func, '@file' => $file, '@line' => $line);
  $message = t('Call to undefined function @func() in @file, on line @line.
      Devel module not enabled.', $vars);

  // Sets up boolean variables for conditions.
  global $user;
  $is_admin     = in_array('administrator', array_values($user->roles));
  $show_warning = variable_get('no_devel_show_warning_message', TRUE) == TRUE;
  $log_warning  = variable_get('no_devel_log_warnings', TRUE) == TRUE;

  if ($show_warning && $is_admin) {
    drupal_set_message($message, 'warning');
  }

  if ($log_warning) {
    watchdog('No Devel', $message, NULL, WATCHDOG_WARNING);
  }
}

/**
 * Implements hook_boot().
 */
function no_devel_boot() {

  // If the following conditions are met, devel is being enabled and
  // devel.module must be preloaded to bring dpm() and related functions into
  // scope, before no_devel's "fake" versions are attempted to be declared.
  if (arg(0) == 'admin' && arg(1) == 'modules' && arg(2) == 'list' && arg(3) == 'confirm') {
    if (!module_exists('devel') && array_key_exists('devel', $_POST['modules']['Development'])) {
      if ($_POST['modules']['Development']['devel']['enable'] == 1) {
        drupal_load('module', 'devel');
      }
    }
  }

  if (!function_exists('dfb')) {
    /**
     * Declares Devel dfb() function.
     */
    function dfb() {
      no_devel_generate_warning();
    }
  }

  if (!function_exists('dfbt')) {
    /**
     * Declares Devel dfbt() function.
     */
    function dfbt() {
      no_devel_generate_warning();
    }
  }

  if (!function_exists('dcp')) {
    /**
     * Declares Devel dcp() function.
     */
    function dcp() {
      no_devel_generate_warning();
    }
  }

  if (!function_exists('dd')) {
    /**
     * Declares Devel dd() function.
     */
    function dd() {
      no_devel_generate_warning();
    }
  }

  if (!function_exists('drupal_debug')) {
    /**
     * Declares Devel drupal_debug() function.
     */
    function drupal_debug() {
      no_devel_generate_warning();
    }
  }

  if (!function_exists('dargs')) {
    /**
     * Declares Devel dargs() function.
     */
    function dargs() {
      no_devel_generate_warning();
    }
  }

  if (!function_exists('dpq')) {
    /**
     * Declares Devel dpq() function.
     */
    function dpq() {
      no_devel_generate_warning();
    }
  }

  if (!function_exists('dpm')) {
    /**
     * Declares Devel dpm() function.
     */
    function dpm() {
      no_devel_generate_warning();
    }
  }

  if (!function_exists('dvm')) {
    /**
     * Declares Devel dvm() function.
     */
    function dvm() {
      no_devel_generate_warning();
    }
  }

  if (!function_exists('dsm')) {
    /**
     * Declares Devel dsm() function.
     */
    function dsm() {
      no_devel_generate_warning();
    }
  }

  if (!function_exists('dpr')) {
    /**
     * Declares Devel dpr() function.
     */
    function dpr() {
      no_devel_generate_warning();
    }
  }

  if (!function_exists('kpr')) {
    /**
     * Declares Devel kpr() function.
     */
    function kpr() {
      no_devel_generate_warning();
    }
  }

  if (!function_exists('dvr')) {
    /**
     * Declares Devel dvr() function.
     */
    function dvr() {
      no_devel_generate_warning();
    }
  }

  if (!function_exists('kprint_r')) {
    /**
     * Declares Devel kprint_r() function.
     */
    function kprint_r() {
      no_devel_generate_warning();
    }
  }

  if (!function_exists('dprint_r')) {
    /**
     * Declares Devel dprint_r() function.
     */
    function dprint_r() {
      no_devel_generate_warning();
    }
  }

  if (!function_exists('devel_render')) {
    /**
     * Declares Devel devel_render() function.
     */
    function devel_render() {
      no_devel_generate_warning();
    }
  }

  if (!function_exists('ddebug_backtrace')) {
    /**
     * Declares Devel ddebug_backtrace() function.
     */
    function ddebug_backtrace() {
      no_devel_generate_warning();
    }
  }

  if (!function_exists('db_queryd')) {
    /**
     * Declares Devel db_queryd() function.
     */
    function db_queryd() {
      no_devel_generate_warning();
    }
  }
}
