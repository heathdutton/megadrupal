<?php

/**
 * Implements hook_menu().
 */
function entityform_email_confirmation_menu() {
  $items['eform/confirm_email'] = array(
    'title' => 'Confirm email',
    'page callback' => 'entityform_email_confirmation_page',
    'access callback' => TRUE,
    'file' => 'entityform_email_confirmation.pages.inc',
  );
  return $items;
}


/**
 * Implementation of hook_rules_event_info().
 */
function entityform_email_confirmation_rules_event_info() {
  return array(
    'entityform_email_confirmation_confirmed' => array(
      'label' => t('User visited confirmation URL'),
      'group' => t('Entityforms E-mail Confirmation'),
      'variables' => array(
        'entityform' => array(
          'label' => t('Entityform Submission'),
          'type' => 'entityform',
        ),
        'email' => array(
          'label' => t('Confirmed e-mail'),
          'type' => 'text',
        ),
      ),
    ),
  );
}


/**
 * Implements hook_rules_action_info() on behalf of the pseudo data module.
 * @see rules_core_modules()
 */
function entityform_email_confirmation_rules_action_info() {
  $return['entityform_email_confirmation_generate_url'] = array(
    'label' => t('Generate confirmation URL'),
    'group' => t('Entityforms E-mail Confirmation'),
    'parameter' => array(
      'entityform_id' => array(
        'type' => 'integer',
        'label' => t('Submission id'),
        'description' => t('Id of submission that is being confirmed.'),
      ),
      'email' => array(
        'type' => 'text',
        'label' => t('E-Mail'),
        'description' => t('E-Mail that is being confirmed.'),
      ),
    ),
    'provides' => array(
      'entityform_email_confirmation_url' => array(
        'type' => 'text',
        'label' => t('Entityform e-mail confirmation URL'),
      ),
    ),
  );
  return $return;
}

/**
 * Action: Add variable.
 */
function entityform_email_confirmation_generate_url($entityform_id, $email) {

  $hash = entityform_email_confirmation_get_hash($entityform_id, $email);
  $url = url('eform/confirm_email', array(
    'absolute' => TRUE,
    'query' => array(
      'id' => $entityform_id,
      'email' => $email,
      'hash' => $hash
    )));
  return array('entityform_email_confirmation_url' => $url);
}

/**
 * Helper function
 */
function entityform_email_confirmation_get_hash($entityform_id, $email) {
  return drupal_hash_base64($entityform_id . $email . drupal_get_hash_salt());
}

