<?php
/**
 * @file
 * This is an Example block provider for lagotto services.
 *
 * It reads the DOI to retrieve metrics from the server from a block
 * configuration variable that is site-wide stored in the block configuration,
 * and displays the results in a very simple list.
 *
 * Typically, the DOI would be stored in the article content-type, and the
 * presentation of the results would be more nuanced, possibly including
 * the metric history as a graph or chart of some sort.
 *
 * @see the file lagotto_services.test for other aspects of the API.
 */

/**
 * Implements hook_block_info().
 */
function lagotto_services_example_block_info() {
  $blocks = array();
  $blocks['lagotto_services_example_block'] = array(
    'info' => t('Lagotto services block'),
  );
  return $blocks;
}

/**
 * Implements hook_block_configure().
 */
function lagotto_services_example_block_configure($delta = '') {
  $form = array();
  if ($delta == 'lagotto_services_example_block') {
    $form['lagotto_services_example_doi'] = array(
      '#type' => 'textfield',
      '#size' => 40,
      '#title' => t('Article DOI to fetch'),
      '#description' => t(
        'The DOI of the article for which info is displayed.'),
      '#default_value' => variable_get('lagotto_services_example_doi', ''),
    );
  }
  return $form;
}

/**
 * Implements hook_block_save().
 */
function lagotto_services_example_block_save($delta = '', $edit = array()) {
  if ($delta == 'lagotto_services_example_block') {
    variable_set('lagotto_services_example_doi', $edit['lagotto_services_example_doi']);
  }
}

/**
 * Implements hook_block_view().
 */
function lagotto_services_example_block_view($delta = '') {

  $block = array();
  switch ($delta) {
    case 'lagotto_services_example_block':
      $render = lagotto_services_example_render();
      $block = array('subject' => NULL, 'content' => $render);
      break;
  }
  return $block;
}

/**
 * Render function for new block.
 *
 * @return string
 *   Block contents as renderable string or array.
 */
function lagotto_services_example_render() {
  $doi = variable_get('lagotto_services_example_doi');

  $doi = lagotto_services_validate_doi($doi);
  if (empty($doi)) {
    $err = t('There is no valid DOI for this block.');
    return '<p>' . $err . '</p>';
  }
  $response = lagotto_services_fetch_work($doi, array('include_detail' => TRUE));

  if (empty($response)) {
    // This should indicate a permission denied error; handle it as such.
    watchdog('lagotto_services_example',
      'Citations search: Permission denied.',
      array(
        '%code' => $response->code,
        '%doi' => $doi,
      ),
      WATCHDOG_WARNING);
    $err = t('Citations search permission denied.');
    return '<p>' . $err . '</p>';
  }

  $record = lagotto_services_record($response, 0);

  // Deal with the errors first.
  if (!empty($record['error']) && ($record['error'] > 0)) {
    watchdog('lagotto_services_example', 'Lagotto API error %code for doi %doi (%msg)',
      array(
        '%code' => $record['error'],
        '%doi' => $doi,
        '%msg' => $record['message'],
      ),
      WATCHDOG_WARNING);

    $err = t(
      'Error in citations search: %msg.',
      array('%msg' => $record['message'])
    );
    return '<p>' . $err . '</p>';
  }

  // [0] for the first article requested, but fixed because we only ever ask
  // for one article at a time.
  $sources = $record['sources'];

  // Make a list of providers in the source data with the total events.
  $providers = array();
  foreach ($sources as $provider) {
    $metrics = $provider['metrics'];
    if (isset($metrics['total'])) {
      $val = $metrics['total'];
      if ($val > 0) {
        $providers[$provider['name']] = array(
          'value' => $val,
          'url' => $provider['events_url'],
          'name' => $provider['display_name'],
        );
      }
    }
  }

  $ext_link_attrs = array(
    'attributes' => array(
      'external' => TRUE,
      'target' => '_blank',
    ),
  );
  if ($record['canonical_url']) {
    $title = l($record['title'], $record['canonical_url'], $ext_link_attrs);
  }
  else {
    $title = check_plain($record['title']);
  }

  $service_url = lagotto_services_service_host();
  $lagotto_link = l(t('Lagotto'), 'http://articlemetrics.github.io/', $ext_link_attrs);
  $info_link = l(
    t('Lagotto article information'),
    $service_url . '/articles/info:doi/' . $doi,
    $ext_link_attrs
  );

  // This is the text we want to render.
  $via_text = t('via !info_link courtesy of !lagotto_link', array(
    '!info_link' => $info_link,
    '!lagotto_link' => $lagotto_link,
  ));

  $items = array();
  foreach ($providers as $provider) {
    $value = check_plain($provider['value']);

    // Make the source name also a link to the source detail, if provided.
    if ($provider['url']) {
      $name_link = l($provider['name'], $provider['url'], $ext_link_attrs);
    }
    else {
      $name_link = check_plain($provider['name']);
    }

    // Construct a renderable metric..
    $item = array(
      '#type' => 'container',
      '#attributes' => array('class' => array('lagotto-services-provider')),
      'info' => array(
        'name' => array(
          '#prefix' => '<span class="lagotto-services-metric-name">',
          '#markup' => $name_link,
          '#suffix' => '</span>',
        ),
        'sep' => array(
          '#prefix' => '<span class="lagotto-services-metric-sep">',
          '#markup' => ': ',
          '#suffix' => '</span>',
        ),
        'value' => array(
          '#prefix' => '<span class="lagotto-services-metric-value">',
          '#markup' => $value,
          '#suffix' => '</span>',
        ),
      ),
    );
    // And render it.
    $items[]['data'] = drupal_render($item);
  }

  // Finally, bring it all together.. a container with the title, metric list
  // and the via text.
  $content = array(
    '#type' => 'container',
    '#attributes' => array('class' => array('lagotto-services-example')),
    'ttl_text' => array(
      '#prefix' => '<h3 class="lagotto-services-metrics-title">',
      '#markup' => $title,
      '#suffix' => '</h3>',
    ),
    'metrics' => array(
      '#items' => $items,
      '#theme' => 'item_list',
      '#attributes' => array(
        'class' => 'providers-list',
      ),
    ),
    'via_text' => array(
      '#prefix' => '<span class="lagotto-services-metrics-via">',
      '#markup' => $via_text,
      '#suffix' => '</span>',
    ),
  );
  return $content;
}
