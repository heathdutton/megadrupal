<?php
/**
 * @file
 * Code for the cm_agenda_editor.
 */

/**
 * Implements hook_menu().
 */
function cm_agenda_editor_menu() {
  $items = array();
  $items['node/%node/events'] = array(
    'title' => 'Events editor',
    'page callback' => 'cm_agenda_editor_page',
    'page arguments' => array(1),
    'access callback' => 'cm_agenda_editor_access_callback',
    'access arguments' => array(1),
    'file' => 'cm_agenda_editor.pages.inc',
    'weight' => 43,
    'type' => MENU_LOCAL_TASK,
  );
  $items['cm-agenda-editor/ajax/save/%node'] = array(
    'title' => 'Events admin',
    'page callback' => 'cm_agenda_editor_ajax_save',
    'access callback' => 'cm_agenda_editor_access_callback',
    'access arguments' => array(3),
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Access callback if user has editor permissions.
 */
function cm_agenda_editor_access_callback($node) {
  return $node->type == 'cm_agenda' && node_access('update', $node);
}

/**
 * Ajax respons for saving data.
 */
function cm_agenda_editor_ajax_save() {
  $data = array();
  if (empty($_POST['mediaid']) || empty($_POST['items'])) {
    drupal_json_output($data);
  }
  $media = entity_load_single('file', $_POST['mediaid']);
  if (empty($media)) {
    drupal_json_output($data);
  }
  $data['messages'] = array();
  $data['media'] = $media;
  $data['mediaid'] = $media->fid;
  $data['agendanid'] = $_POST['agendanid'];
  $eids = array();
  $events = cm_agenda_media_events($media->fid);
  $data['events'] = $events;
  foreach ($_POST['items'] as $item) {
    $id = $item['id'];
    if (empty($events[$id])) {
      $data['messages'][] = 'Media event with id: ' . $item['id'] . ' missing';
      continue;
    }
    $start = strtotime($item['start']) - strtotime('1978-11-19 00:00:00');
    $end = strtotime($item['end']) - strtotime('1978-11-19 00:00:00');
    $event = &$events[$id];
    $event->changestatus = 'same';
    if ((!isset($event->field_media_event_start[LANGUAGE_NONE][0]['value'])) || ($start != $event->field_media_event_start[LANGUAGE_NONE][0]['value'])) {
      $event->changestatus = 'change';
      $event->field_media_event_start[LANGUAGE_NONE][0]['value'] = $start;
    }
    if ((!isset($event->field_media_event_end[LANGUAGE_NONE][0]['value'])) || ($end != $event->field_media_event_end[LANGUAGE_NONE][0]['value'])) {
      $event->changestatus = 'change';
      $event->field_media_event_end[LANGUAGE_NONE][0]['value'] = $end;
    }
    if ($event->changestatus == 'change') {
      $data['change'][] = $id;
      $event->save();
    }
  }
  foreach ($events as $event) {
    if (empty($event->changestatus)) {
      $data['deleted'][] = $event->media_event_id;
      $event->delete();
    }
  }

  $data['eids'] = $eids;
  $data['saveMessage'] = t('Saved');
  drupal_json_output($data);
}
