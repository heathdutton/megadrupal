<?php
/**
 * @file
 * Code for the cm_agenda_popcorn
 */

include_once 'cm_agenda_popcorn.features.inc';

/**
 * Implements template_preprocess_node().
 */
function cm_agenda_popcorn_preprocess_node(&$var) {
  if ($var['type'] != 'cm_agenda') {
    return;
  }
  if (!empty($var['node']->field_cm_agenda_video[LANGUAGE_NONE][0]['fid'])) {
    if (module_exists('cm_agenda_live')) {
      $state = cm_agenda_get_state($var['node']);
      if ($state == 'post_live') {
        return;
      }
    }
    $fid = $var['node']->field_cm_agenda_video[LANGUAGE_NONE][0]['fid'];
    $var['speakers'] = cm_agenda_media_speaker_events($fid);
    $chapters = cm_agenda_media_chapter_events($fid);
    $chapter_info_list = array();
    foreach ($chapters as $chapter) {
      $info = new stdClass();
      $info->media_event_id = $chapter->media_event_id;
      $info->title = $chapter->title;
      $info->text = !empty($chapter->field_media_event_longtext[LANGUAGE_NONE][0]['safe_value']) ? $chapter->field_media_event_longtext[LANGUAGE_NONE][0]['safe_value'] : '';
      $chapter_info_list[] = $info;
    }
    $var['chapter_info_list'] = $chapter_info_list;
    $var['classes_array'][] = 'cm-agenda-popcorn';
    $var['print_chapter_links'] = TRUE;
    $var['print_chapter_speakers'] = TRUE;
    drupal_add_css(drupal_get_path('module', 'cm_agenda_popcorn') . '/css/cm_agenda_popcorn.css');
  }
}

/**
 * Implements hook_popcornplayer_params_alter().
 */
function cm_agenda_popcorn_popcornplayer_params_alter(&$params) {
  if (empty($params['variables']['#entity']->field_cm_agenda_video[LANGUAGE_NONE][0]['fid'])) {
    return;
  }
  $fid = $params['variables']['#entity']->field_cm_agenda_video[LANGUAGE_NONE][0]['fid'];
  $speakers = cm_agenda_media_speaker_events($fid);
  foreach ($speakers as $speaker) {
    if (empty($speaker->field_media_event_start[LANGUAGE_NONE][0]['value'])) {
      continue;
    }
    $e = array(
      'start' => $speaker->field_media_event_start[LANGUAGE_NONE][0]['value'],
      'end' => !empty($speaker->field_media_event_end[LANGUAGE_NONE][0]['value']) ? $speaker->field_media_event_end[LANGUAGE_NONE][0]['value'] : 60 * 60 * 24,
      'target' => '#cm-agenda-speaker-' . $speaker->media_event_id,
      'classname' => 'active',
    );
    $params['popcornplugin']['classactivator'][] = $e;

    $e['target'] = '#cm-agenda-chapter-' . $speaker->media_event_id;
    $e['classname'] = 'started';
    $params['popcornplugin']['classactivator'][] = $e;

  }
  $chapters = cm_agenda_media_chapter_events($fid);
  foreach ($chapters as $chapter) {
    if (empty($chapter->field_media_event_start[LANGUAGE_NONE][0]['value'])) {
      continue;
    }
    $e = array(
      'start' => $chapter->field_media_event_start[LANGUAGE_NONE][0]['value'],
      'end' => !empty($chapter->field_media_event_end[LANGUAGE_NONE][0]['value']) ? $chapter->field_media_event_end[LANGUAGE_NONE][0]['value'] : 60 * 60 * 24,
      'target' => '#cm-agenda-info-' . $chapter->media_event_id,
      'classname' => 'active',
    );
    $params['popcornplugin']['classactivator'][] = $e;

    $e['target'] = '#cm-agenda-chapter-' . $chapter->media_event_id;
    $e['classname'] = 'started';
    $params['popcornplugin']['classactivator'][] = $e;
  }
}
