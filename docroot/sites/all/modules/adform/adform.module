<?php

/**
 * @file
 * User tracking using Adform.
 */

/**
 * An order item was viewed.
 */
define('ADFORM_ITEM_VIEW', 1);
/**
 * An order item was put in cart.
 */
define('ADFORM_ITEM_CART', 2);
/**
 * An order item was purchased.
 */
define('ADFORM_ITEM_PURCHASE', 3);

/**
 * Implements hook_permission().
 */
function adform_permission() {
  return array(
    'administer adform' => array(
      'title' => t('Administer Adform'),
      'description' => t('Perform maintenance tasks for Adform.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function adform_menu() {
  $items['admin/config/system/adform'] = array(
    'title' => 'Adform',
    'description' => 'Configure Adform user behavior tracking.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('adform_admin_settings_form'),
    'access arguments' => array('administer adform'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'adform.admin.inc',
  );

  return $items;
}

/**
 * Add tracking of an shop item.
 *
 * @param string|int $id
 *   Id of the item.
 * @param int $action
 *   Action being applied to the item. One of ADFORM_ITEM_VIEW, ADFORM_ITEM_CART
 *   or ADFORM_ITEM_PURCHASE.
 * @param int $weight
 *   Unless you know you need to use it, ignore this parameter.
 */
function adform_order_item($id, $action = ADFORM_ITEM_VIEW, $weight = 1) {
  $items = &drupal_static(__FUNCTION__, array());
  $items[$id] = array(
    'productid' => $id,
    'weight' => $weight,
    'step' => $action,
  );
}

/**
 * Add tracking of a specific tracking point in addition to path.
 *
 * @param string|int $tracking_point_id
 *   The tracking point ID to track.
 */
function adform_track_id($tracking_point_id) {
  $id = &drupal_static(__FUNCTION__, NULL);
  $id = $tracking_point_id;
}

/**
 * Implements hook_page_alter().
 *
 * Insert the proper tracking code.
 */
function adform_page_alter(&$page) {
  global $base_url;
  $adform_id = variable_get('adform_id', '');
  if (!$adform_id) {
    return;
  }

  // Get the path to track.
  $path = drupal_get_path_alias();

  // Apply path mapping.
  foreach (variable_get('adform_mappings', array()) as $pattern => $map_path) {
    if (preg_match('/^' . $pattern . '$/', $path)) {
      $path = $map_path;
    }
  }
  $path = explode('/', $path);

  // Prefix with hostname.
  $parts = parse_url($base_url);
  array_unshift($path, $parts['host']);

  // Prefix by TEST, if testing.
  if (!in_array($parts['host'], variable_get('adform_hostnames', array()))) {
    array_unshift($path, 'TEST');
  }

  $pagename = join('|', $path);

  $adtrack = array(
    'pm' => $adform_id,
    'pagename' => urlencode($pagename),
    'divider' => urlencode('|'),
  );

  // Add tracking point, if any.
  $id = &drupal_static('adform_track_id', array());
  if (!empty($id)) {
    $adtrack['id'] = $id;
  }

  // Add in items, if any.
  $items = &drupal_static('adform_order_item', array());
  if ($items) {
    $adtrack['order'] = array(
      // Use array_values to ensure sequential integer keys, which tells
      // json_encode that it should be encoded as an JS array.
      'itms' => array_values($items),
    );
  }
  $adtrack_js = json_encode($adtrack);
  $code = <<<EOD
<!-- Adform Tracking Code BEGIN -->
<script type="text/javascript">
var _adftrack = $adtrack_js;
(function(){var s=document.createElement('script');s.type='text/javascript';s.async=true;s.src='https://track.adform.net/serving/scripts/trackpoint/async/';var x = document.getElementsByTagName('script')[0];x.parentNode.insertBefore(s, x);})();
</script>
<noscript>
    <p style="margin:0;padding:0;border:0;">
      <img src="https://track.adform.net/Serving/TrackPoint/?pm={$adtrack['pm']}&amp;ADFPageName={$adtrack['pagename']}&amp;ADFdivider={$adtrack['divider']}" width="1" height="1" alt="" />
    </p>
</noscript>
<!-- Adform Tracking Code END -->
EOD;

  $page['page_top']['adform'] = array(
    '#markup' => $code,
  );
}

/**
 * Generate an URL which tracks traffic passing through in Adform.
 *
 * @see http://www.adform.com/site/files/manuals/TP/Instructions_for_UniqueTrackingPoints_Redirect.pdf
 *
 * @param string|int $link_id
 *   The id of the link as registered in Adform
 * @param $url
 *   The target URL to track
 * @return string
 *   An Adform tracking point URL which will track and redirect the user to the
 *   target URL.
 */
function adform_track_url($link_id, $url) {
  $adform_id = variable_get('adform_id', '');
  if (!$adform_id) {
    return;
  }

  $path = 'https://track.adform.net/Serving/TrackPoint/';
  $options = array(
    'external' => TRUE,
    'query' => array(
      'pm' => $adform_id,
      'lid' => $link_id,
      'rdir' => $url,
    ),
  );
  return url($path, $options);
}
