<?php
/**
 * @file
 * Main file for the Yandex.Webmaster Block module.
 */

/**
 * Implements hook_block_info().
 */
function yandex_webmaster_block_block_info() {
  return array(
    'yandex_webmaster' => array(
      'info' => 'Yandex.Webmaster',
      'cache' => DRUPAL_CACHE_GLOBAL,
      'properties' => array(
        'administrative' => TRUE,
      ),
    ),
  );
}

/**
 * Implements hook_block_configure().
 */
function yandex_webmaster_block_block_configure($delta = '') {
  $settings = variable_get('yandex_webmaster_block_settings', array(TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE));
  $form['yandex'] = array(
    '#type' => 'fieldset',
    '#title' => t('Yandex.Webmaster settings'),
    '#collapsible' => FALSE,
    '#collapsed' => FALSE,
  );
  $form['yandex']['branding'] = array(
    '#type' => 'checkbox',
    '#title' => t('Display Yandex branding in the block.'),
    '#default_value' => $settings[0],
  );
  $form['yandex']['date_format'] = array(
    '#type' => 'checkbox',
    '#title' => t('Use interval to display last index date.'),
    '#default_value' => $settings[1],
    '#suffix' => '<hr />',
  );
  $form['yandex']['hostname'] = array(
    '#type' => 'checkbox',
    '#title' => t('Display hostname.'),
    '#default_value' => $settings[2],
  );
  $form['yandex']['last_access'] = array(
    '#type' => 'checkbox',
    '#title' => t('Display last access date.'),
    '#default_value' => $settings[3],
  );
  $form['yandex']['tcy'] = array(
    '#type' => 'checkbox',
    '#title' => t('Display TCY value.'),
    '#default_value' => $settings[4],
  );
  $form['yandex']['url_count'] = array(
    '#type' => 'checkbox',
    '#title' => t('Display URL count.'),
    '#default_value' => $settings[5],
  );
  $form['yandex']['index_count'] = array(
    '#type' => 'checkbox',
    '#title' => t('Display index count.'),
    '#default_value' => $settings[6],
  );
  $form['yandex']['url_errors'] = array(
    '#type' => 'checkbox',
    '#title' => t('Display url errors count.'),
    '#default_value' => $settings[7],
  );
  $form['yandex']['links_count'] = array(
    '#type' => 'checkbox',
    '#title' => t('Display links count.'),
    '#default_value' => $settings[8],
  );
  $form['yandex']['internal_links_count'] = array(
    '#type' => 'checkbox',
    '#title' => t('Display internal links count.'),
    '#default_value' => $settings[9],
  );
  return $form;
}

/**
 * Implements hook_block_save().
 */
function yandex_webmaster_block_block_save($delta = '', $edit = array()) {
  variable_set('yandex_webmaster_block_settings', array(
    (bool) $edit['branding'],
    (bool) $edit['date_format'],
    (bool) $edit['hostname'],
    (bool) $edit['last_access'],
    (bool) $edit['tcy'],
    (bool) $edit['url_count'],
    (bool) $edit['index_count'],
    (bool) $edit['url_errors'],
    (bool) $edit['links_count'],
    (bool) $edit['internal_links_count'],
  ));
}

/**
 * Implements hook_block_view().
 *
 * Display "Yandex.Webmaster" statistics block.
 */
function yandex_webmaster_block_block_view($delta = '') {
  $block = array();

  drupal_add_css(drupal_get_path('module', 'yandex_webmaster') . '/css/yandex_webmaster.css');
  $settings = variable_get('yandex_webmaster_block_settings', array(TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE));

  $stats = yandex_webmaster_get_host_stats();
  if (count($stats) < 3) {
    $output = isset($stats['error']) ? $stats['error'] : t('An error has occurred.');
  }
  else {
    // Select CSS classes for the block.
    $virused = $stats['virused'] == 'false' ? '' : ' VIRUSED';
    $class = $stats['verification'] . ' ' . $stats['crawling'] . $virused;
    $output = '<div class="yandex-webmaster-stats ' . $class . '">';
    // Display security status message.
    if ($stats['virused'] != 'false') {
      $output .= '<div class="virused-site">' . t('Danger! Site is virused!') . '</div>';
    }
    // Display hostname.
    if ($settings[2]) {
      $output .= '<div class="hostname">' . t('Host name') . ': <span>' . $stats['name'] . '</span></div>';
    }
    // Display last access date.
    if ($settings[3]) {
      $date = $stats['last-access'];
      if ($date > 0) {
        // Use date format or interval.
        if ($settings[1]) {
          $date = t('@time ago', array('@time' => format_interval(time() - $date)));
        }
        else {
          $date = format_date($date);
        }
      }
      $output .= '<div class="last-access">' . t('Last access') . ': <span>' . $date . '</span></div>';
    }
    // Display TCY value.
    if ($settings[4] && $stats['tcy'] > 0) {
      $output .= '<div class="tcy">' . t('TCY') . ': <span>' . number_format($stats['tcy'], 0, '', ' ') . '</span></div>';
    }
    // Display url count.
    if ($settings[5] && $stats['url-count'] > 0) {
      $output .= '<div class="url-count">' . t('URL count') . ': <span>' . number_format($stats['url-count'], 0, '', ' ') . '</span></div>';
    }
    // Display index count.
    if ($settings[6] && $stats['index-count'] > 0) {
      $output .= '<div class="index-count">' . t('Index count') . ': <span>' . number_format($stats['index-count'], 0, '', ' ') . '</span></div>';
    }
    // Display url errors count.
    if ($settings[7] && $stats['url-errors'] > 0) {
      $output .= '<div class="url-errors">' . t('URL errors') . ': <span>' . number_format($stats['url-errors'], 0, '', ' ') . '</span></div>';
    }
    // Display links count.
    if ($settings[8] && $stats['links-count'] > 0) {
      $output .= '<div class="links-count">' . t('Links count') . ': <span>' . number_format($stats['links-count'], 0, '', ' ') . '</span></div>';
    }
    // Display internal links count.
    if ($settings[9] && $stats['internal-links-count'] > 0) {
      $output .= '<div class="internal-links-count">' . t('Internal links') . ': <span>' . number_format($stats['internal-links-count'], 0, '', ' ') . '</span></div>';
    }
    // Display Yandex branding.
    global $language;
    if ($settings[0]) {
      $output .= '<div class="branding branding-' . $language->language . '">' . t('Data provided by !link service.', array('!link' => l(t('Yandex.Webmaster'), 'http://webmaster.yandex.com/'))) . '</div>';
    }
    $output .= '</div>';
  }

  $block['subject'] = t('Yandex.Webmaster');
  $block['content'] = $output;
  return $block;
}
