<?php
/**
 * @file
 * Main file for the Yandex.Webmaster Original texts module.
 */

/**
 * Implements hook_entity_info().
 */
function yandex_webmaster_original_texts_entity_info() {
  return array(
    'yandex_webmaster_original_text' => array(
      'module' => 'yandex_webmaster_original_texts',
      'label' => t('Yandex.Webmaster original text'),
      'entity class' => 'Entity',
      'controller class' => 'EntityAPIController',
      'base table' => 'yandex_webmaster_original_texts',
      'fieldable' => FALSE,
      'entity keys' => array(
        'id' => 'text_md5',
      ),
    ),
  );
}

/**
 * Implements hook_views_api().
 */
function yandex_webmaster_original_texts_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'yandex_webmaster_original_texts') . '/views',
  );
}

/**
 * Add text to Yandex original texts.
 * http://api.yandex.com/webmaster/doc/dg/reference/host-original-texts-add.xml
 */
function yandex_webmaster_original_texts_add_original_text($host_id, $text) {
  $options = array(
    'method' => 'POST',
    'headers' => array('Authorization' => 'OAuth ' . yandex_services_auth_info()),
    'data' => urlencode('<original-text><content>' . check_plain(strip_tags($text)) . '</content></original-text>'),
  );
  $url = yandex_webmaster_host_resources($host_id, 'original-texts');
  $result = drupal_http_request($url, $options);
  if ($result->code != 201) {
    watchdog('yandex_webmaster_original_texts', 'Yandex.Webmaster original texts request to %url failed with code %code and error message "%error".',
      array('%url' => $url, '%code' => $result->code, '%error' => isset($result->error) ? $result->error : 'empty'), WATCHDOG_WARNING);
  }
  _yandex_webmaster_original_texts_add_original_text($host_id, $text, $result);

  return $result;
}

/**
 * Logs original text to DB table.
 */
function _yandex_webmaster_original_texts_add_original_text($host_id, $text, $result) {
  $code = $result->code;
  $record = array(
    'host_id' => $host_id,
    'text' => $text,
    'timestamp' => REQUEST_TIME,
    'code' => $code,
  );
  if ($data = yandex_webmaster_parse_xml($result->data)) {
    if ($code == 201) {
      $record += array(
        'id' => current($data->id),
        'link' => current($data->link->attributes()->href),
        'content' => current($data->content),
      );
    }
    else {
      $record += array(
        'error_code' => current($data->attributes()->code),
        'content' => '',
      );
    }
  }
  else {
    $record += array(
      'content' => '',
    );
  }

  db_merge('yandex_webmaster_original_texts')
    ->key(array('text_md5' => md5($text)))
    ->fields($record)
    ->execute();
}
