<?php
/**
 * @file
 * Add comment options to the node bulk administration page
 */

/**
 * Implement hook_permission().
 */
function comment_options_permission() {
  return array(
    'bulk edit comment options' => array(
      'title' => t('Bulk Edit Comment Options'),
      'restrict access' => TRUE
    )
  );
}

function comment_options_form_alter(&$form, $form_state, $form_id) {

  if (user_access('bulk edit comment options')) {
    switch ($form_id) {
      // Add comments options to the node admin form
      case 'node_admin_nodes':
        $f = &$form['options']['operation']['#options'];
        $f['comment'] = 'Comments Read/Write';
        $f['nocomment'] = 'Comments Disabled';
        $f['rocomment'] = 'Comments Read only';
        break;
    }
  }
}

/**
 * Implementation of hook_node_operations().
 */
function comment_options_node_operations() {
  if (user_access('bulk edit comment options')) {
    $operations = array(
      'comment' => array(
        'label' => t('Comments Read/Write'),
        'callback' => '_comment_options_operations_comment'
      ),
      'nocomment' => array(
        'label' => t('Comments Disabled'),
        'callback' => '_comment_options_operations_nocomment'
      ),
      'rocomment' => array(
        'label' => t('Comments Read only'),
        'callback' => '_comment_options_operations_rocomment'
      )
    );
    return $operations;
  }
}


/**
 * Callback functions to change comment settings.
 */
function _comment_options_operations_comment($nodes) { _comment_options_set_comment($nodes, COMMENT_NODE_READ_WRITE); }
function _comment_options_operations_rocomment($nodes) { _comment_options_set_comment($nodes, COMMENT_NODE_READ_ONLY); }
function _comment_options_operations_nocomment($nodes) { _comment_options_set_comment($nodes, COMMENT_NODE_DISABLED); }
function _comment_options_set_comment($nodes, $flag=COMMENT_NODE_READ_ONLY) {
  $placeholders = implode("','", array_fill(0, count($nodes), '%d'));
  db_query("UPDATE {node} SET comment=%d WHERE nid IN ('$placeholders')", array_merge(array($flag), $nodes));
}

