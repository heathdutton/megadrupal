<?php

/**
 * @file
 * A basic database caching module.
 */

/**
 * Implements hook_help().
 *
 * Returns one set of help instructions for all cases
 * as this module has no admin paths.
 */
function dx_cache_help($path, $arg) {
  return $path == 'admin/help#dx_cache' ? '<p>' . t('The DX Cache module allows you to store both expiring and permanent information in a database table without having to write your own schema implementation or use the variable_set and variable_get functions.') . '</p><p>' . t('Storing values is as simple as using `dx_cache_set(string $key_name, mixed $data_to_store, int $seconds_to_live)`, you can then retrieve the data by using `dx_cache_get(string $key_name)`. It really is as simple as that, for more information, check out the README file in the module.') . "</p>" : '';
}

/**
 * Convenience method to check if a cache object exists.
 *
 * @param string $name
 *   the object name
 *
 * @return bool
 *   TRUE if exists, FALSE if not.
 */
function dx_cache_has($name) {
  $items = db_query("SELECT expires, value FROM {dx_cache} WHERE name = :name LIMIT 1", array(':name' => $name))->fetchAll();
  if (count($items) == 1) {
    // Make sure that this hasn't expired.
    $time = time();
    if (isset($items[0]->expires) && $items[0]->expires < $time) {
      dx_cache_del($name);
      return FALSE;
    }
    return TRUE;
  }
  else {
    return FALSE;
  }
}

/**
 * Set a value in the table, with an optional time to live.
 *
 * @param string $name
 *   The name of the object
 * @param mixed $value
 *   Value to serialize and store
 * @param int $ttl
 *   Time in seconds to expire
 *
 * @return bool
 *   True if a new record is written.
 */
function dx_cache_set($name, $value, $ttl = NULL) {

  $value = serialize($value);

  if (isset($ttl) && !is_int($ttl)) {
    return FALSE;
  }

  db_delete('dx_cache')->condition('name', $name)->execute();

  $time = time();

  $data = array(
    'name'       => $name,
    'value'      => $value,
    'expires'    => isset($ttl) ? ($time + $ttl) : NULL,
    'created_at' => $time,
  );

  return db_insert("dx_cache")->fields($data)->execute();

}

/**
 * Get a value from the DB.
 *
 * @param string $name
 *   The object name
 * @param mixed $default
 *   the optional value to return if it does not exist
 *
 * @return mixed
 *   The cached or default item
 */
function dx_cache_get($name, $default = NULL) {

  if (dx_cache_has($name)) {

    $value = db_query("SELECT * FROM {dx_cache} WHERE name = :name", array(':name' => $name))->fetchAll();
    $value = $value[0];

    $time = time();

    if (isset($value->expires) && ($value->expires < $time)) {
      db_delete('dx_cache')->condition('name', $name)->execute();
      return $default;
    }

    return unserialize($value->value);

  }
  else {
    // Doesn't exist.
    return $default;
  }

}

/**
 * Delete a cache item.
 *
 * @param string $name
 *   The key of the item to delete
 *
 * @return mixed
 *   The value stored in the DB.
 */
function dx_cache_del($name) {
  return db_delete('dx_cache')->condition('name', $name)->execute();
}

/**
 * Implements hook_cron().
 */
function dx_cache_cron() {
  $time = time();
  db_delete('dx_cache')->condition('expires', $time, '<')->execute();
}
