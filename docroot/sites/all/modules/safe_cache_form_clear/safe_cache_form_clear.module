<?php
/**
 * @file
 * Module hooks for the Safe cache_form Clear module.
 */

/**
 * Implements hook_requirements().
 */
function safe_cache_form_clear_requirements($phase) {
  cache_set(__FUNCTION__, __FUNCTION__, 'cache_form', CACHE_TEMPORARY);

  $results = db_select('cache_form')
    ->fields('cache_form')
    ->condition('cid', __FUNCTION__)
    ->execute();

  $cids = $results->fetchCol('cid');

  if (empty($cids)) {
    return array(
      'safe-cache-form-clear-cache-backend' => array(
        'title' => t('Incorrect cache backend in use.'),
        'description' => t('This module will only function correctly if DrupalDatabaseCache is used as the cache backend for cache_form.'),
        'severity' => REQUIREMENT_ERROR,
      )
    );
  }

  return array();
}

/**
 * Remove a limited number of
 *
 * @return integer
 *  The number of rows deleted from the cache_form table.
 */
function safe_cache_form_clear($limit = NULL) {

  if ($limit == NULL) {
    $limit = variable_get('safe_cache_form_clear_limit', 1000);
  }

  // Can't use a subquery on db_delete() directly: Syntax error or access
  // violation: 1235 This version of MySQL doesn't yet support 'LIMIT &
  // IN/ALL/ANY/SOME subquery'

  $results = db_select('cache_form')
    ->fields('cache_form', array('cid'))
    ->condition('expire', CACHE_PERMANENT, '<>')
    ->condition('expire', REQUEST_TIME, '<')
    ->range(0, $limit)
    ->execute();

  $cids = $results->fetchCol('cid');

  if (empty($cids)) {
    return 0;
  }

  return db_delete('cache_form')
    ->condition('cid', $cids, 'IN')
    ->execute();
}
