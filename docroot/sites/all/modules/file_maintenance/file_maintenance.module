<?php


define('FILE_MAINTENANCE_THUMB_WIDTH', 32);
define('FILE_MAINTENANCE_THUMB_HEIGHT', 32);

/**
 * Implements hook_help().
 */
function file_maintenance_help($path, $arg) {
  $output = '';
  switch ($path) {
    case 'admin/help#file_maintenance':
      $output .= t('<p>File maintenance allows to manage the files in the database table <em>file_managed</em>'
        . ' and the files directory in the file system. Both will be compared and conflicts will be shown.</p>');
      $output .= ''
        . t('<p>See also: !link</p>',
          array(
            '!link' => l(t('File system'), 'admin/config/media/file-system', array('attributes' => array('title' => t('File system')))))
          );
      break;
/*
    case 'admin/content/file-maintenance':
      $output .= '<p>'.t('').'</p>'
        . t('See also: !link',
          array('!link' => l(t('File maintenance settings'), 'admin/config/system/file-maintenance', array('attributes' => array('title' => t('File system'))))));
      break;
 */
    case 'admin/config/system/file-maintenance':
      $output .= '' . t('<p>Settings for the !file_maintenance.</p>',
        array(
          '!file_maintenance' => l(t('File maintenance'), 'admin/content/file-maintenance', array('attributes' => array('title' => t('File maintenance')))),
        )
      );
      break;
  }

  return $output;
}

/**
 * Implements hook_permission().
 */
function file_maintenance_permission() {
  return array(
    'use file maintenance' => array(
      'title' => t('Use File maintenance'),
      'description' => t('Use File maintenance to browse and maintain managed and unmanaged files.'),
    ),
    'administer file maintenance' => array(
      'title' => t('Administer File maintenance'),
      'description' => t('Change configuration settings of File maintenance.'),
    ),
    'extend filesystem access' => array(
      'title' => t('Extend filesystem access'),
      'description' => t('(Not yet implemented.) Access the filesystem outside of the standard drupal files directories (public/private).'),
      'restrict access' => TRUE,
    )
  );
}

/**
 * Implements hook_menu().
 */
function file_maintenance_menu() {
  $items = array();
  $items['admin/content/file-maintenance'] = array(
    'title' => 'File maintenance',
    'description' => 'Browse and perform maintenance on managed and unmanaged files.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('file_maintenance_browser_form'),
    'access callback' => 'user_access',
    'access arguments' => array('use file maintenance'),
    //'type' => MENU_NORMAL_ITEM,
    'file' => 'includes/file_maintenance.browser.inc',
    'weight' => 100,
  );

  $items['admin/content/file-maintenance/browse'] = array(
    'title' => 'Browse',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => 0,
  );

  $items['admin/content/file-maintenance/analyze'] = array(
    'title' => 'Analyze',
    'type' => MENU_LOCAL_TASK,
    'access arguments' => array('use file maintenance'),
    'weight' => 5,
  );

  $items['admin/file-maintenance/file-list'] = array(
    'page callback' => 'file_maintenance_update_file_list',
//    'access callback' => 'user_access',
    'access arguments' => array('use file maintenance'),
    'type' => MENU_CALLBACK,
    'file' => 'includes/file_maintenance.browser.inc',
  );
/*
  $items['admin/file-maintenance/directory-tree/%'] = array(
    'page callback' => 'file_maintenance_update_directory_tree',
    'page arguments' => array(3),
    'access callback' => 'user_access',
    'access arguments' => array('use file maintenance'),
    'type' => MENU_CALLBACK,
    'file' => 'includes/file_maintenance.browser.inc',
  );
 */
  $items['admin/config/system/file-maintenance'] = array(
    'title' => 'File maintenance',
    'description' => 'Setup the File maintenance module.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('file_maintenance_settings_form'),
    'access callback' => 'user_access',
    'access arguments' => array('administer file maintenance'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'includes/file_maintenance.browser.inc',
  );
  return $items;
}

/**
 * Implements hook_theme().
 */
function file_maintenance_theme(&$existing, $type, $theme, $path) {
  return array(
    'directory_tree_wrapper' => array(
      'template' => 'templates/file-maintenance-directory-tree-wrapper',
      'render element' => 'tree',
    ),
    'file_list_wrapper' => array(
      'template' => 'templates/file-maintenance-file-list-wrapper',
      'render element' => 'list',
    ),
    'list_file' => array(
      'template' => 'templates/file-maintenance-list-file',
      'variables' => array(
        'filename' => array(),
        'level' => 0,
      )
    ),
    'tree_file' => array(
      'template' => 'templates/file-maintenance-tree-file',
      'variables' => array(
        'filename' => array(),
        'level' => 0,
        'is_temporary' => FALSE,
      ),
    ),
    'file_maintenance_tree_directory' => array(
      'template' => 'templates/file-maintenance-tree-directory',
      'file' => 'includes/file_maintenance.browser.inc',
      'variables' => array(
        // TODO clean up
        'subdirs' => array(),
        'file_count' => 0,
        'files' => array(),
        'files_size' => 0,
        'files_size_deep' => 0,
        'file_count_deep' => 0,
        'dirname' => '',
        'uri' => '',
        'level' => 0,
        'subdirs' => array(),
        'child_count' => 0,
        'in_database' => FALSE,
        'in_filesystem' => FALSE,
        'is_temporary' => FALSE,
        'dir_id' => '',
        'icon' => '',
        'error' => array(),
        'icon_element' => '',
        'toggle_element' => '',
        'expanded' => '',
        'filename_classes' => ''
      ),
      //'pattern' => 'tree_directory__',
    ),
  );
}

/*
 * Implements hook_image_default_styles().
 */
function file_maintenance_image_default_styles() {
  $styles = array();

  $styles['file_maintenance_thumbnail'] = array(
    'effects' => array(
      array(
        'name' => 'image_scale',
        'data' => array('width' => FILE_MAINTENANCE_THUMB_WIDTH, 'height' => FILE_MAINTENANCE_THUMB_HEIGHT, 'upscale' => FALSE),
        'weight' => 0,
      ),
    )
  );
  return $styles;
}

