<?php

define('BLUEJEANS_ENDPOINT', 'https://api.bluejeans.com');

/**
 * Implements hook_menu().
 */
function bluejeans_menu() {
  $items['conference/%bluejeans_content/new'] = array(
    'title' => 'Schedule conference',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bluejeans_conference_form', 1),
    'access arguments' => array('administer bluejeans conference'),
  );
  $items['conference/%bluejeans_content/%bluejeans_conference/edit'] = array(
    'title' => 'Edit conference',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bluejeans_conference_form', 1, 2),
    'access arguments' => array('administer bluejeans conference'),
  );
  $items['conference/%bluejeans_content/%bluejeans_conference/cancel'] = array(
    'title' => 'Cancel conference',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bluejeans_conference_delete', 1, 2),
    'access arguments' => array('administer bluejeans conference'),
  );
  $items['node/%bluejeans_content/conferences'] = array(
    'title' => 'Synchronize Blue Jeans',
    'page callback' => 'bluejeans_conferences_sync',
    'page arguments' => array(1),
    'access callback' => 'bluejeans_debug_access',
    'type' => MENU_LOCAL_TASK,
  );
  $items['admin/config/services/bluejeans'] = array(
    'title' => 'Blue Jeans',
    'description' => 'Adjust Blue Jeans settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bluejeans_admin_settings'),
    'access arguments' => array('administer bluejeans conference'),
  );

  // BJN proxy calls.
  $items['bluejeans/conference/%bluejeans_conference/status'] = array(
    'title' => 'Get conference state',
    'page callback' => 'bluejeans_conference_status',
    'page arguments' => array(2),
    'access callback' => 'bluejeans_conference_access',
    'access arguments' => array(2),
    'type' => MENU_CALLBACK,
  );
  $items['bluejeans/conference/%bluejeans_conference/endpoints'] = array(
    'title' => 'Get conference endpoints',
    'page callback' => 'bluejeans_conference_endpoints',
    'page arguments' => array(2),
    'access callback' => 'bluejeans_conference_access',
    'access arguments' => array(2),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Access function for `bluejeans/conference/%bluejeans_conference/*`.
 */
function bluejeans_conference_access($conference) {
  $nid = db_query("
    SELECT cn.nid FROM {bluejeans_conferences_nodes} cn
    LEFT JOIN {node} n ON n.nid = cn.nid
    WHERE cn.meeting_id = :id
    AND (n.tnid = 0 OR n.tnid = n.nid)
  ", array(':id' => $conference->meeting_id))->fetchField();
  $node = node_load($nid);
  return node_access('view', $node);
}

/**
 * Access function for debugging features.
 */
function bluejeans_debug_access() {
  return variable_get('bluejeans_debug', FALSE) && user_access('administer bluejeans conference');
}

/**
 * Load function for `bluejeans_content`.
 */
function bluejeans_content_load($nid) {
  $node = node_load($nid);
  if ($node && in_array($node->type, variable_get('bluejeans_types', array()))) {
    return $node;
  }
  return FALSE;
}

/**
 * Load function for `bluejeans_conference`.
 */
function bluejeans_conference_load($meeting_id) {
  $conference = db_query("
    SELECT * FROM {bluejeans_conference} WHERE meeting_id = :id
  ", array(':id' => $meeting_id))->fetchObject();
  return $conference;
}

/**
 * Menu handler for `node/%bluejeans_node/conferences`.
 */
function bluejeans_conferences_sync($node) {
  bluejeans_conferences_remote(TRUE);
  drupal_set_message(t('Synchronized conferences with Blue Jeans.'));
  drupal_goto('node/' . $node->nid);
  return '';
}

/**
 * Form function for `admin/settings/bluejeans`.
 */
function bluejeans_admin_settings() {
  $form['bluejeans_appkey'] = array(
    '#type' => 'textfield',
    '#title' => t('Blue Jeans OAuth appkey'),
    '#default_value' => variable_get('bluejeans_appkey', ''),
    '#required' => TRUE,
  );
  $form['bluejeans_appsecret'] = array(
    '#type' => 'textfield',
    '#title' => t('Blue Jeans OAuth app secret'),
    '#default_value' => variable_get('bluejeans_appsecret', ''),
    '#required' => TRUE,
  );
  $form['bluejeans_username'] = array(
    '#type' => 'textfield',
    '#title' => t('Blue Jeans username'),
    '#default_value' => variable_get('bluejeans_username', ''),
    '#required' => TRUE,
  );
  $form['bluejeans_types'] = array(
    '#type' => 'select',
    '#title' => t('Associated content types'),
    '#multiple' => TRUE,
    '#options' => node_type_get_names(),
    '#default_value' => variable_get('bluejeans_types', array()),
  );
  $node_info = entity_get_info('node');
  $view_modes = array();
  foreach ($node_info['view modes'] as $key => $info) {
    $view_modes[$key] = $info['label'];
  }
  $form['bluejeans_view_modes_links'] = array(
    '#type' => 'select',
    '#title' => t('View modes to show "Create new conference" link'),
    '#multiple' => TRUE,
    '#options' => $view_modes,
    '#default_value' => variable_get('bluejeans_view_modes_links', array('full')),
  );
  $form['bluejeans_debug'] = array(
    '#type' => 'checkbox',
    '#title' => t('Debug Blue Jeans integration'),
    '#default_value' => variable_get('bluejeans_debug', FALSE),
  );
  return system_settings_form($form);
}

/**
 * Form function for `bluejeans_conference_delete`.
 */
function bluejeans_conference_delete($form, &$form_state, $node, $conference) {
  $form['#conference'] = $conference;
  $form = confirm_form(
    $form,
    t('Are you sure you want to cancel the conference %title?', array('%title' => $conference->title)),
    'node/' . $conference->nid,
    t('The conference will be canceled. This action cannot be undone.'),
    t('Submit')
  );
  return $form;
}

/**
 * Form submit function for `bluejeans_conference_delete`.
 */
function bluejeans_conference_delete_submit($form, &$form_state) {
  if ($form_state['values']['confirm']) {
    $conference = $form['#conference'];
    if (_bluejeans_conference_delete($conference)) {
      drupal_set_message(t('Canceled conference %title.', array('%title' => $conference->title)));
    }
  }
}

/**
 * Helper function to delete conference locally and remotely.
 */
function _bluejeans_conference_delete($conference) {
  if (!bluejeans_authenticate()) {
    drupal_set_message(t('Could not authenticate to Blue Jeans. Operation aborted.'), 'error');
    return FALSE;
  }

  // Cancel remote meeting.
  $response = drupal_http_request(
    url(BLUEJEANS_ENDPOINT . '/v1/user/' . $_SESSION['bluejeans']->user->id . '/scheduled_meeting/' . $conference->meeting_id,
      array('absolute' => TRUE, 'query' => array('access_token' => $_SESSION['bluejeans']->access_token))
    ),
    array('method' => 'DELETE')
  );
  if ($response->code != 200) {
    watchdog('bluejeans', 'Error deleting conference: !code !error',
      array('!code' => $response->code, '!error' => $response->error),
      WATCHDOG_ERROR
    );
    drupal_set_message(t('Could not delete conference %title because a Blue Jeans error occurred: !code !error', 
      array('%title' => $conference->title, '!code' => $response->code, '!error' => $response->error)
    ), 'error');
    return FALSE;
  }

  // Delete local copy.
  db_delete('bluejeans_conferences_nodes')
    ->condition('meeting_id', $conference->meeting_id)
    ->execute();
  db_delete('bluejeans_conference')
    ->condition('meeting_id', $conference->meeting_id)
    ->execute();

  // Inform other modules we've deleted a conference.
  module_invoke_all('bluejeans_conference', 'delete', $conference); 

  return TRUE;
}

/**
 * Form function for `bluejeans_conference_form`.
 */
function bluejeans_conference_form($form, &$form_state, $node, $conference = NULL) {
  $form['title'] = array(
    '#title' => t('Title'),
    '#type' => 'textfield',
    '#required' => TRUE,
    '#default_value' => isset($conference) ? $conference->title : NULL,
  );
  $format = 'm/d/Y - h:iA';
  $form['start'] = array(
    '#title' => t('Start'),
    '#type' => 'date_popup',
    '#date_format' => $format,
    '#required' => TRUE,
    '#attributes' => array('autocomplete' => 'off'),
    '#default_value' => isset($conference) ? date(DATE_FORMAT_DATETIME, $conference->start) : NULL,
    '#field_suffix' => _bluejeans_timezone_abbreviation(date_default_timezone()),
  );
  $form['end'] = array(
    '#title' => t('End'),
    '#type' => 'date_popup',
    '#date_format' => $format,
    '#required' => TRUE,
    '#attributes' => array('autocomplete' => 'off'),
    '#default_value' => isset($conference) ? date(DATE_FORMAT_DATETIME, $conference->end) : NULL,
    '#field_suffix' => _bluejeans_timezone_abbreviation(date_default_timezone()),
  );
  $form['description'] = array(
    '#title' => t('Message'),
    '#type' => 'textarea',
    '#description' => t('A greeting or description about your meeting.'),
    '#default_value' => isset($conference) ? $conference->description : NULL,
  );
  $form['submit'] = array(
    '#value' => t('Save'),
    '#type' => 'submit',
  );
  $form['cancel'] = array(
    '#type' => 'markup',
    '#value' => l(t('Cancel'), 'node/' . $node->nid),
  );
  $form['#node'] = $node;
  $form['#conference'] = $conference;
  return $form;
}

/**
 * Form validation function for `bluejeans_conference_form`.
 */
function bluejeans_conference_form_validate($form, $form_state) {
  $start = strtotime($form_state['values']['start']);
  $end = strtotime($form_state['values']['end']);
  if ($start < time()) {
    form_set_error('start', t('Conference start time should be in the future.'));
  }
  if ($end <= $start) {
    form_set_error('end', t('Conference end time should be greater than start time.'));
  }
}

/**
 * Form submit function for `bluejeans_conference_form`.
 */
function bluejeans_conference_form_submit($form, $form_state) {
  if (!bluejeans_authenticate()) {
    drupal_set_message(t('Could not authenticate to Blue Jeans. Operation aborted.'), 'error');
    return;
  }

  $updating_meeting_id = isset($form['#conference']) ? $form['#conference']->meeting_id : NULL;

  // Create remote meeting.
  $conference = (object)array(
    'title' => $form_state['values']['title'],
    'start' => strtotime($form_state['values']['start']) * 1000, // in ms
    'end' => strtotime($form_state['values']['end']) * 1000, // in ms
    'description' => $form_state['values']['description'],
    'timezone' => date_default_timezone(),
    'endPointType' => 'Drupal Blue Jeans',
    'endPointVersion' => '1.0',
  );
  $response = drupal_http_request(
    url(BLUEJEANS_ENDPOINT . '/v1/user/' . $_SESSION['bluejeans']->user->id . '/scheduled_meeting' . (isset($updating_meeting_id) ? '/' . $updating_meeting_id : ''),
        array('absolute' => TRUE, 'query' => array(
          'access_token' => $_SESSION['bluejeans']->access_token,
        ))
    ),
    array(
      'headers' => array('Content-Type' => 'application/json'),
      'method' => isset($updating_meeting_id) ? 'PUT' : 'POST',
      'data' => json_encode($conference)
    )
  );
  if ($response->code >= 300) { 
    watchdog('bluejeans', 'Error creating conference: !code !error',
      array('!code' => $response->code, '!error' => $response->error),
      WATCHDOG_ERROR
    );
    drupal_set_message(t('Could not create conference %title because a Blue Jeans error occurred: !code !error',
      array('%title' => $conference->title, '!code' => $response->code, '!error' => $response->error)
    ), 'error');
    return;
  }
  $meeting_id = json_decode($response->data);
  $conference->meeting_id = empty($meeting_id) ? $updating_meeting_id : $meeting_id->id;

  // Read the conference again for full metadata :-(
  $response = drupal_http_request(
    url(BLUEJEANS_ENDPOINT . '/v1/user/' . $_SESSION['bluejeans']->user->id . '/scheduled_meeting/' . $conference->meeting_id,
      array('absolute' => TRUE, 'query' => array('access_token' => $_SESSION['bluejeans']->access_token))
    )
  );
  if ($response->code != 200) {
    watchdog('bluejeans', 'Error fetching conference metadata: !code !error',
      array('!code' => $response->code, '!error' => $response->error),
      WATCHDOG_ERROR
    );
    drupal_set_message(t('Could not create fetch conference data because a Blue Jeans error occurred: !code !error',
      array('!code' => $response->code, '!error' => $response->error)
    ), 'error');
    $response->data = array();
  }
  $conference->metadata = $response->data;

  // Save meeting locally.
  $conference->start = strtotime($form_state['values']['start']);
  $conference->end = strtotime($form_state['values']['end']);
  $result = drupal_write_record('bluejeans_conference', $conference, $updating_meeting_id ? array('meeting_id') : array());
  if (!$updating_meeting_id) {
    $conference->nid = $form['#node']->nid;
    drupal_write_record('bluejeans_conferences_nodes', $conference);
  }

  // Inform other modules we've scheduled a conference.
  module_invoke_all('bluejeans_conference', $updating_meeting_id ? 'update' : 'insert', $conference);

  // Inform user of success.
  if ($updating_meeting_id) {
    drupal_set_message(t('Updated conference %title.', array('%title' => $conference->title)));
  }
  else {
    drupal_set_message(t('Scheduled conference %title.', array('%title' => $conference->title)));
  }
}

/**
 * Implementation of hook_bluejeans_conference().
 */
function bluejeans_bluejeans_conference($op, $conference) {
  if ($op === 'insert' && module_exists('translation')) {
    // Insert same conference for translated nodes.
    $node = node_load($conference->nid);
    if (!empty($node->tnid)) foreach (translation_node_get_translations($node->tnid) as $translation) {
      if ($translation->nid != $conference->nid) {
        $translation->meeting_id = $conference->meeting_id;
        drupal_write_record('bluejeans_conferences_nodes', $translation);
      }
    }
  }
}

/**
 * Implements hook_theme().
 */
function bluejeans_theme() {
  return array(
    'bluejeans_conferences' => array(
      'variables' => array('conferences' => array(), 'node' => NULL),
    ),
    'bluejeans_conferences_teaser' => array(
      'variables' => array('conferences' => array(), 'node' => NULL),
    ),
    'bluejeans_conference' => array(
      'variables' => array('conference' => NULL, 'node' => NULL),
      'template' => 'conference',
    ),
  );
}

/**
 * Theme function for `bluejeans_conferences`.
 */
function theme_bluejeans_conferences($variables) {
  $conferences = $variables['conferences'];
  $node = $variables['node'];
  $output = '';
  if (!empty($conferences)) {
    if (!bluejeans_authenticate()) {
      drupal_set_message(t('Could not authenticate to Blue Jeans. Display aborted.'), 'error');
      return $output;
    }
    global $user;
    global $language;
    $account = $user;
    $account->is_conference_owner = user_access('administer bluejeans conference');
    drupal_add_js(drupal_get_path('module', 'bluejeans') . '/bluejeans.js');
    drupal_add_js(array('BlueJeans' => array(
      'user' => $account,
      'session' => $_SESSION['bluejeans'],
      'basePathLocalized' => rtrim(url('<front>', array('language' => $language)), '/') . '/',
    )), 'setting');
    $items = array();
    foreach ($conferences as $conference) {
      $items[] = theme('bluejeans_conference', array('conference' => $conference, 'node' => $node));
    }
    $output = theme('item_list', array('items' => $items));
  }
  return $output;
}

/**
 * Theme function for `bluejeans_conferences_teaser`.
 */
function theme_bluejeans_conferences_teaser($variables) {
  $conferences = $variables['conferences'];
  $node = $variables['node'];
  return format_plural(count($conferences),
    'There is 1 conference scheduled in this !type for today. !join',
    'There are @count conferences scheduled in this !type for today. !join',
    array(
      '!join' => l(t('Click here to join.'), 'node/' . $node->nid),
      '!type' => t($node->type),
    )
  );
}

/**
 * Theme preprocessor for `bluejeans_conference`.
 */
function bluejeans_preprocess_bluejeans_conference(&$variables) {
  $conference = $variables['conference'];
  $node = $variables['node'];
  $conference->nid = $node->nid; // make sure JavaScript has the nid of the current node
  $node = node_load($conference->nid);
  $variables['title'] = $conference->title;
  $variables['description'] = $conference->description;
  $variables['start_date'] = format_date($conference->start, 'custom', 'j M');
  $variables['start_time'] = format_date($conference->start, 'custom', 'h:iA') . ' ' . _bluejeans_timezone_abbreviation(date_default_timezone());
  $variables['duration'] = format_interval($conference->end - $conference->start);
  drupal_add_js(array('BlueJeans' => array('meetings' => array(
    // For some reason, array_merge_recursive() doesn't honour numeric keys.
    // So we add the 'key.' prefix here to convert the ID to a string.
    // We'll do the same on the JavaScript side when reading the array.
    'key.' . $conference->meeting_id => $conference,
  ))), 'setting');
}

/**
 * Get the timezone's abbreviation.
 */
function _bluejeans_timezone_abbreviation($timezone_name) {
  $dateTime = new DateTime();
  $dateTime->setTimeZone(new DateTimeZone($timezone_name));
  return $dateTime->format('T'); 
}

/**
 * Implements hook_node_view().
 */
function bluejeans_node_view($node, $view_mode, $langcode) {
  if (in_array($node->type, variable_get('bluejeans_types', array()))) {
    // Conference list.
    if ($view_mode === 'teaser') { // teaser mode - show message for active or upcoming conferences only
      $conferences = bluejeans_node_conferences_local($node, TRUE);
      if (!empty($conferences)) {
        $node->content['conferences'] = array(
          '#markup' => theme('bluejeans_conferences_teaser', array('conferences' => $conferences, 'node' => $node)),
        );
      }
    }
    else { // full mode or any custom mode - show full conferences list
      $conferences = bluejeans_node_conferences_local($node);
      if (!empty($conferences)) {
        $node->content['conferences'] = array(
          '#markup' => theme('bluejeans_conferences', array('conferences' => $conferences, 'node' => $node)),
        );
      }
    }
    // New conference link.
    if (user_access('administer bluejeans conference') && in_array($view_mode, variable_get('bluejeans_view_modes_links', array('full')))) {
      $links['conference_create_link'] = array(
        'title' => t('Schedule new conference'),
        'href' => 'conference/' . $node->nid . '/new',
        'query' => array('destination' => 'node/' . $node->nid),
      );
      $node->content['links']['conference_create'] = array(
        '#theme' => 'links',
        '#links' => $links,
        '#attributes' => array('class' => array('links', 'inline')),
      );
    }
  }
}

/**
 * Implements hook_field_extra_fields().
 */
function bluejeans_field_extra_fields() {
  $fields = array();
  foreach(variable_get('bluejeans_types', array()) as $type) {
    $fields['node'][$type]['display'] = array(
      'conferences' => array(
        'label' => t('Blue Jeans conferences'),
        'description' => t('List of Blue Jeans conferences associated with this node.'),
        'weight' => 0,
      ),
    );
  }
  return $fields;
}

/**
 * Implements hook_node_delete().
 */
function bluejeans_node_delete($node) {
  if (in_array($node->type, variable_get('bluejeans_types', array()))) {
    $found = FALSE;
    foreach (bluejeans_node_conferences_local($node) as $conference) {
      $found = _bluejeans_conference_delete($conference);
    }
    if ($found) {
      drupal_set_message(t('Deleted conferences for node %title.', array('%title' => $node->title)));
    }
  }
}

/**
 * Implements hook_node_insert().
 */
function bluejeans_node_insert($node) {
  if (in_array($node->type, variable_get('bluejeans_types', array())) && module_exists('translation')) {
    if (!empty($node->translation_source)) {
      $source = node_load($node->translation_source->nid);
      foreach (bluejeans_node_conferences_local($source) as $conference) {
        $conference->nid = $node->nid;
        drupal_write_record('bluejeans_conferences_nodes', $conference);
      }
    }
  }
}

/**
 * Authenticate with BlueJeans service.
 */
function bluejeans_authenticate($force = FALSE) {
  // Check expiration time before requesting new token.
  if (empty($force) &&
      !empty($_SESSION['bluejeans']->access_token) &&
      !empty($_SESSION['bluejeans']->expires_at) &&
      $_SESSION['bluejeans']->expires_at > time()
  ) {
    return TRUE;
  }

  // Get group admin access token.
  $response = drupal_http_request(
    BLUEJEANS_ENDPOINT . '/oauth2/token',
    array(
      'method' => 'POST',
      'data' => json_encode(array(
        'grant_type' => 'client_credentials',
        'client_id' => variable_get('bluejeans_appkey', ''),
        'client_secret' => variable_get('bluejeans_appsecret', ''),
      ))
    )
  );
  if ($response->code != 200) {
    unset($_SESSION['bluejeans']);
    watchdog('bluejeans', 
      'Authentication failed: !code !error. Cannot continue authentication process.', 
      array('!error' => $response->error, '!code' => $response->code), 
      WATCHDOG_ERROR
    );
    return FALSE;
  }
  $_SESSION['bluejeans'] = json_decode($response->data);
  $_SESSION['bluejeans']->expires_at = time() + $_SESSION['bluejeans']->expires_in;

  // Get main user ID.
  $response = drupal_http_request(
    url(BLUEJEANS_ENDPOINT . '/v1/enterprise/' . $_SESSION['bluejeans']->scope->enterprise . '/users',
      array('absolute' => TRUE, 'query' => array(
        'access_token' => $_SESSION['bluejeans']->access_token,
      ))
    )
  );
  if ($response->code != 200) {
    unset($_SESSION['bluejeans']);
    watchdog('bluejeans', 
      'Error fetching user list: !code !error. Cannot continue authentication process.',
      array('!error' => $response->error, '!code' => $response->code), 
      WATCHDOG_ERROR
    );
    return FALSE;
  }
  $users = json_decode($response->data);
  if (empty($users->count)) {
    unset($_SESSION['bluejeans']);
    watchdog('bluejeans', 
      'No users found. Cannot continue authentication process.', 
      array(), 
      WATCHDOG_ERROR
    );
    return FALSE;
  }
  foreach($users->users as $user) {
    $response = drupal_http_request(
      url(BLUEJEANS_ENDPOINT . '/v1/user/' . $user->id,
        array('absolute' => TRUE, 'query' => array('access_token' => $_SESSION['bluejeans']->access_token))
      )
    );
    if ($response->code == 200) {
      $user = json_decode($response->data);
      // Search for configured username.
      if ($user->username == variable_get('bluejeans_username', '')) {
        $_SESSION['bluejeans']->user = $user;
        break;
      }
    }
  }
  if (empty($_SESSION['bluejeans']->user)) {
    unset($_SESSION['bluejeans']);
    watchdog('bluejeans', 
      'User !user not found. Cannot continue authentication process.', 
      array('!user' => variable_get('bluejeans_username', t('[empty username]'))), 
      WATCHDOG_ERROR
    );    
    return FALSE; 
  }
  
  // Get user's room details.
  $response = drupal_http_request(
    url(BLUEJEANS_ENDPOINT . '/v1/user/' . $_SESSION['bluejeans']->user->id . '/room',
      array('absolute' => TRUE, 'query' => array('access_token' => $_SESSION['bluejeans']->access_token))
    )
  );
  if ($response->code != 200) {
    unset($_SESSION['bluejeans']);
    watchdog('bluejeans', 
      'Error fetching user room: !code !error. Cannot continue authentication process.', 
      array('!code' => $response->code, '!error' => $response->error), 
      WATCHDOG_ERROR
    );    
    return FALSE;   
  }
  $_SESSION['bluejeans']->user->room = json_decode($response->data);

  return TRUE;
}

/**
 * Get list of all conferences from BlueJeans service.
 */
function bluejeans_conferences_remote($sync = FALSE) {
  if (!bluejeans_authenticate()) {
    return array();
  }

  $response = drupal_http_request(
    url(BLUEJEANS_ENDPOINT . '/v1/user/' . $_SESSION['bluejeans']->user->id . '/scheduled_meeting',
      array('absolute' => TRUE, 'query' => array('access_token' => $_SESSION['bluejeans']->access_token))
    )
  );
  if ($response->code != 200) {
    watchdog('bluejeans', 'Error fetching conferences: !code !error',
      array('!code' => $response->code, '!error' => $response->error),
      WATCHDOG_ERROR
    );
    return array();
  }
  $conferences = json_decode($response->data);

  // Sync with local data if needed.
  if ($sync) foreach ($conferences as $conference) {
    $c = (object)array(
      'meeting_id' => $conference->id,
      'title' => $conference->title,
      'description' => $conference->description,
      'start' => $conference->start / 1000, // in sec
      'end' => $conference->end / 1000, // in sec
      'metadata' => json_encode($conference),
    );
    // Only update existing records.
    $result = drupal_write_record('bluejeans_conference', $c, 'meeting_id');
  }

  return $conferences;
}

/**
 * Get list of conferences related to given node from local database.
 *
 * @param object $node
 *   Node object
 * @param bool $today
 *   (optional) Flag to only return today's active or upcoming conferences
 * @return array
*    Array of conference objects associated with given node, can be empty
 */
function bluejeans_node_conferences_local($node, $today = FALSE) {
  $clause = '';
  if ($today) {
    $clause = "AND DATE(FROM_UNIXTIME(c.start)) = CURDATE() AND c.end > UNIX_TIMESTAMP()";
  }
  return db_query("
    SELECT * FROM {bluejeans_conference} c
    LEFT JOIN {bluejeans_conferences_nodes} cn ON c.meeting_id = cn.meeting_id
    WHERE cn.nid = :nid $clause ORDER BY c.start DESC
  ", array(':nid' => $node->nid))->fetchAll();
}

/**
 * Get conference status from BlueJeans service.
 */
function bluejeans_conference_status($conference) {
  if (!bluejeans_authenticate()) {
    drupal_json_output((object)array('error' => t('Could not authenticate to Blue Jeans. Operation aborted.')));
    exit;
  }

  // Get meeting state.
  $metadata = json_decode($conference->metadata);
  $response = drupal_http_request(
    url(BLUEJEANS_ENDPOINT . '/v1/user/' . $_SESSION['bluejeans']->user->id . '/live_meetings/' . $metadata->numericMeetingId,
      array('absolute' => TRUE, 'query' => array('access_token' => $_SESSION['bluejeans']->access_token))
    )
  );
  if ($response->code != 200) {
    if ($response->code == 404) {
      // 404 means meeting not live.
      drupal_json_output((object)array('status' => 'inactive'));
      exit;
    }
    else {
      watchdog('bluejeans', 'Error fetching conference status: !code !error',
        array('!code' => $response->code, '!error' => $response->error),
        WATCHDOG_ERROR
      );
      drupal_json_output((object)array('error' => t('Could not fetch conference status: !code !error',
        array('!code' => $response->code, '!error' => $response->error)
      )));
      exit;
    }
  }
  drupal_json_output(json_decode($response->data)); // response arrives already JSON-encoded
  exit;
}

/**
 * Get conference endpoints from BlueJeans service.
 */
function bluejeans_conference_endpoints($conference) {
  if (!bluejeans_authenticate()) {
    drupal_json_output((object)array('error' => t('Could not authenticate to Blue Jeans. Operation aborted.')));
    exit;
  }

  // Get meeting endpoints.
  $metadata = json_decode($conference->metadata);
  $response = drupal_http_request(
    url(BLUEJEANS_ENDPOINT . '/v1/user/' . $_SESSION['bluejeans']->user->id . '/live_meetings/' . $metadata->numericMeetingId . '/endpoints',
      array('absolute' => TRUE, 'query' => array('access_token' => $_SESSION['bluejeans']->access_token))
    )
  );
  if ($response->code != 200) {
    watchdog('bluejeans', 'Error fetching conference endpoints: !code !error',
      array('!code' => $response->code, '!error' => $response->error),
      WATCHDOG_ERROR
    );
    drupal_json_output((object)array('error' => t('Could not fetch conference participants: !code !error',
      array('!code' => $response->code, '!error' => $response->error)
    )));
    exit;
  }
  drupal_json_output(json_decode($response->data)); // response arrives already JSON-encoded
  exit;
}

/**
 * Implements hook_permission().
 */
function bluejeans_permission() {
  return array(
    'administer bluejeans conference' => array(
      'title' => t('Administer Blue Jeans conferences'),
      'description' => t('Perform administration tasks for Blue Jeans conferences.'),
    ),
  );
}
