<?php

/**
 * @file
 * Implements pickpack pont export method.
 */

/**
 * Implements hook_menu().
 */
function commerce_pickpackpoints_export_menu() {
  $items = array();

  $items['admin/commerce/pickpack-export'] = array(
    'title' => 'Pick-pack orders export',
    'description' => 'Export to CSV file the pick-pack pont orders.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('commerce_pickpackpoints_export_admin_form'),
    'access arguments' => array('order_export_access'),
    'file' => 'includes/pickpackpoints_export.adminform.inc',
  );

  $items['admin/commerce/pickpack-export-result/%'] = array(
    'title' => 'Export result',
    'page callback' => 'commerce_pickpackpoints_export_result_page',
    'page arguments' => array(3),
    'access arguments' => array('order_export_access'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function commerce_pickpackpoints_export_permission() {
  return array(
    'order_export_access' => array(
      'title' => t('Order export access'),
      'description' => t('order export access'),
    ),
  );
}

/**
 * Destination for result.
 */
function commerce_pickpackpoints_export_result_page($filename) {
  return array(
    '#markup' => l(
        t('File %name download.', array('%name' => $filename)), file_create_url('public://ppp_exports') . '/' . $filename, array('html' => TRUE)),
  );
}

/**
 * Return the shipping or billing commerce profile.
 */
function commerce_pickpackpoints_export_get_commerce_profile($order = NULL) {
  $profile = NULL;
  if (!empty($order)) {
    // Load billing profile.
    $profile = commerce_customer_profile_load($order->commerce_customer_shipping[LANGUAGE_NONE][0]['profile_id']);
    if (empty($profile)) {
      // No billing profile load shipping profile.
      $profile = commerce_customer_profile_load($order->commerce_customer_billing[LANGUAGE_NONE][0]['profile_id']);
    }
  }
  return $profile;
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function commerce_pickpackpoints_export_form_commerce_pickpackpoints_settings_alter(&$form, $form_state) {
  $form['pickpack_export'] = array(
    '#type' => 'fieldset',
    '#title' => t("Settigs of Pick-pack export"),
  );

  $form['pickpack_export']['add_phone_field'] = array(
    '#type' => 'fieldset',
    '#title' => t("Phone field in commerce shipping profile"),
  );

  $phone_field = variable_get('ppp_phone_field', 'pickpack_phone');
  $form['pickpack_export']['add_phone_field']['ppp_phone_field'] = array(
    '#type' => 'textfield',
    '#title' => t('Phone field name on commerce shipping profile'),
    '#default_value' => $phone_field,
  );

  if (!field_info_field('pickpack_phone')) {
    // Before created a field name pickpack_phone.
    $form['pickpack_export']['add_phone_field']['add_phone_field_submit'] = array(
      '#type' => 'submit',
      '#value' => t('Add phone field'),
      '#submit' => array('commerce_pickpackpoints_export_add_phone_field_submit'),
    );
  }

  if (!field_info_field('pickpack_phone') && $phone_field == 'pickpack_phone') {
    drupal_set_message(t('It must create phone field click to button or add correct name of phone field from commerce customer profile.'), 'warning');
  }

  $form['pickpack_export']['add_phone_field']['phone_field_decription'] = array(
    '#markup' => t('Must have a phone field in customer shipping profile to able create CSV export to pick-pack pont service.'),
    '#prefix' => '<p>',
    '#suffix' => '</p>',
  );

  $form['pickpack_export']['ppp_prefix'] = array(
    '#type' => 'textfield',
    '#title' => t('Prefix to pick-pack export data'),
    '#description' => t('This prefix will using in CSV file pack id and delivery id.'),
    '#default_value' => variable_get('ppp_prefix', 'ppp'),
  );

  $form['pickpack_export']['pickpack_export_statuses'] = array(
    '#type' => 'checkboxes',
    '#title' => t('Commerce order statuses'),
    '#description' => t('Select what statuses want to export to CSV file.'),
    '#options' => drupal_map_assoc(array_keys(commerce_order_statuses())),
    '#default_value' => variable_get('pickpack_export_statuses', array('pending')),
  );
}

/**
 * Add phone field to commerce shipping profile.
 */
function commerce_pickpackpoints_export_add_phone_field_submit($form, &$form_state) {
  // Empty field cache.
  field_cache_clear();
  field_associate_fields('pickpack_phone');

  if (field_info_field('pickpack_phone')) {
    // Before created a field name pickpack_phone.
    return;
  }

  // Prepare field.
  $field = array(
    'field_name' => 'pickpack_phone',
    'type' => 'number_integer',
  );

  // Create field.
  $field = field_create_field($field);

  // Prepare and create the instance on the bundle.
  $instance = array(
    'field_name' => $field['field_name'],
    'entity_type' => 'commerce_customer_profile',
    'bundle' => 'shipping',
    'label' => t('Phone number'),
    'description' => 'Customer phone number',
    'required' => TRUE,
    'settings' => array('max_length' => 15),
    'widget' => array('number'),
    'locked' => FALSE,
  );

  field_create_instance($instance);
}
