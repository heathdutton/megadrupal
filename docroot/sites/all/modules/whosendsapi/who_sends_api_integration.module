<?php

/**
 * @file
 * Module file for who_sends_api_integration   
 */

/**
 * Implements hook_help().
 */
function who_sends_api_integration_help($path, $arg) {
  $output = '<p>' . t('This module integrates with the WhoSends email spoofing
    and phishing system API enabling administrators and users to send email
    that is tagged with their own secure key image.') . '</p>';
  $output .= '<p>' . t('The module integrates with drupals core mail module to
    add the key image to the top or bottom of outgoing email, more information
    about whosends can be found here ') . l(t('https://www.whosends.com'), 'https://www.whosends.com') . '</p>';
  return ($path == 'admin/help#who_sends_api_integration') ? $output : '';
}

/**
 * Implements hook_menu().
 */
function who_sends_api_integration_menu() {
  $items = array();

  $items['admin/config/services/who_sends_api_integration'] = array(
    'title' => 'Who Sends API Integration',
    'description' => 'Configuration for Who Sends Module',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('who_sends_api_integration_form'),
    'access arguments' => array('administer site configuration'),
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * Implements hook_form().
 */
function who_sends_api_integration_form($node, &$form_state) {
  $form = array();
  $form['who_sends_api_integration_api_url'] = array(
    '#type' => 'textfield',
    '#title' => t('URL'),
    '#description' => t('The URL to the API.'),
    '#default_value' => variable_get('who_sends_api_integration_api_url', 'https://www.whosends.com/api/getmsgaccess'),
    '#required' => TRUE,
    '#weight' => 1,
  );
  $form['who_sends_api_integration_registered_domain'] = array(
    '#type' => 'textfield',
    '#title' => t('Registered Domain (domain)'),
    '#description' => t('The name of the domain of the sender, as registered in WhoSends.'),
    '#default_value' => variable_get('who_sends_api_integration_registered_domain', 'test.com'),
    '#required' => TRUE,
    '#weight' => 2,
  );

  $form['who_sends_api_integration_appkey'] = array(
    '#type' => 'textfield',
    '#title' => t('Application Key (appkey)'),
    '#description' => t('The application key, as registered in WhoSends'),
    '#default_value' => variable_get('who_sends_api_integration_appkey', 'afb654dfeefcc876'),
    '#required' => TRUE,
    '#weight' => 3,
  );

  $form['who_sends_api_integration_url_duration'] = array(
    '#type' => 'textfield',
    '#title' => t('Url Duration (duration)'),
    '#description' => t('The number of days the key phrase image access URL will be valid.'),
    '#default_value' => variable_get('who_sends_api_integration_url_duration', 30),
    '#required' => TRUE,
    '#weight' => 4,
  );

  $form['who_sends_api_integration_format'] = array(
    '#type' => 'select',
    '#options' => array(
      0 => 'html',
      1 => 'text',
    ),
    '#title' => t('String format'),
    '#description' => t('The format of the returned string.'),
    '#default_value' => variable_get('who_sends_api_integration_format', 0),
    '#required' => TRUE,
    '#weight' => 5,
  );

  $form['who_sends_api_integration_image_location'] = array(
    '#type' => 'select',
    '#options' => array(
      0 => 'top',
      1 => 'bottom',
    ),
    '#title' => t('Image location'),
    '#description' => t('This defines the location of the text on the generated emails.'),
    '#default_value' => variable_get('who_sends_api_integration_image_location', 0),
    '#required' => TRUE,
    '#weight' => 6,
  );

  return system_settings_form($form);
}

/**
 * Implements hook_mail_alter().
 */
function who_sends_api_integration_mail_alter(&$message) {
  $key = variable_get('who_sends_api_integration_appkey', 'afb654dfeefcc876');
  $duration = variable_get('who_sends_api_integration_url_duration', 30);
  $domain = variable_get('who_sends_api_integration_registered_domain', 'test.com');
  $url = variable_get('who_sends_api_integration_api_url', 'https://www.whosends.com/api/getmsgaccess');
  $format = (variable_get('who_sends_api_integration_format', 0) == 0) ? 'html' : 'text';
  $image = drupal_http_request($url . '?domain=' . $domain . '&appkey=' . $key . '&email=' . $message['to'] . '&duration=' . $duration . '&format=' . $format);
  // Put test at the start or end of the form.
  if (variable_get('who_sends_api_integration_image_location', 1) == 0) {
    array_unshift($message['body'], $image->data);
  }
  else {
    array_push($message['body'], $image->data);
  }
  // If its html at wrappers.
  if ($format == 'html') {
    array_unshift($message['body'], '<html><body>');
    array_push($message['body'], '</body></html>');
    $message['headers']['Content-Type'] = 'text/html; charset=UTF-8';
  }
}
