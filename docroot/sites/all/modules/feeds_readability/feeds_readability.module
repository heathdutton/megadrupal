<?php

/**
 * @file
 * Provides a Feeds Parser plugin that runs the Readbility library
 * to extract the content and title of a webpage.
 */


/**
 * Implements hook_feeds_plugins().
 */
function feeds_readability_feeds_plugins() {
  $info = array();
  $info['FeedsReadabilityParser'] = array(
    'name' => 'Readability parser',
    'description' => 'Use the Readbility library to extract the title and content of a webpage',
    'handler' => array(
      'parent' => 'FeedsParser',
      'class' => 'FeedsReadabilityParser',
      'file' => 'FeedsReadabilityParser.inc',
      'path' => drupal_get_path('module', 'feeds_readability') . '/plugins',
    ),
  );
  return $info;
}

/**
 * Implements hook_libraries_info().
 *
 * Register the php-readability library.
 */
function feeds_readability_libraries_info() {
  $libraries['php-readability'] = array(
    'name' => 'PHP Readability',
    'vendor url' => 'http://code.fivefilters.org/php-readability/',
    'download url' => 'http://code.fivefilters.org/php-readability/src',
    'version callback' => 'feeds_readability_get_version',
    'files' => array(
      'php' => array(
        'Readability.php',
      ),
    ),
  );
  return $libraries;
}

/**
 * Version callback.  Get the version of the php-readability library.
 */
function feeds_readability_get_version($library) {

  // This seems a little silly.  To get the version, I need to load the whole
  // library anyway.
  $file = DRUPAL_ROOT . '/' . $library['library path'] . '/' . 'Readability.php';
  require_once $file;
  $reflector = new ReflectionClass('Readability');
  $properties = $reflector->getDefaultProperties();
  return $properties['version'];
}
