<?php

/**
 * @file
 * Module hooks and functions for the Google Search Collections module.
 */


/**
 * Implements hook_permission().
 */
function google_search_collections_permission() {
  return array(
    'administer google search collections' => array(
      'title' => t('Administer google search collections'),
      'description' => t('Add, update, and export search collection configs.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function google_search_collections_menu() {
  $prefix = 'search';
  $items = array();

  // Global configurations.
  $items['admin/structure/google-search-collections/settings'] = array(
    'title' => 'Global settings',
    'description' => 'Configure global settings related to Google search collections.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('google_search_collections_settings'),
    'file' => 'google_search_collections.admin.inc',
    'type' => MENU_LOCAL_TASK,
    'access arguments' => array('administer google search collections'),
  );

  // Adding menu items for defined collections.
  drupal_static_reset('search_get_info');
  $default_info = search_get_default_module_info();
  foreach (google_search_collections_get_definitions() as $path => $definition) {
    // Ignore disabled collections.
    if (isset($definition->disabled) && $definition->disabled) {
      continue;
    }

    $items[$prefix . '/' . $path] = array(
      'title' => $definition->title,
      'page callback' => 'google_search_collections_search',
      'page arguments' => array($path, ''),
      'type' => MENU_LOCAL_TASK,
      'weight' => isset($definition->data['weight']) ? $definition->data['weight'] : 0,
    );

    $items[$prefix . '/' . $path . '/%menu_tail'] = array(
      'title' => $definition->title,
      'load arguments' => array('%map', '%index'),
      'page callback' => 'google_search_collections_search',
      'page arguments' => array($path, 2),
      'type' => MENU_LOCAL_TASK,
      'weight' => isset($definition->data['weight']) ? $definition->data['weight'] : 0,
      'tab_root' => $prefix . '/' . $default_info['path'] . '/%',
      'tab_parent' => $prefix . '/' . $default_info['path'],
    );

    // Apply appropriate access grants / arguments.
    if (isset($definition->data['module'])) {
      if ($definition->data['module'] === 'gss') {
        $items[$prefix . '/' . $path]['access callback'] = '_search_menu_access';
        $items[$prefix . '/' . $path]['access arguments'] = array('gss');
        $items[$prefix . '/' . $path . '/%menu_tail']['access callback'] = '_search_menu_access';
        $items[$prefix . '/' . $path . '/%menu_tail']['access arguments'] = array('gss');
      }
      elseif ($definition->data['module'] === 'google_appliance') {
        $items[$prefix . '/' . $path]['access arguments'] = array('access_google_appliance_content');
        $items[$prefix . '/' . $path . '/%menu_tail']['access arguments'] = array('access_google_appliance_content');

        // Google Appliance has a tertiary argument representing sort. It
        // represents a duplicate and should consequently be hidden.
        $items[$prefix . '/' . $path . '/%/%'] = $items[$prefix . '/' . $path . '/%menu_tail'];
        $items[$prefix . '/' . $path . '/%/%']['page arguments'][] = 3;
        $items[$prefix . '/' . $path . '/%/%']['type'] = MENU_NORMAL_ITEM;

        // Replace the %menu_tail menu item with just a single argument.
        $items[$prefix . '/' . $path . '/%'] = $items[$prefix . '/' . $path . '/%menu_tail'];
        unset($items[$prefix . '/' . $path . '/%menu_tail']);
      }
    }
  }

  return $items;
}

/**
 * Implements hook_menu_alter().
 */
function google_search_collections_menu_alter(&$menu) {
  // Remove the default GSS search local task in favor of our collections.
  if (variable_get('google_search_collections_unset_module_defaults', TRUE)) {
    unset($menu['search/gss'], $menu['search/gss/%menu_tail']);
    unset($menu[google_search_collections_get_gsa_path()]);
  }
}

/**
 * Page callback, wraps GSA or GSS search page views for maximum control.
 *
 * @param string $collection
 *   The Google Search collection for which the current search is taking place.
 *
 * @param string $keys
 *   The search query.
 *
 * @return
 *   Themed search results for the given collection and keys.
 */
function google_search_collections_search($collection, $keys = '') {
  $definition = google_search_collections_get_definition($collection);

  if ($definition->data['module'] === 'gss') {
    require_once(drupal_get_path('module', 'search') . '/search.pages.inc');
    $callback = 'search_view';
    $arguments = array('gss', $keys);
  }
  elseif ($definition->data['module'] === 'google_appliance') {
    $callback = 'google_appliance_search_view';
    $arguments = array($keys, func_num_args() > 2 ? func_get_arg(2) : NULL);
  }
  else {
    $callback = FALSE;
  }

  return $callback ? call_user_func_array($callback, $arguments) : FALSE;
}

/**
 * Implements hook_form_alter().
 */
function google_search_collections_form_alter(&$form, &$form_state, $form_id) {
  if (!$collection = google_search_collections_get_active_collection()) {
    $collection = google_search_collections_get_default_collection();
  }

  switch ($form_id) {
    // Perform clean-up here.
    case 'google_appliance_search_form':
    case 'google_appliance_block_form':
      if (isset($form['basic']['search_keys']['#default_value'])) {
        $definition = google_search_collections_get_definition($collection);
        $queryterms = isset($definition->data['queryterms']) ? ' ' . $definition->data['queryterms'] : '';
        $form['basic']['search_keys']['#default_value'] = str_replace($queryterms, '', $form['basic']['search_keys']['#default_value']);
      }

    case 'search_form':
    case 'search_block_form':
    case 'search_theme_form':
      $form['#submit'][] = 'google_search_collections_search_submit';
      $form['#action'] = str_replace('/gss', '/' . $collection, $form['#action']);
      $form['#action'] = str_replace(google_search_collections_get_gsa_path(), $collection, $form['#action']);
      break;
  }
}

/**
 * Implements hook_gss_search_key_alter().
 */
function google_search_collections_gss_search_key_alter(&$key) {
  $collection = google_search_collections_get_active_collection();
  $definition = google_search_collections_get_definition($collection);

  // Apply query terms.
  if (isset($definition->data['queryterms']) && !empty($definition->data['queryterms'])) {
    $key .= ' ' . check_plain($definition->data['queryterms']);
  }
}

/**
 * Implements hook_google_appliance_query_alter().
 */
function google_search_collections_google_appliance_query_alter(&$query) {
  $collection = google_search_collections_get_active_collection();
  $definition = google_search_collections_get_definition($collection);

  // Apply query terms.
  if (isset($definition->data['queryterms']) && !empty($definition->data['queryterms'])) {
    $query['gsa_query_params']['q'] .= ' ' . check_plain($definition->data['queryterms']);
  }

  // Apply GSA collection.
  if (isset($definition->data['collection']) && !empty($definition->data['collection'])) {
    $query['gsa_query_params']['site'] = $definition->data['collection'];
  }

  // Apply GSA frontend.
  if (isset($definition->data['frontend']) && !empty($definition->data['frontend'])) {
    $query['gsa_query_params']['client'] = $definition->data['frontend'];
  }

  // Apply required fields.
  if (isset($definition->data['requiredfields']) && !empty($definition->data['requiredfields'])) {
    $query['gsa_query_params']['requiredfields'] = $definition->data['requiredfields'];
  }
}

/**
 * Implements hook_preprocess_google_appliance_sort_headers().
 *
 * This is used to rewrite the URL generated for date/relevance sorting to get
 * rid of query parameter re-writes.
 */
function google_search_collections_preprocess_google_appliance_sort_headers(&$vars) {
  google_search_collections_clean_path($vars['sorters'][0]['display']);
  google_search_collections_clean_path($vars['sorters'][1]['display']);
}

/**
 * Implements hook_preprocess_gss_result().
 *
 * Ensures that "inurl" and other pseudo parameters are not included in user-
 * facing search text.
 */
function google_search_collections_preprocess_gss_result(&$variables) {
  $result = $variables['result'];
  if (empty($result['link']) && empty($result['title'])) {
    $default_no_results = variable_get('gss_no_results', array(
      'value' => t('No results'),
      'format' => NULL,
    ));
    $empty_results = format_string($default_no_results['value'], array(
      '@query' => arg(2),
    ));
    $variables['snippet'] = check_markup($empty_results, $default_no_results['format']);
  }
}

/**
 * Submit handler for the GSS search form.
 */
function google_search_collections_search_submit($form, &$form_state) {
  if (!$collection = google_search_collections_get_active_collection()) {
    $collection = google_search_collections_get_default_collection();
  }

  if (is_array($form_state['redirect'])) {
    $redirect_to = &$form_state['redirect'][0];
  }
  else {
    $redirect_to = &$form_state['redirect'];
  }

  $redirect_to = str_replace('/gss', '/' . $collection, $redirect_to);
  if ($gsaPath = google_search_collections_get_gsa_path()) {
    $redirect_to = str_replace('/' . $gsaPath, '/search/' . $collection, $redirect_to);
  }
}

/**
 * Returns the current, active Google Search collection.
 *
 * @return string|bool
 *   The current active search collection, or false if no collection could be
 *   found.
 */
function google_search_collections_get_active_collection() {
  $args = arg();
  if (count($args) >= 2 && $args[0] === 'search') {
    return $args[1];
  }
  else {
    return FALSE;
  }
}

/**
 * Returns the default Google Search collection.
 */
function google_search_collections_get_default_collection() {
  // If none is provided, assume the first provided is the default.
  if (!$default = variable_get('google_search_collections_default_collection', FALSE)) {
    $default = key(google_search_collections_get_definitions());
  }

  return $default;
}

/**
 * Returns a single collection definition.
 *
 * @param string $collection
 *   The desired Google Search collection.
 *
 * @return object|bool
 *   Returns the collection definition if one is found, FALSE otherwise.
 */
function google_search_collections_get_definition($collection) {
  $definitions = google_search_collections_get_definitions();
  return isset($definitions[$collection]) ? $definitions[$collection] : FALSE;
}

/**
 * Helper function that returns all currently known search collection configs.
 *
 * @param bool $reset
 *   (Optional) Whether or not the search collection definitions should be
 *   re-calculated. Defaults to FALSE.
 */
function google_search_collections_get_definitions($reset = FALSE) {
  $definitions = drupal_static(__FUNCTION__, array());

  if ($definitions === array() || $reset) {
    ctools_include('export');
    ctools_export_load_object_reset('google_search_collections');
    $definitions = ctools_export_load_object('google_search_collections', 'all');
  }

  // Sort definitions by defined weight.
  uasort($definitions, 'google_search_collections_sort_definitions');

  return $definitions;
}

/**
 * Passes the given path through a series of filters to ensure links pointing
 * back at the search results page point to the right page with the expected
 * search query.
 *
 * @param string $path
 *   A reference to a string representing a link to a search result page.
 */
function google_search_collections_clean_path(&$path) {
  $activeCollection = google_search_collections_get_active_collection();
  $conf = google_search_collections_get_definition($activeCollection);
  $hasQueryTerms = isset($conf->data['queryterms']) && !empty($conf->data['queryterms']);
  $expectedPathPart = 'search/' . $conf->path . '/';

  if ($hasQueryTerms) {
    $term = ' ' . $conf->data['queryterms'];
    $path = str_replace($term, '', $path);
    $path = str_replace(drupal_encode_path($term), '', $path);
  }

  // Account for Google Appliance search path.
  if ($gsaPath = google_search_collections_get_gsa_path()) {
    $path = str_replace($gsaPath . '/', $expectedPathPart, $path);
  }
}

/**
 * Implements hook_ctools_plugin_directory().
 */
function google_search_collections_ctools_plugin_directory($module, $type) {
  // Load the export_ui plugin.
  if ($type === 'export_ui') {
    return 'plugins/export_ui';
  }
}

/**
 * Export callback for Google search collection exportables.
 */
function google_search_collections_export($context, $indent = '') {
  $output = ctools_export_object('google_search_collections', $context, $indent);
  $translatables = array();
  foreach (array('title') as $key) {
    if (!empty($context->{$key})) {
      $translatables[] = $context->{$key};
    }
  }
  $translatables = array_filter(array_unique($translatables));
  if (!empty($translatables)) {
    $output .= "\n";
    $output .= "{$indent}// Translatables included for use with string extractors like potx.\n";
    sort($translatables);
    foreach ($translatables as $string) {
      $output .= "{$indent}t(" . ctools_var_export($string) . ");\n";
    }
  }
  return $output;
}

/**
 * Save callback for Google search collection exportables.
 */
function google_search_collections_save($object) {
  if ($object->export_type & EXPORT_IN_DATABASE) {
    // Existing record.
    $update = array('pid');
  }
  else {
    // New record.
    $update = array();
    $object->export_type = EXPORT_IN_DATABASE;
  }
  $return = drupal_write_record('google_search_collections', $object, $update);

  // Always rebuild the menu when saving a search collection.
  variable_set('menu_rebuild_needed', TRUE);

  return $return;
}

/**
 * Status set callback for Google search collection exportables.
 */
function google_search_collections_set_status($object, $status) {
  ctools_export_set_object_status($object, $status);

  // Always rebuild the menu when updating the status of a search collection.
  variable_set('menu_rebuild_needed', TRUE);
}

/**
 * Delete callback for Google search collection exportables.
 */
function google_search_collections_delete($object) {
  // If we were sent an object, get the export key from it. Otherwise
  // assume we were sent the export key.
  $value = is_object($object) ? $object->pid : $object;
  db_delete('google_search_collections')
    ->condition('pid', $value)
    ->execute();

  // Always rebuild the menu when deleting a search collection.
  variable_set('menu_rebuild_needed', TRUE);
}

/**
 * Returns the base path at which Google Appliance serves search results by
 * default (e.g. gsearch).
 *
 * @return string
 *   The base path at which Google Appliance searches are served by default or
 *   an empty string on error.
 */
function google_search_collections_get_gsa_path() {
  if (!function_exists('_google_appliance_get_settings')) {
    return '';
  }

  $settings = _google_appliance_get_settings();
  return isset($settings['drupal_path']) ? $settings['drupal_path'] : 'gsearch';
}

/**
 * A PHP user-defined sorting function for purposes of sorting Google Search
 * Collections.
 *
 * @param stdClass $a
 * @param stdClass $b
 * @return int
 * @see google_search_collections_get_definitions
 * @see uasort
 */
function google_search_collections_sort_definitions($gsc_a, $gsc_b) {
  $weight1 = isset($gsc_a->data['weight']) ? $gsc_a->data['weight'] : 0;
  $weight2 = isset($gsc_b->data['weight']) ? $gsc_b->data['weight'] : 0;

  // If the weights are equivalent, return 0.
  if ($weight1 === $weight2) {
    return 0;
  }
  // Otherwise, compare.
  else {
    return $weight1 < $weight2 ? -1 : 1;
  }
}
