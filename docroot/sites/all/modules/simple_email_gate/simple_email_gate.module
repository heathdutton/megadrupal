<?php

/**
 * Implements hook_menu().
 */
function simple_email_gate_menu() {
  $items = array();

  $items['admin/config/system/simple-email-gate'] = array(
      'title' => 'Simple Email Gate',
      'description' => 'Configuration for Simple Email Gate.',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('simple_email_gate_admin_settings'),
      'access arguments' => array('administer site configuration'),
      'type' => MENU_NORMAL_ITEM,
      'file' => 'simple_email_gate.admin.inc',
  );
  return $items;
}

/**
 * Implementation of hook_mail_alter()
 */
function simple_email_gate_mail_alter(&$message) {
  $to_setting = variable_get('simple_email_gate_to_list', '');
  $white_list_option = variable_get('simple_email_gate_to_option', 0);
  if ($to_setting) {
    $to_list = drupal_strtolower($to_setting);
    $to = drupal_strtolower($message['to']);
    $to_match = drupal_match_path($to, $to_list);
    $to_match = ($white_list_option xor $to_match);
    if (!$to_match) {
      $gate_debug = variable_get('simple_email_gate_debug', 0);
      if($gate_debug){
        watchdog("simple_email_gate","email blocked to: ".$to);
      }
      $message['send'] = FALSE;
      /*
      $message['to'] = NULL;

      // Remove warning about Drupal being unable to send email.
      $warnings = drupal_get_messages('warning');
      foreach($warnings['warning'] as $warning) {
        if($error != 'Unable to send e-mail') {
          drupal_set_message($warning, 'warning');
        }
      }
      */
    }
  }

}
