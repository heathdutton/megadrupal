<?php
/**
 * @file
 * Main file for the microtemplating module.
 */

/**
 * Implements hook_help().
 */
function microtemplating_help($path, $arg) {
  switch ($path) {
    case 'admin/help#microtemplating':
      $path = dirname(__FILE__) . '/README.md';

      if (file_exists($path)) {
        $readme = file_get_contents($path);
      }
      else {
        $path = dirname(__FILE__) . '/README.txt';
        if (file_exists($path)) {
          $readme = file_get_contents($path);
        }
      }

      if (!isset($readme)) {
        return NULL;
      }

      if (module_exists('markdown')) {
        $filters = module_invoke('markdown', 'filter_info');
        $info = $filters['filter_markdown'];

        if (function_exists($info['process callback'])) {
          $function = $info['process callback'];
          $output = filter_xss_admin($function($readme, NULL));
        }
        else {
          $output = '<pre>' . check_plain($readme) . '</pre>';
        }
      }
      else {
        $output = '<pre>' . check_plain($readme) . '</pre>';
      }

      return $output;
  }
}

/**
 * Implements hook_library().
 */
function microtemplating_library() {
  $path = drupal_get_path('module', 'microtemplating');

  $libraries['microtemplating'] = array(
    'title'   => 'John Resig JavaScript Micro-Templating',
    'website' => 'http://ejohn.org/blog/javascript-micro-templating/',
    'version' => '1.0',
    'js' => array(
      $path . '/js/microtemplating.js' => array(),
    ),
  );

  return $libraries;
}

/**
 * Implements hook_theme().
 */
function microtemplating_theme() {
  return array(
    'js_template' => array(
      'render element' => 'element',
    ),
  );
}

/**
 * Returns HTML to wrap child elements in a JavaScript template.
 *
 * @param array $variables
 *   An associative array containing:
 *   - element: An associative array containing the properties of the element.
 *     Properties used: #id, #attributes, #children.
 *
 * @ingroup themeable
 */
function theme_js_template(array $variables) {
  $element = $variables['element'];

  if (!isset($element['#attributes']['id'])) {
    $element['#attributes']['id'] = $element['#id'];
  }

  return '<script type="text/template" ' . drupal_attributes($element['#attributes']) . '>'
    . $element['#children'] . '</script>';
}
