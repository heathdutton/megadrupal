<?php

/**
 * @file
 * Module file of pages widget.
 */

/**
 * Implements hook_menu().
 */
function amocrm_widget_pages_menu() {
  $items['admin/amocrm-widget/link'] = array(
    'title' => 'AmoCrm widget links settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('amocrm_widget_pages_link_settings_form'),
    'access arguments' => array('administer site configuration'),
    'file' => 'amocrm_widget_pages.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_amocrm_widget_info().
 */
function amocrm_widget_pages_amocrm_widget_info() {
  $widget_link_info = array();
  $widget_links = variable_get('amocrm_widget_pages_link_paths', array());

  if (!empty($widget_links)) {
    // Transform the text string into an array.
    $chunks = explode("\n", trim(str_replace("\r", '', $widget_links)));

    foreach ($chunks as $chunk) {
      $chunk_path_info = explode('|', $chunk);
      $link_title = !empty($chunk_path_info[1]) ? $chunk_path_info[1] : '';
      $link_url = !empty($chunk_path_info[2]) ? $chunk_path_info[2] : '';
      $link = l($link_title, 'amocrm_widget/embed', array('query' => array('url' => $link_url)));

      $widget_link_info[] = array(
        'content' => $link,
        'group' => !empty($chunk_path_info[0]) ? $chunk_path_info[0] : '',
        'ammocrm_page' => !empty($chunk_path_info[3]) ? $chunk_path_info[3] : '',
      );
    }
  }

  return array(
    array(
      'title' => t('Pages widget'),
      'description' => '',
      'settings_form_path' => 'admin/amocrm-widget/links',
      'links' => $widget_link_info,
    ),
  );
}

/**
 * Prepare amoCRM form.
 */
function amocrm_widget_prepare_form($form) {
  $form['fields'] = isset($form['fields']) ? $form['fields'] : array();
  $form['message'] = isset($form['message']) ? $form['message'] : '';
  $form['button_confirm'] = isset($form['button_confirm']) ? $form['button_confirm'] : t('Send mail');
  $form['button_cancel'] = isset($form['button_cancel']) ? $form['button_cancel'] : t('Cancel');

  // Allow modules to act upon form.
  drupal_alter('amocrm_widget_prepare_form', $form);

  return $form;
}
