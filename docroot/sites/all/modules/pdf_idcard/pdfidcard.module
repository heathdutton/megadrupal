<?php
define('PDFIDCARD_BGIMAGE_FILEPATH','pdfidcard_bgimage_filepath');
define('PDFIDCARD_TCPDF_PATH','pdfidcard_tcpdf_path');
define('PDFIDCARD_IMAGES_PATH','pdfidcard_tcpdf_path');

/**
* Display help and module information
* @param section which section of the site we're displaying help
* @return help text for section
*/
function pdfidcard_help($path, $arg) {
  $output = '';
  switch ($path) {
    case "admin/modules#description":
      $output = t("Creates printable PDF ID cards for your Users");
      break;
  }
  return $output;
} //function pdfidcard_help

/**
 * permission hook
 * @return array of permissions
 */
function pdfidcard_permission() {
  return array(
    'manage pdfidcard' => array(
      'title' => t('Manage PDF ID Card module'),
      'description' => t('Allow users to manage PDF ID Card module'),
    ),
    'create own ID card' => array(
      'title' => t('Create own PDF ID Card'),
      'description' => t('Allow users to create own PDF ID card'),
    ),
    'create all ID Cards' => array(
      'title' => t('Create PDF ID Card for all users'),
      'description' => t('Allow users to create PDF ID card for all users'),
    ),
  );
}

/**
 * menu hook
 * @return array of menu items
**/
function pdfidcard_menu() {
  $items = array();

  $items['idcard/create'] = array(
    'title' => 'ID Cards',
    'page callback' => 'pdfidcard_create',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['admin/structure/idcard/templates'] = array(
    'title' => 'ID Cards',
    'description' => 'Create Identification card templates',
    'page callback' => 'pdfidcard_template_page',
    'access arguments' => array('manage pdfidcard'),
    'type' => MENU_NORMAL_ITEM,
  );
  $items['admin/config/media/pdfidcard'] = array(
    'title' => 'PDF-IDCard',
    'description' => 'Configure the background images folder and the location of TCPDF. Identification card templates can be produced via the <a href="' . url('admin/structure/idcard/templates') . '">ID card templates</a> page.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('pdfidcard_form_admin_settings'),
    'access arguments' => array('manage pdfidcard'),
  );
  return $items;
}


function pdfidcard_form_admin_settings() {
  $form['PDFIDCARD_IMAGES_PATH'] = array(
    '#type' => 'textfield',
    '#title' => t('Background image folder'),
    '#description' => t('Name of the folder where the
      template background images will be stored. This will 
      be created within the files directory for this site. 
      '),
    '#default_value' => variable_get('PDFIDCARD_IMAGES_PATH','idcard'),
    '#required' => true,
    );
    //Check to see if the TCPDF Path is correct
  if (!pdfidcard_init()) {
    drupal_set_message(t("Could not initialize TCPDF, check the path"));
  }
  $form['PDFIDCARD_TCPDF_PATH'] = array(
    '#type' => 'textfield',
    '#title' => t('Path to TCPDF'),
    '#description' => t('Path to the tcpdf folder. TCPDF must be 
          configured correctly in order for this module
          to work properly
      '),
    '#default_value' => variable_get('PDFIDCARD_TCPDF_PATH',drupal_get_path('module', 'pdfidcard')."/tcpdf"),
    '#required' => true,
    );
  $form = system_settings_form($form);
  return $form;
}

function pdfidcard_template_page() {
  $output = pdfidcard_form_showtemplates();
  $output .= drupal_render(drupal_get_form('pdfidcard_form_template'));
  return $output;
}

/*
 * Implementation of hook_forms to map multiple form IDs
 * to the same callback function
*/
function pdfidcard_forms($form_id, $args) {
  $forms = array();
  $results = db_query("SELECT * FROM {pdfidcard_templates}");
  foreach ($results as $result) {
    $forms[$result->name . '_pdfidcard_form_template']['callback'] = 'pdfidcard_form_template';
  }
  return $forms;
} //pdfidcard_forms

function pdfidcard_form_showtemplates() {
  $results = db_query("SELECT * FROM {pdfidcard_templates}");
  $output = "";
    //Create the forms
  foreach ($results as $result) {
    $output .= drupal_render(drupal_get_form($result->name . '_pdfidcard_form_template', $result));
  }
  return $output;
}

function pdfidcard_form_template($empty, &$form_state, $template = NULL) {
  if (isset($template->name)) {
    $fstitle = $template->name;
    $fieldset = $template->name;
  }
  else {
    $fstitle = "Add a new template";
    $fieldset = "newtemplate";
  }
  $form['#title'] = $fieldset;
  $form['#attributes']['enctype'] = 'multipart/form-data';
  $form['#validate'][] = 'pdfidcard_form_template_validate';
  $form['#submit'][] = 'pdfidcard_form_template_submit';
  $form['#theme'] = 'pdfidcard_form_template';
  $form[$fieldset] = array (
    '#type' => 'fieldset',
    '#title' => $fstitle,
    '#collapsible' => true,
    '#collapsed' => true,
  );
  
  $form[$fieldset]['name'] = array(
    '#title' => 'Template Name',
    '#description' => 'Create a name for the new Template, 
      spaces are not allowed nor are special characters',
    '#type' => 'textfield',
    '#maxlength' => 30,
    '#size' => 30,
    '#required' => true,
    '#default_value' => isset($template->name) ? $template->name : '',
    );
  $form[$fieldset]['pageorient'] = array(
    '#title' => 'Page Orientation',
    '#description' => 'Orientation of the printout',
    '#type' => 'select',
    '#options' => array('P' => 'Portrait', 'L' => 'Landscape'),
    '#default_value' => isset($template->pageorient) ? $template->pageorient : '',
    );
  if (!isset($template->bgimage)) { 
    $form[$fieldset]['bgimage'] = array(
      '#title' => 'Background Image',
      '#type' => 'file',
      '#description' => t('Select a background image
        to use for this template'),
      );
  }
  else {
    $path = file_create_url($template->bgimage);
    $form[$fieldset]['bgimagepath'] = array(
      '#type' => 'markup',
      '#title' => t('Background Image'),
      '#description' => t(''),
      '#value' => "<div class=\"\">".
        "<a href=\"$path\">" . $template->bgimage . "</a>".
        "</div>",
    );
    $form[$fieldset]['bgimagepathvalue'] = array(
      '#type' => 'value',
      '#value' => $template->bgimage,
    );
    $form[$fieldset]['bgimage'] = array(
      '#title' => 'Background Image',
      '#type' => 'file',
      '#description' => t('Uploading a new image will DELETE 
        the current background image'),
      );
  }
  $form[$fieldset]['pgstyle'] = array(
    '#title' => 'Page Style',
    '#description' => 
      t('Custom = use user supplied height/width') . "<br />" .
      t('Image = use dimensions of image') . "<br />",
    '#type' => 'select',
    '#options' => _pdfidcard_pgstyles(),
    '#default_value' => isset($template->pgstyle) ? $template->pgstyle : '',
  );
  $form[$fieldset]['width'] = array(
    '#title' => 'Width',
    '#description' => t('Width in mm'),
    '#type' => 'textfield',
    '#maxlength' => 7,
    '#size' => 10,
    '#default_value' => isset($template->width) ? $template->width : 0,
  );
  $form[$fieldset]['height'] = array(
    '#title' => 'Height',
    '#description' => t('Height in mm'),
    '#type' => 'textfield',
    '#maxlength' => 7,
    '#size' => 10,
    '#default_value' => isset($template->height) ? $template->height : 0,
  );
  $doc_link = l(t('TCPDF documentation'), base_path() . '/' . variable_get('PDFIDCARD_TCPDF_PATH', 'tcpdf') . "/doc/index.html");
  $examples_link = l(t('TCPDF examples'), base_path() .'/'. variable_get('PDFIDCARD_TCPDF_PATH', 'tcpdf') . "/examples/index.php");
  $form[$fieldset]['php_format_code'] = array(
    '#title' => 'PHP Code',
    '#description' => t('Enter TCPDF PHP Code here. For more information consult the !doc_link and !examples_link', 
      array('!doc_link' => $doc_link, '!examples_link' => $examples_link)) . "<br/>" .
      t('The following items are available: $pdf(PDF Object) $template (db record array), $account (user object)'),
    '#type' => 'textarea',
    '#default_value' => isset($template->php_format_code) ? $template->php_format_code : '',
  );
  if (isset($template)) {
    $form[$fieldset]['submit'] = array(
      '#type' => 'submit',
      '#value' => t("Save Changes"),
    );
    $form[$fieldset]['delete'] = array(
      '#type' => 'submit',
      '#value' => t("Delete this template"),
    );
    $form[$fieldset]['templateid'] = array(
      '#type' => 'value',
      '#value' => $template->templateid,
    );
  }
  else {
    $form[$fieldset]['submit'] = array(
      '#type' => 'submit',
      '#value' => t("Create new template"),
    );
  }
  return $form;
}
/*
** Theme the form
*/
function theme_pdfidcard_form_template($form) {
    $key = $form['#title'];
    $rows[] = array(
      array(data=>drupal_render($form[$key]['name']),colspan=>2),
      array(data=>drupal_render($form[$key]['pageorient'])),
    );
    if ($form[$key]['bgimagepath']) {
    $rows[] = array(
      array(data => "<div class=\"form-item\"><label for=\"edit-bgimagepath\">Current Image</label>", colspan=>1),
      array(data => drupal_render($form[$key]['bgimagepath'])."</div>", colspan=>3),
    );
    } 
    $rows[] = array(
      array(data => drupal_render($form[$key]['bgimage']), colspan=>3),
    );
    $rows[] = array(
      drupal_render($form[$key]['pgstyle']),
      drupal_render($form[$key]['height']),
      drupal_render($form[$key]['width']),
    );
    $rows[] = array(
      array(data => drupal_render($form[$key]['php_format_code']), colspan => 3),
    );
    if ($form[$key]['delete']) {
      $rows[] = array(
        array(data=>drupal_render($form[$key]['submit']),colspan=>1),
        array(data=>drupal_render($form[$key]['delete']),colspan=>2),
      );
    }
    else {
      $rows[] = array(
        array(data=>drupal_render($form[$key]['submit']),colspan=>3),
      );
    }
    $form[$key]['#children'] = theme('table',$header, $rows);
    return drupal_render($form);
}


/*
** Validates the addtemplate form to check for errors
*/
function pdfidcard_form_template_validate($form, &$form_state) {
  if ($form_state['values']['op'] == t("Delete this template")) {
    return TRUE;
  }
  
  if (preg_match('/[^a-zA-Z0-9_]/',$form_state['values']['name'])) {
    form_set_error('name', t('Template name must be alphanumeric or underscores only'));
    return FALSE;
  }
  
  if ($form_state['values']['op'] != t("Save Changes")) {
    $templateid = db_query("SELECT templateid FROM {pdfidcard_templates} WHERE name = :name", 
      array(':name' => $form_state['values']['name']))
    ->fetchField();
    if ($templateid && $templateid == $form_state['values']['templateid']) {
      form_set_error('name', t('Template name must be unique'));
      return FALSE;
    }
  }
  
  // Handle file uploads.
  $validators = array('file_validate_is_image' => array());
  // Check for a new uploaded image.
  $file = file_save_upload('bgimage', $validators);
  if (isset($file)) {
    // File upload was attempted.
    if ($file) {
      // Put the temporary file in form_values so we can save it on submit.
      $form_state['values']['bgimage'] = $file;
    }
    else {
      // File upload failed.
      form_set_error('bgimage', t('The background image could not be uploaded.'));
    }
  }
}

/*
 * Delete the Background image from template
*/
function pdfidcard_deletebgimage($templateid){
  $filename = db_query("SELECT bgimage FROM {pdfidcard_templates} WHERE templateid=:id", 
    array(':id' => $templateid)
  )->fetchField();
  if ($filename && !file_delete($filename)){
    return FALSE;
  }
  else {
    return TRUE;
  }
} //pdfidcard_deletebgimage

/*
 * Deletes a template based on the primary key
*/
function pdfidcard_deletetemplate($templateid){
  if(pdfidcard_deletebgimage($templateid)) {
    if(!db_delete('pdfidcard_templates')->condition('templateid', $templateid)->execute()){
      return FALSE;
    }
    else {
      return TRUE;
    }
  }
  else {
    return FALSE;
  }// pdfidcard_deletebgimage 
} //pdfidcard_deletetemplate

/*
** Handles submission from the form template
*/
function pdfidcard_form_template_submit($form, &$form_state){
  $values = $form_state['values'];
  switch ($values['op']){
  case t("Delete this template") :
    if (pdfidcard_deletetemplate($values['templateid'])){
      drupal_set_message(t("Successfully Deleted ") . $values['name'] );
    }
    else {
      drupal_set_message(t("Sorry, the template could not be deleted"));
    }
    break;
  case t("Save Changes") :

    if ($file = $values['bgimage']) {
      unset($values['bgimage']);
      $filename = file_unmanaged_copy($file->uri);
      $values['logo_path'] = $filename;
    }
    // Exclude unnecessary elements before saving.
    unset($values['submit'], $values['form_id'], $values['op'], $values['form_build_id'], $values['form_token']);
    $validators = array(
      'file_validate_is_image' => array(),
      'file_validate_image_resolution' => array('85x85'),
      'file_validate_size' => array(30 * 1024),
    );

    $file = file_save_upload('bgimage', $validators);
    if ($file !== FALSE) {
      //The file uploaded replaces the existing file
      $template_folder = variable_get('PDFIDCARD_IMAGES_PATH','idcard');
      $filename ="";
      $filepath = file_create_path('') . "/" . $template_folder;
      //check the directory for existence and for write perms
      $is_writable = file_check_directory($filepath, 1);
      if($is_writable) {
        if($form_state['values']['bgimagepathvalue']){
          //Delete the old if is it exists
          if(!pdfidcard_deletebgimage($form_state['values']['templateid'])){
            drupal_set_message(t("Could not delete previous bgimage, please remove manually"));
          }
        }
        $file->filename = file_munge_filename($file->filename, $extensions = NULL, $alerts = TRUE);
        $file = file_save_upload($file, $filepath, false);
        //Now check once more to make sure we have a useable image
        if (image_get_info($file->filepath)) {
          $filename = $file->filepath;
          db_update('pdfidcard_templates')
          ->fields(array(
            'name' => $form_state['values']['name'],
            'pageorient' => $form_state['values']['pageorient'], 
            'bgimage' => $file->filepath,
            'pgstyle' => $form_state['values']['pgstyle'], 
            'width' => $form_state['values']['width'], 
            'height' => $form_state['values']['height'], 
            'php_format_code' => $form_state['values']['php_format_code'])
          )
          ->condition('templateid', $form_state['values']['templateid'], '=')
          ->execute();
        } //image_get_info
      } //is_writable
    }
    else  {
      db_update('pdfidcard_templates')
      ->fields(array(
        'name' => $form_state['values']['name'],
        'pageorient' => $form_state['values']['pageorient'], 
        'pgstyle' => $form_state['values']['pgstyle'], 
        'width' => $form_state['values']['width'], 
        'height' => $form_state['values']['height'], 
        'php_format_code' => $form_state['values']['php_format_code'])
      )
      ->condition('templateid', $form_state['values']['templateid'], '=')
      ->execute();
    }
    break;
  case t("Create new template") :
      //saving or updating
    $template_folder = variable_get('PDFIDCARD_IMAGES_PATH','idcard');
    $filename ="";
    $filepath = $template_folder;//file_create_path('') . "/" . 
      //check the directory for existence and for write perms
    //$is_writable = file_check_directory($filepath, 1);
    //if($is_writable) {
      //we're good to go
      /*TODO Modify the validators array to suit your needs.
      This array is used in the revised file_save_upload */
      $validators = array(
        'file_validate_is_image' => array(),
        'file_validate_image_resolution' => array('85x85'),
        'file_validate_size' => array(30 * 1024),
      );
      $file = file_save_upload('bgimage', $validators);
      if ($file !== FALSE) {
        $dest = $file->destination;
      }
      //Create the INSERT statement
      db_insert('pdfidcard_templates')
      ->fields(array(
        'name' => $form_state['values']['name'],
        'pageorient' => $form_state['values']['pageorient'], 
        'bgimage' => $dest,
        'pgstyle' => $form_state['values']['pgstyle'], 
        'width' => $form_state['values']['width'], 
        'height' => $form_state['values']['height'], 
        'php_format_code' => $form_state['values']['php_format_code'])
      )
      ->execute();
      drupal_set_message(t("Created new template "). $form_state['values']['name']);
      break;
  }
}

/**
* create is an interface to create IDCards for users
**/   
function pdfidcard_create(){

    //Check that we can generate PDFs before we go further
  if(!pdfidcard_init()){
    drupal_set_message(t("PDF Generation is not configured correctly
                        PDFs are unavailable"));
    return false;
  }
  $uid = arg(3);
  $templateid = arg(2);
    //pull in the user object
  global $user;
  if (is_numeric($uid) && ($uid != $user->uid)) {
    $account = user_load(array('uid' => $uid));
  }
  else {
    $account = $user;
  }

  if(!$account){
    drupal_set_message(t("Could not load the user account to create the Identification card")); 
    return false;
  }
   
    //Permission check
  if(
      ($user->uid == $account->uid && user_access('create own ID card'))
      ||
      (user_access('create all ID Cards'))
     ) {
    //Ok we have permission so now let's grab the name of the template
    //and create the card
    $sql = "SELECT * from {pdfidcard_templates} where templateid='%s'";
    $template[0] = strtr(strip_tags($account->name), " .,?!&#", "_______");
    $template[1] = db_query("SELECT * FROM {pdfidcard_templates} where templateid=:id", array(':id' => $templateid))->fetchObject();
    if (!is_object($template[1])) {
      drupal_set_message(t("A template must be selected"));
      return false;
    }
    $pdf = theme('pdfidcard_pdf', $template);
}
  else {
    return "Access denied";
  }


} //function pdfidcard_createpage

/**
** implementation of hook_theme
*/
function pdfidcard_theme() {
  return array(
    'pdfidcard_pdf' => array(
      'arguments' => array('template')
    ),
    'pdfidcard_addpage' => array(
      'arguments' => array('pdf', 'template', 'account')
    ),
  );
/*
  return array(
    'pdfidcard_pdf' => array(
      'arguments' => array('template' => NULL)
    ),
    'pdfidcard_addpage' => array(
      'arguments' => array('pdf' => NULL, 'template' => NULL, 'account' => NULL)
    ),
  );*/
}

/*
** theme the creation of the PDF object, 
** $template = array of values containing the width, height, pagestyle, etc. 
*/
function theme_pdfidcard_pdf($variables){
  $filename = $variables[0];
  $template = $variables[1];
  //Determine the pagestyle to use
  switch ($template->pgstyle) {
    case 'custom':
        //We use the h/w from the user settings
      $pgstyle = array($template->$height, $template->$width);
      break;

    case 'image':
        //On image pgstyle we pull the height width from the image
      $img_info = image_get_info($template->bgimage);
      if ($img_info) {
        //Now convert pixels to mm at 72 dpi
        $heightmm = $img_info['height'] * 25.4 / 72;
        $widthmm = $img_info['width']  * 25.4 / 72;
        $pgstyle = array($heightmm, $widthmm);
      }
      break;

    default:
      $pgstyle = $template->pgstyle;
  }
  if($template->pageorient == 'P' || $template->pageorient == 'L' ){
      $pageorient = $template->pageorient;
  }
  else {
      $pageorient = 'L';
  }

  $pdf = new PDFIDCARD($pageorient,'mm',$pgstyle);
  $pdf->Open();
  if($template->bgimage){
    $pdf->bgimage = $template->bgimage;
  }
    
    //Set Margins to zero (Left, Top, Right) bottom is included in footer
  $pdf->SetMargins(0,0,0);
    //Prevent header and footer from being printed
  $pdf->setPrintHeader(true);
  $pdf->setPrintFooter(false);
    //Turn off auto page breaks
  $pdf->SetAutoPageBreak(false);
    //Return the PDF object
  $pdf->AddPage();
  eval($template->php_format_code);
    //Return the PDF object
  $pdf->Output($filename . ".pdf","I");
}

/**
 * Implements hook_user_view to add the "Create ID card link" to the bottom
 */
function pdfidcard_user_view($account, $view_mode){
  global $user;
  if (($user->uid == $account->uid && user_access('create own ID card'))
    || ($user->uid != $account->uid && user_access('create all ID Cards')))
  {
    $row_count = db_query("SELECT COUNT(templateid) FROM {pdfidcard_templates}")->fetchField();
    $results = db_query("SELECT templateid, name FROM {pdfidcard_templates}");
    foreach ($results as $result) {
      $link = l(t("Create !name Card", array('!name' => $result->name)), "idcard/create/" . $result->templateid . "/" . $account->uid);
      $account->content['ID Cards'][] = array(
        '#type' => 'user_profile_item',
        '#title' => '',
        '#markup' => $link,
        '#weight' => 50,
        '#attributes' => array('class' => array('blog')),
      );
    }
  }
}

/*
 * Returns list of available PG Styles
*/
function _pdfidcard_pgstyles(){
  //If you add to this list ensure that TCPDF recognizes it
  //OR you write code to handle the page size in theme_pdfidcard_page
  $pgstyles = array();
  $pgstyles['custom'] = 'Custom';
  $pgstyles['image'] = 'Image';
  $pgstyles['4A0'] = '4A0';
  $pgstyles['2A0'] = '2A0';
  $pgstyles['A0'] = 'A0';
  $pgstyles['A1'] = 'A1';
  $pgstyles['A2'] = 'A2';
  $pgstyles['A3'] = 'A3';
  $pgstyles['A4'] = 'A4';
  $pgstyles['A5'] = 'A5';
  $pgstyles['A6'] = 'A6';
  $pgstyles['A7'] = 'A7';
  $pgstyles['A8'] = 'A8';
  $pgstyles['A9'] = 'A9';
  $pgstyles['A10'] = 'A10';
  $pgstyles['B0'] = 'B0';
  $pgstyles['B1'] = 'B1';
  $pgstyles['B2'] = 'B2';
  $pgstyles['B3'] = 'B3';
  $pgstyles['B4'] = 'B4';
  $pgstyles['B5'] = 'B5';
  $pgstyles['B6'] = 'B6';
  $pgstyles['B7'] = 'B7';
  $pgstyles['B8'] = 'B8';
  $pgstyles['B9'] = 'B9';
  $pgstyles['B10'] = 'B10';
  $pgstyles['C0'] = 'C0';
  $pgstyles['C1'] = 'C1';
  $pgstyles['C2'] = 'C2';
  $pgstyles['C3'] = 'C3';
  $pgstyles['C4'] = 'C4';
  $pgstyles['C5'] = 'C5';
  $pgstyles['C6'] = 'C6';
  $pgstyles['C7'] = 'C7';
  $pgstyles['C8'] = 'C8';
  $pgstyles['C9'] = 'C9';
  $pgstyles['C10'] = 'C10';
  $pgstyles['RA0'] = 'RA0';
  $pgstyles['RA1'] = 'RA1';
  $pgstyles['RA2'] = 'RA2';
  $pgstyles['RA3'] = 'RA3';
  $pgstyles['RA4'] = 'RA4';
  $pgstyles['SRA0'] = 'SRA0';
  $pgstyles['SRA1'] = 'SRA1';
  $pgstyles['SRA2'] = 'SRA2';
  $pgstyles['SRA3'] = 'SRA3';
  $pgstyles['SRA4'] = 'SRA4';
  $pgstyles['LETTER'] = 'LETTER';
  $pgstyles['LEGAL'] = 'LEGAL';
  $pgstyles['EXECUTIVE'] = 'EXECUTIVE';
  $pgstyles['FOLIO'] = 'FOLIO';
  return $pgstyles;
} //pdfidcard_pgstyles

/*
** Initializes TCPDF, returns true for A-OK, returns false if no tcpdf
*/
function pdfidcard_init(){
  $tcpdf_path = variable_get('PDFIDCARD_TCPDF_PATH','');
  $tcpdf_file = $tcpdf_path .'/tcpdf.php';
  if (file_exists($tcpdf_file)) {
    //define('FPDF_FONTPATH',$tcpdf_path.'/fonts/');
    require_once($tcpdf_file);
    //Extend the TCPDF class to override defult header
    if (!class_exists("PDFIDCARD", FALSE)){
    class PDFIDCARD extends TCPDF {
      public function Header() {
        $this->Image($this->bgimage, 0, 0);
      }
    }
    }
    return true;
  }
  else {
    return false;
  }
} //function pdfidcard_init
