<?php

/**
 * @file
 * Tests for twcards module.
 */

class TwcardsTestCase extends DrupalWebTestCase {
  /**
   * A user with permission to see the leads from Twitter.
   *
   * @var object
   */
  protected $admin_user;

  public static function getInfo() {
    return array(
      'name' => 'Twitter Lead Generation Cards (twcards)',
      'description' => 'Test Twitter Lead Generation Cards functionality.',
      'group' => 'Twitter Lead Generation Cards',
    );
  }

  function setUp() {
    parent::setUp('twcards');
    $this->admin_user = $this->drupalCreateUser(array('view twcards leads'));
  }

  /**
   * Tests leads are created when they should and not when they shouldn't.
   */
  function testLeadGeneration() {
    // Set a salt to force md5 token verification.
    variable_set('twcards_salt_key', "the value from twitter");
    // This variable lets us do tests easily since simpletest can't handle
    // POSTS without a form.
    variable_set('twcards_allow_get_requests', TRUE);

    // Create a lead for testing out the POSTS.
    $lead = array();
    $lead['name'] = 'A Name';
    $lead['screen_name'] = 'a screen name';
    $lead['mail'] = 'a@example.com';
    $lead['token'] = 'FAKE';

    // When the token is wrong, get a 403.
    $this->drupalGet('/twcards-lead-generation-card-endpoint', array('query' => $lead));
    $this->assertResponse(403, 'Access denied when sending an invalid md5 token.');
    // Fix the token, get a 200.
    $lead['mail'] = 'b@example.com';
    $lead['token'] = 'aa3977f103a76ae75e40c084c980f2e3';
    $this->drupalGet('/twcards-lead-generation-card-endpoint', array('query' => $lead));
    $this->assertResponse(200, 'Valid response when sending a valid lead with valid token.');

    // Log in a user and confirm they see the leads.
    $this->drupalLogin($this->admin_user);
    $this->drupalGet('admin/reports/twcards-leads');
    $this->assertNoRaw("a@example.com", 'The email address for an invalid token is not found.');
    $this->assertRaw("b@example.com", 'The email address for a valid lead is found.');
  }
}
