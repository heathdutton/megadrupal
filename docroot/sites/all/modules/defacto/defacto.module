<?php
/**
 * @file defacto.module
 * Main file for Defacto module, which allows biasing Apache Solr search
 * results based on taxonomy term field.
 */

/**
 * Implements hook_install().
 */
function defacto_install() {
  drupal_set_message(st("Defacto settings are available under !link", 
    array( '!link' => l(check_plain(st('Administer > Site configuration > Defacto')),  'admin/config/search/defacto' ) )
    ));
}

/**
 * Implements hook_uninstall().
 */
function defacto_uninstall() {
  variable_del('defacto_field');
  variable_del('defacto_bias');
}

/**
 * Implements hook_permission().
 */
function defacto_permission() {
  return array(
    'administer defacto' =>  array(
      'title' => t('Administer Defacto Search'),
      'description' => t('Configure settings for Defacto search results biasing.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function defacto_menu() {
  $items['admin/config/search/defacto'] = array(
    'title' => 'Defacto',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('defacto_admin_settings'),
    'access arguments' => array('administer defacto'),
    'file' => 'defacto.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_apachesolr_index_document_build_ENTITY_TYPE().
 */
function defacto_apachesolr_index_document_build_node(ApacheSolrDocument $document, $entity, $env_id) {

  $field = variable_get('defacto_field');
  if (!empty($entity->$field)) {
  
    $terms = field_view_field('node', $entity, $field);
  
    foreach ($terms['#items'] as $term) {
      $document->addField('sm_defacto', $term['taxonomy_term']->name, NULL);  
    }
    
    $document->setFieldBoost('sm_defacto', variable_get('defacto_bias'));
  
  }

}

/**
 * Implements HOOK_apachesolr_query_prepare().
 *
 * Boost terms in searches at query time.
 */
function defacto_apachesolr_query_prepare($query) {
  $boost = variable_get('defacto_bias', 42);
  $query->addParam('fl', 'sm_defacto');
  $query->addParam('qf', 'sm_defacto^' . $boost);
}

/**
 * Implements hook_apachesolr_search_result_alter().
 * 
 * Currently only used for debugging.
 */
function defacto_apachesolr_search_result_alter($doc) {
  // dpm($doc);
}