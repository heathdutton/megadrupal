<?php

define('LOCATION_VIEWS_FILTERS_AJAX_ALL', 'All');

/**
 * Implements hook_form_FORM_ID_alter().
 */
function location_views_filters_ajax_form_views_exposed_form_alter(&$form, &$form_state, $form_id) {
  if (isset($form['country'])) {
    // Provide wrappers for Region and Province.
    if (isset($form['region'])) {
      $region_wrapper = $form['#id'] . '-region';
      $form['region']['#prefix'] = "<div id='{$region_wrapper}'>";
      $form['region']['#suffix'] = "</div>";
    }

    if (isset($form['province'])) {
      $province_wrapper = $form['#id'] . '-province';
      $form['province']['#prefix'] = "<div id='{$province_wrapper}'>";
      $form['province']['#suffix'] = "</div>";
    }

    // Do not alter the functionality if e have only Country filter.
    if (!isset($form['region']) && !isset($form['province'])) {
      return;
    }

    // Get current value for Country.
    $country = _location_views_filters_ajax_get_value('country', $form_state);
    $form['country']['#default_value'] = $country;

    $form['country']['#ajax'] = array(
      'wrapper' => '',
      'callback' => 'location_views_filters_ajax_country_callback',
    );

    // Check if if have the Region field.
    if (module_exists('location_region') && isset($form['region']) && location_region_is_country_supported($country)) {
      $regions = array(LOCATION_VIEWS_FILTERS_AJAX_ALL => t('- Any -'));
      if ($country != LOCATION_VIEWS_FILTERS_AJAX_ALL) {
        // Add regions to dropdown.
        $regions += location_region_get_regions($country);
        $form['region']['#options'] = $regions;

        // Add ajax to region filter.
        $form['region']['#ajax'] = array(
          'wrapper' => $province_wrapper,
          'callback' => 'location_views_filters_ajax_region_callback',
        );

        // Get current value and set it as default.
        $region = _location_views_filters_ajax_get_value('region', $form_state);
        if (in_array($region, array_keys($regions))) {
          $form['region']['#default_value'] = $region;
        }
        else {
          $form['region']['#default_value'] = LOCATION_VIEWS_FILTERS_AJAX_ALL;
        }

        $provinces = array(LOCATION_VIEWS_FILTERS_AJAX_ALL => t('- Any -'));
        if ($region != LOCATION_VIEWS_FILTERS_AJAX_ALL) {
          // Build the provinces.
          $provinces += location_region_get_provinces($region, $country);

          // Get current value for province.
          $province = _location_views_filters_ajax_get_value('province', $form_state);
          if (in_array($province, array_keys($provinces))) {
            $form['province']['#default_value'] = $province;
            $provinces = array(LOCATION_VIEWS_FILTERS_AJAX_ALL => t('- Any -'), 'xx' => t('NOT LISTED')) + $provinces;
          }
          else {
            $form['province']['#default_value'] = LOCATION_VIEWS_FILTERS_AJAX_ALL;
          }
        }
        else {
          $form['province']['#default_value'] = LOCATION_VIEWS_FILTERS_AJAX_ALL;
        }

        // Set available options for Province dropdown.
        $form['province']['#options'] = $provinces;
      }
    }
    else {
      // Set region as - Any - or Not Available.
      if ($country != LOCATION_VIEWS_FILTERS_AJAX_ALL) {
        $regions = array(LOCATION_VIEWS_FILTERS_AJAX_ALL => t('- N/A -'));
      }
      else {
        $regions = array(LOCATION_VIEWS_FILTERS_AJAX_ALL => t('- Any -'));
      }

      $form['region']['#options'] = $regions;
      $form['region']['#default_value'] = LOCATION_VIEWS_FILTERS_AJAX_ALL;

      // Set provinces list from Location module.
      $provinces = array(LOCATION_VIEWS_FILTERS_AJAX_ALL => t('- Any -'), 'xx' => t('NOT LISTED'));
      $provinces += location_get_provinces($country);
      $form['province']['#options'] = $provinces;

      // Get current value for province.
      $province = _location_views_filters_ajax_get_value('province', $form_state);
      if (in_array($province, array_keys($provinces))) {
        $form['province']['#default_value'] = $province;
      }
      else {
        $form['province']['#default_value'] = LOCATION_VIEWS_FILTERS_AJAX_ALL;
      }
    }
  }
}

/**
 * Ajax callback for country change.
 */
function location_views_filters_ajax_country_callback(&$form, &$form_state) {
  $region_wrapper = $form['#id'] . '-region';
  $province_wrapper = $form['#id'] . '-province';

  $commands[] = ajax_command_replace('#' . $region_wrapper, render($form['region']));
  $commands[] = ajax_command_replace('#' . $province_wrapper, render($form['province']));

  return array(
    '#type' => 'ajax',
    '#commands' => $commands,
  );
}

/**
 * Ajax callback for region change.
 */
function location_views_filters_ajax_region_callback(&$form, &$form_state) {
  return $form['province'];
}

/**
 * Get the current value for a specified field.
 */
function _location_views_filters_ajax_get_value($field, $form_state) {
  // Check if we have it in URL.
  if (isset($_GET[$field])) {
    return $_GET[$field];
  }

  // Check if it was an ajax submission.
  if (isset($form_state['values'][$field])) {
    return $form_state['values'][$field];
  }

  // By default 'All' value is used.
  return LOCATION_VIEWS_FILTERS_AJAX_ALL;
}
