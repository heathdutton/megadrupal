<?php

/**
 * @file
 * Module file of the translation management OHT module.
 *
 * http://onehourtranslation.com/
 *
 * Implemented by Artem Berdishev, AMgrade
 */

/**
 * Implements hook_tmgmt_translator_plugin_info().
 */
function tmgmt_oht_tmgmt_translator_plugin_info() {
  return array(
    'oht' => array(
      'label' => t('OHT translator'),
      'description' => t('A OneHourTranslation translator service.'),
      'plugin controller class' => 'TMGMTOhtPluginController',
      'ui controller class' => 'TMGMTOhtTranslatorUIController',
    ),
  );
}

/**
 * Implements hook_menu().
 */
function tmgmt_oht_menu() {
  return array(
    'tmgmt_oht_callback' => array(
      'title' => 'TMGMT OHT Callback',
      'description' => '',
      'page callback' => 'tmgmt_oht_callback',
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
    ),
  );
}

/**
 * Callback for OHT requests.
 */
function tmgmt_oht_callback() {
  // If translation submitted - handle it.
  if ($_POST['type'] == 'translation_submitted') {
    /**
     * @var TMGMTJob $job The job object.
     */
    $job = tmgmt_job_load($_POST['custom0']);
    if (!empty($job) && $_POST['custom1'] == tmgmt_oht_hash($job->tjid)) {
      /**
       * @var TMGMTOhtPluginController $oht The translator object.
       */
      $oht = $job->getTranslator()->getController();
      $oht->retrieveTranslation($job);
    }
    else {
      watchdog('tmgmt', 'Wrong call for submitting translation for job %job_id', array('%job_id' => $job->tjid), WATCHDOG_WARNING);
    }
  }
  // Otherwise - add message about status changing.
  elseif ($_POST['type'] == 'status_change') {
    $job = tmgmt_job_load($_POST['custom0']);
    if (!empty($job) && $_POST['custom1'] == tmgmt_oht_hash($job->tjid)) {
      $job->addMessage('Status for project %project changed to %status. Estimated finish: @finish',
        array(
          '%project' => $_POST['project_id'],
          '%status' => $_POST['project_status'],
          '@finish' => format_date($_POST['estimate_finish']),
        )
      );
    }
    else {
      watchdog('tmgmt', 'Wrong query for updating job %job_id status', array('%job_id' => $job->tjid), WATCHDOG_WARNING);
    }
  }
  drupal_exit();
}

/**
 * Create secret hash for OHT reference.
 */
function tmgmt_oht_hash($id) {
  return md5(drupal_get_hash_salt() . $id);
}
