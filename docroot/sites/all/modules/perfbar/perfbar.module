<?php
/**
 * @file
 * Module to add perfbar to your website.
 */

/**
 * Implements hook_menu().
 */
function perfbar_menu() {
  $items['admin/config/development/perfbar'] = array(
    'title' => 'perfBar administration settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('perfbar_admin_form'),
    'access arguments' => array('administer_perfbar'),
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function perfbar_permission() {
  return array(
    'administer_perfbar' => array(
      'title' => t('Administer perfBar'),
      'description' => t('Configure settings for perfBar.'),
    ),
    'view_perfbar' => array(
      'title' => t('View perfBar'),
      'description' => t('View the perfBar.'),
    ),
  );
}

/**
 * Implements hook_page_build().
 */
function perfbar_page_build(&$page) {
  if (user_access('view_perfbar')) {
    if (variable_get('perfbar_use_cdn', 1)) {
      drupal_add_js('//perfbar.khalidlafi.com.global.prod.fastly.net/perfbar-0.2.0.min.js', array(
        'type' => 'external',
        'scope' => 'footer',
        'weight' => 9,
      ));
    }
    else {
      drupal_add_js(libraries_get_path('perfbar') . '/build/perfbar.js', array(
        'type' => 'file',
        'scope' => 'footer',
        'weight' => 9,
      ));
    }
    drupal_add_js("perfBar.init({lazy: true});", array(
      'type' => 'inline',
      'scope' => 'footer',
      'weight' => 10,
    ));
    drupal_add_css(drupal_get_path('module', 'perfbar') . '/perfbar.css');
  }
}

/**
 * Implements hook_libraries_info().
 */
function perfbar_libraries_info() {
  $libraries['perfbar'] = array(
    'name' => 'PerfBar',
    'vendor url' => 'http://lafikl.github.io/perfBar/',
    'download url' => 'https://github.com/lafikl/perfBar/archive/v0.1.0.zip',
    'path' => 'build',
    'files' => array(
      'js' => array(
        'perfbar.js',
      ),
    ),
  );

  return $libraries;
}

/**
 * Creates an admin page.
 */
function perfbar_admin_form() {
  $form = array();
  $form['perfbar_use_cdn'] = array(
    '#type' => 'checkbox',
    '#title' => t('Use Fastly CDN to load the script?'),
    '#description' => t('This will load the script from the Fastly CDN network either over http or https automatically.'),
    '#default_value' => variable_get('perfbar_use_cdn', 1),
  );
  $form['perfbar_submit'] = array(
    '#type' => 'submit',
    '#title' => 'Submit',
    '#value' => 'Submit',
  );
  return system_settings_form($form);
}
