<?php

/**
 * @file
 * Who Logged is a basic module for displaying who logged in.
 */

// Default hours.
define('WHO_LOGGEDIN_HOURS', 24);

/**
 * Implements hook_help().
 */
function who_loggedin_help($path, $arg) {
  switch ($path) {
    case 'admin/help#who_loggedin':
      $output = t('Block to display logged in users in x past hours. Where x is configurable.', array(
        '%config_page', l(t('config page'), '/admin/config/people/who-logged-in'),
      ));
      return $output;
  }
}

/**
 * Implements hook_permissions().
 */
function who_loggedin_permission() {
  return array(
    'administer who_loggedin' => array(
      'title' => t('Administer Who Logged In'),
      'description' => t('Perform administration tasks on Who Logged In'),
    ),
  );
}

/**
 * Implements hook_block_info().
 */
function who_loggedin_block_info() {
  $blocks['who_logged_in'] = array(
    'info' => t('Who Logged In'),
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function who_loggedin_block_view($delta = '') {
  $block = array();
  switch ($delta) {
    case 'who_logged_in':
      $block = array(
        'subject' => t('Who Logged In'),
        'content' => theme('who_loggedin_list', array(
            'users' => who_loggedin_list(),
          )
        ),
      );
      break;
  }

  return $block;
}

/**
 * Implements hook_theme().
 */
function who_loggedin_theme() {
  return array(
    'who_loggedin_list' => array(
      'render element' => 'users',
    ),
  );
}

/**
 * Returns HTML for the who logged in block.
 *
 * @param array $variables
 *   An associative array containing:
 *     - users: array of user objects containging user info: uid, name, mail,
 *       access.
 *
 * @ingroup themeable
 */
function theme_who_loggedin_list(array $variables) {
  $users = $variables['users'];
  $items = array();
  $type = 'ul';
  $title = t('Logged in users in the past %hours hours', array('%hours' => variable_get('who_loggedin_hours', WHO_LOGGEDIN_HOURS)));
  $attributes = array(
    'id' => 'loggedin-users',
  );

  if ($users) {
    foreach ($users as $user) {
      $items[] = array(
        'data' => theme('username', array('account' => $user, 'name' => $user->name)),
      );
    }
  }

  // If no users logged in yet.
  if (!$items) {
    $items[] = array(
      'data' => t('No user logged in'),
    );
  }

  $output = theme('item_list', array(
    'items' => $items,
    'type' => $type,
    'title' => $title,
    'attributes' => $attributes,
  ));

  return $output;
}

/**
 * Lists the users who logged in past x hours.
 */
function who_loggedin_list() {
  $hours = variable_get('who_loggedin_hours', WHO_LOGGEDIN_HOURS);
  $time = strtotime('-' . $hours . ' hours');

  $users = db_query('SELECT uid, name, access
            FROM {users}
            WHERE access >= :time
            AND status != 0', array(':time' => $time));

  return $users;
}

/**
 * Implements hook_block_configure().
 */
function who_loggedin_block_configure($delta = '') {
  $form = array();
  if ($delta == 'who_logged_in') {
    $form['who_loggedin_hours'] = array(
      '#type' => 'textfield',
      '#size' => 5,
      '#title' => t('Hours'),
      '#description' => t('The amount of past hours you want the Logged In Block to display of users.'),
      '#default_value' => variable_get('who_loggedin_hours', WHO_LOGGEDIN_HOURS),
      '#element_validate' => array('element_validate_integer_positive'),
    );
  }

  return $form;
}

/**
 * Implements hook_block_save().
 */
function who_loggedin_block_save($delta, $edit = array()) {
  if ($delta == 'who_logged_in') {
    variable_set('who_loggedin_hours', $edit['who_loggedin_hours']);
    drupal_set_message(t('Who logged in hours have been updated.'));
  }
}
