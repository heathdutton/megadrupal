<?php

/**
 * @file
 * Block functions.
 *
 * Contains all the functions to run the "User Details" blocks.
 */

/**
 * Implements of hook_help().
 *
 * Creates a basic help page(accessible from the modules page and the User Details admin page).
 */
function user_details_help($path, $arg) {
  $output = '';
  switch ($path) {
    case "admin/help#user_details":
      require_once drupal_get_path('module', 'user_details') . '/includes/user_details_help_page.inc';
      $output = drupal_render(drupal_get_form('user_details_help_page'));
      return $output;
  }
}

/**
 * Implements hook_menu().
 */
function user_details_menu() {
  $items = array();
  $items['admin/config/user-interface/user-details'] = array(
    'title' => 'User Details',
    'description' => 'Configure the "User Details" logged-in and authored by blocks.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('user_details_loggedin_admin_form'),
    'access arguments' => array('administer site configuration'),
    'file' => 'includes/user_details_loggedin_admin.inc',
  );
  $items['admin/config/user-interface/user-details/loggedin'] = array(
    'title' => 'Logged-in',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('user_details_loggedin_admin_form'),
    'access arguments' => array('administer site configuration'),
    'file' => 'includes/user_details_loggedin_admin.inc',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => 0,
  );
  $items['admin/config/user-interface/user-details/authored'] = array(
    'title' => 'Authored',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('user_details_authored_admin_form'),
    'access arguments' => array('administer site configuration'),
    'file' => 'includes/user_details_authored_admin.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 1,
  );
  $items['admin/config/user-interface/user-details/help'] = array(
    'title' => 'Help',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('user_details_help_page'),
    'access arguments' => array('administer site configuration'),
    'file' => 'includes/user_details_help_page.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 1,
  );

  return $items;
}

/**
 * Implements hook_theme().
 *
 * Adds the template and variables needed to have the blocks run through a
 * template file.
 */
function user_details_theme($existing, $type, $theme, $path) {
  if (variable_get('user_details_loggedin_template_style') == 1) {
    $loggedin_style = 'templates/styles/icons_only/user-details-loggedin';
  }
  if (variable_get('user_details_loggedin_template_style') == 2) {
    $loggedin_style = 'templates/styles/text_and_icons/user-details-loggedin';
  }
  else {
    $loggedin_style = 'templates/styles/icons_only/user-details-loggedin';
  }
  if (variable_get('user_details_authored_template_style') == 1) {
    $authored_style = 'templates/styles/icons_only/user-details-authored';
  }
  if (variable_get('user_details_authored_template_style') == 2) {
    $authored_style = 'templates/styles/text_and_icons/user-details-authored';
  }
  else {
    $authored_style = 'templates/styles/icons_only/user-details-authored';
  }
  return array(
    'user_details_loggedin' => array(
      'template' => $loggedin_style,
      'variables' => array(
        'user_details_loggedin_picture' => NULL,
        'user_details_loggedin_created' => NULL,
        'user_details_loggedin_posts' => NULL,
        'user_details_loggedin_comments' => NULL,
        'user_details_loggedin_combined' => NULL,
        'user_details_loggedin_points_title' => NULL,
        'user_details_loggedin_points' => NULL,
        'user_details_loggedin_privatemsg' => NULL,
        'user_details_loggedin_role' => NULL,
        'user_details_loggedin_front_imgsrc' => NULL,
        'user_details_loggedin_profile_url' => NULL,
        'user_details_loggedin_profile_imgsrc' => NULL,
        'user_details_loggedin_profile_edit_url' => NULL,
        'user_details_loggedin_profile_edit_imgsrc' => NULL,
        'user_details_loggedin_privatemsg_url' => NULL,
        'user_details_loggedin_privatemsg_imgsrc' => NULL,
        'user_details_loggedin_create_imgsrc' => NULL,
        'user_details_loggedin_ubercart_cart_imgsrc' => NULL,
        'user_details_loggedin_search_imgsrc' => NULL,
        'user_details_loggedin_logout_imgsrc' => NULL,
        'user_details_loggedin_admin_imgsrc' => NULL,
        'user_details_loggedin_user_details_imgsrc' => NULL,
        'user_details_loggedin_panels_imgsrc' => NULL,
        'user_details_loggedin_views_imgsrc' => NULL,
        'user_details_loggedin_performance_imgsrc' => NULL,
        'user_details_loggedin_link_one_url' => NULL,
        'user_details_loggedin_link_one_imgsrc' => NULL,
        'user_details_loggedin_link_one_title' => NULL,
        'user_details_loggedin_link_two_url' => NULL,
        'user_details_loggedin_link_two_imgsrc' => NULL,
        'user_details_loggedin_link_two_title' => NULL,
        'user_details_loggedin_link_three_url' => NULL,
        'user_details_loggedin_link_three_imgsrc' => NULL,
        'user_details_loggedin_link_three_title' => NULL,
        'user_details_loggedin_link_four_url' => NULL,
        'user_details_loggedin_link_four_imgsrc' => NULL,
        'user_details_loggedin_link_four_title' => NULL,
        'user_details_loggedin_link_five_url' => NULL,
        'user_details_loggedin_link_five_imgsrc' => NULL,
        'user_details_loggedin_link_five_title' => NULL,
        'user_details_loggedin_content' => NULL,
      ),
    ),
    'user_details_authored' => array(
      'template' => $authored_style,
      'variables' => array(
        'user_details_authored_picture' => NULL,
        'user_details_authored_created' => NULL,
        'user_details_authored_posts' => NULL,
        'user_details_authored_comments' => NULL,
        'user_details_authored_combined' => NULL,
        'user_details_authored_points_title' => NULL,
        'user_details_authored_points' => NULL,
        'user_details_authored_role' => NULL,
        'user_details_authored_profile_url' => NULL,
        'user_details_authored_profile_imgsrc' => NULL,
        'user_details_authored_link_one_url' => NULL,
        'user_details_authored_link_one_imgsrc' => NULL,
        'user_details_authored_link_one_title' => NULL,
        'user_details_authored_link_two_url' => NULL,
        'user_details_authored_link_two_imgsrc' => NULL,
        'user_details_authored_link_two_title' => NULL,
        'user_details_authored_link_three_url' => NULL,
        'user_details_authored_link_three_imgsrc' => NULL,
        'user_details_authored_link_three_title' => NULL,
        'user_details_authored_link_four_url' => NULL,
        'user_details_authored_link_four_imgsrc' => NULL,
        'user_details_authored_link_four_title' => NULL,
        'user_details_authored_link_five_url' => NULL,
        'user_details_authored_link_five_imgsrc' => NULL,
        'user_details_authored_link_five_title' => NULL,
        'user_details_authored_content' => NULL,
      ),
    ),
  );
}


/**
 * Implements hook_image_default_styles().
 */
function user_details_image_default_styles() {
  $styles = array();

  $styles['user_details_loggedin_avatar'] = array(
    'effects' => array(
      array(
        'name' => 'image_scale',
        'data' => array(
          'width' => '100',
          'height' => '100',
          'upscale' => 1,
        ),
      ),
    ),
  );
  $styles['user_details_authored_avatar'] = array(
    'effects' => array(
      array(
        'name' => 'image_scale',
        'data' => array(
          'width' => '100',
          'height' => '100',
          'upscale' => 1,
        ),
      ),
    ),
  );

  return $styles;
}

/**
 * Implements hook_block_save().
 *
 * Sends all the admin option (checkboxes, textfields, ect) variables to the database to be stored.
 */
function user_details_block_save($delta = '', $edit = array()) {
  if ($delta == 'loggedin') {
    variable_set('user_details_loggedin_template_style', $edit['user_details_loggedin_template_view']);
    variable_set('user_details_loggedin_picture_view', $edit['user_details_loggedin_picture_view']);
    variable_set('user_details_loggedin_created_view', $edit['user_details_loggedin_created_view']);
    variable_set('user_details_loggedin_posts_view', $edit['user_details_loggedin_posts_view']);
    variable_set('user_details_loggedin_comments_view', $edit['user_details_loggedin_comments_view']);
    variable_set('user_details_loggedin_combined_view', $edit['user_details_loggedin_combined_view']);
    variable_set('user_details_loggedin_points_view', $edit['user_details_loggedin_posts_view']);
    variable_set('user_details_loggedin_role_view', $edit['user_details_loggedin_role_view']);
    variable_set('user_details_loggedin_privatemsg_view', $edit['user_details_loggedin_privatemsg_view']);
    variable_set('user_details_loggedin_front_view', $edit['user_details_loggedin_front_view']);
    variable_set('user_details_loggedin_front_imgsrc', $edit['user_details_loggedin_front_imgsrc']);
    variable_set('user_details_loggedin_profile_view', $edit['user_details_loggedin_profile_view']);
    variable_set('user_details_loggedin_profile_imgsrc', $edit['user_details_loggedin_profile_imgsrc']);
    variable_set('user_details_loggedin_profile_edit_view', $edit['user_details_loggedin_profile_edit_view']);
    variable_set('user_details_loggedin_profile_edit_imgsrc', $edit['user_details_loggedin_profile_edit_imgsrc']);
    variable_set('user_details_loggedin_private_message_view', $edit['user_details_loggedin_private_message_view']);
    variable_set('user_details_loggedin_private_message_imgsrc', $edit['user_details_loggedin_private_message_imgsrc']);
    variable_set('user_details_loggedin_blog_view', $edit['user_details_loggedin_blog_view']);
    variable_set('user_details_loggedin_blog_imgsrc', $edit['user_details_loggedin_blog_imgsrc']);
    variable_set('user_details_loggedin_create_view', $edit['user_details_loggedin_create_view']);
    variable_set('user_details_loggedin_create_imgsrc', $edit['user_details_loggedin_create_imgsrc']);
    variable_set('user_details_loggedin_ubercart_cart_view', $edit['user_details_loggedin_ubercart_cart_view']);
    variable_set('user_details_loggedin_ubercart_cart_imgsrc', $edit['user_details_loggedin_ubercart_cart_imgsrc']);
    variable_set('user_details_loggedin_search_view', $edit['user_details_loggedin_search_view']);
    variable_set('user_details_loggedin_search_imgsrc', $edit['user_details_loggedin_search_imgsrc']);
    variable_set('user_details_loggedin_admin_view', $edit['user_details_loggedin_admin_view']);
    variable_set('user_details_loggedin_admin_imgsrc', $edit['user_details_loggedin_admin_imgsrc']);
    variable_set('user_details_loggedin_user_details_view', $edit['user_details_loggedin_user_details_view']);
    variable_set('user_details_loggedin_user_details_imgsrc', $edit['user_details_loggedin_user_details_imgsrc']);
    variable_set('user_details_loggedin_panels_view', $edit['user_details_loggedin_panels_view']);
    variable_set('user_details_loggedin_panels_imgsrc', $edit['user_details_loggedin_panels_imgsrc']);
    variable_set('user_details_loggedin_views_view', $edit['user_details_loggedin_views_view']);
    variable_set('user_details_loggedin_views_imgsrc', $edit['user_details_loggedin_views_imgsrc']);
    variable_set('user_details_loggedin_performance_view', $edit['user_details_loggedin_performance_view']);
    variable_set('user_details_loggedin_performance_imgsrc', $edit['user_details_loggedin_performance_imgsrc']);
    variable_set('user_details_loggedin_logout_view', $edit['user_details_loggedin_logout_view']);
    variable_set('user_details_loggedin_logout_imgsrc', $edit['user_details_loggedin_logout_imgsrc']);
    variable_set('user_details_loggedin_link_one_type', $edit['user_details_loggedin_link_one_type']);
    variable_set('user_details_loggedin_link_one_imgsrc', $edit['user_details_loggedin_link_one_imgsrc']);
    variable_set('user_details_loggedin_link_one_title', $edit['user_details_loggedin_link_one_title']);
    variable_set('user_details_loggedin_link_two_type', $edit['user_details_loggedin_link_two_type']);
    variable_set('user_details_loggedin_link_two_imgsrc', $edit['user_details_loggedin_link_two_imgsrc']);
    variable_set('user_details_loggedin_link_two_title', $edit['user_details_loggedin_link_two_title']);
    variable_set('user_details_loggedin_link_three_type', $edit['user_details_loggedin_link_three_type']);
    variable_set('user_details_loggedin_link_three_imgsrc', $edit['user_details_loggedin_link_three_imgsrc']);
    variable_set('user_details_loggedin_link_three_title', $edit['user_details_loggedin_link_three_title']);
    variable_set('user_details_loggedin_link_four_type', $edit['user_details_loggedin_link_four_type']);
    variable_set('user_details_loggedin_link_four_imgsrc', $edit['user_details_loggedin_link_four_imgsrc']);
    variable_set('user_details_loggedin_link_four_title', $edit['user_details_loggedin_link_four_title']);
    variable_set('user_details_loggedin_link_five_type', $edit['user_details_loggedin_link_five_type']);
    variable_set('user_details_loggedin_link_five_imgsrc', $edit['user_details_loggedin_link_five_imgsrc']);
    variable_set('user_details_loggedin_link_five_title', $edit['user_details_loggedin_link_five_title']);
    variable_set('user_details_loggedin_content_amount', $edit['user_details_loggedin_content_amount']);
    variable_set('user_details_loggedin_content_truncate', $edit['user_details_loggedin_content_truncate']);
    variable_set('user_details_loggedin_content_view', $edit['user_details_loggedin_content_view']);
  }
  if ($delta == 'authored') {
    variable_set('user_details_authored_template_style', $edit['user_details_authored_template_view']);
    variable_set('user_details_authored_picture_view', $edit['user_details_authored_picture_view']);
    variable_set('user_details_authored_created_view', $edit['user_details_authored_created_view']);
    variable_set('user_details_authored_posts_view', $edit['user_details_authored_posts_view']);
    variable_set('user_details_authored_comments_view', $edit['user_details_authored_comments_view']);
    variable_set('user_details_authored_combined_view', $edit['user_details_authored_combined_view']);
    variable_set('user_details_authored_points_view', $edit['user_details_authored_posts_view']);
    variable_set('user_details_authored_role_view', $edit['user_details_authored_role_view']);
    variable_set('user_details_authored_profile_view', $edit['user_details_authored_profile_view']);
    variable_set('user_details_authored_profile_imgsrc', $edit['user_details_authored_profile_imgsrc']);
    variable_set('user_details_authored_blog_view', $edit['user_details_authored_blog_view']);
    variable_set('user_details_authored_blog_imgsrc', $edit['user_details_authored_blog_imgsrc']);
    variable_set('user_details_authored_logout_view', $edit['user_details_authored_logout_view']);
    variable_set('user_details_authored_logout_imgsrc', $edit['user_details_authored_logout_imgsrc']);
    variable_set('user_details_authored_link_one_type', $edit['user_details_authored_link_one_type']);
    variable_set('user_details_authored_link_one_imgsrc', $edit['user_details_authored_link_one_imgsrc']);
    variable_set('user_details_authored_link_one_title', $edit['user_details_authored_link_one_title']);
    variable_set('user_details_authored_link_two_type', $edit['user_details_authored_link_two_type']);
    variable_set('user_details_authored_link_two_imgsrc', $edit['user_details_authored_link_two_imgsrc']);
    variable_set('user_details_authored_link_two_title', $edit['user_details_authored_link_two_title']);
    variable_set('user_details_authored_link_three_type', $edit['user_details_authored_link_three_type']);
    variable_set('user_details_authored_link_three_imgsrc', $edit['user_details_authored_link_three_imgsrc']);
    variable_set('user_details_authored_link_three_title', $edit['user_details_authored_link_three_title']);
    variable_set('user_details_authored_link_four_type', $edit['user_details_authored_link_four_type']);
    variable_set('user_details_authored_link_four_imgsrc', $edit['user_details_authored_link_four_imgsrc']);
    variable_set('user_details_authored_link_four_title', $edit['user_details_authored_link_four_title']);
    variable_set('user_details_authored_link_five_type', $edit['user_details_authored_link_five_type']);
    variable_set('user_details_authored_link_five_imgsrc', $edit['user_details_authored_link_five_imgsrc']);
    variable_set('user_details_authored_link_five_title', $edit['user_details_authored_link_five_title']);
    variable_set('user_details_authored_content_amount', $edit['user_details_authored_content_amount']);
    variable_set('user_details_authored_content_truncate', $edit['user_details_authored_content_truncate']);
    variable_set('user_details_authored_content_view', $edit['user_details_authored_content_view']);
  }
  return;
}

/**
 * Implements hook_block_info().
 *
 * Creates the title of the block for the block list page.
 */
function user_details_block_info() {
  $blocks['loggedin']['info'] = t('User Details: logged-in user');
  $blocks['authored']['info'] = t('User Details: authored user');
  return $blocks;
}

/**
 * Implements hook_block_view().
 *
 * Creates the block title and content.
 */
function user_details_block_view($delta = '') {
  global $user;
  $area = arg(0);

  switch ($delta) {
    case 'loggedin':
      if ($user->uid != 0) {
        $block['subject'] = t('%name', array(
          '%name' => $user->name,
          )
        );
        $block['content'] = user_details_loggedin_block_content();
        return $block;
      }
      else {
        return;
      }
    case 'authored':
      if ($area == 'user') {
        $uid = arg(1);
        $account = user_load($uid);
        $block['subject'] = t('%name', array(
          '%name' => $account->name,
          )
        );
        $block['content'] = user_details_authored_block_content();
        return $block;
      }
      if ($area == 'node') {
        $node = menu_get_object();
        $uid = $node->uid;
        $account = user_load($uid);
        $block['subject'] = t('%name', array(
          '%name' => $account->name,
          )
        );
        $block['content'] = user_details_authored_block_content();
        return $block;
      }
      else {
        return;
      }
  }
}

/**
 * Process variables for user-details-loggedin.tpl.php.
 *
 * This function takes the result of the stored variable(options checkbox) and
 * creates a variable result from it.
 */
function template_preprocess_user_details_loggedin(&$variables) {
  global $user;
  $co = $output = NULL;
  if (variable_get('user_details_loggedin_template_style') == 1) {
    drupal_add_css(drupal_get_path('module', 'user_details') . '/css/styles/icons_only/user_details_loggedin.css');
  }
  if (variable_get('user_details_loggedin_template_style') == 2) {
    drupal_add_css(drupal_get_path('module', 'user_details') . '/css/styles/text_and_icons/user_details_loggedin.css');
  }

  if (variable_get('user_details_loggedin_picture_view') !=0) {
    $variables['user_details_loggedin_picture'] = theme('user_picture', array(
      'account' => $user,
      'style_name' => 'user_details_loggedin_avatar',
      )
    );
  }
  if (variable_get('user_details_loggedin_created_view') != 0) {
    $user_details_loggedin_created_date = date('c', $user->created);
    $variables['user_details_loggedin_created'] = date('M j, Y', strtotime($user_details_loggedin_created_date));
  }
  if (variable_get('user_details_loggedin_posts_view') != 0) {
    $user_details_loggedin_posts_query = db_select('node', 'n');
    $user_details_loggedin_posts_query
      ->condition('n.uid', $user->uid, '=')
      ->fields('n', array('uid'));
    $variables['user_details_loggedin_posts'] = t('%posts', array(
      '%posts' => $user_details_loggedin_posts_query->countQuery()->execute()->fetchField(),
      )
    );
  }
  if (variable_get('user_details_loggedin_comments_view') != 0 && module_exists('comment')) {
    $user_details_loggedin_comments_query = db_select('comment');
    $user_details_loggedin_comments_query
      ->condition('uid', $user->uid, '=')
      ->fields('comment', array('uid'));
    $variables['user_details_loggedin_comments'] = t('%comments', array(
      '%comments' => $user_details_loggedin_comments_query->countQuery()->execute()->fetchField(),
      )
    );
  }
  if (variable_get('user_details_loggedin_combined_view') != 0 && module_exists('comment')) {
    $user_details_loggedin_combined_posts_query = db_select('node', 'n');
    $user_details_loggedin_combined_posts_query
      ->condition('n.uid', $user->uid, '=')
      ->fields('n', array('uid'));
    $posts = $user_details_loggedin_combined_posts_query->countQuery()->execute()->fetchField();
    $user_details_loggedin_combined_comments_query = db_select('comment');
    $user_details_loggedin_combined_comments_query
      ->condition('uid', $user->uid, '=')
      ->fields('comment', array('uid'));
    $comments = $user_details_loggedin_combined_comments_query->countQuery()->execute()->fetchField();
    $variables['user_details_loggedin_combined'] = $posts + $comments;
  };
  if (variable_get('user_details_loggedin_points_view') !=0 && module_exists('userpoints')) {
    $variables['user_details_loggedin_points_title'] = t('!Points', userpoints_translation());
    $variables['user_details_loggedin_points'] = userpoints_get_current_points($user->uid, 'all');
  }
  if (variable_get('user_details_loggedin_role_view') != 0) {
    $user_details_loggedin_role_id_query = db_select('users_roles');
    $user_details_loggedin_role_id_query
      ->condition('uid', $user->uid, '=')
      ->fields('users_roles', array('rid'));
    $user_details_loggedin_role_id = $user_details_loggedin_role_id_query->execute()->fetchField();
    if (($user_details_loggedin_role_id) == NULL) {
      $user_details_loggedin_role_id = 2;
    }
    $user_details_loggedin_role_name_query = db_select('role', 'r');
    $user_details_loggedin_role_name_query
      ->condition('rid', $user_details_loggedin_role_id, '=')
      ->fields('r', array('name'));
    $user_details_loggedin_role = $user_details_loggedin_role_name_query->execute()->fetchField();
    $variables['user_details_loggedin_role'] = t('%role', array(
      '%role' => $user_details_loggedin_role,
      )
    );
  }
  if (variable_get('user_details_loggedin_privatemsg_unread_view') != 0 && module_exists('privatemsg')) {
    $privatemsg_unread = privatemsg_unread_count();
    $variables['user_details_loggedin_privatemsg_unread'] = t('%privatemsg_unread', array(
      '%privatemsg_unread' => $privatemsg_unread,
      )
    );
  }
  if (variable_get('user_details_loggedin_front_view') != 0) {
    $variables['user_details_loggedin_front_imgsrc'] = variable_get('user_details_loggedin_front_imgsrc');
  }
  if (variable_get('user_details_loggedin_profile_view') != 0) {
    $variables['user_details_loggedin_profile_url'] = '/user/' . $user->uid;
    $variables['user_details_loggedin_profile_imgsrc'] = variable_get('user_details_loggedin_profile_imgsrc');
  }
  if (variable_get('user_details_loggedin_profile_edit_view') != 0) {
    $variables['user_details_loggedin_profile_edit_url'] = '/user/' . $user->uid . '/edit';
    $variables['user_details_loggedin_profile_edit_imgsrc'] = variable_get('user_details_loggedin_profile_edit_imgsrc');
  }
  if (variable_get('user_details_loggedin_private_message_view') != 0 && module_exists('privatemsg')) {
    $variables['user_details_loggedin_private_message_url'] = '/messages/' . $user->uid;
    $variables['user_details_loggedin_private_message_imgsrc'] = variable_get('user_details_loggedin_private_message_imgsrc');
  }
  if (variable_get('user_details_loggedin_blog_view') != 0 && module_exists('blog')) {
    $variables['user_details_loggedin_blog_url'] = '/blog/' . $user->uid;
    $variables['user_details_loggedin_blog_imgsrc'] = variable_get('user_details_loggedin_blog_imgsrc');
  }
  if (variable_get('user_details_loggedin_create_view') != 0) {
    $variables['user_details_loggedin_create_imgsrc'] = variable_get('user_details_loggedin_create_imgsrc');
  }
  if (variable_get('user_details_loggedin_ubercart_cart_view') != 0 && module_exists('uc_cart')) {
    $variables['user_details_loggedin_ubercart_cart_imgsrc'] = variable_get('user_details_loggedin_ubercart_cart_imgsrc');
  }
  if (variable_get('user_details_loggedin_search_view') != 0 && module_exists('search')) {
    $variables['user_details_loggedin_search_imgsrc'] = variable_get('user_details_loggedin_search_imgsrc');
  }
  if (variable_get('user_details_loggedin_logout_view') != 0) {
    $variables['user_details_loggedin_logout_imgsrc'] = variable_get('user_details_loggedin_logout_imgsrc');
  }
  if (variable_get('user_details_loggedin_link_one_type') != 0) {
    $variables['user_details_loggedin_link_one_url'] = variable_get('user_details_loggedin_link_one_url');
    $variables['user_details_loggedin_link_one_imgsrc'] = variable_get('user_details_loggedin_link_one_imgsrc');
    $variables['user_details_loggedin_link_one_title'] = variable_get('user_details_loggedin_link_one_title');
  }
  if (variable_get('user_details_loggedin_link_two_type') != 0) {
    $variables['user_details_loggedin_link_two_url'] = variable_get('user_details_loggedin_link_two_url');
    $variables['user_details_loggedin_link_two_imgsrc'] = variable_get('user_details_loggedin_link_two_imgsrc');
    $variables['user_details_loggedin_link_two_title'] = variable_get('user_details_loggedin_link_two_title');
  }
  if (variable_get('user_details_loggedin_link_three_type') != 0) {
    $variables['user_details_loggedin_link_three_url'] = variable_get('user_details_loggedin_link_three_url');
    $variables['user_details_loggedin_link_three_imgsrc'] = variable_get('user_details_loggedin_link_three_imgsrc');
    $variables['user_details_loggedin_link_three_title'] = variable_get('user_details_loggedin_link_three_title');
  }
  if (variable_get('user_details_loggedin_link_four_type') != 0) {
    $variables['user_details_loggedin_link_four_url'] = variable_get('user_details_loggedin_link_four_url');
    $variables['user_details_loggedin_link_four_imgsrc'] = variable_get('user_details_loggedin_link_four_imgsrc');
    $variables['user_details_loggedin_link_four_title'] = variable_get('user_details_loggedin_link_four_title');
  }
  if (variable_get('user_details_loggedin_link_five_type') != 0) {
    $variables['user_details_loggedin_link_five_url'] = variable_get('user_details_loggedin_link_five_url');
    $variables['user_details_loggedin_link_five_imgsrc'] = variable_get('user_details_loggedin_link_five_imgsrc');
    $variables['user_details_loggedin_link_five_title'] = variable_get('user_details_loggedin_link_five_title');
  }
  if (variable_get('user_details_loggedin_admin_view') != 0) {
    $variables['user_details_loggedin_admin_imgsrc'] = variable_get('user_details_loggedin_admin_imgsrc');
  }
  if (variable_get('user_details_loggedin_user_details_view') != 0 && module_exists('user_details')) {
    $variables['user_details_loggedin_user_details_imgsrc'] = variable_get('user_details_loggedin_user_details_imgsrc');
  }
  if (variable_get('user_details_loggedin_panels_view') != 0 && module_exists('panels')) {
    $variables['user_details_loggedin_panels_imgsrc'] = variable_get('user_details_loggedin_panels_imgsrc');
  }
  if (variable_get('user_details_loggedin_views_view') != 0 && module_exists('views')) {
    $variables['user_details_loggedin_views_imgsrc'] = variable_get('user_details_loggedin_views_imgsrc');
  }
  if (variable_get('user_details_loggedin_performance_view') != 0) {
    $variables['user_details_loggedin_performance_imgsrc'] = variable_get('user_details_loggedin_performance_imgsrc');
  }
  if (variable_get('user_details_loggedin_content_view') != 0 && variable_get('user_details_loggedin_content_amount') !=0 && variable_get('user_details_loggedin_content_truncate') != 0) {
    $user_details_loggedin_content_amount = variable_get('user_details_loggedin_content_amount');
  }
  if (variable_get('user_details_loggedin_content_view') != 0 && variable_get('user_details_loggedin_content_amount') !=0 && variable_get('user_details_loggedin_content_truncate') != 0) {
    $truncate_amount = variable_get('user_details_loggedin_content_truncate');
    $user_details_loggedin_content_truncate = $truncate_amount - 3;
  }
  if (variable_get('user_details_loggedin_content_view') != 0 && variable_get('user_details_loggedin_content_amount') !=0 && variable_get('user_details_loggedin_content_truncate') != 0) {
    unset($output);
    $trailing_text = t('...');
    if ($user->uid) {
    // Sql query.
      $user_details_loggedin_content_query = db_select('node', 'n');
      $user_details_loggedin_content_query
        ->condition('n.uid', $user->uid, '=')
        ->fields('n', array('created', 'title', 'nid', 'changed', 'type', 'status'))
        ->range(0, $user_details_loggedin_content_amount)
        ->orderBy('changed', 'DESC');
      $user_details_loggedin_content_fetchfield = $user_details_loggedin_content_query->execute();
      $output = '';
      foreach ($user_details_loggedin_content_fetchfield as $user_details_loggedin_content_node ) {
        $co++;
        if (mb_strlen($user_details_loggedin_content_node->title) > $user_details_loggedin_content_truncate) {
          $output .= '<li>';
          $output .= l(mb_substr($user_details_loggedin_content_node->title, 0, $user_details_loggedin_content_truncate) . $trailing_text, "node/$user_details_loggedin_content_node->nid");
          $output .= '</li>';
        }
        else {
          $output .= '<li>';
          $output .= l($user_details_loggedin_content_node->title, "node/$user_details_loggedin_content_node->nid");
          $output .= '</li>';
        }
      }
      $output .= '';
      // Show only if user have made some content.
      if ($co>0) {
        $variables['user_details_loggedin_content'] = $output;
      }
      if ($co == 0) {
        $variables['user_details_loggedin_content'] = t('No content to list.');
      }
    }
  }
}

/**
 * Process variables for user-details-authored.tpl.php.
 *
 * This function takes the result of the stored variable(options checkbox) and
 * creates a variable result from it.
 */
function template_preprocess_user_details_authored(&$variables) {
  drupal_add_css(drupal_get_path('module', 'user_details') . '/css/user_details_authored.css');
  $img_dir = drupal_get_path('module', 'user_details') . "/images/";
  // If the page is a node we need to load the user data from the node ID(nid)
  // profile.
  $area = arg(0);
  $co = $output = NULL;
  //If the page is a node we need to load the node data to get the author data
  if ($area == 'node') {
    $node_load = node_load(arg(1));
    $uid = $node_load->uid;
    $user = user_load($uid);
  }
  // If the page is a user profile we need to load the user data from the user profile.
  if ($area == 'user') {
    $uid = arg(1);
    $user = user_load($uid);
  }
  global $base_url;
  $url = $base_url . request_uri();
  $profile = $base_url . '/user/' . $user->uid;

  if (variable_get('user_details_authored_template_style') == 1) {
    drupal_add_css(drupal_get_path('module', 'user_details') . '/css/styles/icons_only/user_details_authored.css');
  }
  if (variable_get('user_details_authored_template_style') == 2) {
    drupal_add_css(drupal_get_path('module', 'user_details') . '/css/styles/text_and_icons/user_details_authored.css');
  }
  if (variable_get('user_details_authored_picture_view') !=0) {
    $variables['user_details_authored_picture'] = theme('user_picture', array(
      'account' => $user,
      'style_name' => 'user_details_authored_avatar',
      )
    );
  }
  if (variable_get('user_details_authored_created_view') != 0) {
    $user_details_authored_created_date = date('c', $user->created);
    $variables['user_details_authored_created'] = date('M j, Y', strtotime($user_details_authored_created_date));
  }
  if (variable_get('user_details_authored_posts_view') != 0) {
    $user_details_authored_posts_query = db_select('node', 'n');
    $user_details_authored_posts_query
      ->condition('n.uid', $user->uid, '=')
      ->fields('n', array('uid'));
    $variables['user_details_authored_posts'] = t('%posts', array(
      '%posts' => $user_details_authored_posts_query->countQuery()->execute()->fetchField(),
      )
    );
  }
  if (variable_get('user_details_authored_comments_view') != 0 && module_exists('comment')) {
    $user_details_authored_comments_query = db_select('comment');
    $user_details_authored_comments_query
      ->condition('uid', $user->uid, '=')
      ->fields('comment', array('uid'));
    $variables['user_details_authored_comments'] = t('%comments', array(
      '%comments' => $user_details_authored_comments_query->countQuery()->execute()->fetchField(),
      )
    );
  }
  if (variable_get('user_details_authored_combined_view') != 0 && module_exists('comment')) {
    $user_details_authored_combined_posts_query = db_select('node', 'n');
    $user_details_authored_combined_posts_query
      ->condition('n.uid', $user->uid, '=')
      ->fields('n', array('uid'));
    $posts = $user_details_authored_combined_posts_query->countQuery()->execute()->fetchField();
    $user_details_authored_combined_comments_query = db_select('comment');
    $user_details_authored_combined_comments_query
      ->condition('uid', $user->uid, '=')
      ->fields('comment', array('uid'));
    $comments = $user_details_authored_combined_comments_query->countQuery()->execute()->fetchField();
    $variables['user_details_authored_combined'] = $posts + $comments;
  };
  if (variable_get('user_details_authored_points_view') !=0 && module_exists('userpoints')) {
    $variables['user_details_authored_points_title'] = t('!Points', userpoints_translation());
    $variables['user_details_authored_points'] = userpoints_get_current_points($user->uid, 'all');
  }
  if (variable_get('user_details_authored_role_view') != 0) {
    $user_details_authored_role_id_query = db_select('users_roles');
    $user_details_authored_role_id_query
      ->condition('uid', $user->uid, '=')
      ->fields('users_roles', array('rid'));
    $user_details_authored_role_id = $user_details_authored_role_id_query->execute()->fetchField();
    if (($user_details_authored_role_id) == NULL) {
      $user_details_authored_role_id = 2;
    }
    $user_details_authored_role_name_query = db_select('role', 'r');
    $user_details_authored_role_name_query
      ->condition('rid', $user_details_authored_role_id, '=')
      ->fields('r', array('name'));
    $user_details_authored_role = $user_details_authored_role_name_query->execute()->fetchField();
    $variables['user_details_authored_role'] = t('%role', array(
      '%role' => $user_details_authored_role,
      )
    );
  }
  if (variable_get('user_details_authored_profile_view') != 0 && $area != 'user') {
    $variables['user_details_authored_profile_url'] = '/user/' . $user->uid;
    $variables['user_details_authored_profile_imgsrc'] = variable_get('user_details_authored_profile_imgsrc');
  }
  if (variable_get('user_details_authored_private_message_view') != 0 && module_exists('privatemsg')) {
    $variables['user_details_authored_private_message_url'] = '/messages/' . $user->uid;
    $variables['user_details_authored_private_message_imgsrc'] = variable_get('user_details_authored_private_message_imgsrc');
  }
  if (variable_get('user_details_authored_blog_view') != 0 && module_exists('blog')) {
    $variables['user_details_authored_blog_url'] = '/blog/' . $user->uid;
    $variables['user_details_authored_blog_imgsrc'] = variable_get('user_details_authored_blog_imgsrc');
  }
  if (variable_get('user_details_authored_link_one_type') != 0) {
    $variables['user_details_authored_link_one_url'] = variable_get('user_details_authored_link_one_url');
    $variables['user_details_authored_link_one_imgsrc'] = variable_get('user_details_authored_link_one_imgsrc');
    $variables['user_details_authored_link_one_title'] = variable_get('user_details_authored_link_one_title');
  }
  if (variable_get('user_details_authored_link_two_type') != 0) {
    $variables['user_details_authored_link_two_url'] = variable_get('user_details_authored_link_two_url');
    $variables['user_details_authored_link_two_imgsrc'] = variable_get('user_details_authored_link_two_imgsrc');
    $variables['user_details_authored_link_two_title'] = variable_get('user_details_authored_link_two_title');
  }
  if (variable_get('user_details_authored_link_three_type') != 0) {
    $variables['user_details_authored_link_three_url'] = variable_get('user_details_authored_link_three_url');
    $variables['user_details_authored_link_three_imgsrc'] = variable_get('user_details_authored_link_three_imgsrc');
    $variables['user_details_authored_link_three_title'] = variable_get('user_details_authored_link_three_title');
  }
  if (variable_get('user_details_authored_link_four_type') != 0) {
    $variables['user_details_authored_link_four_url'] = variable_get('user_details_authored_link_four_url');
    $variables['user_details_authored_link_four_imgsrc'] = variable_get('user_details_authored_link_four_imgsrc');
    $variables['user_details_authored_link_four_title'] = variable_get('user_details_authored_link_four_title');
  }
  if (variable_get('user_details_authored_link_five_type') != 0) {
    $variables['user_details_authored_link_five_url'] = variable_get('user_details_authored_link_five_url');
    $variables['user_details_authored_link_five_imgsrc'] = variable_get('user_details_authored_link_five_imgsrc');
    $variables['user_details_authored_link_five_title'] = variable_get('user_details_authored_link_five_title');
  }
  if (variable_get('user_details_authored_content_view') != 0 && variable_get('user_details_authored_content_amount') !=0 && variable_get('user_details_authored_content_truncate') != 0) {
    $user_details_authored_content_amount = variable_get('user_details_authored_content_amount');
  }
  if (variable_get('user_details_authored_content_view') != 0 && variable_get('user_details_authored_content_amount') !=0 && variable_get('user_details_authored_content_truncate') != 0) {
    $truncate_amount = variable_get('user_details_authored_content_truncate');
    $user_details_authored_content_truncate = $truncate_amount - 3;
  }
  if (variable_get('user_details_authored_content_view') != 0 && variable_get('user_details_authored_content_amount') !=0 && variable_get('user_details_authored_content_truncate') != 0) {
    unset($output);
    $trailing_text = t('...');
    if ($user->uid) {
    // Sql query.
      $user_details_authored_content_query = db_select('node', 'n');
      $user_details_authored_content_query
        ->condition('n.uid', $user->uid, '=')
        ->fields('n', array('created', 'title', 'nid', 'changed', 'type', 'status'))
        ->range(0, $user_details_authored_content_amount)
        ->orderBy('changed', 'DESC');
      $user_details_authored_content_fetchfield = $user_details_authored_content_query->execute();
      $output = '';
      foreach ($user_details_authored_content_fetchfield as $user_details_authored_content_node ) {
        $co++;
        if (mb_strlen($user_details_authored_content_node->title) > $user_details_authored_content_truncate) {
          $output .= '<li>';
          $output .= l(mb_substr($user_details_authored_content_node->title, 0, $user_details_authored_content_truncate) . $trailing_text, "node/$user_details_authored_content_node->nid");
          $output .= '</li>';
        }
        else {
          $output .= '<li>';
          $output .= l($user_details_authored_content_node->title, "node/$user_details_authored_content_node->nid");
          $output .= '</li>';
        }
      }
      $output .= '';
      // Show only if user have made some content.
      if ($co>0) {
        $variables['user_details_authored_content'] = $output;
      }
      if ($co == 0) {
        $variables['user_details_authored_content'] = t('No content to list.');
      }
    }
  }
}

/**
 * Used to push the variables to the theme layer for the "logged-in" block.
 */
function user_details_loggedin_block_content() {
  $content = array(
    $user_details_loggedin_picture = 'user_details_loggedin_picture',
    $user_details_loggedin_created = 'user_details_loggedin_created',
    $user_details_loggedin_posts = 'user_details_loggedin_posts',
    $user_details_loggedin_comments = 'user_details_loggedin_comments',
    $user_details_loggedin_combined = 'user_details_loggedin_combined',
    $user_details_loggedin_points_title = 'user_details_loggedin_points_title',
    $user_details_loggedin_points = 'user_details_loggedin_points',
    $user_details_loggedin_privatemsg = 'user_details_loggedin_privatemsg',
    $user_details_loggedin_role = 'user_details_loggedin_role',
    $user_details_loggedin_front_imgsrc = 'user_details_loggedin_front_imgsrc',
    $user_details_loggedin_profile_url = 'user_details_loggedin_profile_url',
    $user_details_loggedin_profile_imgsrc = 'user_details_loggedin_profile_imgsrc',
    $user_details_loggedin_profile_edit_url = 'user_details_loggedin_profile_edit_url',
    $user_details_loggedin_profile_edit_imgsrc = 'user_details_loggedin_profile_edit_imgsrc',
    $user_details_loggedin_privatemsg_url = 'user_details_loggedin_privatemsg_url',
    $user_details_loggedin_privatemsg_imgsrc = 'user_details_loggedin_privatemsg_imgsrc',
    $user_details_loggedin_blog_imgsrc = 'user_details_loggedin_blog_imgsrc',
    $user_details_loggedin_create_imgsrc = 'user_details_loggedin_create_imgsrc',
    $user_details_loggedin_ubercart_cart_imgsrc = 'user_details_loggedin_ubercart_cart_imgsrc',
    $user_details_loggedin_search_imgsrc = 'user_details_loggedin_search_imgsrc',
    $user_details_loggedin_logout_imgsrc = 'user_details_loggedin_logout_imgsrc',
    $user_details_loggedin_admin_imgsrc = 'user_details_loggedin_admin_imgsrc',
    $user_details_loggedin_user_details_imgsrc = 'user_details_loggedin_user_details_imgsrc',
    $user_details_loggedin_panels_imgsrc = 'user_details_loggedin_panels_imgsrc',
    $user_details_loggedin_views_imgsrc = 'user_details_loggedin_views_imgsrc',
    $user_details_loggedin_performance_imgsrc = 'user_details_loggedin_performance_imgsrc',
    $user_details_loggedin_link_one_url = 'user_details_loggedin_link_one_url',
    $user_details_loggedin_link_one_imgsrc = 'user_details_loggedin_link_one_imgsrc',
    $user_details_loggedin_link_one_title = 'user_details_loggedin_link_one_title',
    $user_details_loggedin_link_two_url = 'user_details_loggedin_link_two_url',
    $user_details_loggedin_link_two_imgsrc = 'user_details_loggedin_link_two_imgsrc',
    $user_details_loggedin_link_two_title = 'user_details_loggedin_link_two_title',
    $user_details_loggedin_link_three_url = 'user_details_loggedin_link_three_url',
    $user_details_loggedin_link_three_imgsrc = 'user_details_loggedin_link_three_imgsrc',
    $user_details_loggedin_link_three_title = 'user_details_loggedin_link_three_title',
    $user_details_loggedin_link_four_url = 'user_details_loggedin_link_four_url',
    $user_details_loggedin_link_four_imgsrc = 'user_details_loggedin_link_four_imgsrc',
    $user_details_loggedin_link_four_title = 'user_details_loggedin_link_four_title',
    $user_details_loggedin_link_five_url = 'user_details_loggedin_link_five_url',
    $user_details_loggedin_link_five_imgsrc = 'user_details_loggedin_link_five_imgsrc',
    $user_details_loggedin_link_five_title = 'user_details_loggedin_link_five_title',
    $user_details_loggedin_content = 'user_details_loggedin_content',
  );
  $output = theme('user_details_loggedin', $content);
  return $output;
}

/**
 * Used to push the variables to the theme layer for the "Authored by" block.
 */
function user_details_authored_block_content() {
  $content = array(
    $user_details_authored_avatar = 'user_details_authored_avatar',
    $user_details_authored_joined = 'user_details_authored_joined',
    $user_details_authored_postcount_title = 'user_details_authored_postcount_title',
    $user_details_authored_postcount_result = 'user_details_authored_postcount_result',
    $user_details_authored_points_title = 'user_details_authored_points_title',
    $user_details_authored_points_result = 'user_details_authored_points_result',
    $user_details_authored_rank_title = 'user_details_authored_rank_title',
    $user_details_authored_rank_result = 'user_details_authored_rank_result',
    $user_details_authored_stats_hr = 'user_details_authored_stats_hr',
    $user_details_authored_profilelink_url = 'user_details_authored_profilelink_url',
    $user_details_authored_profilelink_imgsrc = 'user_details_authored_profilelink_imgsrc',
    $user_details_authored_profilelink_imgtitle = 'user_details_authored_profilelink_imgtitle',
    $user_details_authored_privatemsglink_url = 'user_details_authored_privatemsglink',
    $user_details_authored_privatemsglink_imgsrc = 'user_details_authored_privatemsglink_imgsrc',
    $user_details_authored_privatemsglink_imgtitle = 'user_details_authored_privatemsglinkimgtitle',
    $user_details_authored_links_hr = 'user_details_authored_links_hr',
    $user_details_authored_content = 'user_details_authored_content',
  );
  $output = theme('user_details_authored', $content);
  return $output;
}