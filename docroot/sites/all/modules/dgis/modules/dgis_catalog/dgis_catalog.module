<?php
/**
 * @file
 * Module 2gis catalog.
 */

require_once 'dgis_catalog.views.inc';

/**
 * Implements hook_views_api().
 */
function dgis_catalog_views_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'dgis_catalog'),
  );
}

/**
 * Form alter for views exposed form.
 */
function dgis_catalog_form_alter(&$form, $form_state) {
  if (isset($form['dgis_catalog_what'])) {
    $form['#validate'][] = 'dgis_catalog_views_what_validation';
  }
  if (isset($form['dgis_catalog_where']) && variable_get('dgis_api_key', FALSE)) {
    $cities_options = array();
    $cities = dgis_get_cities();
    foreach ($cities as $city) {
      $cities_options[$city['name']] = $city['name'];
    }
    reset($cities_options);
    $form['dgis_catalog_where']['#type'] = 'select';
    $form['dgis_catalog_where']['#multiple'] = FALSE;
    $form['dgis_catalog_where']['#size'] = 1;
    $form['dgis_catalog_where']['#options'] = $cities_options;
    $form['dgis_catalog_where']['#default_value'] = isset($_REQUEST['dgis_catalog_where'])
      ? $_REQUEST['dgis_catalog_where']
      : variable_get('dgis_city', DGIS_DEFAULT_CITY);
    $form['dgis_catalog_where']['#empty_value'] = '';
    $form['#validate'][] = 'dgis_catalog_views_where_validation';
  }
}

/**
 * Validate for views exposed form.
 */
function dgis_catalog_views_what_validation($form, $form_state) {
  if (empty($form_state['values']['dgis_catalog_what'])) {
    form_error($form['dgis_catalog_what']);
  }
}

/**
 * Validate for views exposed form.
 */
function dgis_catalog_views_where_validation($form, $form_state) {
  if (empty($form_state['values']['dgis_catalog_where'])) {
    form_error($form['dgis_catalog_where']);
  }
}
