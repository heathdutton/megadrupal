<?php

/**
 * @file
 * 2gis Maps module main file.
 */

define('DGIS_DEFAULT_BLOCK_DELTA', 'dgis_maps_block');

require_once __DIR__ . '/dgis_maps.block.inc';
require_once __DIR__ . '/dgis_maps.field.inc';

/**
 * Implements hook_menu().
 */
function dgis_maps_menu() {
  $items = array();
  $items['dgis-maps/ajax'] = array(
    'title' => 'Remove item callback',
    'page callback' => 'dgis_maps_field_remove_item',
    'delivery callback' => 'ajax_deliver',
    'access callback' => TRUE,
    'theme callback' => 'ajax_base_page_theme',
    'type' => MENU_CALLBACK,
    'file path' => 'includes',
    'file' => 'form.inc',
  );

  return $items;
}

/**
 * Implements hook_library().
 */
function dgis_maps_library() {

  $module_path = drupal_get_path('module', 'dgis_maps');
  $libraries['2gis_maps'] = array(
    'title' => '2GIS maps',
    'version' => '2.0',
    'js' => array(
      'http://maps.api.2gis.ru/2.0/loader.js?pkg=full' => array(
        'type' => 'external',
        'scope' => 'footer',
        'weight' => 10,
      ),
      "$module_path/misc/2gis.js" => array(
        'type' => 'file',
        'scope' => 'footer',
        'weight' => 11,
      )
    )
  );

  $libraries['2gis_maps_block_admin'] = array(
    'title' => '2GIS maps block admin',
    'version' => '2.0',
    'js' => array(
      'http://maps.api.2gis.ru/2.0/loader.js?pkg=full' => array(
        'type' => 'external',
        'scope' => 'header',
        'weight' => 10,
      ),
      "$module_path/misc/2gis_admin.js" => array(
        'type' => 'file',
        'scope' => 'header',
        'weight' => 11,
      )
    ),
    'css' => array(
      "$module_path/misc/2gis_admin.css" => array(
        'type' => 'file',
        'media' => 'screen',
      ),
    )
  );
  return $libraries;
}

/**
 * Preprocess for html_tag.
 */
function dgis_maps_preprocess_html_tag(&$vars) {
  // Add attribute for tag "script"
  if ($vars['element']['#tag'] == 'script') {
    if (!empty($vars['element']['#attributes']['src'])
      && $vars['element']['#attributes']['src'] == 'http://maps.api.2gis.ru/2.0/loader.js?pkg=full') {
      $vars['element']['#attributes']['data-id'] = 'dgLoader';
    }
  }
}

/**
 * Returns map data.
 */
function dgis_maps_get_map_data($delta) {
  $settings = variable_get($delta . '_settings', dgis_maps_get_default_map_data());

  return $settings;
}

/**
 * Returns map data.
 */
function dgis_maps_get_default_map_data() {
  // Encode default values as JSON to have it in the same format as real values.
  return json_encode(
    array(
      'center' => '54.98,82.89',
      'zoom' => '10',
      'markers' => '',
    )
  );
}