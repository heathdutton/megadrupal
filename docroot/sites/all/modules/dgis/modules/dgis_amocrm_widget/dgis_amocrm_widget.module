<?php
/**
 * @file
 * Module AmoCRM widget 2gis.
 */

require_once 'dgis_amocrm_widget.functions.inc';
require_once 'dgis_amocrm_widget.pages.inc';

define('DGIS_AMOCRM_WODGET_MODULE_PATH', drupal_get_path('module', 'dgis_amocrm_widget'));

/**
 * Implements hook_menu().
 */
function dgis_amocrm_widget_menu() {
  $items['2gis-api/amocrm-widget'] = array(
    'title' => 'AmoCRM widget 2gis',
    'page callback' => 'dgis_amocrm_widget_callback',
    'access callback' => TRUE,
  );
  $items['2gis-api/amocrm-widget/%/%'] = array(
    'title' => 'AmoCRM widget 2gis: company view',
    'page callback' => 'dgis_amocrm_widget_company_callback',
    'page arguments' => array(2,3),
    'access callback' => TRUE,
  );
  $items['2gis-api/amocrm-widget/connect/%/%'] = array(
    'title' => 'AmoCRM widget 2gis: company connect',
    'page callback' => 'dgis_amocrm_widget_company_connect',
    'page arguments' => array(3,4),
    'access callback' => TRUE,
  );
  $items['2gis-api/amocrm-widget/remove'] = array(
    'title' => 'AmoCRM widget remove 2gis',
    'page callback' => 'dgis_amocrm_widget_remove_callback',
    'access callback' => TRUE,
  );
  $items['2gis-api/amocrm-widget/connected-entity'] = array(
    'title' => 'AmoCRM widget remove 2gis',
    'page callback' => 'dgis_amocrm_widget_connected_entity_callback',
    'access callback' => TRUE,
  );
  $items['2gis-api/amocrm-widget/synchronise'] = array(
    'title' => 'AmoCRM widget remove 2gis',
    'page callback' => 'dgis_amocrm_widget_synchronise_callback',
    'access callback' => TRUE,
  );
  $items['2gis-api/amocrm-widget/city-change'] = array(
    'title' => 'AmoCRM widget change city',
    'page callback' => 'dgis_amocrm_widget_change_city_callback',
    'access callback' => TRUE,
  );
  $items['2gis-api/amocrm-widget/city-change/%'] = array(
    'title' => 'AmoCRM widget change city',
    'page callback' => 'dgis_amocrm_widget_set_city_callback',
    'page arguments' => array(3),
    'access callback' => TRUE,
  );

  return $items;
}

/**
 * Implements hook_init().
 */
function dgis_amocrm_widget_init() {
  if (!variable_get('dgis_amocrm_widget_linking_field_id', FALSE) && user_access('administer modules')) {
    drupal_set_message(
      t('Module "AmoCRM widget 2gis" requires to be installed when module "amoCRM widget" is well configured with
        API key. Please make sure that configuration is done and re-install module "AmoCRM widget 2gis"'),
      'error'
    );
  }

  // Get the widget preloader.
  $preloader = theme('amocrm_widget_preload');
  $output = theme('amocrm_widget_page', array('content' => $preloader));
  drupal_add_js(array('DgisAmoCRM' => array('preloader_page' => $output)), 'setting');

  drupal_add_js(drupal_get_path('module', 'dgis_amocrm_widget') . '/includes/dgis_amocrm_widget.js');
}

/**
 * Implements hook_theme().
 */
function dgis_amocrm_widget_theme($existing, $type, $theme, $path) {
  $base = array(
    'path' => $path . '/theme',
    'file' => 'theme.inc',
  );

  $items['dgis_amocrm_widget_company_teaser'] = $base + array(
      'template' => 'dgis-amocrm-widget-company-teaser',
      'variables' => array('data' => NULL),
    );
  $items['dgis_amocrm_widget_company_full'] = $base + array(
      'template' => 'dgis-amocrm-widget-company-full',
      'variables' => array('data' => NULL),
    );
  $items['dgis_amocrm_widget_company_teaser_wrapper'] = $base + array(
      'template' => 'dgis-amocrm-widget-company-teaser-wrapper',
      'variables' => array('data' => NULL),
    );
  $items['dgis_amocrm_widget_city_change_wrapper'] = $base + array(
      'template' => 'dgis-amocrm-widget-city-change-wrapper',
      'variables' => array('cities' => array()),
    );
  $items['dgis_amocrm_widget_wrapper'] = $base + array(
      'template' => 'dgis-amocrm-widget-wrapper',
      'variables' => array('content' => ''),
    );

  return $items;
}

/**
 * Implements hook_amocrm_widget_info().
 */
function dgis_amocrm_widget_amocrm_widget_info() {
  $content = l(
    t('Connect with 2gis'),
    'amocrm_widget/embed',
    array(
      'attributes' => array('id' => 'drupal-2gis-link', 'class' => array('drupal-2gis-link')),
      'query' => array('url' => '2gis-api/amocrm-widget')
    )
  );
  if ($dgis_company = dgis_amocrm_widget_get_cached_data()) {
    $content = l(
      t('Connected with 2gis'),
      'amocrm_widget/embed',
      array(
        'attributes' => array('id' => 'drupal-2gis-link', 'class' => array('drupal-2gis-link')),
        'query' => array('url' => '2gis-api/amocrm-widget/connected-entity')
      )
    );
    $content .= l(
      t('Remove connection'),
      'amocrm_widget/embed',
      array(
        'attributes' => array('id' => 'drupal-2gis-remove-link', 'class' => array('drupal-2gis-link')),
        'query' => array('url' => '2gis-api/amocrm-widget/remove')
      )
    );
  }

  return array(
    array(
      'title' => t('2gis widget'),
      'description' => '',
      'settings_form_path' => '',
      'links' => array(
        array(
          'content' => $content,
          'group' => '2GIS',
          'ammocrm_page' => AMOCRM_TYPE_CONTACT,
        ),
      ),
    ),
    array(
      'title' => t('2gis widget'),
      'description' => '',
      'settings_form_path' => '',
      'links' => array(
        array(
          'content' => $content,
          'group' => '2GIS',
          'ammocrm_page' => AMOCRM_TYPE_COMPANY,
        ),
      ),
    ),
  );
}
