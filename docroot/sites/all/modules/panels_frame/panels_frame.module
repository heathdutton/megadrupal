<?php

/**
 * @fixme Oh crap, do we have a memory spike in rendering complex layouts?
 */

 /**
  * Implements hook_ctools_plugin_directory().
  */
 function panels_frame_ctools_plugin_directory($module, $plugin) {
   if (($module == 'panels' && $plugin == 'layouts') || $module == 'ctools' && $plugin == 'export_ui') {
     return "plugins/$plugin";
   }
 }


/**
 * Implements hook_panels_dashboard_blocks().
 */
function panels_frame_panels_dashboard_blocks(&$vars) {
  ctools_include('export');

  $vars['links']['panels_frame'] = array(
    'title' => l('Panels Frame', 'admin/structure/panels/frame'),
    'description' => t('Create new layouts from combining multiple layouts together!'),
  );

  $count = 0;
  $rows = array();

  foreach (ctools_export_crud_load_all('panels_frame') as $item) {
    $rows[] = array(
      check_plain($item->label),
      array(
        'data' => l(t('Edit'), "admin/structure/panels/frames/$item->plugin/list/$item->name/edit"),
        'class' => 'links',
      ),
    );

    // Only show 10.
    if (++$count >= 10) {
      break;
    }
  }

  if ($rows) {
    $content = theme('table', array('rows' => $rows, 'attributes' => array('class' => 'panels-manage')));
  }
  else {
    $content = '<p>' . t('There are no panels frames :(') . '</p>';
  }

  $vars['blocks']['panels_frame'] = array(
    'title' => t('Panels Frame'),
    'link' => l(t('Go to list'), 'admin/structure/panels/frame'),
    'content' => $content,
    'class' => 'dashboard-panels-frame',
    'section' => 'right',
  );
}

/**
 * Implements hook_menu().
 */
function panels_frame_menu() {
  $items['admin/structure/panels/frame'] = array(
    'title' => 'Frame',
    'description' => 'General system related configuration.',
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('administer panels frame'),
    'file path' => drupal_get_path('module', 'system'),
    'file' => 'system.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_permission()
 */
function panels_frame_permission() {
  return array(
    'administer panels frame' => array(
      'title' => t("Use the Panels Frame UI"),
      'description' => t("Allows a user to build new layouts using the Panels Frame UI."),
    ),
  );
}

/**
 * Implements hook_element_info().
 */
function panels_frame_element_info() {
  return array(
    'panels_frame_layout' => array(
      '#input' => TRUE,
      '#process' => array('panels_frame_element_layout_process'),
      '#theme_wrappers' => array('container', 'form_element'),
      '#allowed_layouts' => 'panels_frame',
      '#tab_options' => array(),
      '#no_builders' => FALSE,
      '#no_frames' => FALSE,
    ),
  );
}

/**
 * Implements hook_js_alter().
 *
 * @todo remove this when https://www.drupal.org/node/2496207 is resolved.
 * We're only /slightly/ modifying the sorting of panels-base.js until the
 * Drupal.Panels object is properly initialized and weight order is irrelevant.
 */
function panels_frame_js_alter(&$javascripts) {
  $file = drupal_get_path('module', 'panels') . '/js/panels-base.js';
  $javascripts[$file]['weight'] -= 0.001;
}

/**
 * Machine-name exists callback for frame identifiers.
 */
function panels_frame_frame_identifier_exists($value, &$element, &$form_state) {
  return in_array($value, array_keys($form_state['item']->data));
}

/**
 * Array filter callback to remove layouts generated by Panels Frame.
 */
function _panels_frame_frame_filter($layout) {
  return !isset($layout['panels_frame']);
}

/**
 * Element process callback for "panels_frame_layout".
 * @see panels_frame_element_info().
 */
function panels_frame_element_layout_process($element, &$form_state, $form) {
  ctools_include('common', 'panels');
  ctools_include('plugins', 'panels');
  ctools_include('cleanstring');

  $element['#attributes']['class'][] = 'panels-frame-choose-layout';
  // Panels has somewhat of an access control system in the available layouts
  // per application, in order to respect this, we declare the "module name" in
  // which we should receive layouts for. This, of course, can be customized by
  // the #allowed_layouts property.
  $layouts = panels_common_get_allowed_layouts($element['#allowed_layouts']);

  // Remove builder layouts if they are not applicable.
  if (!empty($element['#no_builders'])) {
    $layouts = array_filter($layouts, '_panels_builder_filter');
  }

  // Remove Panels Frames generated layouts if they are not applicable.
  if (!empty($element['#no_frames'])) {
    $layouts = array_filter($layouts, '_panels_frame_frame_filter');
  }

  $groups = array();

  // A bit of meta-organization to group layouts together by their category.
  foreach ($layouts as $lid => $layout) {
    $key = ctools_cleanstring($layout['category']);
    $groups[$key]['category'] = $layout['category'];
    $groups[$key]['layouts'][] = $lid;
  }

  // Derive the "active tab" based on the default layout.
  if ($element['#value'] && isset($layouts[$element['#value']]) && empty($element['#tab_options']['selected'])) {
    $category_key = ctools_cleanstring($layouts[$element['#value']]['category']);
    $element['#tab_options']['selected'] = array_search($category_key, array_keys($groups));
  }

  // Prepare the tab labels for each of the layout categories.
  $element['header'] = array(
    '#theme' => 'item_list',
    '#items' => array(),
  );

  // Each layout category will render as a jQuery UI tab pane.
  foreach ($groups as $name => $group) {
    $key = drupal_html_id($name);
    $element['header']['#items'][] = '<a href="#layout-category-' . $key . '">' . $group['category'] . '</a>';
    $element['content'][$name] = array(
      '#type' => 'container',
      '#attributes' => array('id' => 'layout-category-' . $key, 'class' => array('layouts-pane')),
    );

    // Each layout in a category will be represented as a radio form element.
    // Most of the logic here was borrowed from form_process_radios().
    foreach ($group['layouts'] as $lid) {
      $parents_for_id = array_merge($element['#parents'], array($lid));
      $element['content'][$name][$lid] = array(
        '#default_value' => isset($element['#default_value']) ? $element['#default_value'] : NULL,
        '#title' => panels_print_layout_icon($lid, $layouts[$lid], $layouts[$lid]['title']),
        '#id' => drupal_html_id('edit-' . implode('-', $parents_for_id)),
        '#ajax' => isset($element['#ajax']) ? $element['#ajax'] : NULL,
        '#attributes' => $element['#attributes'],
        '#parents' => $element['#parents'],
        '#return_value' => $lid,
        '#type' => 'radio',
      );
    }
  }

  // Attach all the necessary assets. Not that #tab_options allows the user to
  // control the options that are passed to the jQuery Tab library and therefore
  // manipulate how it behaves.
  $element['#attached'] = array(
    'library' => array(
      array('system', 'ui.tabs'),
      // array('system', 'ui.button'),
    ),
    'css' => array(ctools_add_css('panels-frame.choose-layout', 'panels_frame')),
    'js' => array(
      ctools_add_js('panels-frame.choose-layout', 'panels_frame'),
      array('type' => 'setting','data' => array(
        'panelsFrame' => array(
          'chooseLayout' => array(
            'tabs' => array(
              $element['#id'] => $element['#tab_options'],
            ),
          ),
        ),
      )),
    ),
  );

  return $element;
}

/**
 * Provide a consistent cache identifier.
 */
function panels_frame_cache_key($name) {
  return 'edit-' . $name;
}

/**
 * Set object cache.
 */
function panels_frame_cache_set($type, $identifier, $cache) {
  ctools_include('object-cache');
  return ctools_object_cache_set('panels_frame:' . $type, $identifier, $cache);
}

/**
 * Get object cache.
 */
function panels_frame_cache_get($type, $identifier) {
  ctools_include('object-cache');
  return ctools_object_cache_get('panels_frame:' . $type, $identifier);
}

/**
 * Clear object cache.
 */
function panels_frame_cache_clear($type, $identifier) {
  ctools_include('object-cache');
  return ctools_object_cache_clear('panels_frame:' . $type, $identifier);
}
