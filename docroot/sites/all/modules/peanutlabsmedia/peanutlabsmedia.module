<?php
/**
 * @file
 * Author: Anil Sagar, Gaurav Kumar
 * To earn userpoints by taking surveys using peanutlabsmedia
 *
 */

/**
 * Implements hook_permission().
 */
function peanutlabsmedia_permission() {
  return array(
      'administer peanutlabsmedia',
  );
}

/**
 * Implements hook_menu().
 */
function peanutlabsmedia_menu() {
  $items = array();
  $items['admin/config/peanutlabsmedia'] = array(
      'title' => 'Peanutlabs Media',
      'page callback' => 'drupal_get_form',
      'page arguments' => array('peanutlabsmedia_settings'),
      'access callback' => 'user_access',
      'access arguments' => array('Administer Peanutlabsmedia'),
      'type' => MENU_LOCAL_TASK,
      'weight' => 10,
      'file' => 'peanutlabsmedia.admin.inc',
  );
  $items['peanutlab-media/take-survey'] = array(
      'page callback' => '_peanutlab_take_survey',
      'type' => MENU_CALLBACK,
      'title' => 'Take a survey',
      'access arguments' => array('access content')
  );
  $items['peanutlab/process'] = array(
      'page callback' => '_peanutlab_process_survey',
      'type' => MENU_CALLBACK,
      'title' => 'Process survey',
      'access arguments' => array('access content')
  );
  return $items;
}

/**
 * Include all peanutlabmedia include files.
 */
function _peanutlabsmedia_include() {
  // Load peanutlabsmedia.admin.inc from the peanutlabsmedia module.
  module_load_include('inc', 'peanutlabsmedia', 'peanutlabsmedia.admin');
}

function _peanutlab_take_survey() {
  global $user;
  if ($user->uid != 0) {
    $uid = $user->uid;
    $iframe = "<iframe src='http://peanutlabs.com/userGreeting.php?userId=" . variable_get('peanutlabsmedia_userid', FALSE) . "&var_key_1=uid&var_val_1=" . $uid . "' width='" . variable_get('peanutlabsmedia_frame_width', FALSE) . "px' height='" . variable_get('peanutlabsmedia_frame_height', FALSE) . "px'> </iframe>";
    return $iframe;
  }
  elseif ($user->uid == 0) {
    return '<p>' . t('You are not authorized to take a survey. Please <a href="@user-login">login</a> or <a href="@user-register">Register</a>.', array('@user-login' => url('user/login', array('query' => array('destination' => $_GET['q']))), '@user-register' => url('user/register'))) . '</p>';
  }
}

function _peanutlab_process_survey() {
  $cmd = $_GET['cmd'];
  $plab_uid = $_GET['userId'];
  $my_amt = $_GET['amt'];
  $offer_id = $_GET['offerInvitationId'];
  $status = $_GET['status'];
  $oid_hash = $_GET['oidHash'];
  $miles = $_GET['currencyAmt'];
  $trans_id = $_GET['transactionId'];
  $uid = $_GET['uid'];
  $app_key = variable_get('peanutlabsmedia_appkey', FALSE);
  $oid_ver = md5($offer_id . $app_key);
  if ($oid_hash === $oid_ver && $cmd == "transactionComplete" && $status == "C") {
    $params = array(
        'uid' => $uid,
        'points' => $miles,
        'description' => t('You earned @user-points user points by completing a survey with offerId @offerid', array('@user-points' => $miles, '@offerid' => $offer_id)),
        'display' => FALSE
    );
    userpoints_userpointsapi($params);
    print '1';
  }
  else {
    print '0';
  }
}