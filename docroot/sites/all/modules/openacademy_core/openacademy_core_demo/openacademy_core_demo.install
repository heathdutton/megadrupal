<?php
/**
 * @file
 * openacademy_core_demo.install
 */

/**
 * Implementation of hook_enable()
 */
function openacademy_core_demo_enable() {
  // Ensure that migration classes are registered.
  migrate_get_module_apis(TRUE);

  // Import the content
  $migration = Migration::getInstance('OpenacademyCoreDemoTerm');
  $migration->processImport();

  // Remove messages set by migrate module.
  drupal_get_messages('completed');

  // Create general directory
  $directory = file_default_scheme() . '://general';
  file_prepare_directory($directory, FILE_MODIFY_PERMISSIONS);
  file_prepare_directory($directory, FILE_CREATE_DIRECTORY);

  // Add default frontpage spotlight
  $frontpage_files = array(
    'a5fd8592-e336-5344-cd61-5f5b3c6a490c' => array('file' => 'slide-systemseed-logo.jpg'),
    'f313ead4-579c-b524-1d7d-ae4a7d7b7784' => array('file' => 'slide-openacademy-logo.jpg'),
    'f9c879ff-06b3-8d44-85a0-da2e714489bb' => array('file' => 'slide-panopoly-logo.jpg'),
  );
  openacademy_core_demo_load_files($frontpage_files);

  // Since there is no Migrate support for the Panopoly Widgets yet.
  // @see https://drupal.org/node/2110919, we import these manually.
  // This code was generated by creating the panes in the CMS, and then inspecting
  // at /deve/php with something like the following:
  // 
  // $entity = entity_load('fieldable_panels_pane', array(2));
  // dsm(var_export($entity['2']));
  
  $frontpage_spotlight_entity = (object) array(
    'vid' => '21',
    'timestamp' => '1332022303',
    'uid' => '1',
    'title' => '',
    'log' => '',
    'vuuid' => '2a8e31b9-bacd-7164-611b-52da82439620',
    'fpid' => '17',
    'bundle' => 'spotlight',
    'link' => '0',
    'path' => '',
    'reusable' => '0',
    'admin_title' => '',
    'admin_description' => '',
    'category' => 'Reusable Content',
    'view_access' => NULL,
    'edit_access' => NULL,
    'created' => '1328587894',
    'changed' => '1381685622',
    'uuid' => '3cf85237-de5c-35b4-095e-64447e9ff6bf',
    'language' => '',
    'current_vid' => '21',
    'field_basic_spotlight_items' => 
    array (
      'und' => 
      array (
        0 => 
        array (
          'title' => 'Open Academy',
          'description' => 'Open Academy is a Drupal distribution that aims to provide the best in web publishing for the  education sector on a customizable, open source platform.',
          'fid' => '145',
          'link' => 'http://www.systemseed.com/openacademy',
          'uid' => '1',
          'filename' => 'slide-openacademy-logo.jpg',
          'uri' => 'public://general/slide-openacademy-logo.jpg',
          'filemime' => 'image/jpeg',
          'filesize' => '27403',
          'status' => '1',
          'timestamp' => '1381685286',
          'type' => 'image',
          'uuid' => 'f313ead4-579c-b524-1d7d-ae4a7d7b7784',
          'field_file_image_alt_text' => 
          array (
          ),
          'field_file_image_title_text' => 
          array (
          ),
          'metadata' => 
          array (
            'height' => 500,
            'width' => 800,
          ),
        ),
        1 => 
        array (
          'title' => 'Powered by Panopoly',
          'description' => 'Powered by the Panopoly Drupal product framework and packaged with useful Apps for news, courses, events, people and publications.',
          'fid' => '146',
          'link' => 'https://drupal.org/project/panopoly',
          'uid' => '1',
          'filename' => 'slide-openacademy-logo.jpg',
          'uri' => 'public://general/slide-panopoly-logo.jpg',
          'filemime' => 'image/jpeg',
          'filesize' => '27403',
          'status' => '1',
          'timestamp' => '1381685286',
          'type' => 'image',
          'uuid' => 'f9c879ff-06b3-8d44-85a0-da2e714489bb',
          'field_file_image_alt_text' => 
          array (
          ),
          'field_file_image_title_text' => 
          array (
          ),
          'metadata' => 
          array (
            'height' => 500,
            'width' => 800,
          ),
        ),
        2 => 
        array (
          'title' => 'Backed by SystemSeed',
          'description' => 'Open Academy is developed and maintained by SystemSeed. Open Academy was originally started by Chapter Three.',
          'fid' => '144',
          'link' => 'http://www.systemseed.com',
          'uid' => '1',
          'filename' => 'slide-openacademy-logo.jpg',
          'uri' => 'public://general/slide-openacademy-logo_0.jpg',
          'filemime' => 'image/jpeg',
          'filesize' => '27403',
          'status' => '1',
          'timestamp' => '1381685286',
          'type' => 'image',
          'uuid' => 'a5fd8592-e336-5344-cd61-5f5b3c6a490c',
          'field_file_image_alt_text' => 
          array (
          ),
          'field_file_image_title_text' => 
          array (
          ),
          'metadata' => 
          array (
            'height' => 500,
            'width' => 800,
          ),
        ),
      ),
    ),
  );
  foreach($frontpage_spotlight_entity->field_basic_spotlight_items['und'] as $key => $value) {
    $frontpage_spotlight_entity->field_basic_spotlight_items['und'][$key]['fid'] = $frontpage_files[$frontpage_spotlight_entity->field_basic_spotlight_items['und'][$key]['uuid']]['fid'];
  }
  entity_uuid_save('fieldable_panels_pane', $frontpage_spotlight_entity);

  // Add default frontpage about
  $frontpage_about_entity = (object) array(
  'vid' => '2',
  'timestamp' => '1332019920',
  'uid' => '1',
  'title' => 'About Open Academy',
  'log' => '',
  'vuuid' => '792d2165-71fa-5714-194e-2bc201628360',
  'fpid' => '2',
  'bundle' => 'text',
  'link' => '0',
  'path' => '',
  'reusable' => '0',
  'admin_title' => '',
  'admin_description' => '',
  'category' => 'Reusable Content',
  'view_access' => NULL,
  'edit_access' => NULL,
  'created' => '1329015707',
  'changed' => '1381686528',
  'uuid' => 'e663c0b4-8de1-1e54-2133-3de6a740bb8c',
  'language' => '',
  'current_vid' => '2',
  'field_basic_text_text' => 
    array (
      'und' => 
      array (
        0 => 
        array (
          'value' => '<p>Open Academy is a Drupal distribution that aims to provide the best in web publishing for the education sector on a customizable, open source platform.</p><p>Powered by the <a href="http://drupal.org/project/panopoly">Panopoly Drupal product framework</a> and packaged with useful&nbsp;<a href="http://drupal.org/project/apps">Apps</a>&nbsp;for news, courses, events, people and publications, Open Academy makes it easy for universities to create and customize their websites.&nbsp;</p><p>Open Academy is developed and maintained by <a href="http://www.systemseed.com">SystemSeed</a>.</p>',
          'format' => 'panopoly_wysiwyg_text',
          'safe_value' => '<p>Open Academy is a Drupal distribution that aims to provide the best in web publishing for the education sector on a customizable, open source platform.</p>
  <p>Powered by the <a href="http://drupal.org/project/panopoly">Panopoly Drupal product framework</a> and packaged with useful <a href="http://drupal.org/project/apps">Apps</a> for news, courses, events, people and publications, Open Academy makes it easy for universities to create and customize their websites. </p>
  <p>Open Academy is developed and maintained by <a href="http://www.systemseed.com">SystemSeed</a>.</p>
  ',
        ),
      ),
    ),
  );
  entity_uuid_save('fieldable_panels_pane', $frontpage_about_entity);
}

/**
 * Implements hook_disable().
 */
function openacademy_core_demo_disable() {
  // Remove the imported content.
  $migration = Migration::getInstance('OpenacademyCoreDemoTerm');
  $migration->processRollback();
  
  // Remove messages set by migrate module.
  drupal_get_messages('completed');

  // Delete preinstalled entities
  ctools_include('uuid.entity', 'uuid', '');
  $fpid = db_query('SELECT fpid FROM {fieldable_panels_panes} WHERE uuid = :uuid', array(':uuid' => '3cf85237-de5c-35b4-095e-64447e9ff6bf'))->fetchField();
  fieldable_panels_panes_delete($fpid);
  $fpid = db_query('SELECT fpid FROM {fieldable_panels_panes} WHERE uuid = :uuid', array(':uuid' => 'e663c0b4-8de1-1e54-2133-3de6a740bb8c'))->fetchField();
  fieldable_panels_panes_delete($fpid);
}

/**
 * Helper function to download images and add them to the files directory
 */
function openacademy_core_demo_load_files(&$files, $subdir = 'general') {
  foreach($files as $uuid => $file_info) {
    $filepath = drupal_get_path('module', 'openacademy_core_demo') . '/import/images/' . $file_info['file'];
    $file_data = file_get_contents($filepath);
    $file = file_save_data($file_data, variable_get('file_default_scheme', 'public') . '://' . $subdir . '/' . $file_info['file']);
    $file->status = FILE_STATUS_PERMANENT;
    $file->uuid = $uuid;
    $file = file_save($file);       
    $files[$uuid]['fid'] = $file->fid;
  }
}
