<?php
/**
 * @file
 * Code for the Open Academy Core feature.
 */

include_once('openacademy_core.features.inc');

/**
 * Implementation of hook_apps_app_info()
 */
function openacademy_core_apps_app_info() {
  return array(
    'demo content module' => 'openacademy_core_demo',
    'configure form' => 'openacademy_core_configure_form',
  );
}

/** 
 * Open Academy Core App Configuration Form
 *
 * This form will be blank until we have specific settings to customize beyond
 * the demo content that the apps.module puts here for us. 
 */
function openacademy_core_configure_form($form, &$form_state) {
  $form = array();

   return $form;
}

/**
 * Implements hook_migrate_api().
 */
function openacademy_core_migrate_api() {
  return array('api' => 2);
}

/**
 * Implementation of hook_preprocess_page()
 */
function openacademy_core_preprocess_page(&$vars, $hook) {
  // Add the footer menu to the page template variables
  $vars['footer_menu'] = menu_navigation_links('menu-footer-menu');
}


// TODO: Move this to a new openacademy_admin module:

/**
 * Implements hook_core_module_implements_alter().
 */
function openacademy_core_module_implements_alter(&$implementations, $hook) {
  if ($hook == 'menu_alter' || $hook == 'menu_link_alter') {
    // Move openacademy_core_module_implements_alter() to the end of the list.
    // We do this to ensure that our implementations of hook_menu_alter and
    // hook_menu_link_alter run after those of panopoly_admin.
    $group = $implementations['openacademy_core'];
    unset($implementations['openacademy_core']);
    $implementations['openacademy_core'] = $group;
  }
}

/**
 * Implements hook_menu_alter().
 */
function openacademy_core_menu_alter(&$items) {
  // Move Panopoly menu items under configuration
  $paths = array_keys($items);
  $panopoly_paths = preg_grep('/^admin\/panopoly/', $paths);
  foreach ($panopoly_paths as $key) {
    $config_path = preg_replace('/(^admin)/', 'admin/config', $key);
    $items[$config_path] = $items[$key];
    unset($items[$key]);
  }
}

/**
 * Implementation of hook_menu_link_alter()
 */
function openacademy_core_menu_link_alter(&$item) {
  // Automatically set all of the settings elements to be children of the main parent element
  // @see panopoly_admin_menu_link_alter().
  if (isset($item['path']) && strpos($item['path'], 'panopoly/settings/')) {
    $parent_mlid = db_query("SELECT mlid FROM {menu_links} WHERE link_path = :path", array(':path' => 'admin/config/panopoly/settings'))->fetchField();
    $item['plid'] = $parent_mlid;
  }
}
