<?php
/**
 * @file
 * Funky date module.
 */

/**
 * Implements hook_theme().
 */
function funky_date_theme() {
  return array(
    'funky_date' => array(
      'variables' => array(
        'item' => NULL,
        'fromto' => 'both',
        'date1' => NULL,
        'date2' => NULL,
        'format1' => NULL,
        'format2' => NULL,
        'separator' => NULL,
        'hide_same_values' => array(),
        'attributes' => array(),
      ),
    ),
    'funky_date_all' => array(
      'variables' => array(
        'items' => NULL,
        'fromto' => 'both',
        'dates' => NULL,
        'format1' => NULL,
        'format2' => NULL,
        'separator' => NULL,
        'separator_multi' => NULL,
        'hide_same_values' => array(),
        'attributes' => array(),
      ),
    ),
  );
}

/**
 * Implements hook_field_formatter_info().
 */
function funky_date_field_formatter_info() {
  return array(
    'funky_date_formatter' => array(
      'label' => t('Funky date'),
      'field types' => array('date', 'datestamp', 'datetime'),
      'settings' => array(
        'fromto' => 'both',
        'format1' => '',
        'format2' => '',
        'separator' => ' - ',
        'separator_multi' => ', ',
        'hide_same_values' => array(),
      ),
    ),
  );
}

/**
 * Implements hook_field_formatter_settings_form().
 */
function funky_date_field_formatter_settings_form($field, $instance, $view_mode, $form, &$form_state) {
  $display = $instance['display'][$view_mode];
  $function = "funky_date_field_formatter_settings_{$display['type']}_form";
  $settings = $display['settings'];
  return $function($field, $instance, $settings);
}

/**
 * Helper function.
 *
 * @see funky_date_field_formatter_settings_form()
 */
function funky_date_field_formatter_settings_funky_date_formatter_form($field, $instance, $settings) {
  $form = array();

  $form['fromto'] = array(
    '#title' => t('Display:'),
    '#type' => 'select',
    '#options' => array(
      'both' => t('Both Start and End dates'),
      'value' => t('Start date only'),
      'value2' => t('End date only'),
      'all' => t('Show all dates as one (uses only start date)'),
    ),
    '#access' => $field['settings']['todate'],
    '#default_value' => $settings['fromto'],
  );

  $form['format1'] = array(
    '#title' => t('Choose how users view dates and times of first value:'),
    '#type' => 'select',
    '#options' => date_format_type_options(),
    '#default_value' => $settings['format1'],
    '#description' => t('To add or edit options, visit <a href="@date-time-page">Date and time settings</a>.', array('@date-time-page' => url('admin/config/regional/date-time'))),
  );

  $form['format2'] = array(
    '#title' => t('Choose how users view dates and times of second value:'),
    '#type' => 'select',
    '#options' => date_format_type_options(),
    '#default_value' => $settings['format2'],
    '#description' => t('To add or edit options, visit <a href="@date-time-page">Date and time settings</a>.', array('@date-time-page' => url('admin/config/regional/date-time'))),
  );

  $form['separator'] = array(
    '#title' => t('Enter the separator to add in between both values:'),
    '#type' => 'textfield',
    '#default_value' => $settings['separator'],
    '#description' => t('Make sure to add spaces on the left and right side.'),
  );

  $form['separator_multi'] = array(
    '#title' => t('Enter the separator to add in between multiple values:'),
    '#type' => 'textfield',
    '#default_value' => $settings['separator_multi'],
    '#description' => t('Separator to use for multiple values when displaying all dates as one.'),
  );

  $options = date_granularity_names();
  $form['hide_same_values'] = array(
    '#title' => t('Hide parts if they are the same:'),
    '#type' => 'checkboxes',
    '#options' => $options,
    '#default_value' => $settings['hide_same_values'],
    '#description' => t('Hide parts is they are the same for both values.'),
  );

  return $form;
}

/**
 * Implements hook_field_formatter_settings_summary().
 */
function funky_date_field_formatter_settings_summary($field, $instance, $view_mode) {
  $display = $instance['display'][$view_mode];
  $function = "funky_date_field_formatter_settings_{$display['type']}_summary";
  $settings = $display['settings'];
  return $function($field, $instance, $settings);
}

/**
 * Helper function.
 *
 * @see funky_date_field_formatter_settings_form()
 */
function funky_date_field_formatter_settings_funky_date_formatter_summary($field, $instance, $settings) {
  $date_format_type_options = date_format_type_options();
  $summary = array();

  if (isset($settings['format1'])) {
    $summary[] = t('Display as @format1 @separator @format2', array(
      '@format1' => $date_format_type_options[$settings['format1']],
      '@separator' => t($settings['separator'], array(), array('context' => 'funky_date')),
      '@format2' => $date_format_type_options[$settings['format2']],
    ));
  }
  else {
    $summary[] = t('Please configure the display options.');
  }

  return implode('<br />', $summary);
}

/**
 * Implements hook_field_formatter_view().
 */
function funky_date_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  $function = "funky_date_field_formatter_{$display['type']}_view";
  return $function($entity_type, $entity, $field, $instance, $langcode, $items, $display);
}

/**
 * Helper function.
 *
 * @see funky_date_field_formatter_view()
 */
function funky_date_field_formatter_funky_date_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  $elements = array();
  $settings = $display['settings'];
  $formatter = $display['type'];

  // Make sure we have at least 2 dates.
  if ($settings['fromto'] === 'all' && count($items) >= 2) {
    $dates = array();
    foreach ($items as $delta => $item) {
      $dates[] = _funky_date_date_formatter_process($formatter, $entity_type, $entity, $field, $instance, $langcode, $item, $display);
    }

    $elements[] = array(
      '#theme' => 'funky_date_all',
      '#items' => $items,
      '#fromto' => $settings['fromto'],
      '#dates' => $dates,
      '#format1' => $settings['format1'],
      '#format2' => $settings['format2'],
      '#separator' => $settings['separator'],
      '#separator_multi' => $settings['separator_multi'],
      '#hide_same_values' => $settings['hide_same_values'],
      '#attributes' => array(),
    );
  }
  else {
    // All with 1 date is outputting start only.
    if ($variables['fromto'] === 'all') {
      $variables['fromto'] = 'value';
    }

    foreach ($items as $delta => $item) {
      $dates = _funky_date_date_formatter_process($formatter, $entity_type, $entity, $field, $instance, $langcode, $item, $display);

      $elements[$delta] = array(
        '#theme' => 'funky_date',
        '#item' => $item,
        '#fromto' => $settings['fromto'],
        '#date1' => $dates['value'],
        '#date2' => $dates['value2'],
        '#format1' => $settings['format1'],
        '#format2' => $settings['format2'],
        '#separator' => $settings['separator'],
        '#hide_same_values' => $settings['hide_same_values'],
        '#attributes' => array(),
      );
    }
  }

  return $elements;
}

/**
 * Theme funky date.
 */
function theme_funky_date($variables) {
  $output = array();

  $hide_same_values = array_filter($variables['hide_same_values']);

  $limit_parts = array();
  if (!empty($hide_same_values)) {
    $date1_parts = getdate(strtotime($variables['date1']['db']['datetime']));
    $date2_parts = getdate(strtotime($variables['date2']['db']['datetime']));
    foreach ($hide_same_values as $part) {
      if ($date1_parts[$part] == $date2_parts[$part]) {
        $limit_parts[] = $part;
      }
      else {
        break;
      }
    }
  }

  $date1 = $variables['date1']['db']['object'];
  $date2 = $variables['date2']['db']['object'];

  if ($variables['fromto'] != 'both' || $date1 == $date2 || empty($limit_parts)) {
    switch ($variables['fromto']) {
      case 'both':
        return t('@date1@separator@date2', array(
          '@date1' => $variables['date1']['formatted'],
          '@separator' => t($variables['separator'], array(), array('context' => 'funky_date')),
          '@date2' => $variables['date2']['formatted'],
        ));

      case 'value':
        return $variables['date1']['formatted'];

      case 'value2':
        return $variables['date2']['formatted'];
    }
  }

  $format_type = $variables['format1'];
  $format = variable_get('date_format_' . $format_type, '');

  return t('@date1@separator@date2', array(
    '@date1' => date_format_date($date1, 'custom', date_limit_format($format, date_nongranularity($limit_parts))),
    '@separator' => t($variables['separator'], array(), array('context' => 'funky_date')),
    '@date2' => $variables['date2']['formatted'],
  ));
}

/**
 * Theme funky date all.
 */
function theme_funky_date_all($variables) {
  $output = array();
  $dates_parts = array();
  $dates_objects = array();

  // Process all dates, remember last date.
  foreach ($variables['dates'] as $date) {
    $dates_parts[] = getdate(strtotime($date['value']['db']['datetime']));
    $dates_objects[] = $date['value']['db']['object'];
    $last_date_formatted = $date['value']['formatted'];
  }
  $first_date_parts = array_shift($dates_parts);
  $hide_same_values = array_filter($variables['hide_same_values']);

  // Hide parts if it is the same for all dates.
  $limit_parts = array();
  if (!empty($hide_same_values)) {
    foreach ($hide_same_values as $part) {
      $all_equal = TRUE;
      foreach ($dates_parts as $date) {
        if ($first_date_parts[$part] != $date[$part]) {
          $all_equal = FALSE;
          break;
        }
      }
      if ($all_equal) {
        $limit_parts[] = $part;
      }
      else {
        break;
      }
    }
  }

  $format_type = $variables['format1'];
  $format = variable_get('date_format_' . $format_type, '');

  // Remove last date, format all others.
  array_pop($dates_objects);
  $dates_formatted = array();
  foreach ($dates_objects as $date_object) {
    $dates_formatted[] = date_format_date($date_object, 'custom', date_limit_format($format, date_nongranularity($limit_parts)));
  }

  return t('@date1@separator@date2', array(
    '@date1' => implode($variables['separator_multi'], $dates_formatted),
    '@separator' => t($variables['separator'], array(), array('context' => 'funky_date')),
    '@date2' => $last_date_formatted,
  ));
}


/**
 * Helper function for creating formatted date arrays from a formatter.
 *
 * @see date_formatter_process()
 */
function _funky_date_date_formatter_process($formatter, $entity_type, $entity, $field, $instance, $langcode, $item, $display) {
  $dates = array();
  $timezone = date_default_timezone();
  if (empty($timezone)) {
    return $dates;
  }

  $granularity = date_granularity($field);
  $settings = $display['settings'];
  $field_name = $field['field_name'];
  $format = date_formatter_format($formatter, $settings, $granularity, $langcode);
  $timezone = isset($item['timezone']) ? $item['timezone'] : '';
  $timezone = date_get_timezone($field['settings']['tz_handling'], $timezone);
  $timezone_db = date_get_timezone_db($field['settings']['tz_handling']);
  $db_format = date_type_format($field['type']);
  $process = date_process_values($field);

  foreach ($process as $processed) {
    if (empty($item[$processed])) {
      $dates[$processed] = NULL;
    }
    else {
      // Create a date object with a GMT timezone from the database value.
      $dates[$processed] = array();

      // Check to see if this date was already created by date_field_load().
      if (isset($item['db'][$processed])) {
        $date = $item['db'][$processed];
      }
      else {
        $date = new DateObject($item[$processed], $timezone_db, $db_format);
        $date->limitGranularity($field['settings']['granularity']);
      }

      $dates[$processed]['db']['object'] = $date;
      $dates[$processed]['db']['datetime'] = date_format($date, DATE_FORMAT_DATETIME);

      date_timezone_set($date, timezone_open($timezone));
      $dates[$processed]['local']['object'] = $date;
      $dates[$processed]['local']['datetime'] = date_format($date, DATE_FORMAT_DATETIME);
      $dates[$processed]['local']['timezone'] = $timezone;
      $dates[$processed]['local']['offset'] = date_offset_get($date);

      // Format the date, special casing the 'interval' format which doesn't
      // need to be processed.
      $dates[$processed]['formatted'] = '';
      $dates[$processed]['formatted_iso'] = date_format_date($date, 'custom', 'c');

      $format_type = $processed === 'value' ? $settings['format1'] : $settings['format2'];
      $format = variable_get('date_format_' . $format_type, '');
      if (is_object($date)) {
        $dates[$processed]['formatted'] = date_format_date($date, 'custom', $format);
        $dates[$processed]['formatted_date'] = date_format_date($date, 'custom', date_limit_format($format, array(
          'year',
          'month',
          'day',
        )));
        $dates[$processed]['formatted_time'] = date_format_date($date, 'custom', date_limit_format($format, array(
          'hour',
          'minute',
          'second',
        )));
        $dates[$processed]['formatted_timezone'] = date_format_date($date, 'custom', date_limit_format($format, array('timezone')));
      }
    }
  }

  if (empty($dates['value2'])) {
    $dates['value2'] = $dates['value'];
  }

  $dates['format'] = $format;
  return $dates;
}
