<?php

/**
 * @file
 *
 * This module is a base module for extensible elementary and secondary school
 * administration. With this module you can administer students, staff and
 * parents in a school.
 *
 * Author: Murat Tutumlu ("tutumlum", http://drupal.org/user/413570)
 */

/**
 * If academic year is 2000-2001, it is 2001
 * Default value is about to switch after August 30
 */
define("SCHOOL_ADMINISTRATION_C_YEAR", variable_get('school_administration_c_year', (date("m") < 9) ? date("Y") : date("Y") + 1));
define("SCHOOL_ADMINISTRATION_C_TERM", variable_get('school_administration_c_term', 1));


/**
 * implementation of hook_help.
 */
function school_administration_help($path, $arg) {
  if ($path == 'admin/help#school_administration') {
    return t('<p>First step of administrating a school is administering
      registration of students, teachers and non-academic staff. This module
      is a base module of school administration system, and it is responsible
      from keeping data of people.</p>');
  }
}

/**
 * Implementation of hook_permission()
 */
function school_administration_permission() {
  return array(
    'register new person' => array(
      'title' => t('Registration'),
      'description' => t('Allow users to register student, staff or parent. To make this is working you should grand "Administer users" permission too.'),
    ),
    'edit account info of everybody' => array(
      'title' => t('Edit accounts'),
      'description' => t('Allow users to edit all accounts'),
    ),
    'withdraw person' => array(
      'title' => t('Withdraw'),
      'description' => t('Allow users to withdraw any school personel or student'),
    ),
    'browse staff' => array(
      'title' => t('Browse staff'),
      'description' => t('Allow users to browse staff info'),
    ),
    'browse students and parents' => array(
      'title' => t('Browse students and parents'),
      'description' => t('Allow users to browse students and parents info'),
    ),
    'browse alumni' => array(
      'title' => t('Browse alumni'),
      'description' => t('Allow users to browse alumni info'),
    ),
    'change administrative info' => array(
      'title' => t('Update administrative info of users'),
      'description' => t('Allow users to update staff, student and parent related information and approve identity info changes'),
    ),
  );
}

/**
 * Implementation of hook_form_FORM_ID_alter() for user_register_form;
 */
function school_administration_form_user_register_form_alter(&$form, &$form_state, $form_id) {
  $op = array_pop(explode('/', current_path()));

  switch ($op) {
    
    //default
    case 'register_new' :
      $op = 'student';
      
    case 'student' :
      $form += school_administration_student_info();
      break;
    
    case 'staff' :
      $form += school_administration_staff_info();
      break;
    
    case 'parent' :
      //load defaults if the form is loaded just after student registration form
      $path_arr = explode('/', current_path());
      if(count($path_arr) > 3) {
        $form += school_administration_parent_info($path_arr[3]);
      }
      else {
        $form += school_administration_parent_info();
      }
      break;
      
    default :
      //make it available only for school_administration module
      return;
  }
  
  $form += school_administration_identity_info();

  //hiding username and passworde fields 
  $pass_item =& $form['account']['pass'];
  $pass_item['#required'] = FALSE;
  $pass_item['#type'] = 'hidden';
  $usr_item =& $form['account']['name'];
  $usr_item['#required'] = FALSE;
  $usr_item['#type'] = 'hidden';

  unset($form['account']['roles']);
  if (variable_get('school_administration_new_user_options', 0) == 0) {
    //do not send e-mail
    //e-mail field is not required. It will be generated
    $form['account']['mail']['#required'] = FALSE;
    unset($form['account']['notify']);
  }

  $form['user_type'] = array(
    '#type' => 'value',
    '#value' => $op,
  );
  $form['actions']['submit']['#value'] = t('Register');
  //unset 'user_register_submit' function since
  //module will register user itself since uid is produced
  unset($form['#submit'][0]);
  //add school administration validation function to the beginning
  //since userid should be generated first
  $subs[] = 'school_administration_register_user';
  foreach ($form['#submit'] as $sub) {
    $subs[] = $sub;
  }
  $form['#submit'] = $subs;

  //add school administration validation function to the beginning
  //since username and password should be generated first
  $vals[] = 'school_administration_register_form_validate';
  foreach ($form['#validate'] as $val) {
    $vals[] = $val;
  }
  $form['#validate'] = $vals;
}

/**
 * implements hook_form_FORM_ID_alter() for user_profile_form
 * to limit "Administer users" permission.
 * 
 * If an admin wants to make "Administer users" work as it is, 
 * "Edit accounts" permission of this module should be granted
 */
function school_administration_form_user_profile_form_alter($form, &$form_state, $account, $category = 'account') {
  global $user;
  $allow = FALSE;
  if ($user->uid == 1 || $form['#user']->uid == $user->uid || user_access('edit account info of everybody')) {
    $allow = TRUE;
  }
  if (!$allow) {
    drupal_access_denied();
    module_invoke_all('exit');
    exit;
  }

}

/**
 * implements hook_username_alter()
 * to show formatted full names every where.
 * 
 */
function school_administration_username_alter(&$name, $account) {
  if (isset($account->uid)) {
    $name = school_administration_formatted_full_name($account->uid) . " ($name)";
  }
}

/**
 * To limit access to "Browse persons" menu callback
 */
function school_administration_access($op, $uid = 0) {
  GLOBAL $user;
  //user has enough permissions to view photos
  if (user_access('browse staff')
    || user_access('browse students and parents')
    || user_access('browse alumni')) {
      return TRUE;
  }
  switch ($op) {
    case 'browse' :
      return FALSE;
    case 'photo' :
      list($uid) = explode('.', $uid);
      //user is viewing anonymous photo or own photo
      if ($user->uid == $uid || $uid == 0) {
        return TRUE;
      }
      if (module_exists('classes_and_lessons')) {
        $teacher_classes = classes_and_lessons_teaching($user->uid);
        //if user is not a teacher
        if (!$teacher_classes) {
          return FALSE;
        }
        $student_classes = classes_and_lessons_listof_student_classes($uid);
        //is teacher teaching to the user
        $classes = array_intersect($teacher_classes, $student_classes);
        if (count($classes) > 0) {
          return TRUE;
        }
      }
  }
  return FALSE;
}

/**
 * Implementation of hook_menu()
 */
function school_administration_menu() {
  $items['school_administration/autocomplete_fullname'] = array(
    'title' => 'User autocomplete',
    'page callback' => 'school_administration_autocomplete_fullname',
    'access callback' => 'user_access',
    'access arguments' => array('access user profiles'),
    'type' => MENU_CALLBACK,
  );
  $items['school_administration_photo/%'] = array(
    'title' => 'photo',
    'description' => 'Administer Your School',
    'page callback' => 'school_administration_portrait_photo',
    'page arguments' => array(1),
    'access callback' => 'school_administration_access',
    'access arguments' => array('photo', 1),
    'weight' => -2,
  );
  $items['school_administration'] = array(
    'title' => 'Registration',
    'description' => 'Administer Your School',
    'page callback' => 'school_administration_info',
    'access arguments' => array('register new person'),
    'weight' => -2,
  );
  $items['school_administration/register_new'] = array(
    'title' => 'Register New',
    'description' => 'Register New Person',
    'page callback' => 'school_administration_registration',
    'access arguments' => array('register new person'),
    'file' => 'school_administration.forms.inc',
    'weight' => -2,
  );
  $items['school_administration/register_new/student'] = array(
    'title' => 'Register Student',
    'description' => 'Register Student',
    'weight' => 0,
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  $items['school_administration/register_new/staff'] = array(
    'title' => 'Register Staff',
    'description' => 'Register Staff',
    'access arguments' => array('register new person'),
    'weight' => 1,
    'type' => MENU_LOCAL_TASK,
  );
  $items['school_administration/register_new/parent'] = array(
    'title' => 'Register Parent',
    'description' => 'Register Parent',
    'access arguments' => array('register new person'),
    'weight' => 2,
    'type' => MENU_LOCAL_TASK,
  );
  $items['school_administration/withdraw'] = array(
    'title' => 'Withdraw',
    'description' => 'Withdraw staff or students',
    'page callback' => 'school_administration_withdraw',
    'access arguments' => array('withdraw person'),
    'weight' => -2,
  );
  $items['school_administration/withdraw/report'] = array(
    'title' => 'Withdrawal Report',
    'description' => 'Withdrawal Report of students and staff',
    'weight' => -2,
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  $items['school_administration/withdraw/student'] = array(
    'title' => 'Withdraw Student',
    'description' => 'Withdraw a student',
    'page arguments' => array(2),
    'access arguments' => array('withdraw person'),
    'weight' => -1,
    'type' => MENU_LOCAL_TASK,
    'file' => 'school_administration.forms.inc',
  );
  $items['school_administration/withdraw/staff'] = array(
    'title' => 'Withdraw Staff',
    'description' => 'Withdraw a staff',
    'page arguments' => array(2),
    'access arguments' => array('withdraw person'),
    'weight' => -0,
    'type' => MENU_LOCAL_TASK,
    'file' => 'school_administration.forms.inc',
  );
  $items['admin/config/school_administration'] = array(
    'title' => 'Settings',
    'description' => 'School Administration Module Settings',
    'page callback' => 'school_administration_settings',
    'access arguments' => array('access administration pages'),
    'type' => MENU_NORMAL_ITEM, 
    'file' => 'school_administration.forms.inc',
  );
  $items['school_administration/portraits'] = array(
    'title' => 'Portrait Photos',
    'description' => 'Add Portrait Photo',
    'page callback' => 'school_administration_insert_portrait',
    'access arguments' => array('access administration pages'),
    'weight' => 0,
    'file' => 'school_administration.forms.inc',
  );
  $items['school_administration/reg_year'] = array(
    'title' => 'Registration Year',
    'page callback' => 'school_administration_register_to',
    'access arguments' => array('access administration pages'),
    'type' => MENU_CALLBACK,
  );
  $items['school_administration/browse'] = array(
    'title' => 'Browse Persons',
    'description' => 'Browse Persons',
    'page callback' => 'school_administration_browse',
    'access callback' => 'school_administration_access',
    'access arguments' => array('browse'),
    'weight' => 0,
  );
  $items['school_administration/browse/students'] = array(
    'title' => 'Students',
    'description' => 'Browse Student',
    'access arguments' => array('browse students and parents'),
    'weight' => 1,
    'type' => MENU_LOCAL_TASK,
  );
  $items['school_administration/browse/staff'] = array(
    'title' => 'Staff',
    'description' => 'Browse Staff',
    'access arguments' => array('browse staff'),
    'weight' => 1,
    'type' => MENU_LOCAL_TASK,
  );
  $items['school_administration/browse/alumni'] = array(
    'title' => 'Alumni',
    'description' => 'Browse Alumni',
    'access arguments' => array('browse alumni'),
    'weight' => 2,
    'type' => MENU_LOCAL_TASK,
  );
  $items['school_administration/browse/parents'] = array(
    'title' => 'Parents',
    'description' => 'Browse Parent',
    'access callback' => 'school_administration_access',
    'access arguments' => array('browse'),
    'weight' => 2,
    'type' => MENU_LOCAL_TASK,
  );
  $items['school_administration/browse/%'] = array(
    'title' => 'Browse Persons',
    'page arguments' => array(2),
    'access callback' => 'school_administration_access',
    'access arguments' => array('browse'),
    'weight' => 0,
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Implementation of hook_block_info
 * Blocks to display academinc year, list of groups, list of members
 */
function school_administration_block_info() {
  $blocks['academic_year'] = array(
    'info' => t("Display Academic Year"),
    'status'     => 1,
    'weight'     => -10,
    'visibility' => 1,
    'region'     => 'content',
    'pages'      => "",
    'cache'      => DRUPAL_CACHE_GLOBAL,
  );
  $blocks['groups'] = array(
    'info'       => t('Browse Member Groups'),
    'status'     => 1,
    'weight'     => -5,
    'visibility' => 1,
    'region'     => 'content',
    'pages'      => "school_administration/browse/*\n",
    'cache'      => DRUPAL_CACHE_PER_ROLE | DRUPAL_CACHE_PER_PAGE,
  );
  $blocks['members'] = array(
    'info'       => t('Browse Members'),
    'status'     => 1,
    'weight'     => -1,
    'visibility' => 1,
    'region'     => 'sidebar_second',
    'pages'      => "school_administration/browse/*\n",
    'cache'      => DRUPAL_CACHE_PER_ROLE | DRUPAL_CACHE_PER_PAGE,
  );
  $blocks['portrait'] = array(
    'info'       => t('Portrait Photo'),
    'status'     => 1,
    'weight'     => -10,
    'visibility' => 0,
    'region'     => 'sidebar_first',
    'cache'      => DRUPAL_CACHE_PER_USER,
  );
  return $blocks;
}

/**
 * Implementation of hook_block_view
 */
function school_administration_block_view($delta = '') {
  GLOBAL $user;
  $result = array();
  $block = array();
  switch ($delta) {
    case 'academic_year' :
      $result = t("!y1 - !y2 ACADEMIC YEAR",
        array(
          '!y1' => SCHOOL_ADMINISTRATION_C_YEAR - 1,
          '!y2' => SCHOOL_ADMINISTRATION_C_YEAR,
        )
      );
      $block = array(
        'subject' => '<none>',
        'content' => theme('school_administration_display_academic_year', array('academic_year' => $result)),
      );
      break;

    case 'groups':
      //to use groups for other modules use similar url structure like "module/option/group"
      $path_arr = explode('/', current_path());
      list($module, $option, $group) = $path_arr;
      switch ($group) {
        case 'staff' :
          //group staff according to their roles
          $staff_roles = school_administration_staff_roles();
          $sub_groups = school_administration_slice_predefined_roles($staff_roles);
          if (count($sub_groups) == 0) {
            drupal_set_message(t('You should add a role to a staff.'), 'warning');
          }
          break;

        case 'alumni' :
          $sub_groups = school_administration_browse_alumni_years();
          break;

        case 'students' :
        case 'parents' :
          if (module_exists('classes_and_lessons')) {
             $sub_groups = array();
          }
          else {
            $sub_groups = school_administration_browse_student_levels();
            if (count($sub_groups) == 0) {
              drupal_set_message(t('You should add students first.'), 'warning');
            }
          }
          break;

        default :
          $sub_groups = array();
      }
      foreach ($sub_groups as $sub_group) {
        $result[$sub_group] = l($sub_group, "$module/$option/$group/$sub_group");
      }
      $block = array(
        'subject' => '<none>',
        'content' => theme('school_administration_list_block', array('op' => 'groups', 'data' => $result)),
      );
      break;

    case 'members':
      //to use groups for other modules use similar url structure like modulename/option/group/subgroup
      $path_arr = explode('/', current_path());
      if (!isset($path_arr[3])) {
        return $block;
      }
      list($module, $option, $group, $sub_group) = $path_arr;
      switch ($group) {
        case 'staff' :
          $list = school_administration_staff_list($sub_group);
          break;

        case 'alumni' :
          $list = school_administration_alumni_list($sub_group);
          break;

        case 'students' :
        case 'parents' :
          $list = (module_exists('classes_and_lessons')) ? array()
          : school_administration_student_list($sub_group);
          break;

        default :
          $list = array();
      }
      foreach ($list as $uid) {
        $result[$uid] = $uid . ' ' . l(school_administration_formatted_full_name($uid), "$module/$option/$group/$sub_group/$uid");
      }
      usort($result, 'school_administration_sort_link');
      $block = array(
        'subject' => $sub_group,
        'content' => theme('school_administration_list_block', array('op' => 'members', 'data' => $result)),
      );
      break;

    case 'portrait' :
      $image = school_administration_portrait_photo_link($user->uid, array('width' => 130));
      $block = (!$user->uid) ? array() : array(
        'subject' => '<none>',
        'content' => theme('school_administration_portrait_photo_block', array('name' => $user->name, 'image' => $image)),
      );
      break;

  }
  return $block;
}

/**
 * Implementation of hook_form_alter()
 */
function school_administration_form_alter(&$form, $form_state, $form_id) {
  if (!($form_id == 'user_profile_form')) {//'user_register_form' || 
    return;
  }
  $user_info = user_load($form_state['user']->uid);
  //if user registration is not done via school_administration
  if (!isset($user_info->identity)) {
    return;
  }
  include_once 'school_administration.forms.inc';
  if (isset($user_info->identity_not_approved)) {
    $user_identity = $user_info->identity_not_approved;
    $diff = school_administration_identity_not_approved_diff((array)$user_info->identity, (array)$user_info->identity_not_approved);
    if (user_access('change administrative info')) {
      $changes = t('User is updated his/her identity information. Please check it and save it.<br/>Old values:');
      foreach ($diff as $key => $value) {
        $changes .= "<br/>$key: $value";
      }
      drupal_set_message($changes, 'warning');
    }
    else {
      drupal_set_message(t('Your Identification info update is waiting for confirmation.'), 'warning');
    }
  }
  else {
    $user_identity = $user_info->identity;
  }
  $form['identity'] = school_administration_identity_info($user_identity);
  
  if (user_access('change administrative info')) {
    if(isset($user_info->student)) {
      $form['student'] = school_administration_student_info($user_info->student);
    }
    if(isset($user_info->staff)) {
      $form['staff'] = school_administration_staff_info($user_info->staff);
    }
    if(isset($user_info->parenting)) {
      $form['parent'] = school_administration_parent_info(NULL, $user_info->parenting);
    }
  }
  return $form;
}


// ======================================
// Page Callback Functions:
// ======================================

/**
 * Menu callback; Retrieve a JSON object containing autocomplete suggestions for existing users.
 */
function school_administration_autocomplete_fullname($string = '') {
  $matches = array();
  if ($string) {
    $result = db_select('school_administration_users_identities', 'ui')
      ->fields('ui', array('uid'))
      ->condition('names', db_like($string) . '%', 'LIKE')
      ->range(0, 10)
      ->execute();
    foreach ($result as $user) {
      $matches[$user->uid] = check_plain(school_administration_formatted_full_name($user->uid));
    }
  }

  drupal_json_output($matches);
}

/**
 * Menu normal item; Main School Administration Link
 */
function school_administration_info() {
  $uid = school_administration_identity_not_approved();
  if ($uid && user_access('change administrative info')) {
    drupal_set_message(t("A user is updated his/her identity information. Please check it from !link and save it", array('!link' => l('here', "user/$uid/edit"))), 'warning');
  }
  $output = t('Number of Students:');
  $header = array(
    array('data' => t('Level')),
    array('data' => t('Old'), 'colspan' => 3),
    array('data' => t('New'), 'colspan' => 3),
    array('data' => t('Total'), 'colspan' => 3),
  );
  $rows[0] = array(
    t('Level'),
    t('Registered'),
    t('Withdrew'),
    t('Current'),
    t('Registered'),
    t('Withdrew'),
    t('Current'),
    t('Registered'),
    t('Withdrew'),
    t('Current'),
  );
  $all_students = school_administration_num_of_students('all');
  $old_students = school_administration_num_of_students('old');
  $new_students = school_administration_num_of_students('new');
  $old_withdrew = school_administration_num_of_withdrew_students('old');
  $new_withdrew = school_administration_num_of_withdrew_students('new');
  $students = array();
  foreach ($all_students as $level => $num) {
    $students[$level] = array(
      'old_students' => (isset($old_students[$level]) ? $old_students[$level] : 0),
      'old_withdrew' => (isset($old_withdrew[$level]) ? $old_withdrew[$level] : 0),
      'new_students' => (isset($new_students[$level]) ? $new_students[$level] : 0),
      'new_withdrew' => isset($new_withdrew[$level]) ? $new_withdrew[$level] : 0
    );
  }
  $i = 1;
  foreach ($students as $level => $numbers) {
    $rows[$i][] = $level;
    $rows[$i][] = $numbers['old_students'];
    $rows[$i][] = $numbers['old_withdrew'];
    $rows[$i][] = ($numbers['old_students'] - $numbers['old_withdrew']);
    $rows[$i][] = $numbers['new_students'];
    $rows[$i][] = $numbers['new_withdrew'];
    $rows[$i][] = ($numbers['new_students'] - $numbers['new_withdrew']);
    $rows[$i][] = ($numbers['old_students'] + $numbers['new_students']);
    $rows[$i][] = ($numbers['old_withdrew'] + $numbers['new_withdrew']);
    $rows[$i][] = ($numbers['old_students'] - $numbers['old_withdrew'] + $numbers['new_students'] - $numbers['new_withdrew']);
    $i++;
  }
  $rows[$i][] = t('Total');
  $old_st = school_administration_sum_subarrays_by_key($students, 'old_students');
  $old_wt = school_administration_sum_subarrays_by_key($students, 'old_withdrew');
  $new_st = school_administration_sum_subarrays_by_key($students, 'new_students');
  $new_wt = school_administration_sum_subarrays_by_key($students, 'new_withdrew');
  $rows[$i][] = $old_st;
  $rows[$i][] = $old_wt;
  $rows[$i][] = ($old_st - $old_wt);
  $rows[$i][] = $new_st;
  $rows[$i][] = $new_wt;
  $rows[$i][] = ($new_st - $new_wt);
  $rows[$i][] = ($old_st + $new_st);
  $rows[$i][] = ($old_wt + $new_wt);
  $rows[$i][] = ($old_st - $old_wt + $new_st - $new_wt);
  $table1 = array(
    'header' => $header,
    'rows' => $rows,
    'attributes' => array(),
    'caption' => '',
    'colgroups' => array(),
    'sticky' => 1,
    'empty' => '',
  );
  $output .= theme_table($table1);
  //by gender
  $output .= t('Number of Current Students By Gender:');
  $header2 = array(
    array('data' => t('Level')),
    array('data' => t('Girls'), 'colspan' => 3),
    array('data' => t('Boys'), 'colspan' => 3),
    array('data' => t('Total'), 'colspan' => 3),
  );
  $rows2[0] = array(
    t('Level'),
    t('Old'),
    t('New'),
    t('Total'),
    t('Old'),
    t('New'),
    t('Total'),
    t('Old'),
    t('New'),
    t('Total'),
  );
  $all_female = school_administration_num_of_students('female');
  $all_male = school_administration_num_of_students('male');
  $old_female = school_administration_num_of_old_students('female');
  $old_male = school_administration_num_of_old_students('male');
  $students = array();
  foreach ($all_students as $level => $total) {
    $students[$level] = array(
      'female_tot' => (isset($all_female[$level]) ? $all_female[$level] : 0),
      'female_old' => (isset($old_female[$level]) ? $old_female[$level] : 0),
      'male_tot'   => (isset($all_male[$level]) ? $all_male[$level] : 0),
      'male_old'   => isset($old_male[$level]) ? $old_male[$level] : 0
    );
  }
  $i = 1;
  foreach ($students as $level => $numbers) {
    $rows2[$i][] = $level;
    $rows2[$i][] = $numbers['female_old'];
    $rows2[$i][] = ($numbers['female_tot'] - $numbers['female_old']);
    $rows2[$i][] = $numbers['female_tot'];
    $rows2[$i][] = $numbers['male_old'];
    $rows2[$i][] = ($numbers['male_tot'] - $numbers['male_old']);
    $rows2[$i][] = $numbers['male_tot'];
    $rows2[$i][] = ($numbers['female_old'] + $numbers['male_old']);
    $rows2[$i][] = ($numbers['female_tot'] - $numbers['female_old'] + $numbers['male_tot'] - $numbers['male_old']);
    $rows2[$i][] = ($numbers['female_tot'] + $numbers['male_tot']);
    $i++;
  }
  $rows2[$i][] = t('Total');
  $female_old = school_administration_sum_subarrays_by_key($students, 'female_old');
  $female_tot = school_administration_sum_subarrays_by_key($students, 'female_tot');
  $male_old = school_administration_sum_subarrays_by_key($students, 'male_old');
  $male_tot = school_administration_sum_subarrays_by_key($students, 'male_tot');
  $rows2[$i][] = $female_old;
  $rows2[$i][] = ($female_tot - $female_old);
  $rows2[$i][] = $female_tot;
  $rows2[$i][] = $male_old;
  $rows2[$i][] = ($male_tot - $male_old);
  $rows2[$i][] = $male_tot;
  $rows2[$i][] = ($female_old + $male_old);
  $rows2[$i][] = ($female_tot - $female_old + $male_tot - $male_old);
  $rows2[$i][] = ($female_tot + $male_tot);
  $table2 = array(
    'header' => $header2,
    'rows' => $rows2,
    'attributes' => array(),
    'caption' => '',
    'colgroups' => array(),
    'sticky' => 1,
    'empty' => '',
  );
  $output .= theme_table($table2);
  return $output;
}

/**
 * Menu normal item; Insert portrait photos to database
 */
function school_administration_student_withdrawal_report() {
  $header = array(
    array('data' => t('No:')),
    array('data' => t('School No')),
    array('data' => t('Name and Surname')),
    array('data' => t('Grade Level')),
    array('data' => t('Debt Left')),
    array('data' => t('Reason')),
  );
  $rows = array();
  $i = 1;
  foreach (school_administration_list_of_withdrew_students() as $withdraw) {
    $term = taxonomy_term_load($withdraw->reason);
    if (module_exists('classes_and_lessons')) {
      $grade_level = implode(', ', classes_and_lessons_listof_student_classes($withdraw->school_no));
    }
    else {
      $user = user_load($withdraw->school_no);
      $grade_level = $user->full_name;
    }
    $rows[] = array(
      $i,
      $withdraw->school_no,
      school_administration_formatted_full_name($withdraw->school_no),
      $grade_level,
      $withdraw->debt_of_student_left,
      $term->name,
    );
    $i++;
  }
  $table = array(
    'header' => $header,
    'rows' => $rows,
    'attributes' => array(),
    'caption' => '',
    'colgroups' => array(),
    'sticky' => 1,
    'empty' => '',
  );
  return theme_table($table);
}

/**
 * Menu normal item; Insert portrait photos to database
 */
function school_administration_insert_portrait() {
  $output = '<b>' . t('Notes:') . '</b><br />';
  $output .= t('Photographs should be in JPG format.') . '<br />';
  if (!function_exists('face_detect')) {
    $output .= t('Use photos that cropped as portrait.') . '<br />';
  }
  if (!function_exists('imagecreatefromjpeg')) {
    $output .= t('A photograph should be maximum 64KB in size.') . '<br />';
    $output .= t('Set photograph size 300x400 (widthxheight) (in pixels).') . '<br />';
  }
  $output .= t('Set file name as userid.') . '<br />';
  $output .= t('Copy photos to "Portrait Photos Directory"') . '<br />';
  $output .= drupal_render(drupal_get_form('school_administration_insert_portrait_form'));
  return $output;
}

/**
 * Menu local task; Register New
 */
function school_administration_registration() {
  $_form = drupal_get_form('user_register_form');
  return drupal_render($_form);
}

/**
 * Menu local task; withdraw
 */
function school_administration_withdraw($withdraw = 'report') {
  $output = '';
  switch ($withdraw) {
    case 'report' :
    $output .= school_administration_student_withdrawal_report();
    break;

    case 'student' :
    $_form = drupal_get_form('school_administration_student_withdraw_form');
    $output .= drupal_render($_form);
    break;

    case 'staff' :
    $_form = drupal_get_form('school_administration_staff_withdraw_form');
    $output .= drupal_render($_form);
    break;
  }
  return $output;
}

/**
 * Menu local task; School Administration Settings
 */
function school_administration_settings() {
   $_form = drupal_get_form('school_administration_admin');
   return drupal_render($_form);
}

/**
 * Menu callback; Sets whether registration year is
 * current academic year or next academic year.
 *
 * @param $mode
 *   Valid values are 'current' and 'next'.
 */
function school_administration_register_to($mode = 'current') {
  global $user;
  user_save($user, array('register_to' => ($mode == 'next')));
  drupal_goto(drupal_get_destination());
}

function school_administration_show_user($form, &$form_state) {
  $form['browse'] = array(
    '#type' => 'fieldset',
    '#title' => t('View any user\'s profile info'),
  );
  $form['browse']['user'] = array(
    '#type' => 'textfield',
    '#title' => t('Full name or ID Number of user'),
    '#autocomplete_path' => 'school_administration/autocomplete_fullname',
  );
  $form['submit'] = array('#type' => 'submit', '#value' => t('Show user'));
  
  return $form;
}

function school_administration_show_user_validate($form, &$form_state) {
  if (!is_numeric($form_state['values']['user'])) {
    form_set_error('user', t('Please submit only ID Number.'));
  }
  $account = user_load($form_state['values']['user']);
  if (!$account) {
    form_set_error('user', t('You have entered an invalid ID Number.'));
  }
}

function school_administration_show_user_submit($form, &$form_state) {
  drupal_goto('user/' . $form_state['values']['user']);
}

/**
 * Menu normal item; Browse persons
 */
function school_administration_browse($path = NULL) {
  $path_arr = explode('/', current_path());
  if ($path == NULL || !isset($path_arr[4]) || !is_numeric($uid = array_pop($path_arr))) {
    return drupal_render(drupal_get_form('school_administration_show_user'));
  }
  if ($path_arr[2] == 'parents') {
    $output = 'Registered Parents:<br />';
    $parents = school_administration_parents_of_student($uid);
    foreach ($parents as $parent) {
      $output .= $parent->relation . ' : ' . l(school_administration_formatted_full_name($parent->uid), 'user/' . $parent->uid) . "<br />";
    }
    return $output;
  }
  $account = user_load($uid);
  user_build_content($account);
  $build = $account->content;
  $build += array(
    '#theme' => 'user_profile',
    '#account' => $account,
  );
  return $build;
}

/**
 * Menu item; Display portrait photos.
 */
function school_administration_portrait_photo($uid) {
  list($uid) = explode('.', $uid);
  //_drupal_set_preferred_header_name('image/jpeg');
  header('Content-Type: image/jpeg');
  print db_query("
    SELECT photo
    FROM {school_administration_users_portraits}
    WHERE uid = :uid
    ORDER BY upload_date DESC",
    array(':uid' => $uid)
  )
  ->fetchField();
  exit;
}

// ======================================
// Helper Functions:
// ======================================

/**
 * generate username form name and surname as first letter of the name and whole surname.
 *
 */
function school_administration_generate_user_name($name, $surname){
  $i = 0;
  do {
    $ex = ($i == 0) ? '' : $i;
    //to produce username mtutumlu for Murat Tutumlu
    $uname = drupal_strtolower(drupal_substr($name , 0, 1) . str_replace(array(' ', '.'), '', $surname)) . $ex;
    $i++;
  }
  while (db_query("
    SELECT COUNT(name)
    FROM {users}
    WHERE name = :name",
    array(':name' => $uname)
    )
    ->fetchField() > 0
  );
  return $uname;
}

/**
 * crop and resize the loaded image to 300x400 portraits.
 *
 */
function school_administration_face_detect_crop_resize($jpg_file_path, $face, $size) {
  $a = explode('/', $jpg_file_path);
  $n = array_pop($a);
  $b = implode('/', $a);
  $jpg_file_path_temp = $b . '/_' . $n;
  //face detection process
  // -> expermental face detection
  // if portraits selected from both methods' results 100% accuracy can be reached.
  if (function_exists('imagecreatefromjpeg') && $size == 1) {
    $result = imagecreatetruecolor(300, 400);
    $src = imagecreatefromjpeg($jpg_file_path);
    list($w, $h) = getimagesize($jpg_file_path);
    if (function_exists('face_detect') && $face > 0) {
      $i = 0;
      do {
        $coord = array();
        if($i == 0) {
          $jpeg = $jpg_file_path;
        }
        else {
          $jpeg = $jpg_file_path_temp;
          list($w, $h) = getimagesize($jpeg);
          //reduce image size 5% to get ony one (supposingly the most reliable) face
          $ratio = 0.95;
          $res = imagecreatetruecolor($w * $ratio, $h * $ratio);
          imagecopyresized($res, $src, 0, 0, 0, 0, $w * $ratio, $h * $ratio, $w, $h);
          //save it to temp file
          imagejpeg($res, $jpg_file_path_temp);
        }
        // method-1 around produces 95% accurate result
        if ($face == 1) {
          $method = '/usr/local/share/opencv/haarcascades/haarcascade_frontalface_alt_tree.xml';
        }
          // method-2 around produces 90% accurate result
        else {
          $method = '/usr/local/share/opencv/haarcascades/haarcascade_frontalface_alt.xml';
        }
        $coord = face_detect($jpeg, $method);
        $i++;
      } while (count($coord) > 10);
      $x = (int)($coord[0]['x'] - $coord[0]['w'] * 0.3); //move to 30% of face width left
      $y = (int)($coord[0]['y'] - $coord[0]['h'] * 0.45); //move to 45% of face height up
      $w = (int)($coord[0]['w'] + $coord[0]['w'] * 0.6);  //increase width of portrait photo 60%
      $h = (int)($coord[0]['h'] + $coord[0]['h'] * 1.2);  //increase height of portrait photo 110%
      //get cropped image
      $src = imagecreatefromjpeg($jpeg);
      $dest = imagecreatetruecolor($w, $h);
      imagecopy($dest, $src, 0, 0, $x, $y, $w, $h);
      drupal_set_message(t('Note: Please check the result images since openCV has aroun 95% accuracy.'), 'warning', FALSE);
      imagedestroy($src);
    }
    else {
      //face detection is not possible since openCV is not installed
      $dest = $src;
    }
    //resize the image to 300x400
    imagecopyresampled($result, $dest, 0, 0, 0, 0, 300, 400, $w, $h);
    imagedestroy($dest);
    //file will be written to to a temp new file
    imagejpeg($result, $jpg_file_path_temp);
    imagedestroy($result);
    return $jpg_file_path_temp;
  }
  //if GD library is not installed just copy the file.
  copy($jpg_file_path, $jpg_file_path_temp);
  return $jpg_file_path_temp;
}

/**
 * It the diffrence between recorded identity info and updatated identity info.
 *
 * @return array of difference
 */
function school_administration_identity_not_approved_diff($record, $edit) {
  $diff = array();
  foreach ($record as $key => $value) {
    if (isset($edit[$key]) && $edit[$key] != $value) {
      //extract changes
      $diff[$key] = $value;
    }
  }
  unset($diff['vid'], $diff['update_approved'], $diff['update_time'], $diff['updater_uid']);
  return $diff;
}

/**
 * It checks any apporval for identity update is exist or not.
 *
 * @return vid for the first match
 */
function school_administration_identity_not_approved($uid = NULL) {
  if ($uid == NULL) {
    $vids = db_query('SELECT uid, MAX(vid) FROM {school_administration_users_identities} GROUP BY uid ORDER BY update_time ASC')->fetchAllKeyed();
  }
  else {
    $vids = db_query('SELECT uid, MAX(vid) FROM {school_administration_users_identities} WHERE uid=:uid ORDER BY update_time ASC', array(':uid' => $uid))->fetchAllKeyed();
  }
  foreach ($vids as $uid => $vid) {
    $app = db_query('SELECT update_approved as app FROM {school_administration_users_identities} WHERE vid=:vid', array(':vid' => $vid))->fetchField();
    if ($app == 0) {
      return $uid;
    }
  }
  return FALSE;
}

/**
 * It checks user is a student or not.
 *
 * @param $uid
 *   id of suggested user.
 *
 * @return student info array or FALSE
 */
function school_administration_student($uid) {
  $result = db_query("
    SELECT *
    FROM {school_administration_student_main}
    WHERE school_no = :uid
    AND withdraw_date IS NULL
    AND academic_year = :cyear",
    array(':cyear' => SCHOOL_ADMINISTRATION_C_YEAR, ':uid' => $uid)
  )
  ->fetch();
  return ($result) ? $result : FALSE;
}

/**
 * It checks user is a staff or not.
 *
 * @param $uid
 *   id of suggested user.
 *
 * @return staff info array or FALSE
 */
function school_administration_staff($uid) {
  $result = db_query("
    SELECT *
    FROM {school_administration_staff_main}
    WHERE staff_no = :uid
    AND academic_year = :cyear",
    array(':cyear' => SCHOOL_ADMINISTRATION_C_YEAR, ':uid' => $uid)
  )
  ->fetch();
  return ($result) ? $result : FALSE;
}

/**
 * It gets roles assigned to staff.
 *
 * @return role id array;
 */
function school_administration_staff_roles() {
  $result = array();
  $proles = variable_get('school_administration_predefined_roles');
  $staff_rid = $proles['staff']['rid'];
  $staff = db_query("SELECT uid FROM {users_roles} WHERE rid = :rid", array(':rid' => $staff_rid))->fetchCol();
  foreach ($staff as $st) {
    $roles = db_query("SELECT r.rid, r.name FROM {role} r, {users_roles} ur WHERE r.rid=ur.rid AND uid = :uid", array(':uid' => $st))->fetchAllKeyed();
    foreach ($roles as $rid => $role) {
      $result[$rid] = $role;
    }
  }
  return $result;
}

/**
 * It checks user is a parent of a student or not.
 *
 * @param $uid
 *   id of suggested user.
 *
 * @return student parent info array or FALSE
 */
function school_administration_student_parent($uid) {
  $result = db_query("
    SELECT school_no
    FROM {school_administration_student_parents}
    WHERE uid = :uid
    AND academic_year = :cyear",
    array(':cyear' => SCHOOL_ADMINISTRATION_C_YEAR, ':uid' => $uid)
  )
  ->fetchCol();
  return ($result) ? $result : FALSE;
}

/**
 * It checks user is an alumnus or not.
 *
 * @param $uid
 *   id of suggested user.
 *
 * @return alumnus info array or FALSE
 */
function school_administration_alumnus($uid) {
  $result = db_query("
    SELECT *
    FROM {school_administration_alumni}
    WHERE school_no = :uid",
    array(':uid' => $uid)
  )
  ->fetch();
  return ($result) ? $result : FALSE;
}

/**
 * Producing num_range array for department digits from user input
 *
 * @return ranges
 *    returns an array
 */
function school_administration_get_id_conf_range ($type) {
  $ranges = array();
  switch ($type) {
    case 'register_new' :
    case 'student' :
      $text = variable_get('school_administration_num_range');
      break;

    case 'staff' :
      $text = variable_get('school_administration_num_range_staff');
      break;

    case 'parent' :
      return $ranges;

  }
  if (module_exists('php') && substr($text, 0, 5) == '<?php') {
    $text = str_replace(array('[', ']'), '', php_eval($text));
  }
  foreach (explode(chr(10), $text) as $val) {
    $r = explode('=>', $val);
    if (isset($r[1])) {
      $ranges[trim($r[0])] = trim($r[1]);
    }
  }
  return $ranges;
}

/**
 * Perform a calculation for custom uid.
 *
 * Configured user id will be in format yydxx which is 'yy' last two digits of current year,
 * 'd' is department digit, x's are ordered numbers.
 *
 * @param $range
 *    To divide enrolling students to groups.
 *    It is an integer value passed from $form_state array of student registration form
 *    or NULL (default value) if user is staff or parent.
 *
 * @return uid
 *    returns an integer
 */
function school_administration_calculate_user_id ($type, $range = NULL) {
  $start_digits = (school_administration_register_to_next_year()) ? SCHOOL_ADMINISTRATION_C_YEAR - 2000 : SCHOOL_ADMINISTRATION_C_YEAR - 2001;
  $st_id_len = variable_get('school_administration_std_id_len', 2);
  //fill student ID lenght with zeros
  $st_id_fill = sprintf("%0" . $st_id_len . "s", 0);
  //get the ranges
  $ranges = school_administration_get_id_conf_range($type);
  if ($range != NULL) {
    //student
    //get the range name
    $range_name = $ranges[$range];
    //the ranges which are assigned to this name
    foreach ($ranges as $k => $r) {
      if ($range_name == $r) {
        $s_ranges[] = $k;
      }
    }
    $range_num_max = MAX($s_ranges);
    $range_num_min = MIN($s_ranges);
    //the number bigger than highest possible userid in the given range
    $max = $start_digits . $range_num_max + 1 . $st_id_fill;
    //the number smaller than lowest possible userid in the given range
    $min = $start_digits . $range_num_min . $st_id_fill;
    $max_in_range = db_query("
      SELECT MAX(uid) + 1
      FROM {users}
      WHERE uid > :min
      AND uid < :max",
      array(':min' => $min, ':max' => $max)
    )
    ->fetchField();
    return ($max_in_range > $min) ? $max_in_range : ($min + 1);
  }
  else {
    //parent
    $ranges = array_merge(school_administration_get_id_conf_range('student'), school_administration_get_id_conf_range('staff'));
    //get the range keys
    $range_keys = array_keys($ranges);
    //get the shortest key as first
    array_multisort(array_map('strlen', $range_keys), SORT_ASC, SORT_NUMERIC, $range_keys);
    //get zero's with the length of shortest range key
    $range_fill = sprintf("%0" . strlen($range_keys[0]) . "s", 0);
    //the smallest ID number produced.
    $st_no_min = $start_digits . $range_fill . $st_id_fill;
    $max_out_of_range = db_query("
      SELECT MAX(uid) + 1
      FROM {users}
      WHERE uid < :min",
      array(':min' => $st_no_min)
    )
    ->fetchField();
    //return Parent ID with possible minimum non-configured userid
    return $max_out_of_range;
  }
}

/**
 * Determine if registration mode is next academic year.
 */
function school_administration_register_to_next_year() {
  global $user;
  return (isset($user->register_to)) ? $user->register_to : FALSE;
}

/**
 * Display the link to shift academic year to register students and parents.
 */
function school_administration_next_year_link() {
  $output = '';
  if (school_administration_register_to_next_year()) {
    $output .= t('Now registering to !y1 - !y2 academic year.', array(
      '!y1' => SCHOOL_ADMINISTRATION_C_YEAR,
      '!y2' => SCHOOL_ADMINISTRATION_C_YEAR + 1,
    ));
    $output .= l(
      t('Switch to !y1 - !y2 academic year', array(
        '!y1' => SCHOOL_ADMINISTRATION_C_YEAR - 1,
        '!y2' => SCHOOL_ADMINISTRATION_C_YEAR,
      )),
      'school_administration/reg_year/current', array(
        'attributes' => array(
          'title' => t('Register new person to current academic year.')
        ),
        'query' => drupal_get_destination()
      ));
  }
  else {
    $output .= t('Now registering to !y1 - !y2 academic year. ', array(
      '!y1' => SCHOOL_ADMINISTRATION_C_YEAR - 1,
      '!y2' => SCHOOL_ADMINISTRATION_C_YEAR,
    ));
    $output .= l(
      t('Switch to !y1 - !y2 academic year', array(
        '!y1' => SCHOOL_ADMINISTRATION_C_YEAR,
        '!y2' => SCHOOL_ADMINISTRATION_C_YEAR + 1,
      )),
      'school_administration/reg_year/next', array(
        'attributes' => array(
          'title' => t('Register new person to next academic year.')
        ),
        'query' => drupal_get_destination()
      ));
  }
  drupal_set_message($output, 'status');
}

/**
 * Provides link to display portrait photos.
 *
 * @param $uid
 *   id of suggested user.
 * @param $attributes
 *   HTML attributes of displaying photo.
 *
 * @return <img> tag of users photo
 */
function school_administration_portrait_photo_link($uid, $attributes=array()) {
  $uid = empty($uid) ? 0 : $uid;
  $exist = db_query("
    SELECT uid
    FROM {school_administration_users_portraits}
    WHERE uid = :uid",
    array(':uid' => $uid)
  )
  ->fetchCol();
  //if there is no image, retreive default image
  $uid = (count($exist) < 1) ? 0 : $uid;
  $url = '?q=school_administration_photo/' . $uid . '.jpg';
  $url = (url($url) == $url) ? $url : (base_path() . $url);
  $variables = array(
    'path' => check_url($url),
    'alt' => $uid . '.jpg',
    'title' => $uid . '.jpg',
    'attributes' => $attributes,
  );
  return theme_image($variables);
}

/**
 * Provides parents and guardians of suggested student.
 *
 * @param $school_no
 *   id of suggested student.
 *
 * @return associative array of parents and guardians.
 */
function school_administration_parents_of_student($school_no) {
  $result = db_query("
    SELECT *
    FROM {school_administration_student_parents}
    WHERE school_no = :school_no
    AND academic_year = :cyear",
    array(':cyear' => SCHOOL_ADMINISTRATION_C_YEAR, ':school_no' => $school_no)
  )
  ->fetchAllAssoc('uid');
  return $result;
}

/**
 * Provides parent information by parent parenting_id.
 *
 * @param $id
 *   parenting_id of suggested parent.
 *
 * @return object of parent.
 */
function school_administration_parenting_info($parenting_id) {
  $result = db_query("
    SELECT *
    FROM {school_administration_student_parents}
    WHERE id = :id
    AND academic_year = :cyear",
    array(':cyear' => SCHOOL_ADMINISTRATION_C_YEAR, ':id' => $parenting_id)
  )
  ->fetch();
  return ($result) ? $result : FALSE;
}

/**
 * Provides uid's of students who are childeren of suggested user.
 *
 * @param $uid
 *   uid of suggested user.
 *
 * @return associative array of students.
 */
function school_administration_childeren_of_parent($uid) {
  $result = db_query("
    SELECT *
    FROM {school_administration_student_parents}
    WHERE uid = :uid
    AND academic_year = :cyear",
    array(':cyear' => SCHOOL_ADMINISTRATION_C_YEAR, ':uid' => $uid)
  )
  ->fetchAllAssoc('school_no');
  return $result;
}

/**
 * Sweeps pre-defined roles out from given array
 *
 * @return array of roles.
 */
function school_administration_slice_predefined_roles($all_roles) {
  //remove anonimous user, authenticated user and administrator
  unset($all_roles[1], $all_roles[2], $all_roles[3]);
  //get student, staff and parent rid's
  foreach (variable_get('school_administration_predefined_roles') as $role) {
    $predef_roles[] = $role['name'];
  }
  //get student, staff and parent roles
  $result = array_diff($all_roles, $predef_roles);
  //sort with keeping keys unchanged
  asort($result);
  return $result;
}

/**
 * Provides recorded student grade levels.
 *
 * @return array of levels.
 */
function school_administration_browse_student_levels() {
  $result = db_query("
    SELECT DISTINCT level
    FROM {school_administration_student_main}
    WHERE academic_year = :cyear",
    array(':cyear' => SCHOOL_ADMINISTRATION_C_YEAR)
  )
  ->fetchCol();
  sort($result);
  return $result;
}

/**
 * Provides recorded alumni classes year by year.
 *
 * @return array of classes in yyyy-A format.
 */
function school_administration_browse_alumni_years() {
  $classes = array();
  $result = db_query("
    SELECT DISTINCT graduation_year, class
    FROM {school_administration_alumni}"
  );
  foreach ($result as $class) {
    $classes[] = "$class->graduation_year-$class->class";
  }
  sort($classes);
  return $classes;
}

/**
 * Provides uid's of alumni.
 *
 * @param $section
 *   suggested section in yyyy-A format.
 *
 * @return array uid's.
 */
function school_administration_alumni_list($section) {
  $result = explode('-', $section);
  $students = db_query("
    SELECT school_no
    FROM {school_administration_alumni}
    WHERE graduation_year = :year
    AND class = :class",
    array(':year' => $result[0], ':class' => $result[1])
  )
  ->fetchCol();
  return $students;
}

/**
 * Provides uid's of staff who have suggested role.
 *
 * @param $role
 *   suggested role.
 *
 * @return array uid's.
 */
function school_administration_staff_list($role) {
  $staff = db_query("
    SELECT s.staff_no
    FROM {school_administration_staff_main} s, {users_roles} ur, {role} r
    WHERE s.staff_no = uid AND ur.rid=r.rid
    AND s.academic_year = :cyear
    AND r.name = :role",
    array(':cyear' => SCHOOL_ADMINISTRATION_C_YEAR, ':role' => $role)
  )
  ->fetchCol();
  return $staff;
}

/**
 * Provides uid's of students who have suggested level.
 *
 * @param $level
 *   suggested level.
 *
 * @return array uid's.
 */
function school_administration_student_list($level) {
  $result = db_query("
    SELECT school_no
    FROM {school_administration_student_main}
    WHERE level = :level
    AND academic_year = :cyear
    AND withdraw_date IS NULL
    ORDER BY school_no",
    array(':cyear' => SCHOOL_ADMINISTRATION_C_YEAR, ':level' => $level)
  )
  ->fetchCol();
  return $result;
}

/**
 * Provides uid's of all present teachers.
 *
 * @return array uid's.
 */
function school_administration_list_of_all_teachers() {
  $rids = variable_get('school_administration_teacher_roles', array(1));
  $result = db_query("
    SELECT staff_no
    FROM {school_administration_staff_main}, {users_roles}
    WHERE staff_no = uid
    AND withdraw_date IS NULL
    AND rid IN (:rids)
    AND academic_year = :cyear",
    array(':cyear' => SCHOOL_ADMINISTRATION_C_YEAR, ':rids' => implode(', ', $rids))
  )
  ->fetchCol();
  return $result;
}

/**
 * Provides uid's of students who are siblings of suggested student.
 *
 * @param $school_no
 *   uid of suggested user.
 *
 * @return array of student uids.
 */
function school_administration_siblings_of_student($school_no) {
  $parent = db_query("
    SELECT uid
    FROM {school_administration_student_parents}
    WHERE school_no = :school_no
    AND academic_year = :cyear",
    array(':cyear' => SCHOOL_ADMINISTRATION_C_YEAR, ':school_no' => $school_no)
  )
  ->fetchField();
  $result = db_query("
    SELECT school_no
    FROM {school_administration_student_parents}
    WHERE uid = :uid
    AND school_no != :school_no
    AND academic_year = :cyear",
    array(
      ':uid' => $parent,
      ':school_no' => $school_no,
      ':cyear' => SCHOOL_ADMINISTRATION_C_YEAR,
    )
  )
  ->fetchCol();
  return $result;
}

/**
 * Provides formatted full name of suggested user.
 *
 * @param $uid
 *   uid of suggested user.
 * @param $format
 *   selected format id of full name.
 *
 * @return formatted full name.
 */
function school_administration_formatted_full_name($uid) {
  $format = variable_get('school_administration_full_name_format', 0);
  $formatted = array();
  $result = db_query("
    SELECT title, names, surname
    FROM {school_administration_users_identities}
    WHERE uid = :uid 
    AND update_approved=1 
    ORDER BY vid DESC",
    array(':uid' => $uid)
  )
  ->fetch();
  if (count($result) > 0) {
    $title = (isset($result->title)) ? $result->title : '';
    $names = (isset($result->names)) ? $result->names : '';
    $surname = (isset($result->surname)) ? $result->surname : '';
    switch ($format) {
      case 2 :
        $formatted[] = drupal_strtoupper($surname) . ',';
        foreach (explode(' ', $names) as $name) {
          $formatted[] = drupal_ucfirst(drupal_strtolower($name));
        }
        break;

      case 1 :
        $formatted[] = drupal_ucfirst(drupal_strtolower($title));
        foreach (explode(' ', $names) as $name) {
          $formatted[] = drupal_ucfirst(drupal_strtolower($name));
        }
        $formatted[] = drupal_ucfirst(drupal_strtolower($surname));
        break;

      default :
        foreach (explode(' ', $names) as $name) {
          $formatted[] = drupal_ucfirst(drupal_strtolower($name));
        }
        $formatted[] = drupal_ucfirst(drupal_strtolower($surname));
    }
  }
  return implode(' ', $formatted);
}

/**
 * Provides sum of sub-arrays' values with a definite key of sub arrays.
 * array (
 *   1 => array(7 => 22, 8 => 30, 9 => 43 ),
 *   2 => array(7 => 23, 8 => 31, 9 => 44 ),
 *   3 => array(7 => 24, 8 => 32, 9 => 45 ),
 * )
 *
 * @param $array
 *   multi-dimensional array
 * @param $key
 *   definite key of sub arrays.
 *
 * @return sum of additions.
 * above arrray with $key = 8 returns 30+31+32
 */
function school_administration_sum_subarrays_by_key($array, $key) {
  $sum = 0;
  foreach ($array as $sub_array) {
    $sum += $sub_array[$key];
  }
  return $sum;
}

/**
 * Provides number of current students in every level with given condition.
 *
 * @param $op
 *   condition options.
 * options are: new, old, male, female.
 *
 * @return array of levels and number of students.
 */
function school_administration_num_of_students($op) {
  $query = db_select('school_administration_student_main', 's');
  $query->leftjoin('school_administration_users_identities', 'u', 's.school_no = u.uid');
  $query->addExpression('COUNT(DISTINCT school_no)');
  $query->addField('s', 'level');
  switch ($op) {
    case 'new' :
      $query->where("school_no > :range", array(':range' => (SCHOOL_ADMINISTRATION_C_YEAR - 2001)*1000));
      break;

    case 'old' :
      $query->where("school_no < :range", array(':range' => (SCHOOL_ADMINISTRATION_C_YEAR - 2001)*1000));
      break;

    case 'male' :
      $query->where("gender = 'Male'");
      $query->where("
        NOT EXISTS
        (SELECT *
        FROM {school_administration_withdrawal} wt
        WHERE wt.school_no = s.school_no
        AND academic_year = :cyear)",
        array(':cyear' => SCHOOL_ADMINISTRATION_C_YEAR)
        );
      break;

    case 'female' :
      $query->where("gender = 'Female'");
      $query->where("
        NOT EXISTS
        (SELECT *
        FROM {school_administration_withdrawal} wt
        WHERE wt.school_no = s.school_no
        AND academic_year = :cyear)",
        array(':cyear' => SCHOOL_ADMINISTRATION_C_YEAR)
        );
      break;
    case 'all' :
    break;
  }
  $query->where("s.academic_year = :cyear", array(':cyear' => SCHOOL_ADMINISTRATION_C_YEAR));
  $query->groupBy('level');
  $students = $query->execute()->fetchAllKeyed();
  ksort($students);
  return $students;
}

/**
 * Provides number of withdrew students in every level with given condition.
 *
 * @param $op
 *   condition options.
 * options are: new, old.
 *
 * @return array of levels and number of students.
 */
function school_administration_num_of_withdrew_students($op) {
  $query = db_select('school_administration_withdrawal', 'w');
  $query->leftjoin('school_administration_student_main', 's', 'w.school_no = s.school_no');
  $query->addExpression('COUNT(w.school_no)');
  $query->addField('s', 'level');
  if ($op == 'new') {
    $query->where("w.school_no > (:cyear - 2001)*1000", array(':cyear' => SCHOOL_ADMINISTRATION_C_YEAR));
  }
  else {
    $query->where("w.school_no < (:cyear - 2001)*1000", array(':cyear' => SCHOOL_ADMINISTRATION_C_YEAR));
  }
  $query->where("s.academic_year = :cyear", array(':cyear' => SCHOOL_ADMINISTRATION_C_YEAR));
  $query->where("w.academic_year = s.academic_year");
  $query->groupBy('s.level');
  $students = $query->execute()->fetchAllKeyed();
  ksort($students);
  return $students;
}

/**
 * Provides number of withdrew students in every level with given condition.
 *
 * @return array of levels and number of students.
 */
function school_administration_list_of_withdrew_students() {
  return db_query("
    SELECT *
    FROM {school_administration_withdrawal}
    WHERE academic_year = :cyear", array(
      ':cyear' => SCHOOL_ADMINISTRATION_C_YEAR,
    )
  );
}

/**
 * Provides number of old students in every level with given condition.
 *
 * @param $op
 *   condition options.
 * options are: male, female.
 *
 * @return array of levels and number of students.
 */
function school_administration_num_of_old_students($op) {
  $gender = ($op == 'male') ? 'Male' : 'Female';
  $students = db_query("
    SELECT level, COUNT(DISTINCT school_no)
    FROM
      {school_administration_student_main},
      {school_administration_users_identities}
    WHERE gender = :gender
    AND school_no = uid
    AND school_no < (:cyear1 - 2001)*1000
    AND academic_year = :cyear2
    AND withdraw_date IS NULL
    GROUP BY level", array(
      ':gender' => $gender,
      ':cyear1' => SCHOOL_ADMINISTRATION_C_YEAR,
      ':cyear2' => SCHOOL_ADMINISTRATION_C_YEAR,
    )
  )
  ->fetchAllKeyed();
  ksort($students);
  return $students;
}

/**
 * Compares 2 values.
 *
 * @param $a
 *   first value
 * @param $b
 *   second value
 *
 * @return 0, if $a and $b is equal, 1 if $a is greater, -1 if $b is greater.
 */
function school_administration_sort_link($a, $b) {
  $a = strip_tags($a);
  $b = strip_tags($b);
  if ($a == $b) {
    return 0;
  }
  return ($a < $b) ? -1 : 1;
}

// ======================================
// Form Validation Functions:
// ======================================


function school_administration_register_form_validate($form, &$form_state){
  if (!form_get_errors()) {
    $uname = school_administration_generate_user_name($form_state['values']['names'], $form_state['values']['surname']);
    $pass = user_password(8);
    if (variable_get('school_administration_id_conf_use_default', 1) != 1) {
      $range = isset($form_state['values']['num_range']) ? $form_state['values']['num_range'] : NULL ;
      $form_state['values']['uid'] = school_administration_calculate_user_id($form_state['values']['user_type'], $range);
    }
    else {
      $form_state['values']['uid'] = 0;
    }
    form_set_value($form['account']['pass'], $pass, $form_state);
    form_set_value($form['account']['name'], $uname, $form_state);
    
    if (empty($form_state['values']['mail'])) {
      form_set_value($form['account']['mail'], $uname . '@' . $_SERVER['HTTP_HOST'], $form_state);
    }
    elseif (isset($form['account']['notify'])) {
      form_set_value($form['account']['notify'], 1, $form_state);
    }
  }
}

function school_administration_admin_validate($form, &$form_state) {
  $cyear = (int)$form_state['values']['school_administration_c_year'];
  if ($cyear <= 0) {
    form_set_error('school_administration_c_year', t("You must type a year"));
  }
  $sc_length = (int)$form_state['values']['school_administration_std_id_len'];
  if ($sc_length <= 0 || $sc_length > 9) {
    form_set_error('school_administration_std_id_len', t("You must type an integer less than 10"));
  }
}

function school_administration_student_withdraw_form_validate($form_id, &$form_state) {
  if ($form_state['values']['reason'] == '') {
    form_set_error('reason', t("You must select a reason"));
  }
  $school_no = explode('-', $form_state['values']['school_no']);
  foreach ($school_no as $st_no) {
    if (!school_administration_student($st_no)) {
      form_set_error('school_no', t("School No <b> !st </b> is not a registered student number...", array('!st' => $st_no)));
    }
  }
}

function school_administration_insert_portrait_form_validate($form_id, &$form_state) {
  if (!is_dir(DRUPAL_ROOT . '/sites/default/files/' . $form_state['values']['pdir'])) {
    form_set_error('pdir', t("directory named as '!path' is not exist", array('!path' => $form_state['values']['pdir'])));
  }
}

// ======================================
// Form Submit Functions:
// ======================================

/**
 * Perform registering new user.
 *
 * New user's name, surname and range should be set to register new user
 * name and surname will be used to produce username. password will be prodeced automaticaly.
 * user id for new user for 3 main groups of users:
 * students, staff and parents
 *
 * @param $name
 *    name of the user
 * @param $surname
 *    surname of the user
 * @param $range
 *    department digits to generate user id
 *
 * @return array
 *    returns an array of user information
 */
function school_administration_user_data_insert($values) {
  $userinfo = array(
    'name' => $values['name'],
    'pass' => $values['pass'],
    'init' => $values['name'],
    'status' => 1,
    'mail' => $values['mail'],
    'created' => REQUEST_TIME
  );
  if ($values['uid'] != 0) {
    $userinfo['uid'] = $values['uid'];
  }
  $user = user_save(drupal_anonymous_user(), $userinfo);
  drupal_set_message(
    t('@name is registered as <b>@role</b>.
      <br/>ID: @id',
      array('@name' => $user->name,
        '@id' => $user->uid,
        '@role' => $values['user_type'],
      )
    )
  );
  if (!empty($values['mail']) && variable_get('school_administration_new_user_options', 0) == 1) {
    //send registration e-mail
    _user_mail_notify('register_admin_created', $user);
    drupal_set_message(t('A welcome message with further instructions to access the system has been e-mailed to the new user.'));
  }
  else {
    //if no e-mail is provided during registration
    //print  username & password of new user with his/her role and uid on screen.
    drupal_set_message(t('username: @uname<br/>password: @pass', array('@uname' => $userinfo['name'], '@pass' => $userinfo['pass'])));
  }
  $user->pass = $userinfo['pass'];
  return $user;
}

function school_administration_insert_portrait_form_submit($form_id, &$form_state) {
  $path = DRUPAL_ROOT . '/sites/default/files/' . $form_state['values']['pdir'];
  $directory = opendir($path);
  $dirarray = array();
  while ($file = readdir($directory))  {
    $dirarray[] = $file;
  }
  closedir($directory);
  sort($dirarray);
  unset($dirarray[0], $dirarray[1]);
  $count = 0;
  foreach ($dirarray as $jpgfile) {
    //rename($path . '/' . $jpgfile, $path . '/' . substr($jpgfile, 1));
    //$jpgfile = substr($jpgfile, 1);
    $jpgfilepath = $path . '/' . $jpgfile;
    $fileparts = explode('.', $jpgfile);
    if (isset($fileparts[1]) && substr(strtolower($fileparts[1]), 0, 3) != 'jpg') {
      drupal_set_message(t("Please jpeg file for !uid.", array(':uid' => $fileparts[0])), 'warning');
      continue;
    }
    if (!is_numeric($fileparts[0])) {
      drupal_set_message(t('"!file" could not be inserted to DB because !uid is not a number.', array('!file' => $jpgfile, '!uid' => $fileparts[0])), 'warning');
      continue;
    }
    if (db_query("SELECT COUNT(*) FROM {users} WHERE uid = :uid", array(':uid' => $fileparts[0]))->fetchField() == 0) {
      drupal_set_message(t("!file could not be inserted to DB because !uid is not a registered user id.", array('!file' => $jpgfile, '!uid' => $fileparts[0])), 'warning');
      continue;
    }
    //$form_state['input']['values'] might have a bug it is not working in this case
    if ($form_state['input']['options']['face'] == 'face') {
      $face = ($form_state['input']['options']['method2'] == 'method2') ? 2 : 1;
    }
    else {
      $face = 0;
    }
    $size = ($form_state['values']['options']['size'] == 'size') ? 1 : 0;
    //find face and crop the image as portrait.
    if ($size > 0 || $face > 0) {
      $processed_jpgfilepath = school_administration_face_detect_crop_resize($jpgfilepath, $face, $size);
      $jpg = $processed_jpgfilepath;
    }
    else {
      $jpg = $jpgfilepath;
    }
    
    if (filesize($jpg) > 65536) {
      drupal_set_message(t("!file could not be inserted to DB because file size is larger than 64KB.", array('!file' => $jpgfile)), 'warning');
      continue;
    }

    //md5 same file check
    $fp = fopen($jpg, "r");
    $photo = fread($fp, filesize($jpg));
    fclose($fp);
    $md5 = md5_file($jpg);
    if (db_query("SELECT COUNT(*) FROM {school_administration_users_portraits} WHERE image_md5 = :md5", array(':md5' => $md5))->fetchField() > 1) {
      drupal_set_message(t("The same portrait image is exist for !uid. Image is not recorded.", array('!uid' => $fileparts[0])));
      continue;
    }
    
    if ($form_state['input']['options']['save'] == 'save') {
      db_insert('school_administration_users_portraits')
      ->fields(array(
        'photo' => $photo,
        'uid' => $fileparts[0],
        'image_md5' => $md5,
        'upload_date' => time(),
        )
      )
      ->execute();
      $count++;
      drupal_set_message(t("!file is inserted to DB.", array('!file' => $jpgfile)), 'status');
    }
    //delete temp files.
    if ($form_state['input']['options']['keep_temp'] != 'keep_temp') {
      unlink($processed_jpgfilepath);
    }
    //delete original file
    if ($form_state['input']['options']['keep_original'] != 'keep_original') {
      unlink($jpgfilepath);
    }
  }
  drupal_set_message(
    t("!num found and inserted to DB.",
    array('!num' => format_plural($count, '1 photo', '@count photos'))),
    'status');
}


function school_administration_student_withdraw_form_submit($form_id, &$form_state) {
  $node = $form_state['values'];
  $school_no = explode('-', $node['school_no']);
  $bl = (!empty($node['status'])) ? 'Blacklisted@@' : '';
  foreach ($school_no as $st_no) {
    $num = db_insert('school_administration_withdrawal')
      ->fields(array(
        'school_no' => $st_no,
        'academic_year' => SCHOOL_ADMINISTRATION_C_YEAR,
        'reason' => $node['reason'],
        'given_documents' => $node['doc'],
        'debt_of_student_left' => (float)$node['dept_left'],
        'notes' => $bl . $node['notes'],
      )
    )
    ->execute();
    $num_updated = db_update('school_administration_student_main')
      ->fields(array('withdraw_date' => $node['date']['year'] . '-' . $node['date']['month'] . '-' . $node['date']['day']))
      ->condition('school_no', $st_no, '=')
      ->execute();
    if ($form_state['values']['reason'] == variable_get('school_administration_graduation_tid')) {
      db_insert('school_administration_alumni')
      ->fields(array('school_no' => $st_no, 'graduation_year' => date('Y')))
      ->execute();
    }
    else {
      user_cancel(array('user_cancel_notify' => FALSE), $st_no, 'user_cancel_block');
    }
    drupal_set_message(t("The student with School No <b> :st </b> is withdrew...", array(':st' => $st_no)));
  }
}

function school_administration_staff_withdraw_form_submit($form_id, &$form_state) {
  $node = $form_state['values'];
  $num_updated = db_update('school_administration_staff_main')
    ->fields(array('withdraw_date' => $node['date']['year'] . '-' . $node['date']['month'] . '-' . $node['date']['day']))
    ->condition('staff_no', $node['staff_no'], '=')
    ->execute();
  user_cancel($edit = array(), $node['staff_no'], 'user_cancel_block');
  drupal_set_message(t("The staff with Staff No <b> :st </b> is withdrew...", array(':st' => $node['staff_no'])));
}

function school_administration_register_user(&$form, &$form_state) {
  global $user;
  $user_info = school_administration_user_data_insert($form_state['values']);
  //in case uid is drupal default
  $form_state['values']['uid'] = $user_info->uid;
  $form_state['values']['updater_uid'] = $user->uid;
  $form_state['values']['update_approved'] = 1;
  school_administration_identity_insert($form_state['values']);
  switch ($form_state['values']['user_type']) {

    //default value
    case 'register_new' :
    case 'student' :
      $parent_id = school_administration_student_write($form_state['values']);
      $form_state['redirect'] = "school_administration/register_new/parent/$parent_id/parent";
      break;
    
    case 'staff' :
      school_administration_staff_write($form_state['values']);
      drupal_set_message(l(t('You may add additional role(s)'), "user/$user_info->uid/edit"));
      break;
    
    case 'parent' :
      //do 2 dimentional array for each kid of the current parent
      $fields = array('relation', 'guardian', 'student_resides');
      foreach ($form_state['values'] as $field => $value) {
        $arr = explode('_', $field);
        $school_no = array_pop($arr);
        $field_name = implode('_', $arr);
        foreach ($fields as $field) {
          if ($field_name == $field) {
            $children[$school_no][$field] = $value;
          }
        }
      }
      //record for each kid
      foreach ($children as $school_no => $data) {
        $data['school_no'] = ($school_no == 0) ? $form_state['values']['school_no_0'] : $school_no;
        $parent_data = array_merge($data, $form_state['values']);
        school_administration_parent_write($parent_data);
      }
      $form_state['redirect'] = "school_administration/register_new/parent";
      break;
  }
}

// ======================================
// Storing Data:
// ======================================


/**
 * Perform registering student information of new student.
 *
 * @param $values
 *    array of identity info gathered from registration form
 *
 * @param $uid
 *    generated user id of registered user
 */
function school_administration_student_write($values, $primary_keys = array()) {
  $st_res = (isset($values['student_resides'])) ? $values['student_resides'] : '';
  //if the record is coming from student register form we need this
  if (!isset($values['uid'])) {
    $values['uid'] = 0;
  }
  $acd_year = (school_administration_register_to_next_year()) ? (SCHOOL_ADMINISTRATION_C_YEAR + 1) : SCHOOL_ADMINISTRATION_C_YEAR;
  $values = array(
    'school_no'               => $values['uid'],
    'academic_year'           => $acd_year,
    'enrollment_date'         => $values['enrollment_date']['year'] . '-' . $values['enrollment_date']['month'] . '-' . $values['enrollment_date']['day'],
    'level'                   => $values['level'],
    'entrance_exam_result'    => $values['entrance_exam_result'],
    'scholarship'             => $values['scholarship'],
    'scholarship_description' => $st_res,
  );
  if (empty($primary_keys)) {
    drupal_write_record('school_administration_student_main', $values);
    $proles = variable_get('school_administration_predefined_roles');
    db_insert('users_roles')->fields(array('uid' => $values['school_no'], 'rid' => $proles['student']['rid']))->execute();
    if(!empty($st_res)) {
      $values['student_resides'] = $st_res;
      //return parent_id of record parent to use at parent registration form
      return school_administration_student_reside_write($values);
    }
  }
  else {
    drupal_write_record('school_administration_student_main', $values, $primary_keys);
  }
}

/**
 * Perform registering parent information.
 *
 * @param $values
 *    array of identity info gathered from registration form
 *
 */
function school_administration_parent_write($values, $primary_keys = array()) {
  //if the record is coming from student register form we need this
  if (!isset($values['uid'])) {
    $values['uid'] = 0;
  }
  if (isset($values['reside_record_only'])) {
    $reside_only = $values['reside_record_only'];
  }
  $acd_year = (school_administration_register_to_next_year()) ? (SCHOOL_ADMINISTRATION_C_YEAR + 1) : SCHOOL_ADMINISTRATION_C_YEAR;
  $relations = variable_get('school_administration_relations');
  $values = array(
    'school_no'     => $values['school_no'],
    'relation'      => $values['relation'],
    'uid'           => $values['uid'],
    'guardian'      => $values['guardian'],
    'resides_with_student' => $values['student_resides'],
    'academic_year' => $acd_year,
  );
  //parent info is about to update
  if (!empty($primary_keys)) {
    drupal_write_record('school_administration_student_parents', $values, $primary_keys);
    return;
  }
  //record is coming from student register form
  if (isset($reside_only)) {
    $values['resides_with_student'] = 1;
    //return id of record to use at parent registration form
    return db_insert('school_administration_student_parents')->fields($values)->execute();
  }
  //parent is recorded during student registration or not
  $exist = FALSE;
  foreach (school_administration_parents_of_student($values['school_no']) as $parent) {
    if($values['relation'] == $parent->relation) {
      $exist = TRUE;
      $primary_keys = array('school_no', 'relation');
    }
  }
  //new parent record but parent is recorded during student registration
  if ($exist) {
    db_update('school_administration_student_parents')
    ->fields($values)
    ->condition('school_no', $values['school_no'])
    ->condition('relation', $values['relation'])
    ->execute();
    $proles = variable_get('school_administration_predefined_roles');
    db_insert('users_roles')->fields(array('uid' => $values['uid'], 'rid' => $proles['parent']['rid']))->execute();
  }
  //new parent record
  else {
    drupal_write_record('school_administration_student_parents', $values);
    $proles = variable_get('school_administration_predefined_roles');
    db_insert('users_roles')->fields(array('uid' => $values['uid'], 'rid' => $proles['parent']['rid']))->execute();
  }
}

/**
    drupal_write_record('school_administration_student_parents', $values, $primary_keys);
    //(2) check the parent is recorded during student registration or not
      db_update('school_administration_student_parents')
      ->fields($values)
      ->condition('school_no', $values['school_no'])
      ->condition('relation', $values['relation'])
      ->execute();
 * Perform registering parent information during student registration.
 *
 * @param $values
 *    array of identity info gathered from registration form
 *
 */
function school_administration_student_reside_write($values) {
  foreach ($values['student_resides'] as $relation) {
    if ($relation != 0) {
      $values['relation'] = $relation;
      $values['guardian'] = 0;
      $values['reside_record_only'] = 1;
      $parent_id[] = school_administration_parent_write($values);
    }
  }
  //return parent_id of first recorded parent to use at parent registration form
  return array_shift($parent_id);
}

/**
 * Perform registering staff information of new staff.
 *
 * @param $values
 *    array of staff info gathered from registration form
 *
 */
function school_administration_staff_write($values, $primary_keys = array()) {
  $acd_year = (school_administration_register_to_next_year()) ? (SCHOOL_ADMINISTRATION_C_YEAR + 1) : SCHOOL_ADMINISTRATION_C_YEAR;
  $values = array(
    'staff_no'      => $values['uid'],
    'academic_year' => $acd_year,
    'branch'        => $values['branch'],
    'start_date'    => $values['start_date']['year'] . '-' . $values['start_date']['month'] . '-' . $values['start_date']['day'],
    'contract_type' => $values['contract']
  );
  if (empty($primary_keys)) {
    drupal_write_record('school_administration_staff_main', $values);
    $proles = variable_get('school_administration_predefined_roles');
    db_insert('users_roles')->fields(array('uid' => $values['staff_no'], 'rid' => $proles['staff']['rid']))->execute();
  }
  else {
    drupal_write_record('school_administration_staff_main', $values, $primary_keys);
  }
}

/**
 * Perform registering identification information of new user.
 *
 * @param $values
 *   array of identity info gathered from registration form
 *
 */
function school_administration_identity_insert($values) {
  if (!isset($values['names']) || !isset($values['surname'])) {
    return;
  }
  $values['dob'] = $values['dob']['year'] . '-' . $values['dob']['month'] . '-' . $values['dob']['day'];
  $values['update_time'] = REQUEST_TIME;
  
  $schema = drupal_get_schema('school_administration_users_identities');
  $fields = array_keys($schema['fields']);
  //unset vid serial field
  unset($fields[0]);
  foreach ($fields as $field) {
    $vals[$field] = $values[$field];
  }
  db_insert('school_administration_users_identities')->fields($vals)->execute();
}

// ======================================
// Hook Functions:
// ======================================

/**
 * Implementation of hook_user_view
 */
function school_administration_user_view($account) {
  if(school_administration_identity_not_approved($account->uid)) {
    drupal_set_message(t('Your Identification info update is waiting for confirmation.'), 'warning');
  }
  if (isset($account->identity)) {
    $account->content['Identity']['photo'] =  array(
      '#type' => 'user_profile_item',
      '#title' => '',
      '#markup' => school_administration_portrait_photo_link($account->uid, array('width' => 150)),
      '#weight' => -2,
    );
    $account->content['Identity']['uid'] =  array(
      '#type' => 'user_profile_item',
      '#title' => t('ID Number:'),
      '#markup' => l($account->uid, "user/$account->uid/edit"),
      '#weight' => -1,
    );
    $account->content['Identity']['full_name'] =  array(
      '#type' => 'user_profile_item',
      '#title' => t('Full Name:'),
      '#markup' => school_administration_formatted_full_name($account->uid),
      '#weight' => 0,
    );
    $account->content['Identity']['dob'] =  array(
      '#type' => 'user_profile_item',
      '#title' => t('Date of Birth:'),
      '#markup' => format_date(strtotime($account->identity->dob), 'custom', 'l, j F Y'),
      '#weight' => 1,
    );
    $account->content['Identity']['nationality'] =  array(
      '#type' => 'user_profile_item',
      '#title' => t('Nationality:'),
      '#markup' => $account->identity->nationality,
      '#weight' => 2,
    );
    $account->content['Identity']['national_id_no'] =  array(
      '#type' => 'user_profile_item',
      '#title' => t('National ID No:'),
      '#markup' => $account->identity->national_id_no,
      '#weight' => 3,
    );
    $account->content['Identity']['pob'] =  array(
      '#type' => 'user_profile_item',
      '#title' => t('Place of Birth:'),
      '#markup' => $account->identity->pob,
      '#weight' => 4,
    );
    $account->content['Identity']['gender'] =  array(
      '#type' => 'user_profile_item',
      '#title' => t('Gender:'),
      '#markup' => $account->identity->gender,
      '#weight' => 5,
    );
    $account->content['Identity']['fathers_name'] =  array(
      '#type' => 'user_profile_item',
      '#title' => t("Father's Name:"),
      '#markup' => $account->identity->fathers_name,
      '#weight' => 6,
    );
    $account->content['Identity']['mothers_name'] =  array(
      '#type' => 'user_profile_item',
      '#title' => t("Mother's Name:"),
      '#markup' => $account->identity->mothers_name,
      '#weight' => 7,
    );
    $account->content['Identity']['home_address'] =  array(
      '#type' => 'user_profile_item',
      '#title' => t("Home Address:"),
      '#markup' => $account->identity->home_address,
      '#weight' => 8,
    );
  }
  if (isset($account->student)) {
    $account->content['Student']['level'] =  array(
      '#type' => 'user_profile_item',
      '#title' => t("Level:"),
      '#markup' => $account->student->level,
      '#weight' => 12,
    );
    if (!empty($account->student->scholarship)) {
      $account->content['Student']['scholarship'] =  array(
        '#type' => 'user_profile_item',
        '#title' => t("Scholarship:"),
        '#markup' => $account->student->scholarship,
        '#weight' => 12,
      );
    }
    if (!empty($account->student->scholarship_description)) {
      $account->content['Student']['scholarship'] =  array(
        '#type' => 'user_profile_item',
        '#title' => t("Scholarship Description:"),
        '#markup' => $account->student->scholarship_description,
        '#weight' => 12,
      );
    }
  }
  if (isset($account->staff)) {
    $options = school_administration_slice_predefined_roles($account->roles);
    $account->content['Staff']['job'] =  array(
      '#type' => 'user_profile_item',
      '#title' => t('Job:'),
      '#markup' => implode(', ', $options),
      '#weight' => 0,
    );
    $account->content['Staff']['branch'] =  array(
      '#type' => 'user_profile_item',
      '#title' => t('Department/Office/Branch:'),
      '#markup' => $account->staff->branch,
      '#weight' => 0,
    );
    $account->content['Staff']['start_date'] =  array(
      '#type' => 'user_profile_item',
      '#title' => t('Job Start Date:'),
      '#markup' => format_date(strtotime($account->staff->start_date), 'custom', "d F Y"),
      '#weight' => 1,
    );
    if (isset($account->staff->admin_job)) {
      $account->content['Staff']['admin_job'] =  array(
        '#type' => 'user_profile_item',
        '#title' => t('Administration Job:'),
        '#markup' => $account->staff->admin_job,
        '#weight' => 2,
      );
    }
  }
  if (isset($account->parenting)) {
    foreach ($account->parenting as $parent) {
      $relation = taxonomy_term_load($parent->relation);
      $rels[] = t('!relative of <b>!student</b>', array('!relative' => $relation->name, '!student' => l(school_administration_formatted_full_name($parent->school_no), "user/$parent->school_no")));
    }
    $account->content['parenting']['relations'] =  array(
      '#type' => 'user_profile_item',
      '#title' => t("Guardianship:"),
      '#markup' => implode('<br />', $rels),
      '#weight' => 12,
    );
  }
  if (isset($account->parents)) {
    foreach ($account->parents as $parent) {
      $relation = taxonomy_term_load($parent->relation);
      $row = $relation->name . ': <b>';
      $row .= l(school_administration_formatted_full_name($parent->uid), "user/$parent->uid") . '</b> ';
      if ($parent->guardian == 1) {
        $row .= t('(Guardian)');
      }
      $rels[] = $row;
    }
    $account->content['parents']['relations'] =  array(
      '#type' => 'user_profile_item',
      '#title' => t("Parents and gurdians:"),
      '#markup' => implode('<br />', $rels),
      '#weight' => 12,
    );
  }
  if (isset($account->siblings)) {
    foreach ($account->siblings as $sibling_school_no) {
      $sibs[] = '<b>' . l(school_administration_formatted_full_name($sibling_school_no), "user/$sibling_school_no") . '</b>';
    }
    $account->content['siblings']['sibling'] =  array(
      '#type' => 'user_profile_item',
      '#title' => t("Siblings:"),
      '#markup' => implode('<br />', $sibs),
      '#weight' => 12,
    );
  }
  if (isset($account->alumni)) {
    $account->content['Alumnus']['graduation_year'] =  array(
      '#type' => 'user_profile_item',
      '#title' => t("Graduation Year:"),
      '#markup' => $account->alumni->graduation_year,
      '#weight' => 12,
    );
    $account->content['Alumnus']['current_city'] =  array(
      '#type' => 'user_profile_item',
      '#title' => t("Current City:"),
      '#markup' => $account->alumni->current_city,
      '#weight' => 12,
    );
  }
}

/**
 * Implementation of hook_user_load
 */
function school_administration_user_load($users) {
  global $user;
  $result = db_query('SELECT * FROM {school_administration_users_identities} WHERE uid IN (:uids) AND update_approved=1 ORDER BY vid DESC', array(':uids' => array_keys($users)));
  foreach ($result as $record) {
    if (empty($users[$record->uid]->identity)) {
      $users[$record->uid]->identity = $record;
      $users[$record->uid]->identity->full_name = school_administration_formatted_full_name($record->uid);
      if (school_administration_identity_not_approved($record->uid)) {
        $result_not_app = db_query('SELECT * FROM {school_administration_users_identities} WHERE uid = :uid ORDER BY vid DESC', array(':uid' => $record->uid))->fetchObject();
        $users[$record->uid]->identity_not_approved = $result_not_app;
        if ($user->uid == $record->uid) {
          $users[$record->uid]->identity = $result_not_app;
        }
      }
    }
    if ($data = school_administration_student($record->uid)) {
      $users[$record->uid]->student = $data;
    }
    if ($data = school_administration_staff($record->uid)) {
      $users[$record->uid]->staff = $data;
    }
    if ($data = school_administration_alumnus($record->uid)) {
      $users[$record->uid]->alumni = $data;
    }
    if ($data = school_administration_childeren_of_parent($record->uid)) {
      $users[$record->uid]->parenting = $data;
    }
    if ($data = school_administration_parents_of_student($record->uid)) {
      $users[$record->uid]->parents = $data;
    }
    if ($data = school_administration_siblings_of_student($record->uid)) {
      $users[$record->uid]->siblings = $data;
    }
  }
}

/**
 * Implementation of hook_user_update
 */
function school_administration_user_update(&$edit, $account, $category) {
  //it is needless if the user is not registered via school_administration
  if (!isset($account->identity)) {
    return;
  }
  //it is needless if user is updated by other modules
  if (!isset($edit['user_type'])) {
    return;
  }
  GLOBAL $user;
  $edit['updater_uid'] = $user->uid;
  $edit['update_approved'] = 1;
  if (!user_access('change administrative info')) {
    $edit['update_approved'] = 0;
    drupal_set_message(t("Changes are submitted to an administrator to approve."));
  }

  //compare old and new record
  $d = explode('-', $account->identity->dob);
  $account->identity->dob = array('year' => $d[0], 'month' => $d[1], 'day' => $d[2]);
  $diff = school_administration_identity_not_approved_diff((array)$account->identity, $edit);
  //if there is change, record identity data
  if (!empty($diff)) {
    school_administration_identity_insert($edit);
  }
  
  //staff, student and parent data can be updated only by admin
  if (user_access('change administrative info')) {
    if (isset($account->student)) {
      school_administration_student_write($edit, 'school_no');
    }
    if (isset($account->staff)) {
      school_administration_staff_write($edit, 'staff_no');
    }
    if (isset($account->parenting)) {
      //do 2 dimentional array for each kid of the current parent
      $fields = array('relation', 'guardian', 'student_resides');
      foreach ($edit as $field => $value) {
        $arr = explode('_', $field);
        $school_no = array_pop($arr);
        $field_name = implode('_', $arr);
        foreach ($fields as $field) {
          if ($field_name == $field) {
            $children[$school_no][$field] = $value;
          }
        }
      }
      //record for each kid
      foreach ($children as $school_no => $data) {
        $data['school_no'] = $school_no;
        $parent_data = array_merge($data, $edit);
        school_administration_parent_write($parent_data, array('school_no', 'relation'));
      }
    }
  }
}


// ======================================
// Theme Functions:
// ======================================

function school_administration_theme() {
  return
  array(
    'school_administration_display_academic_year' => array(
      'arguments' => array(
        'academic_year' => NULL,
       )
    ),
    'school_administration_list_block' => array(
      'arguments' => array(
        'op' => NULL,
        'list' => array(),
      )
    ),
    'school_administration_portrait_photo_block' => array(
      'arguments' => array(
        'image' => NULL,
        'name' => NULL,
      )
    ),
  );
}

/**
 * Theming Displaying Academic Year
 */
function theme_school_administration_display_academic_year($input) {
  drupal_add_css(".academic_year { line-height : 55px; font-size : 18px; }", 'inline');
  $output = '<div class="academic_year">';
  $output .= $input['academic_year'];
  $output .= '</div>';
  return $output;
}

/**
 * Theming Displaying Portrait Photo
 */
function theme_school_administration_portrait_photo_block($input) {
  drupal_add_css(".portrait_photo { line-height : 22px; font-size : 12px; text-align:center; }", 'inline');
  $output = '<div class="portrait_photo">';
  $output .= t('Welcome');
  $output .= ', <b>';
  $output .= $input['name'];
  $output .= '</b><br />';
  $output .= $input['image'];
  $output .= '</div>';
  return $output;
}

/**
 * Theming Class List Block
 */
function theme_school_administration_list_block($input) {
  switch ($input['op']) {
    case 'groups':
      $groups = array();
      foreach ($input['data'] as $group) {
        $groups[] = '[' . $group . ']';
      }
      return implode(' ', $groups);

    case 'members':
      $output = array();
      $i = 1;
      foreach ($input['data'] as $member) {
        $output[] = $i . ') ' . $member;
        $i++;
      }
      return implode('<br>', $output);

    default :
      return '';
  }
}