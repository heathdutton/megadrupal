<?php
/**
 * @file : jquery_twitter_search.test
 * Tests the functionality of jQuery twitter search module.
 * @TODO : fix Drupal.org test run issue, and implement more testing scenarios
 */
class JqueryTwitterSearchTestCase extends DrupalWebTestCase {
  protected $privileged_user;
  protected $regions;

  public static function getInfo() {
    return array(
      'name' => 'jQuery twitter search',
      'description' => 'Ensure that the jQuery twitter search provided a proper functionality.',
      'group' => 'jQuery twitter search'
    );
  }

  public function setUp() {
    parent::setUp(array('libraries', 'jquery_twitter_search'));
    $this->privileged_user = $this->drupalCreateUser (
      array(
        'administer jquery twitter search',
        'administer blocks'
      )
    );
    
    $this->drupalLogin($this->privileged_user);

    $this->regions = array();
    $this->regions[] = 'header';
    $this->regions[] = 'sidebar_first';
    $this->regions[] = 'content';
    $this->regions[] = 'sidebar_second';
    $this->regions[] = 'footer';

  }

  public function testJqueryTwitterSearchPermission() {
    $data = module_invoke('jquery_twitter_search', 'permission');
    $this->assertTrue(is_array($data), t('Permission hook returns array.'));
    $this->assertTrue(array_key_exists('administer jquery twitter search', $data), t('Setup permission pass.'));
  }

  public function testJqueryTwitterSearchCreateBlock() {
    $this->assertNoText(t('Please Make sure that you have jquery.twitter.search.js'));
    // Fill out jquery twitter search admin form.
    $edit = array();
    $edit['jqueryts_title'] = 'jQuery block title';
    $edit['jqueryts_term'] = 'jQuery';
    $this->drupalPost('admin/config/services/jquery-twitter-search/edit', $edit, t('Save'));
    $this->assertText(format_string('Block @block_title have been saved.', array('@block_title' => $edit['jqueryts_term'])));

    //add the block to content region.
    $block = db_select('jquery_twitter_search', 'jqts')->fields('jqts', array('delta'))->condition('delta', 1)->execute()->fetch();
    $title = $edit['jqueryts_term'];
    $edit = array();
    $edit['blocks[jquery_twitter_search_' . $block->delta . '][region]'] = $this->regions[2];
    $this->drupalPost('admin/structure/block', $edit, t('Save blocks'));
    $this->drupalGet('node');
    $cleanup = FALSE;     
    //create libraries folder if not exsits. 
    $filename ='sites/all/libraries/jquery_twitter_search/jquery.twitter.search.js';
    if (!file_exists($filename)) {
      $this->assertText('Please Make sure that you have jquery.twitter.search.js'); drupal_mkdir('sites/all/libraries');
      drupal_mkdir('sites/all/libraries/jquery_twitter_search');
      $jquery_twitter_search_js = fopen('https://raw.github.com/malsup/twitter/master/jquery.twitter.search.js', 'r');       
      file_put_contents($filename, $jquery_twitter_search_js); 
      $cleanup =TRUE;     
    }
    
    $this->drupalGet('node');
    $this->assertNoText('Please Make sure that you have jquery.twitter.search.js'); 
    $this->assertText($title);

    if ($cleanup) {
      //cleanup after the test.
      drupal_unlink('sites/all/libraries/jquery_twitter_search/jquery.twitter.search.js');
      drupal_rmdir('sites/all/libraries/jquery_twitter_search');
      drupal_rmdir('sites/all/libraries');
    }
  }
}