<?php

/**
 * @file
 * mojeID module adds mojeID branding to Drupal openid forms and adds some
 * features for better integration with the mojeID provider.
 *
 * Read more about mojeID (the OpenID provider ) - http://mojeid.cz/
 *
 * @author Vojtech Kusy - http://vojtechkusy.com/
 *
 * CREDITS
 *  - Initial development sponsored by NIC.CZ - http://www.nic.cz/
 *  - Developed by Ants! - http://atomicant.co.uk/
 */

//=============================================================================
//  DEFINITIONS
//=============================================================================

/**
 * Name of the mojeID domain.
 */
define('MOJEID_SERVER', 'mojeid.cz');
define('MOJEID_SERVER_TEST', 'mojeid.fred.nic.cz');

/**
 * URL to mojeID endpoint.
 */
define('MOJEID_ENDPOINT', 'https://mojeid.cz/endpoint/');
define('MOJEID_ENDPOINT_TEST', 'https://mojeid.cz/endpoint/');

/**
 * URL to mojeID registration endpoint.
 */
define('MOJEID_REGISTRATION_ENDPOINT', 'https://mojeid.cz/registration/endpoint/');
define('MOJEID_REGISTRATION_ENDPOINT_TEST', 'https://mojeid.fred.nic.cz/registration/endpoint/');

/**
 * URL when user can create new mojeID account.
 */
define('MOJEID_URL_CREATE_ACCOUNT', 'http://www.mojeid.cz/page/795/');

/**
 * URL to "What is mojeID" page.
 */
define('MOJEID_URL_ABOUT', 'http://www.mojeid.cz/page/805/');

//=============================================================================
//  DRUPAL HOOKS
//=============================================================================


/**
 * Implements hook_permission().
 */
function mojeid_permission() {
  return array('administer mojeid' => array(
      'title' => t('Administer mojeID'),
      'description' => t('Perform administration tasks for mojeID module.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function mojeid_menu() {
  $items = array();

  $items['admin/config/people/mojeid'] = array(
    'title' => 'mojeID settings',
    'description'  => 'Configure mojeID settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('mojeid_admin_settings'),
    'access arguments' => array('administer mojeid'),
    'file' => 'mojeid.admin.inc',
  );

  $items['admin/config/people/mojeid/settings'] = array(
    'title' => 'Settings',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -2,
  );

  return $items;
}

/**
 * Implements hook_help().
 */
function mojeid_help($path, $arg) {
  switch ($path) {
    case 'user/%/openid':
      $output = '<p>' . t('This site supports <a href="@moje-id-cz">mojeID</a>, which adds some more features to OpenID protocol.', array('@moje-id-cz' => 'http://mojeid.cz')) . '</p>';
      $output .= '<p>' . t('If you already have a mojeID, enter the URL to your mojeID server below (e.g. myusername.mojeid.cz). Next time you login, you will be able to use this URL instead of a regular username and password.') . '</p>';
      return $output;

    case 'admin/help#openid':
      $output = '<p>' . t('This site supports <a href="@moje-id-cz">mojeID</a>, which adds some more features to OpenID protocol.', array('@moje-id-cz' => 'http://mojeid.cz')) . '</p>';
      $output .= '<p>' . t('If you already have a mojeID, enter the URL to your mojeID server below (e.g. myusername.mojeid.cz). Next time you login, you will be able to use this URL instead of a regular username and password.') . '</p>';
      $output .= '<p>' . t('The basic concept of the mojeID usage is the same as with OpenID described above.') . '</p>';
      $output .= '<p>' . t('More information on mojeID (e.g. how it differs from regular OpenID) is available at <a href="@moje-id-cz">mojeID</a> (the site is in Czech and English).', array('@moje-id-cz' => 'http://mojeid.cz')) . '</p>';
      return $output;
  }
}

/**
 * Implements hook_form_alter().
 *
 * Adds OpenID selector to the OpenID forms.
 */
function mojeid_form_alter(&$form, &$form_state, $form_id) {
  // Dispatch.
  if (in_array($form_id, array('user_login_block', 'user_login'))) {
    module_load_include('inc', 'mojeid');
    _mojeid_form_alter_user_login($form, $form_state, $form_id);
  }
  elseif ($form_id === 'user_register_form') {
    module_load_include('inc', 'mojeid');
    _mojeid_form_alter_user_register($form, $form_state, $form_id);
  }
  elseif ($form_id === 'openid_user_add') {
    module_load_include('inc', 'mojeid');
    _mojeid_form_alter_openid_user_add($form, $form_state, $form_id);
  }
  elseif ($form_id === 'openid_redirect_form') {
    unset($form['form_id'], $form['form_build_id'], $form['form_token']);
    if (variable_get('mojeid_logging', FALSE)) {
      watchdog('mojeid', 'OpenId redirect form: @form', array('@form' => print_r($form, TRUE)), WATCHDOG_DEBUG);
    }
  }
}

/**
 * Implements hook_openid().
 */
function mojeid_openid($op, $request = array()) {
  // Add our information to the request if op is request and we are enabled.
  if ($op == 'request') {
    $mojeid_domain = variable_get('mojeid_server', MOJEID_SERVER);
    if (strpos($request['openid.identity'], ".$mojeid_domain") !== FALSE) {
      // Authentication policy.
      $request['openid.ns.pape'] = 'http://specs.openid.net/extensions/pape/1.0';
      // Max age of the last autentization.
      $request['openid.pape.max_auth_age'] = 3600;
      // See http://schemas.openid.net/pape/policies/2007/06/phishing-resistant.
      $request['openid.pape.preferred_auth_policies'] = '';

      // Add required AX elements.
      // @todo Rework this, AX elemets could be managed by the Drupal core itself.
      if (module_exists('openid_client_ax')) {
        $ax = variable_get('openid_client_ax_alias', 'ax');
        $required = array_filter(variable_get('mojeid_required', array()));
        foreach ($required as $required_key => $required_element) {
          // Remove required elements which aren't used in the request
          $ax_element = sprintf('openid.%s.type.%s', $ax, $required_element);
          if (empty($request[$ax_element])) {
            unset($required[$required_key]);
          }
        }
        if (!empty($required)) {
          $request[sprintf('openid.%s.required', $ax)] = implode(',', $required);
        }
      }

      if (variable_get('mojeid_logging', FALSE)) {
        watchdog('mojeid', 'mojeID request: @data', array('@data' => print_r($request, TRUE)));
      }

      return $request;
    }
  }
}

/**
 * Implements hook_theme().
 */
function mojeid_theme($existing, $type, $theme, $path) {
  return array(
    'mojeid_button_links' => array(
      'variables' => array(),
      'file' => 'mojeid.theme.inc',
    ),
  );
}

/**
 * Implements hook_openid_ax_schema() from OpenID Client AX module.
 *
 * Create an array containing the MojeID identifiers NOT listed in AX
 * http://www.axschema.org/types/
 *
 * Similar to openid_client_ax_schema_definitions()
 *
 * @return
 *   Array containing the schema definitions
 */
function mojeid_openid_client_ax_schema() {
  module_load_include('inc', 'mojeid');
  return _mojeid_openid_client_ax_schema();
}

/**
 * Implementation of hook_xrds(); Simple XRDS module.
 *
 * Return a XRDS for Attribute Exchange service discovery.
 */
function mojeid_xrds($account = NULL) {
  $xrds = array();
  $xrds['mojeid_return_to'] = array(
    'services' => array(
      array(
        'priority' => 10,
        'data' => array(
          'Type' => array('http://specs.openid.net/auth/2.0/return_to'),
          'URI' => array(url('', array('absolute' => TRUE))),
         ),
      )
    )
  );

  return $xrds;
}
