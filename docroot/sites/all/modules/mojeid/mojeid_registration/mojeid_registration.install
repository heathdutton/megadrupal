<?php

/**
 * Implements hook_requirements().
 */
function mojeid_registration_requirements($phase) {
  $requirements = array();

  if ($phase == 'runtime') {
    if (!variable_get('https', FALSE)) {
      $requirements['mojeid_registration'] = array(
        'severity' => REQUIREMENT_WARNING,
        'title' => t('mojeID SSL'),
        'value' => t('Disabled'),
        'description' => t("HTTPS isn't enabled. You'll will not be able to receive secure response from the mojeID provider after user's successful registration. Please <a href=\"@url\">configure your web server to allow SSL connection</a> and place the following code at the end of site's settings.php file: <code>\$conf['https'] = TRUE;</code>", array('@url' => 'http://drupal.org/https-information')),
      );
    }
    else {
      $requirements['mojeid_registration'] = array(
        'severity' => REQUIREMENT_OK,
        'title' => t('mojeID SSL'),
        'value' => t('Enabled'),
      );
    }
  }

  return $requirements;
}

/**
 * Implements hook_schema().
 */
function mojeid_registration_schema() {

  $schema['mojeid_nonce'] = array(
    'description' => 'Stores created registration_nonce to prevent various attacks.',
    'fields' => array(
      'nonce' => array(
        'type' => 'varchar',
        'length' => 255,
        'description' => 'The value of registration_nonce.',
      ),
      'expires' => array(
        'type' => 'int',
        'not null' => TRUE,
        'default' => 0,
        'description' => 'A Unix timestamp indicating when the entry should expire.',
      ),
    ),
    'indexes' => array(
      'nonce' => array('nonce'),
      'expires' => array('expires'),
    ),
  );

  return $schema;
}

/**
 * Implementation of hook_install().
 */
function mojeid_registration_install() {
  // Put mojeid module after openid and mojeid in the drupal alter call chain.
  // More about this: http://drupal.org/node/110238
  db_query("UPDATE {system} SET weight = 3 WHERE type = 'module' AND name = 'mojeid_registration'");
}

/**
 * Implementation of hook_uninstall().
 */
function mojeid_registration_uninstall() {
  variable_del('mojeid_registration');
  variable_del('mojeid_registration_page_title');
  variable_del('mojeid_registration_page_body');
  variable_del('mojeid_registration_page_body_format');
  variable_del('mojeid_registration_page_path');
}
