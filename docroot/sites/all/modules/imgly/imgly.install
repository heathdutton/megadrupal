<?php
/**
 * @file
 * Imgly installation hooks.
 */

/**
 * Implements hook_install().
 *
 * Alter module weight, create image styles, define and attach fields.
 */
function imgly_install() {
  // Change module's weight to make sure it runs after the path module.
  db_query("UPDATE {system} SET weight = 1 WHERE name = 'imgly'");
  drupal_set_message(t('Imgly module weight has been updated.'));

  // Create image styles.
  foreach (_imgly_styles() as $s) {
    $style = image_style_save(array('name' => $s['name']));

    foreach ($s['effects'] as $effect) {
      $effect['isid'] = $style['isid'];
      image_effect_save($effect);
    }
  }

  // Create all fields.
  foreach (_imgly_fields() as $field) {
    field_create_field($field);
  }

  // Create all field instances.
  foreach (_imgly_instances() as $instance) {
    $instance['entity_type'] = 'node';
    $instance['bundle'] = 'imgly';
    field_create_instance($instance);
  }
}

/**
 * Implements hook_uninstall().
 *
 * Cleanup variables.
 */
function imgly_uninstall() {
  // Delete variables.
  variable_del('imgly_powered');
  variable_del('imgly_counter');
  variable_del('imgly_index');

  // Find imgly nodes.
  $result = db_select('node', 'n')->fields('n', array('nid'))->condition('type', 'imgly', '=')->execute();
  $nids = array();

  foreach ($result as $row) {
    $nids[] = $row->nid;
  }

  // Delete all nodes at once.
  node_delete_multiple($nids);

  // Find and delete all field instances.
  // Fields will automatically get deleted once there no instances left.
  $instances = field_info_instances('node', 'imgly');
  foreach ($instances as $instance) {
    field_delete_instance($instance, TRUE);
  }

  // Delete content type.
  node_type_delete('imgly');

  // Delete image style and replace any lingering instances with Drupal core image style.
  image_style_delete(image_style_load('imgly'), 'large');

  // Purge all field infromation.
  field_purge_batch(1000);
}