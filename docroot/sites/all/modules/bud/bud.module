<?php

/**
 * Implements hook_menu().
 */
function bud_menu() {
  $items['admin/structure/block/move/nojs/%'] = array(
    'title' => 'Move up',
    'page callback' => 'bud_block_move',
    'page arguments' => array(4, 5),
    'access arguments' => array('administer blocks'),
    'theme callback' => 'ajax_base_page_theme',
    'type' => MENU_CALLBACK,
  );
  $items['admin/structure/block/disable/nojs/%'] = array(
    'title' => 'Disable',
    'page callback' => 'bud_block_disable',
    'page arguments' => array(4, 5),
    'access arguments' => array('administer blocks'),
    'theme callback' => 'ajax_base_page_theme',
    'type' => MENU_CALLBACK,
  );
  $items['admin/structure/block/move/ajax/%'] = array(
    'delivery callback' => 'ajax_deliver'
  ) + $items['admin/structure/block/move/nojs/%'];

  $items['admin/structure/block/disable/ajax/%'] = array(
    'delivery callback' => 'ajax_deliver'
  ) + $items['admin/structure/block/disable/nojs/%'];

  return $items;
}

/**
 * Implements hook_contextual_links_view_alter().
 */
function bud_contextual_links_view_alter(&$element, $items) {
  if(isset($element['#element']['#block'])) {
    drupal_add_library('system', 'drupal.ajax');

    $element['#links']['bud-up'] = array(
      'title' => t('!arrow Move up', array('!arrow' => '&#8593;')),
      'attributes' => array('class' => array('use-ajax')),
      'html' => TRUE,
      'href' => url('admin/structure/block/move/nojs/' . $element['#element']['#block']->bid . '/up', array('absolute' => TRUE, 'query' => array('tok' => drupal_get_token('bud_block_move' . $element['#element']['#block']->bid)) + drupal_get_destination())),
    );
    $element['#links']['bud-down'] = array(
      'title' => t('!arrow Move down', array('!arrow' => '&#8595;')),
      'attributes' => array('class' => array('use-ajax')),
      'html' => TRUE,
      'href' => url('admin/structure/block/move/nojs/' . $element['#element']['#block']->bid . '/down', array('absolute' => TRUE, 'query' => array('tok' => drupal_get_token('bud_block_move' . $element['#element']['#block']->bid)) + drupal_get_destination()))
    );
    $element['#links']['bud-disable'] = array(
      'title' => t('!disable Disable', array('!disable' => '&#8855;')),
      'attributes' => array('class' => array('use-ajax')),
      'html' => TRUE,
      'href' => url('admin/structure/block/disable/nojs/' . $element['#element']['#block']->bid, array('absolute' => TRUE, 'query' => array('tok' => drupal_get_token('bud_block_disable' . $element['#element']['#block']->bid)) + drupal_get_destination()))
    );
  }
}

/**
 * Menu callback.
 */
function bud_block_move($ajax, $bid, $direction) {
  $is_ajax = $ajax == 'ajax';

  if (empty($_GET['tok']) || !drupal_valid_token($_GET['tok'], 'bud_block_move' . $bid)) {
    return MENU_ACCESS_DENIED;
  }

  // Get the region of the block to move.
  $query = db_select('block', 'b');
  $query->condition('b.bid', $bid);
  $query->fields('b', array('region'));
  $region = $query->execute()->fetchField();

  // Get in an array all the blocks that are displayed
  // in the specified region for the current user only.
  $blocks = block_list($region);

  $block_ids = array();

  foreach($blocks as $block){
    $block_ids[] = $block->bid;
  }

  $index1 = array_search($bid, $block_ids);
  $blocks = array_values($blocks);

  if ($direction == 'up') {
    $index2 = $index1 - 1;
  } else {
    $index2 = $index1 + 1;
  }

  if ($index2 < 0 || $index2 > count($blocks)) {
    return;
  }

  // Reorder the $blocks array to save into the DB.
  $temp = $blocks[$index1];
  $blocks[$index1] = $blocks[$index2];
  $blocks[$index2] = $temp;

  $i = 0;
  $inc = count($blocks);
  // Reorder them properly using weight.
  foreach ($blocks as $instance) {
    $i += $inc;
    db_update('block')
      ->condition('bid', $instance->bid)
      ->fields(array('weight' => $i))
      ->execute();
  }

  if ($is_ajax) {

    if ($direction == 'up') {
      $block1 = '#' . drupal_clean_css_identifier('block-'.$blocks[$index2]->module . '_' . $blocks[$index2]->delta);
      $block2 = '#' . drupal_clean_css_identifier('block-'.$blocks[$index1]->module . '_' .$blocks[$index1]->delta);
    } else {
      $block1 = '#' . drupal_clean_css_identifier('block-'.$blocks[$index1]->module . '_' . $blocks[$index1]->delta);
      $block2 = '#' . drupal_clean_css_identifier('block-'.$blocks[$index2]->module . '_' .$blocks[$index2]->delta);
    }

    return array(
      '#type' => 'ajax',
      '#commands' => array(
        array(
          'command' => 'bud_block_move',
          'block1' => $block1,
          'block2' => $block2,
        ),
        ajax_command_changed($block1),
        ajax_command_changed($block2),
      )
    );
  } else {
    // Redirect to the page.
    drupal_goto();
  }
}

/**
 * Menu callback.
 */
function bud_block_disable($ajax, $bid) {
  $is_ajax = $ajax == 'ajax';

  if (empty($_GET['tok']) || !drupal_valid_token($_GET['tok'], 'bud_block_disable' . $bid)) {
    return MENU_ACCESS_DENIED;
  }

  if (is_numeric($bid)) {
    $block = db_select('block', 'b')
      ->fields('b')
      ->condition('bid', $bid)
      ->condition('status', 1)
      ->execute()->fetchAssoc();

    db_update('block')
      ->condition('bid', $bid)
      ->fields(array('status' => 0))
      ->execute();
  }

  if ($is_ajax) {
    $commands[] = ajax_command_remove('#'.drupal_clean_css_identifier('block-'.$block['module'].'_'.$block['delta']));

    return array(
      '#type' => 'ajax',
      '#commands' => $commands
    );
  } else {
    // Redirect to the page.
    drupal_goto();
  }
}
