<?php

/**
 * @file
 * Controls the visual building blocks a page is constructed with.
 */
include_once libraries_get_path('sweetCaptcha') . '/sweetcaptcha.php';

/**
 * Implements hook_menu().
 */
function sweetcaptcha_menu() {
  $items = array();
  $items['admin/config/sweetcaptcha'] = array(
    'title' => 'Sweetcaptcha',
    'description' => 'Sweetcapcha form settings',
    'access arguments' => array('administer nodes'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('sweetcaptcha_admin_settting_form'),
    'file' => 'sweetcaptcha.admin.inc',
  );

  return $items;
}

/**
 * @param type $form
 * @param type $form_state
 * @param type $form_id
 */
function sweetcaptcha_form_alter(&$form, &$form_state, $form_id) {
  if (file_exists(libraries_get_path('sweetCaptcha') . '/sweetcaptcha.php')) {
    $sweetcaptcha_form_ids = str_replace(" ", "", variable_get("sweetcaptcha_form_id", NULL));
    if ($sweetcaptcha_form_ids) {
      $sweetcaptcha_form_id_array = explode(',', $sweetcaptcha_form_ids);
      if (in_array($form_id, $sweetcaptcha_form_id_array)) {
        $sweetcapcha = new Sweetcaptcha(
            variable_get("sweetcaptcha_app_id", NULL), variable_get("sweetcaptcha_key", NULL), variable_get("sweetcaptcha_secret_key", NULL), variable_get("sweetcaptcha_public_url", NULL)
        );
        $sweetcapcha_output = $sweetcapcha->get_html();
        $return_value = drupal_json_decode($sweetcapcha_output);
        if (isset($return_value['error'])) {
          return;
        }
        $form['sweetcaptcha'] = array(
          '#type' => 'markup',
          '#markup' => $sweetcapcha_output,
        );
        $form['#validate'][] = "sweetcaptcha_form_submit";
      }
    }
  }
}

/**
 * 
 * @param type $form
 * @param type $form_state
 * @return boolean
 */
function sweetcaptcha_form_submit($form, $form_state) {
  // print_r($form_state['input']); die;
  $sweetcapcha = new Sweetcaptcha(
      variable_get("sweetcaptcha_app_id", NULL), variable_get("sweetcaptcha_key", NULL), variable_get("sweetcaptcha_secret_key", NULL), variable_get("sweetcaptcha_public_url", NULL)
  );
  $sweet_capcha_value = $sweetcapcha->check(
      array(
        'sckey' => $form_state['input']['sckey'],
        'scvalue' => $form_state['input']['scvalue'])
  );
  //print_r($sweet_capcha_value); die;
  if (isset($form_state['input']['sckey']) &&
      isset($form_state['input']['scvalue']) &&
      $sweet_capcha_value == "true") {
    
  }
  else {
    form_set_error('sweetcaptcha', t("Invalid captcha, Please try again"));
  }
}
