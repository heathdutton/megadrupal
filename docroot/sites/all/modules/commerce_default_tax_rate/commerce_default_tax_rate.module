<?php


function commerce_default_tax_rate_settings_form($form, &$form_state) {

  $form['default_rate'] = array(
    '#type' => 'select',
    '#title' => t('Default rate'),
    '#options' => commerce_tax_rate_titles(),
    '#default_value' => variable_get('commerce_default_tax_rate_default'),
    '#description' => t('Select your default tax rate.'),
  );

  $form['actions']['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save configuration'),
  );

  return $form;
}


function commerce_default_tax_rate_settings_form_submit($form, &$form_state) {

  variable_set('commerce_default_tax_rate_default', $form_state['values']['default_rate']);

  entity_defaults_rebuild();
  drupal_set_message(t('Default tax rate has been saved.'));
}


function commerce_default_tax_rate_menu() {

  $items = array();
  $items['admin/commerce/config/taxes/commerce_default_tax_rate'] = array(
    'title' => 'Default tax rate (sitewide)',
    'description' => 'Select a default tax rate',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('commerce_default_tax_rate_settings_form'),
    'access arguments' => array('administer commerce_default_tax_rate settings'),
    'weight' => 100,
    'type' => MENU_LOCAL_TASK,
   );
  return $items;
}


function commerce_default_tax_rate_form_alter(&$form, &$form_state, $form_id) {

  if (strpos($form_id, 'node_form')) {
    $form['field_product'][LANGUAGE_NONE]['form']['commerce_price'][LANGUAGE_NONE]['0']['include_tax']['#default_value'] = variable_get('commerce_default_tax_rate_default');
  }
  elseif ('commerce_product_ui_product_form' == $form_id) {
    if (isset($form['#entity']->is_new)) {
      $form['commerce_price'][LANGUAGE_NONE]['0']['include_tax']['#default_value'] = variable_get('commerce_default_tax_rate_default');
    }
  }
}
