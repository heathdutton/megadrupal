<?php

/**
 * @file
 * Contains class iDEALTestUpgradePathWebTestCase.
 */

/**
 * Test iDEAL's update path.
 */
class iDEALTestUpdatePathWithContentWebTestCase extends UpdatePathTestCase {

  static function getInfo() {
    return array(
      'description' => '',
      'name'  => 'Update path (with existing content and configuration)',
      'group' => 'iDEAL',
      'dependencies' => array('ideal_test'),
    );
  }

  function setUp() {
    $this->profile = 'testing';
    $this->databaseDumpFiles = array(
      drupal_get_path('module', 'ideal') . '/ideal-database-dump.php',
      drupal_get_path('module', 'ideal') . '/ideal-database-dump-content.php',
    );
    parent::setUp();
    // Re-register the autoload functions that were unregistered by
    // UpdatePathTestCase::setUp(), because it also loads some module files
    // that work with classes.
    spl_autoload_register('drupal_autoload_class');
    spl_autoload_register('drupal_autoload_interface');
    registry_rebuild();
  }

  /**
   * Test a successful update.
   */
  function testiDEALUpdate() {
    $this->assertTrue($this->performUpgrade(), 'The update was completed successfully.');
    foreach (entity_load('payment_method') as $payment_method) {
      if ($this->assertTrue($payment_method instanceof PaymentMethod)) {
        $this->assertTrue($payment_method->controller instanceof iDEALVersion2PaymentMethodController);
      }
    }
    foreach (entity_load('payment') as $payment) {
      $this->assertTrue($payment instanceof Payment);
    }
  }
}