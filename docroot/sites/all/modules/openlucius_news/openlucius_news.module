<?php
/**
 * @file
 * Code for the OpenLucius news feature.
 */

include_once 'openlucius_news.features.inc';
include_once 'includes/blocks.inc';
include_once 'includes/forms.inc';
include_once 'includes/processing.inc';

/**
 * Implements hook_permission().
 */
function openlucius_news_permission() {
  return array(
    'promote news' => array(
      'title'       => t('Promote news'),
      'description' => t("Permission to promote news"),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function openlucius_news_menu() {

  // Initialize items.
  $items = array();

  $items['news-items']          = array(
    'page callback'    => 'openlucius_news_build_news_items_display',
    'type'             => MENU_NORMAL_ITEM,
    'access arguments' => array('access content'),
    'file'             => 'functions.inc',
    'file path'        => drupal_get_path('module', 'openlucius_news') . '/includes',
  );
  $items['promoted-news-items'] = array(
    'page callback'    => 'openlucius_news_build_promoted_news_items_display',
    'type'             => MENU_NORMAL_ITEM,
    'access arguments' => array('access content'),
    'file'             => 'functions.inc',
    'file path'        => drupal_get_path('module', 'openlucius_news') . '/includes',
  );

  // Page for default group/team configuration.
  $items['admin/config/openlucius/news'] = array(
    'title'            => 'News settings',
    'description'      => 'Configure news settings.',
    'page callback'    => 'drupal_get_form',
    'page arguments'   => array('openlucius_news_configuration_form'),
    'access arguments' => array('administer openlucius configuration'),
    'type'             => MENU_LOCAL_TASK,
    'tab_parent'       => 'admin/config/openlucius',
    'file'             => 'forms.inc',
    'file path'        => drupal_get_path('module', 'openlucius_news') . '/includes',
  );

  // Return items.
  return $items;
}

/**
 * Implements hook_theme().
 */
function openlucius_news_theme() {
  return array(
    'openlucius_news_news_item'          => array(
      'variables' => array('vars' => NULL),
      'template'  => 'templates/openlucius_news_news_item',
    ),
    'openlucius_news_news_items'         => array(
      'variables' => array('vars' => NULL),
      'template'  => 'templates/openlucius_news_news_items',
    ),
    'openlucius_news_promoted_news_item' => array(
      'variables' => array('vars' => NULL),
      'template'  => 'templates/openlucius_news_promoted_news_item',
    ),
  );
}

/**
 * Implements openlucius_core_tabs_alter().
 */
function openlucius_news_openlucius_core_tabs_alter(&$items) {

  // Get the count of unread items.
  $unread_count = openlucius_core_fetch_unread_count('ol_news');

  // Build item.
  $item = array(
    'list-class' => '',
    'target'     => 'news',
    'title'      => t('News'),
    'link-class' => 'news',
  );

  if ($unread_count > 0) {

    // Fetch unread.
    $unread = openlucius_core_fetch_unread_count('ol_news', TRUE);

    // Add unread.
    $item['unread'] = $unread;
    $item['mark_read'] = 'ol_news';
  }

  // Add item to front-page tabs for news.
  $items[] = $item;
}

/**
 * Implements hook_openlucius_core_content_types_with_signature_alter().
 */
function openlucius_news_openlucius_core_content_types_with_signature_alter(&$content_types) {
  $content_types[] = 'ol_news';
}

/**
 * Implements hook_openlucius_core_content_types_with_like_button_alter().
 */
function openlucius_news_openlucius_core_content_types_with_like_button_alter(&$content_types) {
  $content_types[] = 'ol_news';
}

/**
 * Implements hook_openlucius_core_content_types_alter().
 */
function openlucius_news_openlucius_core_content_types_alter(&$content_types) {
  $content_types[] = 'ol_news';
}

/**
 * Implements hook_openlucius_core_fetch_notification_users_alter().
 */
function openlucius_news_openlucius_core_fetch_notification_users_alter(&$all_users) {

  // Get all users you are in groups with.
  $all_users = openlucius_core_fetch_associated_users();
}
