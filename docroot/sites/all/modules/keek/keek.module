<?php

/**
 * @file
 * adds a formatter for text fields to display embedded Keek videos
 *
 */


/**
 * Implements hook_field_formatter_info().
 */
function keek_field_formatter_info() {
  return array(
    'keek_formatter' => array( // Machine name of the formatter
      'label' => t('Embedded Keek video'),
      'field types' => array('text'), // This will only be available to text fields
      'settings'  => array( //Array of the settings we'll create
        'width' => '480', //give a default value for when the form is first loaded
      ),
    ),
  );
}


/**
 * Implements hook_field_formatter_settings_form().
 */
function keek_field_formatter_settings_form($field, $instance, $view_mode, $form, &$form_state) {
  // This gets the view_mode where our settings are stored
  $display = $instance['display'][$view_mode];
  // This gets the actual settings
  $settings = $display['settings'];
  // Initialize the element variable
  $element = array();
  // Add your select box
  $element['width'] = array(
    '#type'           => 'select', // Use a select box widget
    '#title'          => t('Keek photo width'),  // Widget label
    '#description'    => t('Select the width for embedded Keek video'), // Helper text
    '#default_value'  => $settings['width'],              // Get the value if it's already been set
    '#options'        => array(
      '320'  => 'Small (320px)',
      '480' => 'Medium (480px)',
      '600'  => 'Large (600px)',
    ),
  );
  return $element;
}


/**
 * Implements hook_field_formatter_settings_summary().
 */
function keek_field_formatter_settings_summary($field, $instance, $view_mode) {
  $display = $instance['display'][$view_mode];
  $settings = $display['settings'];
  $summary = t('Use a @width px width embedded Keek video', array(
    '@width' => $settings['width'],
  )); // we use t() for translation and placeholders to guard against attacks
  return $summary;
}


/**
 * Implements hook_field_formatter_view().
 */
function keek_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  $element = array(); // Initialize the var
  $settings = $display['settings']; // get the settings
  $width = $settings['width']; // The Size setting selected in the settings form
  $height = $width * 0.75;
  foreach ($items as $delta => $item) {
    $safe_value = $item['safe_value']; // Getting the actual value
  }
  if (isset($safe_value) ) {
    $xmark_pos = strrpos($safe_value, '!');
    $keek_id = substr($safe_value, $xmark_pos+1);
    $element[0]['#markup'] = '<iframe src="https://www.keek.com/embed/' . $keek_id . '" width="' . $width . 'px" height="' . $height . 'px" frameborder="0" allowfullscreen></iframe>'; // Assign it to the #markup of the element
  }
  return $element;
}

