<?php

/**
 * @file
 * Defines core Space Launches NASA module functionality.
 */
define('SPACE_LAUNCHES_NASA_LAUNCH_SOURCE', 'NASA');
define('SPACE_LAUNCHES_NASA_BASE_URL', 'http://www.nasa.gov');

/**
 * Implements hook_libraries_info()
 */
function space_launches_nasa_libraries_info() {
  $libraries['NASA-Web-Data-PHP'] = array(
    'name' => 'NASA Web Data PHP Library',
    'vendor url' => 'https://github.com/ruscoe/NASA-Web-Data-PHP',
    'download url' => 'https://github.com/ruscoe/NASA-Web-Data-PHP/archive/v1.0.tar.gz',
    'version arguments' => array(
      'file' => 'NASAWebData.php',
      'pattern' => '/Version (\d+)/',
      'lines' => 6,
    ),
    'files' => array(
      'php' => array(
        'NASAWebData.php',
        'NASACalendar.php',
      ),
    ),
  );

  return $libraries;
}

/**
 * Implements hook_space_launches_import()
 */
function space_launches_nasa_space_launches_import() {
  // Get time range for launches. Start today.
  $start_time = time();
  // End 90 days in the future.
  $end_time = ($start_time + 7776000);

  // Format date range.
  $start_date = date('Ymd', $start_time) . '0000';
  $end_date = date('Ymd', $end_time) . '2359';

  /* @var $nasa_calendar_lib NASAWebData\NASACalendar */
  $nasa_calendar_lib = space_launches_nasa_get_library('NASACalendar');

  $calendars = array(NASAWebData\NASACalendar::CALENDAR_LAUNCHES);

  $calendar_data_set_ids = $nasa_calendar_lib->getCalendarEventDataSetIds($start_date, $end_date, $calendars);

  $launches = array();

  if (!empty($calendar_data_set_ids)) {
    // Get launch data from data set IDs.
    $data_set_count = count($calendar_data_set_ids);

    for ($i = 0; $i < $data_set_count; $i++) {
      $launch_data = $nasa_calendar_lib->getDataSet($calendar_data_set_ids[$i]);

      if (!empty($launch_data)) {
        $launch = array(
          'source' => SPACE_LAUNCHES_NASA_LAUNCH_SOURCE,
          'source_uid' => $launch_data->calendarEvent->nid,
          'source_updated' => $launch_data->calendarEvent->changed,
          'title' => $launch_data->calendarEvent->title,
          'description' => $launch_data->calendarEvent->description,
          'url' => SPACE_LAUNCHES_NASA_BASE_URL . $launch_data->calendarEvent->uri,
          'time' => strtotime($launch_data->calendarEvent->eventDate[0]->value . ' ' . $launch_data->calendarEvent->eventDate[0]->timezone_db),
          'time_is_exact' => ($launch_data->calendarEvent->isAllDay) ? 0 : 1,
        );

        $launches[$i] = $launch;
      }
    }
  }

  return $launches;
}

/**
 * Gets an instance of the NASA Web Data library.
 *
 * @param string $class
 *   The name of the library class to instantiate.
 *
 * @return \NASAWebData\NASAWebData
 *   NASAWebData object dependent on the value of $class.
 */
function space_launches_nasa_get_library($class) {
  if (libraries_load('NASA-Web-Data-PHP')) {
    $library = 'NASAWebData\\' . $class;
    return new $library();
  }

  return NULL;
}
