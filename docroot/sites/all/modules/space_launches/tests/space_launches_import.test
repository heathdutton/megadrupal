<?php

/**
 * @file
 * Test cases for importing launch data.
 */

/**
 * Tests importing and updating launches.
 */
class SpaceLaunchesImportTestCase extends DrupalWebTestCase {

  /**
   * Gets test information for the test UI.
   * 
   * @return array
   *   Array of test information.
   */
  public static function getInfo() {
    return array(
      'name' => 'Space Launches Import',
      'description' => 'Tests space launch data is correctly imported and updated.',
      'group' => 'Space Launches',
    );
  }

  /**
   * Performs pre-test setup.
   */
  public function setUp() {
    $enabled_modules = array(
      'entity',
      'space_launches',
    );

    parent::setUp($enabled_modules);
  }

  /**
   * Tests importing a new launch.
   */
  public function testImportNewLaunchData() {
    $data = array(
      'source' => 'Kerbal Space Program',
      'source_uid' => 1,
      'source_updated' => 1437146272,
      'title' => 'Exciting Rocket Launch',
      'description' => 'Putting stuff in space.',
      'url' => 'http://example.com/',
      'time' => 1439722800,
      'time_is_exact' => 1,
    );

    space_launches_process_launch($data);

    /* @var $launch SpaceLaunchesLaunch */
    $launch = space_launches_get_launch_by_source_uid($data['source_uid']);

    $this->assertNotNull($launch);

    $this->assertEqual($launch->source, $data['source']);
    $this->assertEqual($launch->source_uid, $data['source_uid']);
    $this->assertEqual($launch->source_updated, $data['source_updated']);
    $this->assertEqual($launch->title, $data['title']);
    $this->assertEqual($launch->description, $data['description']);
    $this->assertEqual($launch->url, $data['url']);
    $this->assertEqual($launch->time, $data['time']);
    $this->assertEqual($launch->time_is_exact, $data['time_is_exact']);
  }

  /**
   * Tests importing a launch with changed data and an idential source
   * updated timestamp.
   *
   * The launch entity should not be updated unless the source updated
   * timestamp is greater than the timestamp when last imported.
   */
  public function testImportUpdatedLaunchDataNoSourceUpdate() {
    $data = array(
      'source' => 'Kerbal Space Program',
      'source_uid' => 1,
      'source_updated' => 1437146272,
      'title' => 'Exciting Rocket Launch',
      'description' => 'Putting stuff in space.',
      'url' => 'http://example.com/',
      'time' => 1439722800,
      'time_is_exact' => 1,
    );

    space_launches_process_launch($data);

    /* @var $launch SpaceLaunchesLaunch */
    $launch = space_launches_get_launch_by_source_uid(1);

    $this->assertNotNull($launch);

    $updated_data = array(
      'source' => 'Kerbal Space Program',
      'source_uid' => 1,
      'source_updated' => 1437146272,
      'title' => 'Updated Rocket Launch',
      'description' => 'Going to the Mun.',
      'url' => 'http://example.org/',
      'time' => 1439722801,
      'time_is_exact' => 1,
    );

    space_launches_process_launch($updated_data);

    /* @var $updated_launch SpaceLaunchesLaunch */
    $updated_launch = space_launches_get_launch_by_source_uid(1);

    $this->assertNotEqual($updated_launch->title, $updated_data['title']);
    $this->assertNotEqual($updated_launch->description, $updated_data['description']);
    $this->assertNotEqual($updated_launch->url, $updated_data['url']);
    $this->assertNotEqual($updated_launch->time, $updated_data['time']);
  }

  /**
   * Tests importing a launch with changed data and a new source
   * updated timestamp.
   */
  public function testImportUpdatedLaunchDataWithSourceUpdate() {
    $data = array(
      'source' => 'Kerbal Space Program',
      'source_uid' => 1,
      'source_updated' => 1437146272,
      'title' => 'Exciting Rocket Launch',
      'description' => 'Putting stuff in space.',
      'url' => 'http://example.com/',
      'time' => 1439722800,
      'time_is_exact' => 1,
    );

    space_launches_process_launch($data);

    /* @var $launch SpaceLaunchesLaunch */
    $launch = space_launches_get_launch_by_source_uid(1);

    $this->assertNotNull($launch);

    $updated_data = array(
      'source' => 'Kerbal Space Program',
      'source_uid' => 1,
      'source_updated' => 1437146273,
      'title' => 'Updated Rocket Launch',
      'description' => 'Going to the Mun.',
      'url' => 'http://example.org/',
      'time' => 1439722801,
      'time_is_exact' => 1,
    );

    space_launches_process_launch($updated_data);

    /* @var $updated_launch SpaceLaunchesLaunch */
    $updated_launch = space_launches_get_launch_by_source_uid(1);

    $this->assertEqual($updated_launch->title, $updated_data['title']);
    $this->assertEqual($updated_launch->description, $updated_data['description']);
    $this->assertEqual($updated_launch->url, $updated_data['url']);
    $this->assertEqual($updated_launch->time, $updated_data['time']);
  }

}
