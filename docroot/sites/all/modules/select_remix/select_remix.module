<?php

/**
 * Implementation of hook_form_alter().
 */
function select_remix_form_alter(&$form, $form_state, $form_id) {
  select_remix_cck_form_alter($form, $form_id);
  select_remix_node_form_alter($form, $form_id); 
}

function select_remix_cck_form_alter(&$form, $form_id) {

  // Check this is a CCK field with widget set to 'select'.
  if ($form_id != 'field_ui_field_edit_form') return;
  if ($form['instance']['widget']['type']['#value'] != 'options_select') return;

  $type = $form['instance']['bundle']['#value'];
  $field = $form['instance']['field_name']['#value'];
  $allowed_values = $form['#field']['settings']['allowed_values'];
 
  if (empty($allowed_values)) {
    return;
  }

  $selected = variable_get('select_remix_'. $type .'_'. $field, array());
 
  $form['instance']['select_remix'] = array(
    '#type' => 'checkboxes',
    '#title' => t('Hide Options'),
    '#description' => t('Select which options to hide for this content type.'),
    '#options' => $allowed_values,
    '#default_value' => $selected,
  );

  $form['#submit'][] = 'select_remix_cck_form_alter_submit';
  
}

function select_remix_node_form_alter(&$form, $form_id) {

  if (!isset($form['#node_edit_form']) || $form['#node_edit_form'] != TRUE) return;
  $entity = $form['#entity_type'];
  $bundle = $form['#bundle'];
  $fields = field_info_instances($entity, $bundle);

  foreach ($fields as $field_name => $field) {
    if ($field['widget']['type'] == 'options_select') {
      $hide = variable_get('select_remix_'. $bundle .'_'. $field_name, array());
  
      if (!empty($hide)) {
         select_remix_hide_field_options($form, $field_name, $hide);
      }
    }
  }
  
}

function select_remix_hide_field_options(&$form, $field_name, $hide) {

  $field = field_info_field($field_name);
  $allowed_values = $field['settings']['allowed_values'];

  if (empty($allowed_values)) return;

	if (isset($form[$field_name]['und']['#options']['_none'])) {
		$options['_none'] = $form[$field_name]['und']['#options']['_none'];
	}

  foreach ($allowed_values as $name => $value) {
    if (!isset($hide[$name]) || empty($hide[$name])) {
      $options[$name] = $value;
    }
  } 

  $form[$field_name]['und']['#options'] = $options;
}  


function select_remix_cck_form_alter_submit($form, &$form_state) {

  $hiden = FALSE;
  $type = $form_state['values']['instance']['bundle'];
  $field = $form_state['values']['instance']['field_name'];
  $options = $form_state['values']['instance']['select_remix'];

  foreach ($options as $option) {
    if (!empty($option)) {
      $hiden = TRUE;
    }
  }
  
  if ($hiden) {
    variable_set('select_remix_'. $type .'_'. $field, $options);
  }
  else {
    variable_del('select_remix_'. $type .'_'. $field);
  }
}

