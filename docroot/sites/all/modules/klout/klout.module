<?php

/**
 * @file
 * Module file for "Klout".
 */

/**
 * Implements hook_block_info().
 *
 * Provides one block named 'Klout Badge' that is globally cached.
 */
function klout_block_info() {
  $blocks['kloutbadge'] = array(
    'info' => t('Klout Badge'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 *
 * Renders a HTML-span containing the Klout Badge information.
 */
function klout_block_view($delta = '') {
  $block = array();
  switch ($delta) {
    case 'kloutbadge':
      $klout_user_id = variable_get('klout_user', '');
      $klout_size = variable_get('klout_size', t('Large'));
      if ($klout_size == t('Large')) {
        $klout_width = 200;
        $klout_height = 98;
        $klout_url = '';
      }
      elseif ($klout_size == t('Medium')) {
        $klout_width = 160;
        $klout_height = 78;
        $klout_url = '?size=m';
      }
      elseif ($klout_size == t('Small')) {
        $klout_width = 120;
        $klout_height = 60;
        $klout_url = '?size=s';
      }
      else {
        $klout_width = 200;
        $klout_height = 98;
        $klout_url = '';
      }
      $output = '<iframe src="http://widgets.klout.com/badge/' . $klout_user_id . $klout_url . '" style="border:0" scrolling="no" allowTransparency="true" frameBorder="0" width="' . $klout_width . 'px" height="' . $klout_height . 'px"></iframe>';
      // Create the block.
      $block['subject'] = t('Klout Badge');
      $block['content'] = $output;
      break;
  }
  return $block;
}

/**
 * Implements hook_block_configure().
 *
 * Creates the form data to set the klout profile id.
 */
function klout_block_configure($delta = '') {
  $form = array();
  if ($delta == 'kloutbadge') {

    // Plain text field for the klout profile id.
    $klout_user_id = variable_get('klout_user', '');
    $form['klout_block_userid'] = array(
      '#type' => 'textfield',
      '#title' => t('Klout Profile ID'),
      '#size' => 30,
      '#description' => t('Enter your valid Klout Profile ID.'),
      '#default_value' => $klout_user_id,
    );

    // Plain text field for the size.
    $klout_size = variable_get('klout_size', t('Large'));
    $form['klout_block_size'] = array(
      '#type' => 'select',
      '#title' => t('Size'),
      '#options' => drupal_map_assoc(array(t('Large'), t('Medium'), t('Small'))),
      '#description' => t('Size of the Klout Badge to display in block'),
      '#default_value' => $klout_size,
    );
  }
  return $form;
}

/**
 * Implements hook_block_save().
 *
 * Stores the Klout Profile ID and size of badge.
 */
function klout_block_save($delta = '', $edit = array()) {
  if ($delta == 'kloutbadge') {
    $klout_user = $edit['klout_block_userid'];
    variable_set('klout_user', $klout_user);
    $klout_size = $edit['klout_block_size'];
    variable_set('klout_size', $klout_size);
  }
}