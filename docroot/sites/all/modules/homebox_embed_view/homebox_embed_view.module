<?php
/**
 * @file
 *
 * Expose a list of Views that users can chose to embed/display on their homebox
 * powered dashboard.
 *
 * @todo Limit the list of offered Views/make it admin customizable.
 */

/**
 * Implements hook_block_info().
 */
function homebox_embed_view_block_info() {
  $blocks = array();
  $blocks['block_feed'] = array(
    'info' => t('Block feed'),
    'cache' => DRUPAL_NO_CACHE,
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function homebox_embed_view_block_view($delta = '') {
  $block = array();
  if ($delta == 'block_feed') {
    $block['subject'] = t('Block feed');
    $block['content'] = homebox_embed_view_block_content();
  }
  return $block;
}

/**
 * Implements hook_block_content().
 *
 * Provide default whitespace content so the block is rendered before setting
 * it up.
 */
function homebox_embed_view_block_content() {
  return '&nbsp;';
}

/**
 * Implements hook_homebox_block_edit_form().
 *
 * Only allow block displays to be embedded.
 */
function homebox_embed_view_homebox_block_edit_form($block) {
  foreach (views_get_all_views() as $view) {
    foreach ($view->display as $display) {
      if ($display->display_plugin == 'block') {
        $options[$view->name] = $view->human_name;
      }
    }
  }
  $form['embed_view'] = array(
    '#title' => t('View'),
    '#description' => t('View to embed'),
    '#options' => $options,
    '#default_value' => isset($block->embed_view) ? $block->embed_view : '',
    '#type' => 'select',
  );
  return $form;
}

/**
 * Implements of hook_block_view_MODULE_BLOCK_ID_alter().
 *
 * Only at this stage are block settings available. Replacing the block content
 * with the embedded view.
 */
function homebox_embed_view_block_view_homebox_embed_view_block_feed_alter(&$block, $settings) {
  if (isset($settings->embed_view)) {
    $block['content'] = views_embed_view($settings->embed_view, 'block');
  }
}

/**
 * Implements hook_homebox_block_keys().
 *
 * Define the settings variables to be saved per user for the block.
 */
function homebox_embed_view_homebox_block_keys($block) {
  return array('embed_view');
}
