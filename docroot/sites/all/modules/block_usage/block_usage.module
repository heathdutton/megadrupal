<?php

/**
 * Implements hook_form_FORM_ID_alter() for block_admin_configure().
 */
function block_usage_form_block_admin_configure_alter(&$form, &$form_state) {
  $module = $form['module']['#value'];
  $delta = $form['delta']['#value'];

  $matches = _block_usage_matches($module, $delta, $implementations);
  ksort($matches);

  $num_matches = 0;
  $modules = array();
  foreach ($matches as $module_3rd => $items) {
    $num_matches += count($items);

    $modules[$module_3rd] = array(
      '#theme' => 'item_list',
      '#items' => $items,
      '#title' => $module_3rd,
    );
  }
  $form['block_usage'] = array(
    '#type' => 'fieldset',
    '#title' => t('Block usage (@num)', array('@num' => $num_matches)),
    '#description' => t('Checked: @modules', array('@modules' => implode(', ', $implementations))),
    '#weight' => 150, // 'actions' seems to be 100, so below that.
    'modules' => $modules,
  );
}

/**
 * Implements template_preprocess_block().
 */
function block_usage_preprocess_block(&$vars) {
  // Add more useful Context data to this block, if it might have come from Context.
  if (module_exists('context')) {
    $block = $vars['block'];
    $bid = $block->module . '-' . $block->delta;
    $contexts = array_filter(context_active_contexts(), function($context) use ($bid) {
      return isset($context->reactions['block']['blocks'][$bid]);
    });
    $vars['attributes_array']['data-contexts'] = implode(', ', array_keys($contexts));
    $vars['elements']['#block_usage_contexts'] = $contexts;
  }
}

/**
 * Implements hook_contextual_links_view_alter().
 */
function block_usage_contextual_links_view_alter(&$element, $items) {
  if (!empty($element['#element']['#block_usage_contexts']) && user_access('administer blocks')) {
    $element['#links']['block-usage-contexts'] = array(
      'title' => 'Which contexts?',
      'href' => request_path(),
      'attributes' => array('onclick' => "alert(jQuery(this).closest('.block').data('contexts')); return false"),
    );
  }
}

/**
 * Helper to find all usages of the given block via a hook.
 */
function _block_usage_matches($module, $delta, &$implementations = array()) {
  $matches = &drupal_static(__FUNCTION__ . ':' . $module . ':' . $delta);

  require_once __DIR__ . '/block_usage.modules.inc';
  $hook = 'block_usage';
  $implementations = module_implements($hook);

  if (!is_array($matches)) {
    $matches = array();

    foreach ($implementations as $module_3rd) {
      $function = $module_3rd . '_' . $hook;
      if (is_callable($function)) {
        $module_matches = $function($module, $delta);
        if ($module_matches) {
          $matches[$module_3rd] = $module_matches;
        }
      }
    }
  }

  return $matches;
}

/**
 * Helper to return all bids for a given module + delta.
 */
function _block_usage_bids($module, $delta) {
  $bids = db_query('SELECT bid FROM {block} WHERE module = :module AND delta = :delta', array(
    ':module' => $module,
    ':delta' => $delta,
  ))->fetchCol();
  return $bids;
}
