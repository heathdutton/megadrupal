<?php

/**
 * @file
 *   widget_user.module
 *   Main module file for widget_user module.
 */

/**
 * Implements hook_theme().
 */
function widget_user_theme($existing, $type, $theme, $path) {
  return array(
    'widget_user_quick_links_auntenticated_user_widget' => array(
      'template' => 'widget_user_quick_links_auntenticated_user_widget',
      'variables' => array('preset' => NULL, 'account' => NULL),
    ),
    'widget_user_quick_links_anonymous_user_widget' => array(
      'template' => 'widget_user_quick_links_anonymous_user_widget',
      'variables' => array('preset' => NULL, 'login_form' => array()),
    ),
  );
}

/**
 * Implements hook_widget_factory_widgets_info
 */
function widget_user_widget_factory_widgets_info() {
  return array(
    'widget_user_quick_links' => array(
      'info' => 'Widget User: Quick Links',
      'defaults' => array(
        'cache' => DRUPAL_NO_CACHE,
        'content_callback' => 'widget_user_quick_links_widget_content',
      ),
    ),
  );
}

function widget_user_quick_links_widget_content($preset) {
  global $user;
  if ($user->uid) {
    $data['#theme'] = 'widget_user_quick_links_auntenticated_user_widget';
    $data['#preset'] = $preset;
    $data['#account'] = $user;
  }
  else {
    $data['#theme'] = 'widget_user_quick_links_anonymous_user_widget';
    $data['#preset'] = $preset;
    $data['#login_form'] = widget_user_get_minimalist_login_form();
  }
  return $data;
}

function widget_user_get_minimalist_login_form() {
  $form = drupal_get_form('user_login_block');
  unset($form['links']);
  $children = element_children($form);
  $allowed_keys = array(
    'name',
    'pass',
    'actions',
    'form_build_id',
    'form_id',
  );
  foreach ($children as $value) {
    if (!in_array($value, $allowed_keys)) {
      unset($form[$value]);
    }
  }
  $form['name']['#attributes']['placeholder'] = $form['name']['#title'];
  unset($form['name']['#title']);
  $form['pass']['#attributes']['placeholder'] = $form['pass']['#title'];
  unset($form['pass']['#title']);
  return $form;
}
