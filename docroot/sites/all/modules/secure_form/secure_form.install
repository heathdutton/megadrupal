<?php

/**
 * @file
 * Installation process for Secure Form module.
 */

/**
 * Implements hook_enable().
 */
function secure_form_enable() {
  if (function_exists('finfo_open') && function_exists('finfo_file')) {
    variable_set('secure_form_check_file', 1);
  }
  elseif (function_exists('mime_content_type')) {
    variable_set('secure_form_check_file', 1);
  }
  variable_set('secure_form_autocomplete_form', 1);
}

/**
 * Implements hook_disable().
 */
function secure_form_disable() {
  $secure_form_check_file = variable_get('secure_form_check_file');
  if (!empty($secure_form_check_file)) {
    variable_set('secure_form_check_file', 0);
  }
  variable_set('secure_form_autocomplete_form', 0);
}

/**
 * Implements hook_uninstall().
 */
function secure_form_uninstall() {
  variable_del('secure_form_check_file');
  variable_del('secure_form_autocomplete_form');
}

/**
 * Implements hook_requirements().
 */
function secure_form_requirements($phase) {
  $requirements = array();

  // Test function existence.
  if ($phase == 'runtime') {
    // Ensure translations don't break during installation.
    $t = get_t();
    $function_available = NULL;
    $requirements['secure_form']['title'] = $t('Secure form file checker');
    // Check FILEINFO_MIME_TYPE, if required functions are available.
    if (function_exists('finfo_open') && function_exists('finfo_file')) {
      $function_available = $t('!link_open and !link_file functions are available to get information about a file.', array(
        '!link_open' => l($t('finfo_open'), 'http://in2.php.net/manual/en/function.finfo-open.php'),
        '!link_file' => l($t('finfo_file'), 'http://in2.php.net/manual/en/function.finfo-file.php'),
      ));
    }
    // Check mime_content_type of file, if function available.
    elseif (function_exists('mime_content_type')) {
      $function_available = $t('!link function is available to get information about a file.', array(
        '!link' => l($t('mime_content_type'), 'http://in.php.net/manual/en/function.mime-content-type.php'),
      ));
    }
    if (empty($function_available)) {
      $requirements['secure_form']['value'] = $t('Not available');
      $requirements['secure_form']['description'] = $t('File information is not available. Make sure that, <em>extension=php_fileinfo.dll</em> in your <em>php.ini</em> is not commented. Remember to restart Apache, if you make any changes in <em>php.ini</em> to take effect.');
      $requirements['secure_form']['severity'] = REQUIREMENT_WARNING;
    }
    else {
      $requirements['secure_form']['value'] = $t('Available');
      $requirements['secure_form']['description'] = $function_available;
      $requirements['secure_form']['severity'] = REQUIREMENT_OK;
    }
  }

  return $requirements;
}
