<?php

/**
 * @file
 * Provides Drupal integration with Nimble CRM.
 */

// Include core module functions.
nimble_crm_include('core');

define('NIMBLE_CRM_OAUTH_CLIENT', 'nimble_crm');
define('NIMBLE_CRM_OAUTH_REDIRECT_PATH', 'nimble-crm/authorized');

/**
 * Implements hook_menu().
 */
function nimble_crm_menu() {
  $items = array();
  $file_path = drupal_get_path('module', 'nimble_crm') . '/includes';

  $items['admin/config/services/nimble-crm'] = array(
    'title' => 'Nimble CRM',
    'description' => 'Nimble CRM settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('nimble_crm_admin_settings_form'),
    'file' => 'nimble_crm.admin.inc',
    'file path' => $file_path,
    'access arguments' => array('administer site configuration'),
  );
  $items[NIMBLE_CRM_OAUTH_REDIRECT_PATH] = array(
    'page callback' => 'nimble_crm_oauth2_authorized',
    'file' => 'nimble_crm.admin.inc',
    'file path' => $file_path,
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Implements hook_oauth2_clients().
 */
function nimble_crm_oauth2_clients() {
  global $base_url;
  $server_url = 'https://api.nimble.com';
  $oauth2_clients = array();

  // Using server-side flow.
  $oauth2_clients[NIMBLE_CRM_OAUTH_CLIENT] = array(
    'auth_flow' => 'server-side',
    'client_id' => variable_get('nimble_crm_client_id'),
    'client_secret' => variable_get('nimble_crm_client_secret'),
    'token_endpoint' => $server_url . '/oauth/token',
    'authorization_endpoint' => $server_url . '/oauth/authorize',
    'redirect_uri' => $base_url . '/' . NIMBLE_CRM_OAUTH_REDIRECT_PATH,
  );

  return $oauth2_clients;
}

/**
 * Load file from /includes folder.
 */
function nimble_crm_include($file) {
  module_load_include('inc', 'nimble_crm', 'includes/nimble_crm.' . $file);
}
