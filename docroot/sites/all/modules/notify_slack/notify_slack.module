<?php
/**
 * @file
 * Custom service module.
 */

/**
 * Implements hook_menu().
 */
function notify_slack_menu() {
  $items = array();
  $items['admin/config/ucdapp/notify_slack'] = array(
    'title'            => 'Notify Slack settings',
    'description'      => 'Configure Notify Slack defaults.',
    'page callback'    => 'drupal_get_form',
    'page arguments'   => array('notify_slack_admin_settings'),
    'access arguments' => array('administer site configuration'),
    'file'             => 'includes/notify_slack.admin.inc',
    'type'             => MENU_LOCAL_TASK,
  );
  $items['notify_slack/form'] = array(
    'title'           => 'Notify Slack Form',
    'page callback'   => 'drupal_get_form',
    'page arguments'  => array('notify_slack_form'),
    'access callback' => TRUE,
    'description'     => 'Send notification to Slack.',
    'type'            => MENU_NORMAL_ITEM,
  );

  return $items;
}


/**
 * Menu callback page.
 */
function notify_slack_form($form, &$form_state) {
  $form['notify_slack']['hook_url'] = array(
    '#title'         => 'Hook URL',
    '#type'          => 'textfield',
    '#default_value' => isset($form_state['values']['hook_url']) ? $form_state['values']['hook_url'] : variable_get('notify_slack_default_hook_url', ''),
  );
  $form['notify_slack']['channel'] = array(
    '#title'         => 'Channel',
    '#type'          => 'textfield',
    '#default_value' => isset($form_state['values']['channel']) ? $form_state['values']['channel'] : variable_get('notify_slack_default_channel', '#random'),
  );
  $form['notify_slack']['bot_name'] = array(
    '#title'         => 'Bot name',
    '#type'          => 'textfield',
    '#default_value' => isset($form_state['values']['bot_name']) ? $form_state['values']['bot_name'] : variable_get('notify_slack_default_bot_name', 'Shrek'),
  );
  $form['notify_slack']['avatar'] = array(
    '#type'          => 'radios',
    '#options'       => array(
      'icon_emoji' => t('Icon Emoji'),
      'icon_url'   => t('Icon URL'),
    ),
    '#title'         => t('Bots avatar'),
    '#default_value' => variable_get('notify_slack_default_avatar', 'icon_emoji'),
  );
  $form['notify_slack']['icon_emoji'] = array(
    '#title'         => 'Icon emoji',
    '#type'          => 'textfield',
    '#default_value' => isset($form_state['values']['icon_emoji']) ? $form_state['values']['icon_emoji'] : variable_get('notify_slack_default_icon_emoji', ':ghost:'),
    '#states'        => array(
      'visible'  => array(
        ':input[name="avatar"]' => array('value' => 'icon_emoji'),
      ),
      'required' => array(
        ':input[name="avatar"]' => array('value' => t('icon_emoji')),
      ),
    ),
  );
  $form['notify_slack']['icon_url'] = array(
    '#title'         => 'Icon URL',
    '#type'          => 'textfield',
    '#default_value' => isset($form_state['values']['icon_url']) ? $form_state['values']['icon_url'] : variable_get('notify_slack_default_icon_url', ''),
    '#states'        => array(
      'visible'  => array(
        ':input[name="avatar"]' => array('value' => 'icon_url'),
      ),
      'required' => array(
        ':input[name="avatar"]' => array('value' => t('icon_url')),
      ),
    ),
  );
  $form['notify_slack']['text'] = array(
    '#title'         => 'Message',
    '#type'          => 'textarea',
    '#resizable'     => FALSE,
    '#default_value' => isset($form_state['values']['text']) ? $form_state['values']['text'] : '',
  );
  $form['submit'] = array(
    '#type'  => 'submit',
    '#value' => 'Submit',
  );

  return $form;
}

/**
 * Form submit processor.
 */
function notify_slack_form_submit($form, &$form_state) {
  $payload = array(
    'channel'  => $form_state['values']['channel'],
    'username' => $form_state['values']['bot_name'],
    'text'     => $form_state['values']['text'],
  );
  if ($form_state['values']['avatar'] == 'icon_url') {
    $payload['icon_url'] = $form_state['values']['icon_url'];
  }
  else {
    $payload['icon_emoji'] = $form_state['values']['icon_emoji'];
  }
  $form_state['rebuild'] = TRUE;

  notify_slack_post($form_state['values']['hook_url'], $payload);
}

/**
 * Post message to Slack.
 *
 * @param string $hook_url
 *   You need to get Hook URL from slack (click new services).
 * @param array|NULL $payload
 *   Payload is the message whick wrapped by json_encode.
 * @param array $options
 *   cURL options.
 *
 * @return mixed
 *   cURL response status.
 */
function notify_slack_post($hook_url, array $payload = NULL, array $options = array()) {
  $default_payload = array(
    'link_names' => 1,
  );
  $payload = array_merge($default_payload, $payload);
  $defaults = array(
    CURLOPT_POST           => 1,
    CURLOPT_HEADER         => 0,
    CURLOPT_URL            => $hook_url,
    CURLOPT_FRESH_CONNECT  => 1,
    CURLOPT_RETURNTRANSFER => 1,
    CURLOPT_FORBID_REUSE   => 1,
    CURLOPT_TIMEOUT        => 4,
    CURLOPT_POSTFIELDS     => 'payload=' . json_encode($payload),
    CURLOPT_SSL_VERIFYHOST => 0,
    CURLOPT_SSL_VERIFYPEER => 0,
  );
  $ch = curl_init();
  curl_setopt_array($ch, ($options + $defaults));
  if (!$result = curl_exec($ch)) {
    trigger_error(curl_error($ch));
  }
  curl_close($ch);

  return $result;
}

/**
 * Notify Slack.
 *
 * @param mixed $payload
 *   Array or string.
 *    String: Message text.
 *   Array:
 *    link_names: Let mention be a link, default is 1.
 *    icon_emoji: To show bot avator, default is ':ghost:'.
 *    channel: Notify channels, default is '#random'.
 *    username: Slackbot name, default is 'Shrek'.
 *    text: Message text.
 *
 * @return bool
 *   FALSE if there aren't setting Hook URL.
 */
function notify_slack($payload) {
  if (empty($payload)) {
    return FALSE;
  }
  $default_payload = array(
    'channel'  => variable_get('notify_slack_default_channel', '#random'),
    'username' => variable_get('notify_slack_default_bot_name', 'Shrek'),
    'text'     => '',
  );
  if (variable_get('notify_slack_default_avatar', 'icon_emoji') == 'icon_url') {
    $default_payload['icon_url'] = variable_get('notify_slack_default_icon_url', '');
  }
  else {
    $default_payload['icon_emoji'] = variable_get('notify_slack_default_icon_emoji', ':ghost:');
  }
  if (is_string($payload)) {
    $payload = array(
      'text' => $payload,
    );
  }
  $payload = array_merge($default_payload, $payload);
  $hook_url = variable_get('notify_slack_default_hook_url', '');
  if ($hook_url !== '') {
    notify_slack_post($hook_url, $payload);
  }

  return FALSE;
}
