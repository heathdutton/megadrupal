<?php

/**
 * @file
 * Displays business hours managed by dynOZ on Drupal pages
 *
 */

define('DYNOZ_ACCESS_PAGES_DEFAULT', '');
define('DYNOZ_VISIBILITY_DEFAULT', 0);
define('DYNOZ_NUMBER_BLOCKS_DEFAULT', 3);
define('DYNOZ_BLOCK_DEFAULT', '');

/**
 * Implements hook_permission().
 */
function dynoz_permission() {
  return array('administer blocks', 'use PHP for block visibility');
}

/**
 * Configuration of the provided block
 *
 * @param $delta
 *   block number
 * @return
 *   array with the block configuration or FALSE if no such block was found
 */
function _dynoz_get_block_config($delta = 0) {
  if ($data = variable_get('dynoz_block_' . $delta, DYNOZ_BLOCK_DEFAULT)) {
    $dynoz_block = explode(':', $data);
    $dynoz_block[0] = urldecode($dynoz_block[0]);
    return $dynoz_block;
  }
  return FALSE;
}

/**
 * Implements hook_block_configure().
 */
function dynoz_block_configure($delta = '') {

  $dynoz_block = _dynoz_get_block_config($delta);

  $form['info'] = array(
    '#type' => 'textfield',
    '#title' => t('Block description'),
    '#default_value' => ($dynoz_block) ? $dynoz_block[0] : '',
    '#maxlength' => 64,
    '#description' => t('A brief description of your block. Used on the <a href="@overview">block overview page</a>.', array('@overview' => url('admin/build/block'))),
    '#required' => TRUE,
    '#weight' => -19,
  );

  $form['webkey'] = array(
    '#type' => 'textfield',
    '#title' => t('Webkey'),
    '#default_value' => ($dynoz_block) ? $dynoz_block[1] : '',
    '#maxlength' => 64,
    '#description' => t('dynOZ Webkey'),
    '#required' => TRUE,
    '#weight' => -10,
  );
  
  $form['oz_type'] = array(
    '#type' => 'select',
    '#title' => t('Format'),
    '#default_value' => ($dynoz_block) ? $dynoz_block[2] : '1',        
    '#options' => array(
      '1' => t('weekly business hours'),
      '2' => t('daily business hours')
    ),
    '#description' => t('Select the type of information you want to show.'),
  );      
  return $form;
}

/**
 * Implements hook_block_save().
 */
function dynoz_block_save($delta = '', $edit = array()) {
  $data = implode(':', array(urlencode($edit['info']), $edit['webkey'], $edit['oz_type']));
  variable_set('dynoz_block_' . $delta, $data);
  return;
}


/**
 * Implements hook_block_view().
 */
function dynoz_block_view($delta = '') {  
  if (_dynoz_page_match()) {
    $dynoz_block = _dynoz_get_block_config($delta);
    $block['content'] = ($dynoz_block) ? dynoz_display(array('webkey' => $dynoz_block[1], 'oz_type' => $dynoz_block[2])) : t('dynOZ unconfigured block. <a href=!url>Click to configure.</a>', array('!url' => url('admin/build/block/configure/dynoz/' . $delta)));
  }
  return $block;
}

/**
 * Implements hook_block_info().
 */
function dynoz_block_info() {
  $max = variable_get('dynoz_number_blocks', DYNOZ_NUMBER_BLOCKS_DEFAULT);
  for ($count=0 ; $count < $max ; $count++) {
    if ($dynoz_block = _dynoz_get_block_config($count)) {
      $title = $dynoz_block[0];
    } 
    else {
      $title = t('dynOZ: unconfigured') . $count;
    }
    $block[$count]['info'] = $title;
  }
  return $block;
}

/**
 * Implements hook_menu().
 */
function dynoz_menu() {
  $items = array();

  $items['admin/structure/dynoz'] = array(
    'title' => 'dynOZ',
    'description' => 'Configure dynOZ',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('dynoz_main_settings'),
    'access arguments'  => array('administer dynoz'),
    'file' => 'dynoz.admin.inc',
  );
  
  $items['admin/structure/dynoz/main'] = array(
    'title' => 'Settings',
    'weight' => 10,
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  
  return $items;
}

/**
 * Generates the Output
 */
function dynoz_display($data) {
  $webkey = $data['webkey'];
  if ($data['oz_type'] == 2)
    $url = "http://dyn-oz.appspot.com/headraw?id=$webkey";
  else
    $url = "http://dyn-oz.appspot.com/contentraw?id=$webkey";

  $ch = curl_init();
  $timeout = 5;
  curl_setopt($ch, CURLOPT_URL, $url);
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
  curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, $timeout);
  $content = curl_exec($ch);
  curl_close($ch);

  return $content;
}

/**
 * Default dynoz theming. Simply add a div with the dynoz and $module classes
 *
 * @param $dynoz_block
 *   string with the generated dynoz_block
 * @param $module
 *   module used to generate the dynoz_block
 *
 * @return
 *   string with the modified dynoz_block
 */
function theme_dynoz_ad($dynoz_block, $module) {
  return "<div class='dynoz $module'>\n$dynoz_block\n</div>";
}

/**
 * Determine if dynoz has permission to be used on the current page.
 *
 * @return
 *   TRUE if can render, FALSE if not allowed.
 */
function _dynoz_page_match() {
  $pages = variable_get('dynoz_access_pages', DYNOZ_ACCESS_PAGES_DEFAULT);
  $visibility = variable_get('dynoz_visibility', DYNOZ_VISIBILITY_DEFAULT);

  if ($pages) {
    if ($visibility == 2) {
      return drupal_eval($pages);
    }
    $path = drupal_get_path_alias($_GET['q']);
    $page_match = drupal_match_path($path, $pages);
    if ($path != $_GET['q']) {
      $page_match = $page_match || drupal_match_path($_GET['q'], $pages);
    }
    return !($visibility xor $page_match);
  } 
  else {
    return !$visibility;
  }
}

/**
 * Implements hook_help().
 */
function dynoz_help($path, $arg) {
  switch ($path) {
    case 'admin/settings/dynoz':
      return t('Here you can define via the number of blocks how many different views on your hours managed at <a href="http://www.dynoz.net">dynoz.net</a> shall be shown on your website.');
  }
}
