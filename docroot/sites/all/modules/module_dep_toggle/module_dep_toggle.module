<?php

/**
 * @file
 */

/**
 * Implements hook_form_FORM_ID_alter().
 */
function module_dep_toggle_form_system_modules_alter(&$form, &$form_state, $form_id) {
  $titles = array(
    "link_text" => t("Dependencies"),
    "link_title" => t("Click to show."),
  );

  if (isset($form['modules']['#tree']) && $form['modules']['#tree']) {
    foreach ($form['modules'] as $tree => $modules) {
      if (is_array($modules)) {
        foreach ($modules as $k => $v) {
          if (is_array($v)) {
            module_dep_toggle_process_row($form['modules'][$tree][$k], $titles);
          }
        }
      }
    }
  }
  elseif (module_exists("module_filter")) {
    foreach ($form['modules'] as $k => $v) {
      if (is_array($v)) {
        module_dep_toggle_process_row($form['modules'][$k], $titles);
      }
    }
  }
  else {
    return FALSE;
  }

  $form['#attached']['css'][] = array(
    "type" => "file",
    "data" => drupal_get_path("module", "module_dep_toggle") . "/module_dep_toggle.css",
  );

  $form['#attached']['js'][] = array(
    "type" => "file",
    "data" => drupal_get_path("module", "module_dep_toggle") . "/module_dep_toggle.js",
  );
}

/**
 * Helper function for building link.
 */
function module_dep_toggle_process_row(&$row, $titles) {
  if (!empty($row['#requires']) || !empty($row['#required_by'])) {
    $row['description']['#markup'] .= "<div><a href='#' class='hide module_dep_toggle' title='" . $titles['link_title'] . "'>" . $titles['link_text'] . "</a></div>";
  }
}
