<?php

/**
 * @file
 * Main module file for Feedbackify
 */

/**
 * Implements hook_help().
 */
function feedbackify_help($path, $arg) {
  switch ($path) {
    case 'admin/help#feedbackify':
      return t('Please use your form ID from your Feedbackify account. Please see http://www.feedbackify.com for a demo and more information.');
  }
}

/**
 * Implements hook_permission().
 */
function feedbackify_permission() {
  return array(
    'administer feedbackify' => array(
      'title' => t('Administer Feedbackify'),
      'description' => t('Perform administration tasks for Feedbackify.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function feedbackify_menu() {
  $items = array();
  $items['admin/config/services/feedbackify'] = array(
    'title' => 'Feedbackify',
    'description' => 'Configure Feedbackify.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('feedbackify_settings_form'),
    'access arguments' => array('administer feedbackify'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'feedbackify.admin.inc',
  );
  return $items;
}

/**
 * Implements hook_page_alter().
 *
 * Insert Feedbackify JavaScript at the end of the page.
 */
function feedbackify_page_alter() {
  $feedbackify_id = check_plain(variable_get('feedbackify_id', ''));
  if (!empty($feedbackify_id) && _feedbackify_visibility_pages()) {

    $feedbackify_pos = check_plain(variable_get('feedbackify_pos', 'right'));
    $feedbackify_color = check_plain(variable_get('feedbackify_color', '#237BAB'));

    $script = array();
    $script[] = "var fby = fby || []";
    $script[] = "fby.push(['showTab', {id: '$feedbackify_id', position: '$feedbackify_pos', color: '$feedbackify_color'}]);";
    $script[] = "(function () {";
    $script[] = "  var f = document.createElement('script'); f.type = 'text/javascript'; f.async = true;";
    $script[] = "  f.src = '//cdn.feedbackify.com/f.js';";
    $script[] = "  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(f, s);";
    $script[] = "})();";

    drupal_add_js(implode(PHP_EOL, $script), array('type' => 'inline', 'scope' => 'footer'));
  }
}

/**
 * Determine if the Feedbackify code should be printed on the current page.
 */
function _feedbackify_visibility_pages() {
  $visibility = variable_get('feedbackify_visibility', 0);
  $pages = variable_get('feedbackify_pages', '');

  // Match path if necessary.
  if (!empty($pages)) {
    $path = drupal_get_path_alias($_GET['q']);
    // Compare with the internal and path alias (if any).
    $page_match = drupal_match_path($path, $pages);
    if ($path != $_GET['q']) {
      $page_match = $page_match || drupal_match_path($_GET['q'], $pages);
    }
    // When $visibility has a value of 0, the block is displayed on
    // all pages except those listed in $pages. When set to 1, it
    // is displayed only on those pages listed in $pages.
    $page_match = !($visibility xor $page_match);
  }
  else {
    $page_match = TRUE;
  }

  return $page_match;
}
