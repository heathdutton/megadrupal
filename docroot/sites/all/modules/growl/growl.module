<?php

/**
 * @file
 * Posts system events to Growl.
 */

function growl_help($path, $arg) {
  switch ($path) {
    case 'admin/help#growl':
      return '<p>'. t('Provides the facility to post Drupal system messages to !growl.', array('!growl' => l('Growl', 'http://growl.info'))) .'</p>';
  }
}


function growl($message, $extra_params = array()) {
  $command = variable_get('growl_path', '/usr/local/bin/growlnotify');
  if (!empty($message)) {
    $command .= ' -m ' . escapeshellarg($message);
  }
  foreach ($extra_params as $key => $value) {
    $command .= ' -' . $key . ' ' . escapeshellarg($value);
  }
  exec($command . "\n", $results);
  return $results;
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function growl_form_system_logging_settings_alter(&$form, &$form_state) {
  exec('/usr/local/bin/growlnotify -v', $results, $output);
  if ($output !== 0) {
    drupal_set_message(t(
        'Warning: Growl module requires that the growlnotify command line utility be installed and accessible to the apache process. growlnotify does NOT appear to be installed on this server. For more information on Growl and growlnotify, visit !growl.',
        array('!growl' => l('http://growl.info', 'http://growl.info'))
      ), 'error'
    );
  }

  $options = array(
    WATCHDOG_EMERGENCY    => t('Emergency: system is unusable'),
    WATCHDOG_ALERT    => t('Alert: action must be taken immediately'),
    WATCHDOG_CRITICAL => t('Critical: critical conditions'),
    WATCHDOG_ERROR    => t('Error: error conditions'),
    WATCHDOG_WARNING  => t('Warning: warning conditions'),
    WATCHDOG_NOTICE   => t('Notice: normal but significant condition'),
    WATCHDOG_INFO     => t('Informational: informational messages'),
    WATCHDOG_DEBUG    => t('Debug: debug-level messages'),
  );

  $form['growl_severity'] = array(
    '#type'          => 'select',
    '#title'         => t('Growl severity level'),
    '#default_value' => variable_get('growl_severity', WATCHDOG_CRITICAL),
    '#options'       => $options,
    '#description'   => t('Watchdog messages below this severity level will not be posted on Growl. Severity levels, as defined in !rfc, allow administrators to filter alert messages. Most Drupal log messages are Errors or Notices.', array(
      '!rfc'         => l("RFC 3164", 'http://www.faqs.org/rfcs/rfc3164.html'),
      )),
  );
}

/**
 * Implements hook_watchdog().
 */
function growl_watchdog(array $log_entry) {
  global $base_url;

  $severity = variable_get('growl_severity', WATCHDOG_ALERT);
  $message = strip_tags(is_null($log_entry['variables']) ? $log_entry['message'] : strtr($log_entry['message'], $log_entry['variables']));

  if ($log_entry['severity'] <= $severity) {
    growl($message, array('t' => variable_get('site_name', 'Drupal') . ': ' . $log_entry['type']));
  }
}
