<?php
/**
 * @file
 * The A12 connect module provides functions to connect to A12 services.
 */

define('A12_CONNECT_WEBSERVICES_URL', 'https://services.axis12.com');
define('A12_CONNECT_VALIDATE_METHOD', 'a12_webservices.validate');

/**
 * Implements hook_menu().
 */
function a12_connect_menu() {
  $items['admin/config/system/a12'] = array(
    'title'             => 'A12 Connection Settings',
    'description'       => 'Settings for A12 Webservices.',
    'page callback'     => 'drupal_get_form',
    'page arguments'    => array('a12_connect_settings'),
    'file'              => 'a12_connect.pages.inc',
    'access arguments'  => array('administer a12 connector'),
  );
  return $items;
}

/**
 * Implements hook_permission().
 */
function a12_connect_permission() {
  return array(
    'administer a12 connector' => array(
      'title' => t('Administer A12 Connector'),
      'description' => t('Can configure the A12 connection settings.'),
    ),
  );
}

/**
 * Get the A12 Connector.
 *
 * This is statically cached so we do not uneccesarily create multiple 
 * connectors on a single page request.
 */
function a12_connect_get_connector() {
  $connector = &drupal_static(__FUNCTION__);
  if (!$connector) {
    global $base_url;
    $secret = variable_get('a12_key', NULL);
    $key = variable_get('a12_identifier', NULL);

    $connector = new A12Connector($key, $secret, $base_url);
  }

  return $connector;
}

/**
 * Validate credentials of the subscription.
 *
 * @return bool
 *   TRUE if valid credentials.
 */
function a12_connect_credentials_validate($form, &$form_state) {
  $values = $form_state['values'];
  $key = trim($values['a12_identifier']);
  $secret = trim($values['a12_key']);

  global $base_url;
  $connector = new A12Connector($key, $secret, $base_url);

  try {
    $result = $connector->authenticate();
  }
  catch (A12ConnectorException $e) {
    drupal_set_message($e->getMessage(), 'error');
    form_set_error('a12_identifier', "");
    form_set_error('a12_key', "");
    return FALSE;
  }

  return $result;
}

/**
 * Deletes A12 subscription settings.
 */
function a12_connect_delete_submit() {
  variable_del('a12_key');
  variable_del('a12_identifier');
  return drupal_set_message(t('Settings deleted'));
}

/**
 * A12 settings form.
 */
function a12_connect_credentials_submit($form, $form_state) {
  variable_set('a12_key', $form_state['values']['a12_key']);
  variable_set('a12_identifier', $form_state['values']['a12_identifier']);
  drupal_set_message(t('Subscription details saved.'));
}
