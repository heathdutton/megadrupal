<?php
/**
 * @file
 * The A12 Search Synonyms module provides functions to connect to A12
 * services.
 */

/**
 * Form submission handler for enterprise_search_synonyms_form().
 */
function a12_synonyms_synonyms_submit($form, &$form_state) {
  variable_set('ES_synonyms_expand', $form_state['values']['expand']);
  variable_set('ES_case_sensitive', $form_state['values']['casesensitive']);
  $vid = db_query("SELECT vid FROM {taxonomy_vocabulary} WHERE machine_name = 'search_synonyms'")->fetchField();
  $env_id = apachesolr_default_environment();
  $solr = apachesolr_get_solr($env_id);
  $solr->setSynonyms(a12_synonyms_synonyms_json($vid));
  drupal_set_message(t('Synonyms metadata successfully submitted to A12 Find.'), 'status');
}

/**
 * Builds the synonyms.txt compatible json.
 *
 * @return string
 *   The json encoded synonyms document.
 */
function a12_synonyms_synonyms_json($vid) {
  $data[] = variable_get('ES_synonyms_expand');
  $data[] = variable_get('ES_case_sensitive');
  $terms = taxonomy_get_tree($vid);
  foreach ($terms as $term) {
    $data[] = taxonomy_term_load($term->tid);
  }
  return json_encode($data);
}

function a12_synonyms_form_enterprise_search_features_form_alter(&$form,
                                                                 &$form_state, $form_id) {
  $form['synonyms']['message'] = array(
    '#markup' => t(''),
  );
  $form['synonyms']['expand'] = array(
    '#type' => 'checkbox',
    '#title' => t('Expand'),
    '#default_value' => variable_get('ES_synonyms_expand', 1)
  );
  $form['synonyms']['casesensitive'] = array(
    '#type' => 'checkbox',
    '#title' => t('Case sensitive'),
    '#default_value' => variable_get('ES_case_sensitive', 0)
  );
  $form['synonyms']['taxonomy_link'] = array(
    '#markup' => l('Add synonyms', 'admin/structure/taxonomy/search_synonyms'),
    '#suffix' => t('<br/><br/>')
  );
  $form['synonyms']['action'] = array(
    '#type' => 'submit',
    '#value' => t('Deploy Synonyms to A12 Find'),
    '#submit' => array('a12_synonyms_synonyms_submit'),
  );
}