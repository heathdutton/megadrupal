<?php
/**
 * @file
 * The A12 Elevated search results module provides functions to connect to A12
 * services.
 */

/**
 * Implements hook_menu_alter().
 *
 * Reorganise the Apache Solr search modules menu items to make room for
 * Enterprise Search menu items.
 */
function a12_elevated_search_results_menu_alter(&$menu) {
  $menu['admin/config/search/solr_best_bets']['page arguments'] = array('a12_elevated_search_results_elevate_form');
  $menu['admin/config/search/solr_best_bets']['description'] = 'Deploy elevations to Axis12 Find.';
  $menu['admin/config/search/solr_best_bets/advanced'] = FALSE;
  $menu['admin/config/search/solr_best_bets/keygen'] = FALSE;
}

/**
 * Implements hook_form().
 */
function a12_elevated_search_results_elevate_form($form) {
  $form['actions']['elevate'] = array(
    '#type' => 'submit',
    '#value' => t('Deploy Elevation to A12 Find'),
    '#submit' => array('a12_elevated_search_results_elevate_submit'),
  );
  return $form;
}

/**
 * Form submission handler for a12_elevated_search_results_elevate_form().
 */
function a12_elevated_search_results_elevate_submit() {
  $env_id = apachesolr_default_environment();
  $environment = apachesolr_environment_load($env_id);
  $environment_current = array(
    'label' => 'Apache Solr: ' . $environment['name'],
    'id callbacks' => array('enterprise_search_document_id'),
    'name' => 'apachesolr:' . $environment['env_id'],
    'id options' => array("unique field" => 'id', 'url' => $environment['url']),
  );
  $solr = apachesolr_get_solr($env_id);
  $response = $solr->setElevate(a12_elevated_search_results_elevate_json($environment_current));

  // Set all best bets term status to sent.
  db_update('solr_best_bets')
    ->fields(array(
      'status' => 2,
    ))
    ->execute();

  // Set global best bets synched flag.
  variable_set('enterprise_search_synonyms_sync', '1');

  drupal_set_message(t('Elevation metadata successfully submitted to A12 Find.'), 'status');
}

/**
 * Builds the elevate.xml compatible json.
 *
 * @param array $environment
 *   The environment definition.
 *
 * @return string
 *   The json encoded elevate document.
 */
function a12_elevated_search_results_elevate_json(array $environment) {
  $sql = '
    SELECT content_id, query_text, exclude
    FROM {solr_best_bets}
    WHERE environment = :environment
    AND status != 3
    ORDER BY query_text, weight
  ';
  $result = db_query($sql, array(':environment' => $environment['name']));
  foreach ($result as $record) {
    // Contine to the next value if the ID cannot be resolved.
    if (FALSE === ($transformed_id = solr_best_bets_transform_id($record->content_id, $environment))) {
      watchdog('solr_best_bets', 'ID not transformed to index value: @id', array('@id' => $record->content_id), WATCHDOG_WARNING);
      continue;
    }
    $record->id = $transformed_id;
    $data[] = (array) $record;
  }

  return json_encode($data);
}

/**
 * Implements hook_views_api().
 */
function a12_elevated_search_results_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'a12_elevated_search_results') . '/views',
  );
}

/**
 * Implements hook_form_alter().
 */
function a12_elevated_search_results_form_solr_best_bets_node_form_alter(&$form, &$form_state, $form_id) {
  $form['actions']['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Add as best bet for search query'),
    '#submit' => array('a12_elevated_search_results_save_best_bets_submit'),
  );
}

/**
 * Saves a best bet entry to the database.
 *
 * @param array $values
 *   An associative array of the values being saved containing:
 *     - content_id:
 *     - query_text:
 *     - environment:
 *     - exclude: (optional)
 *     - weight: (optional)
 *
 * @return bool
 *   The success of the operation.
 */
function a12_elevated_search_results_best_bets_save(array $values) {
  $defaults = array(
    'environment' => FALSE,
    'content_id' => FALSE,
    'query_text' => FALSE,
    'exclude' => 0,
    'weight' => 0,
    'status' => 1,
  );
  $keys = array(
    'environment' => TRUE,
    'content_id' => TRUE,
    'query_text' => TRUE,
  );

  // Merge in defaults, strip out all of the other stuff.
  $values = array_intersect_key($values + $defaults, $defaults);

  // Ensure we have all required values.
  if (!in_array(FALSE, $values, TRUE)) {
    $values['query_text'] = drupal_strtolower($values['query_text']);
    db_merge('solr_best_bets')
      ->key(array_intersect_key($values, $keys))
      ->fields(array_diff_key($values, $keys))
      ->execute();
    return TRUE;
  }

  return FALSE;
}

/**
 * Form submission handler for solr_best_bets_node_form().
 */
function a12_elevated_search_results_save_best_bets_submit($form, &$form_state) {
  $node = $form_state['build_info']['args'][0];
  if (!empty($form_state['values']['query_text'])) {
    // Save the best bet, build status message and type based on the result.
    if (a12_elevated_search_results_best_bets_save($form_state['values'])) {
      $message = '%title is set as a best bet for the search query %query.';
      $type = 'status';
    }
    else {
      $message = 'Error setting %title as a best bet for the search query %query.';
      $type = 'error';
    }
    // Display the status message to the user.
    $args = array(
      '%title' => $node->title,
      '%query' => $form_state['values']['query_text']
    );
    drupal_set_message(t($message, $args), $type);
  }
  $form_state['redirect'] = 'node/' . $node->nid . '/solr_best_bets';
}

/**
 * Implements hook_form_alter().
 */
function a12_elevated_search_results_form_alter(&$form, &$form_state, $form_id) {
  if ($form['form_id']['#value'] == 'solr_best_bets_node_overview') {
    $form['options']['submit'] = array(
      '#type' => 'submit',
      '#value' => t('Update'),
      '#submit' => array('a12_elevated_search_node_overview_submit'),
    );
  }
}

/**
 * Form submission handler for solr_best_bets_node_overview().
 */
function a12_elevated_search_node_overview_submit($form, &$form_state) {
  // Flag whether we the content should be excluded or not. This is ignored for
  // delete operations.
  $exclude = (int) ($form_state['values']['operation'] == 'exclude_yes');

  // Get query test and environment for best bets being acted on.
  $records = array_filter($form_state['values']['table']);
  foreach ($records as $id) {
    list($query_text, $environment) = array_map('rawurldecode', explode(':', $id));
    $records[$id] = array(
      'content_id' => $form_state['values']['content_id'],
      'query_text' => $query_text,
      'environment' => $environment,
      'exclude' => $exclude,
    );
  }

  // Take action on selected items.
  if ($records) {
    module_load_include('inc', 'solr_best_bets', 'solr_best_bets.crud');
    switch ($form_state['values']['operation']) {
      case 'delete':
        a12_elevated_search_results_delete($records);
        break;

      case 'exclude_yes':
      case 'exclude_no':
        $exclude = ($form_state['values']['operation'] == 'exclude_yes');
        solr_best_bets_update_exclude($records, $exclude);
        break;
    }
  }
}

/**
 * Sets delete status on best bet entries in the database.
 *
 * @param array $records
 *   An associative array of the values being saved containing:
 *     - content_id:
 *     - query_text:
 *     - environment:
 */
function a12_elevated_search_results_delete(array $records) {
  $update = db_update('solr_best_bets')->fields(array(
    'status' => 3,
  ));
  $or = db_or();
  foreach ($records as $values) {
    $or->condition(
      db_and()
        ->condition('environment', $values['environment'])
        ->condition('content_id', $values['content_id'])
        ->condition('query_text', $values['query_text'])
    );
  }
  $update->condition($or);
  $update->execute();
}

/**
 * Returns back the number of terms.
 */
function a12_elevated_search_results_terms_cardinality($set) {
  switch ($set) {
    case 'all':
      $result = db_select('solr_best_bets', 'best_bets')
        ->fields('best_bets')
        ->execute();
      $value = $result->rowCount();
      break;
    case 'sent':
      $result = db_select('solr_best_bets', 'best_bets')
        ->fields('best_bets')
        ->condition('status', '2', '=')
        ->execute();
      $value = $result->rowCount();
      break;
    case 'not sent':
      $result = db_select('solr_best_bets', 'best_bets')
        ->fields('best_bets')
        ->condition('status', '1', '=')
        ->execute();
      $value = $result->rowCount();
      break;
    case 'deleted':
      $result = db_select('solr_best_bets', 'best_bets')
        ->fields('best_bets')
        ->condition('status', '3', '=')
        ->execute();
      $value = $result->rowCount();
      break;
    default:
      break;
  }
  return $value;
}

/**
 * Returns the page markup for Elevated Search Results.
 */
function a12_elevated_search_results_markup() {
  drupal_add_library('system', 'ui.dialog');
  drupal_add_css(drupal_get_path('module', 'a12_elevated_search_results') . '/css/style.css');
  drupal_add_js(drupal_get_path('module', 'a12_elevated_search_results') . '/js/tooltip.js');
  if (variable_get('enterprise_search_synonyms_sync') == '0') {
    drupal_set_message(t('Your elevated search results are out of sync with the
     server. Please re-deploy. !readmore.',
      array(
        '!readmore' => l('Read more', 'http://axistwelve.com/elevated-search-results#out-of-sync',
          array('attributes' => array('target' => '_blank')))
      )), 'error');
  }
  $output = t('This enables you to configure the top results for any given query by associating content with specific keywords. !readmore.',
    array(
      '!readmore' => l('Read more', 'http://axistwelve.com/elevated-search-results',
        array('attributes' => array('target' => '_blank')))
    ));
  $output .= views_embed_view('elevated-search-results', 'default');
  if (variable_get('enterprise_search_synonyms_sync') == '1') {
    $status_message = 'Status: @all items (@sent active, @notsent to be deployed
    and @deleted to be deleted)';
  }
  else {
    $status_message = 'Status: unknown';
  }
  $output .= t($status_message, array(
    '@notsent' => a12_elevated_search_results_terms_cardinality('not sent'),
    '@sent' => a12_elevated_search_results_terms_cardinality('sent'),
    '@all' => a12_elevated_search_results_terms_cardinality('all'),
    '@deleted' => a12_elevated_search_results_terms_cardinality('deleted')
  ));

  // Render form for Deploy All action
  $output .= drupal_render(drupal_get_form
  ('a12_elevated_search_results_elevate_form'));
  $output .= '<div id = "dialog"
  title = "Elevated Search Results" style="display: none;">
  <p>Active terms have been sent to the A12 Find service.</p>

  <p>Inactive terms have not been sent to the A12 Find service.</p>

  <p>Deleted terms will be removed after a Deploy.</p>

  <p>Undefined status is visible when the search index core or environment is
    changed. Re-deploy to submit elevated search terms metadata to the A12
    Find Service.</p>

  <p>
    <a href = "http://axistwelve.com/elevated-search-results#status"
      target = "_blank">
      Read More.
    </a>
  </p>
</div>';

  $variables['element']['#attributes']['class'][] = 'collapsible';
  $variables['element']['#children'] = '';
  $variables['element']['#description'] = '';
  $variables['element']['#id'] = 'Elevated Search Results';
  $variables['element']['#title'] = 'Elevated Search Results';
  $variables['element']['#value'] = $output;
  $output = theme('fieldset', $variables);
  return $output;
}

/**
 * Implementation of hook_action_info().
 */
function a12_elevated_search_results_action_info() {
  $action = array(
    'elevated_search_delete' => array(
      'label' => t('Delete Selected'),
      'description' => t('Delete Elevated Search Terms.'),
      'type' => 'solr_best_bets',
      'configurable' => FALSE,
    ),
    'elevated_search_deploy' => array(
      'label' => t('Deploy All'),
      'description' => t('Deploy all elevated search terms.'),
      'type' => 'solr_best_bets',
      'configurable' => FALSE,
      'vbo_configurable' => FALSE,
      'triggers' => array('any'),
    ),
  );
  return $action;
}

/**
 * Implements hook_entity_info().
 *
 * Necessary in order to use VBO on solr best bets.
 */
function a12_elevated_search_results_entity_info() {
  return array(
    'solr_best_bets' => array(
      'label' => t('solr_best_bets'),
      'base table' => 'solr_best_bets',
      'entity keys' => array(
        'id' => 'query_text',
      ),
    ),
  );
}

/**
 * Action callback to delete selected terms.
 *
 * @param object $items
 *   A StdClass that contains the data from the database row.
 * @param array $context
 *   An array of information passed into the action by the action executor.
 */
function elevated_search_delete($items, $context) {
  // Delete terms marked for deletion.
  db_update('solr_best_bets')
    ->fields(array(
      'status' => 3,
    ))
    ->condition('content_id', $items->content_id)
    ->condition('query_text', $items->query_text)
    ->execute();
}

/**
 * Action callback to deploy elevated search metadata to A12 Find Server.
 *
 * @param object $items
 *   A StdClass that contains the data from the database row.
 * @param array $context
 *   An array of information passed into the action by the action executor.
 */
function elevated_search_deploy($items, $context) {
  $env_id = apachesolr_default_environment();
  $environment = apachesolr_environment_load($env_id);
  $environment_current = array(
    'label' => 'Apache Solr: ' . $environment['name'],
    'id callbacks' => array('apachesolr_entity_document_id'),
    'name' => 'apachesolr:' . $environment['env_id'],
    'id options' => array("unique field" => 'id'),
  );
  $solr = apachesolr_get_solr($env_id);
  $solr->setElevate(a12_elevated_search_results_elevate_json($environment_current));

  // Deleted terms marked for deletion.
  db_delete('solr_best_bets')
    ->condition('status', 3)
    ->execute();

  // Set all best bets term status to sent.
  db_update('solr_best_bets')
    ->fields(array(
      'status' => 2,
    ))
    ->execute();

  // Set global best bets synched flag.
  variable_set('enterprise_search_synonyms_sync', '1');

  drupal_set_message(t('Elevated Search Results metadata successfully
  submitted to A12 Find.'), 'status');
}