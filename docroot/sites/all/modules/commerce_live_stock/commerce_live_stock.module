<?php
/**
 * @file
 * Defines features and functions for the Commerce Live Stock module.
 */

/**
 * Implements hook_rules_action_info().
 */
function commerce_live_stock_rules_action_info() {
  $items = array();
  $items['rules_commerce_live_stock'] = array(
    'label' => t('Commerce Live Stock'),
    'group' => t('commerce live stock'),
    'parameter' => array(
      'commerce_line_item' => array(
        'type' => 'commerce_line_item',
        'label' => t('Line item'),
      ),
    ),
    'base' => 'commerce_live_stock_rules_process',
  );
  return $items;
}

/**
 * Action: Live instant stock.
 */
function commerce_live_stock_rules_process($line_item) {
  $sku = $line_item->line_item_label;
  $info = field_info_field('commerce_stock');
  $message = (object) array(
    'data' => (object) array(
      'sku' => $sku,
      'precision' => $info['columns']['value']['scale'],
      'quantity' => $line_item->quantity,
    ),
    'channel' => 'commerce_live_stock_channel',
    'callback' => 'commerce_live_stock',
  );
  Nodejs::enqueueMessage($message);
}

/**
 * Implements hook_nodejs_handlers_info().
 */
function commerce_live_stock_nodejs_handlers_info() {
  return array(
    drupal_get_path('module', 'commerce_live_stock') . '/commerce_live_stock.js');
}

/**
 * Implements hook_nodejs_user_channels().
 */
function commerce_live_stock_nodejs_user_channels($account) {
  return array(
    'commerce_live_stock_channel',
  );
}

/**
 * Implements hook_preprocess_field().
 */
function commerce_live_stock_preprocess_field(&$variables, $hook) {
  if ($variables['element']['#field_name'] == 'commerce_stock') {
    $variables['classes_array'][] = 'product-' . $variables['element']['#object']->sku;
  }
}
