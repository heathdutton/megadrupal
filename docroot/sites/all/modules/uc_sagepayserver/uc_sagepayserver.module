<?php

// Simulator, Test and live Sagepay Server transaction notification URL's
define('UC_SAGEPAYSERVER_SIMULATOR_URL', 'https://test.sagepay.com/Simulator/VSPServerGateway.asp?Service=VendorRegisterTx');
define('UC_SAGEPAYSERVER_TEST_URL', 'https://test.sagepay.com/gateway/service/vspserver-register.vsp');
define('UC_SAGEPAYSERVER_LIVE_URL', 'https://live.sagepay.com/gateway/service/vspserver-register.vsp');

function uc_sagepayserver_init() {
  // If the form is checkout review and we have an error flag, display the relevant error
  if (isset($_GET['uc_sagepayserver_error'])) {
    switch ($_GET['uc_sagepayserver_error']) {
      case 'notauthed':
          // Authorisation was failed by the bank
          drupal_set_message(t('Your payment was declined by the bank. This could be due to insufficient funds, or incorrect card details. If the problem persists, contact your bank.'), 'error');
        break;
      case 'error':
          // An error has occurred at Sage Pay ... they normally indicate a problem with bank connectivity
          drupal_set_message(t('We could not process your order because our Payment Gateway service was experiencing difficulties. Please contact us for assistance.'), 'error');
        break;
      case 'rejected':
          // Fraud screening rules were not met
          drupal_set_message(t('Your order did not meet our minimum fraud screening requirements. If you have questions about our fraud screening rules, or wish to discuss this, please contact us.'), 'error');
        break;
    }
  }
  else {
    drupal_get_messages('error', TRUE);
  }
}

/**
 * Implementation of hook_menu().
 * Add items to Drupal's menu system
 */
function uc_sagepayserver_menu() {
  // URL for Sagepay Server to send it's notifications to
  $items['uc_sagepayserver/%/notification/%'] = array(
    'title' => 'Sagepay Server Notification',
    'page callback' => 'uc_sagepayserver_notification',
    'page arguments' => array(1, 3),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
    'file' => 'uc_sagepayserver.pages.inc'
  );
  // URL for user to be directed to on order completion
  $items['order/%/thankyou'] = array(
    'title' => 'Thank you for your order',
    'page callback' => 'uc_sagepayserver_order_thankyou',
    'page arguments' => array(1),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
    'file' => 'uc_sagepayserver.pages.inc'
  );
  return $items;
}

/**
 * Implementation of hook_uc_payment_method().
 *
 * Add config form to Ubercart Payment Methods administration page
 */
function uc_sagepayserver_uc_payment_method() {
  $methods[] = array(
    'id' => 'uc_sagepayserver',
    'name' => t('Sagepay Server'),
    'title' => t('Sagepay Server'),
    'description' => t('Pay using Sagepay Server.'),
    'callback' => 'uc_payment_method_sagepayserver',
    'checkout' => FALSE,
    'weight' => 1,
  );
  return $methods;
}

/**
 * Callback for hook_uc_payment_method (see uc_sagepayserver_uc_payment_method)
 */
function uc_payment_method_sagepayserver($op, &$order, $form = NULL, &$form_state = NULL) {
  switch ($op) {
    case 'settings':
      $form['uc_payment_method_sagepayserver']['uc_sagepayserver_mode'] = array(
        '#type' => 'radios',
        '#title' => t('Transaction registration mode'),
        '#description' => t('Choose between simulator, test and live modes. When using the live mode, actual transactions will take place.'),
        '#required' => TRUE,
        '#default_value' => variable_get('uc_sagepayserver_mode', 0),
        '#options' => array(t('Simulator'), t('Test'), t('Live')),
      );
      $form['uc_payment_method_sagepayserver']['uc_sagepayserver_vendor_name'] = array(
        '#type' => 'textfield',
        '#title' => t('Vendor name'),
        '#description' => t('This should contain the vendor name supplied by Sagepay when your account was created.'),
        '#required' => TRUE,
        '#default_value' => variable_get('uc_sagepayserver_vendor_name', NULL),
      );
      $form['uc_payment_method_sagepayserver']['uc_sagepayserver_debug_notifications'] = array(
        '#type' => 'checkbox',
        '#title' => t('Show debug info in the logs for payment notifications.'),
        '#default_value' => variable_get('uc_sagepayserver_debug_notifications', FALSE),
      );
      return $form;
  }
}

/**
 * Implementation of hook_form_alter().
 */
function uc_sagepayserver_form_alter(&$form, &$form_state, $form_id) {
  // Add required stuff to the Ubercart order review form
  if ($form_id == 'uc_cart_checkout_review_form' && ($order_id = intval($_SESSION['cart_order'])) > 0) {
    $order = uc_order_load($order_id);
    // If uc_sagepayserver is the selected method ...
    if ($order->payment_method == 'uc_sagepayserver') {
      // ... alter the checkout form to integrate with uc_sagepayserver
      // Point the form at the processing URL
      $form['#submit'] = array('uc_sagepayserver_checkout_form_submit');
    }
  }
}
 
 /**
  * Implementation of hook_form_alter on the uc_cart_checkout_form to
  * make elements conform with sagepays maxlengths etc.
  */
function uc_sagepayserver_form_uc_cart_checkout_form_alter(&$form, &$form_state) {
  //Billing Address
  $form['panes']['billing']['billing_first_name']['#maxlength'] = 20;
  $form['panes']['billing']['billing_last_name']['#maxlength'] = 20;
  $form['panes']['billing']['billing_street1']['#maxlength'] = 100;
  $form['panes']['billing']['billing_city']['#maxlength'] = 40;
  $form['panes']['billing']['billing_phone']['#maxlength'] = 20;

  //Delivery Address
  $form['panes']['delivery']['delivery_first_name']['#maxlength'] = 20;
  $form['panes']['delivery']['delivery_last_name']['#maxlength'] = 20;
  $form['panes']['delivery']['delivery_street1']['#maxlength'] = 100;
  $form['panes']['delivery']['delivery_city']['#maxlength'] = 40;
  $form['panes']['delivery']['delivery_phone']['#maxlength'] = 20;
}

/**
 * Intercept the checkout form submission, send data to Sagepay, and respond to returned data
 */
function uc_sagepayserver_checkout_form_submit($form, &$form_state) {

  global $user;
  global $base_url;
  
  // Get order details
  $order = uc_order_load($_SESSION['cart_order']);  
  // Generate a unique vendor_tx_code
  $vendor_tx_code = "AUTH-" . (rand(0, 32000)*rand(0, 32000)) . "-" . $order->order_id;
  
  // Get billing country code
  $country_data = uc_get_country_data(array('country_id' => $order->billing_country));
  $billing_country_iso_code = $country_data[0]["country_iso_code_2"];  
  // If delivery country was specified, get the code - make sure delivery_street1 is present as well as another country can be specified by default.
  if (($order->delivery_country) && ($order->delivery_street1)) {
    $country_data = uc_get_country_data(array('country_id' => $order->delivery_country));
    $delivery_country_iso_code = $country_data[0]["country_iso_code_2"];
  }
  // Otherwise just use billing country code
  else {
    $delivery_country_iso_code = $billing_country_iso_code;
  }
  
  // Set description
  $description = _uc_sagepayserver_make_order_description($order);
  // Set basket
  $basket = _uc_sagepayserver_make_order_basket($order);
  // Set data to be sent to processor
  // Sagepay requires delivery fields, so we have to provide them even if the product is not a deliverable
  // When no delivery fields are provided in the order, use the billing fields instead
  $nvp_request = array(
    // Merchant Information
    'VPSProtocol' => '2.23',
    'TxType' => 'PAYMENT',
    'Vendor' => variable_get('uc_sagepayserver_vendor_name', NULL),
    'VendorTxCode' => $vendor_tx_code,
    'Amount' => number_format(check_plain($order->order_total, "number"), 2, '.', ''),
    'Currency' => variable_get('uc_currency_code', 'USD'),
    'Description' => check_plain($description),
    'BillingSurname' => check_plain($order->billing_last_name),
    'BillingFirstnames' => check_plain($order->billing_first_name),
    'BillingAddress1' => check_plain($order->billing_street1),
    'BillingAddress2' => check_plain($order->billing_street2),
    'BillingCity' => check_plain($order->billing_city),
    'BillingPostcode' => check_plain($order->billing_postal_code),
    'BillingCountry' => check_plain($billing_country_iso_code),
    'BillingPhone' => check_plain($order->billing_phone),
    'DeliverySurname' => (empty($order->delivery_last_name)) ? check_plain($order->billing_last_name) : check_plain($order->delivery_last_name),
    'DeliveryFirstnames' => (empty($order->delivery_first_name)) ? check_plain($order->billing_first_name) : check_plain($order->delivery_first_name),
    'DeliveryAddress1' => (empty($order->delivery_street1)) ? check_plain($order->billing_street1) : check_plain($order->delivery_street1),
    'DeliveryAddress2' => (empty($order->delivery_street2)) ? check_plain($order->billing_street2) : check_plain($order->delivery_street2),
    'DeliveryCity' => (empty($order->delivery_city)) ? check_plain($order->billing_city) : check_plain($order->delivery_city),
    'DeliveryCountry' => check_plain($delivery_country_iso_code),
    'DeliveryPostcode' => (empty($order->delivery_postal_code)) ? check_plain($order->billing_postal_code) : check_plain($order->delivery_postal_code),
    'Basket' => check_plain($basket),
    'NotificationURL' => url('uc_sagepayserver/' . $order->order_id . '/notification/' . uc_cart_get_id(), array('absolute' => TRUE))
  );
  // Only provide BillingState and DeliveryState fields if country is US
  if ($billing_country_iso_code == 'US') {
    // Get billing state code
    if ($order->billing_zone) {
      $nvp_request['BillingState'] = uc_get_zone_code(intval($order->billing_zone));
    }
    // Get delivery state code, if state was provided and is US
    if ($order->delivery_zone) {
      $nvp_request['DeliveryState'] = uc_get_zone_code(intval($order->delivery_zone));
    }
    // Otherwise, use billing state code
    else {
      $nvp_request['DeliveryState'] = uc_get_zone_code(intval($order->billing_zone));
    }
  }

  // Should the data be sent to the simulator, test or the live transaction notification url?
  switch (variable_get('uc_sagepayserver_mode', 0)) {
    case 0:
        $registration_url = UC_SAGEPAYSERVER_SIMULATOR_URL;
      break;
    case 1:
        $registration_url = UC_SAGEPAYSERVER_TEST_URL;
      break;
    case 2:
        $registration_url = UC_SAGEPAYSERVER_LIVE_URL;
      break;
    default:
        $registration_url = UC_SAGEPAYSERVER_SIMULATOR_URL;
      break;
  }
  // Send the data to the processor and await response
  $nvp_response = uc_sagepayserver_request($nvp_request, $registration_url);
  
  // Check for drupal_http_request errors
  if (isset($nvp_response->error)) {
    form_set_error('', t('There was an error processing the purchase. Please contact us.'));
    watchdog('uc_sagepayserver', "Drupal had a problem sending order data to Sagepay Server. drupal_http_request() failed.<br />Error Code: @code<br />Error Message: @error", array('@code' => $nvp_response->code, '@error' => $nvp_response->error), WATCHDOG_ERROR);
    return;
  }
  
  if (!$nvp_response->data || empty($nvp_response->data)) {
    form_set_error('', t('There was an error processing the purchase. Please contact us.'));
    watchdog('uc_sagepayserver', 'No data returned from Sagepay Server notification URL', array(), WATCHDOG_NOTICE);
    uc_order_update_status($order->order_id, 'in_checkout');
    return;
  }
  
  // Turn the response data string into a convenient array
  $nvp_response_data = _uc_sagepayserver_response_to_array($nvp_response->data);
  
  // Check the response and take the appropriate action
  // VPSProtocol
  if ($nvp_response_data['VPSProtocol'] != '2.23') {
    form_set_error('', t('There was an error processing the purchase. Please contact us.'));
    watchdog('uc_sagepayserver', 'The VPSProtocol returned from Sagepay Server does not match the VPSProtocol of the notification data', array(), WATCHDOG_NOTICE);
    uc_order_update_status($order->order_id, 'in_checkout');
    return;
  }
  // Status
  if ($nvp_response_data['Status'] == 'OK' || $nvp_response_data['Status'] == 'OKREPEATED') {
    /**
     * If status is okay set an appropriate status for the order (uc_sagepayserver pending?)
     * and store the Security Key, NextURL and VPSTxId with the orderId
     */
    // Set the order status
    uc_order_update_status($order->order_id, 'uc_sagepayserver_pending_result');    
    // Record data in uc_sagepayserver_transactions table
    $data = new stdClass();
    $data->order_id = $order->order_id;
    $data->vendor_transaction_code = $vendor_tx_code;
    $data->uc_sagepayserver_transaction_id = $nvp_response_data['VPSTxId'];
    $data->status = $nvp_response_data['Status'];
    $data->status_detail = $nvp_response_data['StatusDetail'];
    $data->security_key = $nvp_response_data['SecurityKey'];
    $data->received = REQUEST_TIME;
    drupal_write_record('uc_sagepayserver_transactions', $data);    
    header('Location: ' . $nvp_response_data['NextURL']);
    module_invoke_all('exit');
    exit();
  }
  else {
    // Log status detail
    watchdog('uc_sagepayserver', $nvp_response_data['StatusDetail'], NULL, WATCHDOG_ERROR);
    form_set_error('', t('There was an error processing the purchase. Please contact us.'));
    watchdog('uc_sagepayserver', 'Sagepay Server sent a not OK response.@debug', array('@debug' => variable_get('uc_sagepayserver_debug_notifications', FALSE) ? print_r($nvp_response_data, TRUE) : ''), WATCHDOG_NOTICE);
    uc_order_update_status($order->order_id, 'in_checkout');
    return;
  }
  return;
}

// Sends a request to remote server and return a response array.
function uc_sagepayserver_request($request, $server) {
  $data = http_build_query($request, NULL, '&');
  $options = array(
    'method' => 'POST',
    'data' => $data,
    'headers' => array('Content-Type' => 'application/x-www-form-urlencoded')
  );
  $response = drupal_http_request($server, $options);
  return $response;
}

// Turns Sagepay's initial reponse to an array
function _uc_sagepayserver_response_to_array($nvpstr) {
  $response = preg_split("/[\n]/", $nvpstr);
  $output = array();
  for ($i=0; $i<count($response); $i++) {
    $splitAt = strpos($response[$i], "=");
    $output[trim(drupal_substr($response[$i], 0, $splitAt))] = trim(drupal_substr($response[$i], ($splitAt+1)));
  }
  return $output;
}

/**
 * Get a description string suitable for passing to Sagepay
 */
function _uc_sagepayserver_make_order_description($order) {  
  $site_name = variable_get('site_name', 'Drupal');
  $date_time = format_date(REQUEST_TIME, 'medium');
  $description = t('Purchase from @site_name on @date_time.', array('@site_name' => $site_name, '@date_time' => $date_time));
  $description = drupal_substr($description, 0, 100);  
  return $description;
}

/**
 * Create a description of the user's shopping basket that is in the correct
 * format for submission to Sagepay
 */
function _uc_sagepayserver_make_order_basket($order) {

  $basket = '';
  $break = ":";
  $no_lines = 0;
  
  foreach ($order->products as $product) {    
    $context = array(
      'revision' => 'altered',
      'type' => 'order_product',
      'subject' => array(
        'order' => $order,
        'product' => $product,
        'node' => node_load($product->nid),
      ),
    );    
    // Removed all refernce to uc_price as not present in Ubercart 3 
    $basket .= $break . str_replace(':', ' ', $product->title);
    $basket .= $break . $product->qty;
    $basket .= $break . number_format($product->price, 2, '.', '');
    $basket .= $break . '---';
    $basket .= $break . number_format($product->price, 2, '.', '');
    $basket .= $break . number_format(($product->qty * $product->price), 2, '.', '');
    $no_lines++;
  }  
  return $no_lines . $basket;  
}