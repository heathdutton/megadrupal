<?php

/**
 * Implements hook_menu().
 */
function update_exceptions_menu() {
  $items = array();
  $items['projects/%/%'] = array(
    'page callback' => 'update_exceptions_check',
    'page arguments' => array(1, 2),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Returns a fake "up-to-date" status.
 */
function update_exceptions_check($project, $core) {
  global $base_url;

  $site_key = isset($_GET['site_key']) ? $_GET['site_key'] : '';
  if ($site_key != drupal_hmac_base64($base_url, drupal_get_private_key())) {
    watchdog('update_exceptions', t('Unauthorized product version callback'), array(), WATCHDOG_ERROR);
    drupal_exit();
  }

  $module = system_get_info('module', $project);
  list($api, $numbers, $extra) = explode('-', $module['version'] .'---');
  list($major, $minor) = explode('.', $numbers .'..');

  $output = '<?xml version="1.0" encoding="utf-8"?>';
  $output .= '<project xmlns:dc="http://purl.org/dc/elements/1.1/">';
  $output .= '<title>'. $module['name'] .'</title>';
  $output .= '<short_name>'. $project .'</short_name>';
  $output .= '<api_version>'. $core .'</api_version>';
  $output .= '<project_status>published</project_status>';
  $output .= '<recommended_major>'. $major .'</recommended_major>';
  $output .= '<supported_majors>'. $major .'</supported_majors>';
  $output .= '<default_major>'. $major .'</default_major>';
  $output .= '<releases>';

  $output .= '<release>';
  $output .= '<name>'. $project .' '. $module['version'] .'</name>';
  $output .= '<version>'. $module['version'] .'</version>';
  $output .= '<tag>'. $module['version'] .'</tag>';
  $output .= '<version_major>'. $major .'</version_major>';
  if ($minor != 'x') {
    $output .= '<version_patch>'. $minor .'</version_patch>';
  }
  if (isset($extra)) {
    $output .= '<version_extra>'. $extra .'</version_extra>';
  }
  $output .= '<status>published</status>';
  $output .= '<release_link></release_link>';
  $output .= '<download_link></download_link>';
  $output .= '<date>0</date>';
  $output .= '</release>';

  $output .= '<release>';
  $output .= '<name>'. $project .' HEAD</name>';
  $output .= '<version>master</version>';
  $output .= '<tag>master</tag>';
  $output .= '<version_extra>dev</version_extra>';
  $output .= '<status>published</status>';
  $output .= '<release_link></release_link>';
  $output .= '<download_link></download_link>';
  $output .= '<date>0</date>';
  $output .= '</release>';

  $output .= '</releases>';
  $output .= '</project>';
  echo $output;

  drupal_exit();
}
