<?php

/**
 * @file
 * Provides the shopping cart in Userbar if there are items
 */

/**
 * Implements hook_userbar_info().
 * 
 * @see hook_userbar_info()
 */
function userbar_ubercart_userbar_info() {
  return array('userbar_ubercart' => array(
    'userbar_ubercart_cnt' => array('tip' => t('Shopping cart'), 'description' => t('Shopping cart'),
      'display' => "/" . drupal_get_path('module', 'uc_cart') . '/images/cart-full.png', 'type' => 'image'),
    )  );
}

/**
 * Implements hook_userbar_view().
 * 
 * @see hook_userbar_view()
 */
function userbar_ubercart_userbar_view($indexes) {  
  $output = array('userbar_ubercart' => array());
  if (in_array('userbar_ubercart_cnt', $indexes)) {
    if ($product_count = count(uc_cart_get_contents())) {
      $output['userbar_ubercart']['userbar_ubercart_cnt']=array('tip' => t("Shopping cart has !product_count items", array('!product_count' => $product_count)), 'description' => t('Shopping cart'),
        'callback' => 'cart', 'display' => "/" . drupal_get_path('module', 'uc_cart') . '/images/cart-full.png', 'type' => 'image');
    }    
  }
  return $output  ;
}

/**
 * track cart changes and update the cache for this user
 */
/**
 * Implements hook_uc_update_cart_item().
 *
 * @see hook_uc_update_cart_item()
 */
function userbar_ubercart_uc_update_cart_item($nid, $data = array(), $qty, $cid = NULL) {
  global $user;
  $content = userbar_ubercart_userbar_view(array('userbar_ubercart_cnt'));
  userbar_update_cache($user->uid, 'userbar_ubercart', 'userbar_ubercart_cnt',
    isset($content['userbar_ubercart']['userbar_ubercart_cnt'])? $content['userbar_ubercart']['userbar_ubercart_cnt'] : $content['userbar_ubercart']); 
}

/**
 * Implements  hook_uc_add_to_cart().
 * 
 * @see hook_uc_add_to_cart()
 */
function userbar_ubercart_uc_add_to_cart($nid, $qty, $data) {
  global $user;
  $content = userbar_ubercart_userbar_view(array('userbar_ubercart_cnt'));
  userbar_update_cache($user->uid, 'userbar_ubercart', 'userbar_ubercart_cnt',
    isset($content['userbar_ubercart']['userbar_ubercart_cnt'])? $content['userbar_ubercart']['userbar_ubercart_cnt'] : $content['userbar_ubercart']); 
}
