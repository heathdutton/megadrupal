<?php

/**
 * @file
 * Provides status of flagged content in Userbar
 */

/**
 * Implements hook_userbar_info().
 * 
 * @see hook_userbar_info()
 */
function userbar_flag_userbar_info() {
  return array('userbar_flag' => array(
    'userbar_flag_cnt' => array('tip' => t('Content updated'), 'description' => t('Content updated'),
      'display' => "/" . drupal_get_path('module', 'userbar_flag') . '/images/flag_new.png', 'type' => 'image'),
    )  );
}

/**
 * Implements hook_userbar_view().
 * 
 * @see hook_userbar_view()
 */
function userbar_flag_userbar_view($indexes) {  
  $output = array('userbar_flag' => array());
  if (in_array('userbar_flag_cnt', $indexes)) {
    global $user;
    if (isset($_SESSION["userbar_flag"])) {
      $last_check = $_SESSION["userbar_flag"];
    }
    else {
      $last_check = strtotime('now');
    }
    //  check if there is at least one record updated or commented since last refresh
    $result = db_query_range("select f.content_id id
          from {flag_content} f
          left outer join {node_revision} nr on nr.nid=f.content_id
          left outer join {comment} c on c.nid=f.content_id
          where f.uid=:user and (nr.timestamp > :timestamp or  c.changed > :timestamp) ", 0, 1,
        array(':user' => $user->uid, ':timestamp' => $last_check))->fetchField(0);
    //store the current time as last check    
    $_SESSION["userbar_flag"] = strtotime('now');
    if ($result) {
      $output['userbar_flag']['userbar_flag_cnt'] = array('tip' => t("Bookmarked content has been updated"), 'description' => t('Show if the bookmarked content is updated'),
        'callback' => 'bookmarks', 'display' => "/" . drupal_get_path('module', 'userbar_flag') . '/images/flag_new.png', 'type' => 'image');
    }    
    else {  
      $output['userbar_flag']['userbar_flag_cnt'] = array('description' => t('Shows links to bookmarks'), 'tip' => t('Bookmarks'),
        'callback' => 'bookmarks',
        'display' => "/" . drupal_get_path('module', 'userbar_flag') . '/images/flag.png', 'type' => 'image');
    }
  }
  return $output  ;
}

/**
 * Implements hook_user_login().
 * 
 * Set the last access time as the time the last check for updated content was done.
 * 
 * @see hook_user_login()
 */
function userbar_flag_user_login(&$edit, $account) {
  //set the user's last access as the time the last check was done for modified flagged content.
  $_SESSION["userbar_flag"] = $account->access;
}
