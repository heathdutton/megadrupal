<?php
/**
 * @file
 * Define Verticrawl search page.
 */

define("VERTICRAWL_SEARCH_API_CONFIG_ID", 101);

define("VERTICRAWL_SEARCH_PAGE_PATH_CONFIG_ID", 201);
define("VERTICRAWL_SEARCH_PAGE_TITLE_CONFIG_ID", 202);
define("VERTICRAWL_SEARCH_PAGE_DESCRIPTION_CONFIG_ID", 203);
define("VERTICRAWL_SEARCH_PAGE_DESCRIPTION_FORMAT_CONFIG_ID", 204);
define("VERTICRAWL_SEARCH_KEYWORD_WRAPPER_CONFIG_ID", 205);

define("VERTICRAWL_SEARCH_ADVANCED_SORT_BY_CONFIG_ID", 301);
define("VERTICRAWL_SEARCH_ADVANCED_MATCH_MODE_CONFIG_ID", 302);
define("VERTICRAWL_SEARCH_ADVANCED_DOCUMENT_TYPE_CONFIG_ID", 303);
define("VERTICRAWL_SEARCH_ADVANCED_SITE_URL_CONFIG_ID", 304);
define("VERTICRAWL_SEARCH_ADVANCED_GROUP_BY_SITE_CONFIG_ID", 305);
define("VERTICRAWL_SEARCH_ADVANCED_FILTER_BY_DATE_CONFIG_ID", 306);

define("VERTICRAWL_SEARCH_POWERED_BY", 399);

define("VERTICRAWL_SEARCH_DEFAULT_PATH", 'verticrawl-search');
define("VERTICRAWL_SEARCH_DEFAULT_TITLE", 'Verticrawl Search Engine');

/**
 * Implements hook_menu().
 */
function verticrawl_search_menu() {
  $path = VerticrawlHelper::getConfigValue(VERTICRAWL_SEARCH_PAGE_PATH_CONFIG_ID, VERTICRAWL_SEARCH_DEFAULT_PATH);
  $title = VerticrawlHelper::getConfigValue(VERTICRAWL_SEARCH_PAGE_TITLE_CONFIG_ID, VERTICRAWL_SEARCH_DEFAULT_TITLE);

  $items[$path] = array(
    'title' => $title,
    'description' => 'Page results from Verticrawl API',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('verticrawl_search_results_form'),
    'access arguments' => array('use verticrawl search'),
    'file' => 'verticrawl_search.search_page.inc',
    'type' => MENU_NORMAL_ITEM,
  );

  $items[$path . '/%'] = array(
    'title' => $title,
    'description' => 'Page results from Verticrawl API',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('verticrawl_search_results_form'),
    'access arguments' => array('use verticrawl search'),
    'file' => 'verticrawl_search.search_page.inc',
    'type' => MENU_NORMAL_ITEM,
  );

  $items['admin/config/search/verticrawl/search-php'] = array(
    'title' => 'Search PHP',
    'description' => 'Configuration for Verticrawl Search PHP component',
    'position' => 'left',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('verticrawl_search_admin_form'),
    'access arguments' => array('administer verticrawl search'),
    'file' => 'verticrawl_search.admin.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 0,
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function verticrawl_search_permission() {
  $permissions = array(
    'administer verticrawl search' => array(
      'title' => t('Administer Verticrawl search'),
    ),
    'use verticrawl search' => array(
      'title' => t('Use Verticrawl search'),
    ),
    'use verticrawl advanced_search' => array(
      'title' => t('Use Verticrawl advanced search'),
    ),
  );

  return $permissions;
}

/**
 * Implements hook_preprocess_page().
 */
function verticrawl_search_preprocess_page(&$vars, $hook) {
  $verticrawl_search_php_css_file_path = drupal_get_path('module', 'verticrawl_search') . "/css/verticrawl_search.css";
  drupal_add_css($verticrawl_search_php_css_file_path);

  $verticrawl_search_php_js_file_path = drupal_get_path('module', 'verticrawl_search') . "/js/verticrawl_search.js";
  drupal_add_js($verticrawl_search_php_js_file_path);
}

/**
 * Implements hook_theme().
 */
function verticrawl_search_theme($existing, $type, $theme, $path) {
  $module_path = drupal_get_path('module', 'verticrawl_search') . '/theme';

  $themes = array(
    'verticrawl_search__results' => array(
      'path'  => $module_path,
      'variables' => array(
        'urls' => NULL,
        'group_by_site' => FALSE,
        'current_url' => NULL,
      ),
      'template' => 'verticrawl-search--results',
    ),
    'verticrawl_search__pager' => array(
      'path'  => $module_path,
      'variables' => array(
        'pages' => NULL,
        'base_url' => NULL,
      ),
      'template' => 'verticrawl-search--pager',
    ),
    'verticrawl_search__answords' => array(
      'path'  => $module_path,
      'variables' => array(
        'answords' => NULL,
      ),
      'template' => 'verticrawl-search--answords',
    ),
  );
  return $themes;
}

/**
 * Implements hook_theme_registry_alter().
 *
 * Altering theme_registry to make available the template files to
 * template suggestion.
 */
function verticrawl_search_theme_registry_alter(&$theme_registry) {
  $extension   = '.tpl.php';
  $module_path = drupal_get_path('module', 'verticrawl_search');
  $files       = file_scan_directory($module_path . '/theme', '/' . preg_quote($extension) . '$/');
  foreach ($files as $file) {
    $template = drupal_basename($file->filename, $extension);
    $theme    = str_replace('-', '_', $template);
    list($base_theme, $specific) = explode('__', $theme, 2);
    // Don't override base theme.
    if (!empty($specific) && isset($theme_registry[$base_theme])) {
      $theme_info = array(
        'template'   => $template,
        'path'       => drupal_dirname($file->uri),
        'variables'  => $theme_registry[$base_theme]['variables'],
        'base hook'  => $base_theme,
        // Other available value: theme_engine.
        'type'       => 'module',
        'theme path' => $module_path,
      );
      $theme_registry[$theme] = $theme_info;
    }
  }
}

/**
 * Implements hook_block_info().
 */
function verticrawl_search_block_info() {
  $blocks['verticrawl_search_quick_form'] = array(
    'info' => t('Verticrawl search quick form'),
    'status' => TRUE,
    'region' => 'sidebar_first',
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function verticrawl_search_block_view($delta = '') {
  $block = array();

  switch ($delta) {
    case 'verticrawl_search_quick_form':
      if (user_access('use verticrawl search')) {
        $block['content'] = drupal_get_form('verticrawl_search_quick_form');
      }
      break;
  }
  return $block;
}

/**
 * Form constructor for the Verticrawl quick search frorm
 *
 * @see verticrawl_search_block_view()
 */
function verticrawl_search_quick_form($form, &$form_state) {
  // Keywords - text.
  $form['keywords'] = array(
    '#type' => 'textfield',
    '#size' => 15,
  );

  // Submit.
  $form['submit_button'] = array(
    '#type' => 'submit',
    '#value' => t('Search'),
  );

  $form['#submit'][] = 'verticrawl_search_quick_form_submit';

  return $form;
}

/**
 * Drupal form submit.
 *
 * @see verticrawl_search_quick_form()
 */
function verticrawl_search_quick_form_submit($form, &$form_state) {
  $query['query']['keywords'] = trim($form_state['values']['keywords']);

  $search_page_path = verticrawl_search_helper::getConfigValue(VERTICRAWL_SEARCH_PAGE_PATH_CONFIG_ID, VERTICRAWL_SEARCH_DEFAULT_PATH);

  $form_state['redirect'] = array(
    $search_page_path,
    $query,
  );
}
