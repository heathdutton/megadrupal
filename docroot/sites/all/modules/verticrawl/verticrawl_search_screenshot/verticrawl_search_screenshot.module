<?php
/**
 * @file
 * Define the Verticrawl Sreenshot features.
 */

define("VERTICRAWL_SEARCH_SCREENSHOT_API_CONFIG_ID", 102);
define("VERTICRAWL_SEARCH_SCREENSHOT_API_URL", 'http://admin.verticrawl.com/search/screenshot.php');

/**
 * Implements hook_menu().
 */
function verticrawl_search_screenshot_menu() {

  $items['admin/config/search/verticrawl/screenshot'] = array(
    'title' => 'Screenshot',
    'description' => 'Configuration for Verticrawl Search Screenshot component',
    'position' => 'left',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('verticrawl_search_screenshot_admin_form'),
    'access arguments' => array('administer verticrawl search'),
    'type' => MENU_LOCAL_TASK,
    'weight' => 1,
  );

  return $items;
}

/**
 * Drupal form.
 *
 * @see verticrawl_search_screenshot_menu()
 */
function verticrawl_search_screenshot_admin_form($form, &$form_state) {
  $form['intro'] = array(
    '#markup' => t('<p>You must have set your Screenshot API in <a href="http://www.verticrawl.com" target="_blank">Verticrawl</a> first.</p>'),
  );

  $api_key = VerticrawlHelper::getConfigValue(VERTICRAWL_SEARCH_SCREENSHOT_API_CONFIG_ID, '');

  $form['screenshot_api_key'] = array(
    '#type' => 'textfield',
    '#title' => t("API Key - Screenshot"),
    '#description' => t("Enter your <strong>Verticrawl Search PHP</strong> API Key for SCREENSHOT integration. You can find your own API Key or buy one <a href='http://www.verticrawl.com' target='_blank'>here</a>."),
    '#required' => TRUE,
    '#default_value' => $api_key,
  );

  $form['#submit'][] = 'verticrawl_search_screenshot_admin_form_submit';

  return system_settings_form($form);
}

/**
 * Callback submitting Drupal form.
 *
 * @see verticrawl_search_screenshot_admin_form()
 */
function verticrawl_search_screenshot_admin_form_submit($form, &$form_state) {
  $configs = array(
    'config_screenshot_api' => array(
      'config_id' => VERTICRAWL_SEARCH_SCREENSHOT_API_CONFIG_ID,
      'config_name'  => "screenshot_api_key",
      'config_value'   => $form_state['values']['screenshot_api_key'],
    ),
  );

  foreach ($configs as $config) {
    VerticrawlHelper::saveConfig($config);
  }

  drupal_flush_all_caches();
}

/**
 * Implements hook_preprocess().
 */
function template_preprocess_verticrawl_search__results(&$variables) {
  $screenshot_api_key = VerticrawlHelper::getConfigValue(VERTICRAWL_SEARCH_SCREENSHOT_API_CONFIG_ID, '');
  if (!empty($screenshot_api_key)) {
    $screenshot_url = VERTICRAWL_SEARCH_SCREENSHOT_API_URL;
    $screenshot_url .= '?DATABASE=' . $screenshot_api_key;
    $variables['screenshot_url'] = $screenshot_url;
  }
}
