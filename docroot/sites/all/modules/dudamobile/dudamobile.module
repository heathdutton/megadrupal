<?php

define('DUDAMOBILE_JS', -10000);
define('DUDAMOBILE_ADMINISTER_PERMISSION', 'administer dudamobile');

/**
 * Implments hook_init().
 */
function dudamobile_init() {
  if (variable_get('dudamobile_mobile_url') && !path_is_admin(current_path())) {
    $mobile_url = variable_get('dudamobile_mobile_url');

    drupal_add_js('http://static.mobilewebsiteserver.com/DM_redirect.js', array(
      'type'   => 'external',
      'group'  => DUDAMOBILE_JS,
      'weight' => -1000,
    ));
    drupal_add_js('DM_redirect("' . $mobile_url . '");', array(
      'type'   => 'inline',
      'group'  => DUDAMOBILE_JS,
      'weight' => -999,
    ));
  }
}

/**
 * Implements hook_menu().
 */
function dudamobile_menu() {
  $items['admin/config/services/dudamobile'] = array(
    'title'            => 'DudaMobile',
    'page callback'    => 'drupal_get_form',
    'page arguments'   => array('dudamobile_form'),
    'access arguments' => array(DUDAMOBILE_ADMINISTER_PERMISSION),
    'type'             => MENU_NORMAL_ITEM,
  );

  return $items;
}

function dudamobile_form($form, &$form_state) {
  $form['mobile_url'] = array(
    '#type'          => 'textfield',
    '#title'         => t('Mobile URL'),
    '#description'   => t('Enter the URL to the Dudamobile mobile site that you would like the user to redirect to if they are visiting this site via a mobile device. <br><strong>For example:</strong> http://m.example.com'),
    '#default_value' => variable_get('dudamobile_mobile_url'),
  );

  $form['actions']['submit'] = array(
    '#type'  => 'submit',
    '#value' => t('Submit'),
  );

  return $form;
}

/**
 * Submission handler.
 */
function dudamobile_form_submit(&$form, &$form_state) {
  variable_set('dudamobile_mobile_url', $form_state['values']['mobile_url']);
  drupal_set_message(t('Your changes have been saved.'), 'status', FALSE);
}
