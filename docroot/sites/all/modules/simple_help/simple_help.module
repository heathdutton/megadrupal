<?php

/**
 * @file
 * Creates help pages from module markdown readmes. This module is very
 * similar to advanced_help but we're only interested in markdown files.
 */

/**
 * Implements hook_permission().
 */
function simple_help_permission() {
  return array(
    'access simple help' => array(
      'title' => t('Access Simple help pages'),
      'restrict access' => TRUE,
    ),
  );
}

/**
 * Implements hook_menu().
 */
function simple_help_menu() {
  $items = $help_paths = array();

  $modules = module_list(TRUE, FALSE, TRUE);

  foreach ($modules as $module) {
    $path = drupal_get_path('module', $module);
    $readmes = array();
    foreach (glob($path . '/*.md') as $readme) {
      $readmes[] = $readme;
    }
    if (sizeof($readmes) == 0) {
      continue;
    }
    $help_paths[] = 'admin/simple-help/' . $module;
    if (sizeof($readmes) == 1) {
      $items['admin/simple-help/' . $module] = array(
        'title callback' => 'simple_help_title',
        'title arguments' => array($module),
        'page callback' => 'simple_help_page',
        'page arguments' => array($module, $readmes[0]),
        'access arguments' => array('access simple help'),
      );
    }
    elseif (sizeof($readmes) > 1) {
      $paths = array();
      foreach ($readmes as $readme) {
        $path = 'admin/simple-help/' . $module . '/' . $readme;
        $paths[] = $path;
        $items[$path] = array(
          'title callback' => 'simple_help_title',
          'title arguments' => array($module),
          'page callback' => 'simple_help_page',
          'page arguments' => array($module, $readme),
          'access arguments' => array('access simple help'),
        );
      }
      $items['admin/simple-help/' . $module] = array(
        'title callback' => 'simple_help_title',
        'title arguments' => array($module),
        'page callback' => 'simple_help_listing',
        'page arguments' => array($paths),
        'access arguments' => array('access simple help'),
      );
    }
  }

  if (sizeof($items)) {
    $items['admin/simple-help'] = array(
      'title' => 'Help',
      'description' => t('Markdown generated help pages.'),
      'page callback' => 'simple_help_listing',
      'page arguments' => array($help_paths),
      'access arguments' => array('access simple help'),
    );
  }

  return $items;
}

/**
 * Returns a page title.
 */
function simple_help_title($module) {
  return t('Help for @module', array('@module' => $module));
}

/**
 * Renders a markdown help file.
 */
function simple_help_page($module, $readme) {
  return _filter_markdown(file_get_contents($readme), NULL);
}

/**
 * Returns a simple listing page of help pages.
 */
function simple_help_listing($paths) {
  foreach ($paths as &$path) {
    $path = l(simple_help_title(basename($path)), $path);
  }
  return theme('item_list', array('items' => $paths));
}
