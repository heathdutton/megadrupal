<?php

function portchecker_menu() {
  $items['portchecker'] = array(
    'title' => 'Check port status',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('portchecker_form'),
    'access arguments' => array('access content'),
    'type' => MENU_NORMAL_ITEM,
  );
return $items;
}


function portchecker_form($form, &$form_state) {

	if(!empty($_SESSION['portchecker_port_status'])) {
		$form['status'] = array(
		'#markup' => '<p>' . $_SESSION['portchecker_port_status'] . '</p>',
		);
		$_SESSION['portchecker_port_status'] = '';
	}

	$form['host'] = array(
		'#title' => 'Host / IP:',
		'#type' => 'textfield',
		'#default_value' => $_SESSION['portchecker_host'],
		'#prefix' => '<div class="container-inline" style="float:left;margin-right: 8px;">',
		'#suffix' => '</div>',
		'#size'  => 24, 

	);
	
	$form['port'] = array(
		'#title' => t('Port:'),
		'#type' => 'textfield',
		'#default_value' => $_SESSION['portchecker_port'],
		'#prefix' => '<div class="container-inline" style="float:left;margin-right: 8px;">',
		'#suffix' => '</div>',
		'#size'  => 4, 
	);
	
	$form['submit'] = array(
		'#title' => '',
		'#type' => 'submit',
		'#value' => t('Check'),
		'#submit' => array('portchecker_form_submit'),
	);
	
	
	return $form;
}


function portchecker_form_submit($form, &$form_state) {
	if(!is_numeric($form_state['values']['port']) || !$form_state['values']['host']) {
		form_set_error('', 'A valid host and port number are required');
	}
	else { 
  
  // Validate host param
  $host = preg_replace("/[^a-zA-Z0-9.-]/", '', $form_state['values']['host']);

	exec('nc -v -w 3 ' . $host . ' -z ' . $form_state['values']['port'] . ' | grep "succeeded"', $out );
	$port_status = (empty($out[0])) ? '<b style="color:red">' . t('closed') . '</b>' : '<b style="color:#20cd24">' . t('open') . ' </b>';
	
	//drupal_set_message('Port <b>' . $form_state['values']['port'] . '</b> on host <b>' . $form_state['values']['host'] . '</b> is ' . $port_status);
	$_SESSION['portchecker_port_status'] = t('Port') . '<b> ' . $form_state['values']['port'] . '</b> ' . t('on host') . ' <b>' . $host . '</b> is ' . $port_status;
	$_SESSION['portchecker_port'] = $form_state['values']['port'];
	$_SESSION['portchecker_host'] = $host;
	
	}
}
?>
