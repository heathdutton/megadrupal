<?php

/**
 * @file
 * HiringThing module.
 */

/**
 * Implements hook_permission().
 */
function hiringthing_permission() {
  return array(
    'administer hiringthing' => array(
      'title' => t('Administer HiringThing'),
      'description' => t('Configure the HiringThing settings for API access.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function hiringthing_menu() {
  $items = array();

  $items['admin/config/services/hiringthing'] = array(
    'title' => 'HiringThing',
    'description' => t('Configure your HiringThing API key.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('hiringthing_admin_settings_form'),
    'access arguments' => array('administer hiringthing'),
    'file' => 'hiringthing.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * Implements hook_block_info().
 */
function hiringthing_block_info() {
  $blocks = array();

  $blocks['widget'] = array(
    'info' => t('HiringThing.com jobs widget'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );

  return $blocks;
}

/**
 * Implements hook_libraries_info().
 */
function hiringthing_libraries_info() {
  $libraries = array();

  $libraries['hiringthing'] = array(
    'name' => 'HiringThing',
    'vendor url' => 'http://www.hiringthing.com',
    'download url' => 'https://github.com/hiringthing/hiringthing_api_php',
    'version arguments' => array(
      'file' => 'hiringthing.inc',
      'pattern' => '/define\(\'HIRINGTHING_VERSION\',\s*\'([0-9a-zA-Z\.-]+)\'\)/',
      'lines' => 20,
    ),
    'files' => array(
      'php' => array(
        'hiringthing.inc',
      ),
    ),
  );

  return $libraries;
}

/**
 * Implements hook_block_configure().
 */
function hiringthing_block_configure($delta = '') {
  $form = array();

  if ($delta == 'widget') {
    $message  = '';
    $message .= theme('image', array(
      'path'   => drupal_get_path('module', 'hiringthing') . '/hiringthing_logo_sm.png',
      'width'  => 318,
      'height' => 75,
      'alt'    => 'HiringThing logo',
    ));
    $message .= '<p>' . t('<a target="_blank" href="http://www.hiringthing.com">HiringThing</a> is online software that helps companies post jobs online, manage applicants and hire great employees.') . '</p>';

    $form['hiringthing_message'] = array(
      '#type' => 'markup',
      '#markup' => $message,
    );
    $form['hiringthing_site_url'] = array(
      '#title' => t('Enter your HiringThing account URL'),
      '#type' => 'textfield',
      '#size' => '40',
      '#field_prefix' => 'http://',
      '#field_suffix' => '.hiringthing.com',
      '#default_value' => variable_get('hiringthing_site_url', ''),
      '#description' => t('If you don\'t yet have a HiringThing account, visit <a target="_blank" href="http://www.hiringthing.com">http://www.hiringthing.com</a> for a 30-day free trial.'),
    );
  }

  return $form;
}

/**
 * Implements hook_block_save().
 */
function hiringthing_block_save($delta = '', $edit = array()) {
  if ($delta == 'widget') {
    variable_set('hiringthing_site_url', $edit['hiringthing_site_url']);
  }
}

/**
 * Implements hook_block_view().
 */
function hiringthing_block_view($delta = '') {
  $block = array();

  if ($delta == 'widget') {
    if ($site_url = variable_get('hiringthing_site_url', '')) {
      $site_url_js = drupal_json_encode($site_url);
      $site_url_link = l(t('View our currently open positions'), "http://$site_url.hiringthing.com");
      $brought_to_you_by = t('Job listings brought to you by <a href="http://www.hiringthing.com">HiringThing</a>.');

      $block['subject'] = t('We\'re hiring!');
      $block['content'] = <<<HTML
<!-- HiringThing Jobs Widget -->
<noscript>
$site_url_link
<br /><br />
$brought_to_you_by
</noscript>
<script type="text/javascript">
    var ht_settings = ( ht_settings || new Object() );
    ht_settings.site_url = $site_url_js;
    ht_settings.src_code = "drupal";
</script>
<script src="http://assets.hiringthing.com/javascripts/embed.js" type="text/javascript"></script>
<div id="hiringthing-jobs"></div>
<!-- widget stylesheet can be overridden or replaced for customization -->
<link rel="stylesheet" type="text/css" media="all" href="http://assets.hiringthing.com/stylesheets/embed.css" />
<!-- end HiringThing Jobs Widget -->
HTML;
    }
  }

  return $block;
}

/**
 * Returns a HiringThing API object for accessing the read API.
 *
 * It will cache the object statically for the length of the request.
 *
 * @returns HiringThing|NULL
 *   It will return the HiringThing object or NULL if the library is
 *   not installed or not configured.
 */
function hiringthing_api_object() {
  static $hiringthing = NULL;

  if (is_null($hiringthing)) {
    $configured = FALSE;

    // check that the library is present
    if (module_exists('libraries')) {
      $library = libraries_load('hiringthing');
      $configured = !empty($library['loaded']);
    }

    // check that the API information is configured
    if ($configured) {
      $credentials = array(
        'subdomain'    => variable_get('hiringthing_site_url', ''),
        'api_key'      => variable_get('hiringthing_api_key', ''),
        'api_password' => variable_get('hiringthing_api_password', ''),
      );

      foreach ($credentials as $key => $value) {
        if ($value === '') {
          $configured = FALSE;
          break;
        }
      }
    }

    if ($configured) {
      $hiringthing = new HiringThing($credentials, 'HiringThingHttpRequesterDrupal');
    }
    else {
      $hiringthing = FALSE;
    }
  }

  // We previously determined that the library wasn't present or not configured
  // properly. So, we can simply return NULL.
  if ($hiringthing === FALSE) {
    return NULL;
  }

  return $hiringthing;
}

