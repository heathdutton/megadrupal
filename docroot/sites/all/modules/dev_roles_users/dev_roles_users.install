<?php
/**
 * @file
 * Development Roles Users module install functions.
 */

/**
 * Implements hook_install().
 */
function dev_roles_users_install() {
  $users = dev_roles_users_get_users_info();

  foreach ($users as $user) {
    user_save('', $user);
  }
}

/**
 * Implements hook_enable().
 */
function dev_roles_users_enable() {
  $users = dev_roles_users_get_users_info();

  foreach ($users as $user) {
    $loaded_user = user_load_by_name($user['name']);

    if ($loaded_user->status == 0) {
      $loaded_user->status = 1;
      user_save($loaded_user);
    }
  }
}

/**
 * Implements hook_disable().
 */
function dev_roles_users_disable() {
  $users = dev_roles_users_get_users_info();

  foreach ($users as $user) {
    $loaded_user = user_load_by_name($user['name']);

    if ($loaded_user->status == 1) {
      $loaded_user->status = 0;
      user_save($loaded_user);
    }
  }
}

/**
 * Implements hook_uninstall().
 */
function dev_roles_users_uninstall() {
  $users = dev_roles_users_get_users_info();

  foreach ($users as $user) {
    $loaded_user = user_load_by_name($user['name']);

    user_delete($loaded_user->uid);
  }
}

/**
 * Gets user information for each role.
 */
function dev_roles_users_get_users_info() {
  global $base_url;
  $users = array();
  $roles = user_roles(TRUE);

  // Remove "authenticated user" form the roles list.
  unset($roles[DRUPAL_AUTHENTICATED_RID]);

  // Clean $base_url to be used as email domain.
  $mail_domain = preg_replace('#http(s)?://(www.)?#', '', $base_url);

  foreach ($roles as $rid => $role) {
    $username = dev_roles_users_get_clean_username($role);
    $mail = $username . '@' . $mail_domain;

    $users[] = array(
      'name' => $username,
      'pass' => $username,
      'mail' => $mail,
      'status' => 1,
      'roles' => array(
        DRUPAL_AUTHENTICATED_RID => 'authenticated user',
        $rid => $role,
      ),
    );
  }

  return $users;
}

/**
 * Gets clean username from role name.
 */
function dev_roles_users_get_clean_username($role) {
  return strtolower(preg_replace('/[\s]+/', '.', $role));
}
