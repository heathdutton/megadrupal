<?php

// Define constants
define("cLinkPointGAPIURL", "https://secure.linkpt.net:1129/LSGSXML");

/**
 * Implements hook_menu().
 */
function pg_linkpoint_menu() {
  $items = array();
  $items['admin/pgdata/pgsettings/linkpoint'] = array(
    'title' => 'Linkpoint',
    'description' => 'Linkpoint payment settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('pg_linkpoint_settings'),
    'access callback' => 'user_access',
    'access arguments' => array('administer pgapi'),
    'file' => 'pg_linkpoint.admin.inc',
    'type' => MENU_LOCAL_TASK,
  );
  return $items;
}

/**
 * Implements hook_pgapi_gw().
 */
function pg_linkpoint_pgapi_gw($op, $a3 = NULL, $a4 = NULL) {
  switch ($op) {
    case 'display name':
      $ret = t('Linkpoint Global API Payment Gateway');
      break;
    case 'payment gateway info':
      $ret['name']   = t('Linkpoint');
      $prices['USD'] = $a3 * variable_get('pg_linkpoint_rate', '1.00');
      $ret['price']  = $prices;
      break;
    case 'process form':
      $form_state   = $a4;
      $transaction  = $a3;
      $ret = _pg_linkpoint_process_form($form_state, $transaction);
      break;
    case 'get form':
      $ret = drupal_get_form('pg_linkpoint_extraform');
      break;
    default:
      $ret = '';
  }
  return $ret;
}

/**
 * Implements hook_pgapi_transaction().
 */
function pg_linkpoint_pgapi_transaction($status, &$transaction) {
  switch ($status) {
    case PG_PENDING:
      $transaction->extra['amount'] =  $transaction->amount * variable_get('pg_linkpoint_rate', '1.00');
      break;
  }
}

/**
 * Return linkpoint payment form
 */
function pg_linkpoint_extraform() {
  $form = array();
  $form['cc'] = array(
    '#type' => 'fieldset',
    '#title' => t('Credit Card'),
  );
  $form['cc']['cart_owner'] = array(
    '#type' => 'textfield',
    '#title' => t('Card Owner'),
  );
  $form['cc']['cart_number'] = array(
    '#type' => 'textfield',
    '#title' => t('Card Number'),
  );
  $form['cc']['exp_month'] = array(
    '#type' => 'select',
    '#title' => t('Expiration Month'),
    '#options' => drupal_map_assoc('01', '02', '03', '04', '05', '06', '07', '08', '09', '10', '11', '12'),
  );
  $form['cc']['exp_year'] = array(
    '#type' => 'select',
    '#title' => t('Expiration Year'),
    '#options' => drupal_map_assoc('11', '12', '13', '14', '15', '16', '17', '18', '19', '20'),
  );
  $form['cc']['cvv'] = array(
    '#type' => 'textfield',
    '#title' => t('Security Code'),
  );
  return $form;
}

/**
 * Process linkpoint payment
 */
function _pg_linkpoint_process_form($form_state, $t) {
  // Set amount of money
  $amount = number_format($t->amount * variable_get('pg_linkpoint_rate', '1.00'), 2);

  // Build xml order
  $xml  = "<order>";

  // Billing
  $xml .= "<billing>";
  $xml .= "<name>"      . $t->extra['billing_addr']['first_name'] . " " . $t->extra['billing_addr']['last_name'] . "</name>" . "\n";
  $xml .= "<company>"   . $t->extra['billing_addr']['company'] . "</company>" . "\n";
  $xml .= "<address1>"  . $t->extra['billing_addr']['address'] . "</address1>" . "\n";
  $xml .= "<address2></address2>" . "\n";
  $xml .= "<addrnum>"   . $t->extra['billing_addr']['address'] . "</addrnum>" . "\n";
  $xml .= "<city>"      . $t->extra['billing_addr']['city'] . "</city>" . "\n";
  $xml .= "<state>"     . $t->extra['billing_addr']['state'] . "</state>" . "\n";
  $xml .= "<zip>"       . $t->extra['billing_addr']['postal_code'] . "</zip>" . "\n";
  $xml .= "<country>"   . $t->extra['billing_addr']['country'] . "</country>" . "\n";
  $xml .= "<phone>"     . $t->extra['billing_addr']['phone'] . "</phone>" . "\n";
  $xml .= "<email>"     . $t->email . "</email>" . "\n";
  $xml .= "</billing>"  . "\n";

  // Shipping
  $xml .= "<shipping>"  . "\n";
  $xml .= "<name>"      . $t->extra['shipping_addr']['first_name'] . " " . $t->extra['shipping_addr']['last_name'] . "</name>" . "\n";
  $xml .= "<address1>"  . $t->extra['shipping_addr']['address'] . "</address1>" . "\n";
  $xml .= "<address2></address2>" . "\n";
  $xml .= "<city>"      . $t->extra['shipping_addr']['city'] . "</city>" . "\n";
  $xml .= "<state>"     . $t->extra['shipping_addr']['state'] . "</state>" . "\n";
  $xml .= "<zip>"       . $t->extra['shipping_addr']['postal_code'] . "</zip>" . "\n";
  $xml .= "<country>"   . $t->extra['shipping_addr']['country'] . "</country>" . "\n";
  $xml .= "</shipping>" . "\n";

  // Order options
  $xml .= "<orderoptions>"  . "\n";
  $xml .= "<result>"        . variable_get('pg_linkpoint_transaction_mode', '') . "</result>" . "\n";
  $xml .= "<ordertype>"     . variable_get('pg_linkpoint_transaction_method', '') . "</ordertype>" . "\n";
  $xml .= "</orderoptions>" . "\n";

  // Merchant information
  $xml .= "<merchantinfo>" . "\n";
  $xml .= "<configfile>"    . variable_get('pg_linkpoint_login_id', '') . "</configfile>" . "\n";
  $xml .= "</merchantinfo>" . "\n";

  // Credit card infortaion
  $xml .= "<creditcard>"    . "\n";
  $xml .= "<cardnumber>"    . $form_state['cc']['cart_number'] . "</cardnumber>" . "\n";
  $xml .= "<cardexpmonth>"  . $form_state['cc']['exp_month'] . "</cardexpmonth>" . "\n";
  $xml .= "<cardexpyear>"   . $form_state['cc']['exp_year'] . "</cardexpyear> " . "\n";
  $xml .= "<cvmvalue>"      . $form_state['cc']['cvv'] . "</cvmvalue>" . "\n";
  $xml .= "<cvmindicator>provided</cvmindicator>" . "\n";
  $xml .= "</creditcard>"   . "\n";

  // Payment infortaion
  $xml .= "<payment>"     . "\n";
  $xml .= "<chargetotal>" . $amount . "</chargetotal>" . "\n";
  $xml .= "</payment>"    . "\n";

  // Transaction details
  $xml .= "<transactiondetails>" . "\n";
  $xml .= "<transactionorigin>ECI</transactionorigin>" . "\n";
  $xml .= "<oid>" . $t->txnid . "</oid>" . "\n";
  $xml .= "<ip>" . $_SERVER['REMOTE_ADDR'] . "</ip>" . "\n";
  $xml .= "</transactiondetails>" . "\n";

  // Some notes
  $xml .= "<notes>" . "\n";
  $xml .= "<comments></comments>" . "\n";
  $xml .= "</notes>" . "\n";

  $xml .= "</order>" . "\n";

  $fid = variable_get('pg_linkpoint_transaction_key_fid', '');
  $filepath = db_query("SELECT filepath FROM {file_managed} WHERE fid = :fid", array(':fid' => $fid))->fetchField();
  $ch = curl_init();
  curl_setopt($ch, CURLOPT_URL, variable_get('pg_linkpoint_action_url', cLinkPointGAPIURL));
  curl_setopt($ch, CURLOPT_VERBOSE, 0);
  curl_setopt($ch, CURLOPT_POST, 1);
  curl_setopt($ch, CURLOPT_POSTFIELDS, $xml);
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
  curl_setopt($ch, CURLOPT_SSLCERT, $filepath);
  $buffer = curl_exec($ch);

  if ($error = curl_error($ch)) {
    watchdog('uc_linkpoint_api', $error, WATCHDOG_ERROR);
  }
  curl_close($ch);

  if (drupal_strlen($buffer) < 2) {
    $buffer = "<r_error>Sorry - Could not connect to payment gateway.</r_error>";
  }
  preg_match_all("/<(.*?)>(.*?)\</", $buffer, $outarr, PREG_SET_ORDER);

  $retarr = array();
  $n = 0;
  while (isset($outarr[$n])) {
    $retarr[$outarr[$n][1]] = strip_tags($outarr[$n][0]);
    $n++;
  }

  $x_response_code = isset($retarr['r_approved']) ? $retarr['r_approved'] : '';
  $x_response_text = isset($retarr['r_error']) ? $retarr['r_error'] : '';
  $x_approval_code = isset($retarr['r_code']) ? $retarr['r_code'] : '';

  $description = t('Credit card charged');
  $status = 'completed';

  if ($x_response_code != 'APPROVED') {
    $description = t('Credit card declined. Error: !error, code:!code', array('!error' => $x_response_text, '!code' => $x_approval_code));
    $status = 'denied';
  }

  $t->description = $description;
  $t->status = pgapi_get_status_id($status);
  pgapi_transaction_save($t);
  return $t;
}
