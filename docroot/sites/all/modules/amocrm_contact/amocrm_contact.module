<?php

/**
 * Implements hook_form_FORM_ID_alter().
 */
function amocrm_contact_form_contact_category_edit_form_alter(&$form, &$form_state, $form_id) {
  $cid = !empty($form['cid']['#value']) ? $form['cid']['#value'] : '';

  $form['amocrm_contact_enable'] = array(
    '#type' => 'checkbox',
    '#title' => t('Create a contact in amoCRM'),
    '#default_value' => !empty($cid) ? variable_get('amocrm_contact_enable_' . $cid, FALSE) : FALSE,
  );

  $form['#submit'][] = 'amocrm_contact_contact_category_edit_submit';
}

/**
 * Form submission handler for contact_category_edit_form().
 */
function amocrm_contact_contact_category_edit_submit(&$form, &$form_state) {
  if (!empty($form_state['values']['cid'])) {
    variable_set('amocrm_contact_enable_' . $form_state['values']['cid'], $form_state['values']['amocrm_contact_enable']);
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function amocrm_contact_form_contact_site_form_alter(&$form, &$form_state, $form_id) {
  $form['#submit'][] = 'amocrm_contact_contact_site_form_submit';
}

/**
 * Form submission handler for contact_site_form().
 */
function amocrm_contact_contact_site_form_submit(&$form, &$form_state) {
  if (!empty($form_state['values']['cid'])) {
    $values = $form_state['values'];
    $amocrm_contact_enable = variable_get('amocrm_contact_enable_' . $values['cid'], FALSE);

    if ($amocrm_contact_enable) {
      $amocrm_domain = variable_get('amocrm_api_default_domain');
      $amocrm_email = variable_get('amocrm_api_default_email');
      $amocrm_key = variable_get('amocrm_api_default_key');

      if (isset($amocrm_domain, $amocrm_email, $amocrm_key)) {
        $client = amocrm_api_client($amocrm_domain, $amocrm_email, $amocrm_key);
        $client_info = amocrm_api_account_load($client);

        // Prepare contact info for amoCRM request.
        $contact = array(
          'name' => !empty($values['name']) ? $values['name'] : '',
          'date_create' => REQUEST_TIME,
          'last_modified' => REQUEST_TIME,
        );

        $custom_fields = array();
        if (!empty($client_info['custom_fields']['contacts']) && !empty($values['mail'])) {
          foreach ($client_info['custom_fields']['contacts'] as $field) {
            if (!empty($field['code']) && $field['code'] == 'EMAIL') {
              $custom_fields[] = array(
                'id' => $field['id'],
                'values' => array(
                  array(
                    'value' => $values['mail'],
                    'enum' => 'OTHER',
                  ),
                ),
              );
              break;
            }
          }
        }

        $contact['custom_fields'] = $custom_fields;
        $contact_category = contact_load($values['cid']);
        $contact['tags'] = $contact_category['category'];
        amocrm_api_contacts_add($client, array($contact));
      }
      else {
        watchdog('amocrm_contact', 'Not filled with data to connect to amoCRM', NULL, WATCHDOG_ERROR);
      }
    }
  }
}
