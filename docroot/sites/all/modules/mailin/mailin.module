<?php

/**
 * @file
 * Provide integration with the Mailin API.
 */

/**
 * @defgroup Drupal hooks
 * @{
 */

/**
 * Implements hook_boot().
 *
 * The Mailin API uses an autoloader so it has to be included soon
 * in the bootstrap process.
 */
function mailin_init() {
  _mailin_init();
}

/**
 * Implements hook_menu().
 */
function mailin_menu() {
  $items = array();

  $items['admin/config/services/mailin'] = array(
    'title' => 'Mailin',
    'description' => 'Mailin Settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('mailin_admin_settings_form'),
    'access arguments' => array('administer mailin'),
    'file' => 'mailin.admin.inc',
  );

  $items['admin/config/services/mailin/settings'] = array(
    'title' => 'Settings',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => -10,
  );

  /*$items['mailin/api-callback'] = array(
    'title' => 'Mailin API callback handler',
    'page callback' => 'mailin_api_callback',
    'access callback' => 'mailin_api_callback_access',
    'access arguments' => array(2),
    'type' => MENU_CALLBACK,
  );*/

  return $items;
}

/**
 * Implements hook_permission().
 */
function mailin_permission() {
  return array(
    'administer mailin' => array(
      'title' => t('Administer mailin'),
      'description' => t('Administer the Mailin API settings.'),
    ),
  );
}

/**
 * @} End of "defgroup Drupal hooks".
 *
 * @defgroup Libraries hooks
 * @{
 */

/**
 * Implements hook_libraries_info().
 */
function mailin_libraries_info() {
  $libraries['mailin'] = array(
    'name' => 'Mailin API',
    'vendor url' => 'https://github.com/B-Prod/Mailin',
    'download url' => 'https://github.com/B-Prod/Mailin/archive/master.zip',
    'version arguments' => array(
      'file' => 'README.md',
      'pattern' => '/\* Version: ((?:[\w]+-)?(?:\d+)\.(?:\d+))/',
    ),
    'files' => array(
      'php' => array('mailin.php'),
    ),
  );

  return $libraries;
}

/**
 * @} End of "defgroup Libraries hooks".
 */

/**
 * Ensure the required files are included.
 */
function _mailin_init() {
  if (!defined('MAILIN_LIBRARY_INSTALLED')) {
    $library = libraries_load('mailin');
    define('MAILIN_LIBRARY_INSTALLED', (bool) $library['loaded']);
  }
}

/**
 * Access callback for Mailin API advanced administration pages.
 *
 * @param $permission
 *   The required permission to allow access.
 *
 * @return bool
 */
function mailin_api_access($permission = 'administer mailin') {
  static $api_key;

  if (!isset($api_key)) {
    $api_key = ('' !== variable_get('mailin_api_key', ''));
  }

  _mailin_init();
  return user_access($permission) && mailin_available() && FALSE !== $api_key;
}

/**
 * Check if the Mailin library is available.
 */
function mailin_available() {
  return defined('MAILIN_LIBRARY_INSTALLED') && FALSE !== MAILIN_LIBRARY_INSTALLED;
}

/**
 * Access callback for the Mailin API callback page.
 *
 * @param $hash
 *   The hash string.
 *
 * @return bool
 */
/*function mailin_api_callback_access($hash) {
  return $hash === mailin_api_hash();
}*/

/**
 * Generate an hashed key for the Mailin API callback URL.
 *
 * @return string
 *   An hash string.
 */
function mailin_api_hash() {
  return drupal_hash_base64(drupal_get_hash_salt() . drupal_get_private_key());
}

/**
 * Get the Mailin API callback URL.
 *
 * @return string
 */
function mailin_api_callback_url() {
  return url('mailin/api-callback/' . mailin_api_hash(), array('absolute' => TRUE));
}
