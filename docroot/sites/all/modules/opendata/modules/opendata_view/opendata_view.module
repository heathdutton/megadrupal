<?php
/**
 * @file
 * Code for the Project Open Data View feature.
 */

include_once 'opendata_view.features.inc';

/**
 * Implements hook_views_post_render().
 */
function opendata_views_post_render(&$view, &$output, &$cache) {
  if ($view->name == 'opendata' && $view->current_display == 'page' && variable_get('opendata_theming', TRUE)) {
      drupal_add_css(drupal_get_path('module', 'opendata') . '/opendata.css');
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function opendata_view_form_opendata_settings_alter(&$form, &$formstate, $formid) {
  $views = views_get_all_views();
  $myview = $views['opendata'];
  $viewtype = $myview->type;

  // Make sure our submit handler gets called.
  array_unshift($form['#submit'], 'opendata_view_save_view_handler');
  $formstate['opendata_view'] = $myview;

  if ($viewtype == 'Overridden') {
    // Get the current submit handler.
    $path1 = $myview->display['page']->display_options['path'];

  }
  else {
    $path1 = variable_get('opendata_path_html', 'data');
  }

  $form['opendata']['opendata_theming'] = array(
    '#type' => 'checkbox',
    '#title' => t('Apply default theming to /data page'),
    '#default_value' => variable_get('opendata_theming', TRUE),
  );

  $form['opendata']['opendata_path_html'] = array(
    '#type' => 'textfield',
    '#title' => t('Path to the human-readable view'),
    '#default_value' => $path1,
  );
}

/**
 * Processess the view paths in case the view is overridden.
 */
function opendata_view_save_view_handler($form, $formstate) {
  // Pull the view from the data structure.
  $view = $formstate['opendata_view'];

  if ($view->type == 'Overridden') {
    // Get the new paths.
    $htmlpath = $formstate['values']['opendata_path_html'];

    // Update the view.
    $view->display['page']->display_options['path'] = $htmlpath;

    // Save the view.
    views_save_view($view);
  }

  // Clear the views cache.
  views_invalidate_cache();
}
