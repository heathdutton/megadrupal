<?php

/**
 * @file
 * Stingray tests.
 */

/**
 * Test basic API.
 */
class StingrayTestCase extends DrupalWebTestCase {

  public static function getInfo() {
    return array(
      'name' => 'Stingray cache tests',
      'description' => 'Test various Stingray cache clearings with paths and aliases.',
      'group' => 'Stingray',
    );
  }

  function setUp() {
    parent::setUp('stingray');
    $user = $this->drupalCreateUser(array('purge stingray cache'));
    $this->drupalLogin($user);
    variable_set('stingray_service_cache_class', 'StingrayDummyCacheControl');
  }

  /**
   * Tests clear.
   */
  function testDirectCacheClear() {
    variable_set('stingray_base_path', 'http://cdn-domain.com');
    $expected = array('http', 'cdn-domain.com');
    // Fixed relative URL
    $stingray = stingray_get_class(STINGRAY_SERVICE_CACHE);
    $urls = array(
      '/test/test',
      '/foo/bar'
    );
    $actual_urls = $stingray->clearByPath($urls);

    foreach ($actual_urls as $index => $actual) {
      $this->assertEqual(array_merge($expected, array($urls[$index])), $actual);
    }
  }

  /**
   * Tests clear with no aliases.
   */
  function testCacheClearUI() {
    $edit = array(
      'paths' => 'testing/1'
    );
    $this->drupalPost('admin/config/development/stingray/refresh', $edit, t('Start Refreshing Content'));
    $this->assertText('Cleared cache for given path');
  }

}



