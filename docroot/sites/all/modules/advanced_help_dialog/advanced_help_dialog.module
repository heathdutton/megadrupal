<?php

/*
 * Implements hook_menu().
 */
function advanced_help_dialog_menu() {
  $items['advanced_help_dialog/fetch/%/%'] = array(
    'page callback' => 'advanced_help_dialog_view_topic',
    'page arguments' => array(2, 3),
    'access arguments' => array('view advanced help topic'),
  );
  
  return $items;
}

/*
 * Ajax callback: render topic in a modal window
 */
function advanced_help_dialog_view_topic($module, $topic) {
  // Add ctools requirements
  ctools_include('ajax');
  ctools_include('modal');
  
  $path = drupal_get_path('module', 'advanced_help_dialog') . '/js/advanced_help_dialog.js';
  drupal_add_js($path);
  
  if ($output = advanced_help_view_topic($module, $topic)) {
    $info = module_invoke($module, 'advanced_help_dialog_help');

    // Find a title to use
    foreach ($info as $path => $topics) {
      foreach ($topics as $module_topic => $help) {
        if ($module_topic == $topic) {        
          $title = isset($help['title']) ? $help['title'] : $help['link_text'];
          
          // Hide the navigation if necessary.
          $css = empty($help['show_navigation']) ? '<style type="text/css">.help-navigation{display:none}</style>' : '';          
        }
      }
    }   
    
    $output .= $css;
    ctools_modal_render($title, $output);      
  }
  else {
    ctools_modal_render('Topic not found', t('Sorry, topic could not be found.'));
  }
}

/*
 * Implements hook_help().
 */
function advanced_help_dialog_help($path, $arg) {
  // Load the modal library and add the modal javascript.
  ctools_include('modal');
  ctools_modal_add_js();
  
  if (!user_access('view advanced help dialog links') || !user_access('view advanced help topic')) {
    return;
  }
    
  foreach (module_implements('advanced_help_dialog_help') as $module) {
    foreach (module_invoke($module, 'advanced_help_dialog_help') as $help_path => $topics) {
      foreach ($topics as $topic => $help) {
        if ($help_path == '<front>') {
          $help_path = variable_get('site_frontpage', 'node');
        }
        
        // Assemble a list of help links for this path
        if ($help_path == $path) {          
          $element = array(
            '#type' => 'modal_help_dialog',
            '#module' => $module,
            '#topic' => $topic,
            '#link_text' => $help['link_text'],
          );
          
          $items[] = drupal_render($element);
        }
      }
    } 
  }
  
  if (isset($items)) {
    return theme_item_list(array(
      'items' => $items,
      'title' => t('Help'),
      'type' => 'ul',
      'attributes' => array()
    ));
  }
}

/*
 * Implements hook_theme().
 */
function advanced_help_dialog_theme() {
  return array(
    'modal_help_dialog' => array(
      'render element' => 'element'
    )
  );
}

/*
 * Implements hook_element_info()
 */
function advanced_help_dialog_element_info() {
  $types['modal_help_dialog'] = array(
    '#input' => 0,
    '#theme' => 'modal_help_dialog'    
  );
  
  return $types;
}

/*
 * Theme callback: render the modal help dialog element
 */
function theme_modal_help_dialog($variables) {
  $element = $variables['element'];
  
  if (isset($element['#module']) && isset($element['#topic']) && isset($element['#link_text']) && user_access('view advanced help dialog links')) {
    return l($element['#link_text'], 'advanced_help_dialog/fetch/' . $element['#module'] . '/' . $element['#topic'], array('attributes' => array('class' => 'ctools-use-modal')));
  }
}

/*
 * Implements hook_permission().
 */
function advanced_help_dialog_permission() {
  return array(
    'view advanced help dialog links' => array(
      'title' => t('View advanced help dialog links')
    )
  );
}
