<?php

/**
 * Implements hook_form_FORM_ID_alter() for npr_pull_cron_config().
 */
function npr_stations_form_npr_pull_cron_config_alter(&$form, &$form_state, $form_id) {
  $stations = array();
  foreach (npr_stations_get_stations_from_disk() as $station) {
    $stations[$station->id] = $station->name;
  }

  // Remove NPR
  unset($stations[1]);

  $form['npr_stations_cron_query_ids'] = array(
    '#type' => 'select',
    '#title' => t('Stations'),
    '#default_value' => variable_get('npr_stations_cron_query_ids', array()),
    '#options' => $stations,
    '#multiple' => TRUE,
    '#weight' => -1,
  );
}

/**
 * Implements hook_cron().
 */
function npr_stations_cron() {
  $org_ids = variable_get('npr_stations_cron_query_ids');
  if (module_exists('npr_pull') && !empty($org_ids)) {
    npr_stations_get_stories($org_ids);
  }
}

/**
 * Implements hook_form_FORM_ID_alter() for npr_pull_cron_config().
 */
function npr_stations_get_stories($org_ids) {
  $today = format_date(REQUEST_TIME, 'custom', 'Y-m-d');
  $pub = variable_get('npr_pull_cron_publish_flag', 1);
  $params = array(
    'startDate' => $today,
    'orgId' => implode(',', $org_ids)
  );
  $NPR = npr_api_fetch_object($params);
  if (!empty($NPR->stories)) {
    foreach ($NPR->stories as $story) {
      $story->status = $pub;
      npr_pull_insert_story($story);
    }
  }
}

/**
 * Retrieve all member station data from a json file (no API call).
 *
 * @return array
 *   Basic data for all member stations.
 */
function npr_stations_get_stations_from_disk() {
  $stations = json_decode(file_get_contents(drupal_get_path('module', 'npr_stations') . '/stations.members.json'));
  return $stations;
}

/**
 * Retrieve all member station data, via an API call.
 *
 * @return array
 *   Basic data for all member stations.
 */
function npr_stations_get_stations() {
  // Add caching
  $stations = array();

  $params = array('type' => 'Member');
  $params['apiKey'] = variable_get('npr_api_api_key');

  // Load API classes
  module_load_include('php', 'npr_api', 'classes/NPRAPI');
  module_load_include('php', 'npr_api', 'classes/NPRAPIDrupal');

  $NPRAPIDrupal = new NPRAPIDrupal();
  $NPRAPIDrupal->request($params, 'GET', NULL, 'v2/orgs');
  $response = $NPRAPIDrupal->response;
  if ($response->code == 200) {
    $stations = json_decode($response->data);
    // Caching
    return $stations;
  }
  else {
    return array();
  }
}

/**
 * Implements hook_modules_installed().
 */
function npr_stations_modules_installed($modules) {
  if (in_array('chosen', $modules)) {
    npr_stations_add_select_to_chosen();
  }
}

/**
 * Appends selector for massive npr stations cron select to relevant variable
 * for Chosen module.
 *
 * Allows for automated, lightweight Chosen<-->NPR_Stations integration without
 * a strict dependency.
 */
function npr_stations_add_select_to_chosen() {
  $selector = '#edit-npr-stations-cron-query-ids';
  $selectors = variable_get('chosen_jquery_selector', '');
  if (strstr($selectors, $selector) === FALSE) {
    $selectors = $selectors . $selector . "\n";
    variable_set('chosen_jquery_selector', $selectors);
  }
}