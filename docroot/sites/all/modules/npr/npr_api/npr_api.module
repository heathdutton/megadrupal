<?php

/**
 * @file
 * Creates basic calls to NPR API; creates and parses NPR's flavor of XML (NPRML).
 */

/**
 * Implements hook_permisssion().
 */
function npr_api_permission() {
  return array(
    'administer npr api' => array(
      'title' => t('Administer the NPR API'), 
      'description' => t('Perform administration tasks for the NPR API.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function npr_api_menu() {

  $items['admin/config/services/npr'] = array(
    'title' => 'NPR API',
    'description' => 'Control your NPR API settings',    
    'page callback' => 'drupal_get_form',
    'page arguments' => array('npr_api_config_form'),
    'access arguments' => array('administer npr api'),
  );

  $items['admin/config/services/npr/api_config'] = array(
    'title' => 'API Settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('npr_api_config_form'),
    'access arguments' => array('administer npr api'),
    'weight' => -20,
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );

  $items['admin/config/services/npr/npr_api_test'] = array(
    'title' => 'API Pull Test',
    'page callback' => 'npr_api_test_api',
    'access arguments' => array('administer npr api'),
    'type' => MENU_LOCAL_TASK,
  );

  return $items; 
}

/**
 * Page callback: Config form for NPR API connection settings.
 * 
 * Callback for admin/config/system/npr.
 *
 * @return array
 *   A renderable (form) array.
 *
 * @see npr_api_menu()
 */
function npr_api_config_form($form, &$form_state) {
  $form['npr_api_api_key'] = array(
    '#type' => 'textfield',
    '#title' => t('NPR API Key'),
    '#default_value' => variable_get('npr_api_api_key'),
    '#description' => t(''),
  );
  return system_settings_form($form);
}

/**
 * Page callback: Test page NPR API connection/settings.
 *
 * Callback for admin/config/system/npr_api_test.
 *
 * @return array
 *   An item list of various test API call stats. 
 *
 * @see npr_api_menu()
 */
function npr_api_test_api() {
  $params = array(
    'id' => 1149, // topic = Afghanistan
  );
  $NPR = npr_api_fetch_object($params);
  return theme('item_list', array('items' => $NPR->report()));
}

/**
 * Creates an NPRAPIDrupal object, narrowed by query-type parameters.
 *
 * @param $params
 *   An array of query-type parameters.
 *
 * @return
 *   An NPRAPIDrupal object.
 */

function npr_api_fetch_object($params) {
  
  $params['apiKey'] = variable_get('npr_api_api_key');
  
  // Load API classes
  module_load_include('php', 'npr_api', 'classes/NPRAPI');
  module_load_include('php', 'npr_api', 'classes/NPRAPIDrupal');
  
  $NPRAPIDrupal = new NPRAPIDrupal();
  $NPRAPIDrupal->request($params);
  $NPRAPIDrupal->parse();
  return $NPRAPIDrupal;
}

/**
 * Creates an array of NPR stories, narrowed by query-type parameters.
 *
 * @param $params
 *   An array of query-type parameters.
 *
 * @return
 *   An array of NPR stories, each an NPRMLEntity.
 */

function npr_api_fetch_stories($params) {
  $object = npr_api_fetch_object($params);
  return $object->stories;
}

/**
 * Returns a nested array of info about all NPRML "fields".
 *
 * @return
 *   An array of all NPRML "fields".
 */
function npr_api_get_nprml_fields() {
  $nprml_fields = array(
    'id' => array(
      'type' => 'attribute',
      'accepted_types' => array('text_textfield'),
    ),
    'subtitle' => array(
      'type' => 'text', 
      'accepted_types' => array('text_textfield'),
    ),
    'shortTitle' => array(
      'type' => 'text',
      'accepted_types' => array('text_textfield'), 
    ),
    'miniTeaser' => array(
      'type' => 'text',
      'accepted_types' => array('text_textfield'),
    ),
    'slug' => array(
      'type' => 'text',
      'accepted_types' => array('text_textfield', 'options_select'),
    ),
    'image' => array(
      'type' => 'image',
      'accepted_types' => array('image_image'),    
    ),
    'audio' => array(
      'type' => 'audio',
      'accepted_types' => array('npr_audio'),
    ),
  );
  return $nprml_fields;
}