<?php

/**
 * @file
 * Provide lightbox integration for affiliate store.
 */

/**
 * Get name of lightbox module for a given context.
 *
 * @param string $context
 *   The context in which to get the lightbox setting, e.g. product.
 *
 * @return string
 *   Name of lightbox module to use, either the preferred one or the first found
 *   on system.
 *
 * @see affiliate_store_lightbox_get_options()
 */
function affiliate_store_lightbox_for($context) {
  $lightboxes = affiliate_store_lightbox_get_options();
  $prefer = variable_get("affiliate_store_lightbox_for_$context", '');
  return isset($lightboxes[$prefer]) ? $prefer : key($lightboxes);
}

/**
 * Get list of supported and enabled lightbox module.
 *
 * @return array
 *   An associative array of lightbox names keyed by lightbox module name. The
 *   special key 'none' means do not use any lightboxes.
 */
function affiliate_store_lightbox_get_options() {
  $lightboxes = &drupal_static(__FUNCTION__);

  if (isset($lightboxes)) {
    return $lightboxes;
  }

  $modules = array(
    // The first module listed here will be selected if there's no user
    // preferred lightbox.
    'Lightbox2' => 'lightbox2',
    'Colorbox' => 'colorbox',
  );
  $lightboxes = array_flip(array_filter($modules, 'module_exists'));
  $lightboxes['none'] = t('None');
  return $lightboxes;
}

/**
 * Implemenets hook_form_affiliate_store_advanced_settings_page_alter().
 */
function affiliate_store_lightbox_form_affiliate_store_advanced_settings_page_alter(&$form, &$form_state) {
  $lightboxes = affiliate_store_lightbox_get_options();
  if (count($lightboxes) > 1) {
    $form['product']['affiliate_store_lightbox_for_product'] = array(
      '#type' => 'radios',
      '#title' => t('Lightbox module'),
      '#description' => t(
        'The selected lightbox will be used for product full image overlay.'
      ),
      '#options' => $lightboxes,
      '#default_value' => affiliate_store_lightbox_for('product'),
    );
  }
  else {
    $message = t(
      'There is no lightbox type module installed. See Affiliate Store Lightbox module README.txt for details.'
    );
    drupal_set_message($message, 'warning');
  }
}

/**
 * Wrap an image element inside a lightbox as a link.
 *
 * If there is no lightbox type module found, a regular anchor link will be
 * generated as fallback.
 *
 * @see theme_affiliate_store_image()
 */
function affiliate_store_lightbox_affiliate_store_image($variables) {
  $element = $variables['element'];
  $url = $variables['url'];
  $title = $variables['title'];
  $lightbox = affiliate_store_lightbox_for('product');
  $options = array(
    'html' => TRUE,
    'attributes' => array('title' => check_plain($title)),
  );
  if ($lightbox === 'lightbox2') {
    $options['attributes']['rel'] = 'lightbox';
  }
  elseif ($lightbox === 'colorbox') {
    $options['attributes']['class'] = array('colorbox-load');
  }
  return l($element, $url, $options);
}

/**
 * Implements hook_theme_registry_alter().
 */
function affiliate_store_lightbox_theme_registry_alter(&$theme_registry) {
  $theme = &$theme_registry['affiliate_store_image'];
  // Substitute the original theme_affiliate_store_image function provided by
  // affiliate store module with the one that uses lightbox from this module.
  // If the theme function has been customized by user, it will not be
  // overridden.
  if ($theme['function'] === 'theme_affiliate_store_image') {
    $theme['function'] = 'affiliate_store_lightbox_affiliate_store_image';
  }
}
