<?php

/**
 * Implements hook_url_outbound_alter().
 */
function inception_url_outbound_alter(&$path, &$options, $original_path) {
  if (empty($options['external']) && path_is_admin($path)) {
    $layers = inception_get_inception_layers();
    if (empty($layers)) {
      $layers[] = current_path();
    }
    $layers[] = $path;
    $options['query']['inception'] = $layers;
  }
}

/**
 * Implements hook_page_alter().
 */
function inception_page_alter(&$page) {
  $mode = overlay_get_mode();
  if ($mode == 'client' && $layers == inception_get_inception_layers()) {
    dpm($layers);
  }
}

function inception_get_inception_layers() {
  $layers = isset($_GET['inception']) && is_array($_GET['inception']) ? $_GET['inception'] : array();
  drupal_alter('inception_layers', $layers);
  return $layers;
}
