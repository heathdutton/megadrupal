<?php

/**
 * @file
 * Drupal Module: AdInsight
 * Adds the required Javascript to Drupal pages to enable the AdInsight Clarity
 * phone number tracking system.
 *
 * @author: James Drinkwater <http://drupal.org/user/2279468>
 */

/**
 * Implements hook_menu().
 */
function adinsight_clarity_menu() {
  $items['admin/config/tracking'] = array(
    'title' => 'Tracking',
    'description' => 'Tracking and Statistics',
    'position' => 'right',
    'weight' => 0,
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('access administration pages'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
  );

  $items['admin/config/tracking/adinsight_clarity'] = array(
    'title' => 'AdInsight Clarity',
    'description' => 'Configure the AdInsight Clarity telephone tracking system.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('adinsight_clarity_admin_settings_form'),
    'access arguments' => array('administer adinsight clarity'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'adinsight_clarity.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function adinsight_clarity_permission() {
  return array(
    'administer adinsight clarity' => array(
      'title' => t('Administer AdInsight Clarity'),
    ),
  );
}

/**
 * Implements hook_page_alter().
 *
 * Inserts JavaScript into the appropriate scope/region of the page.
 */
function adinsight_clarity_page_alter(&$page) {

  $id = variable_get('adinsight_clarity_account', '');

  // Check if the AdInsight account ID has been set.
  if (!empty($id)) {

    $script = 'var adiInit = ' . drupal_json_encode($id) . ';';
    $script .= '(function() { ';
    $script .= 'var adiSrc = document.createElement("script");';
    $script .= 'adiSrc.type = "text/javascript";';
    $script .= 'adiSrc.async = true;';
    $script .= 'adiSrc.src = ("https:" == document.location.protocol ? "https://" : "http://") + "static.adinsight.com/static/scripts/adiTrack.min.js";';
    $script .= 'var s = document.getElementsByTagName("script")[0];';
    $script .= 's.parentNode.insertBefore(adiSrc, s);';
    $script .= '})();';

    // Placement of the script is allowed in the head or foot of the document
    // defaults to foot but the user can override if needed.
    $scope = variable_get('adinsight_clarity_js_scope', 'footer');

    drupal_add_js($script, array('scope' => $scope, 'type' => 'inline'));
  }
}

/**
 * Implements hook_help().
 */
function adinsight_clarity_help($path, $arg) {
  switch ($path) {
    case 'admin/config/tracking/adinsight_clarity':
      return t('<a href="@ac_url">AdInsight Clarity</a> is a subscription service that provides call level tracking and call analytics.', array('@ac_url' => 'http://www.adinsight.com/'));
  }
}

/**
 * Returns the AdInsight telephone number span.
 *
 * The AdInsight JavaScript targets this span element and dynamically replaces
 * the base telephone number
 *
 * Used by adinsight_tokens() to get the value of the [adinsight:tag] token.
 */
function _adinsight_clarity_build_tag() {
  // This function could be called multiple times so use the drupal static
  // pattern.
  $tag = &drupal_static(__FUNCTION__);

  if (!isset($tag)) {
    $pool = variable_get('adinsight_clarity_pool', '');
    $base = variable_get('adinsight_clarity_base_phone', '');

    if (!empty($pool) && !empty($base)) {
      $tag = '<span class="adinsightNumber' . check_plain($pool) . '">' . check_plain($base) . '</span>';
    }
  }
  return $tag;
}

/**
 * Implements hook_hook_info().
 */
function adinsight_clarity_hook_info() {
  $hooks['token_info'] = array(
    'group' => 'tokens',
  );
  $hooks['tokens'] = array(
    'group' => 'tokens',
  );
}

/**
 * Implements hook_block_info().
 *
 * Declares the AdInsight block.
 */
function adinsight_clarity_block_info() {
  $blocks['adinsight_clarity_block'] = array(
    'info' => t('AdInsight Clarity Telephone Number'),
    // Allow global block caching because the number is updated by JavaScript.
    'cache' => DRUPAL_CACHE_GLOBAL,
  );
  return $blocks;
}

/**
 * Implements hook_block_configure().
 *
 * Allow the base phone number to be altered in the block admin UI.
 */
function adinsight_clarity_block_configure($delta = '') {
  $form = array();
  if ($delta == 'adinsight_clarity_block') {
    $form['adinsight_clarity_base_phone'] = array(
      '#type' => 'textfield',
      '#title' => t('Base telephone number'),
      '#default_value' => variable_get('adinsight_clarity_base_phone', ''),
      '#size' => 20,
      '#maxlength' => 20,
      '#required' => TRUE,
      '#description' => t('The base phone number is inserted into the page and replaced with the dynamicly generated number when the AdInsight script executes. The base phone number will also be seen by users who have JavaScript disabled.'),
    );
  }
  return $form;
}

/**
 * Implements hook_block_save().
 *
 * Save the changes to the block
 */
function adinsight_clarity_block_save($delta = '', $edit = array()) {
  if ($delta == 'adinsight_clarity_block') {
    variable_set('adinsight_clarity_base_phone', $edit['adinsight_clarity_base_phone']);
  }
  return;
}

/**
 * Implements hook_block_view().
 *
 * Generate the content for the AdInsight Clarity block.
 */
function adinsight_clarity_block_view($delta = '') {
  switch ($delta) {
    case 'adinsight_clarity_block':
      $block['subject'] = t('Telephone Number');
      $block['content'] = _adinsight_clarity_build_tag();
      break;
  }
  return $block;
}

/**
 * Implements hook_filter_info().
 */
function adinsight_clarity_filter_info() {

  $tag = _adinsight_clarity_build_tag();

  $filters['filter_tag'] = array(
    'title' => t('AdInsight Telephone Tag'),
    'description' => t('Every instance of the special <code><strong>&lt;adinsight /&gt;</strong></code> tag will be replaced with the telephone number markup: <code><strong>@tag</strong></code>', array('@tag' => $tag)),
    'prepare callback' => '_adinsight_clarity_filter_tag_prepare',
    'process callback' => '_adinsight_clarity_filter_tag_process',
    'tips callback' => '_adinsight_clarity_filter_tag_tips',
  );
  return $filters;
}

/**
 * AdInsight filter prepare callback.
 */
function _adinsight_clarity_filter_tag_prepare($text, $filter) {
  return preg_replace('!<adinsight ?/>!', '[adinsight-tag]', $text);
}

/**
 * AdInsight filter process callback.
 */
function _adinsight_clarity_filter_tag_process($text, $filter) {
  $markup = _adinsight_clarity_build_tag();
  return str_replace('[adinsight-tag]', $markup, $text);
}

/**
 * AdInsight filter tips callback.
 */
function _adinsight_clarity_filter_tag_tips($filter, $format, $long = FALSE) {
  return t('<em>&lt;adinsight /&gt;</em> is replaced with the current telephone tag markup.');
}
