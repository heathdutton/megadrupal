<?php
/**
 * @file
 * This module allows you to add attachments to your e-mail, as well as send
 * full HTML e-mails. To prevent e-mail being marked as spam, ManyMail by
 * default sends everything as plain text.
 *
 * The trade-off of a higher spam score and possibly sending loads of bytes
 * across the wire is entirely up to the user's discretion.
 */

/**
 * Implements hook_manymail_mail_meta().
 */
function manymail_mime_manymail_mail_meta($form_state) {
  $meta['is_html'] = (user_access('manymail send html') && empty($form_state['values']['as_plain_text']));

  return $meta;
}

/**
 * Implements hook_manymail_mail_alter().
 *
 * @todo: add weight to have this hook executed last.
 */
function manymail_mime_manymail_mail_alter(&$mail, $meta) {
  if ($meta['is_html']) {
    // Set the content type to text/html.
    $mail->IsHTML();

    // Build a basic HTML page as a render array so modules
    // can change it through hook_manymail_mime_mail_alter().
    $head = array(
      '#prefix' => '<head>',
      '#suffix' => '</head>',
    );

    $head['charset'] = array(
      '#markup' => '<meta charset="' . check_plain($mail->CharSet) . '">',
    );

    $head['title'] = array(
      '#prefix' => '<title>',
      '#markup' => check_plain($mail->Subject),
      '#suffix' => '</title>',
    );

    $body = array(
      '#prefix' => '<body>',
      '#markup' => $mail->Body,
      '#suffix' => '</body>',
    );

    $html = array(
      '#prefix' => '<!DOCTYPE html><html>',
      '#suffix' => '</html>',
      'head' => $head,
      'body' => $body,
    );

    // Pass the render array to other modules for alteration.
    // The $mail and $meta variables are passed as context.
    drupal_alter('manymail_mime_mail', $html, $mail, $meta);

    // Render the render array as valid HTML.
    $mail->Body = drupal_render($html);
  }
}

/**
 * Implements hook_permission().
 */
function manymail_mime_permission() {
  $perm = array(
    'manymail send html' => array(
      'title' => t('Send HTML e-mail.'),
    ),
    // @todo: implement attachment functionality;
    /*'manymail mime' => array(
      'title' => t('Add attachments to e-mails.'),
    ),*/
  );

  return $perm;
}

/**
 * Implements hook_form_BASE_FORM_ID_alter().
 */
function manymail_mime_form_manymail_send_form_alter(&$form, &$form_state, $form_id) {
  if (user_access('manymail send html') && variable_get('manymail_mime_show_plain_toggle')) {
    $form['content']['as_plain_text'] = array(
      '#type' => 'checkbox',
      '#title' => t('Send as plain text'),
      '#default_value' => 0,
      '#description' => t('Send the e-mail as regular text, without any markup.<br />Significantly reduces the likelihood of your e-mail being marked as spam.'),
    );
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function manymail_mime_form_manymail_config_options_form_alter(&$form, &$form_state, $form_id) {
  $form['content']['manymail_options_html_to_text']['#title'] = t('For plain text e-mail, convert HTML to marked up plain text');

  $form['content']['manymail_mime_show_plain_toggle'] = array(
    '#type' => 'checkbox',
    '#title' => t('Show <em>Send as plain text</em> toggle'),
    '#default_value' => variable_get('manymail_mime_show_plain_toggle', 0),
    '#description' => t('When checked, shows users the option to still send their e-mail as plain text.'),
  );
}
