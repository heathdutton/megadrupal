<?php

function pax_content_menu() {
  $items = array();
  
  if (variable_get('pax_content_api_key', '')) {
    $data = _pax_content_get_content_list();
    foreach ($data->items as $entry) {
      $path = $entry->path;
      $items['pax/' . $path] = array(
        'title' => $entry->title,
        'page callback' => '_pax_content_get_content_item',
        'page arguments' => array($entry->id),
        'access arguments' => array('access pax content'),
        'type' => MENU_NORMAL_ITEM,
      );
    }
  }
  
  $items['admin/config/services/pax_content'] = array(
    'title' => 'PaX content',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('pax_content_admin_settings'),
    'access arguments' => array('administer pax content'),
    'file' => 'pax_content.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );
  
  return $items;
}

function pax_content_permission() {
  return array(
    'access pax content' => array(
      'title' => t('Access PaX content'),
      'description' => t('Allow user to view PaX content.'),
    ),
    'administer pax content' => array(
      'title' => t('Administer PaX content settings'),
      'description' => t('Administer PaX content settings.'),
    ),
  );
}

function _pax_content_get_content_list() {
  if ($key = variable_get('pax_content_api_key', '')) {
    if ($cache = cache_get('pax_content_list')) {
      return $cache->data;
    }
    else {
      $response = drupal_http_request('https://www.pax.de/api/content/list?key=' . $key);
      if ($response->code == 200) {

        $data = json_decode($response->data);
        cache_set('pax_content_list', $data, 'cache', REQUEST_TIME + 86400);
        return $data;
      }
    }
  }
}

function _pax_content_get_content_item($id) {
  if ($key = variable_get('pax_content_api_key', '')) {
    if ($cache = cache_get('pax_content_item_' . $id)) {
      return $cache->data;
    }
    else {      
      $response = drupal_http_request('https://www.pax.de/api/content/item/' . $id . '?key=' . $key);

      if ($response->code != 200) {
        drupal_not_found();
        return;
      }
      
      $output = json_decode($response->data);
      $body = base64_decode($output->body);
      
      cache_set('pax_content_item_' . $id, $body, 'cache', REQUEST_TIME + 86400);
      return $body;
    }
  }
  else {
    drupal_not_found();
    return;
  }
}
