<?php
/**
 * @file
 */

/**
 * Implements hook_menu().
 */
function webform_component_reuse_menu() {
  $items['admin/structure/webform_component_reuse'] = array(
    'title' => t('Administer Webform Component Reuse'),
    'page callback' => 'webform_component_reuse_list',
    'access arguments' => array('administer webform_component_reuse'),
    'file' => 'webform_component_reuse.pages.inc',
  );

  $items['admin/structure/webform_component_reuse/%webform_menu/list'] = array(
    'title' => t('Administer Webform Component Reuse'),
    'page callback' => 'webform_component_reuse_list',
    'page arguments' => array(3),
    'access arguments' => array('administer webform_component_reuse'),
    'file' => 'webform_component_reuse.pages.inc',
  );

  $items['node/%webform_menu/webform/add-from-library'] = array(
    'title' => t('Add from library'),
    'page callback' => 'webform_component_reuse_add_from_library',
    'page arguments' => array(1),
    'access arguments' => array('administer webform_component_reuse'),
    'weight' => 0,
    'type' => MENU_LOCAL_TASK,
    'file' => 'webform_component_reuse.pages.inc'
  );
  return $items;
}

/**
 * Implements hook_action_info().
 */
function webform_component_reuse_action_info() {
  $action = array(
    'webform_component_reuse_add_to_webform' => array(
      'label' => t('Add selected Webform Component Reuse to current Webform.'),
      'type' => 'webform_component_reuse',
      'configurable' => FALSE,
      'triggers' => array('any'),
    ),
  );
  return $action;
}

/**
 * Implements hook_entity_info().
 */
function webform_component_reuse_entity_info() {
  $info['webform_component_reuse'] = array(
    'label' => t('Webform Component Reuse'),
    'controller class' => 'WebformComponentReuseController',
    'base table' => 'webform_component_reuse',
    'fieldable' => TRUE,
    'entity keys' => array(
      'id' => 'wcid',
      'bundle' => 'bundle'
    ),
    'bundle keys' => array(
      'bundle' => 'bundle',
    ),
    'static cache' => TRUE,
    'bundles' => array(
      'webform_component_reuse' => array(
        'label' => 'Webform Component Reuse',
        'admin' => array(
          'path' => 'admin/structure/webform_component_reuse',
          'access arguments' => array('administer webform_component_reuse'),
        ),
      ),
    ),
    'view modes' => array(
      'full' => array(
        'label' => t('Full content'),
        'custom settings' =>  FALSE,
      ),
    )
  );

  return $info;
}

/**
 * Implements hook_permission().
 */
function webform_component_reuse_permission() {
  $permissions = array(
    'administer webform_component_reuse' =>  array(
      'title' => t('Administer webform_component_reuse'),
    ),
  );
  return $permissions;
}

/**
 * Implements hook_views_api().
 */
function webform_component_reuse_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'webform_component_reuse') . '/views',
  );
}

function webform_component_reuse_views_bulk_operations_form_alter(&$form, &$form_state, $vbo) {
  if($vbo && $vbo->view->name == 'webform_component_reuse') {
    $form['webform_component_reuse_webform_nid'] = array(
      '#type' => 'value',
      '#value' => isset($vbo->view->args[0]) ? $vbo->view->args[0] : 0,
    );
    $form['select']['submit']['#submit'][] = 'webform_component_reuse_views_bulk_operations_form_alter_submit';
    $form['#submit'][] = 'webform_component_reuse_views_bulk_operations_form_alter_submit';
  }
}

function webform_component_reuse_views_bulk_operations_form_alter_submit(&$form, &$form_state) {
  $values = $form_state['values'];
  if(isset($values['webform_component_reuse_webform_nid']) && $values['webform_component_reuse_webform_nid']) {
    $wcids = $values['views_bulk_operations'];
    $node = node_load($values['webform_component_reuse_webform_nid']);
    if(!empty($wcids) && $node) {
      foreach($wcids as $wcid) {
        if($wcid) {
          $entity = db_select('webform_component_reuse', 'w')
            ->fields('w')
            ->condition('wcid', $wcid)
            ->execute()
            ->fetchObject();
          $webform_component_reuse = (array) $entity;
          $webform_component_reuse['nid'] = $node->nid;
          $webform_component_reuse['pid'] = 0;
          $webform_component_reuse['extra'] = unserialize($webform_component_reuse['extra']);
          webform_component_insert($webform_component_reuse);
        }
      }
      $form_state['redirect'] = 'node/' . $values['webform_component_reuse_webform_nid'] . '/webform';
    }
  }
}

function webform_component_reuse_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'webform_component_edit_form' && arg(4) == 'new') {
    $entity = entity_get_controller('webform_component_reuse')->create();
    $form['basic_entity'] = array(
      '#type' => 'value',
      '#value' => $entity,
    );    
    $form['library'] = array(
      '#title' => t('Library'),
      '#type' => 'fieldset',
      '#collapsible' => TRUE,
      '#collapsed' => FALSE,
      '#attributes' => array('class' => array('collapsible')),
      '#weight' => 0,
    );
    $form['library']['save_for_future_use'] = array(
      '#title' => t('Saving for future use'),
      '#type' => 'checkbox',
      '#value' => 1,
    );
    $form['library']['entity_fields_container'] = array(
      '#type' => 'container',
      '#states' => array(
        'visible' => array(
          ':input[name="library[save_for_future_use]"]' => array(
            'checked' => TRUE,
          ),
        ),
      ),
    );
    field_attach_form('webform_component_reuse', $entity, $form, $form_state);
    $instances = field_info_instances('webform_component_reuse', 'webform_component_reuse');
    foreach($instances as $field_name => $instance) {
      $form['library']['entity_fields_container'][$field_name] = $form[$field_name];
      unset($form[$field_name]);
    }    
    $form['#submit'][] = 'webform_component_reuse_form_alter_submit';
  }
}

function webform_component_reuse_form_alter_submit(&$form, &$form_state) {
  $values = $form_state['values'];
  if ($values['library']['save_for_future_use']) {
    $entity = $values['basic_entity'];
    $entity->name = isset($values['name']) ? $values['name'] : '';
    $entity->form_key = isset($values['form_key']) ? $values['form_key'] : '';
    $entity->type = isset($values['type']) ? $values['type'] : '';
    $entity->value = isset($values['value']) ? $values['value'] : '';
    $entity->extra = isset($values['extra']) ? serialize($values['extra']) : array();
    $entity->mandatory = isset($values['mandatory']) ? $values['mandatory'] : 0;
    $entity->weight = isset($values['weight']) ? $values['weight'] : 0;
    $instances = field_info_instances('webform_component_reuse', 'webform_component_reuse');
    foreach($instances as $field_name => $instance) {
      $form_state['values'][$field_name] = $form_state['values']['library']['entity_fields_container'][$field_name];
    }
    field_attach_submit('webform_component_reuse', $entity, $form, $form_state);
    $entity = webform_component_reuse_save($entity);    
  }
}

function webform_component_reuse_view($entity, $view_mode = 'tweaky') {
  $entity_type = 'webform_component_reuse';
  $entity->content = array(
    '#view_mode' => $view_mode,
  );

  field_attach_prepare_view($entity_type, array($entity->wcid => $entity), $view_mode);
  entity_prepare_view($entity_type, array($entity->wcid => $entity));
  $entity->content += field_attach_view($entity_type, $entity, $view_mode);
  global $language;
  $langcode = $language->language;
  module_invoke_all('entity_view', $entity, $entity_type, $view_mode, $langcode);
  drupal_alter(array('webform_component_reuse_view', 'entity_view'),
    $entity->content, $entity_type);
  return $entity->content;
}

function webform_component_reuse_form($form, &$form_state, $entity) {
  $form['basic_entity'] = array(
    '#type' => 'value',
    '#value' => $entity,
  );
  field_attach_form('webform_component_reuse', $entity, $form, $form_state);
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save'),
    '#weight' => 100,
  );
  $form['delete'] = array(
    '#type' => 'submit',
    '#value' => t('Delete'),
    '#submit' => array('webform_component_reuse_edit_delete'),
    '#weight' => 200,
  );

  return $form;
}

function webform_component_reuse_form_validate($form, &$form_state) {
  field_attach_form_validate('webform_component_reuse', $form_state['values']['basic_entity'], $form, $form_state);
}

function webform_component_reuse_form_submit($form, &$form_state) {
  $entity = $form_state['values']['basic_entity'];
  field_attach_submit('webform_component_reuse', $entity, $form, $form_state);
  $entity = webform_component_reuse_save($entity);
  $form_state['redirect'] = 'admin/structure/webform_component_reuse/manage';
}

function webform_component_reuse_edit_delete( $form , &$form_state ) {
  $entity = $form_state['values']['basic_entity'];
  webform_component_reuse_delete($entity);
  drupal_set_message(t('The entity ID %id has been deleted',
    array('%id' => $entity->wcid))
  );
  $form_state['redirect'] = 'admin/structure/webform_component_reuse';
}

function webform_component_reuse_load($wcid = NULL, $reset = FALSE) {
  $wcids = (isset($wcid) ? array($wcid) : array());
  $basic = webform_component_reuse_load_multiple($wcids, array(), $reset);
  return $basic ? reset($basic) : FALSE;
}

function webform_component_reuse_load_multiple($wcids = FALSE, $conditions = array(), $reset = FALSE) {
  return entity_load('webform_component_reuse', $wcids, $conditions, $reset);
}

function webform_component_reuse_add() {
  $entity = entity_get_controller('webform_component_reuse')->create();
  return drupal_get_form('webform_component_reuse_form', $entity);
}

function webform_component_reuse_save(&$entity) {
  return entity_get_controller('webform_component_reuse')->save($entity);
}

function webform_component_reuse_delete($entity) {
  entity_get_controller('webform_component_reuse')->delete($entity);
}
