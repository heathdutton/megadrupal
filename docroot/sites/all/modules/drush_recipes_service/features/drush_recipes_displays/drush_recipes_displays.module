<?php
/**
 * @file
 * Code for the Drush Recipes displays feature.
 */

include_once 'drush_recipes_displays.features.inc';

/**
 * Implements hook_views_post_render().
 */
function drush_recipes_displays_views_post_render(&$view, &$output, &$cache) {
  // only work against the main recipes array
  if ($view->name == 'drush_recipes' && $view->plugin_name == 'views_data_export_xml') {
    //load xml to manipulate
    $ary = (array) simplexml_load_string($output);
    // test for 1 vs multiple recipes in this output
    if (isset($ary['drush_recipe']) && gettype($ary['drush_recipe']) == 'object') {
      $final = _drush_recipes_service_array_parser($ary);
      $final = array('drush_recipe' => array('recipe0' =>$final['drush_recipe']));
    }
    else  {
      $final = array();
      // loop through higher level array and prefix the items below
      foreach ($ary as $key => $ary2) {
        $final['drush_recipe'] = _drush_recipes_service_array_parser($ary2, 'recipe');
      }
    }
    // build a new XML object
    $xml = new SimpleXMLElement('<drush_recipes/>');
    _drush_recipes_service_array_to_xml($final, $xml);
    // effectively overwrite the output
    $output = $xml->asXML();
  }
}
