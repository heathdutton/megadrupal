<?php
/**
 * @file
 * Install, update and uninstall functions for the vchess module.
 *
 */

/**
 * Implements hook_install()
 */
function vchess_install() {
  // rid=2 => authenticated user
  user_role_change_permissions(2, 
    array(
      'view player' => TRUE,
      'basic access' => TRUE,
      'view game' => TRUE, 
      'view challenges' => TRUE,
      'accept challenge' => TRUE, 
      'my current games' => TRUE,
     )
   );
}

/**
 * Define the database tables required for this module
 * 
 * There are 2 tables:
 * - vchess_games contains summary of each game 
 *   - who is playing who
 *   - whose move it is
 *   - what the current board postion is
 *   - etc.
 * 
 * - vchess_moves contains the list of moves for each game
 * 
 * N.B. There is a problem with enum not currently being supported in core.  
 * The patch solution is:
 * - http://drupal.org/node/1464354
 * - http://drupal.org/node/1466122
 * Note that I originally thought that timestamp was not supported but it
 * is with the mysql_type key, see:
 * http://api.drupal.org/api/drupal/includes%21database%21schema.inc/group/schemaapi/7
 */
function vchess_schema() {
  
  // Table of each game, one row per game
  $schema['vchess_games'] = array(
      'description' => 'This table contains a summary of each game',
      'fields' => array(
          'gid' => array(
              'description' => 'Game id.  A unique identifier for a particular game.',
              'type' => 'serial',
              'unsigned' => TRUE,
              'not null' => TRUE,
          ),
          'turn' => array(
              'description' => 'Whose turn it is to play, either "w" (white) or "b" (black)',
              'type' => 'enum',  // See http://drupal.org/node/1464354 to get this working
              'enum' => array('w', 'b'),
              'not null' => TRUE,
              'default' => 'w',
          ),
          'status' => array(
              'description' => 'Status of the game',
              'type' => 'enum',  // See http://drupal.org/node/1464354 to get this working
              'enum' => array(
                  STATUS_AWAITING_PLAYERS,
                  STATUS_IN_PROGRESS,
                  STATUS_DRAW,
                  STATUS_WHITE_WIN,
                  STATUS_BLACK_WIN),
              'not null' => TRUE,
              'default' => 'in progress',
          ),
          'white_uid' => array(
              'description' => 'Userid of white player',
              'type' => 'int',
              'unsigned' => TRUE,
              'not null' => TRUE,
          ),
          'black_uid' => array(
              'description' => 'Userid of black player',
              'type' => 'int',
              'unsigned' => TRUE,
              'not null' => TRUE,
          ),
          'board' => array(
              'description' => 'The board position saved as standard Forsyth–Edwards Notation (FEN)',
              'type' => 'varchar',
              'length' => '72',
              'not null' => TRUE,
              'default' => 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR',
          ),
          'castling' => array(
              'description' => 'Castling availability. If neither side can castle, this is "-". Otherwise, this has one or more letters: "K" (White can castle kingside), "Q" (White can castle queenside), "k" (Black can castle kingside), and/or "q" (Black can castle queenside).',
              'type' => 'varchar',
              'length' => '4',
              'not null' => TRUE,
              'default' => 'KQkq',
          ),
          'en_passant' => array(
              'description' => 'ep (en passant) target square. If there is no ep target square, this is "-". If a pawn has just made a 2-square move, this is the position "behind" the pawn. This is recorded regardless of whether there is a pawn in position to make an ep capture.',
              'type' => 'char',
              'length' => '2',
              'not null' => TRUE,
              'default' => '-',
          ),
          'time_per_move' => array(
              'description' => 'Time per move (the units are defined by time_units field)',
              'type' => 'int',
              'unsigned' => TRUE,
              'not null' => TRUE,
              'default' => DEFAULT_TIME_PER_MOVE,
          ),
          'time_units' => array(
              'description' => 'Units of the time_per_move field',
              'type' => 'enum',
              'enum' => array(TIME_UNITS_DAYS, TIME_UNITS_HOURS, TIME_UNITS_MINS, TIME_UNITS_SECS),
              'not null' => TRUE,
              'default' => DEFAULT_TIME_UNITS,
          ),
          'time_started' => array(
              'description' => 'Date and time of the start of the game, e.g. 2012-05-03 12:01:29',
              'type' => 'datetime',  
              'mysql_type' => 'datetime',
              'not null' => TRUE,
          ),
          ),
          'primary key' => array('gid'),
      );

  // Table of the moves of each game, one row per move
  $schema['vchess_moves'] = array(
      'description' => 'Contains the list of moves for each game',
      'fields' => array(
          'gid' => array(
              'description' => 'Game id',
              'type' => 'int',
              'unsigned' => TRUE,
              'not null' => TRUE,
          ),
          'move_no' => array(
              'description' => 'Move number',
              'type' => 'int',
              'unsigned' => TRUE,
              'not null' => TRUE,
          ),
          'color' => array(
              'description' => 'Move color',
              'type' => 'enum',
              'enum' => array('w', 'b'),
              'not null' => TRUE,
          ),
          'long_move' => array(
              'description' => 'The actual move in full detail format, e.g. "Pe2-e4", "Nf6xBg8", "Ke1-g1"',
              'type' => 'varchar',
              'length' => '10',
              'not null' => TRUE,
          ),
          'algebraic' => array(
              'description' => 'Move in algebraic notation (e.g. "e4", "Nc3", "O-O")',
              'type' => 'varchar',
              'length' => '20',
              'not null' => TRUE,
          ),
          'datetime' => array(
              'description' => 'Exact date and time of the move',
              'type' => 'datetime',
              'mysql_type' => 'datetime',
              'not null' => TRUE,
          ),
      ),
      'primary key' => array('gid', 'move_no', 'color'),
  );
  
  return $schema;
}
