<?php
/**
 * Install, uninstall, schema and update hooks for module
 */

/**
 * Implements hook_install
 */
function vinfield_install() {
}

/**
 * Implements of hook_uninstall
 */
function vinfield_uninstall() {
}

/**
 * Implements hook_field_schema
 */
function vinfield_field_schema($field) {
  $columns = array(
    'vin' => array(
      'description' => 'VIN',
      'type' => 'char',
      'length' => 17,
      'not null' => TRUE,
    ),
    'year' => array(
      'description' => 'Model year of vehicle',
      'type' => 'char',
      'length' => 4,
    ),
    'make' => array(
      'description' => 'Make of vehicle',
      'type' => 'varchar',
      'length' => 128,
    ),
    'model' => array(
      'description' => 'Model of vehicle',
      'type' => 'varchar',
      'length' => 128,
    ),
    'trim' => array(
      'description' => 'Trim level of vehicle',
      'type' => 'varchar',
      'length' => 128,
    ),
    'extra' => array(
      'description' => 'Extended model information',
      'type' => 'text',
      'size' => 'big',
    ),
    'module' => array(
      'description' => 'Name of module that retrieved this data',
      'type' => 'varchar',
      'length' => 128,
    ),
  );

  $indexes = array(
    'year' => array('year'),
    'make' => array('make'),
    'model' => array('model'),
    'module' => array('module'),
  );

  return array(
    'columns' => $columns,
    'indexes' => $indexes,
  );
}

/**
 * Implements hook_schema
 */
function vinfield_schema() {
  // Create new cache table using core cache schema
  $schema['cache_vinfield'] = drupal_get_schema_unprocessed('system', 'cache');
  $schema['cache_vinfield']['description'] = 'Cache bin for the cache_vinfield module';

  return $schema;
}

/**
 * Remove serialization flag from field schema
 */
function vinfield_update_7100() {
  // Updated schema definition for the field
  $vinfield_extra_schema = array(
    'description' => 'Extended model information',
    'type' => 'text',
    'size' => 'big',
  );

  $fields = field_info_fields();
  foreach ($fields as $field_name => $field) {
    if ($field['type'] == 'vinfield' && $field['storage']['type'] == 'field_sql_storage') {
      foreach ($field['storage']['details']['sql'] as $type => $table_info) {
        foreach ($table_info as $table_name => $columns) {
          $column_name = _field_sql_storage_columnname($field_name, 'extra');
          db_change_field($table_name, $column_name, $column_name, $vinfield_extra_schema);
        }
      }
    }
  }
  field_cache_clear();
}
