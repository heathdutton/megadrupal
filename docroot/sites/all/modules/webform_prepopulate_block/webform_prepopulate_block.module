<?php

/**
 * @file
 *
 * Developed by Gabor Szanto.
 *  hello@szantogabor.com
 *  http://szantogabor.com
 */

define("WEBFORM_PREPOPULATE_BLOCK_VARIABLE_PREFIX", 'webform_prepopulate_block_');

/**
 * Implements hook_form().
 */
function webform_prepopulate_block_forms() {
  $forms = array();
  if ($blocks = _webform_prepopulate_block_variable_get()) {
    foreach (array_keys($blocks) as $block) {
      $forms["$block"]['callback'] = 'webform_prepopulate_block_block_form';
    }
  }
  return $forms;
}

/**
 * Implements hook_form_alter().
 */
function webform_prepopulate_block_form_alter(&$form, &$form_state, $form_id) {
  if (strpos($form_id, 'webform_client_form') !== FALSE) {
    // Force set default_values of components from url query string.
    _webform_prepopulate_block_prepare_default_values($form, $form_state, array('submitted'));
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function webform_prepopulate_block_form_webform_component_edit_form_alter(&$form, &$form_state) {
  $component = $form_state['build_info']['args'][1];
  if (in_array($form['type']['#value'], _webform_prepopulate_block_get_enabled_types())) {
    $form['display']['prepopulate_block'] = array(
      '#type' => 'checkbox',
      '#title' => t('Add to prepopulate block'),
      '#default_value' => isset($component['extra']['prepopulate_block']) ? $component['extra']['prepopulate_block'] : FALSE,
      '#description' => t('If checked, the component will be added to a custom block of this webform. When submit that custom form, will be redirected to original webform, and prepopulate the values previous set.'),
      '#parents' => array('extra', 'prepopulate_block'),
    );
    $form['#submit'][] = 'webform_prepopulate_block_webform_component_edit_form_submit';
  }
}

function webform_prepopulate_block_webform_component_edit_form_submit($form, &$form_state) {
  $var = WEBFORM_PREPOPULATE_BLOCK_VARIABLE_PREFIX . $form_state['values']['nid'];
  $block = variable_get($var, array());
  if ($form_state['values']['extra']['prepopulate_block'] == 1) {
    $block["cid_{$form_state['values']['cid']}"] = $form_state['values']['cid'];
    variable_set($var, $block);
  }
  else {
    if (isset($block["cid_{$form_state['values']['cid']}"])) {
      unset($block["cid_{$form_state['values']['cid']}"]);
      variable_set($var, $block);
    }
  }
}

/**
 * Implements hook_block_info().
 */
function webform_prepopulate_block_block_info() {
  $blocks = array();

  $webform_blocks = _webform_prepopulate_block_variable_get();
  foreach ($webform_blocks as $name => $value) {
    $nid = str_replace(WEBFORM_PREPOPULATE_BLOCK_VARIABLE_PREFIX, '', $name);
    $webform_node = node_load($nid);
    $blocks[$name] = array(
      'info' => t('Webform prepopulate block for @title', array('@title' => $webform_node->title)),
    );
  }
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function webform_prepopulate_block_block_view($delta = '') {
  $block = array();
  $webform_blocks = _webform_prepopulate_block_variable_get();
  foreach ($webform_blocks as $name => $components) {
    switch ($delta) {
      case $name:
        $nid = str_replace(WEBFORM_PREPOPULATE_BLOCK_VARIABLE_PREFIX, '', $name);
        $webform_node = node_load($nid);
        // Return if user has no access to the webform node.
        if (!node_access('view', $webform_node)) {
          return;
        }

        $block['subject'] = check_plain($webform_node->title);
        $block['content'] = drupal_get_form("$name", $webform_node, $components);

        break;
    }
  }
  return $block;
}

/**
 * Implements hook_form_FORM_ID_alter().
 * @todo: Is this deprecated?
 */
function webform_prepopulate_block_form_webform_client_form_alter(&$form, &$form_state) {
  if (isset($form['#node']->webform_prepopulate_block) && $form['#node']->webform_prepopulate_block) {
    $form['#submit'] = array('webform_prepopulate_block_webform_submit');
  }
}

/**
 * Build own form for our blocks. Simple render the webform, and pick up
 * components flagged as prepopulate_block.
 * @param $form
 *   Need for form_builder.
 * @param $form_state
 *   Need for form_builder.
 * @param $node
 *   The webform node.
 * @param $components
 *   The components flagged as prepopulate_block.
 *
 * @return array
 */
function webform_prepopulate_block_block_form($form, &$form_state, $node, $components) {
  $form = array('#node' => $node);

  $form['#attached'] = array(
    'css' => array(drupal_get_path('module', 'webform') . '/css/webform.css'),
    'js' => array(drupal_get_path('module', 'webform') . '/js/webform.js'),
  );

  foreach (element_children($node->webform['components']) as $key) {
    if (in_array($node->webform['components'][$key]['cid'], $components)) {
      $form_key = $node->webform['components'][$key]['form_key'];
      $element = $node->webform['components'][$key];
      $form[$form_key] = webform_component_invoke($element['type'], 'render', $element, array(), FALSE);
      $form[$form_key]['#default_value'] = isset($_GET[$form_key]) ? $_GET[$form_key] : $element['value'];
      drupal_alter('webform_component_render', $element, $component);
    }
  }

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => empty($node->webform['submit_text']) ? t('Submit') : t($node->webform['submit_text']),
    '#weight' => 1000,
  );
  $form['#submit'][] = 'webform_prepopulate_block_webform_submit';

  return $form;
}

/**
 * Custom form submit function to redirect to webform node with prepopulated
 * query args.
 */
function webform_prepopulate_block_webform_submit($form, &$form_state) {
  $node = $form['#node'];
  $query = array();
  //$url = url("node/$nid", array('absolute' => TRUE, 'query' => $form_state['input']['submitted']));
  $components = _webform_prepopulate_block_variable_get($node->nid);
  foreach (element_children($node->webform['components']) as $key) {
    if (in_array($node->webform['components'][$key]['cid'], $components)) {
      $form_key = $node->webform['components'][$key]['form_key'];
      $query[$form_key] = $form_state['values'][$form_key];
    }
  }

  $form_state['redirect'] = url("node/$node->nid", array(
    'absolute' => TRUE,
    'query' => $query
  ));
}

/**
 * Helper funcion to get types, in which prepopulate block flag could be set.
 *
 * @return array
 *   A simple array of enabled types.
 */
function _webform_prepopulate_block_get_enabled_types() {
  return array(
    'textfield',
    'select',
    'textarea',
    'number',
    'date',
  );
}

/**
 * Helper function to get variables built by this module.
 *
 * @param null $nid
 *  A webform node id.
 *
 * @return array|null
 *  An array of variables keyed by its name. If nid exists, only the nid
 *  variable will return.
 */
function _webform_prepopulate_block_variable_get($nid = NULL) {
  if (!is_null($nid)) {
    return variable_get(WEBFORM_PREPOPULATE_BLOCK_VARIABLE_PREFIX . $nid, array());
  }
  else {
    $variables = &drupal_static(__FUNCTION__);
    if (!empty($variables)) {
      return $variables;
    }
    $variables = array();
    foreach (
      db_select('variable', 'v')
        ->fields('v')
        ->condition('name', db_like(WEBFORM_PREPOPULATE_BLOCK_VARIABLE_PREFIX) . '%', 'LIKE')
        ->execute()
        ->fetchCol() as $name
    ) {
      $variables[$name] = variable_get($name);
    }
  }
  return $variables;
}

/**
 * Build forced default values form a webform.
 *
 * @param $form
 *   The webform array we are working on.
 * @param $form_state
 * @param $parents
 *   An array of parents item. It needs for recursive calling to set correct
 *   values within fieldset, or other container elements.
 * @param bool $force
 *   If TRUE, the ref array will be rebuild.
 */
function _webform_prepopulate_block_prepare_default_values(&$form, &$form_state, $parents, $force = FALSE) {
  $vars = _webform_prepopulate_block_variable_get($form['#node']->nid);
  $parents_array = $parents;

  // Build actual form item working on based on $parents.
  // See: http://api.drupal.org/api/drupal/includes%21common.inc/function/drupal_array_set_nested_value/7
  $ref = &$form;
  foreach ($parents as $parent) {
    if ($force && isset($ref) && !is_array($ref)) {
      $ref = array();
    }
    $ref = &$ref[$parent];
  }

  foreach (element_children($ref) as $child) {
    //dsm(get_defined_vars());

    if (isset($_GET[$child]) && isset($vars['cid_' . $ref[$child]['#webform_component']['cid']])) {
      $ref[$child]['#default_value'] = $_GET[$child];
    }
    if ($ref[$child]['#type'] == 'fieldset') {
      $parents_array[] = $child;
      _webform_prepopulate_block_prepare_default_values($form, $form_state, $parents_array, TRUE);
    }
    $parents_array = $parents;
  }
}
