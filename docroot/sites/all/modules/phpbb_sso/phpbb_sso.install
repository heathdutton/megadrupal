<?php

function phpbb_sso_requirements($phase) {
    $requirements = array();
    // Ensure translations don't break during installation.
    $t = get_t();

    // Report cron status
    if ($phase == 'runtime') {
        $settings = array(
            'phpbb_sso_phpbb_table_prefix' => array(
                'title' => 'phpBB table prefix',
                'description' => 'Please set the phpBB table prefix.',
            ),
            'phpbb_sso_phpbb_path' => array(
                'title' => 'phpBB path',
                'description' => 'Please set the phpBB directory path.',
            ),
        );

        foreach ($settings as $index => $setting) {
            if (strlen(variable_get($index, '')) == 0) {
                $requirements[$index] = array(
                    'title' => $t($setting['title']),
                    'description' => $t($setting['description']),
                    'severity' => REQUIREMENT_ERROR,
                    'value' => $t('Missing setting.'),
                );
            }
        }

        if (strlen(variable_get('phpbb_sso_phpbb_path', ''))) {
            module_load_include('inc', 'phpbb_sso', 'phpbb_sso.utility');

            $version = phpbb_sso_get_phpbb_version();
            if (!empty($version)) {
                $requirements['phpbb_sso_phpbb_version'] = array(
                    'title' => $t('phpBB forum'),
                    'severity' => REQUIREMENT_OK,
                    'value' => phpbb_sso_get_phpbb_version(),
                );
            }
        }
    }

    return $requirements;
}
