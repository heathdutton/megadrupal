<?php
/**
 * @file Freebase Googlecode version of API
 *
 * Utility to make requests from the Freebase API.
 *
 * 2014 DEPRECATED as the googlecode library worked on here is just too
 * broken. DO NOT USE.
 *
 * @author 'dman' Dan Morrison http://coders.co.nz/
 * @version 2010
 */

module_load_include('inc', 'freebase_googlecode', 'freebase_googlecode');

/**
 * hook_help()
 */
function freebase_googlecode_help($path, $arg) {
  switch ($path) {
    case 'admin/help#freebase_googlecode':
      $list = array();
      $tests = file_scan_directory(drupal_get_path('module', 'freebase_googlecode') . '/tests', '/.*\.php/');
      foreach ($tests as $test_file) {
        $list[] = array('href' => file_create_url($test_file->uri), 'title' => $test_file->filename);
      }
      $output = "Some basic tests to see if things are working.";
      $output .= theme('links', array('links' => $list));
      return $output;
      break;
  }
}

/**
 * Implements hook_libraries_info().
 *
 * See also gauth.module which publishes the library too, but is not suitable
 * for our needs yet.
 *
 * If libraries.module is not in use, we also do some directory scanning
 * manually to see if we can find it too.
 * @see freebase_googlecode_get_freebase.
 */
function freebase_googlecode_libraries_info() {
  $libraries['google-api-php-client'] = array(
    'title' => 'Google OAuth2 Library',
    'vendor url' => 'http://code.google.com/p/google-api-php-client',
    'download url' => 'http://code.google.com/p/google-api-php-client/downloads/list',
    'version arguments' => array(
      'file' => 'src/io/Google_HttpRequest.php',
      'pattern' => '/USER_AGENT_SUFFIX = "+(google-api-php-client\/\d\.\d\.\d)+";/',
      'lines' => 27,
    ),
    'versions' => array(
      'google-api-php-client/0.6.0' => array(),
    ),
    'files' => array(
      'php' => array(
        'src/Google_Client.php',
      ),
    ),
  );
  return $libraries;
}

/**
 * Implements hook_libraries_info_alter().
 *
 * Use alter not hook_libraries info so as not to clash with gauth.module
 */
function freebase_googlecode_libraries_info_alter(&$libraries) {
  // Cannot trust the googlecode version - load our local fork of it instead.
  #$libraries['google-api-php-client']['files']['php'][] = 'src/contrib/Google_FreebaseService.php';
}


/**
 * Implementation of hook_requirements().
 */
function freebase_googlecode_requirements($phase) {
  $requirements = array();
  // Ensure translations don't break at install time
  $t = get_t();

  if ($phase == 'runtime') {
    $phpfreebase = freebase_googlecode_get_freebase();
    $strings = array(
      '@Google_FreebaseService_url' => 'https://code.google.com/p/google-api-php-client/',
      '@help_url' => url('admin/help/freebase_googlecode'),
    );
    if ($phpfreebase) {
      $requirements['Google_FreebaseService'] = array(
        'title' => $t('Google Freebase library'),
        'value' => $t('Google_FreebaseService library is available. <a href="@help_url">Diagnostics</a>', $strings),
        'severity' => REQUIREMENT_OK,
      );
    }
    else {
      $requirements['Google_FreebaseService'] = array(
        'title' => $t('Google Freebase library'),
        'description' => $t('Google_FreebaseService library is required to make remote requests over the googlecode API.'),
        'value' => $t("Google_FreebaseService library doesn't seem to be available."),
        'severity' => REQUIREMENT_ERROR,
        'description' => $t('
          See the README or <a href="@help_url">help</a> for install instructions.
          Download the required libraries from
          <a href="@Google_FreebaseService_url">googlecode</a>.
          Place it in <code>sites/all/libraries/google-api-php-client/</code>',
          $strings
        ),
      );
    }
  }

  return $requirements;
}
