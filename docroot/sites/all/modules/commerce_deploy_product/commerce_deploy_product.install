<?php
/**
 * @file
 * Install, update and uninstall functions for the Commerce deploy installation profile.
 */

/**
 * Implements hook_install().
 */
function commerce_deploy_product_install() {
  // Allow any user to view products
  user_role_grant_permissions(DRUPAL_ANONYMOUS_RID, array('view any commerce_product entity'));
  user_role_grant_permissions(DRUPAL_AUTHENTICATED_RID, array('view any commerce_product entity'));
  
  // Generate a product display content type
  $product_display = array(
    'type' => 'product_display',
    'name' => st('Product display'),
    'base' => 'node_content',
    'description' => st('Use product displays for adding product pages to your store'),
    'custom' => 1,
    'modified' => 1,
    'locked' => 0,
  );
  $product_display = node_type_set_defaults($product_display);
  node_type_save($product_display);
  node_add_body_field($product_display);

  // Add a product reference field that uses Inline Entity Form.
  // This field name changed early in development.
  //  See https://www.drupal.org/node/2298111.
  $field_name = 'field_product';
  $entity_type = 'node';
  $bundle = 'product_display';
  $label = 'Products';

  commerce_activate_field($field_name);
  field_cache_clear();

  $field = field_info_field($field_name);
  $instance = field_info_instance($entity_type, $field_name, $bundle);

  if (empty($field)) {
    $field = array(
      'field_name' => $field_name,
      'type' => 'commerce_product_reference',
      'cardinality' => -1,
      'entity_types' => array($entity_type),
      'translatable' => FALSE,
      'locked' => FALSE,
    );
    $field = field_create_field($field);
  }

  if (empty($instance)) {
    $instance = array(
      'field_name' => $field_name,
      'entity_type' => $entity_type,
      'bundle' => $bundle,

      'label' => $label,
      'required' => TRUE,
      'settings' => array(),

      'widget' => array(
        'type' => 'inline_entity_form',
        'weight' => 0,
        'settings' => array(
          'type_settings' => array(
            'allow_bulk_create' => 1,
          ),
        ),
      ),

      'display' => array(
        'display' => array(
          'label' => 'hidden',
          'weight' => 5,
          'type' => 'commerce_cart_add_to_cart_form',
          'settings' => array(
            'show_quantity' => FALSE,
            'default_quantity' => 1,
            'combine' => TRUE,
            'show_single_product_attributes' => FALSE,
            'line_item_type' => 'product',
          ),
          'module' => 'commerce_cart',
        ),
      ),
    );
    field_create_instance($instance);
  }
}
