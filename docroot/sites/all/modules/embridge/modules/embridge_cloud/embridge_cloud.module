<?php

/**
 * @file
 * Defines functions for EnterMedia and Cloud integration.
 */

/**
 * Settings for Cloud.
 */
function embridge_cloud_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'embridge_settings') {
    $form['cloud_info'] = array(
      '#type' => 'fieldset',
      '#title' => t('Cloud information'),
      '#description' => t('Information to utilize Cloud server for renditions.'),
      '#collapsible' => TRUE,
      '#weight' => 11,
    );
    $form['cloud_info']['embridge_cloud_server_url'] = array(
      '#type' => 'textfield',
      '#title' => t('Cloud URL'),
      '#size' => 100,
      '#description' => t('Cloud URL (e.g. http://assets.entermediasoftware.com).'),
      '#default_value' => variable_get('embridge_cloud_server_url', ''),
    );

    $form['cloud_info']['embridge_cloud_use_cloud_urls'] = array(
      '#type' => 'checkbox',
      '#title' => t('Use Cloud URLs'),
      '#description' => t('The Cloud URLs will be used when the renditions are avaiable on the Cloud server.'),
      '#default_value' => variable_get('embridge_cloud_use_cloud_urls', FALSE),
    );
  }
}

/**
 * Convert regular url to cloud url.
 * @param type $url
 * @return cloud url.
 */
function embridge_cloud_convert_url($url) {
  $converted_url = $url;
  $server_url = variable_get('embridge_server_url', 'http://entermedia.databasepublish.com');
  $server_port = variable_get('embridge_server_port', '8080');
  $server_name = $server_url . ($server_port ? ':' . $server_port : '');
  $embridge_cloud_server_url = variable_get('embridge_cloud_server_url', '');
  $use_cloud_urls = variable_get('embridge_cloud_use_cloud_urls', FALSE);
  if ($use_cloud_urls) {
    $converted_url = str_replace($server_name, $embridge_cloud_server_url, $url);
  }
  return $converted_url;
}

/**
 * Define function here.
 */
function embridge_cloud_preprocess_embridge_field_icon(&$vars) {
  $server_url = variable_get('embridge_server_url', 'http://entermedia.databasepublish.com');
  $server_port = variable_get('embridge_server_port', '8080');
  $server_name = $server_url . ($server_port ? ':' . $server_port : '');
  $embridge_cloud_server_url = variable_get('embridge_cloud_server_url', '');
  $use_cloud_urls = variable_get('embridge_cloud_use_cloud_urls', FALSE);
  if ($use_cloud_urls) {
    $entermediaasset = &$vars['entermediaasset'];
    $catalog_tokens = explode('/', $entermediaasset->catalogid);
    $catalog_name = array_pop($catalog_tokens);
    $rendition_settings = variable_get('embridge_' . $catalog_name . '_renditions', array());
    // Replace EnterMedia urls by Cloud urls.
    foreach ($rendition_settings as $key => $value) {
      if (!empty($entermediaasset->$key)) {
        $entermediaasset->$key = str_replace($server_name, $embridge_cloud_server_url, $entermediaasset->$key);
      }
    }
    $entermediaasset->preview = str_replace($server_name, $embridge_cloud_server_url, $entermediaasset->preview);
    $entermediaasset->thumbnail = str_replace($server_name, $embridge_cloud_server_url, $entermediaasset->thumbnail);
  }
}

/**
 * implements hook_embridge_renditions_alter()
 */
function embridge_cloud_embridge_renditions_alter($renditions) {
  $server_url = variable_get('embridge_server_url', 'http://entermedia.databasepublish.com');
  $server_port = variable_get('embridge_server_port', '8080');
  
  $server_name = $server_url . ($server_port ? ':' . $server_port : '');
  $embridge_cloud_server_url = variable_get('embridge_cloud_server_url', '');
  $use_cloud_urls = variable_get('embridge_cloud_use_cloud_urls', FALSE);
  if ($use_cloud_urls) {
    foreach ($renditions as $key => $value) {
      $renditions[$key] = str_replace($server_name, $embridge_cloud_server_url, $value);
    }
  }
  return $renditions;
}