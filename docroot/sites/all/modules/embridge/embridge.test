<?php

/**
 * @file
 * Tests for the embridge module
 */

/**
 * Class EmbridgeTestCase to define test cases.
 */
class EmbridgeTestCase extends DrupalWebTestCase {
  /**
   * Define info for Embridge Test Case.
   */
  public static function getInfo() {
    return array(
      'name' => t('Embridge functionality'),
      'description' => t('Test admin and integration with EnterMedia server in the Embridge module.'),
      'group' => 'Embridge',
    );
  }

  /**
   * Initialize setup for Embridge Test Case.
   *
   * Enable modules and create users with specific permissions.
   */
  public function setUp() {
    parent::setUp('embridge');
    $this->privileged_user = $this->drupalCreateUser(array(
      'administer entermedia',
      'allow entermedia metadata update',
      'allow entermedia asset upload',
      'allow entermedia search',
    ));
  }

  /**
   * Test Menu functionality through the admin and user interfaces.
   */
  public function testMenu() {
    $items = module_invoke('embridge', 'menu');
    $this->assertTrue(is_array($items), t('Module defines menu items.'));
    $this->assertTrue(isset($items['admin/config/entermedia']), t('Module defines embridge settings section.'));
    $this->assertTrue(isset($items['admin/config/embridge/settings']), t('Module defines embridge admin page.'));
    $this->assertTrue(isset($items['embridge/search/%']), t('Module defines embridge search page.'));
    $this->assertTrue(isset($items['embridge/bulk-upload/%']), t('Module defines embridge bulk upload page.'));
  }

  /**
   * Test Embridge Admin page.
   */
  public function testAdminPage() {
    $this->drupalLogin($this->privileged_user);
    $this->drupalGet("admin/config/embridge/settings");
    // Make sure we don't get a 401 unauthorized response:
    $this->assertResponse(200, t('Admin is allowed to access admin page.'));
    $this->assertText(t("@title", array('@title' => 'EnterMedia server information')), "Found server settings");
  }
}

/**
 * Class EmbridgeUnitCase to define unit test cases.
 */
class EmbridgeUnitCase extends DrupalUnitTestCase {
  /**
   * Define info for Embridge Test Case.
   */
  public static function getInfo() {
    return array(
      'name' => t('Embridge module unit tests'),
      'description' => t('Test that custom functions in embridge modules work properly.'),
      'group' => 'Examples',
    );
  }

  /**
   * Initialize setup for Embridge Unit Test Case - Enable modules.
   */
  public function setUp() {
    drupal_load('module', 'embridge');
    parent::setUp();
  }

  /**
   * Test Embridge Unit functions.
   */
  public function testUnitTestFunction() {
    $result = _embridge_get_file_extension('/var/www/html/files/01234567.jpg');
    $message = t('A valid filepath value should return correct extension.');
    $this->assertEqual('jpg', $result, $message);
  }
}
