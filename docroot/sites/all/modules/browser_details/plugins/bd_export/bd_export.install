<?php

function bd_export_requirements($phase) {
  $requirements = array();
  // Ensure translations don't break during installation.
  $t = get_t();

  if (!module_exists('libraries')) {
      $requirements['libraries'] = array(
          'title' => $t('Libraries module missing'),
          'value' => t('Libraries module required for Browser Details Export'),
          'description' => $t('Browser Details Export module requires the <a href="@url">Libraries module</a> to be installed.', array('@url' => 'http://drupal.org/project/libraries')),
          'severity' => REQUIREMENT_ERROR,
      );
      return $requirements;
  }

  $requirements['dompdf']['title'] = $t('dompdf library');

  if (!($path = libraries_get_path('dompdf')) || !file_exists($path . '/dompdf_config.inc.php')) {
    $download_url = 'https://github.com/downloads/dompdf/dompdf/dompdf_0-6-0_beta3.tar.gz';

    if ($phase != 'install') {
        $requirements['dompdf']['value'] = $t('Not found');
    }
    $requirements['dompdf']['severity'] = REQUIREMENT_ERROR;
    $requirements['dompdf']['description'] = $t('The dompdf library is required by Browser Details Export.'
        . '<br/>Please <a href="@url">download</a> dompdf and extract it into <em>sites/all/libraries</em> so that <em>sites/all/libraries/dompdf/dompdf_config.inc.php</em> exists.', 
        array('@url' => $download_url));
  } else {
    $dompdf = libraries_detect('dompdf');
    $requirements['dompdf']['value'] = ($dompdf && !empty($dompdf['version'])) ? $dompdf['version'] : 'unknown version';
    $requirements['dompdf']['severity'] = REQUIREMENT_OK;
  }

  $min_php = 5.0; // dompdf requires PHP 5.0+
  if (version_compare(phpversion(), $min_php) < 0) {
    $requirements['dompdf']['description'] = $t('Your PHP installation is too old. The dompdf library requires at least PHP %version.', array('%version' => $min_php));
    $requirements['dompdf']['severity'] = REQUIREMENT_ERROR;
  }

  return $requirements;
}
