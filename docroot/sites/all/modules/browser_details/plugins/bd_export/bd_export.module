<?php

/**
 * Implements hook_libraries_info()
 */
function bd_export_libraries_info() {
    $libraries = array();
    $libraries['dompdf'] = array(
        'name' => 'dompdf',
        'vendor url' => 'http://github.com/dompdf/dompdf',
        'download url' => 'https://github.com/downloads/dompdf/dompdf/dompdf_0-6-0_beta3.tar.gz',
        'version arguments' => array(
            'file' => 'changelog.txt',
            'pattern' => '/DOMPDF (.+) Release Notes/',
            'lines' => 5,
        ),
        'files' => array(
            'php' => array('dompdf_config.inc.php'),
        ),
    );

    return $libraries;
}

/**
 * Implements hook_permission().
 */
function bd_export_permission() {
    return array(
        'export browser details' => array(
            'title' => 'Export browser details',
        ),
    );
}

/**
 * Implements hook_theme().
 */
function bd_export_theme($existing, $type, $theme, $path) {
    return array(
        'bd_export_download' => array(
            'variables' => array(
                'plugins' => NULL,
                'format' => NULL,
            ),
        ),
        'bd_export_download_pdf' => array(
            'variables' => array(
                'plugins' => NULL,
            ),
        ),
        'bd_export_download_csv' => array(
            'variables' => array(
                'plugins' => NULL,
            ),
        ),
    );
}

function theme_bd_export_download(&$variables) {
    return theme('bd_export_download_' . $variables['format'], array('plugins' => $variables['plugins']));
}

function theme_bd_export_download_csv(&$variables) {
    return 'CSV is not ready';
}

function theme_bd_export_download_pdf(&$variables) {
    $output = '';
    $plugins = $variables['plugins'];
    foreach ($plugins as $plugin) {
        $block = (object) array('module' => 'browser_details', 'delta' => $plugin['name'], 'title' => '', 'region' => 'content');
        $blocks = _block_render_blocks(array($block));
        $renderable_block = _block_get_renderable_array($blocks);
        unset($renderable_block['browser_details_' . $plugin['name']]['#contextual_links']);
        $output .= drupal_render($renderable_block);
    }
    $output = "<html><body>$output</body></html>";
    return $output;
}

/**
 * Implements hook_browser_details_plugin().
 */
function bd_export_browser_details_plugin() {
    return array(
        'export_pdf' => array(
            'name' => 'export_pdf',
            'title' => 'Export to PDF',
            'icon' => 'bd_export_load_pdf_icon',
            'content' => 'bd_export_load_pdf_content',
        ),/*
        'export_csv' => array(
            'name' => 'export_csv',
            'title' => '',
            'icon' => 'bd_export_load_csv_icon',
            'content' => 'bd_export_load_csv_content',
        ),*/
    );
}

function bd_export_load_pdf_icon() {
    if (!user_access('export browser details'))
        return;
}

function bd_export_load_pdf_content() {
    if (!user_access('export browser details'))
        return;

    $plugins = browser_details_load();
    foreach (array('export_pdf', 'export_csv') as $plugin) {
        unset($plugins[$plugin]);
    }

    $settings = array(
        'plugins' => array_keys($plugins),
    );
    drupal_add_js(array('bd_export' => $settings), 'setting');

    $form = drupal_render(drupal_get_form('bd_export_download_pdf_form'));
    return $form;
}

function bd_export_download_pdf_form() {
    $form = array();
    $form['pdf_export'] = array(
        '#type' => 'submit',
        '#value' => 'Export to PDF',
    );

    $extra_info = 'pdf_export_extra';
    $form[$extra_info] = array(
        '#type' => 'hidden',
        '#default_value' => '',
    );

    if (!libraries_load('dompdf')) {
        return drupal_set_message('PDF export not configured.', 'error');
    }

    drupal_add_js(array('bd_export' => array('extra_info' => $extra_info)), 'setting');
    return $form;
}

function bd_export_download_pdf_form_submit(&$form, &$form_state) {
    $plugins = browser_details_load();
    foreach ($plugins as $name => $plugin) {
        if (in_array($name, array('export_pdf', 'export_csv')))
            unset($plugins[$name]);
    }

    $content = theme('bd_export_download', array('plugins' => $plugins, 'format' => 'pdf'));

    if (!libraries_load('dompdf'))
        return drupal_set_message('PDF export not configured.', 'error');

    $dompdf = new DOMPDF();
    $dompdf->load_html($content);
    $dompdf->render();
    $dompdf->stream('browser-details.pdf');
}
