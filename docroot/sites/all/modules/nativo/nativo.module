<?php

/**
 * @file
 * Module to add Nativo ad support.
 */

/**
 * Implements hook_menu().
 */
function nativo_menu() {
  $items = array();

  $items['admin/config/search/nativo'] = array(
    'title' => 'Nativo settings',
    'description' => 'Administer settings for Nativo integration.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('nativo_admin_settings'),
    'access arguments' => array('administer nativo settings'),
  );

  $items[_nativo_get_path()] = array(
    'description' => 'Placeholder page for Nativo content.',
    'page callback' => 'nativo_display',
    'access callback' => TRUE,
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function nativo_permission() {
  return array(
    'administer nativo settings' => array(
      'title' => t('Administer Nativo settings'),
    ),
  );
}

/**
 * Callback for settings page.
 */
function nativo_admin_settings() {

  $form['nativo_html'] = array(
    '#type' => 'textarea',
    '#title' => t('HTML for Nativo template'),
    '#description' => t('See <a target="_blank" href="@url">the Nativo Integration Guide</a> for required/optional HTML elements', array('@url' => 'http://www.nativo.net/download/postrelease_js_install.pdf')),
    '#default_value' => variable_get('nativo_html', _nativo_get_default_body()),
    '#rows' => 5,
    '#cols' => 30,
  );

  $form['nativo_incjs'] = array(
    '#type' => 'checkbox',
    '#title' => t('Include Nativo JS'),
    '#description' => t('Include the Natvio javascript file on front-facing pages'),
    '#default_value' => variable_get('nativo_incjs', 0),
  );

  $form['nativo_pattern'] = array(
    '#type' => 'textfield',
    '#size' => 128,
    '#title' => t('Advanced users: Path pattern to NOT load Nativo JS'),
    '#description' => t('Regex pattern to match against current_path() to prevent loading Nativo Javascript. This is run through preg_match().'),
    '#default_value' => _nativo_get_default_pattern(),
  );

  $form['help'] = array(
    '#markup' => t('NOTE: You can place a nativo.css in the theme(s)\'s folder,
      and it will be automatically included on the Nativo template page.'),
    '#prefix' => '<p class="warning">',
    '#suffix' => '</p>',
  );

  return system_settings_form($form);
}

/**
 * Display the Nativo placeholder page.
 */
function nativo_display() {

  // Allow themes to put nativo.css in their folder to automatically be
  // included.
  $styles = path_to_theme() . '/nativo.css';
  if (is_file($styles)) {
    drupal_add_css($styles);
  }

  // Prevent robots from crawling the index page.
  drupal_add_html_head(
    array(
      '#tag' => 'meta',
      '#attributes' => array('name' => 'robots', 'content' => 'noindex, nofollow')
    ),
    'nativo_nofollow'
  );
  drupal_set_title('<!-- @Title -->', PASS_THROUGH);
  // Unfortunately, we cannot run this through filter_xss_admin() because it
  // strips the Nativo tags.
  return variable_get('nativo_html', _nativo_get_default_body());
}

/**
 * Implements hook_preprocess_theme().
 *
 * Because template_preprocess_html() runs the head_title through strip_tags(),
 * we must re-build head_title. We can assume drupal_get_title() returns non-
 * empty result because we set it in the display callback.
 */
function nativo_preprocess_html(&$variables) {
  if  (_nativo_get_path() !== current_path()) {
    return;
  }

  if (drupal_get_title()) {
    $head_title = array(
      'title' => drupal_get_title(),
      'name' => check_plain(variable_get('site_name', 'Drupal')),
    );
    $variables['head_title_array'] = $head_title;
    $variables['head_title'] = implode(' | ', $head_title);
  }
}

/**
 * Implements hook_init().
 *
 * Add Nativo js to every front-end page.
 */
function nativo_init() {
  // Don't load if JS is disabled, or we're on a path matching the exclude
  // regex.
  if (variable_get('nativo_incjs', 0) !== 1
    || preg_match(
      _nativo_get_default_pattern(),
      current_path()
    )) {
    return;
  }

  $script = <<< EOD
(function () {
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = 'http://a.postrelease.com/serve/load.js?async=true';
var x = document.getElementsByTagName('script')[0];
x.parentNode.insertBefore(s, x);
})();
EOD;

  drupal_add_js($script, array('type' => 'inline', 'scope' => 'footer'));
}

/**
 * Return the default value for Nativo ad template body.
 */
function _nativo_get_default_body() {
  $default_nativo_html =<<< EOD
<div id="article">
  <div id="content-header">
    <div class="preview"><!-- @Preview --></div>
    <div class="author"><span>Presented by </span> <!-- @Author --> at <!-- @Datetime --><!-- @AuthorLogo --></div>
  </div>
  <!-- @Content -->
</div>
EOD;

  return $default_nativo_html;
}

/**
 * Return the default exclusion pattern for Nativo JS.
 */
function _nativo_get_default_pattern() {
  return variable_get('nativo_pattern', '#^admin|^node/[0-9]+/(edit|devel)|^node/add#');
}

/**
 * Return the default path for Naitov ad page.
 */
function _nativo_get_path() {
  return variable_get('nativo_path', 'promoted');
}
