<?php
/**
 * @file
 * Add the analytic marker and the ads on your website.
 *
 * @author: Amauri CHAMPEAUX
 */

/**
 * Implements hook_permission().
 */
function ferank_permission() {
  return array(
    'administer ferank' => array(
      'title' => t('Administer FERank'),
      'description' => t('Perform administration tasks for FERank'),
      'restrict access' => TRUE,
    ),
  );
}

/**
 * Implements hook_menu().
 */
function ferank_menu() {
  $items = array();
  $items['admin/config/system/ferank'] = array(
    'title' => 'FERank',
    'description' => 'Configuration of the HTML tag',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ferank_admin_settings'),
    'access arguments' => array('administer ferank'),
    'file' => 'ferank.admin.inc',
  );
  return $items;
}

/**
 * Build the footer.
 */
function ferank_page_build(&$page) {
  global $user;
  if (!path_is_admin(current_path()) && _ferank_track($user)) {
    $script = _ferank_output_js_code();
    $page['page_bottom']['ferank'] = array(
      '#type' => 'markup',
      '#markup' => $script,
    );
  }
}

/**
 * Display the JS tracker if role is allowed.
 */
function _ferank_track($account) {
  $track = TRUE;
  $roles = variable_get('ferank_track_roles', array());
  if (is_array($roles)) {
    foreach (array_keys($account->roles) as $role) {
      if ($roles[$role]) {
        $track = FALSE;
        break;
      }
    }
  }
  return $track;
}

/**
 * Put the Javascript tracker to the footer.
 */
function _ferank_output_js_code() {
  $type_marker = variable_get('ferank_type', 'classique');
  $path = drupal_get_path('module', 'ferank');
  if ($type_marker == 1) {
    drupal_add_js($path . '/ferank.js');
  }
  elseif ($type_marker == 2) {
    drupal_add_js('https://opt-out.ferank.eu/tarteaucitron.js', 'external');
    drupal_add_js($path . '/tarteaucitron.js');
  }
}

/**
 * Implements hook_block_info().
 */
function ferank_block_info() {
  $blocks = array();
  $blocks['ads1'] = array(
    'info' => t('FERank ads 1'),
  );
  $blocks['ads2'] = array(
    'info' => t('FERank ads 2'),
  );
  $blocks['ads3'] = array(
    'info' => t('FERank ads 3'),
  );
  return $blocks;
}

/**
 * Implements hook_block_configure().
 */
function ferank_block_configure($delta = '') {
  $form = array();

  switch ($delta) {
    case 'ads1':
      $form['size'] = array(
        '#weight' => 1,
        '#type' => 'select',
        '#title' => t('Size of the ad block'),
        '#default_value' => variable_get('ferank_size_1', '660x250'),
        '#options' => array(
          '660x250',
          '336x280',
          '300x250',
          '250x250',
          '970x90',
          '728x90',
          '468x60',
          '300x600',
          '160x600',
          '120x600',
        ),
      );

      $form['c_title'] = array(
        '#weight' => 2,
        '#type' => 'textfield',
        '#title' => t('Hex color for the title'),
        '#description' => t('Enter html color like: #0099ff'),
        '#default_value' => variable_get('ferank_color_titre_1', '#0099ff'),
      );

      $form['c_text'] = array(
        '#weight' => 3,
        '#type' => 'textfield',
        '#title' => t('Hex color for the text'),
        '#description' => t('Enter html color like: #333333'),
        '#default_value' => variable_get('ferank_color_text_1', '#333333'),
      );
      break;

    case 'ads2':
      $form['size'] = array(
        '#weight' => 1,
        '#type' => 'select',
        '#title' => t('Size of the ad block'),
        '#default_value' => variable_get('ferank_size_2', '660x250'),
        '#options' => array(
          '660x250',
          '336x280',
          '300x250',
          '250x250',
          '970x90',
          '728x90',
          '468x60',
          '300x600',
          '160x600',
          '120x600',
        ),
      );

      $form['c_title'] = array(
        '#weight' => 2,
        '#type' => 'textfield',
        '#title' => t('Hex color for the title'),
        '#description' => t('Enter html color like: #0099ff'),
        '#default_value' => variable_get('ferank_color_titre_2', '#0099ff'),
      );

      $form['c_text'] = array(
        '#weight' => 3,
        '#type' => 'textfield',
        '#title' => t('Hex color for the text'),
        '#description' => t('Enter html color like: #333333'),
        '#default_value' => variable_get('ferank_color_text_2', '#333333'),
      );
      break;

    case 'ads3':
      $form['size'] = array(
        '#weight' => 1,
        '#type' => 'select',
        '#title' => t('Size of the ad block'),
        '#default_value' => variable_get('ferank_size_3', '660x250'),
        '#options' => array(
          '660x250',
          '336x280',
          '300x250',
          '250x250',
          '970x90',
          '728x90',
          '468x60',
          '300x600',
          '160x600',
          '120x600',
        ),
      );

      $form['c_title'] = array(
        '#weight' => 2,
        '#type' => 'textfield',
        '#title' => t('Hex color for the title'),
        '#description' => t('Enter html color like: #0099ff'),
        '#default_value' => variable_get('ferank_color_titre_3', '#0099ff'),
      );

      $form['c_text'] = array(
        '#weight' => 3,
        '#type' => 'textfield',
        '#title' => t('Hex color for the text'),
        '#description' => t('Enter html color like: #333333'),
        '#default_value' => variable_get('ferank_color_text_3', '#333333'),
      );
      break;
  }
  return $form;
}

/**
 * Implements hook_block_save().
 */
function ferank_block_save($delta = '', $edit = array()) {
  switch ($delta) {
    case 'ads1':
      variable_set('ferank_size_1', $edit['size']);
      variable_set('ferank_color_titre_1', $edit['c_title']);
      variable_set('ferank_color_text_1', $edit['c_text']);
      break;

    case 'ads2':
      variable_set('ferank_size_2', $edit['size']);
      variable_set('ferank_color_titre_2', $edit['c_title']);
      variable_set('ferank_color_text_2', $edit['c_text']);
      break;

    case 'ads3':
      variable_set('ferank_size_3', $edit['size']);
      variable_set('ferank_color_titre_3', $edit['c_title']);
      variable_set('ferank_color_text_3', $edit['c_text']);
      break;
  }
}

/**
 * Implements hook_block_view().
 */
function ferank_block_view($delta = '') {
  $block = array();

  switch ($delta) {
    case 'ads1':
      $block['content'] = ferank_ads('1');
      break;

    case 'ads2':
      $block['content'] = ferank_ads('2');
      break;

    case 'ads3':
      $block['content'] = ferank_ads('3');
      break;
  }

  return $block;
}

/**
 * Inject the ads.
 */
function ferank_ads($n) {
  $id = variable_get('ferank_id', '');
  $l_size = variable_get('ferank_size_' . $n, 0);
  $size = array(
    '660x250',
    '336x280',
    '300x250',
    '250x250',
    '970x90',
    '728x90',
    '468x60',
    '300x600',
    '160x600',
    '120x600',
  );
  $title = preg_replace('@#@', '', variable_get('ferank_color_titre_' . $n, '#0099ff'));
  $text = preg_replace('@#@', '', variable_get('ferank_color_text_' . $n, '#333333'));

  if ($id != '') {
    return '<script type="text/javascript">
    var ferank_client = "' . $id . '",
        ferank_taille = "' . $size[$l_size] . '",
        ferank_couleur_titre = "' . $title . '",
        ferank_couleur_texte = "' . $text . '";
    </script>
    <script type="text/javascript" src="//static.ferank.fr/publicite.js"></script>';
  }
}
