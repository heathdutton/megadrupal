<?php

/**
 * @file
 *
 * This module provide unpublish link for own comments based on permissions.
 *
 * @author: alvar0hurtad0
 * @special Thanks: keopx
 */

/**
 * Implements hook_permission().
 */
function unpublish_own_comment_permission() {
  $perms = array();
  $perms['unpublish own comment'] = array(
    'title' => t('Unpublish Own Comment'),
    'description' => t('Allows the user to unpublish comments they have made.'),
  );
  return $perms;
}

/**
 * Implements hook_menu().
 */
function unpublish_own_comment_menu() {
  $items = array();

  $items['node/%node/unpublish_own_comment/%comment'] = array(
    'title' => 'unpublish_own_comment_title',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('unpublish_own_comment_form', 1, 3),
    'access callback' => 'unpublish_own_comment_access',
    'access arguments' => array(1, 3),
    'file' => 'unpublish_own_comment.pages.inc',
  );

  return $items;
}

/**
 * Implements hook_comment_view().
 */
function unpublish_own_comment_comment_view($comment, $view_mode, $langcode) {
  $links = array();
  $node = node_load($comment->nid);

  if (($comment->status == COMMENT_PUBLISHED) && unpublish_own_comment_access($node, $comment)) {
    $links['unpublish_own_comment'] = array(
      'title' => t('unpublish'),
      'href' => 'node/' . $node->nid . '/unpublish_own_comment/' . $comment->cid,
      'query' => drupal_get_destination(),
    );
  }

  if (count($links)) {
    $comment->content['links']['comment-unpublish_own_comment'] = array(
      '#theme' => 'links',
      '#links' => $links,
      '#attributes' => array('class' => array('links', 'inline')),
    );
  }
}

/**
 * Access callback for unpublish_own_comment forms.
 */
function unpublish_own_comment_access($node, $comment = NULL) {
  $access = FALSE;
  if (isset($node->nid) && isset($comment->cid) && $comment->status == COMMENT_PUBLISHED && node_access('view', $node)) {
    global $user;

    if (user_access('administer comments')) {
      $access = TRUE;
    }

    if ($user->uid == $comment->uid) {
      $access = user_access('unpublish own comment');
    }
  }
  return $access;
}

/**
 * Implements hook_help().
 */
function unpublish_own_comment_help($path, $arg) {
  switch ($path) {
    case 'admin/help#unpublish_own_comment':
      $output = '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The Unpublish own comment module adds a "unpublish" button on comments based on permissions. For more information, see the project page @link.', array('@link' => '<a href="https://www.drupal.org/sandbox/alvar0hurtad0/2303353" title="Unpublish own comment">Unpublish own comment</a>')) . '<p>';
      return $output;
  }
}
