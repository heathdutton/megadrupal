<?php
/**
 * @file
 * Create forms for testing of the Textmarketer module.
 * 
 * This module creates forms used to test the Textmarketer additions
 * to the SMS Frameworks sms_send_form.
 */

/**
 * Implements hook_menu().
 */
function sms_textmarketer_test_menu() {
  $items = array();

  $items['sms_textmarketer_test/sms_send_form'] = array(
    'access callback' => TRUE,
    'page arguments' => array('sms_textmarketer_test_sms_send_form'),
    'page callback' => 'drupal_get_form',
    'title' => 'Test Textmarketer Send Form',
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Textmarketer test send form.
 */
function sms_textmarketer_test_sms_send_form($form, &$form_state) {
  $form['message'] = array(
    '#required' => TRUE,
    '#title' => t('Message'),
    '#type' => 'textarea',
  );
  $form += sms_send_form(TRUE);

  $form['actions'] = array(
    '#type' => 'actions',
  );
  $form['actions']['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Send'),
  );

  return $form;
}

/**
 * Textmarketer test send form validate.
 */
function sms_textmarketer_test_sms_send_form_validate($form, &$form_state) {
  // The SMS Framework doesn't add their validation function to the form by
  // default, so we have to manually call it here.
  sms_send_form_validate($form, $form_state);
}

/**
 * Textmarketer test send form validate.
 */
function sms_textmarketer_test_sms_send_form_submit($form, &$form_state) {
  // The SMS Framework doesn't add their submit function to the form by
  // default, so we have to manually call it here.
  // On closer inspection the SMS Framework submit function produces no useful
  // output for determining the success of the send attempt, so it wont be used
  // here.
  // @see sms_send_form_submit()
  $values = $form_state['values'];
  $values['number'] = sms_formatter($values['number']);

  // Attempt to send message.
  try {
    $result = sms_send($values['number'], $values['message'], $values['gateway']);

    if ($result) {
      drupal_set_message(t('Message sent.'));
    }
    else {
      drupal_set_message(t('Failed to send message.'));
    }
  }
  catch (Exception $e) {
    drupal_set_message(t('Something went wrong whilst attempting to send your message.'), 'error');
    watchdog('sms_textmarketer_test', 'An error occurred whilst attempting to send an SMS: !error', array('!error' => print_r($e, TRUE)), WATCHDOG_ERROR);
  }
}

/**
 * Implements hook_sms_incoming().
 */
function sms_textmarketer_test_sms_incoming($process, $number, $message, $options) {
  if ($process != 'process') {
    return;
  }

  drupal_set_message('test-number: ' . $number);
  drupal_set_message('test-message: ' . $message);
}
