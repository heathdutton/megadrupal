<?php

/**
 * @file
 * Installation file for the Widget to search from ofru.ru.
 */

/**
 * Implements hook_permission().
 */
function widget_to_search_from_ofruru_permission() {
  return array(
    'Widget to search from ofru.ru' => array(
      'title' => t('Widget to search from ofru.ru'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function widget_to_search_from_ofruru_menu() {
  $items['admin/config/search/widget_to_search_from_ofruru'] = array(
    'access arguments' => array('administer site configuration'),
    'title' => 'Widget to search from ofru.ru',
    'description' => 'Settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('widget_to_search_from_ofruru_admin'),
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}


/**
 * Admin settings page for the widget to search from ofru.ru.
 */
function widget_to_search_from_ofruru_admin() {
  $form = array();

  $form['widget_to_search_from_ofruru_lang'] = array(
    '#type' => 'radios',
    '#title' => t('Language site'),
    '#options' => array(
      'en' => t('English'),
      'ru' => t('Russian'),
      'ua' => t('Ukrainian'),
    ),
    '#default_value' => variable_get('widget_to_search_from_ofruru_lang', 'en'),
  );

  $form['widget_to_search_from_ofruru_width'] = array(
    '#type' => 'textfield',
    '#title' => t('Box Width'),
    '#default_value' => variable_get('widget_to_search_from_ofruru_Width', '20'),
    '#size' => 2,
    '#maxlength' => 2,
  );

  $form['widget_to_search_from_ofruru_helplink'] = array(
    '#type' => 'checkbox',
    '#title' => t('Help promote module: "widget to search from ofru.ru"?'),
    '#default_value' => variable_get('widget_to_search_from_ofruru_helplink', 1),
  );

  return system_settings_form($form);
}

/**
 * Implements hook_forms().
 */
function widget_to_search_from_ofruru_forms() {
  $forms = array();
  $forms['widget_to_search_from_ofruru_form'] = array(
    'callback' => 'widget_to_search_from_ofruru_html',
    'callback arguments' => array('widget'),
  );
  return $forms;
}


/**
 * Form builder for the Search this site from ofru.ru.
 */
function widget_to_search_from_ofruru_html($form, $form_state, $form_id = 0) {
  $form = array();
  global $base_url;

  $form['#action'] = 'http://is-all.ru/';
  $form['#method'] = 'get';
  $form['#attributes']['target'] = '_blank';
  $form['h'] = array(
    '#type' => 'hidden',
    '#value' => $base_url . '/',
  );
  $form['q'] = array(
    '#type' => 'textfield',
    '#default_value' => '',
    '#size' => variable_get('widget_to_search_from_ofruru_Width', '20'),
  );
  $form['l'] = array(
    '#type' => 'hidden',
    '#value' => variable_get('widget_to_search_from_ofruru_lang', 'en'),
  );
  $form['sa'] = array(
    '#type' => 'submit',
    '#value' => t('Search'),
  );

  return $form;
}

/**
 * Implements hook_block_info().
 */
function widget_to_search_from_ofruru_block_info() {
  $block['widget_to_search_from_ofruru']['info'] = t('Search this site from ofru.ru');
  return $block;
}

/**
 * Implements hook_block_view().
 */
function widget_to_search_from_ofruru_block_view($delta = '') {
  if (user_access('Widget to search from ofru.ru')) {
    switch ($delta) {
      case 'widget_to_search_from_ofruru':
        $block['subject'] = t('Search this site from ofru.ru');

        $block['content'] = drupal_render(drupal_get_form('widget_to_search_from_ofruru_form'));
        if (variable_get('widget_to_search_from_ofruru_helplink', 1)) {
          $block['content'] .= '<br />' . t('This widget can be <a target="_blank" href="http://ofru.ru/widgets/?l=en">downloaded here</a>');
        }
        return $block;
    }
  }

}
