<?php

/**
 * Implements hook_filesondemand().
 */
function filesondemand_example_filesondemand() {
  return array(
    'example' => array(
      'generate callback'      => '_filesondemand_example_generate',
      'validate path callback' => '_filesondemand_example_validate',

      // Doesn't expire until the cache is cleared. You could also set
      // this to a number of seconds.
      'expires after' => FALSE,
    ),
  );
}

/**
 * Implements hook_flush_caches().
 */
function filesondemand_example_flush_caches() {
  filesondemand_clear_cache('example');
  return array();
}

function _filesondemand_example_validate($path, $dest, $scheme) {
  // We only allow .txt files!
  return strrpos($path, '.txt', 0) === strlen($path) - 4;
}

function _filesondemand_example_generate($path, $dest) {
  $now = format_date(time());

  if ($fd = fopen($dest, 'wt')) {
    fwrite($fd, "I've always said that $path was the best file ever!");
    fwrite($fd, " ");
    fwrite($fd, "The first time I said so was $now.");
    fclose($fd);
    return TRUE;
  }

  return FALSE;
}

/**
 * Implements hook_file_download().
 *
 * You must implement this to allow access to your files via the private
 * file system, otherwise you'll get access denied.
 */
function filesondemand_example_file_download($uri) {
  // If this is in our directory...
  if (strpos(file_uri_target($uri), 'example') === 0) {
    // ... allow any user with the 'access content' permission.
    if (user_access('access content')) {
      return array('Content-Type' => 'text/plain');
    }
  }
}

