<?php
/**
 * @file
 * Implements Flo2Cash web payment integration for use with Drupal Commerce.
 */

/**
 * Transaction types.
 */
define('FLO2CASH_STATUS_UNKNOWN', 0);
define('FLO2CASH_STATUS_SUCCESS', 2);
define('FLO2CASH_STATUS_FAILED', 3);
define('FLO2CASH_STATUS_BLOCKED', 4);
define('FLO2CASH_STATUS_DECLINED', 11);

/**
 * Implements hook_menu().
 */
function commerce_flo2cash_menu() {
  $items['checkout/%commerce_order/flo2cash/mnscheck/%'] = array(
    'title' => 'Flo2Cash MNS Check',
    'page callback' => 'commerce_flo2cash_mns_check',
    'page arguments' => array(1, 4),
    'access callback' => 'user_access',
    // Path must be publicly accessible.
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    'file' => 'includes/commerce_flo2cash.pages.inc',
  );
  $items['checkout/%commerce_order/flo2cash/return/%'] = array(
    'title' => 'Flo2Cash Response',
    'page callback' => 'commerce_flo2cash_return_url',
    'page arguments' => array(1, 4),
    'access callback' => 'user_access',
    // Path must be publicly accessible.
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    'file' => 'includes/commerce_flo2cash.pages.inc',
  );
  $items['checkout/%commerce_order/flo2cash/verify/%/%'] = array(
    'title' => 'Flo2Cash Verifying Payment',
    'page callback' => 'commerce_flo2cash_verify_payment',
    'page arguments' => array(1, 4, 5),
    'access callback' => 'user_access',
    // Path must be publicly accessible.
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
    'file' => 'includes/commerce_flo2cash.pages.inc',
  );

  return $items;
}

/**
 * Implements hook_commerce_payment_method_info().
 */
function commerce_flo2cash_commerce_payment_method_info() {
  $payment_methods['commerce_flo2cash'] = array(
    'title' => t('Flo2Cash Web Payment'),
    'short_title' => t('Flo2Cash'),
    'display_title' => t('Credit card via Flo2Cash'),
    'description' => t('Integration with Flo2Cash web payment system.'),
    'terminal' => FALSE,
    'active' => TRUE,
    'offsite' => TRUE,
    'offsite_autoredirect' => TRUE,
    'callbacks' => array(
      'settings_form' => 'commerce_flo2cash_settings_form',
      'redirect_form' => 'commerce_flo2cash_redirect_form',
    ),
    'file' => 'includes/commerce_flo2cash.forms.inc',
  );

  return $payment_methods;
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Add the Flo2Cash logo to the payment option radio.
 */
function commerce_flo2cash_form_commerce_checkout_form_alter(&$form, &$form_state) {
  // If this checkout form contains the payment method radios...
  $payment_method = &$form['commerce_payment']['payment_method'];
  if (!empty($payment_method['#options'])) {
    // Loop over the options array looking for a Flo2Cash option.
    foreach ($payment_method['#options'] as $key => &$value) {
      list($method_id, $rule_name) = explode('|', $key);

      if ($method_id == 'commerce_flo2cash') {
        // Prepare the replacement radio button text with an icon.
        $path = drupal_get_path('module', 'commerce_flo2cash');
        $icon = theme('image',array(
          'path' => $path . '/images/powered-by-flo2cash.gif',
          'attributes' => array('class' => 'flo2cash-icon'),
        ));

        // Add a wrapper to the value and append the icon.
        $value = '<span class="flo2cash-label">' . $value . '</span>' . $icon;

        // Add the CSS.
        $payment_method['#attached']['css'][] = $path . '/css/commerce_flo2cash.css';
        break;
      }
    }
  }
}

/**
 * Helper function for converting status numbers to names.
 */
function commerce_flo2cash_status_name($status_number) {
  switch ($status_number) {
    case 0:
      return 'Unknown';
    case 2:
      return 'Successful';
    case 3:
      return 'Failed';
    case 4:
      return 'Blocked';
    case 11:
      return 'Declined';
  }
}

/**
 * Helper function for converting card types to names.
 */
function commerce_flo2cash_card_type_name($card_type) {
  switch ($status_number) {
    case 1:
      return 'American Express';
    case 3:
      return 'Diners Club';
    case 4:
      return 'MasterCard';
    case 5:
      return 'Visa Card';
  }
}
