<?php
/**
 * @file
 * Code for the nm_members feature.
 */

include_once 'nm_members.features.inc';

/**
 * Custom Process variables for user-profile.tpl.php.
 *
 * The $variables array contains the following arguments:
 * - $account
 *
 * @see user-profile.tpl.php
 */
function nm_members_preprocess_user_profile(&$variables) {

  //custom hiding of 'History' 
  if (isset($variables['user_profile']['summary'])) {
    unset($variables['user_profile']['summary']);
    unset($variables['elements']['summary']);
  }
  //custom hiding of 'Member Profile' from profile2 since we are using Views to display content
  if (isset($variables['user_profile']['profile_nm_member_profile'])) {
    unset($variables['user_profile']['profile_nm_member_profile']);
    unset($variables['elements']['profile_nm_member_profile']);
  }
  //custom hiding of 'user picture' from core since we are using Views to display profile2 content
  if (isset($variables['user_profile']['user_picture'])) {
    unset($variables['user_profile']['user_picture']);
    unset($variables['elements']['user_picture']);
  }

  //below copied from user.pages.inc

  $account = $variables['elements']['#account'];

  // Helpful $user_profile variable for templates.
  foreach (element_children($variables['elements']) as $key) {
    $variables['user_profile'][$key] = $variables['elements'][$key];
  }

  // Preprocess fields.
  field_attach_preprocess('user', $account, $variables['elements'], $variables);
}


/**
 * Implements hook_block_view_alter.
 */
function nm_members_block_view_alter(&$data, $block) {
  //for the nm_members View blocks
  switch ($block->delta) {

    case 'nm_member_profile-block' :
    case 'nm_member_profile-block_1' :
    case 'nm_member_profile-block_2' :
    case 'nm_member_profile-block_3' :
    case 'nm_member_profile-block_4' :
    case 'nm_member_profile-block_5' :

      //make sure there is data first
      if (!empty($data)) {

        //get the Views data
        $viewname = $data['content']['#views_contextual_links_info']['views_ui']['view_name'];
        $display = $data['content']['#views_contextual_links_info']['views_ui']['view_display_id'];
        $view = views_get_view($viewname);
        $view->set_display($display);
        $view->set_arguments(array(arg(1)));
        $view->preview();
  
        //figure out if there are results in the block
        $not_empty = FALSE;
        foreach ($view->result[0] as $k => $v) {
          if (preg_match('%field_field_%', $k)) {
            if (!empty($v)) {
              $not_empty = TRUE;
            }
          }
        }
       
        //hide Views blocks if no content
        if ($not_empty == FALSE) {
          unset($data['content']);
          unset($data['subject']);
        }

      }

      break;
  }

}
