<?php

/**
 * @file
 * The contest module file.
 */

/**
 * Display the administration information about a contest.
 *
 * @param $nid (int) The node ID.
 *
 * @return (string) Fully themed contest admin page.
 */
function contest_admin_page($node = NULL) {
  drupal_add_css(drupal_get_path('module', 'contest') . '/css/contest.css');
  return theme('contest_admin_page', _contest_get_admin_page_data($node));
}
/**
 * Implementation of hook_block_info().
 */
function contest_block_info() {
  return array(
    'contest_list' => array(
      'info'       => t('Contest List'),
    ),
  );
}
/**
 * Implementation of hook_block_view().
 */
function contest_block_view($delta = '') {
  switch ($delta) {
    case 'contest_list':
      return array(
        'content' => theme('contest_list_block', _contest_get_list_data('block')),
      );
  }
  return array();
}
/**
 * Clear an individual winner of a contest.
 *
 * @param $nid (int) The node ID.
 * @param uid (int) The user's ID.
 */
function contest_clear_winners($nid, $uid = NULL) {
  $published = db_query_range("SELECT publish_winners FROM {contest} WHERE nid = :nid", 0, 1, array(':nid' => $nid))->fetchField();

  if ($published) {
    drupal_set_message('You must unpublish contest winners before clearing a winner.', 'warning');
  }
  elseif ($uid) {
    db_update('contest_entry')
      ->fields(array('winner' => 0))
      ->condition('nid', $nid)
      ->condition('uid', $uid)
      ->execute();
  }
  else {
    db_update('contest_entry')
      ->fields(array('winner' => 0))
      ->condition('nid', $nid)
      ->execute();
  }
  drupal_goto("node/$nid/contest-admin");
}
/**
 * Implimentation of hook_cron().
 * Rebuild the custom taxonomy paths.
 */
function contest_cron() {
  _contest_purge_exports();
}
/**
 * Implements hook_date_format_types().
 */
function contest_date_format_types() {
  return array(
    'contest_date'  => t('Month Day Year'),
  );
}
/**
 * Implementation of hook_date_formats().
 * We want a simple date only format.
 */
function contest_date_formats() {
  $formats = array(
    0 => array(
      'type'    => 'contest_date',
      'format'  => 'F j Y',
      'locales' => array(),
    ),
  );
  foreach ($formats as $format) {
    variable_set("date_format_{$format['type']}", $format['format']);
  }
  return $formats;
}
/**
 * Implementation of hook_entity_info_alter().
 */
function contest_entity_info_alter(&$entity_info) {
  $entity_info['node']['view modes']['block'] = array(
    'label'           => t('Block'),
    'custom settings' => TRUE,
  );
}
/**
 * Contest entry form.
 *
 * @return $form (array) A Drupal form array.
 */
function contest_entry_form() {
  global $user;
  $states = _contest_get_states(variable_get('site_default_country', ''));

// Add the JavaScript and CSS.

  drupal_add_css(drupal_get_path('module', 'contest') . '/css/contest.css');
  drupal_add_js(drupal_get_path('module', 'contest') . '/js/contest.js');

// Load the full user object.

  $usr = user_load($user->uid);

  $birthday = _contest_get_usr_val($usr, 'field_contest_birthdate', 0, REQUEST_TIME);

// Build the form.

  $form = array(
    '#id'       => 'contest-entry-form',
    '#submit'   => array('contest_entry_form_submit'),
    '#validate' => array('contest_entry_form_validate'),
  );
  $form['uid'] = array(
    '#type'   => 'hidden',
    '#value'  =>  $usr->uid,
    '#weight' => -10,
  );
  $form['nid'] = array(
    '#type'   => 'hidden',
    '#value'  =>  intval(arg(1)),
    '#weight' => -10,
  );
  $form['heading2'] = array(
    '#type'   => 'markup',
    '#markup' => $usr->uid? '': '<p><b>' . t('Please fill in and submit the form below, (all fields are required).') . '</b><br />' . t('If you already have an account click !link to log in and skip filling in the form.', array('!link' => l('here', 'user/login'))) . '</p>',
    '#weight' => -1,
  );
  $form['fieldset'] = array(
    '#type'        => 'fieldset',
    '#title'       => t('Contestant Profile'),
    '#attributes'  => $usr->uid? array('class' => array('collapsible', 'collapsed')): array('class' => array('collapsible')),
    '#collapsible' => TRUE,
    '#collapsed'   => $usr->uid? TRUE: FALSE,
  );
  $form['fieldset']['contest_name'] = array(
    '#title'         => t('Name'),
    '#type'          => 'textfield',
    '#attributes'    => array('pattern' => '^\s*[\s\w\-\.]+\s*$'),
    '#default_value' => _contest_get_usr_val($usr, 'field_contest_name'),
    '#size'          => 30,
    '#maxlength'     => 100,
    '#required'      => TRUE,
    '#weight'        => 0,
  );
  $form['fieldset']['contest_address'] = array(
    '#title'         => t('Address'),
    '#type'          => 'textfield',
    '#attributes'    => array('pattern' => '^\s*[\s\w\-\.\,#]+\s*$'),
    '#default_value' => _contest_get_usr_val($usr, 'field_contest_address'),
    '#size'          => 30,
    '#maxlength'     => 100,
    '#required'      => TRUE,
    '#weight'        => 1,
  );
  $form['fieldset']['contest_city'] = array(
    '#title'         => t('City'),
    '#type'          => 'textfield',
    '#attributes'    => array('pattern' => '^\s*[\s\w\-\.]+\s*$'),
    '#default_value' => _contest_get_usr_val($usr, 'field_contest_city'),
    '#size'          => 30,
    '#maxlength'     => 50,
    '#required'      => TRUE,
    '#weight'        => 2,
  );
  if (!empty($states)) {
    $form['fieldset']['contest_state'] = array(
      '#title'         => t('State'),
      '#type'          => 'select',
      '#attributes'    => array('pattern' => '^.+$'),
      '#options'       => array_merge(array('' => t(' -Select- ')), $states),
      '#default_value' => _contest_get_usr_val($usr, 'field_contest_state'),
      '#required'      => TRUE,
      '#weight'        => 3,
    );
  }
  else {
    $form['fieldset']['contest_state'] = array(
      '#title'         => t('Province'),
      '#type'          => 'textfield',
      '#attributes'    => array('pattern' => '^.+$'),
      '#default_value' => _contest_get_usr_val($usr, 'field_contest_state'),
      '#size'          => 30,
      '#maxlength'     => 50,
      '#required'      => FALSE,
      '#weight'        => 3,
    );
  }
  $form['fieldset']['contest_zip'] = array(
    '#title'         => t('Zip'),
    '#type'          => 'textfield',
    '#attributes'    => array('pattern' => '^\s*\d+\s*$'),
    '#default_value' => _contest_get_usr_val($usr, 'field_contest_zip'),
    '#size'          => 30,
    '#maxlength'     => 5,
    '#required'      => TRUE,
    '#weight'        => 4,
  );
  $form['fieldset']['mail'] = array(
    '#title'         => t('Email'),
    '#type'          => 'textfield',
    '#attributes'    => array('pattern' => '^\s*[\w\-\.]+@[\w\-\.]+\.\w+\s*$'),
    '#default_value' => !empty($usr->mail)? check_plain($usr->mail): '',
    '#size'          => 30,
    '#maxlength'     => 100,
    '#required'      => TRUE,
    '#weight'        => 5,
  );
  $form['fieldset']['contest_phone'] = array(
    '#title'         => t('Phone'),
    '#type'          => 'textfield',
    '#default_value' => _contest_get_usr_val($usr, 'field_contest_phone'),
    '#size'          => 30,
    '#maxlength'     => 20,
    '#required'      => FALSE,
    '#weight'        => 6,
  );
  $form['fieldset']['contest_birthdate'] = array(
    '#title'         => t('Birthday'),
    '#type'          => 'date',
    '#default_value' => array(
      'month' => format_date($birthday, 'custom', 'n'),
      'day'   => format_date($birthday, 'custom', 'j'),
      'year'  => format_date($birthday, 'custom', 'Y'),
    ),
    '#required'      => TRUE,
    '#weight'        => 7,
  );
  $form['contest_optin'] = array(
    '#title'         => t('Opt In'),
    '#type'          => 'checkbox',
    '#description'   => t("I'd like to receive information about contests and special offers from the sponsor and promoter."),
    '#attributes'    => array('pattern' => '^\d$'),
    '#prefix'        => '<div id="contest-optin">',
    '#suffix'        => '</div>',
    '#default_value' => 1,
    '#required'      => FALSE,
    '#weight'        => 8,
  );
  $form['clear_both'] = array(
    '#prefix' => '<div class="clr">',
    '#suffix' => '</div>',
    '#type'   => 'markup',
    '#value'  => '&nbsp;',
    '#weight' => 9,
  );
  $form['submit'] = array(
    '#type'   => 'submit',
    '#value'  => t('Enter Contest'),
    '#weight' => 10,
  );
  return $form;
}
/**
 * Custom validation function for the contest setting form.
 */
function contest_entry_form_submit($form, &$form_state) {
  global $user;
  $periods = variable_get('contest_period', array(86400 => 'Daily'));

// Users must have all their personal information filled out to enter a contest.

  $form_state['values']['uid'] = _contest_contestant($form_state);

  $usr = user_load($form_state['values']['uid']);

// If they're not logged in, are already a user and have an incomplete profile give them the explanation and redirect them to the login page.

  if ($user->uid != $usr->uid && (empty($usr->field_contest_name) || empty($usr->field_contest_address) || empty($usr->field_contest_city) || empty($usr->field_contest_state) || empty($usr->field_contest_zip))) {
    drupal_set_message('You already have an account with an incomplete profile. The easiest way to enter the contest is to log in and come back and enter the contest.', 'warning');
    drupal_set_message('Once your profile is complete you won\'t have to do this again.');
    drupal_set_message('If you have problems logging in click the "Request new password" link and a login link will be sent to your email.');
    return 'user';
  }
// I don't think this should ever get used, but...

  elseif (empty($usr->field_contest_name) || empty($usr->field_contest_address) || empty($usr->field_contest_city) || empty($usr->field_contest_state) || empty($usr->field_contest_zip)) {
    drupal_set_message('You must have a complete profile to enter a contest.', 'warning');
    return "user/$usr->uid/edit/Contest";
  }
// We'll check to see if the contest is running by getting the entry period.

  $values = array(
    ':end'   => REQUEST_TIME,
    ':nid'   => $form_state['values']['nid'],
    ':start' => REQUEST_TIME,
  );
  $period = db_query_range("SELECT period FROM {contest} WHERE nid = :nid AND start < :start AND :end < end", 0, 1, $values)->fetchField();

  if (!$period) {
    drupal_set_message('This contest is closed.', 'warning');
    return 'contest';
  }
// Check to see if they've entered today.

  $entered = _contest_get_entered($form_state['values']['uid'], $form_state['values']['nid'], $period);

  if ($entered) {
    drupal_set_message("You can enter the contest {$periods[$period]}. We already have an entry for you during this period.", 'warning');
    return "node/{$form_state['values']['nid']}";
  }
// Enter them into the contest.

  $fields = array(
    'nid'     => $form_state['values']['nid'],
    'uid'     => $usr->uid,
    'created' => REQUEST_TIME,
    'ip'      => ip_address(),
  );
  db_insert('contest_entry')->fields($fields)->execute();

  drupal_set_message('You have been entered into the contest.');
}
/**
 * Custom submit function for the contest entry form.
 * Check for the opt in.
 */
function contest_entry_form_validate($form, &$form_state) {
  if (!_contest_min_age($form_state['values']['contest_birthdate'])) {
    form_set_error('contest_birthdate', t("You must be at least @age years old to enter.", array('@age' => variable_get('contest_min_age', 18))));
  }
  if ($form_state['values']['contest_optin'] != 1) {
    form_set_error('contest_optin', t("You must agree to be contacted by the contest's sponsors and host to enter."));
  }
}
/**
 * Export a complete list of contest entries.
 *
 * @param $node (object) The contest node.
 */
function contest_export_entries($node) {
  $csv = '"email","name","address","city","state","zip","phone"' . "\n";
  $export_dir = variable_get('contest_export_dir', 'contest_export');
  $file_dir = file_stream_wrapper_get_instance_by_uri('private://')->getDirectoryPath();
  $file_name = "contest_entries_{$node->nid}_" . REQUEST_TIME . '.csv';

// Get a list of all the contest entries.

  $rows = db_query("SELECT uid FROM {contest_entry} WHERE nid = :nid", array(':nid' => $node->nid))->fetchAll();

  foreach ($rows as $row) {
    $usr = user_load($row->uid);
    if ($usr->uid) {
      $csv .= _contest_to_csv($usr);
    }
  }
// Print the export to a file and output it to the user.

  $fh = fopen("$file_dir/$export_dir/$file_name", 'w+');
  fwrite($fh, $csv);
  fclose($fh);

  header('Content-Type: application/csv');
  header("Content-Disposition: attachment; filename=$file_name");
  header('Pragma: no-cache');
  readfile("$file_dir/$export_dir/$file_name");
  exit();
}
/**
 * Export a list of unique entrants.
 *
 * @param $node (object) The contest node.
 */
function contest_export_unique($node) {
  $csv = '"email","name","address","city","state","zip","phone"' . "\n";
  $export_dir = variable_get('contest_export_dir', 'contest_export');
  $file_dir = file_stream_wrapper_get_instance_by_uri('private://')->getDirectoryPath();
  $file_name = "contest_unique_{$node->nid}_" . REQUEST_TIME . '.csv';

// Get a list of unique contest users.

  $rows = db_query("SELECT uid FROM {contest_entry} WHERE nid = :nid GROUP BY uid", array(':nid' => $node->nid))->fetchAll();

  foreach ($rows as $row) {
    $usr = user_load($row->uid);
    if ($usr->uid) {
      $csv .= _contest_to_csv($usr);
    }
  }
// Print the export to a file and redirect the user to it.

  $fh = fopen("$file_dir/$export_dir/$file_name", 'w+');
  fwrite($fh, $csv);
  fclose($fh);

  header('Content-Type: application/csv');
  header("Content-Disposition: attachment; filename=$file_name");
  header('Pragma: no-cache');
  readfile("$file_dir/$export_dir/$file_name");
  exit();
}
/**
 * Implements hook_field_extra_fields().
 */
function contest_field_extra_fields() {
  $extra['node']['contest'] = array(
    'display' => array(
      'contest_entry_form' => array(
        'label'       => t('Contest Entry Form'),
        'description' => t('Allows a user to enter a contest.'),
        'weight'      => 1,
        'display' => array(
          'default' => array(
            'weight'  => 1,
            'visible' => TRUE,
          ),
          'full' => array(
            'weight'  => 1,
            'visible' => TRUE,
          ),
          'teaser' => array(
            'weight'  => 1,
            'visible' => FALSE,
          ),
          'block' => array(
            'weight'  => 1,
            'visible' => FALSE,
          ),
          'rss' => array(
            'weight'  => 1,
            'visible' => FALSE,
          ),
        ),
      ),
      'contest_results' => array(
        'label'       => t('Contest Results'),
        'description' => t('Displays the contest results.'),
        'weight'      => 2,
        'display' => array(
          'default' => array(
            'weight'  => 2,
            'visible' => TRUE,
          ),
          'full' => array(
            'weight'  => 2,
            'visible' => TRUE,
          ),
          'teaser' => array(
            'weight'  => 2,
            'visible' => FALSE,
          ),
          'block' => array(
            'weight'  => 2,
            'visible' => FALSE,
          ),
          'rss' => array(
            'weight'  => 2,
            'visible' => FALSE,
          ),
        ),
      ),
      'contest_tnc' => array(
        'label'       => t('Contest T&C'),
        'description' => t("The contest's terms and conditions."),
        'weight'      => 3,
        'display' => array(
          'default' => array(
            'weight'  => 3,
            'visible' => TRUE,
          ),
          'full' => array(
            'weight'  => 3,
            'visible' => TRUE,
          ),
          'teaser' => array(
            'weight'  => 3,
            'visible' => FALSE,
          ),
          'block' => array(
            'weight'  => 3,
            'visible' => FALSE,
          ),
          'rss' => array(
            'weight'  => 3,
            'visible' => FALSE,
          ),
        ),
      ),
    ),
  );
  return $extra;
}
/**
 * Implimentation of hook_flush_caches().
 */
function contest_flush_caches() {
  db_query("DELETE FROM {cache} WHERE cid LIKE 'contest-%'");
  return array();
}
/**
 * Implementation of hook_form().
 */
function contest_form($node, $form_state) {
  $end = !empty($node->contest->end)? $node->contest->end: REQUEST_TIME;
  $start = !empty($node->contest->start)? $node->contest->start: REQUEST_TIME;
  $type = node_type_get_type($node);

  $form['#submit'][] = 'contest_form_submit';
  $form['#validate'][] = 'contest_form_validate';

  $form['title'] = array(
    '#title'         => check_plain($type->title_label),
    '#type'          => 'textfield',
    '#default_value' => !empty($node->title)? check_plain($node->title): '',
    '#required'      => TRUE,
    '#weight'        => 0,
  );
  $form['sponsor'] = array(
    '#title'         => t('Contest Sponsor'),
    '#type'          => 'textfield',
    '#default_value' => !empty($node->contest->sponsor)? check_plain($node->contest->sponsor): '',
    '#required'      => FALSE,
    '#weight'        => 20,
  );
  $form['sponsor_email'] = array(
    '#title'         => t('Sponsor Email'),
    '#type'          => 'textfield',
    '#default_value' => !empty($node->contest->sponsor_email)? check_plain($node->contest->sponsor_email): '',
    '#required'      => FALSE,
    '#weight'        => 30,
  );
  $form['sponsor_url'] = array(
    '#title'         => t('Sponsor Url'),
    '#description'   => t('A URL including protocol, (http, https).'),
    '#type'          => 'textfield',
    '#default_value' => !empty($node->contest->sponsor_url)? check_plain($node->contest->sponsor_url): '',
    '#required'      => FALSE,
    '#weight'        => 40,
  );
  $form['places'] = array(
    '#title'         => t('Winning Places'),
    '#type'          => 'select',
    '#options'       => drupal_map_assoc(range(1, 10)),
    '#default_value' => !empty($node->contest->places)? $node->contest->places: 1,
    '#required'      => TRUE,
    '#weight'        => 50,
  );
  $form['period'] = array(
    '#title'         => t('User Can Enter'),
    '#type'          => 'select',
    '#options'       => variable_get('contest_period', array(86400 => 'Daily')),
    '#default_value' => !empty($node->contest->period)? $node->contest->period: 86400,
    '#required'      => TRUE,
    '#weight'        => 60,
  );
  $form['start'] = array(
    '#title'         => t('Start Contest'),
    '#type'          => 'date',
    '#default_value' => array(
      'month' => format_date($start, 'custom', 'n'),
      'day'   => format_date($start, 'custom', 'j'),
      'year'  => format_date($start, 'custom', 'Y'),
    ),
    '#required'      => TRUE,
    '#weight'        => 70,
  );
  $form['end'] = array(
    '#title'         => t('End Contest'),
    '#type'          => 'date',
    '#default_value' => array(
      'month' => format_date($end, 'custom', 'n'),
      'day'   => format_date($end, 'custom', 'j'),
      'year'  => format_date($end, 'custom', 'Y'),
    ),
    '#required'      => TRUE,
    '#weight'        => 80,
  );
  return $form;
}
/**
 * Implimentation of hook_form_FORM_ID_alter().
 * Remove the block module's instance of our content blocks, (content editable via the contest config form).
 */
function contest_form_block_admin_display_form_alter(&$form, &$form_state, $form_id) {
  unset($form['blocks']['block_' . variable_get('contest_block_tnc', 0)]);
}
/**
 * Implementation of hook_form_FORM_ID_alter().
 */
function contest_form_field_ui_display_overview_form_alter(&$form, &$form_state) {
  if ($form['#view_mode'] == 'block' || $form['#view_mode'] == 'teaser') {
    unset($form['fields']['contest_entry_form']);
    unset($form['fields']['contest_results']);
    unset($form['fields']['contest_tnc']);
  }
}
/**
 * Custom submit function.
 */
function contest_form_submit($form, &$form_state) {
  $node = $form_state['node'];
  $fields = array(
    'period',
    'places',
    'sponsor',
    'sponsor_email',
    'sponsor_url',
  );
  if (empty($node->contest) || !is_object($node->contest)) {
    $node->contest = new stdClass();
  }
  $node->contest->start = _contest_mktime($form_state['values']['start']);
  unset($form_state['values']['start']);

  $node->contest->end = _contest_mktime($form_state['values']['end']);
  unset($form_state['values']['end']);

  foreach ($fields as $field) {
    if (!empty($form_state['values'][$field])) {
      $node->contest->{$field} = $form_state['values'][$field];
      unset($form_state['values'][$field]);
    }
  }
}
/**
 * Implementation of hook_form_alter().
 */
function contest_form_user_profile_form_alter(&$form, &$form_state) {
  $states = _contest_get_states(variable_get('site_default_country', ''));

  if (!empty($states)) {
    $form['field_contest_state'][LANGUAGE_NONE][0]['value']['#type'] = 'select';
    $form['field_contest_state'][LANGUAGE_NONE][0]['value']['#options'] = array_merge(array('' => t(' -Select- ')), $states);
    $form['field_contest_state'][LANGUAGE_NONE][0]['value']['#size'] = 1;
  }
  else {
    $form['field_contest_state'][LANGUAGE_NONE][0]['value']['#access'] = FALSE;
    $form['field_contest_state'][LANGUAGE_NONE][0]['value']['#required'] = FALSE;
  }
}
/**
 * Custom validation function.
 */
function contest_form_validate($form, &$form_state) {
  $day = 86400;
  $end = _contest_mktime($form_state['values']['end']);
  $start = _contest_mktime($form_state['values']['start']);

// If the end date is before the start date set an error.

  if ($end < $start) {
    form_set_error('end', 'Contest cannot end before it starts.');
  }
// If the end date is the same as the start date set an error.

  if (($end - $start) < $day) {
    form_set_error('start', 'Contest must run for at least one day.');
  }
}
/**
 * Implements hook_help().
 */
function contest_help($path, $arg) {
  $output = '';

  switch ($path) {
    case 'admin/help#contest':
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The contest module allows your site to host random games of chance, &ldquo;Sweepstakes&rdquo;. Where users can enter to win prizes via a random drawing.') . '</p>';
      $output .= '<p>' . t('Anonymous users can fill-in their personal information and a user will be created for them.') . '</p>';
      $output .= '<p>' . t('Logged in users with complete profiles can just click the &ldquo;Enter Contest&rdquo; button.') . '</p>';
      $output .= '<p>' . t("Winners can be selected via a contest's admin page or the entries exported and printed for a public drawing.") . '</p>';
      $output .= '<p>' . t('The same export can be provided to sponsors or affiliates for marketing purposes.') . '</p>';
      return $output;
  }
}
/**
 * Implementation of hook_insert().
 */
function contest_insert($node) {
  $sponsor_uid = _contest_add_usr($node->contest->sponsor, $node->contest->sponsor_email);

  if (!empty($node->nid) && db_query_range("SELECT 1 FROM {contest} WHERE nid = :nid", 0, 1, array(':nid' => $node->nid))->fetchField()) {
    return contest_update($node)? TRUE: FALSE;
  }
  $fields = array(
    'nid'         => $node->nid,
    'vid'         => $node->vid,
    'sponsor_uid' => $sponsor_uid,
    'sponsor_url' => $node->contest->sponsor_url,
    'start'       => $node->contest->start,
    'end'         => $node->contest->end,
    'places'      => $node->contest->places,
    'period'      => $node->contest->period,
  );
  return db_insert('contest')->fields($fields)->execute()? TRUE: FALSE;
}
/**
 * Callback for the contest list page.
 *
 * @return (string) fully rendered HTML for the contest list page.
 */
function contest_list_page() {
  return theme('contest_list_page', array('data' => _contest_get_list_data('teaser')));
}
/**
 * Implementation of hook_load().
 */
function contest_load(&$nodes) {
  $stmt = "
    SELECT
      u.name AS 'sponsor',
      u.mail AS 'sponsor_email',
      c.sponsor_url,
      c.start,
      c.end,
      c.places,
      c.period,
      c.publish_winners
    FROM
      {contest} c
      LEFT JOIN {users} u ON u.uid =  c.sponsor_uid
    WHERE
      c.nid = :nid
  ";
  foreach ($nodes as $nid => $node) {
    $node->contest = db_query_range($stmt, 0, 1, array(':nid' => $nid))->fetchObject();
  }
}
/**
 * Implementation of hook_mail().
 */
function contest_mail($key, &$message, $params) {
  global $language;
  $language = isset($message['language'])? $message['language']:  $language;

  $message['subject'] .= _user_mail_text("{$key}_subject", $language, $params);
  $message['body'][] = _user_mail_text("{$key}_body", $language, $params);
}
/**
 * Implementation of hook_menu().
 */
function contest_menu() {
  $items['admin/config/contest'] = array(
    'title'            => 'Contest Config',
    'description'      => 'Custom settings for the Contest site.',
    'page callback'    => 'drupal_get_form',
    'page arguments'   => array('contest_settings_form'),
    'access arguments' => array('administer contest'),
    'file'             => 'contest.admin.inc',
    'type'             => MENU_NORMAL_ITEM,
  );
  $items['contest'] = array(
    'title'            => '!site_name Contests',
    'title arguments'  => array('!site_name' => variable_get('site_name', '')),
    'page callback'    => 'contest_list_page',
    'access arguments' => array('access content'),
    'type'             => MENU_NORMAL_ITEM,
  );
  $items['contest/clear-winners/%'] = array(
    'title'            => 'Clear Contest Winner(s)',
    'page callback'    => 'contest_clear_winners',
    'page arguments'   => array(2, 3),
    'access arguments' => array('edit contest'),
    'type'             => MENU_CALLBACK,
  );
  $items['contest/export-entries/%node'] = array(
    'title'            => 'Contest Entries Export',
    'page callback'    => 'contest_export_entries',
    'page arguments'   => array(2),
    'access arguments' => array('administer contest'),
    'type'             => MENU_CALLBACK,
  );
  $items['contest/export-unique/%node'] = array(
    'title'            => 'Contest Unique Entries Export',
    'page callback'    => 'contest_export_unique',
    'page arguments'   => array(2),
    'access arguments' => array('administer contest'),
    'type'             => MENU_CALLBACK,
  );
  $items['contest/pick-winner/%'] = array(
    'title'            => 'Select Contest Winner',
    'page callback'    => 'contest_pick_winner',
    'page arguments'   => array(2, 3),
    'access arguments' => array('edit contest'),
    'type'             => MENU_CALLBACK,
  );
  $items['contest/publish-winners/%node'] = array(
    'title'            => 'Publish Contest Winners',
    'page callback'    => 'contest_publish_winners',
    'page arguments'   => array(2),
    'access arguments' => array('edit contest'),
    'type'             => MENU_CALLBACK,
  );
  $items['contest/unpublish-winners/%node'] = array(
    'title'            => 'Unpublish Contest Winners',
    'page callback'    => 'contest_unpublish_winners',
    'page arguments'   => array(2),
    'access arguments' => array('edit contest'),
    'type'             => MENU_CALLBACK,
  );
  $items['contest/usr-autocomplete'] = array(
    'page callback'     => 'contest_usr_autocomplete',
    'delivery callback' => 'ajax_callback',
    'access arguments'  => array('access content'),
    'type'              => MENU_CALLBACK,
  );
  $items['node/%node/contest-admin'] = array(
    'title'            => 'Contest',
    'page callback'    => 'contest_admin_page',
    'page arguments'   => array(1),
    'access arguments' => array('administer contest'),
    'weight'           => 1,
    'type'             => MENU_LOCAL_TASK,
  );
  return $items;
}
/**
 * Implementation of hook_node_info().
 */
function contest_node_info() {
  return array(
    'contest' => array(
      'name'        => t('Contest'),
      'description' => t('A <em>contest</em> is a content type that allows a user to enter to win prizes via a random selection.'),
      'base'        => 'contest',
      'has_body'    => TRUE,
      'has_title'   => TRUE,
      'title_label' => t('Title'),
      'help'        => '',
      'locked'      => TRUE,
    ),
  );
}
/**
 * Implementation of hook_permission().
 */
function contest_permission() {
  return array(
    'administer contest' => array(
      'title'       => t('Administer the Contest Module'),
      'description' => t('Perform administration tasks for the contest module.'),
    ),
  );
}
/**
 * Pick a random winner of a contest.
 *
 * @param $nid (int) The node ID.
 * @param uid (int) The user's ID.
 */
function contest_pick_winner($nid, $uid = FALSE) {
  $hog_days = variable_get('contest_hog_days', 90);
  $wids = array(0);

// We don't allow contest results to be edited while they are published.

  $row = db_query("SELECT end, places, publish_winners FROM {contest} WHERE nid = :nid", array(':nid' => $nid))->fetchObject();

  $dq = $row->end - ($hog_days * 60 * 60 * 24);

  if ($row->publish_winners) {
    drupal_set_message('You must unpublish a contest before editing results.', 'warning');
    drupal_goto("node/$nid/contest-admin");
  }
// We don't allow the winner to be picked when the contest is still open.

  if (REQUEST_TIME < $row->end) {
    drupal_set_message('You can\'t select a contest winner before the contest ends.', 'warning');
    drupal_goto("node/$nid/contest-admin");
  }
// Check to see if there are any more winners allowed..

  $winners = db_query_range("SELECT COUNT(uid) FROM {contest_entry} WHERE nid = :nid AND winner", 0, 1, array(':nid' => $nid))->fetchField();

  if ($winners >= $row->places) {
    drupal_set_message("The contest allows " . (($row->places == 1)? 'one winner. ': "$row->places places") . 'Currently their ' . (($row->places == 1)? 'is one.': "are $row->places."), 'warning');
    drupal_goto("node/$nid/contest-admin");
  }
// Build a comma seperated string of the disqualified users ID's that will be used in a "IN" sql list.

  $rows = db_query("SELECT uid FROM {contest_entry} WHERE created > :created AND winner ORDER BY winner", array(':created' => $dq))->fetchAll();

  foreach ($rows as $row) {
    if ($uid && $row->uid == $uid) {
      drupal_set_message('This person has already won something in the last ' . (($hog_days == 1)? 'day.': "$hog_days days."), 'warning');
      drupal_goto("node/$nid/contest-admin");
    }
    $wids[] = $row->uid;
  }
// Select the winner randomly from the qualifying entrants.

  if ($uid) {
    $stmt = "
      SELECT
        e.uid,
        e.created
      FROM
        {contest_entry} e
        JOIN {users} u ON u.uid = e.uid
      WHERE
        e.nid = :nid
        AND e.uid = :uid
        AND u.status = 1
      ORDER BY
        RAND()
    ";
    $row = db_query_range($stmt, 0, 1, array(':nid' => $nid, ':uid' => $uid))->fetchObject();
  }
  else {
    $stmt = "
      SELECT
        e.uid,
        e.created
      FROM
        {contest_entry} e
        JOIN {users} u ON u.uid = e.uid
      WHERE
        e.nid = :nid
        AND e.uid NOT IN (:wids)
        AND u.status = 1
      ORDER BY
        RAND()
    ";
    $row = db_query_range($stmt, 0, 1, array(':nid' => $nid, ':wids' => $wids))->fetchObject();
  }
// If we have a winner get the next place and update the winning entry.

  if ($row->uid) {
    $place = 1 + db_query_range("SELECT winner FROM {contest_entry} WHERE nid = :nid AND winner ORDER BY winner DESC", 0, 1, array(':nid' => $nid))->fetchField();

    db_update('contest_entry')
      ->fields(array('winner' => $place))
      ->condition('nid', $nid)
      ->condition('uid', $row->uid)
      ->condition('created', $row->created)
      ->execute();
  }
// Redirect back to the contest entries list page.

  drupal_goto("node/$nid/contest-admin");
}
/**
 * Publish the winners of a contest.
 *
 * @param $nid (int) The node ID.
 */
function contest_publish_winners($node) {
  $winners = db_query_range("SELECT COUNT(uid) FROM {contest_entry} WHERE nid = :nid AND winner", 0, 1, array(':nid' => $node->nid))->fetchField();

  if ($winners != $node->contest->places) {
    drupal_set_message("You can't publish winners before they've all been selected.", 'warning');
    drupal_goto("node/$node->nid/contest-admin");
  }
  db_update('contest')->fields(array('publish_winners' => 1))->condition('nid', $node->nid)->execute();

  drupal_goto("node/$node->nid/contest-admin");
}
/**
 * Implimentation of hook_theme().
 */
function contest_theme() {
  return array(
    'contest_admin_page' => array(
      'path'     => _contest_get_template_path('contest', 'contest-admin-page'),
      'template' => 'contest-admin-page',
    ),
    'contest_list_block' => array(
      'path'     => _contest_get_template_path('contest', 'contest-list-block'),
      'template' => 'contest-list-block',
    ),
    'contest_list_page' => array(
      'path'     => _contest_get_template_path('contest', 'contest-list-page'),
      'template' => 'contest-list-page',
    ),
    'contest_results' => array(
      'path'     => _contest_get_template_path('contest', 'contest-results'),
      'template' => 'contest-results',
    ),
    'contest_tnc' => array(
      'render element' => 'element',
    ),
  );
}
/**
 * Unpublish the winners of a contest.
 *
 * @param $nid (int) The node ID.
 */
function contest_unpublish_winners($node) {
  db_update('contest')->fields(array('publish_winners' => 0))->condition('nid', $node->nid)->execute();
  drupal_goto("node/$node->nid/contest-admin");
}
/**
 * Implementation of hook_update().
 */
function contest_update($node) {
  $sponsor_uid = _contest_add_usr($node->contest->sponsor, $node->contest->sponsor_email);

  if (!empty($node->nid) && !db_query_range("SELECT 1 FROM {contest} WHERE nid = :nid", 0, 1, array(':nid' => $node->nid))->fetchField()) {
    return contest_insert($node)? TRUE: FALSE;
  }
  $fields = array(
    'nid'         => $node->nid,
    'sponsor_uid' => $sponsor_uid,
    'sponsor_url' => $node->contest->sponsor_url,
    'start'       => $node->contest->start,
    'end'         => $node->contest->end,
    'places'      => $node->contest->places,
    'period'      => $node->contest->period,
  );
  return db_update('contest')->fields($fields)->condition('vid', $node->vid)->execute()? TRUE: FALSE;
}
/**
 * Callback for username auto-complete fields.
 *
 * @return (JSON) A username to username hash.
 */
function contest_usr_autocomplete($name = '') {
  return drupal_json_output(db_query("SELECT name, name FROM {users} WHERE name LIKE :name", array(':name' => "$name%"))->fetchAllKeyed());
}
/**
 * Implements hook_view().
 */
function contest_view($node, $view_mode) {
  drupal_add_library('system', 'drupal.collapse');
  drupal_add_css(drupal_get_path('module', 'contest') . '/css/contest.css');

// If this isn't the full view we don't need the form, results or T&C so we'll short-circuit.

  if ($view_mode != 'full') {
    return $node;
  }
// Add the form if the contest is running.

  if ($node->contest->start < REQUEST_TIME && REQUEST_TIME < $node->contest->end) {
    $node->content['contest_entry_form'] = drupal_get_form('contest_entry_form', $node);
  }
// Add the reslults if the contest is over.

  else {
    $node->content['contest_results'] = array('#markup' => theme('contest_results', _contest_get_results_data($node)));
  }
// Always add the T&C on the full page view.

  $node->content['contest_tnc'] = theme('contest_tnc', array('node' => $node, 'tnc' => _contest_get_block_body(variable_get('contest_block_tnc', 0))));

  return $node;
}
/**
 * Theme function for the terms and conditions.
 *
 * @param $tnc (string) The HTML for the terms and conditions.
 *
 * @return $form (array) A drupal form array used to wrap the T&C in a collapsible fieldset.
 */
function theme_contest_tnc($args) {
  $node = !empty($args['node'])? $args['node']: new stdClass();
  $tnc = !empty($args['tnc'])? $args['tnc']: '';
  $host = _contest_usr_load(user_load(variable_get('contest_host_uid', 1)));

  $tokens = array(
    '!host_link'     => l($_SERVER['HTTP_HOST'], "http://{$_SERVER['HTTP_HOST']}"),
    '!server_link'   => l($_SERVER['SERVER_NAME'], "http://{$_SERVER['SERVER_NAME']}"),
    '!sponsor'       => !empty($node->contest->sponsor_url)? l($node->contest->sponsor, $node->contest->sponsor_url, array('absolute' => TRUE)): $node->contest->sponsor,
    '@country'        => variable_get('site_default_country', ''),
    '@date_end'      => format_date($node->contest->end, 'contest_date'),
    '@date_notify'   => format_date(($node->contest->end + (60 * 60 * 24 * 31)), 'contest_date'),
    '@date_start'    => format_date($node->contest->start, 'contest_date'),
    '@host_address'  => $host->address,
    '@host_business' => $host->business,
    '@host_city'     => $host->city,
    '@host_name'     => $host->full_name,
    '@host_state'    => $host->state,
    '@host_zip'      => $host->zip,
    '@host_title'    => variable_get('contest_host_title', 'Contest Host'),
    '@places'        => $node->contest->places,
    '@timezone'      => date('T'),
  );
  $form['wrapper'] = array(
    '#type'        => 'fieldset',
    '#title'       => t('Terms & Conditions'),
    '#attributes' => array('class' => array('collapsible', 'collapsed')),
    '#collapsible' => TRUE,
    '#collapsed'   => TRUE,
  );
  $form['wrapper']['tnc'] = array(
    'type'    => 'markup',
    '#markup' => t($tnc, $tokens),
  );
  return $form;
}
/**
 * Laod or add a user and return their ID.
 *
 * @param $name (string) The user name.
 * @param $email (string) The user email.
 *
 * @return (int) The user's ID.
 *
 */
function _contest_add_usr($name, $email) {
  $email = strtolower(trim($email));

  if (!$name || !$email) {
    return NULL;
  }
// Try to load the user.

  $usr = user_load_by_mail($email);

// If they don't exist, create them.

  if (empty($usr->uid)) {
    $args = array(
      'mail'   => $email,
      'name'   => _contest_name_gen($name),
      'pass'   => _contest_email_to_password($email),
      'roles'  => array(2 => 'authenticated user'),
      'status' => 1,
    );
    $usr = user_save($usr, $args);
  }
// Return the user's id.

  return $usr->uid;
}
/**
 * Build and return a cache ID and resoectuve cached data.
 *
 * @param $seeds (string|mixed) Data used to build a unique cache ID.
 *
 * @return (array) A two element ordered array of: cache ID, cached data.
 */
function _contest_cache_get($seeds = array()) {
  $cid = FALSE;
  $seeds = (array) $seeds;

  if (!user_access('administer contest')) {
    $cid = _contest_cid($seeds);

    $cache = $cid? cache_get($cid): FALSE;

    if ($cache !== FALSE) {
      return array($cid, $cache->data);
    }
  }
  return array($cid, FALSE);
}
/**
 * Set the cache and return the data.
 *
 * @param $cid (string) The cache ID.
 * @param $data (mixed) The cached data.
 *
 * @return $data (mixed) The submitted, (and cached) data.
 */
function _contest_cache_set($cid, $data) {
  global $conf;

  if (!user_access('administer contest') && !empty($cid)) {
    cache_set($cid, $data, 'cache', CACHE_TEMPORARY);
  }
  return $data;
}
/**
 * Generate a cache ID.
 *
 * @param $args (string|array) The string(s) to build the cache ID from.
 *
 * @return $cid (string) A unique cache ID.
 */
function _contest_cid($args = '') {
  $args = (array) $args;
  $cid = '';

  foreach ($args as $arg) {
    $cid .= (is_array($arg) || is_object($arg))? _contest_cid($arg): "-$arg";
  }
  return ($cid && strlen($cid) < 255)? _contest_stroked($cid): 'contest-' . md5($cid);
}
/**
 * Process the path into a OS safe string.
 *
 * @param $path (string) A directory name.
 *
 * @return (string) An OS safe string.
 */
function _contest_clean_path($path) {
  $regx = array(
    '/[[:^print:]]/s' => '',
    '/\W+/s'          => '_',
    '/__+/'           => '_',
    '/^_+|_+$/'       => '',
  );
  return preg_replace(array_keys($regx), array_values($regx), strtolower($path));
}
/**
 * Find or add a contestant then return the uid.
 *
 * @param $form_state (array) The submitted contest entry form.
 *
 * @return (int) The entrant's user ID.
 */
function _contest_contestant($form_state) {
  global $base_url;
  global $user;
  $from = variable_get('site_mail', 'webmaster@' . preg_replace('/(\w+\.[a-z]+)$/', "$1", $base_url));

// Try to get the user by uid or email.

  $usr = user_load($form_state['values']['uid']);

  if (empty($usr->uid)) {
    $usr = user_load_by_mail($form_state['values']['mail']);
  }
// If we have them and the match the global user, (should be superfluos) update their information.

  if (!empty($usr->uid) && $usr->uid === $user->uid) {
    $usr = _contest_usr_save($usr, $form_state);
    return $usr->uid;
  }
// If we have a valid user return their ID.

  elseif (!empty($usr->uid)) {
    return $usr->uid;
  }
// If they don't exist, create them.

  $args = array(
    'name'     => _contest_name_gen($form_state['values']['contest_name']),
    'mail'     => $form_state['values']['mail'],
    'pass'     => _contest_email_to_password($form_state['values']['mail']),
    'roles'    => array(2 => 'authenticated user'),
    'status'   => 1,
    'timezone' => variable_get('date_default_timezone', 'America/New_York'),
  );
// Save the new user.

  $usr = _contest_usr_save(user_save($usr, $args), $form_state);

// Build the message variables, send out the welcome email and set the welcome message.

  $mail = drupal_mail('contest', 'register_no_approval_required', $usr->mail, user_preferred_language($usr), array('user' => $usr), $from, TRUE);

  $tokens = array(
    '@password'  => $args['pass'],
    '@site_name' => variable_get('site_name', 'Contest Host'),
    '@username'  => $usr->name,
  );
  drupal_set_message(t("You have been added to the @site_name website. Below is your login information.<br>Username: @username<br>Password: @password.<br>Please keep this information for you records. If you have a problem logging in, use the password recovery tool located at the top of the user's login page.", $tokens));

// Log them in.

  user_authenticate($usr->name, trim($args['pass']));
  user_module_invoke('login', $edit, $usr);

// Return the user's id.

  return $usr->uid;
}
/**
 * Create the export directory.
 *
 * @param $path (string) The export directory name.
 *
 * @return (bool) True if the directory exists, otherwise false.
 */
function _contest_create_export_directory($path) {
  $path = _contest_clean_path($path);
  $wrapper = file_stream_wrapper_get_instance_by_uri('private://');

  if (!$path || !$wrapper) {
    return FALSE;
  }
  $export_dir = $wrapper->getDirectoryPath() . "/$path";

  if (!is_dir($export_dir)) {
    mkdir($export_dir);
    @chmod($export_dir, 0777);
  }
  return is_dir($export_dir);
}
/**
 * Generate a password from an email address.
 *
 * @param $email (string) The user's email address.
 *
 * @return (string) A password that hopefully isn't too terrible.
 */
function _contest_email_to_password($email = '') {
  return $email? preg_replace('/@.*/', '', $email) . '-' . substr(md5(REQUEST_TIME . rand(0, 100)), 0, rand(4, 6)): substr(md5(REQUEST_TIME . rand(0, 100)), 0, rand(8, 12));
}
/**
 * Build the data for a contest's admin page.
 *
 * @param $nid (int) The node ID.
 *
 * @return (array) A one element array of objects.
 */
function _contest_get_admin_page_data($node = NULL) {
  $data = array();
  list($cid, $cache) = _contest_cache_get(array(__FUNCTION__, $node->nid));

  if ($cache !== FALSE) {
    return $cache;
  }
  $node->contest->host = _contest_usr_load(user_load(variable_get('contest_host_uid', 1)));
  $node->contest->host->title = variable_get('contest_host_title', '');

  $node->contest->sponsor = _contest_usr_load(user_load_by_mail($node->contest->sponsor_email));
  $node->contest->sponsor->url = $node->contest->sponsor_url;

  $node->contest->contestants = array();
  $node->contest->entrants = 0;
  $node->contest->entries = 0;
  $node->contest->winners = array();

  $winners = db_query("SELECT uid, winner FROM {contest_entry} WHERE nid = :nid AND winner ORDER BY winner ASC", array(':nid' => $node->nid))->fetchAllKeyed();

  $stmt = "
    SELECT
      u.uid,
      u.name,
      u.mail,
      COUNT(e.nid) AS 'qty',
      e.created,
      e.winner
    FROM
      {contest_entry} e
      JOIN {contest} c ON c.nid = e.nid
      JOIN {users} u ON u.uid = e.uid
    WHERE
      e.nid = :nid
      AND u.status = 1
    GROUP BY
      u.uid
    ORDER BY
      qty DESC,
      u.name ASC
  ";
  $rows = db_query($stmt, array(':nid' => $node->nid))->fetchAll();

  foreach  ($rows as $row) {
    if (!$row->mail) {
      continue;
    }
    $node->contest->contestants[$row->uid] = $row;
    $node->contest->entrants++;
    $node->contest->entries += $row->qty;

    if (!empty($winners[$row->uid])) {
      $row->winner = $winners[$row->uid];
      $node->contest->winners["$row->uid"] = $row->winner;
    }
  }
  asort($node->contest->winners);

// Build the template's data object.

  $data = (object) array(
    'node'        => $node,
    'contest'     => $node->contest,
    'contestants' => $node->contest->contestants,
    'host'        => $node->contest->host,
    'sponsor'     => $node->contest->sponsor,
    'winners'     => $node->contest->winners,
  );
  return _contest_cache_set($cid, array('data' => $data));
}
/**
 * Retrieve the block body.
 *
 * @param $bid (int) The block ID.
 *
 * @return (string) The block body.
 */
function _contest_get_block_body($bid = 0) {
  return db_query_range("SELECT body FROM {block_custom} WHERE bid = :bid", 0, 1, array(':bid' => $bid))->fetchField();
}
/**
 * Retrieve the block body format.
 *
 * @param $bid (int) The block ID.
 *
 * @return (string) The block body format.
 */
function _contest_get_block_body_format($bid = 0) {
  return db_query_range("SELECT format FROM {block_custom} WHERE bid = :bid", 0, 1, array(':bid' => $bid))->fetchField();
}
/**
 * Return true if entered in the contest during this period, (configuarble).
 *
 * @param $nid (int) The node ID.
 * @param $uid (int) The user's ID.
 * @param $period (int) The seconds allowed between entries.
 *
 * @return (bool) True if the user has entered the contest already durring this period.
 */
function _contest_get_entered($uid, $nid, $period) {
  $periods = variable_get('contest_period', array(86400 => 'daily', 2147483646 => 'once'));
  $fmt = array(
    86400    => 'Y-m-d',
    604800   => 'Y-W',
    2592000  => 'Y-m',
    31536000 => 'Y',
  );
// If it's a one entry contest check for an entry and return.

  if ($periods[$period] == 'once') {
    return db_query_range("SELECT 1 FROM {contest_entry} WHERE uid = :uid AND nid = :nid", 0, 1, array(':nid' => $nid, ':uid' => $uid))->fetchField();
  }
// If we can't figure out the format. We'll assume the worst and return TRUE.

  if (empty($fmt[$period])) {
    return TRUE;
  }
// Determin if the user has already enter the conetest.

  $today = date($fmt[$period], REQUEST_TIME);
  $entered = date($fmt[$period], db_query_range("SELECT created FROM {contest_entry} WHERE uid = :uid AND nid = :nid ORDER BY created DESC", 0, 1, array(':nid' => $nid, ':uid' => $uid))->fetchField());

  return ($entered == $today)? TRUE: FALSE;
}
/**
 * Build the data needed to display the blog block.
 *
 * @return $data (array) An array of node objects prepared for render().
 */
function _contest_get_list_data($view_mode = 'teaser') {
  $data = array();
  list($cid, $cache) = _contest_cache_get(__FUNCTION__);

  if ($cache !== FALSE) {
    return $cache;
  }
  $stmt = "
    SELECT
      c.nid
    FROM
      {contest} c
      JOIN {node} n ON n.nid = c.nid
    WHERE
      n.status = 1
    ORDER BY
      n.sticky DESC,
      c.end ASC,
      c.start DESC,
      n.title ASC
  ";
  $rows = db_query($stmt)->fetchAll();

  foreach ($rows as $row) {
    $node = node_load($row->nid);
    $data[] = node_view($node, $view_mode);
  }
  return _contest_cache_set($cid, array('data' => $data));
}
/**
 * Build the data needed to display the results.
 *
 * @param $node (object) A node object.
 *
 * @return (array) A one elemet array of data to build the results.
 */
function _contest_get_results_data($node = NULL) {
  $states = _contest_get_states(variable_get('site_default_country', ''));
  $winners = array();
  $data = (object) array();
  list($cid, $cache) = _contest_cache_get(array(__FUNCTION__, $node->nid));

  if ($cache !== FALSE) {
    return $cache;
  }
  $rows = db_query("SELECT winner, uid FROM {contest_entry} WHERE nid = :nid AND winner ORDER BY winner ASC", array(':nid' => $node->nid))->fetchAllKeyed();

  foreach ($rows as $place => $uid) {
    $winners[$place] = _contest_usr_load(user_load($uid));

    if (!empty($states[$winners[$place]->state])) {
      $winners[$place]->state = $states[$winners[$place]->state];
    }
  }
  $data = (object) array(
    'node'    => $node,
    'winners' => $winners,
  );
  return _contest_cache_set($cid, array('data' => $data));
}
/**
 * Gets the states for the selected country.
 *
 * @param $country (string) The ISO country code.
 *
 * @return (array) An ISO code to country name hash.
 */
function _contest_get_states($country = 'US') {
  switch ($country) {
    case 'CA':
      return array(
        'AB' => 'Alberta',
        'BC' => 'British Columbia',
        'MB' => 'Manitoba',
        'NB' => 'New Brunswick',
        'NL' => 'Newfoundland and Labrador',
        'NS' => 'Nova Scotia',
        'ON' => 'Ontario',
        'PE' => 'Prince Edward Island',
        'QC' => 'Quebec',
        'SK' => 'Saskatchewan',
        'NT' => 'Northwest Territories',
        'NU' => 'Nunavut',
        'YT' => 'Yukon',
      );
    case 'US':
      return array(
        'AL' => 'Alabama',
        'AK' => 'Alaska',
        'AZ' => 'Arizona',
        'AR' => 'Arkansas',
        'CA' => 'California',
        'CO' => 'Colorado',
        'CT' => 'Connecticut',
        'DE' => 'Delaware',
        'DC' => 'District Of Columbia',
        'FL' => 'Florida',
        'GA' => 'Georgia',
        'HI' => 'Hawaii',
        'ID' => 'Idaho',
        'IL' => 'Illinois',
        'IN' => 'Indiana',
        'IA' => 'Iowa',
        'KS' => 'Kansas',
        'KY' => 'Kentucky',
        'LA' => 'Louisiana',
        'ME' => 'Maine',
        'MD' => 'Maryland',
        'MA' => 'Massachusetts',
        'MI' => 'Michigan',
        'MN' => 'Minnesota',
        'MS' => 'Mississippi',
        'MO' => 'Missouri',
        'MT' => 'Montana',
        'NE' => 'Nebraska',
        'NV' => 'Nevada',
        'NH' => 'New Hampshire',
        'NJ' => 'New Jersey',
        'NM' => 'New Mexico',
        'NY' => 'New York',
        'NC' => 'North Carolina',
        'ND' => 'North Dakota',
        'OH' => 'Ohio',
        'OK' => 'Oklahoma',
        'OR' => 'Oregon',
        'PA' => 'Pennsylvania',
        'RI' => 'Rhode Island',
        'SC' => 'South Carolina',
        'SD' => 'South Dakota',
        'TN' => 'Tennessee',
        'TX' => 'Texas',
        'UT' => 'Utah',
        'VT' => 'Vermont',
        'VI' => 'Virgin Islands',
        'VA' => 'Virginia',
        'WA' => 'Washington',
        'WV' => 'West Virginia',
        'WI' => 'Wisconsin',
        'WY' => 'Wyoming',
      );
  }
  return array();
}
/**
 * Scan the theme and module directories in that order for the template and return the path to the template's directory.
 *
 * @param $module (string) The module name, (without the suffix).
 * @param $template (string) The template name, (without the suffixes).
 *
 * @return (string) A Drupal path to the template's directory, (defaults to .../module/templates).
 */
function _contest_get_template_path($module, $template = '') {
  $theme_path = drupal_get_path('theme', variable_get('theme_default', 'garland'));

  $scan = file_scan_directory($theme_path, "/^$template\.tpl\.php$/", array('recurse' => TRUE, 'filename' => TRUE));

  if (!count($scan)) {
    $scan = file_scan_directory(drupal_get_path('module', $module), "/^$template\.tpl\.php$/", array('recurse' => TRUE, 'filename' => TRUE));
  }
  return count($scan)? preg_replace('/(\/[^\/]+)$/', '', key($scan)):  drupal_get_path('module', $module) . '/templates';
}
/**
 * Extract the contest profile value from the user object.
 *
 * @param $usr (object) A Drupal user object.
 * @param $field (string) The field name.
 *
 * @return (string) The safe_value if set.
 */
function _contest_get_usr_val($usr = NULL, $field = '', $index = 0, $default = NULL) {
  if (!is_object($usr) || empty($field)) {
    return NULL;
  }
  if (!empty($usr->{$field}[LANGUAGE_NONE][$index]['safe_value'])) {
    return $usr->{$field}[LANGUAGE_NONE][$index]['safe_value'];
  }
  elseif (!empty($usr->{$field}[LANGUAGE_NONE][$index]['value'])) {
    return $usr->{$field}[LANGUAGE_NONE][$index]['value'];
  }
  return $default;
}
/**
 * Determine if the profile is complete.
 *
 * @param $usr (object) A Drupal user object.
 * @param $role (string) The role to test.
 *
 * @return (bool) True if the user has a completed profile.
 */
function _contest_has_complete_profile($usr, $role = 'entrant') {
  $status = (_contest_get_usr_val($usr, 'field_contest_name') && _contest_get_usr_val($usr, 'field_contest_address') && _contest_get_usr_val($usr, 'field_contest_city') && _contest_get_usr_val($usr, 'field_contest_state') && _contest_get_usr_val($usr, 'field_contest_zip') && _contest_get_usr_val($usr, 'field_contest_phone'))? TRUE: FALSE;

  switch ($role) {
    case 'entrant':
      return $status;

    case 'host':
      return ($status && _contest_get_usr_val($usr, 'field_contest_business'))? TRUE: FALSE;
  }
  return FALSE;
}
/**
 * Generate a UNIX timestamp from an array.
 *
 * @param $date (array) An array with day, month and year.
 *
 * @return (int) A UNIX timestamp.
 */
function _contest_mktime($date) {
  if (!isset($date['day']) || !isset($date['month']) || !isset($date['year'])) {
    return NULL;
  }
  return mktime(0, 0, 0, intval($date['month']), intval($date['day']), intval($date['year']));
}
/**
 * Determine if the minimum age requirement has been met.
 *
 * @param $age (int|array) The birthdate in either UNIX time or an array with year, month, day.
 *
 * @return (bool) True if the minimum age requirement is met, otherwise false.
 */
function _contest_min_age($age = NULL) {
  $min_date = mktime(0, 0, 0, intval(date('n')), intval(date('j')), (intval(date('Y')) - variable_get('contest_min_age', 18)));

  if (is_int($age)) {
    $birthday = $age;
  }
  elseif (isset($age['day']) && isset($age['month']) && isset($age['year'])) {
    $birthday = mktime(0, 0, 0, intval($age['month']), intval($age['day']), intval($age['year']));
  }
  else {
    return FALSE;
  }
  return ($birthday <= $min_date)? TRUE: FALSE;
}
/**
 * Generate a unique username.
 *
 * @param $name (string) The user's name.
 *
 * @return $username (string) A unique username.
 */
function _contest_name_gen($name) {
  $min = 10;
  $max = 99;
  $username = $name;

  for ($i = $min; $i <= $max; $i++) {
    $found = db_query_range("SELECT 1 FROM {users} WHERE name = :name", 0, 1, array(':name' => $username))->fetchField();

    if (!$found) {
      return $username;
    }
    $username = preg_replace('/\W/', '', strtolower($name)) . '-' . rand($min, $max);
  }
  return _contest_name_gen($username);
}
/**
 * Delete the requested files.
 *
 * @param $file_regx (string) A posix regex.
 * @param $age (int) The age of the files in seconds.
 *
 * @return (int) The number of files deleted.
 */
function _contest_purge_dir($file_regx, $age) {
  $count = 0;
  $files = glob($file_regx);

  foreach ($files as $file) {
    if (is_file($file) && (REQUEST_TIME - filemtime($file)) >= $age) {
      @chmod($file, 0777);
      unlink($file);
      $count++;
    }
  }
  return $count;
}
/**
 * Remove old contest export files.
 *
 * @return (int|bool) The number of files deleted.
 */
function _contest_purge_exports() {
  $max_age = 3600;
  $sub_dir = variable_get('contest_export_dir', '');
  $wrapper = file_stream_wrapper_get_instance_by_uri('private://');

  if (!$sub_dir || !$wrapper) {
    return FALSE;
  }
  $file_regx = $wrapper->getDirectoryPath() . "/$sub_dir/*.csv";

  return _contest_purge_dir($file_regx, $max_age);
}
/**
 * Set a plain text user profile value.
 *
 * @param $usr (object) A user object.
 * @param $values (array) The contents of the form_state['values'].
 * @param $field (string) The field name.
 * @param $index (int) The index of the field.
 *
 * @param $usr (object) A user object.
 */
function _contest_set_usr_txt_val($usr = NULL, $values = array(), $field = '', $index = 0) {
  if (empty($usr) || !is_object($usr) || empty($values) || empty($field) || !is_int($index)) {
    return;
  }
  $property = "field_{$field}";

  $usr->{$property}[LANGUAGE_NONE][$index] = array(
    'value'      => !empty($values[$field])? $values[$field]: '',
    'formt'      => 'plain_text',
    'safe_value' => !empty($values[$field])? check_plain($values[$field]): '',
  );
}
/**
 * Convert the provided string to a lowercase stroke delimited string, (uppercase converted to lower, consecutive non alpha-numeric characters converted to a stroke).
 *
 * @param $txt (string) The string to convert.
 *
 * @return (string) A lowercase stroke delimited string.
 */
function _contest_stroked($txt) {
  return preg_replace(array('/[^a-z0-9]+/', '/^-+|-+$/'), array('-', ''), strtolower($txt));
}
/**
 * Return a single csv line for a contest.
 *
 * @param $usr (object) A user object.
 *
 * @return $csv (string) A comma seperated list of users.
 */
function _contest_to_csv($usr) {
  $csv  = '"'  . (preg_replace('/"/', '\"', $usr->mail)) . '"';
  $csv .= ',"' . (preg_replace('/"/', '\"', _contest_get_usr_val($usr, 'field_contest_name'))) . '"';
  $csv .= ',"' . (preg_replace('/"/', '\"', _contest_get_usr_val($usr, 'field_contest_address'))) . '"';
  $csv .= ',"' . (preg_replace('/"/', '\"', _contest_get_usr_val($usr, 'field_contest_city'))) . '"';
  $csv .= ',"' . (preg_replace('/"/', '\"', _contest_get_usr_val($usr, 'field_contest_state'))) . '"';
  $csv .= ',"' . (preg_replace('/"/', '\"', _contest_get_usr_val($usr, 'field_contest_zip'))) . '"';
  $csv .= ',"' . (preg_replace('/"/', '\"', _contest_get_usr_val($usr, 'field_contest_phone'))) . '"';

  return "$csv\n";
}
/**
 * Create a summary from the provided text.
 *
 * @param $string (string) The string to trim.
 * @param $max (int) The target length of the string.
 *
 * @return $txt (string) The provided text truncated to the requested length.
 */
function _contest_trim($string, $max = 150) {
  $chars = 0;
  $txt = '';

  foreach (preg_split('/\s+/', $string) as $atom) {
    $length = strlen($atom);
    if (($length + strlen($txt) + 1) > $max) {
      return preg_match('/<\/p>$/', $txt)? preg_replace('/<\/p>$/', '&hellip;</p>', $txt): "$txt&hellip;</p>";
    }
    $txt .= $txt? " $atom": $atom;
  }
  return $txt;
}
/**
 * Build a more friendly user object.
 *
 * @param $usr (object) A user object
 *
 * @return (object) An object with the data we'll be using moved to the root so it's friendlier to use.
 */
function _contest_usr_load($usr = NULL) {
  return (object) array(
    'uid'       => $usr->uid,
    'name'      => $usr->name,
    'mail'      => $usr->mail,
    'full_name' => _contest_get_usr_val($usr, 'field_contest_name'),
    'business'  => _contest_get_usr_val($usr, 'field_contest_business'),
    'address'   => _contest_get_usr_val($usr, 'field_contest_address'),
    'city'      => _contest_get_usr_val($usr, 'field_contest_city'),
    'state'     => _contest_get_usr_val($usr, 'field_contest_state'),
    'zip'       => _contest_get_usr_val($usr, 'field_contest_zip'),
    'phone'     => _contest_get_usr_val($usr, 'field_contest_phone'),
    'birthdate' => _contest_get_usr_val($usr, 'field_contest_birthdate'),
  );
}
/**
 * Save the contest profile fields to the user object.
 *
 * @param $usr (object) A Drupal user object.
 * @param $form_state (array) A form state array.
 *
 * @return (object) A fully loaded user object.
 */
function _contest_usr_save($usr = NULL, $form_state = array()) {
  if (empty($usr->uid)) {
    return user_load(0);
  }
  if (empty($form_state)) {
    return $usr;
  }
  _contest_set_usr_txt_val($usr, $form_state['values'], 'contest_name');
  _contest_set_usr_txt_val($usr, $form_state['values'], 'contest_address');
  _contest_set_usr_txt_val($usr, $form_state['values'], 'contest_city');
  _contest_set_usr_txt_val($usr, $form_state['values'], 'contest_state');
  _contest_set_usr_txt_val($usr, $form_state['values'], 'contest_zip');
  _contest_set_usr_txt_val($usr, $form_state['values'], 'contest_phone');
  _contest_set_usr_txt_val($usr, array('contest_birthdate' => _contest_mktime($form_state['values']['contest_birthdate'])), 'contest_birthdate');
  $usr->field_contest_optin[LANGUAGE_NONE][0] = array('value' => intval($form_state['values']['contest_optin']));

  return user_save($usr);
}
