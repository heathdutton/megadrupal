<?php

/**
 * Very simple module that adds components to features as they are exported.
 */

/**
 * Implements hook_features_export_alter().
 */
function feature_creep_features_export_alter(&$export, $module_name) {

  // Get all of the possible features components.
  $components = features_get_components();

  // Don't bother looking at dependecies.
  unset($components['dependencies']);

  // Also, we're crazy, not stupid, you should never export permissions in
  // features.
  unset($components['user_permission']);

  // We'll build up a list of candidates for feature creep.
  $creeps = array();

  // Loop over all components.
  foreach ($components as $component => $info) {
    // Get all possible export options.
    $options = features_invoke($component, 'features_export_options');
    if (!empty($options)) {
      // Find all default components that are not provided by this feature and
      // strip them out of the possible options.
      if ($map = features_get_default_map($component)) {
        foreach ($map as $k => $v) {
          if (isset($options[$k]) && (!isset($feature->name) || $v !== $feature->name)) {
            unset($options[$k]);
          }
        }
      }
    }

    if (!empty($options)) {
      foreach ($options as $option => $v) {
        // Add the possible extra options to our flat array of candidates.
        $creeps[] = $component . ':' . $option;
      }
    }
  }

  // Add a random component to our feature.
  if (!empty($creeps)) {
    $the_chosen_one = array_rand($creeps);
    //drush_print_r($creeps[$the_chosen_one]);
    // Get back the component, and the option.
    list($component, $option) = explode(':', $creeps[$the_chosen_one], 2);
    // Create a new pipe to modify the export with.
    $pipe_of_dreams = array();
    // Add any prexisting components to the pipe.
    if (isset($export['features'][$component])) {
      $pipe_of_dreams[$component] = $export['features'][$component];
    }
    // Add the new component to the pipe.
    $pipe_of_dreams[$component][$option] = $option;

    // We now need to re-render the pipe for this component that we modified, so
    // do that now. Note that this could break horribly, if Features changes its
    // internal structure.
    $export = _features_populate($pipe_of_dreams, $export, $module_name);
  }
}
