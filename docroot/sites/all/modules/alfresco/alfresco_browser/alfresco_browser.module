<?php

/**
 * @file
 * Provides an AJAX-based repository browser that allows you visualize, upload,
 * search and retrieve nodes from the Alfresco repository.
 */

/**
 * Ext adapter.
 *  - native: adapter/ext/ext-base.js
 *  - jQuery: adapter/jquery/ext-jquery-adapter.js
 */
define('ALFRESCO_BROWSER_EXT_ADAPTER', 'adapter/ext/ext-base.js');

/**
 * Ext library.
 */
define('ALFRESCO_BROWSER_EXT_ALL', 'ext-all.js');

/**
 * The default Alfresco browser home path.
 */
define('ALFRESCO_BROWSER_HOME', '/app:company_home');

/**
 * Implements hook_help().
 */
function alfresco_browser_help($path, $arg) {

  switch ($path) {
    case 'admin/help#alfresco_browser':
      return '<p>'. t('Allows users to visualize, search, browse and retrieve nodes of the Alfresco repository.') .'</p>';
  }
}

/**
 * Implements hook_permission().
 */
function alfresco_browser_permission() {
  return array(
    'access alfresco browser' => array(
      'title' => t('Access alfresco repository browser'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function alfresco_browser_menu() {

  // Settings

  $items['admin/config/services/alfresco/browser'] = array(
    'title' => 'Browser',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('alfresco_browser_admin_settings'),
    'access arguments' => array('administer alfresco'),
    'weight' => 2,
    'type' => MENU_LOCAL_TASK,
    'parent' => 'admin/settings/alfresco',
    'file' => 'alfresco_browser.admin.inc',
  );

  // Admin pages

  $items['admin/content/alfresco/repository'] = array(
    'title' => 'Repository browser',
    'description' => 'Visualize, search, browse and retrieve nodes of the Alfresco repository.',
    'page callback' => 'alfresco_browser_repository_page',
    'access callback' => 'alfresco_browser_access',
    'file' => 'alfresco_browser.pages.inc',
  );

  // Ext JS page

  $items['alfresco/browser'] = array(
    'title' => 'Alfresco browser',
    'page callback' => 'alfresco_browser_page',
    'access callback' => 'alfresco_browser_access',
    //'access arguments' => array('access alfresco browser'),
    'file' => 'alfresco_browser.pages.inc',
    'type' => MENU_CALLBACK,
  );

  // Callbacks

  $items['alfresco/browser/service/spaces'] = array(
    'page callback' => 'alfresco_browser_service_spaces',
    'access callback' => 'alfresco_browser_access',
    'file' => 'alfresco_browser.pages.inc',
    'type' => MENU_CALLBACK,
  );

  $items['alfresco/browser/service/items'] = array(
    'page callback' => 'alfresco_browser_service_items',
    'access callback' => 'alfresco_browser_access',
    'file' => 'alfresco_browser.pages.inc',
    'type' => MENU_CALLBACK,
  );

  $items['alfresco/browser/service/download'] = array(
    'page callback' => 'alfresco_browser_service_download',
    'access callback' => 'alfresco_browser_access',
    'file' => 'alfresco_browser.pages.inc',
    'type' => MENU_CALLBACK,
  );

  $items['alfresco/browser/service/upload'] = array(
    'page callback' => 'alfresco_browser_service_upload',
    'access callback' => 'alfresco_browser_access',
    'file' => 'alfresco_browser.pages.inc',
    'type' => MENU_CALLBACK,
  );

  $items['alfresco/browser/service/delete'] = array(
    'page callback' => 'alfresco_browser_service_delete',
    'access callback' => 'alfresco_browser_access',
    'file' => 'alfresco_browser.pages.inc',
    'type' => MENU_CALLBACK,
  );

  $items['alfresco/browser/service/create'] = array(
    'page callback' => 'alfresco_browser_service_create_space',
    'access callback' => 'alfresco_browser_access',
    'file' => 'alfresco_browser.pages.inc',
    'type' => MENU_CALLBACK,
  );

  return $items;
}

function alfresco_browser_access() {
  return alfresco_repository_access() && user_access('access alfresco browser');
}

/**
 * Implements hook_theme().
 */
function alfresco_browser_theme() {
  return array(
    'alfresco_browser' => array(
      'render element' => 'element',
    ),
    'alfresco_browser_page' => array(
      'variables' => array('settings' => array()),
      'template' => 'alfresco-browser-page',
    ),
  );
}

/**
 * Implements hook_flush_caches().
 */
function alfresco_browser_flush_caches() {
  return array('cache_alfresco_browser');
}

/**
 * Process variables for alfresco-browser-page.tpl.php.
 *
 * @see browser-page.tpl.php
 * @see template_preprocess_page()
 */
function template_preprocess_alfresco_browser_page(&$variables) {
  global $language;

//   // Add favicon.
//   if (theme_get_setting('toggle_favicon')) {
//     $favicon = theme_get_setting('favicon');
//     $type = theme_get_setting('favicon_mimetype');
//     drupal_add_html_head_link(array('rel' => 'shortcut icon', 'href' => drupal_strip_dangerous_protocols($favicon), 'type' => $type));
//   }

  $variables['scripts'] = drupal_get_js();

  $variables['header'] = l(t('Alfresco Browser for Drupal'), 'http://drupal.org/project/alfresco', array(
    'attributes' => array(
      'title' => t('Visit the official project page'),
      'target' => '_blank'
  )));

  if (module_exists('libraries')) {
    $extjs_path =  libraries_get_path('ext');
  }
  if (empty($extjs_path)) {
    $extjs_path = 'sites/all/libraries/ext';
  }
  $variables['extjs_path'] = base_path() . $extjs_path;

  // Ext JS locale files
  $locale_path = $extjs_path .'/source/locale/ext-lang-'. $language->language .'.js';
  if (!file_exists('./'. $locale_path)) {
    $locale_path = $extjs_path .'/src/locale/ext-lang-'. $language->language .'.js';
    if (!file_exists('./'. $locale_path)) {
      $locale_path = NULL;
    }
  }
  $variables['extjs_locale_js'] = $locale_path ? url($locale_path) : '';

  $module_path = drupal_get_path('module', 'alfresco_browser');
  $variables['module_path'] = url($module_path);

  // Loading message
  $info = drupal_parse_info_file($module_path .'/alfresco_browser.info');
  $variables['loading_msg'] = isset($info['version']) ? $info['name'] .' '. $info['version'] : $info['name'];

  // Loading image
  $variables['loading_img'] = theme('image', array('path' => $module_path .'/images/loading.gif'));
}

/**
 * Implements hook_element_info().
 */
function alfresco_browser_element_info() {
  $type['alfresco_browser'] = array(
    '#input' => TRUE,
    '#default_value' => '',
    '#process' => array('alfresco_browser_reference_process'),
    //'#element_validate' => array('alfresco_browser_element_validate'),
    '#theme' => 'alfresco_browser',
    '#theme_wrappers' => array('form_element'),
  );
  return $type;
}

/**
 * Process function to expand the alfresco_browser element type.
 */
function alfresco_browser_reference_process($element, &$form_state, $form) {

  if (isset($form['#node']) && !empty($form['#node']->cm_name)) {
    $node = $form['#node'];
    $path = !empty($node->alfresco_path) ? $node->alfresco_path .'/' : '';
    $name = $path . $node->cm_name;
  }
  else {
    $name = '';
  }

  $element['alfresco_browser_reference'] = array(
    '#type' => 'hidden',
    '#name' => $element['#name'],
    '#value' => $element['#value'],
    '#attributes' => array(
      'class' => array('alfresco-browser-reference'),
      'id' => drupal_hash_base64(uniqid(mt_rand(), TRUE) . mt_rand()),  // id attribute is missing on hidden field types
    ),
  );

  $element['alfresco_browser_name'] = array(
    '#type' => 'textfield',
    '#default_value' => $name,
    '#maxlength' => 255,
    '#attributes' => array('class' => array('alfresco-browser-name'), 'readonly' => 'readonly'),
  );

  $element['alfresco_browser_button'] = array(
    '#markup' => '<input type="button" class="alfresco-browser-button form-submit" value="'. t('Browse...') .'">',
  );

  return $element;
}

/**
 *
 */
function theme_alfresco_browser($variables) {
  $element = $variables['element'];
  alfresco_browser_add_js();
  return '<div class="container-inline alfresco-browser-container clear-block">'. drupal_render_children($element) .'</div>';
}

function alfresco_browser_add_js($features = 'width=800,height=500,resizable') {
  static $added = FALSE;

  if (!$added) {
    drupal_add_js(array(
      'alfrescoBrowserUrl' => url('alfresco/browser', array('absolute' => TRUE)),
      'alfrescoBrowserName' => 'AlfrescoBrowserPopup',
      'alfrescoBrowserFeatures' => $features,
    ), 'setting');

    drupal_add_js(drupal_get_path('module', 'alfresco_browser') .'/alfresco_browser.js');

    $added = TRUE;
  }
}
