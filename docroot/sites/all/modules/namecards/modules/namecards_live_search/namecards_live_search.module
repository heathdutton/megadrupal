<?php

/**
 * @file
 *
 * Adds live search (i.e. ajax) functionality to the search textbox provided the 'namecards' module.
 *
 *  @see namecards_search_form() in namecards.module for search form definition.
 *
 * Copyright 2010 Ben Gunn
 *
 * Licensed under the GNU Public License
 */

/**
 * Implements hook_init
 */
function namecards_live_search_init() {
  // Get the URI of the page currently being loaded.  Utilizes check_plain()
  // to circumvent hackers. Get src uri to avoid problems with changing aliases.
  $uri = check_plain($_GET['q']);
  $regex_pattern = '/namecards\/(browse_contacts|organization_names|event_names|email_list)/';

  // Add live search box to page
  if (preg_match($regex_pattern, $uri) > 0 ) {
    theme('namecards_live_search_javascript');
    theme('namecards_live_search_css');
  }
}

/**
 * Implements hook_menu
 */
function namecards_live_search_menu() {
  $items['namecards/live_search_results/js'] = array(
    'page callback' => 'namecards_live_search_results_js',
    'page arguments' => array(),
    'access callback' => 'namecards_menu_access_callback_function',
    'type' => MENU_CALLBACK,
  );
  // TODO: The following item appears to be unutilized by the module.  Confirm this is case and delete.
//  $items['namecards/live_search_get_uri/js'] = array(
//    'page callback' => 'namecards_live_search_get_uri_js',
//    'page arguments' => array(),
//    'access callback' => 'namecards_menu_access_callback_function',
//    'type' => MENU_CALLBACK,
//  );
  return $items;
}

/**
 * Fetch clean URI for the page being loaded
 */
//function namecards_live_search_get_uri_js() {
//  $uri = check_plain($_GET['q']);
//
//  // create a JSON object. The object will contain a property named “contacts” and "nodeId" that will be sent to the browser and is accessabel to javascript.
//  return drupal_json(array('uri' => $uri));
//  exit;
//}

/**
 * Returns view 'browse contacts' filtered by search terms as a JSON object
 */
function namecards_live_search_results_js() {
  // Get additional arguments from URI.
  $args = arg();
  unset($args[0]);
  unset($args[1]);
  unset($args[2]);
  $args = array_values($args);

  if (!empty($args)) {
    // Create string of search terms.
    $search_terms = implode('+', $args);
    // Sanitize search terms.
    $search_terms = check_plain($search_terms);
  }
  else {
    $search_terms = NULL;
  }
  // Change page URI to 'namecards/browse_contacts'.  Because this is an ajax call,
  // the URI should remain unchanged from that of the page calling the ajax function.
  // Otherwise the pager links will not function correctly as they will try to point
  // to the URI of the ajax call (i.e. 'namecards/live_search_results/js').
  $_GET['q'] = 'namecards/browse_contacts';
  if ($search_terms) {
    // Append search terms as arguments to URI.
    $_GET['q'] .= '/' . $search_terms;
  }

  $view_browse_contacts = views_embed_view('namecards_browse_contacts', 'default', $search_terms);

  // create a JSON object. The object will contain a property named “contacts” and "nodeId" that will be sent to the browser and is accessabel to javascript.
  return drupal_json_output(array('viewBrowseContacts' => $view_browse_contacts));
  exit;
}

/**
 * Implements hook_theme
 */
function namecards_live_search_theme() {
  return array(
    'namecards_live_search_javascript' => array(
      'arguments' => array(),
    ),
    'namecards_live_search_css' => array(
      'arguments' => array(),
    ),
  );
}

/**
 * Adds search gadget to page
 */
function theme_namecards_live_search_javascript() {
  drupal_add_js(drupal_get_path('module', 'namecards_live_search') . '/namecards_live_search.js');
}
/**
 * Adds css to page
 */
function theme_namecards_live_search_css() {
  drupal_add_css(drupal_get_path('module', 'namecards_live_search') . '/namecards_live_search.css');
}