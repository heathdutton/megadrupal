<?php

/**
 * @file
 * Main module file for the SharedVue module.
 */

/**
 * Implements hook_menu().
 */
function sharedvue_menu() {
  $items = array();

  // Main syndicated content pages
  $sharedvue_endpoints = variable_get('sharedvue_endpoints', array());

  foreach ($sharedvue_endpoints as $sharedvue_endpoint) {
    $items['sharedvue/' . $sharedvue_endpoint['key']] = array(
      'title' => check_plain($sharedvue_endpoint['title']),
      'page callback' => '_sharedvue_content',
      'type' => MENU_NORMAL_ITEM,
      'access arguments' => array('access syndicated sharedvue content'),
      'page arguments' => array(1),
      'file' => 'sharedvue.pages.inc',
      'menu_name' => 'main-menu',
    );
  }

  // Main admin configuration form
  $items['admin/config/services/sharedvue'] = array(
    'title' => 'SharedVue',
    'description' => 'Configure settings for the SharedVue content syndication page',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('sharedvue_admin'),
    'type' => MENU_NORMAL_ITEM,
    'access arguments' => array('administer sharedvue syndicated content settings'),
    'file' => 'sharedvue.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function sharedvue_permission() {
  return array(
    'access syndicated sharedvue content' => array(
      'title' => t('Access syndicated SharedVue content'),
    ),
    'administer sharedvue syndicated content settings' => array(
      'title' => t('Administer SharedVue syndicated content settings'),
    ),
  );
}

/**
 * Implements template_preprocess_page().
 */
function sharedvue_preprocess_page(&$variables) {

  // Suppress the title on the SharedVue page since the page content contains strong branding
  if (arg(0) === 'sharedvue' && variable_get('sharedvue_suppress_title', TRUE)) {
    $variables['title'] = FALSE;
  }
}

function _sharedvue_strip_stylesheets($matches) {
  preg_match('<link.*href=\'(.*)\'.*\/>', $matches[0], $href);

  drupal_add_css($href[1], array('type' => 'external'));
}
