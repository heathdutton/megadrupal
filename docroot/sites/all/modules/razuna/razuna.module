<?php
/**
 * @file
 * Allows users to upload files on Razuna Media Server (Cloud).
 */

// Load all Field module hooks for Razuna.
require_once DRUPAL_ROOT . '/' . drupal_get_path('module', 'razuna') . '/razuna.field.inc';

/**
 * Establish connection with Razuna.
 */
function razuna_connect($hostname = '', $api_key = '') {
  if (($library = libraries_load('razuna')) && !empty($library['loaded'])) {
    if ($api_key == '' && $hostname == '') {
      $api_key = variable_get('razuna_api_key', '');
      $hostname = str_replace('http://', '', variable_get('razuna_hostname', ''));
    }
    if ($hostname != '' && $api_key != '') {
      if (method_exists('Razuna', 'connect')) {
        $razuna = new Razuna();
        $razuna->connect($hostname, $api_key);
        $razuna1['error'] = FALSE;
        $razuna1['lib'] = $razuna;
        $razuna1['api_key'] = $api_key;
      }
      else {
        $razuna1['error'] = TRUE;
        drupal_set_message(t('Razuna is not configured properly! Please check that you are using <a href="@razuna_url" target="_blank"> Razuna API 2</a> version.', array('@razuna_url' => url('https://github.com/razuna/razuna-php-library'))), 'error', FALSE);
      }
    }
    else {
      $razuna1['error'] = TRUE;
      drupal_set_message(t('Empty Arguments Passed !'), 'error');
      drupal_set_message(t('Razuna is not configured properly! Please <a href="@curl_url">Configure Razuna</a>', array('@curl_url' => url('admin/config/media/razuna-settings'))), 'error', FALSE);
    }
  }
  else {
    // Something went wrong.
    // This contains a short status code of what went wrong and detailed
    // (localized) error message.
    $razuna1['error'] = TRUE;
    // The error set below comes directly from third party so not sanitized.
    drupal_set_message($library['error'] . ' : ' . $library['error message'], 'error');
  }
  return $razuna1;
}

/**
 * Implements hook_menu().
 */
function razuna_menu() {
  $items = array();
  $items['admin/config/media/razuna-settings'] = array(
    'title' => 'Configure Razuna',
    'description' => 'Configure Razuna',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('razuna_admin_settings'),
    'access arguments' => array('administer site configuration'),
    'file' => 'razuna.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}

/**
 * Implements hook_libraries_info().
 */
function razuna_libraries_info() {
  $libraries['razuna'] = array(
    'name' => 'Razuna library',
    'vendor url' => 'http://www.razuna.com/',
    'download url' => 'https://github.com/razuna/razuna-php-library',
    'version arguments' => array(
      'file' => 'Readme.md',
      'pattern' => '/Version (\d+)/',
      'lines' => 506,
    ),
    'version' => '2',
    'files' => array(
      'php' => array('Razuna.class.php'),
    ),
  );
  return $libraries;
}

/**
 * Returns cloud url from razuna for uploaded file.
 */
function razuna_get_assets($asset_id = '', $type = '', $filetype = 'img', $height = '', $width = '') {
  global $_razuna_flag;
  $razuna = razuna_connect();
  if (!$razuna['error']) {
    $json_asset = $razuna['lib']->getAsset($asset_id, $filetype);
    $asset = drupal_json_decode($json_asset);
    $html = '';
    if ($asset == '') {
      drupal_set_message(check_plain($json_asset), 'error', FALSE);
    }
    elseif (isset($asset['COLUMNS'])) {
      $key_thumb = array_search('cloud_url', $asset['COLUMNS']);
      $key_url = array_search('cloud_url_org', $asset['COLUMNS']);
      $key_local_thumb = array_search('local_url_thumb', $asset['COLUMNS']);
      $key_local_url = array_search('local_url_org', $asset['COLUMNS']);
      if ($filetype == 'img') {
        if ($type == 'thumbnail') {
          if (empty($asset['DATA'][0][$key_thumb])) {
            $html = $asset['DATA'][0][$key_local_thumb];
          }
          else {
            $html = $asset['DATA'][0][$key_thumb];
          }
        }
        else {
          if (empty($asset['DATA'][0][$key_url])) {
            $html = $asset['DATA'][0][$key_local_url];
          }
          else {
            $html = $asset['DATA'][0][$key_url];
          }
        }
      }
      elseif ($filetype == 'vid' || $filetype == 'doc' || $filetype == 'aud') {
        if ($type == 'thumbnail') {
          if ($_razuna_flag == FALSE) {
            $_razuna_flag = TRUE;
          }
          $html = $asset['DATA'][0][$key_url];
        }
      }
      return str_replace('/razuna', '', $html);
    }
  }
}
