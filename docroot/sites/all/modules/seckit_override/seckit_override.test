<?php
/**
 * @file
 * Tests for Security Kit module.
 */

/**
 * Functional tests for Security Kit.
 */
class SecKitOverrideBaseTestCase extends DrupalWebTestCase {
  /**
   * Admin user for tests
   * @var object
   */
  protected $admin;

  /**
   * Base settings for SecKit with nothing enabled.
   * @var array
   */
  protected $baseForm;

  /**
   * Base settings for inheritance with everything set to inherit.
   * @var array
   */
  protected $baseInherit;

  /**
   * Implements setUp().
   * @see DrupalWebTestCase::setUp()
   */
  public function setUp() {
    parent::setUp('seckit_override');
    $this->admin = $this->drupalCreateUser(array('administer seckit'));
    $this->drupalLogin($this->admin);

    // Initialize base settings to nothing.
    $this->baseForm = array(
      'seckit_xss[csp][checkbox]'    => TRUE,
      'seckit_xss[csp][default-src]' => '',
      'seckit_xss[csp][script-src]'  => '',
      'seckit_xss[csp][object-src]'  => '',
      'seckit_xss[csp][img-src]'     => '',
      'seckit_xss[csp][media-src]'   => '',
      'seckit_xss[csp][style-src]'   => '',
      'seckit_xss[csp][frame-src]'   => '',
      'seckit_xss[csp][font-src]'    => '',
      'seckit_xss[csp][connect-src]' => '',
      'seckit_xss[csp][report-uri]'  => '',
      'seckit_xss[csp][policy-uri]'  => '',
      'seckit_xss[csp][checkbox]'    => FALSE,
      'seckit_xss[csp][report-only]' => FALSE,
      'seckit_xss[x_xss][select]'    => SECKIT_X_XSS_DISABLE,
      'seckit_xss[x_content_type][checkbox]' => FALSE,
      'seckit_csrf[origin]' => FALSE,
      'seckit_csrf[origin_whitelist]' => '',
      'seckit_clickjacking[x_frame]' => SECKIT_X_FRAME_DISABLE,
      'seckit_clickjacking[x_frame_allow_from]' => '',
      'seckit_clickjacking[js_css_noscript]' => FALSE,
      'seckit_clickjacking[noscript_message]' => 'Sorry, your JavaScript is disabled.',
      'seckit_ssl[hsts]' => FALSE,
      'seckit_ssl[hsts_max_age]' => 0,
      'seckit_ssl[hsts_subdomains]' => 0,
      'seckit_various[from_origin]' => FALSE,
    );

    $this->baseInherit = array(
      'seckit_xss[csp][checkbox]'    => SECKIT_OVERRIDE_INHERIT,
      'seckit_xss[csp][default-src]' => '',
      'seckit_xss[csp][script-src]'  => '',
      'seckit_xss[csp][object-src]'  => '',
      'seckit_xss[csp][img-src]'     => '',
      'seckit_xss[csp][media-src]'   => '',
      'seckit_xss[csp][style-src]'   => '',
      'seckit_xss[csp][frame-src]'   => '',
      'seckit_xss[csp][font-src]'    => '',
      'seckit_xss[csp][connect-src]' => '',
      'seckit_xss[csp][report-uri]'  => '',
      'seckit_xss[csp][policy-uri]'  => '',
      'seckit_xss[csp][checkbox]'    => SECKIT_OVERRIDE_INHERIT,
      'seckit_xss[csp][report-only]' => SECKIT_OVERRIDE_INHERIT,
      'seckit_xss[x_xss][select]'    => SECKIT_OVERRIDE_INHERIT,
      'seckit_xss[x_content_type][checkbox]' => SECKIT_OVERRIDE_INHERIT,
      'seckit_csrf[origin]' => SECKIT_OVERRIDE_INHERIT,
      'seckit_csrf[origin_whitelist]' => '',
      'seckit_clickjacking[x_frame]' => SECKIT_OVERRIDE_INHERIT,
      'seckit_clickjacking[x_frame_allow_from]' => '',
      'seckit_clickjacking[js_css_noscript]' => SECKIT_OVERRIDE_INHERIT,
      'seckit_clickjacking[noscript_message]' => '',
      'seckit_ssl[hsts]' => SECKIT_OVERRIDE_INHERIT,
      'seckit_ssl[hsts_max_age]' => '',
      'seckit_ssl[hsts_subdomains]' => SECKIT_OVERRIDE_INHERIT,
      'seckit_various[from_origin]' => SECKIT_OVERRIDE_INHERIT,
    );

    // Set the defaults.
    $this->drupalPost('admin/config/system/seckit', $this->baseForm, t('Save configuration'));
  }

  /**
   * Create a new rule.
   *
   * @param string $path
   *   The path pattern to add as a new rule.
   * @param bool $report_alert
   *   Flag indicating if an assert should be specified for this insert.
   *
   * @return int
   *   The ID of the added row, or NULL if did not succeed.
   */
  protected function ruleAdd($path, $report_alert = TRUE) {
    $form['new[path]'] = $path;
    $form['new[weight]'] = 0;

    $this->drupalPost('admin/config/system/seckit/override', $form, t('Save'));

    // See if we can get the ID.
    $pattern = '@admin/config/system/seckit/override/edit/(\d+)@';
    $matches = preg_match($pattern, $this->url, $match);

    if ($report_alert) {
      $this->assertTrue(
        $matches,
        format_string('Added override rule for path %path',
          array('%path' => $path))
      );
    }

    return $match[1];
  }

  /**
   * Delete a newly created rule.
   *
   * @param int $rule_id
   *   The ID of the rule to delete.
   * @param bool $report_alert
   *   Flag indicating if an assert should be specified for this insert.
   */
  protected function ruleDelete($rule_id, $report_alert = TRUE) {
    $form = array();
    $this->drupalPost('admin/config/system/seckit/override/delete/' . $rule_id,
      $form, t('Confirm'));

    if ($report_alert) {
      $this->pass(format_string('Deleted rule @rule', array('@rule' => $rule_id)));
    }
  }
}

class SecKitOverrideRuleTestCase extends SecKitOverrideBaseTestCase {
  /**
   * Implements getInfo().
   * @see DrupalWebTestCase::getInfo()
   */
  public static function getInfo() {
    return array(
      'name' => t('Security Kit Override Rule Creation'),
      'description' => t('Tests creating and deleting SecKit Override rules.'),
      'group' => t('Security Kit Overrides'),
    );
  }

  /**
   * Tests basic creation and deletion of a rule.
   */
  public function testCreateRule() {
    $ruleid = $this->ruleAdd($this->randomName());
    $this->ruleDelete($ruleid);
  }
}

class SecKitOverrideCSPTestCase extends SecKitOverrideBaseTestCase {
  /**
   * Implements getInfo().
   * @see DrupalWebTestCase::getInfo()
   */
  public static function getInfo() {
    return array(
      'name' => t('Security Kit Override Content Security Policy'),
      'description' => t('Tests Content Security Policy settings.'),
      'group' => t('Security Kit Overrides'),
    );
  }

  /**
   * Tests disabled Content Security Policy.
   */
  public function testDisabledCSP() {
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $form['seckit_xss[csp][checkbox]'] = FALSE;
    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));
    $this->assertFalse($this->drupalGetHeader('Content-Security-Policy'),
      t('Content Security Policy is disabled (Official).'));
    $this->assertFalse($this->drupalGetHeader('X-Content-Security-Policy'),
      t('Content Security Policy is disabled (Mozilla and IE10).'));
    $this->assertFalse($this->drupalGetHeader('X-WebKit-CSP'),
      t('Content Security Policy is disabled (Chrome and Safari).'));
  }

  /**
   * Tests Content Security Policy with all enabled directives.
   */
  public function testCSPHasAllDirectives() {
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $form = array(
      'seckit_xss[csp][checkbox]'    => TRUE,
      'seckit_xss[csp][default-src]' => '*',
      'seckit_xss[csp][script-src]'  => '*',
      'seckit_xss[csp][object-src]'  => '*',
      'seckit_xss[csp][style-src]'   => '*',
      'seckit_xss[csp][img-src]'     => '*',
      'seckit_xss[csp][media-src]'   => '*',
      'seckit_xss[csp][frame-src]'   => '*',
      'seckit_xss[csp][font-src]'    => '*',
      'seckit_xss[csp][connect-src]' => '*',
      'seckit_xss[csp][report-uri]'  => 'admin/config/system/seckit/csp-report',
    ) + $form;
    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));

    $expected = 'default-src *; script-src *; object-src *; style-src *; img-src *; media-src *; frame-src *; font-src *; connect-src *; report-uri ' . base_path() . 'admin/config/system/seckit/csp-report';
    $this->assertEqual($expected, $this->drupalGetHeader('Content-Security-Policy'),
      t('Content-Security-Policy has all the directves (Official).'));
    $this->assertEqual($expected, $this->drupalGetHeader('X-Content-Security-Policy'),
      t('X-Content-Security-Policy has all the directves (Mozilla and IE10).'));
    $this->assertEqual($expected, $this->drupalGetHeader('X-WebKit-CSP'),
      t('X-WebKit-CSP has all the directves (Chrome and Safari).'));
  }

  /**
   * Tests Content Security Policy with policy-uri directive.
   *
   * In this case, only policy-uri directive should be present.
   */
  public function testCSPPolicyUriDirectiveOnly() {
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $form = array(
      'seckit_xss[csp][checkbox]'    => TRUE,
      'seckit_xss[csp][default-src]' => '*',
      'seckit_xss[csp][script-src]'  => '*',
      'seckit_xss[csp][object-src]'  => '*',
      'seckit_xss[csp][style-src]'   => '*',
      'seckit_xss[csp][img-src]'     => '*',
      'seckit_xss[csp][media-src]'   => '*',
      'seckit_xss[csp][frame-src]'   => '*',
      'seckit_xss[csp][font-src]'    => '*',
      'seckit_xss[csp][connect-src]' => '*',
      'seckit_xss[csp][report-uri]'  => 'admin/config/system/seckit/csp-report',
      'seckit_xss[csp][policy-uri]'  => 'csp.xml',
    ) + $form;
    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));

    $expected = 'policy-uri ' . base_path() . 'csp.xml';
    $this->assertEqual($expected, $this->drupalGetHeader('Content-Security-Policy'),
      t('Content-Security-Policy has only policy-uri (Official).'));
    $this->assertEqual($expected, $this->drupalGetHeader('X-Content-Security-Policy'),
      t('X-Content-Security-Policy has only policy-uri (Mozilla and IE10).'));
    $this->assertEqual($expected, $this->drupalGetHeader('X-WebKit-CSP'),
      t('X-WebKit-CSP has only policy-uri(Chrome and Safari).'));
  }

  /**
   * Tests Content Security Policy with all directives empty.
   *
   * In this case, we should revert back to default values.
   */
  public function testCSPAllDirectivesEmpty() {
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $form = array(
      'seckit_xss[csp][checkbox]'    => TRUE,
      'seckit_xss[csp][default-src]' => '',
      'seckit_xss[csp][script-src]'  => '',
      'seckit_xss[csp][object-src]'  => '',
      'seckit_xss[csp][img-src]'     => '',
      'seckit_xss[csp][media-src]'   => '',
      'seckit_xss[csp][style-src]'   => '',
      'seckit_xss[csp][frame-src]'   => '',
      'seckit_xss[csp][font-src]'    => '',
      'seckit_xss[csp][connect-src]' => '',
      'seckit_xss[csp][report-uri]'  => '',
      'seckit_xss[csp][policy-uri]'  => '',
    ) + $form;
    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));

    $expected = "default-src 'self'; report-uri " . base_path() . "admin/config/system/seckit/csp-report";
    $this->assertEqual($expected, $this->drupalGetHeader('Content-Security-Policy'),
      t('Content-Security-Policy has default directive (Official).'));
    $this->assertEqual($expected, $this->drupalGetHeader('X-Content-Security-Policy'),
      t('X-Content-Security-Policy has default directive (Mozilla and IE10).'));
    $this->assertEqual($expected, $this->drupalGetHeader('X-WebKit-CSP'),
      t('X-WebKit-CSP has default directive (Chrome and Safari).'));
  }

  /**
   * Tests Content Security Policy in report-only mode.
   */
  public function testReportOnlyCSP() {
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $form['seckit_xss[csp][checkbox]'] = TRUE;
    $form['seckit_xss[csp][report-only]'] = TRUE;
    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));

    $this->assertTrue($this->drupalGetHeader('Content-Security-Policy-Report-Only'),
      t('Content Security Policy is in report-only mode (Official).'));
    $this->assertTrue($this->drupalGetHeader('X-Content-Security-Policy-Report-Only'),
      t('Content Security Policy is in report-only mode (Mozilla and IE10).'));
    $this->assertTrue($this->drupalGetHeader('X-WebKit-CSP-Report-Only'),
      t('Content Security Policy is in report-only mode (Chrome and Safari).'));
  }
}

class SecKitOverrideXSSTestCase extends SecKitOverrideBaseTestCase {
  /**
   * Implements getInfo().
   * @see DrupalWebTestCase::getInfo()
   */
  public static function getInfo() {
    return array(
      'name' => t('Security Kit Override XSS Tests'),
      'description' => t('Tests Cross Site Scripting protection settings.'),
      'group' => t('Security Kit Overrides'),
    );
  }

  /**
   * Tests disabled X-XSS-Protection HTTP response header.
   */
  public function testXXSSProtectionIsDisabled() {
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $form['seckit_xss[x_xss][select]'] = SECKIT_X_XSS_DISABLE;
    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));

    $this->assertFalse($this->drupalGetHeader('X-XSS-Protection'),
      t('X-XSS-Protection is disabled.'));
  }

  /**
   * Tests set to 0 X-XSS-Protection HTTP response header.
   */
  public function testXXSSProtectionIs0() {
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $form['seckit_xss[x_xss][select]'] = SECKIT_X_XSS_0;
    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));

    $this->assertEqual(0, $this->drupalGetHeader('X-XSS-Protection'),
      t('X-XSS-Protection is set to 0.'));
  }

  /**
   * Tests set to 1; mode=block X-XSS-Protection HTTP response header.
   */
  public function testXXSSProtectionIs1() {
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $form['seckit_xss[x_xss][select]'] = SECKIT_X_XSS_1;
    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));

    $this->assertEqual('1; mode=block', $this->drupalGetHeader('X-XSS-Protection'),
      t('X-XSS-Protection is set to 1; mode=block.'));
  }

  /**
   * Tests disabled X-Content-Type-Options HTTP response header.
   */
  public function testDisabledXContentTypeOptions() {
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $form['seckit_xss[x_content_type][checkbox]'] = FALSE;
    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));

    $this->assertFalse($this->drupalGetHeader('X-Content-Type-Options'),
      t('X-Content-Type-Options is disabled.'));
  }

  /**
   * Tests enabled X-Content-Type-Options HTTP response header.
   */
  public function testEnabledXContentTypeOptions() {
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $form['seckit_xss[x_content_type][checkbox]'] = TRUE;
    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));

    $this->assertEqual('nosniff', $this->drupalGetHeader('X-Content-Type-Options'),
      t('X-Content-Type-Options is enabled and set to nosniff.'));
  }
}

class SecKitOverrideCSRFTestCase extends SecKitOverrideBaseTestCase {
  /**
   * Implements getInfo().
   * @see DrupalWebTestCase::getInfo()
   */
  public static function getInfo() {
    return array(
      'name' => t('Security Kit Override CSRF Tests'),
      'description' => t('Tests CSRF settings.'),
      'group' => t('Security Kit Overrides'),
    );
  }

  /**
   * Tests HTTP Origin allows requests from the site.
   */
  public function testOriginAllowsSite() {
    global $base_root;
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $form['seckit_csrf[origin]'] = TRUE;
    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));

    $this->drupalPost('admin/config/system/seckit', array(), t('Save configuration'),
      array(), array('Origin: ' . $base_root));
    $this->assertResponse(200,
      t('Request from %base_root is allowed.', array('%base_root' => $base_root)));
  }

  /**
   * Tests HTTP Origin allows requests from the specified source.
   */
  public function testOriginAllowsSpecifiedSource() {
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $form = array(
      'seckit_csrf[origin]' => TRUE,
      'seckit_csrf[origin_whitelist]' => 'http://www.example.com',
    ) + $form;

    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));

    $this->drupalPost('admin/config/system/seckit', array(), t('Save configuration'),
      array(), array('Origin: http://www.example.com'));
    $this->assertResponse(200,
      t('Whitelisted request is allowed.'));
  }

  /**
   * Tests HTTP Origin denies request.
   */
  public function testOriginDeny() {
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $form['seckit_csrf[origin]'] = TRUE;
    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));

    $form = array();
    $this->drupalPost('admin/config/system/seckit', $form, t('Save configuration'),
      array(), array('Origin: http://www.example.com'));
    $this->assertEqual(array(), $_POST,
      t('POST is empty.'));

    // This test will fail on the testbot because localhost is always allowed.
    // So skip it if localhost.
    if (in_array(ip_address(), array('localhost', '127.0.0.1', '::1'), TRUE)) {
      return;
    }

    $this->assertResponse(403,
      t('Request is denied.'));
  }
}

class SecKitOverrideClickjackingTestCase extends SecKitOverrideBaseTestCase {
  /**
   * Implements getInfo().
   * @see DrupalWebTestCase::getInfo()
   */
  public static function getInfo() {
    return array(
      'name' => t('Security Kit Override Clickjack protection'),
      'description' => t('Tests clickjack protection settings.'),
      'group' => t('Security Kit Overrides'),
    );
  }

  /**
   * Tests disabled X-Frame-Options HTTP response header.
   */
  public function testXFrameOptionsIsDisabled() {
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $form['seckit_clickjacking[x_frame]'] = SECKIT_X_FRAME_DISABLE;
    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));

    $this->assertFalse($this->drupalGetHeader('X-Frame-Options'),
      t('X-Frame-Options is disabled.'));
  }

  /**
   * Tests set to SameOrigin X-Frame-Options HTTP response header.
   */
  public function testXFrameOptionsIsSameOrigin() {
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $form['seckit_clickjacking[x_frame]'] = SECKIT_X_FRAME_SAMEORIGIN;
    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));

    $this->assertEqual('SameOrigin', $this->drupalGetHeader('X-Frame-Options'),
      t('X-Frame-Options is set to SameOrigin.'));
  }

  /**
   * Tests set to Deny X-Frame-Options HTTP response header.
   */
  public function testXFrameOptionsIsDeny() {
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $form['seckit_clickjacking[x_frame]'] = SECKIT_X_FRAME_DENY;
    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));

    $this->assertEqual('Deny', $this->drupalGetHeader('X-Frame-Options'),
      t('X-Frame-Options is set to Deny.'));
  }

  /**
   * Tests set to Allow-From X-Frame-Options HTTP response header.
   */
  public function testXFrameOptionsIsAllowFrom() {
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $form['seckit_clickjacking[x_frame]'] = SECKIT_X_FRAME_ALLOW_FROM;
    $form['seckit_clickjacking[x_frame_allow_from]'] = 'http://www.google.com';
    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));

    $this->assertEqual('Allow-From: http://www.google.com', $this->drupalGetHeader('X-Frame-Options'),
      t('X-Frame-Options is set to Allow-From.'));
  }

  /**
   * Tests JS + CSS + Noscript protection.
   */
  public function testJSCSSNoscript() {
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $msg = 'Please Enable JavaScript.';
    $form['seckit_clickjacking[js_css_noscript]'] = TRUE;
    $form['seckit_clickjacking[noscript_message]'] = $msg;
    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));

    $this->assertRaw($msg,
      t('JavaScript + CSS + Noscript protection is loaded.'));
  }
}

class SecKitOverrideHSTSTestCase extends SecKitOverrideBaseTestCase {
  /**
   * Implements getInfo().
   * @see DrupalWebTestCase::getInfo()
   */
  public static function getInfo() {
    return array(
      'name' => t('Security Kit Override SSL protection'),
      'description' => t('Tests SSL protection settings.'),
      'group' => t('Security Kit Overrides'),
    );
  }

  /**
   * Tests disabled HTTP Strict Transport Security.
   */
  public function testDisabledHSTS() {
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $form['seckit_ssl[hsts]'] = FALSE;
    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));

    $this->assertFalse($this->drupalGetHeader('Strict-Transport-Security'),
      t('HTTP Strict Transport Security is disabled.'));
  }

  /**
   * Tests HTTP Strict Transport Security has all directives.
   */
  public function testHSTSAllDirectves() {
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $form = array(
      'seckit_ssl[hsts]' => TRUE,
      'seckit_ssl[hsts_max_age]' => 1000,
      'seckit_ssl[hsts_subdomains]' => 1,
    ) + $form;
    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));

    $expected = 'max-age=1000; includeSubDomains';
    $this->assertEqual($expected, $this->drupalGetHeader('Strict-Transport-Security'),
      t('HTTP Strict Transport Security has all the directives.'));
  }
}

class SecKitOverrideFromOriginTestCase extends SecKitOverrideBaseTestCase {
  /**
   * Implements getInfo().
   * @see DrupalWebTestCase::getInfo()
   */
  public static function getInfo() {
    return array(
      'name' => t('Security Kit Override Misc protections'),
      'description' => t('Tests other protection settings.'),
      'group' => t('Security Kit Overrides'),
    );
  }

  /**
   * Tests disabled From-Origin.
   */
  public function testDisabledFromOrigin() {
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $form['seckit_various[from_origin]'] = FALSE;
    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));

    $this->assertFalse($this->drupalGetHeader('From-Origin'),
      t('From-Origin is disabled.'));
  }

  /**
   * Tests enabled From-Origin.
   */
  public function testEnabledFromOrigin() {
    $path = 'admin/config/system/seckit*';
    $id = $this->ruleAdd($path, FALSE);

    $form = $this->baseInherit;
    $form['path'] = $path;

    $form = array(
      'seckit_various[from_origin]' => TRUE,
      'seckit_various[from_origin_destination]' => 'same',
    ) + $form;
    $this->drupalPost('admin/config/system/seckit/override/edit/' . $id,
      $form, t('Save configuration'));

    $this->assertEqual('same', $this->drupalGetHeader('From-Origin'),
      t('From-Origin is enabled and set to same.'));
  }
}
