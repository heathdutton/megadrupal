<?php
/**
 * @file
 * Adds an Addtoany share widget
 *
 */

/**
  * Implements hook_menu().
  */
function external_iframe_share_menu() {
  $items['admin/config/externaliframe/addtoany'] = array(
    'title' => 'External iFrame Addtoany Settings',
    'access arguments' => array('administer external iframe'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('external_iframe_share_admin'),
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
  * Configuration Form
  */
function external_iframe_share_admin($form, &$form_state) {
  $form = array();
  $form['share_widget'] = array(
    '#type' => 'fieldset',
    '#title' => t('External Iframe Share Widget Settings'),
    '#description' => t('Choose what kind of button to display in the header of external iframes'),
  );
  $variables = array(
    'default' => _external_iframe_share_img_variable('default'),
    'small' => _external_iframe_share_img_variable('small'),
    'minimal' => _external_iframe_share_img_variable('minimal'),
    'large' => _external_iframe_share_img_variable('large'),
  );
  $options = array();
  foreach ($variables as $key => $value) {
    $options[$key] = theme_image($value);
  }
  $form['share_widget']['external_iframe_share_style'] = array(
    '#title' => t('Addtoany button type'),
    '#type' => 'radios',
    '#options' => $options,
    '#default_value' => variable_get('external_iframe_share_style', 'default'),
  );

  return system_settings_form($form);
}

/**
  * Implements hook_preprocess_page().
  */
function external_iframe_share_preprocess_page(&$variables) {
  if (arg(0) == 'external') {
    // find url and check if https argument present
    $widget_type = variable_get('external_iframe_share_style', 'default');
    $variables['external_iframe_share_button'] = theme('share_button', array('type' => $widget_type));
  }
}

/**
 * Helper function to return $variables for theme_image()
 */
function _external_iframe_share_img_variable($type = 'default') {
  switch ($type) {
    case 'default':
      $variables = array(
        'path' => 'http://static.addtoany.com/buttons/share_save_171_16.png',
        'width' => '171',
        'height' => '16',
        'alt' => t('Share'),
        'attributes' => array(),        
      );
      break;
    case 'small':
      $variables = array(
        'path' => 'http://static.addtoany.com/buttons/share_save_120_16.gif',
        'width' => '120',
        'height' => '16',
        'alt' => t('Share'),
        'attributes' => array(),    
      );
      break;
    case 'minimal':
      $variables = array(
        'path' => 'http://static.addtoany.com/buttons/favicon.png',
        'width' => '16',
        'height' => '16',
        'alt' => t('Share'),
        'attributes' => array(),        
      );        
      break;
    case 'large':
      $variables = array(
        'path' => 'http://static.addtoany.com/buttons/share_save_256_24.png',
        'width' => '256',
        'height' => '24',
        'alt' => t('Share'),
        'attributes' => array(),    
      );
      break;
  }
  return $variables;
}

/**
  * Implements hook_theme().
  */
function external_iframe_share_theme() {
  return array(
    'share_button' => array(
      'variables' => array('type' => 'default'),
    ),
  );
}

/**
 * Theme function to return share button
 */
function theme_share_button($variables) {
  $type = $variables['type'];
  $img_variables = _external_iframe_share_img_variable($type);
  $img = theme_image($img_variables);
  $linkname = t('Shared link from @sitename', array('@sitename' => variable_get('site_name', '')));
  $script = 'a2a_config = { linkname: "' . $linkname . '", linkurl: "' . $_GET['url'] . '"};';
  drupal_add_js($script, 'inline');
  return l($img, 'http://www.addtoany.com/share_save', array('attributes' => array('class' => 'a2a_dd'), 'html' => TRUE));
}
