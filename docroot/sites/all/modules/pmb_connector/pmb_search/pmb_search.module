<?php

/**
 * @file
 * PMB search module.
 */

require_once(drupal_get_path('module', 'pmb') . '/pmb.class_data.inc');

/**
 * Implements hook_permission().
 */
function pmb_search_permission() {
  return array(
    'PMB search catalog' => array(
      'title' => t('Search in a local catalog'),
    ),
    'PMB search external' => array(
      'title' => t('Search in external catalogs'),
    ),
    'PMB search aggregate' => array(
      'title' => t('Aggregate searches in local and external catalogs'),
    ),
    'PMB search advanced' => array(
      'title' => t('Use advanced search'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function pmb_search_menu() {
  $items = array();

  $items['catalog'] = array(
    'title' => 'Catalog',
    'description' => 'Search the catalog',
    'page callback' => 'pmb_search_base',
    'access arguments' => array('PMB search catalog'),
    'file' => 'pmb_search.api.inc',
    'menu_name' => pmb_variable_get('pmb_menu_attach_search'),
    'type' => MENU_NORMAL_ITEM,
  );
  $items['catalog/search/local'] = array(
    'title' => 'Local catalog',
    'description' => 'Search the local catalog',
    'page callback' => 'pmb_search_base',
    'access arguments' => array('PMB search catalog'),
    'file' => 'pmb_search.api.inc',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'weight' => 1,
  );
  $items['catalog/search/external'] = array(
    'title' => 'External catalog',
    'description' => 'Search the external catalog',
    'page callback' => 'pmb_search_external',
    'access arguments' => array('PMB search external'),
    'file' => 'pmb_search.api.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 2,
  );
  $items['catalog/search/advanced'] = array(
    'title' => 'Advanced search',
    'description' => 'Advanced search in the catalog',
    'page callback' => 'pmb_search_advanced',
    'access arguments' => array('PMB search advanced'),
    'file' => 'pmb_search.api.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 3,
  );
  $items['catalog/search/local/%/%'] = array(
    'title' => 'Search the catalog',
    'description' => 'Search the catalog',
    'page callback' => 'pmb_search_base_result',
    'page arguments' => array(3, 4),
    'access arguments' => array('PMB search catalog'),
    'file' => 'pmb_search.api.inc',
    'type' => MENU_NORMAL_ITEM,
    'hidden' => 1,
  );

  $items['catalog/search/external/%/%/%'] = array(
    'title' => 'Search the external catalog',
    'description' => 'Search the external catalog',
    'page callback' => 'pmb_search_external_result',
    'page arguments' => array(3, 4, 5),
    'access arguments' => array('PMB search external'),
    'file' => 'pmb_search.api.inc',
    'type' => MENU_NORMAL_ITEM,
    'hidden' => 1,
  );
  $items['catalog/search/advanced/result'] = array(
    'page callback' => 'pmb_search_advanced_result',
    'access arguments' => array('PMB search advanced'),
    'file' => 'pmb_search.api.inc',
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implements hook_theme().
 */
function pmb_search_theme() {
  return array(
    'pmb_search_base_form' => array(
      'render element' => 'form',
    ),
    'pmb_search_external_form' => array(
      'render element' => 'form',
    ),
    'pmb_search_advanced_form' => array(
      'render element' => 'form',
    ),
    'pmb_search_base_result' => array(
      'variables' => array(
        'search_terms' => NULL,
        'search_fields' => NULL,
        'notices' => NULL,
        'parameters' => NULL,
      ),
      'file' => 'pmb_search.templates.inc',
    ),
    'pmb_search_external_result' => array(
      'variables' => array(
        'search_terms' => NULL,
        'search_sources' => NULL,
        'search_fields' => NULL,
        'notices' => NULL,
        'parameters' => NULL,
      ),
      'file' => 'pmb_search.templates.inc',
    ),
  );
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Extends PMB admin configuration with search display settings.
 *
 * @ingroup forms
 * @see pmb_admin_form()
 * @see pmb_search_admin_form()
 */
function pmb_search_form_pmb_admin_form_alter(&$form, &$form_state) {
  require_once(drupal_get_path('module', 'pmb_search') . '/pmb_search.admin.inc');
  $form['tab'] = array_merge_recursive($form['tab'], pmb_search_admin_form());
}

/**
 * Implements hook_block_info().
 */
function pmb_search_block_info() {
  $blocks['search'] = array(
    'info' => t('Search the catalog'),
    'cache' => DRUPAL_NO_CACHE,
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function pmb_search_block_view($delta) {
  global $user;

  if (user_access('PMB search catalog', $user)) {
    include_once(drupal_get_path('module', 'pmb_search') . '/pmb_search.forms.inc');
    $block = array(
      'subject' => t('Search the catalog'),
      'content' => drupal_get_form('pmb_search_block_form'),
    );
  }
  else {
    $block = array(
      'subject' => t('Search the catalog'),
      'content' => t("You don't have the permissions to search the catalog."),
    );
  }

  return $block;
}
