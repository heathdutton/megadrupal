<?php
/**
 * @file
 * File contains functionality to notify someone when currency conversion fails.
 */

/**
 * Implements hook_menu().
 */
function notifier_scc_menu() {
  $items['admin/config/regional/simplecurrencyconverter/notifier'] = array(
    'title' => 'Simple Currency Converter',
    'description' => 'Notifier',
    'access callback' => 'user_access',
    'access arguments' => array('simplecurrencyconverter administer'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('notifier_scc_admin_form'),
    'file' => 'notifier_scc.admin.inc',
    'type' => MENU_LOCAL_TASK,
  );

  return $items;
}

/**
 * Notify callback.
 */
function notifier_scc_notify($data) {
  $subject = 'Simple Currency Converter primary feed down using secondary';
  $body[] = 'Secondary feed responded with:';
  $body[] = 'From: ' . $data['from_currency'];
  $body[] = 'From: ' . $data['to_currency'];
  $body[] = 'Ratio: ' . $data['feed'];
  $body = implode("\n", $body);

  notifier_scc_alert_admin($subject, $body);
}

/**
 * Notification for when currency check fails.
 */
function notifier_scc_alert_admin($subject, $body) {
  $notifier_scc_email = variable_get('notifier_scc_email', '');
  $time_interval = variable_get('notifier_scc_email_time', 3600);
  $last_sent = variable_get('notifier_scc_email_time_last_sent', 0);

  if ($notifier_scc_email && time() > ($last_sent + $time_interval)) {
    notifier_scc_send_admin_mail($subject, $body);
    variable_set('notifier_scc_email_time_last_sent', time());
  }
}

/**
 * Notification callback.
 */
function notifier_scc_send_admin_mail($subject, $body) {
  $module = 'notifier_scc';
  $mail_token = 'admin_email';
  $from = variable_get('site_mail', '');
  $message = array(
    'id' => $module . '_' . $mail_token,
    'to' => variable_get('notifier_scc_email', ''),
    'subject' => $subject,
    'body' => $body,
    'headers' => array(
      'From' => $from,
      'Sender' => $from,
      'Return-Path' => $from,
    ),
  );

  $system = drupal_mail_system($module, $mail_token);
  return $system->mail($message);
}
