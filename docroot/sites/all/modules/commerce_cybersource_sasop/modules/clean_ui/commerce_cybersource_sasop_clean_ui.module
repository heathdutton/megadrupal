<?php

/**
 * @file
 * Implements a simplified payment form for the Commerce Cybersource SASOP
 *   module.
 */

/**
 * Implements hook_form_FORM_ID_alter().
 */
function commerce_cybersource_sasop_clean_ui_form_commerce_cybersource_sasop_redirect_form_alter(&$form, &$form_state, $form_id) {
  global $user;

  // Get order object
  $order = $form_state['build_info']['args'][0];
  $order_wrapper = entity_metadata_wrapper('commerce_order', $order);
  $billing_info = $order_wrapper->commerce_customer_billing->value();
  $address_info = $billing_info->commerce_customer_address[LANGUAGE_NONE][0];

  // Create text version of the address info to be submitted.
  $address = array();
  if (isset($address_info['first_name']) && isset($address_info['last_name'])) {
    $address[] = $address_info['first_name'] . " " . $address_info['last_name'];
  }
  if (isset($address_info['organisation_name'])) {
    $address[] = $address_info['organisation_name'];
  }
  if (isset($address_info['thoroughfare'])) {
    $address[] = $address_info['thoroughfare'];
  }
  if (isset($address_info['premise']) && (trim($address_info['premise']) != '')) {
    $address[] = $address_info['premise'];
  }
  if (isset($address_info['sub_premise'])) {
    $address[] = $address_info['sub_premise'];
  }
  if (isset($address_info['locality'])) {
    $address[] = $address_info['locality'];
  }
  if (isset($address_info['dependent_locality'])) {
    $address[] = $address_info['dependent_locality'];
  }
  if (isset($address_info['administrative_area'])) {
    $address[] = $address_info['administrative_area'];
  }
  if (isset($address_info['sub_administrative_area'])) {
    $address[] = $address_info['sub_administrative_area'];
  }
  if (isset($address_info['country'])) {
    $address[] = $address_info['country'];
  }
  if (isset($address_info['postal_code'])) {
    $address[] = $address_info['postal_code'];
  }
  $address_text = '<label>' . t('Billing Address') . '</label>';
  $address_text .= implode('<br />', $address);
  $form['address_text'] = array(
    '#markup' => $address_text,
    '#weight' => -10,
    '#prefix' => '<div class="form-item form-item-address-text">',
    '#suffix' => '</div>',
  );

  // Hide billing fields.
  $form['bill_to_forename']['#type'] = 'hidden';
  $form['bill_to_surname']['#type'] = 'hidden';
  if (isset($form['bill_to_company_name'])) {
    $form['bill_to_company_name']['#type'] = 'hidden';
  }
  $form['bill_to_email']['#type'] = 'hidden';
  $form['bill_to_address_line1']['#type'] = 'hidden';
  $form['bill_to_address_line2']['#type'] = 'hidden';
  $form['bill_to_address_city']['#type'] = 'hidden';
  if (isset($form['bill_to_address_state'])) {
    $form['bill_to_address_state']['#type'] = 'hidden';
  }
  $form['bill_to_address_country']['#type'] = 'hidden';
  if (isset($form['bill_to_address_postal_code'])) {
    $form['bill_to_address_postal_code']['#type'] = 'hidden';
  }

  // Make remaining fields required.
  $form['card_type']['#required'] = TRUE;
  $form['card_type']['#required'] = TRUE;
  $form['card_number']['#required'] = TRUE;
  $form['card_expiry_date']['#required'] = TRUE;
  $form['card_cvn']['#required'] = TRUE;
  $form['bill_to_phone']['#required'] = TRUE;

  // Set field weights.
  $form['card_type']['#weight'] = -40;
  $form['card_type']['#weight'] = -35;
  $form['card_number']['#weight'] = -30;
  $form['card_expiry_date']['#weight'] = -25;
  $form['card_cvn']['#weight'] = -20;
  $form['bill_to_phone']['#weight'] = -15;

  // Shrink phone field to max allowed by Cybersource.
  $form['bill_to_phone']['#maxlength'] = 15;
  $form['bill_to_phone']['#size'] = 15;
}

