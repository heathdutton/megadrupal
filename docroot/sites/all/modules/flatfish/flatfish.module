<?php
/**
 * @file
 *
 * Sets up hooks to use Migrate and ctools.
 *
 * Load YAML config which will be used to automatically register our
 * custom Migration classes.
 */

/*
 * Implements hook_migrate_api()
 */
function flatfish_migrate_api() {
  $api = array(
    'api' => 2,
  );
  return $api;
}

/**
 * Implements of hook_ctools_plugin_api().
 *
 */
function flatfish_ctools_plugin_api($owner, $api) {
  if ($owner == 'flatfish' && $api == 'default_flatfish_configs') {
    return array('version' => 1);
  }
}

/**
 * Implements of hook_ctools_plugin_directory().
 *
 * Tells ctools where to find our files for the admin settings
 *
 * !IMPORTANT!
 */
function flatfish_ctools_plugin_directory($module, $type) {
  if ($type =='export_ui') {
    return 'plugins/export_ui';
  }
}

/**
 * Implementation of hook_default_flatfish_config().
 *
 * Loads our YAML for ctools ui.
 *
 * !IMPORTANT!
 * 
 */
function flatfish_default_flatfish_config() {
  // TODO make $base config, add in error handling for spyc and missing/bad YAML
  // TODO ALSO FIX THE RATS' NEST OF CONFIG
  $base = 'sites/all/flatfish_migrations';

  if ($path = libraries_get_path('spyc')) {
    require_once $path . '/spyc.php';
  }

  $settings = Spyc::YAMLLoad($base . '/config.yml');
  $schema = Spyc::YAMLLoad($base . '/schema.yml');

  if (!file_exists($base . '/config.yml')) {
    dpm("The config.yml file is required.  Cannot find it at {$base}/config.yml.", NULL, 'error');
    return '';
  }
  if (!isset($settings['types'])) {
    dpm("It does not look like your config.yml file has the correct syntax.", NULL, 'error');
    return '';
  }

  $settings['types']['Flatfish'] = Array(); // temporary hack for media, TODO FIX THIS
  foreach ($settings['types'] as $type => $values) {
    $config[$type] = (object)array(
      'machine_name' => $type,
      'description' => '',
      'api_version' => 1,
      'disabled' => FALSE,
      'config' => array(
        'driver' => 'mysql',
        'database' => $settings['db'],
        'username' => $settings['db_user'],
        'password' => $settings['db_pass'],
        'host' => isset($settings['db_host']) ? $settings['db_host'] : 'localhost',
        'prefix' => isset($settings['db_prefix']) ? $settings['db_prefix'] : '',
      ));
    foreach ($schema['schema'] as $k => $v) {
      if ($k == $type) {
        $config[$type]->config[$type] = array(
          'machine_name' => $v['machine_name'],
          'fields' => $v['fields'],
          'primary key' => $v['primary key'],
        );
      }
    }
  }

  
  return $config; // !IMPORTANT! 
}
