<?php

/**
 * @file
 * Installation functions for the couchbase module.
 * 
 * Copyright (c) 2011-2012 DOCOMO Innovations, Inc.
 * 
 */

/**
 * Implements hook_requirements().
 */
function couchbase_requirements($phase) {
  $requirements = array();
  $t = get_t();
  
  $couchbase = extension_loaded('couchbase');
  if ($phase == 'install' || $phase == 'runtime') {
    if (!$couchbase) {
      $requirements['couchbase']['severity'] = REQUIREMENT_ERROR;
      $requirements['couchbase']['title'] = $t('Couchbase extension not available');
      $requirements['couchbase']['value'] = $t('<a href="http://www.couchbase.com/develop/php/next">Couchbase</a> extensions must be installed in order to use Couchbase module.');
    }    
  }
  if ($phase == 'runtime') {
    if (!$couchbase) {
      $requirements['couchbase']['severity'] = REQUIREMENT_ERROR;
      $requirements['couchbase']['title'] = $t('Couchbase extension not available');
      $requirements['couchbase']['value'] = $t('<a href="http://www.couchbase.com/develop/php/next">Couchbase</a> extensions must be installed in order to use Couchbase module.');
    }
    
    // loop the connections and make sure they are ok
    $connections = variable_get('couchbase', array());
    foreach ($connections as $key => $value) {
      try {
        $cb_obj = couchbase_admin($key)->getPool();
        $requirements['couchbase_' . $key] = array(
        	'severity' => REQUIREMENT_OK,
          'title' => $t('Couchbase Connection Status'),
          'value' => $t('Data Bucket @bucket connecting ok', array('@bucket' => $key)),
        );
      }
      catch (CouchbaseRestException $e) {
        $requirements['couchbase_' . $key] = array(
        	'severity' => REQUIREMENT_ERROR,
        	'title' => $t('Couchbase Connection Status'),
        	'value' => $t('Data Bucket ' . $key . ' not connecting'),
        );
      }
    }
  }
  return $requirements;
}
