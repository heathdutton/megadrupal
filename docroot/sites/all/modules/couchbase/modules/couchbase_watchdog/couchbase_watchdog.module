<?php

/**
 * @file
 * Couchbase watchdog module
 * 
 * Copyright (c) 2011-2012 DOCOMO Innovations, Inc.
 */

define ('COUCHBASE_WATCHDOG_PER_PAGE', 50);
define ('COUCHBASE_WATCHDOG_DB', 'drupal_watchdog');

/**
 * Implements hook_menu().
 */
function couchbase_watchdog_menu() {
  $items['admin/reports/couchbase-watchdog'] = array(
    'title' => 'Recent Couchbase log entries',
    'description' => 'View events that have been logged in Couchbase',
    'page callback' => 'couchbase_watchdog_list',
    'access arguments' => array('access site reports'),
    'file' => 'couchbase_watchdog.admin.inc',
  );
  
  $items['admin/reports/couchbase-watchdog/%'] = array(
    'title' => 'Couchbase Log Details',
    'page callback' => 'couchbase_watchdog_detail',
    'page arguments' => array(3),
    'access arguments' => array('access site reports'),
    'type' => MENU_CALLBACK,
    'file' => 'couchbase_watchdog.admin.inc',
  );
  return $items;
}

/**
 * Implements hook_watchdog().
 */
function couchbase_watchdog_watchdog(array $log_entry) {
  // massage the user
  $account = $log_entry['user'];
  unset($log_entry['user']);
  $log_entry['user'] = array('name' => isset($account->name) ? $account->name : variable_get('anonymous', t('Anonymous')), 'uid' => $account->uid);
  
  try {
    $cb = couchbase('default', COUCHBASE_WATCHDOG_DB);
    // Get a unique id from couchbase
    $cb_rest = couchbase_rest();
    $uuids = $cb_rest->getUUIDS();  //TODO: don't like this too much
    $cb->set($uuids['uuids'][0], json_encode($log_entry));
  }
  catch (Exception $e) {
    drupal_set_message(check_plain('Error occured while connecting to Couchbase ' . $e), 'error');
  }
}
