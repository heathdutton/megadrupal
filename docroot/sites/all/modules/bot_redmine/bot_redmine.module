<?php

/**
 * @file
 * Enables various project toolkit compatible actions.
 */

/**
 * Listen for URLs or a numerical ID and respond with information about it.
 *
 * @param $data
 *   The regular $data object prepared by the IRC library.
 * @param $from_query
 *   Boolean; whether this was a queried request.
 */
function bot_redmine_irc_msg_channel($data, $from_query = FALSE) {
  $to = $from_query ? $data->nick : $data->channel;

  // ======================================================================== */
  // if Redmine issue lookups are enabled...                                  */
  // ======================================================================== */
  if (variable_get('bot_redmine_enable', FALSE)) {
    $tickets_to_scrape = array();

    if (preg_match('/([r#])(\d+)/', $data->message, $url_matches)) {
      $num = $url_matches[2];
      if (is_numeric($num)) {
        $tickets_to_scrape[] = check_plain($num);
      }
    }

    // retrieve each desired URL.
    foreach ($tickets_to_scrape as $ticket) {
      $ticket_result = redmine_rest_api_call('issues/' . $ticket);
      if ($ticket_result->code == '200') {
        if (isset($ticket_result->decoded_data->issue->subject) && !empty($ticket_result->decoded_data->issue->subject)) {
          $ticket_url = '';
          if ($redmine_base_url = variable_get('redmine_rest_api_redmine_base_url', FALSE)) {
            $ticket_url = ' â€“ ' . $redmine_base_url . '/issues/' . $ticket;
          }
          $ticket_title = decode_entities($ticket_result->decoded_data->issue->subject);
          $project_name = '';
          if (isset($ticket_result->decoded_data->issue->project->name) && !empty($ticket_result->decoded_data->issue->project->name)) {
            $project_name = '[' . decode_entities($ticket_result->decoded_data->issue->project->name) . '] ';
          }
          $message = '#' . $ticket . ' ' . $project_name . $ticket_title . $ticket_url;
          bot_message($to, $message);
        }
      }
    }
  }
}

/**
 * All responses are available via a query.
 */
function bot_redmine_irc_msg_query($data) {
  bot_redmine_irc_msg_channel($data, TRUE);
}

/**
 * Configures the project toolkit features.
 */
function bot_redmine_form_redmine_rest_api_admin_configure_alter(&$form, &$form_state, $form_id) {
  $form['bot_redmine_enable'] = array(
    '#default_value' => variable_get('bot_redmine_enable', FALSE),
    '#title'         => t('Enable Redmine lookups from the IRC bot'),
    '#type'          => 'checkbox',
  );
}
