<?php

define("CLOUD_DASHBOARD_API_BASE_URL", "https://cloudapi.acquia.com/v1/");

/**
 * Implements hook_menu().
 */
function acquia_cloud_simple_varnish_flush_menu() {

  $items['admin/config/system/acquia-cloud-simple-flush'] = array(
    'title' => 'Acquia Cloud Simple Varnish Flush Settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('acquia_cloud_simple_varnish_flush_settings'),
    'access arguments' => array('administer site configuration'),
    'file' => 'acquia_cloud_simple_varnish_flush.admin.inc',
  );
  return $items;
}

/**
 * Helper function that makes the curl calls (POST).
 * Taken from Acquia Cloud Dashboard Module - @ https://www.drupal.org/project/acquia_cloud_dashboard
 */
function acquia_cloud_simple_varnish_flush_curl_caller_post($method, $request = "POST", $binary = FALSE, $post_data = array(), $params = array()) {
  $url = CLOUD_DASHBOARD_API_BASE_URL . $method . ".json";

  if (count($params)) {
    $url .= "?";
    foreach ($params as $key => $value) {
      $en_key = urlencode($key);
      $en_val = urlencode($value);
      $url .= ("$en_key=$en_val&");
    }
  }
  $username = variable_get('acquia_cloud_simple_varnish_flush_username', "");
  $password = variable_get('acquia_cloud_simple_varnish_flush_password', "");
  $ch = curl_init();

  curl_setopt($ch, CURLOPT_USERPWD, "$username:$password");
  // Set the url, number of POST vars, POST data.
  curl_setopt($ch, CURLOPT_URL, $url);
  curl_setopt($ch, CURLOPT_POST, 0);
  curl_setopt($ch, CURLOPT_POSTFIELDS, drupal_json_encode($post_data));
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
  curl_setopt($ch, CURLOPT_CUSTOMREQUEST, $request);
  if ($binary) {
    curl_setopt($ch, CURLOPT_BINARYTRANSFER, TRUE);
  }

  curl_exec($ch);
  curl_close($ch);
  drupal_set_message(t('Command Sent to Cloud API'));
}

/**
 * Helper function to flush Varnish caches.
 */
function acquia_cloud_simple_varnish_flush_cc_all() {
  if (isset($_ENV['AH_SITE_ENVIRONMENT'])) {
    acquia_cloud_simple_varnish_flush_curl_caller_post("sites/" . $_ENV['AH_SITE_GROUP'] . "/envs/" . $_ENV['AH_SITE_ENVIRONMENT'] . "/domains/" . $_SERVER['HTTP_HOST'] . "/cache", "DELETE");
    drupal_set_message(t("Sent Request to Acquia Cloud to purge all varnish caches."));
  }
  else {
    drupal_set_message(t("Not clearing Varnish cache since current site instance is not on Acquia Cloud"), "warning");
  }
}

/**
 * Implements hook_node_insert().
 */
function acquia_cloud_simple_varnish_flush_node_insert($node) {
  acquia_cloud_simple_varnish_flush_cc_all();
}

/**
 * Implements hook_node_update().
 */
function acquia_cloud_simple_varnish_flush_node_update($node) {
  acquia_cloud_simple_varnish_flush_cc_all();
}

/**
 * Implements hook_taxonomy_term_update().
 */
function acquia_cloud_simple_varnish_flush_taxonomy_term_update($term) {
  acquia_cloud_simple_varnish_flush_cc_all();
}

/**
 * Implements hook_taxonomy_term_insert().
 */
function acquia_cloud_simple_varnish_flush_taxonomy_term_insert($term) {
  acquia_cloud_simple_varnish_flush_cc_all();
}
