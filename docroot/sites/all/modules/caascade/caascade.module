<?php

/**
 * Implements hook_init().
 */
function caascade_init()
{
  $module_path = drupal_get_path('module', 'caascade');
  $caascade_id = variable_get('caascade_id', '');
  $recaptcha_theme = variable_get('caascade_recaptcha_theme', 'red');
  $pubkey = variable_get('caascade_recaptcha_publickey', '');
  $override_css = $module_path . '/html/override/caascade.css';
  $override_js = $module_path . '/html/override/caascade.js';
  if(is_file($override_css))
  {
    # override default css
    drupal_add_css($override_css); 
  }
  else
  {
    drupal_add_css($module_path . '/caascade.css');
  }
  drupal_add_js('https://www.google.com/recaptcha/api/js/recaptcha_ajax.js', array('type' => 'external'));
  drupal_add_js(array('caascade' => array('id' => $caascade_id, 'recaptcha_pubkey' => $pubkey, 'recaptcha_theme' => $recaptcha_theme)), array('type' => 'setting'));
  if(is_file($override_js))
  {
    # override default js
    drupal_add_js($override_js, array('scope' => 'footer'));
  }
  else
  {
    drupal_add_js($module_path . '/caascade.js', array('scope' => 'footer'));
  }
}

/**
 * Implements hook_menu().
 */
function caascade_menu() {
  $items['admin/config/services/caascade'] = array(
    'title' => 'Caascade',
    'description' => 'Caascade numeric ID and other settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('caascade_admin_settings'),
    'access arguments' => array('administer site configuration'),
    'file' => 'caascade.admin.inc',
  );
  $items['caascade/relay'] = array(
    'page callback' => 'caascade_relay',
    'page arguments' => array(),
    'access callback' => TRUE,
    'access arguments' => array(),
    'type' => MENU_CALLBACK,
  );
  return $items;
}


/**
* Implements hook_block_info().
*/
function caascade_block_info() {
  $blocks = array();
  $caascade_files = caascade_block_helper();
  foreach($caascade_files as $caascade_file)
  {
    $command = str_replace('.html', '', $caascade_file);
    $blocks[$command] = array('info' => t("Caascade $command block"));
  }
  return $blocks;
}

/*
 Helper function to hide extra blocks
 *
 */
function caascade_block_helper() {
  if(variable_get('caascade_all_operators', false))
  {
    return array();
  }
  $arithmetic = array();
  $relational = array();
	$trig = array();
  if(variable_get('caascade_arithmetic_operators', false))
  {
    $arithmetic = array('add.html', 'multiply.html', 'subtract.html', 'divide.html');
  }
  if(variable_get('caascade_relational_operators', false))
  {
    $relational = array('gt.html', 'gte.html', 'lt.html', 'lte.html');
  }
	if(variable_get('caascade_trig_functions', false))
  {
    $trig = array('cos.html', 'sin.html', 'tan.html', 'csc.html', 'sec.html', 'cot.html', 'cosh.html', 'sinh.html', 'tanh.html', 'csch.html', 'sech.html', 'coth.html', 'acos.html', 'asin.html', 'atan.html', 'acsc.html', 'asec.html', 'acot.html', 'acosh.html', 'asinh.html', 'atanh.html', 'acsch.html', 'asech.html', 'acoth.html');
  }
  $exclude = array_merge($arithmetic, $relational, $trig, array('..', '.', 'override'));
  return $caascade_files = array_diff(scandir(drupal_get_path('module', 'caascade') . '/html'), $exclude);
}

/**
* Implements hook_block_view().
*/
function caascade_block_view($delta = '')
{
  $theme = variable_get('caascade_recaptcha_theme', 'red');
  $block = array();
  if(!class_exists('ReCaptchaResponse'))
  {
    require_once 'recaptchalib.php';
  } 
  $html = drupal_get_path('module', 'caascade') . '/html/' . $delta . '.html';
  $override = drupal_get_path('module', 'caascade') . '/html/override/' . $delta . '.html';

  $dialog = '<div class="caascade-dialog"><div class="caascade-waiting-container"><div class="caascade-waiting">Computing...</div></div><div class="caascade-output-container"><div class="caascade-output"></div></div></div>';
  $pre_html = variable_get('caascade_pre_html', '');
  $post_html = variable_get('caascade_post_html', '');
  $block['subject'] = t("Tetragy Caascade $delta command");
  $markup = '';
  if(is_file($override))
  {
    $markup = '<div class="caascade-cp">' . file_get_contents($override) . '</div>';
  }
  elseif(is_file($html))
  {
    $markup = '<div class="caascade-cp">' . file_get_contents($html) . '</div>';
  }
  $recaptcha_html = '<div class="caascade-recaptcha" id="caascade-recaptcha-' . rand(10000,99999) . '"></div>';
  $block['content'] = '<div class="caascade" id="caascade-' . $delta .'">' . $pre_html . $markup . $dialog . $recaptcha_html . $post_html . '</div>';
  return $block;
}

function caascade_relay()
{
  define('CAASCADE_SERVER', variable_get('caascade_router', 'https://route.tetragy.com'));
  if(!class_exists('ReCaptchaResponse'))
  {
    require_once 'recaptchalib.php';
  }
  $privatekey = variable_get('caascade_recaptcha_privatekey', '');

  if(strlen($privatekey))
  {
    $resp = recaptcha_check_answer($privatekey, $_SERVER["REMOTE_ADDR"], $_GET["recaptcha_challenge_field"], $_GET["recaptcha_response_field"]);
    if(!$resp->is_valid)
    {
      echo $_GET['callback'] . '({"input":"","output":"The reCAPTCHA wasn\'t entered correctly. Go back and try it again.","pdf":""})';
      exit;
    }
  }
  $fields = array();
  $fields['arg0'] = $_GET['arg0'];
  $fields['arg1'] = $_GET['arg1'];
  $fields['arg2'] = $_GET['arg2'];
  $fields['arg3'] = $_GET['arg3'];
  $fields['arg4'] = $_GET['arg4'];
  $fields['id'] = variable_get('caascade_id', '');
  $fields['cmd'] = $_GET['cmd'];
  $fields['input_base'] = $_GET['input_base'];
  $fields['output_base'] = $_GET['output_base'];
  $fields['callback'] = $_GET['callback'];
  $fields['approximate'] = $_GET['approximate'];
  $fields['expr_1'] = $_GET['expr_1'];
  $fields['expr_2'] = $_GET['expr_2'];
  $fields['x_wrt'] = $_GET['x_wrt'];
  $fields['y_wrt'] = $_GET['y_wrt'];
  $fields['z_wrt'] = $_GET['z_wrt'];	
  $fields['x_from'] = $_GET['x_from'];
  $fields['y_from'] = $_GET['y_from'];
  $fields['z_from'] = $_GET['z_from'];
  $fields['x_to'] = $_GET['x_to'];
  $fields['y_to'] = $_GET['y_to'];
  $fields['z_to'] = $_GET['z_to'];
  $fields['azimuth'] = $_GET['azimuth'];
  $fields['elevation'] = $_GET['elevation'];
  $fields['contours'] = $_GET['contours'];
  $fields['grid'] = $_GET['grid'];
  $fields['ntics'] = $_GET['ntics'];
  $fields['logx'] = $_GET['logx'];
  $fields['logy'] = $_GET['logy'];
  $fields['axes'] = $_GET['axes'];
  $fields['box'] = $_GET['box'];
  $fields['legend'] = $_GET['legend'];
  $fields['xlabel'] = $_GET['xlabel'];
  $fields['ylabel'] = $_GET['ylabel'];
  $fields['zlabel'] = $_GET['zlabel'];
  $fields['width'] = $_GET['width'];
  $fields['height'] = $_GET['height'];
  $fields['format'] = $_GET['format'];
  $fields['pdf'] = $_GET['pdf'];
  $fields_string = '';
  foreach($fields as $key => $value)
  {
    $fields_string .= $key . '=' . urlencode($value) . '&';
  }
  $fields_string = rtrim($fields_string, '&');
	$contents = file_get_contents(CAASCADE_SERVER . '/index.php?' . $fields_string);
  print $_GET['callback'] . '(' . $contents .')';
}
