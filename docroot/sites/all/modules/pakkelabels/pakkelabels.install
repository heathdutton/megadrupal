<?php

/**
 * @file
 */

/**
 * Implements hook_requirements().
 */
function pakkelabels_requirements($phase) {
  if ($phase == 'runtime') {

    $library = libraries_detect('pakkelabels-php');

    // Prepare the download instructions.
    $description = t('The php-sdk for pakkelabels is required for the pakkelabels module to function.
      Download the library from !url and place it in <em>!path</em>.', array('!path' => libraries_get_path('pakkelabels-php'), '!url' => l('Github', 'https://github.com/discimport/pakkelabels-dk')));

    return array(
      'pakkelabels-php' => array(
        'title' => t('Pakkelabels PHP-SDK library'),
        'value' =>  $library['installed'] ? t('Available') : t('Unavailable'),
        'description' => !$library['installed'] ? $description : NULL,
        'severity' => $library['installed'] ? REQUIREMENT_OK : REQUIREMENT_ERROR,
      ),
    );
  }
}

/**
 * Implements hook_uninstall().
 */
function pakkelabels_uninstall() {
  variable_del('pakkelabels_api_user');
  variable_del('pakkelabels_api_key');
  variable_del('pakkelabels_testmode');
  variable_del('pakkelabels_create_mode');
  variable_del('pakkelabels_sender_name');
  variable_del('pakkelabels_sender_address');
  variable_del('pakkelabels_sender_zipcode');
  variable_del('pakkelabels_sender_city');
  variable_del('pakkelabels_sender_countrycode');
  variable_del('pakkelabels_sender_email');
  // TODO What to do about the created fields?
}

/**
 * Implements hook_enable().
 */
function pakkelabels_enable() {
  // Adds shipping reference field on order entity.
  _pakkelabels_create_field('pakkelabels_shipment_id', 'commerce_order', 'commerce_order', 'Pakkelabels Shipment ID');
}

/**
 * Utility function to create fields
 */
function _pakkelabels_create_field($field_name, $entity_type, $bundle_name, $label) {
  $field = field_read_field($field_name);
  if (empty($field)) {
    $field = array(
      'field_name' => $field_name,
      'type' => 'text',
      'cardinality' => 1,
      'locked' => TRUE,
    );
    field_create_field($field);
  }

  $instance = field_info_instance($entity_type, $field_name, $bundle_name);
  if (empty($instance)) {
    // Create the instance on the bundle.
    $instance = array(
      'field_name' => $field_name,
      'entity_type' => $entity_type,
      'label' => $label,
      'bundle' => $bundle_name,
      'required' => FALSE,
      'settings' => array(),
      'widget' => array(
        'type' => 'text_textfield',
      ),
      'display' => array(
        'default' => array(
          'label' => 'hidden',
          'type' => 'hidden',
        ),
      ),
    );
    field_create_instance($instance);
  }
}
