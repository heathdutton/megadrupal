<?php
/**
 * @file
 * Scrapes ASX website for share price.
 */

/**
 * Implements hook_permission().
 */
function asx_permission() {
  return array(
    'administer asx' => array(
      'title' => t('Administer ASX'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function asx_menu() {
  $items = array();
  $items['admin/config/services/asx'] = array(
    'title' => 'ASX',
    'description' => 'Settings for ASX.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('asx_admin_settings'),
    'access arguments' => array('administer asx'),
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}

/**
 * Admin settings form.
 */
function asx_admin_settings() {
  $form = array();
  $form['asx_admin_settings']['system_settings'] = array(
    '#type' => 'fieldset',
    '#title' => t('ASX Settings'),
  );
  $form['asx_admin_settings']['system_settings']['asx_code'] = array(
    '#type' => 'textfield',
    '#title' => t('ASX Code'),
    '#description' => t('Enter your ASX code(s) separated by comma.'),
    '#default_value' => variable_get('asx_code', ''),
    '#required' => TRUE,
  );
  return system_settings_form($form);
}

/**
 * Implements hook_cron().
 */
function asx_cron() {
  $asx_codes = explode(',', variable_get('asx_code', ''));
  foreach ($asx_codes as $asx_code) {
    $asx_code = trim($asx_code);
    $url = 'http://www.asx.com.au/asx/markets/equityPrices.do?by=asxCodes&asxCodes=' . $asx_code;
    $html = file_get_contents($url);
    $dom = new DOMDocument();
    $dom->loadHTML($html);
    $xpath = new DOMXPath($dom);
    $nodes = $xpath->query("//*[contains(concat(' ', normalize-space(@class), ' '), 'last')]");
    $data = $nodes->item(0)->nodeValue;
    variable_set('asx_share_price_' . strtolower($asx_code), $data);
  }
}
