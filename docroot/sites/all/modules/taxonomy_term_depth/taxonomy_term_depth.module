<?php
/**
 * @file
 * Provides some custom functionality.
 */

/**
 * Require all constants
 */
require_once __DIR__. '/constants.inc';

/**
 * @todo: Provide description
 * @param $tid
 * @param bool $force
 * @return int
 */
function taxonomy_term_depth_get_by_tid($tid, $force = FALSE) {
  $cache = &drupal_static('taxonomy_term_depth', array());
  $cache_key = $tid;
  if ($force || !isset($cache[$cache_key])) {
    // Try to get cached value first but only if no need to rebuild
    // If force flag is set to TRUE the query won't be executed
    if ($force || !($depth = db_query('SELECT depth FROM {taxonomy_term_data} WHERE tid=:tid', array(':tid' => $tid))->fetchField())) {
      // Calculate value without using caches
      $depth = _taxonomy_term_depth_get_nocache($tid);

      // And write to database cache
      db_update('taxonomy_term_data')
        ->fields(array(
          'depth' => $depth,
        ))
        ->condition('tid', $tid)
        ->execute();
    }

    $cache[$cache_key] = $depth;
  }

  return $depth;
}

/**
 * Implements hook_entity_update();
 */
function taxonomy_term_depth_entity_update($entity, $type) {
  // Update depth of the item on save
  if ($type == 'taxonomy_term') {
    taxonomy_term_depth_get_by_tid($entity->tid, TRUE);
  }
}

/**
 * Implements hook_entity_insert()
 */
function taxonomy_term_depth_entity_insert($entity, $type) {
  taxonomy_term_depth_entity_update($entity, $type);
}

/**
 * Calculates taxonomy term depth from database
 * @param $tid
 * @return int
 */
function _taxonomy_term_depth_get_nocache($tid) {
  $parent = taxonomy_term_depth_get_parent($tid);
  if (!$parent) {
    return 1;
  }
  else {
    return 1 + _taxonomy_term_depth_get_nocache($parent);
  }
}

/**
 * Gets parent of the term
 * @param $tid
 *  Term tid to find its parent
 */
function taxonomy_term_depth_get_parent($tid, $nocache = FALSE) {
  $cache = &drupal_static(__FUNCTION__, array());
  $cache_key = $tid;
  if (!isset($cache[$cache_key]) || $nocache) {
    $cache[$cache_key] = db_query(
      "SELECT parent FROM {taxonomy_term_hierarchy} WHERE tid = :tid",
      array(':tid' => $tid)
    )->fetchField();
  }

  return $cache[$cache_key];
}

/**
 * @param $tid
 * @return array
 */
function taxonomy_term_depth_get_chain($tid, $reveresed = FALSE) {
  // @todo: Caching parents or not worth?
  $parents = array();
  $parent = $tid;
  while ($parent = taxonomy_term_depth_get_parent($parent)) {
    $parents[] = $parent;
  }

  return $reveresed ? array_reverse($parents) : $parents;
}

/**
 * Implements hook_menu()
 */
function taxonomy_term_depth_menu() {
  $items = array();
  $items['admin/structure/taxonomy/taxonomy_term_depth_update'] = array(
    'title' => t('Rebuild all taxonomy term depths'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('taxonomy_term_depth_batch_depth_update_form'),
    'access arguments' => array('administer taxonomy'),
    'file' => 'taxonomy_term_depth.batch.inc',
    'type' => MENU_LOCAL_TASK,
  );

  return $items;
}
