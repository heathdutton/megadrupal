<?php
/**
 * @file
 * File MD5.
 */

// Include auxiliary functionality.
require_once 'includes/file_md5.common.inc';

/**
 * Implements hook_file_presave().
 */
function file_md5_file_presave(\stdClass $file) {
  $file->md5 = is_readable($file->uri) ? file_md5_hash($file->uri) : md5($file->uri);
}

/**
 * Implements hook_file_validate().
 */
function file_md5_file_validate(\stdClass $file) {
  $errors = [];

  // Validate a file by MD5 only if this is allowed.
  // @see file_md5_form_system_file_system_settings_alter()
  if (variable_get(__FUNCTION__, TRUE)) {
    $existing = file_md5_load_by('md5', file_md5_hash($file->uri));

    if (!empty($existing)) {
      $errors[] = t('An identical file located here: @uri.', [
        '@uri' => $existing->uri,
      ]);
    }
  }

  return $errors;
}

/**
 * Implements hook_form_BASE_FORM_ID_alter().
 */
function file_md5_form_system_file_system_settings_alter(array &$form, array &$form_state, $form_id) {
  $items = [];

  $items['file_md5_file_validate'] = [
    '#type' => 'checkbox',
    '#title' => t('Enable validation by comparing MD5 hash of a file'),
    '#prefix' => '<label>' . t('MD5 validation') . '</label>',
    '#default_value' => TRUE,
  ];

  // Dynamically set values for form elements, provided by this module.
  foreach ($items as $name => $item) {
    $items[$name]['#default_value'] = variable_get($name, $item['#default_value']);
  }

  // Extend an original form.
  // @see system_file_system_settings()
  $form += $items;
}
