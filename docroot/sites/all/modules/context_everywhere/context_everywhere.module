<?php

/**
 * @file
 * Disables the core Block UI to allows context complete control of blocks.
 *
 * @package context_everywhere
 */

/**
 * Implements hook_FORM_ID_form_alter().
 */
function context_everywhere_form_context_ui_settings_alter(&$form, &$form_state, $form_id) {
  $form['context_everywhere'] = array(
    '#type' => 'checkbox',
    '#title' => t('Disable core Block UI.'),
    '#description' => t('This allows context to have complete control of block placement.'),
    '#default_value' => variable_get('context_everywhere', 1),
  );
}

/**
 * Implements hook_form_alter().
 */
function context_everywhere_form_alter(&$form, &$form_state, $form_id) {
  switch ($form_id) {
    case 'block_admin_configure':
      if (variable_get('context_everywhere', 1)) {
        // Allow the block to be placed if we're editing the dashboard.
        if (module_exists('dashboard')) {
          $themes = element_children($form['regions']);
          foreach ($themes as $theme_name) {
            $admin_theme = FALSE;
            $theme = $form['regions'][$theme_name];
            foreach ($theme['#options'] as $region_id => $region_title) {
              if (strpos($region_id, 'dashboard') === FALSE) {
                unset($form['regions'][$theme_name]['#options'][$region_id]);
              }
              else {
                $admin_theme = TRUE;
              }
            }
          }
        }
        // Otherwise, just unset the whole regions fieldset.
        else {
          unset($form['regions']);
        }
      }
      break;

    case 'block_admin_display_form':
      if (variable_get('context_everywhere', 1)) {
        $form['#access'] = FALSE;
        drupal_set_message(t('Configuration of blocks on this page has been disabled by the Context Everywhere module. To change this setting, visit !link.', array('!link' => l(t('the Context settings page'), 'admin/structure/context/settings'))), 'warning');
      }
      break;
  }
}
