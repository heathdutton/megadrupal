<?php
/**
 * @file kimjong_filter.module
 * Process content for Kim 'n friends.
 */

define('KIMJONG_PCRE_LINK', 'http://au1.php.net/manual/en/pcre.pattern.php');

/**
 * Implements hook_filter_info().
 */
function kimjong_filter_filter_info() {
  return array(
   'kimjong' => array(
     'title' => t('Kim Jong-filter'),
     'description' => t('Wraps all occurrences of the names of great leaders in a span element.'),
     'settings callback' => '_kimjong_filter_settings',
     'process callback' => '_kimjong_filter_process',
     'tips callback' => '_kimjong_filter_tips',
     'default settings' => array(
       'dear_leader' => '/\b(Kim [A-Z]{1}[^-]+\-[^\s\b]+)\b/',
     ),
   ),
 );
}

/**
 * Settings callback.
 */
function _kimjong_filter_settings($form, &$form_state, $filter, $format, $defaults, $filters) {
  $filter->settings += $defaults;

  $elements = array();
  $elements['dear_leader'] = array(
    '#type' => 'textfield',
    '#title' => t('Dear leader regular expression'),
    '#description' => t('Valid <a href="@url">PCRE</a> regular expression that matches the names of the past and current dear leaders.', array('@url' => url(KIMJONG_PCRE_LINK))),
    '#default_value' => $filter->settings['dear_leader'],
    '#element_validate' => array('_kimjong_filter_settings_validate'),
  );
  return $elements;
}

/**
 * Element validation callback.
 */
function _kimjong_filter_settings_validate($element, &$form_state) {
  $value = $element['#value'];
  $valid = @preg_match($value, 'test', $matches);
  if (!empty($value) && $valid === FALSE) {
    form_error($element, t('%name must contain a valid <a href="@url">PCRE</a> regular expression.', array('%name' => $element['#title'], '@url' => url(KIMJONG_PCRE_LINK))));
  }
}

/**
 * Filter callback.
 */
function _kimjong_filter_process($text, $filter) {
  $regex_notag = '/(?<=^|>)([^><]+?)(?=<|$)/';
  $regex_leader = $filter->settings['dear_leader'];

  return preg_replace_callback(
    $regex_notag,
    create_function(
      '$matches',
      'return preg_replace("' . $regex_leader . '", "<span class=\"kimjong\">\$1</span>", $matches[0]);'
    ),
    $text);
}

/**
 * Filter tips callback.
 */
function _kimjong_filter_tips($filter, $format, $long = FALSE) {
  return t('Wrap all occurrences of the names of great leaders in a span element.');
}
