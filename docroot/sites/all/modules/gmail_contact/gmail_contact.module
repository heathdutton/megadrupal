<?php

/**
 * Implements hook_menu().
 */
function gmail_contact_menu() {
  $items = array();
  $items['admin/structure/gmail_contact'] = array(
    'title' => 'Gmail contact setting',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('gmail_contact_admin_form'),
    'file' => 'gmail_contact.admin.inc',
    'access arguments' => array('administer gmail contact'),
  );
  $items['gmail-invite'] = array(
    'title' => 'Invite Your Contacts',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('gmail_contact_invite_form'),
    'file' => 'gmail_contact.page.inc',
    'access arguments' => array('access gmail contact page'),
  );
  $items['initiate-gmail-invite'] = array(
    'title' => 'Initiate gmail inviation',
    'page callback' => 'gmail_contact_invite_page',
    'file' => 'gmail_contact.page.inc',
    'access arguments' => array('access gmail contact page'),
  );
  return $items;
}

/**
 * Access callback to visit gmail invite page.
 *
 * We only open this page to logged in users.
 * @return mixed
 */
function gmail_contact_permission() {
  return array(
    'administer gmail contact' => array(
      'title' => t('Administer Gmail Contact'),
    ),
    'access gmail contact page' => array(
      'title' => t('Access Gmail Contact invite page'),
    ),
  );
}

/**
 * Implements hook_mail().
 */
function gmail_contact_mail($key, &$message, $params) {
  if ($key == 'invite') {
    $site_name = variable_get('site_name', 'Drupal');
    $message['subject'] = variable_get('gmail_contact_email_subject', $site_name);
    $body = variable_get('gmail_contact_email_message', '');
    $sender_name = variable_get('gmail_contact_email_sender', $site_name);

    // Replace tokens.
    if (module_exists('token')) {
      $sender_name = token_replace($sender_name);
      $message['subject'] = token_replace($message['subject']);
      $message['body'][]  = token_replace($body);
    }

    $message['headers']['From'] = $sender_name . '<' . $message['headers']['From'] . '>';
  }
}

/**
 * Implements hook_block_info().
 */
function gmail_contact_block_info() {
  $blocks['gmail_contact_invite'] = array(
    'info' => t('Gmail Invite Block'),
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function gmail_contact_block_view($delta = '') {
  $block = array();
  switch ($delta) {
    case 'gmail_contact_invite':
      $block['subject'] = t('Invite Gmail Contacts');
      $gmail_url = gmail_contact_get_invite_link_url();
      $gmail_options = array(
        'attributes' => array(
          'target' => "_blank",
          'rel' => "nofollow",
        ),
      );
      $block['content'] = '<div class="gmail-contact-invite-link">' . l(t('Invite Gmail Contacts'), $gmail_url, $gmail_options) . '</div>';
      break;
  }
  return $block;
}

/**
 * Implements hook_cron_queue_info().
 */
function gmail_contact_cron_queue_info() {
  $queue['gmail_contact_invites'] = array(
    'worker callback' => '_gmail_contact_invites_gmail_worker',
    'time' => 60,
  );
  return $queue;
}

/**
 * Drupal queue implementation.
 * @param $vars
 */
function _gmail_contact_invites_gmail_worker($vars) {
  global $language;
  $email = $vars['email'];
  $from = $vars['from'];
  $params = array();

  // Send e-mail.
  $result = drupal_mail('gmail_contact', 'invite', $email, $language, $params, $from, TRUE);
  if ($result) {
    watchdog('gmail_contact', 'Successfully send e-mail %to).', array('%to' => $email));
  }
}

/*====================== Helper Functions ==============*/

/**
 * Construct the request url sent to Google.
 *
 * @param string $redirect_path
 * The redirected path required by Google.
 *
 * @return string
 * Url string.
 */
function gmail_contact_get_invite_link_url($redirect_path = 'initiate-gmail-invite') {
  global $base_url;
  $gmail_url = 'https://accounts.google.com/o/oauth2/auth?client_id=' . variable_get('gmail_contact_client_id', '');
  $gmail_url .= '&redirect_uri=' . $base_url . '/' . $redirect_path . '';
  if ($max = variable_get('gmail_contact_max_result', '')) {
    $gmail_url .= '&max-results=' . $max;
  }
  $gmail_url .= '&scope=https://www.google.com/m8/feeds/&response_type=code';

  return $gmail_url;
}

/**
 * Send request to Google api to get response.
 *
 * @param $auth_code
 * @return string
 */
function gmail_contact_get_gmail_contacts($auth_code) {
  global $base_url;
  $client_id = variable_get('gmail_contact_client_id', '');
  $client_secret = variable_get('gmail_contact_client_secret', '');
  $redirect_uri = $base_url . '/initiate-gmail-invite';

  $fields = array(
    'code'=>  urlencode($auth_code),
    'client_id'=>  urlencode($client_id),
    'client_secret'=>  urlencode($client_secret),
    'redirect_uri'=>  urlencode($redirect_uri),
    'grant_type'=>  urlencode('authorization_code')
  );
  $post = '';
  foreach($fields as $key=>$value) { $post .= $key.'='.$value.'&'; }
  $post = rtrim($post,'&');

  $curl = curl_init();
  curl_setopt($curl,CURLOPT_URL,'https://accounts.google.com/o/oauth2/token');
  curl_setopt($curl,CURLOPT_POST,5);
  curl_setopt($curl,CURLOPT_POSTFIELDS,$post);
  curl_setopt($curl, CURLOPT_RETURNTRANSFER,TRUE);
  curl_setopt($curl, CURLOPT_SSL_VERIFYPEER,0);
  curl_setopt($curl, CURLOPT_SSL_VERIFYHOST,0);
  $result = curl_exec($curl);
  curl_close($curl);

  // Remove auth code from session once its been used.
  if (isset($_SESSION['gmail_auth_code'])) {
    unset($_SESSION['gmail_auth_code']);
  }

  $response =  json_decode($result);
  if (!$response) {
    echo t("No response from Google. It may happen if you have loose internet connection with Google Service.
      <br> Please try again later. If problem persists, please report this issue to site administrator.");
    exit();
  }
  elseif (isset($response->error) && $response->error) {
    echo 'Error: ' . $response->error . '<br>' . $response->error_description;
    exit();
  }
  elseif ($response->access_token) {
    $accesstoken = $response->access_token;

    // It's not a good idea to store access token at session, which could be
    // dangerous to expose user data. We can store Google code in session.
    $url = 'https://www.google.com/m8/feeds/contacts/default/full?oauth_token='.$accesstoken;

    // Add max number limit if it exists.
    if ($max_results = variable_get('gmail_contact_max_result', '')) {
      $url .= '&max-results=' . $max_results;
    }
    $xmlresponse = file_get_contents($url);
    if (!$xmlresponse){
      echo t("No contact list response from Google. It may happen if you have loose internet connection with Google Service.
      <br> Please try again later. If problem persists, please report this issue to site administrator.");
      exit();
    }

    return $xmlresponse;
  }
  else {
    echo t("Unrecognized response from Google. It may happen if you have loose internet connection with Google Service.
      <br> Please try again later. If problem persists, please report this issue to site administrator.");
    exit();
  }
}

/**
 * @param $xmlresponse
 * @return array
 */
function gmail_contact_parse_gmail_contacts($xmlresponse) {
  // Parse emails.
  $xml =  new SimpleXMLElement($xmlresponse);

  $xml->registerXPathNamespace('gd', 'http://schemas.google.com/g/2005');

  $contacts = array();
  $name_flag = variable_get('gmail_contact_name_required', '');

  foreach ($xml->entry as $entry) {
    foreach ($entry->xpath('gd:email') as $email) {
      if (!$name_flag) {
        $name = (string)$entry->title;
        // If no name provided, use email address as name.
        if (!$name) {
          $name = (string)$email->attributes()->address;
        }
        $contacts[] = array('name' => $name, 'email' => (string)$email->attributes()->address);
      }
      else {
        // Only proceed when this contact has name associated.
        if ((string)$entry->title) {
          $contacts[] = array('name' => (string)$entry->title, 'email' => (string)$email->attributes()->address);
        }
      }
    }
  }

  return $contacts;
}
