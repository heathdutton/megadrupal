<?php
/**
 * @file
 *   The "Require aliased paths" module.
 *
 *   Requires path aliases to be used when they are available by blocking
 *   external requests directly for internal paths like "node/5" or "user/3"
 *   when a path alias exists for the path.
 *
 *   © 2015 House at Work and Red Bottle Design, LLC. All rights reserved.
 *
 * @author Guy Paddock (guy.paddock@redbottledesign.com)
 */

/**
 * Implements hook_page_delivery_callback_alter().
 *
 * Denies access to pages when they are accessed directly via their internal
 * path rather than their path alias.
 */
function require_aliased_paths_page_delivery_callback_alter(&$callback) {
  // Swap out the page callback for our own.
  if ($callback == 'drupal_deliver_html_page') {
    $request_path = request_path();
    $current_path = current_path();

    /* If the requested path is the same as the current path, that means we didn't
     * get here via an alias.
     */
    if ($request_path == $current_path) {
      $alias_path = drupal_lookup_path('alias', $current_path);

      /* If the current path isn't the same as the alias path for the current
       * path, that means that there's an alias out there for the current page
       * that wasn't used.
       */
      if (!empty($alias_path) && ($current_path != $alias_path)) {
        $callback = 'require_aliased_paths_page_access_denied_deliver_callback';
      }
    }
  }
}

/**
 * Page delivery callback that just serves up access denied (how exciting!).
 *
 * This is used by require_aliased_paths_page_delivery_callback_alter() when
 * it wants to block access to a non-aliased path.
 */
function require_aliased_paths_page_access_denied_deliver_callback() {
  drupal_deliver_html_page(MENU_ACCESS_DENIED);
}