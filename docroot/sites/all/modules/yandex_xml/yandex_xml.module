<?php

/**
 * @file
 * Primarily Drupal hooks for Yandex XML module.
 */

/**
 * Implements hook_theme().
 */
function yandex_xml_theme() {
  return array(
    'yandex_xml_results' => array(
      'render element' => 'elements',
      'template' => 'yandex_xml-results',
      'file' => 'yandex_xml.pages.inc',
    ),
  );
}

/**
 * Implements hook_menu().
 */
function yandex_xml_menu() {
  $items['yandex/search'] = array(
    'title' => 'Search',
    'page callback' => 'yandex_xml_view',
    'access arguments' => array('use yandex xml'),
    'type' => MENU_SUGGESTED_ITEM,
    'file' => 'yandex_xml.pages.inc',
  );
  $items['admin/config/search/yandex_xml'] = array(
    'title' => 'Yandex XML settings',
    'description' => 'Yandex XML keys and search settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('yandex_xml_settings_form'),
    'access arguments' => array('administer yandex xml'),
    'file' => 'yandex_xml.admin.inc',
  );
  return $items;
}

/**
 * Implements hook_permission().
 */
function yandex_xml_permission() {
  return array(
    'administer yandex xml' => array(
      'title' => t('Administer yandex xml search'),
    ),
    'use yandex xml' => array(
      'title' => t('Use yandex xml search'),
    ),
  );
}

/**
 * Implements hook_block_info().
 */
function yandex_xml_block_info() {
  $blocks['form']['info'] = t('Yandex XML search form');
  // Not worth caching.
  $blocks['form']['cache'] = DRUPAL_NO_CACHE;
  $blocks['form']['properties']['administrative'] = TRUE;
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function yandex_xml_block_view($delta = '') {
  if (user_access('use yandex xml')) {
    $block['content'] = drupal_get_form('yandex_xml_form', '', TRUE);
    return $block;
  }
}

/**
 * Builds a search form.
 *
 * @param string $keys
 *   The search string entered by the user, containing keywords for the search.
 *
 * @return array
 *   A Form API array for the search form.
 */
function yandex_xml_form($form, &$form_state, $keys = '', $block = FALSE) {

  $form['basic'] = array('#type' => 'container', '#attributes' => array('class' => array('container-inline')));
  $form['basic']['keys'] = array(
    '#type' => 'textfield',
    '#default_value' => $keys,
    '#size' => $block ? 15 : 50,
    '#attributes' => array('placeholder' => $block ? t('Search site') : t('Enter your keywords'), 'required' => 'required'),
    '#maxlength' => 255,
  );
  $form['basic']['actions']['submit'] = array('#type' => 'submit', '#value' => t('Search'));

  return $form;
}

/**
 * Search form validation handler.
 */
function yandex_xml_form_validate($form, &$form_state) {
  $keys = $form_state['values']['keys'];
  if ($keys == '') {
    form_set_error('keys', t('Please enter some keywords.'));
  }
}

/**
 * Process a search form submission.
 */
function yandex_xml_form_submit($form, &$form_state) {
  $keys = $form_state['values']['keys'];
  $form_state['redirect'] = 'yandex/search/' . $keys;
}
