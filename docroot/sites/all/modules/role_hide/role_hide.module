<?php

/**
 * Implements hook_form_alter().
 */
function role_hide_form_alter(&$form, &$form_state, $form_id) {
  switch($form_id) {
    case 'user_admin_permissions':
      $roles = variable_get('role_hide', array());
      foreach($roles as $rid) {
        if (isset($form['role_names'][$rid])) {
          $form['role_names'][$rid]['#access'] = FALSE;
          $form['checkboxes'][$rid]['#access'] = FALSE;
        }
      }
      $form['role_names']['#after_build'][] = '_role_hide_add_js';
      break;

    case 'user_admin_role':
      $hidden_roles = variable_get('role_hide', array());
      $form['role_hide'] = array(
        '#type' => 'checkbox',
        '#title' => t('Hide this role from the permissions screen.'),
        '#default_value' => (in_array($form['rid']['#value'], $hidden_roles)) ? 1 : 0,
      );

      $form['#submit'][] = 'hide_role_submit';
      break;

    case 'user_admin_role_delete_confirm':
      $form['#submit'][] = 'hide_role_delete_submit';
      break;
  }
}

/**
 * Manage submission on role edit page.
 */
function hide_role_submit($form, &$form_state) {
  $hidden_roles = variable_get('role_hide', array());
  if ($form['role_hide']['#checked'] && !in_array($form['rid']['#value'], $hidden_roles)) {
    $hidden_roles[] = $form['rid']['#value'];
    variable_set('role_hide', $hidden_roles);
  }
  else if (!$form['role_hide']['#checked']) {
    hide_role_delete_role($form['rid']['#value']);
  }
}

/**
 * Remove setting on role delete.
 */
function hide_role_delete_submit($form, &$form_state) {
  hide_role_delete_role($form_state['values']['rid']);
}

/**
 * Delete role from hidden roles.
 */
function hide_role_delete_role($rid) {
  $hidden_roles = variable_get('role_hide', array());
  if (($key = array_search($rid, $hidden_roles)) !== FALSE) {
    unset($hidden_roles[$key]);
    variable_set('role_hide', $hidden_roles);
    return TRUE;
  }

  return FALSE;
}

/**
 * Load Javascript.
 */
function _role_hide_add_js($element) {
  drupal_add_js(drupal_get_path('module', 'role_hide') . '/js/role_hide.js');
  return($element);
}
