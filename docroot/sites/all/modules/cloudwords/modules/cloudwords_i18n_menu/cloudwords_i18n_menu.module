<?php

/**
 * @file
 * Integrates Cloudwords with i18n_menu.module.
 */

/**
 * Implements hook_cloudwords_translatable_info().
 */
function cloudwords_i18n_menu_cloudwords_translatable_info() {
  return array(
    'menu' => array(
      'controller class' => 'CloudwordsI18nStringSource',
    ),
    'menu_link' => array(
      'controller class' => 'CloudwordsI18nStringSource',
    ),
  );
}

/**
 * Implements hook_menu_insert().
 */
function cloudwords_i18n_menu_menu_insert($menu) {
  cloudwords_i18n_menu_menu_update($menu);
}

/**
 * Implements hook_menu_update().
 */
function cloudwords_i18n_menu_menu_update($menu) {
  cloudwords_i18n_ensure_translatables('menu', 'menu', $menu['menu_name'], $menu['title']);
}

/**
 * Implements hook_menu_delete().
 */
function cloudwords_i18n_menu_menu_delete($menu) {
  $translatables = cloudwords_get_translatables_by_property(array(
    'textgroup' => 'menu',
    'type' => 'menu',
    'objectid' => $menu['menu_name'],
  ));

  cloudwords_translatable_delete_multiple(array_keys($translatables));
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function cloudwords_i18n_menu_form_menu_edit_menu_alter(&$form, &$form_state) {
  if (!empty($form['old_name']['#value'])) {
    $args = array(
      'textgroup' => 'menu',
      'type' => 'menu',
      'objectid' => $form['old_name']['#value'],
    );

    cloudwords_outdated_form($form, $form_state, $args);
  }
}

/**
 * Implements hook_menu_link_insert().
 */
function cloudwords_i18n_menu_menu_link_insert($item) {
  cloudwords_i18n_menu_menu_link_update($item);
}

/**
 * Implements hook_menu_link_update().
 */
function cloudwords_i18n_menu_menu_link_update($item) {
  if (empty($item['language']) || $item['language'] == LANGUAGE_NONE) {

    $menu = menu_load($item['menu_name']);

    if (isset($menu['i18n_mode']) && $menu['i18n_mode'] == 5) {
      cloudwords_i18n_ensure_translatables('menu', 'menu_link', $item['mlid'], $item['link_title']);
    }
  }
}

/**
 * Implements hook_menu_link_delete().
 */
function cloudwords_i18n_menu_menu_link_delete($item) {
  $translatables = cloudwords_get_translatables_by_property(array(
    'textgroup' => 'menu',
    'type' => 'menu_link',
    'objectid' => $item['mlid'],
  ));

  cloudwords_translatable_delete_multiple(array_keys($translatables));
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function cloudwords_i18_menun_form_menu_edit_item_alter(&$form, &$form_state) {
  if (!empty($form['mlid']['#value'])) {
    $args = array(
      'textgroup' => 'menu',
      'type' => 'menu_link',
      'objectid' => $form['mlid']['#value'],
    );

    cloudwords_outdated_form($form, $form_state, $args);
  }
}

/**
 * Implements hook_cloudwords_refresh_translatables().
 */
function cloudwords_i18n_menu_cloudwords_refresh_translatables(&$context) {
  cloudwords_i18n_refresh_strings('menu', 'menu');
  cloudwords_i18n_refresh_strings('menu', 'item', 'menu_link');
}
