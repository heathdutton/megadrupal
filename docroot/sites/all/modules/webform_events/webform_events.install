<?php
/**
 * @file
 * webform_events.install
 */

/**
 * Implements hook_install().
 */
function webform_events_install() {
  $var = variable_get('webform_node_types');
  $var[] = 'webform_events';
  variable_set('webform_node_types', $var);
  variable_set('webform_events_default_manage_pager', 10);
  variable_set('webform_events_default_profile_pager', 10);
  variable_set('webform_events_default_participants', 10);
  // Create fields.
  $fields = array();

  // Email field.
  $fields['field_webform_events_email']  = array(
    'field_config'                      => array(
      'active'                          => '1',
      'cardinality'                     => '1',
      'deleted'                         => '0',
      'entity_types'                    => array(),
      'field_name'                      => 'field_webform_events_email',
      'foreign keys'                    => array(
        'format'                        => array(
          'columns'                     => array(
            'format'                    => 'format',
          ),
          'table'                       => 'filter_format',
        ),
      ),
      'indexes'                         => array(
        'format'                        => array(
          0                             => 'format',
        ),
      ),
      'locked'                          => '0',
      'module'                          => 'text',
      'settings'                        => array(
        'max_length'                    => '255',
      ),
      'translatable'                    => '0',
      'type'                            => 'text',
    ),
    'field_instance'                    => array(
      'bundle'                          => 'webform_events',
      'default_value'                   => NULL,
      'deleted'                         => '0',
      'description'                     => 'Email to notify of signups',
      'display'                         => array(
        'default'                       => array(
          'label'                       => 'hidden',
          'settings'                    => array(),
          'type'                        => 'hidden',
          'weight'                      => '8',
        ),
        'teaser'                        => array(
          'label'                       => 'above',
          'settings'                    => array(),
          'type'                        => 'hidden',
          'weight'                      => 8,
        ),
      ),
      'entity_type'                     => 'node',
      'field_name'                      => 'field_webform_events_email',
      'label'                           => 'Email',
      'required'                        => 0,
      'settings'                        => array(
        'text_processing'               => '0',
        'user_register_form'            => FALSE,
      ),
      'widget'                          => array(
        'active'                        => 1,
        'module'                        => 'text',
        'settings'                      => array(
          'size'                        => '60',
        ),
        'type'                          => 'text_textfield',
        'weight'                        => '8',
      ),
    ),
  );

  // Signup limit field.
  $fields['field_webform_events_limit']    = array(
    'field_config'                              => array(
      'active'                                  => '1',
      'cardinality'                             => '1',
      'deleted'                                 => '0',
      'entity_types'                            => array(),
      'field_name'                              => 'field_webform_events_limit',
      'foreign keys'                            => array(),
      'indexes'                                 => array(
        'value'                                 => array(
          0                                     => 'value',
        ),
      ),
      'locked'                                  => '0',
      'module'                                  => 'list',
      'settings'                                => array(
        'allowed_values'                        => array(
          0                                     => '',
          1                                     => '',
        ),
        'allowed_values_function'               => '',
      ),
      'translatable'                            => '0',
      'type'                                    => 'list_boolean',
    ),
    'field_instance'                            => array(
      'bundle'                                  => 'webform_events',
      'default_value'                           => array(
        0                                       => array(
          'value'                               => 0,
        ),
      ),
      'deleted'                                 => '0',
      'description'                             => 'Check this to limit singups to one at time',
      'display'                                 => array(
        'default'                               => array(
          'label'                               => 'hidden',
          'module'                              => 'list',
          'settings'                            => array(),
          'type'                                => 'list_default',
          'weight'                              => 6,
        ),
        'teaser'                                => array(
          'label'                               => 'above',
          'settings'                            => array(),
          'type'                                => 'hidden',
          'weight'                              => 6,
        ),
      ),
      'entity_type'                             => 'node',
      'field_name'                              => 'field_webform_events_limit',
      'label'                                   => 'Limit to single signup at time',
      'required'                                => 0,
      'settings'                                => array(
        'user_register_form'                    => FALSE,
      ),
      'widget'                                  => array(
        'active'                                => 1,
        'module'                                => 'options',
        'settings'                              => array(
          'display_label'                       => 1,
        ),
        'type'                                  => 'options_onoff',
        'weight'                                => '6',
      ),
    ),
  );

  // Overbooking field.
  $fields['field_webform_events_overbooking']    = array(
    'field_config'                              => array(
      'active'                                  => '1',
      'cardinality'                             => '1',
      'deleted'                                 => '0',
      'entity_types'                            => array(),
      'field_name'                              => 'field_webform_events_overbooking',
      'foreign keys'                            => array(),
      'indexes'                                 => array(
        'value'                                 => array(
          0                                     => 'value',
        ),
      ),
      'locked'                                  => '0',
      'module'                                  => 'list',
      'settings'                                => array(
        'allowed_values'                        => array(
          0                                     => '',
          1                                     => '',
        ),
        'allowed_values_function'               => '',
      ),
      'translatable'                            => '0',
      'type'                                    => 'list_boolean',
    ),
    'field_instance'                            => array(
      'bundle'                                  => 'webform_events',
      'default_value'                           => array(
        0                                       => array(
          'value'                               => 0,
        ),
      ),
      'deleted'                                 => '0',
      'description'                             => 'Check this to allow overbooking and multislot queue.',
      'display'                                 => array(
        'default'                               => array(
          'label'                               => 'hidden',
          'module'                              => 'list',
          'settings'                            => array(),
          'type'                                => 'list_default',
          'weight'                              => 7,
        ),
        'teaser'                                => array(
          'label'                               => 'above',
          'settings'                            => array(),
          'type'                                => 'hidden',
          'weight'                              => 7,
        ),
      ),
      'entity_type'                             => 'node',
      'field_name'                              => 'field_webform_events_overbooking',
      'label'                                   => 'Allow overbooking',
      'required'                                => 0,
      'settings'                                => array(
        'user_register_form'                    => FALSE,
      ),
      'widget'                                  => array(
        'active'                                => 1,
        'module'                                => 'options',
        'settings'                              => array(
          'display_label'                       => 1,
        ),
        'type'                                  => 'options_onoff',
        'weight'                                => '7',
      ),
    ),
  );

  // Event image.
  $fields['field_webform_events_event_image']    = array(
    'field_config'                              => array(
      'active'                                  => '1',
      'cardinality'                             => '1',
      'deleted'                                 => '0',
      'entity_types'                            => array(),
      'field_name'                              => 'field_webform_events_event_image',
      'foreign keys'                            => array(
        'fid'                                   => array(
          'columns'                             => array(
            'fid'                               => 'fid',
          ),
          'table'                               => 'file_managed',
        ),
      ),
      'indexes'                                 => array(
        'fid'                                   => array(
          0                                     => 'fid',
        ),
      ),
      'locked'                                  => '0',
      'module'                                  => 'image',
      'settings'                                => array(
        'default_image'                         => 0,
        'uri_scheme'                            => 'public',
      ),
      'translatable'                            => '0',
      'type'                                    => 'image',
    ),
    'field_instance'                            => array(
      'bundle'                                  => 'webform_events',
      'deleted'                                 => '0',
      'description'                             => 'This will scale to 250px width',
      'display'                                 => array(
        'default'                               => array(
          'label'                               => 'hidden',
          'module'                              => 'image',
          'settings'                            => array(
            'image_link'                        => '',
            'image_style'                       => 'webform_events',
          ),
          'type'                                => 'image',
          'weight'                              => '1',
        ),
        'full'                                  => array(
          'label'                               => 'hidden',
          'module'                              => 'image',
          'settings'                            => array(
            'image_link'                        => '',
            'image_style'                       => 'webform_events',
          ),
          'type'                                => 'image',
          'weight'                              => '1',
        ),
        'teaser'                                => array(
          'label'                               => 'above',
          'settings'                            => array(),
          'type'                                => 'hidden',
          'weight'                              => 0,
        ),
      ),
      'entity_type'                             => 'node',
      'fences_wrapper'                          => 'figure',
      'field_name'                              => 'field_webform_events_event_image',
      'label'                                   => 'Event image',
      'required'                                => 0,
      'settings'                                => array(
        'alt_field'                             => 1,
        'default_image'                         => 0,
        'file_directory'                        => '',
        'file_extensions'                       => 'png gif jpg jpeg',
        'max_filesize'                          => '',
        'max_resolution'                        => '',
        'min_resolution'                        => '',
        'title_field'                           => 1,
        'user_register_form'                    => FALSE,
      ),
      'widget'                                  => array(
        'active'                                => 1,
        'module'                                => 'image',
        'settings'                              => array(
          'preview_image_style'                 => 'webform_events',
          'progress_indicator'                  => 'throbber',
        ),
        'type'                                  => 'image_image',
        'weight'                                => '1',
      ),
    ),
  );

  // Description.
  $fields['field_webform_events_description']    = array(
    'field_config'                              => array(
      'active'                                  => '1',
      'cardinality'                             => '1',
      'deleted'                                 => '0',
      'entity_types'                            => array(),
      'field_name'                              => 'field_webform_events_description',
      'foreign keys'                            => array(
        'format'                                => array(
          'columns'                             => array(
            'format'                            => 'format',
          ),
          'table'                               => 'filter_format',
        ),
      ),
      'indexes'                                 => array(
        'format'                                => array(
          0                                     => 'format',
        ),
      ),
      'locked'                                  => '0',
      'module'                                  => 'text',
      'settings'                                => array(),
      'translatable'                            => '0',
      'type'                                    => 'text_with_summary',
    ),
    'field_instance'                            => array(
      'bundle'                                  => 'webform_events',
      'default_value'                           => NULL,
      'deleted'                                 => '0',
      'description'                             => '',
      'display'                                 => array(
        'default'                               => array(
          'label'                               => 'hidden',
          'module'                              => 'text',
          'settings'                            => array(),
          'type'                                => 'text_default',
          'weight'                              => '2',
        ),
        'full'                                  => array(
          'label'                               => 'hidden',
          'module'                              => 'text',
          'settings'                            => array(),
          'type'                                => 'text_default',
          'weight'                              => '2',
        ),
        'teaser'                                => array(
          'label'                               => 'hidden',
          'module'                              => 'text',
          'settings'                            => array(
            'trim_length'                       => 600,
          ),
          'type'                                => 'text_summary_or_trimmed',
          'weight'                              => '2',
        ),
      ),
      'entity_type'                             => 'node',
      'fences_wrapper'                          => 'div',
      'field_name'                              => 'field_webform_events_description',
      'label'                                   => 'Description',
      'required'                                => 0,
      'settings'                                => array(
        'display_summary'                       => 0,
        'text_processing'                       => '1',
        'user_register_form'                    => FALSE,
      ),
      'widget'                                  => array(
        'active'                                => 1,
        'module'                                => 'text',
        'settings'                              => array(
          'rows'                                => '20',
          'summary_rows'                        => 5,
        ),
        'type'                                  => 'text_textarea_with_summary',
        'weight'                                => '2',
      ),
    ),
  );

  // Start Date.
  $fields['field_webform_events_start_date']       = array(
    'field_config'                              => array(
      'active'                                  => '1',
      'cardinality'                             => '1',
      'deleted'                                 => '0',
      'entity_types'                            => array(),
      'field_name'                              => 'field_webform_events_start_date',
      'foreign keys'                            => array(),
      'indexes'                                 => array(),
      'locked'                                  => '0',
      'module'                                  => 'date',
      'settings'                                => array(
        'cache_count'                           => '4',
        'cache_enabled'                         => 0,
        'granularity'                           => array(
          'day'                                 => 'day',
          'hour'                                => 'hour',
          'minute'                              => 'minute',
          'month'                               => 'month',
          'second'                              => 0,
          'year'                                => 'year',
        ),
        'timezone_db'                           => '',
        'todate'                                => '',
        'tz_handling'                           => 'none',
      ),
      'translatable'                            => '0',
      'type'                                    => 'datetime',
    ),
    'field_instance'                            => array(
      'bundle'                                  => 'webform_events',
      'deleted'                                 => '0',
      'description'                             => '',
      'display'                                 => array(
        'default'                               => array(
          'label'                               => 'inline',
          'module'                              => 'date',
          'settings'                            => array(
            'format_type'                       => 'medium',
            'fromto'                            => 'both',
            'multiple_from'                     => '',
            'multiple_number'                   => '',
            'multiple_to'                       => '',
          ),
          'type'                                => 'date_default',
          'weight'                              => '3',
        ),
        'full'                                  => array(
          'label'                               => 'inline',
          'module'                              => 'date',
          'settings'                            => array(
            'format_type'                       => 'medium',
            'fromto'                            => 'both',
            'multiple_from'                     => '',
            'multiple_number'                   => '',
            'multiple_to'                       => '',
          ),
          'type'                                => 'date_default',
          'weight'                              => '3',
        ),
        'teaser'                                => array(
          'label'                               => 'inline',
          'settings'                            => array(),
          'type'                                => 'hidden',
          'weight'                              => '3',
        ),
      ),
      'entity_type'                             => 'node',
      'fences_wrapper'                          => 'div',
      'field_name'                              => 'field_webform_events_start_date',
      'label'                                   => 'Signups open',
      'required'                                => 0,
      'settings'                                => array(
        'default_value'                         => 'now',
        'default_value2'                        => 'same',
        'default_value_code'                    => '',
        'default_value_code2'                   => '',
        'user_register_form'                    => FALSE,
      ),
      'widget'                                  => array(
        'active'                                => 1,
        'module'                                => 'date',
        'settings'                              => array(
          'increment'                           => '15',
          'input_format'                        => 'm/d/Y - H:i:s',
          'input_format_custom'                 => '',
          'label_position'                      => 'above',
          'text_parts'                          => array(),
          'year_range'                          => '-3:+3',
        ),
        'type'                                  => 'date_popup',
        'weight'                                => '3',
      ),
    ),
  );

  // End Date.
  $fields['field_webform_events_end_date']       = array(
    'field_config'                              => array(
      'active'                                  => '1',
      'cardinality'                             => '1',
      'deleted'                                 => '0',
      'entity_types'                            => array(),
      'field_name'                              => 'field_webform_events_end_date',
      'foreign keys'                            => array(),
      'indexes'                                 => array(),
      'locked'                                  => '0',
      'module'                                  => 'date',
      'settings'                                => array(
        'cache_count'                           => '4',
        'cache_enabled'                         => 0,
        'granularity'                           => array(
          'day'                                 => 'day',
          'hour'                                => 'hour',
          'minute'                              => 'minute',
          'month'                               => 'month',
          'second'                              => 0,
          'year'                                => 'year',
        ),
        'timezone_db'                           => '',
        'todate'                                => '',
        'tz_handling'                           => 'none',
      ),
      'translatable'                            => '0',
      'type'                                    => 'datetime',
    ),
    'field_instance'                            => array(
      'bundle'                                  => 'webform_events',
      'deleted'                                 => '0',
      'description'                             => '',
      'display'                                 => array(
        'default'                               => array(
          'label'                               => 'inline',
          'module'                              => 'date',
          'settings'                            => array(
            'format_type'                       => 'medium',
            'fromto'                            => 'both',
            'multiple_from'                     => '',
            'multiple_number'                   => '',
            'multiple_to'                       => '',
          ),
          'type'                                => 'date_default',
          'weight'                              => '4',
        ),
        'full'                                  => array(
          'label'                               => 'inline',
          'module'                              => 'date',
          'settings'                            => array(
            'format_type'                       => 'medium',
            'fromto'                            => 'both',
            'multiple_from'                     => '',
            'multiple_number'                   => '',
            'multiple_to'                       => '',
          ),
          'type'                                => 'date_default',
          'weight'                              => '4',
        ),
        'teaser'                                => array(
          'label'                               => 'inline',
          'settings'                            => array(),
          'type'                                => 'hidden',
          'weight'                              => '4',
        ),
      ),
      'entity_type'                             => 'node',
      'fences_wrapper'                          => 'div',
      'field_name'                              => 'field_webform_events_end_date',
      'label'                                   => 'Signups close',
      'required'                                => 0,
      'settings'                                => array(
        'default_value'                         => 'now',
        'default_value2'                        => 'same',
        'default_value_code'                    => '',
        'default_value_code2'                   => '',
        'user_register_form'                    => FALSE,
      ),
      'widget'                                  => array(
        'active'                                => 1,
        'module'                                => 'date',
        'settings'                              => array(
          'increment'                           => '15',
          'input_format'                        => 'm/d/Y - H:i:s',
          'input_format_custom'                 => '',
          'label_position'                      => 'above',
          'text_parts'                          => array(),
          'year_range'                          => '-3:+3',
        ),
        'type'                                  => 'date_popup',
        'weight'                                => '4',
      ),
    ),
  );

  // Participants.
  $fields['field_webform_events_participant']   = array(
    'field_config'                              => array(
      'active'                                  => '1',
      'cardinality'                             => '1',
      'deleted'                                 => '0',
      'entity_types'                            => array(),
      'field_name'                              => 'field_webform_events_participant',
      'foreign keys'                            => array(),
      'indexes'                                 => array(),
      'locked'                                  => '0',
      'module'                                  => 'number',
      'settings'                                => array(),
      'translatable'                            => '0',
      'type'                                    => 'number_integer',
    ),
    'field_instance'                            => array(
      'bundle'                                  => 'webform_events',
      'default_value'                           => NULL,
      'deleted'                                 => '0',
      'description'                             => '',
      'display'                                 => array(
        'default'                               => array(
          'label'                               => 'hidden',
          'module'                              => 'number',
          'settings'                            => array(
            'decimal_separator'                 => '.',
            'prefix_suffix'                     => 1,
            'scale'                             => 0,
            'thousand_separator'                => '',
          ),
          'type'                                => 'number_integer',
          'weight'                              => '5',
        ),
        'full'                                  => array(
          'label'                               => 'hidden',
          'module'                              => 'number',
          'settings'                            => array(
            'decimal_separator'                 => '.',
            'prefix_suffix'                     => 1,
            'scale'                             => 0,
            'thousand_separator'                => '',
          ),
          'type'                                => 'number_integer',
          'weight'                              => '5',
        ),
        'teaser'                                => array(
          'label'                               => 'above',
          'settings'                            => array(),
          'type'                                => 'hidden',
          'weight'                              => '5',
        ),
      ),
      'entity_type'                             => 'node',
      'fences_wrapper'                          => 'p',
      'field_name'                              => 'field_webform_events_participant',
      'label'                                   => 'Participants',
      'required'                                => 0,
      'settings'                                => array(
        'max'                                   => '1000',
        'min'                                   => '0',
        'prefix'                                => '',
        'suffix'                                => '',
        'user_register_form'                    => FALSE,
      ),
      'widget'                                  => array(
        'active'                                => 0,
        'module'                                => 'number',
        'settings'                              => array(),
        'type'                                  => 'number',
        'weight'                                => '5',
      ),
    ),
  );

  // Loop fields.
  foreach ($fields as $field) {
    // Create fields if they don't exist and set instances.
    if (!field_info_field($field['field_config']['field_name'])) {
      $field_structure = $field['field_config'];
      field_create_field($field_structure);

      $instance = $field['field_instance'];
      field_create_instance($instance);
    }
  }
}

/**
 * Implements hook_disable().
 */
function webform_events_disable() {
  drupal_set_message(t("NOTICE: Uninstalling webform event will delete event content type and all event nodes."), 'warning');
}

/**
 * Implements hook_uninstall().
 */
function webform_events_uninstall() {
  // Remove event from webform types.
  $var = variable_get('webform_node_types');
  $var = array_diff($var, array('webform_events'));
  variable_set('webform_node_types', $var);

  // Delete fields.
  $fields = array(
    'field_webform_events_event_image',
    'field_webform_events_description',
    'field_webform_events_end_date',
    'field_webform_events_limit',
    'field_webform_events_participant',
    'field_webform_events_overbooking',
    'field_webform_events_email',
    'field_webform_events_start_date',
  );

  foreach ($fields as $field) {
    field_delete_field($field);
    field_delete_instance($field);
  }

  $sql = 'SELECT nid FROM {node} n WHERE n.type = :type';
  $result = db_query($sql, array(':type' => 'webform_events'));
  $nids = array();

  foreach ($result as $row) {
    $nids[] = $row->nid;
  }

  // Delete all the nodes at once.
  // api.drupal.org/api/function/node_delete_multiple/7.
  node_delete_multiple($nids);

  // Delete our content type.
  // api.drupal.org/api/function/node_type_delete/7.
  node_type_delete('webform_events');
  field_purge_batch(1000);
  drupal_flush_all_caches();

  // Del variables.
  variable_del('webform_events_default_email');
  variable_del('webform_events_default_overbooking');
  variable_del('webform_events_default_limit');
  variable_del('webform_events_default_participants');
  variable_del('webform_events_default_manage_pager');
  variable_del('webform_events_default_profile_pager');
  variable_del('webform_events_show_profile');
  variable_del('webform_events_change_titles');
  variable_del('webform_events_manage_page');
}
