<?php

/**
 * @file
 * Main module file for Views Extra Pagers module.
 */

/**
 * Implements hook_views_api().
 */
function views_extra_pagers_views_api() {
  return array('api' => 3);
}

/**
 * Implements hook_theme().
 */
function views_extra_pagers_theme($existing, $type, $theme, $path) {
  return array(
    'views_extra_pager_full_all' => array(
      'variables' => array('pager' => NULL, 'element' => 0, 'parameters' => array(), 'all_label' => NULL),
      'pattern' => 'views_extra_pager_full_all__',
    ),
    'views_extra_pager_mini_all' => array(
      'variables' => array('pager' => NULL, 'element' => 0, 'parameters' => array(), 'all_label' => NULL),
      'pattern' => 'views_extra_pager_mini_all__',
    ),
  );
}

/**
 * Theme callback for 'views_extra_pager_full_all'.
 *
 * @ingroup themeable
 */
function theme_views_extra_pager_full_all($variables) {
  return views_extra_pager_add_all_link($variables);
}

/**
 * Theme callback for 'views_extra_pager_mini_all'.
 *
 * @ingroup themeable
 */
function theme_views_extra_pager_mini_all($variables) {
  return views_extra_pager_add_all_link($variables);
}

/**
 * Adds 'Show all' link to the standard pager output.
 */
function views_extra_pager_add_all_link($variables) {
  $pager = $variables['pager'];
  $element = $variables['element'];
  $parameters = $variables['parameters'];
  $all_label = $variables['all_label'];

  if (!empty($pager)) {
    if (is_array($pager)) {
      $pager = drupal_render($pager);
    }
    $matches = array();
    // This regular expression should be adapted in the themes which override theme_pager().
    if (preg_match('/(.*<ul[^>]*class=[^>]*pager[^>]*>.*)(<\/ul>.*)/isu', $pager, $matches)) {
      $link_variables = array(
        'text' => !empty($all_label) ? $all_label : t('Show all'),
        'element' => $element,
        'parameters' => $parameters + array('items_per_page' => 'All'),
      );
      $li_all = '<li class="pager-all">' . theme('pager_link', $link_variables) . '</li>';
      $pager = $matches[1] . $li_all . $matches[2];
    }
  }

  return $pager;
}
