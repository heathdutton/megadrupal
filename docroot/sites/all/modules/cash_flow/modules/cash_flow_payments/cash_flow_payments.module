<?php
/**
 * @file
 * Code for the Finance payments feature.
 */

include_once('cash_flow_payments.features.inc');

function cash_flow_payments_form_payment_node_form_alter(&$form, &$form_state) {
  drupal_add_js(drupal_get_path('module', 'cash_flow_payments') . '/cash_flow_payments.js');
}

function cash_flow_payments_views_query_alter(&$view, &$query) {
  if (arg(0) == 'node' && arg(2) == 'edit') {
    $node = menu_get_object();
    if ($node->type == 'payment') {
      $its_this_group = NULL;
      $type = NULL;
      foreach ($query->where as $index => &$condition_group) {
        foreach ($condition_group['conditions'] as &$condition) {
          if ($condition['field'] == 'field_data_field_remaining.field_remaining_value') {
            // Flag this condition group as needing another condition
            // Use $query since that survives the foreach()
            $its_this_group = &$query->where[$index];
          }
          // Figure out the type from the filter setup
          if ($condition['field'] == 'node.type') {
            // Just the first one is fine
            $type = $condition['value'][0];
          }
        }
      }
      if ($its_this_group && $type) {
        $its_this_group['type'] = 'OR';
        $node_field_name = $type == 'income' ? 'field_line_item' : 'field_target_line_item';
        $query_field_name = 'node.nid';

        $target_id_field = field_get_items('node', $node, $node_field_name);
        $target_id = $target_id_field[0]['target_id'];

        $its_this_group['conditions'][] = array(
          'field' => $query_field_name,
          'value' => $target_id,
          'operator' => '=',
        );
      }
    }
  }
}

function _cash_flow_payments_get_paid_sql_field() {
  $paid_field = field_info_field('field_paid');
  $paid_table = _field_sql_storage_tablename($paid_field);
  $paid_column = _field_sql_storage_columnname('field_paid', 'value');
  return array($paid_field, $paid_table, $paid_column);
}

