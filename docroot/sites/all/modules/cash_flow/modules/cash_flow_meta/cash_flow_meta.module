<?php
/**
 * @file
 * Code for the Finance meta feature.
 */

include_once('cash_flow_meta.features.inc');

function computed_field_field_tax_compute(&$entity_field, $entity_type, $entity, $field, $instance, $langcode, $items) {
  $field_amount = field_get_items('node', $entity, 'field_amount');

  // Start with no tax and R&D.
  $entity_field[0]['value'] = 0.00;

  $field_r_d = field_get_items('node', $entity, 'field_r_d');
  $field_r_d[0]['value'] = 0.00;
  cash_flow_field_set_items('node', $entity, 'field_r_d', $field_r_d);

  // Set up some stuff for our checks
  $field_tax_override = field_get_items('node', $entity, 'field_tax_override');
  $field_tax_type = field_get_items('node', $entity, 'field_tax_type');

  // Is the tax override field set?
  if (!empty($field_tax_override[0]['value'])) {
    $entity_field[0]['value'] = (float) $field_tax_override[0]['value'];
  }
  elseif (!empty($field_tax_type[0]['target_id'])) {
    // Is a tax type selected?
    $tax_type = node_load($field_tax_type[0]['target_id']);
    // Round up to the next unit of currency (e.g. dollar, kroner).
    $tt_field_tax_rate = field_get_items('node', $tax_type, 'field_tax_rate');
    $entity_field[0]['value'] = ceil((float) $tt_field_tax_rate[0]['value'] * $field_amount[0]['value']);
  }

  // Calculate the R&D contribution at the same time, if applicable
  $field_r_d_percentage = field_get_items('node', $entity, 'field_r_d_percentage');
  if (!empty($field_r_d_percentage[0]['target_id'])) {
    $rd_type = node_load($field_r_d_percentage[0]['target_id']);
    // Round up to the nearest 1/100 unit of currency (e.g. cent, øre).
    $rdt_field_tax_rate = field_get_items('node', $rd_type, 'field_tax_rate');
    $r_d_tax = $rdt_field_tax_rate[0]['value'];
    $r_d_amount = $field_amount[0]['value'];
    $unrounded = (float) ($r_d_tax * $r_d_amount);
    $field_r_d[0]['value'] = ceil($unrounded / 0.01) * 0.01;
    cash_flow_field_set_items('node', $entity, 'field_r_d', $field_r_d);
  }
}

function computed_field_field_tax_display($field, $entity_field_item) {
  return $entity_field_item['value'];
}

function computed_field_field_r_d_compute(&$entity_field, $entity_type, $entity, $field, $instance, $langcode, $items) {

}

function computed_field_field_r_d_display($field, $entity_field_item) {
  return $entity_field_item['value'];
}

