<?php
/**
 * @file
 * Installation, enabling, disabling and updating tasks.
 */

if (!defined('MARKDOWNIZER_MODULE_NAME')) {
  define('MARKDOWNIZER_MODULE_NAME', 'markdownizer');
}

/**
 * Implements hook_requirements().
 */
function markdownizer_requirements($phase) {
  $requirements = array();

  if ('install' == $phase) {
    // Check Drush availability only when libraries are not installed yet.
    if (_markdownizer_libraries_not_installed()) {
      try {
        _markdownizer_drush();
      }
      catch (\Exception $e) {
        $requirements[MARKDOWNIZER_MODULE_NAME] = [
          'title' => 'Drush',
          'severity' => REQUIREMENT_ERROR,
          'description' => $e->getMessage(),
        ];
      }
    }
  }

  return $requirements;
}

/**
 * Implements hook_install().
 */
function markdownizer_install() {
  if (_markdownizer_libraries_not_installed()) {
    shell_exec(sprintf(
      "%s make %s/%s.make --no-core --y",
      _markdownizer_drush(),
      drupal_get_path('module', MARKDOWNIZER_MODULE_NAME),
      MARKDOWNIZER_MODULE_NAME
    ));
  }
}

/**
 * Implements hook_uninstall().
 */
function markdownizer_uninstall() {
  // Remove module dependencies.
  module_load_include('module', MARKDOWNIZER_MODULE_NAME);

  foreach (markdownizer_libraries_info() as $name => $info) {
    file_unmanaged_delete_recursive(libraries_get_path($name));
  }
}

/**
 * Check existence of necessary libraries.
 *
 * @return bool
 *   FALSE if necessary libraries are not available, TRUE - otherwise.
 */
function _markdownizer_libraries_not_installed() {
  static $result;

  if (!isset($result)) {
    // Load module file to be able to execute the "libraries_info()" hook.
    module_load_include('module', MARKDOWNIZER_MODULE_NAME);
    $result = (bool) array_diff_key(markdownizer_libraries_info(), libraries_get_libraries());
  }

  return $result;
}

/**
 * Get Drush executable file. Needed for testing and installing the module.
 *
 * @throws \Exception
 *   When Drush was not found by execution of "whereis drush", was not
 *   configured by setting the path to executable file into variable or
 *   was not installed.
 *
 * @return string
 *   Path to Drush executable file.
 */
function _markdownizer_drush() {
  static $drush = '';

  if (empty($drush)) {
    $var = sprintf('%s_drush', MARKDOWNIZER_MODULE_NAME);
    $drush = variable_get($var, shell_exec('whereis drush'));

    if (empty($drush) || !shell_exec("$drush --version")) {
      throw new \Exception("Set the '$var' variable by execution of 'drush vset $var /path/to/drush' command. This needed because the Drush executable was not found automatically.");
    }
  }

  return $drush;
}
