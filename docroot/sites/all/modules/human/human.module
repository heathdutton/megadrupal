<?php

/**
 * @file
 * Implements code to enforce human behavior
 */

/**
 * Implements hook_form_alter().
 *
 */
function human_form_alter (&$form, &$form_state, $form_id) {
  $selectedform = variable_get('human_form', 'user_register_form, user_login_form, user_pass, user_login');
  $selected = explode(',', $selectedform);
  $selected = array_filter(array_map('trim', $selected));
  if (in_array($form_id, $selected)) {
    $form['#validate'][] = 'human_behavior_check';
  }
}

/**
 * Check and validate human behavior.
 */
function human_behavior_check(&$form, &$form_state) {
  $token = $form_state['input']['drupal_impression_id'];
  $impression = impression_token_verify($token);
  if ($impression) {
    if (time() - $impression < 10800) {
      return;
    }
  }
  form_set_error('title', t('Catpcha verification failed.'));
}

/**
 * Implements hook_permission().
 */
function human_permission() {
  return array(
    'administer human' => array(
      'title' => t('Administer human module'),
      'description' => t('Perform administration tasks for human module.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function human_menu() {
  $items = array();

  $items['admin/config/people/human'] = array(
    'title' => 'Human Configuration',
    'description' => 'Human form configuration interface.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('human_settings'),
    'access arguments' => array('administer human'),
    'file' => 'human.admin.inc',
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}
