<?php
/**
 * @file
 * Provides a formatter setting that allows fields to be floated left or right.
 */

/**
 * Implements hook_field_formatter_info_alter().
 */
function drifter_field_formatter_info_alter(&$info) {
  foreach ($info as $type => $values) {
    $info[$type]['settings']['drifter_float'] = '';
    $info[$type]['settings']['drifter_margin_side'] = '1em';
    $info[$type]['settings']['drifter_margin_bottom'] = '0.5em';
  }
}

/**
 * Implements hook_field_formatter_settings_form_alter().
 */
function drifter_field_formatter_settings_form_alter(array &$settings_form, array $context) {
  $settings = $context['instance']['display'][$context['view_mode']]['settings'];

  $settings_form['drifter_float'] = array(
    '#type' => 'select',
    '#title' => t('Float'),
    '#options' => array(
      'left' => t('Left'),
      'right' => t('Right'),
    ),
    '#empty_option' => t('- None -'),
    '#default_value' => $settings['drifter_float'],
  );
  $settings_form['drifter_margin_side'] = array(
    '#type' => 'textfield',
    '#title' => t('Side margin'),
    '#default_value' => $settings['drifter_margin_side'],
    '#maxlength' => 7,
    '#size' => 6,
    '#states' => array(
      'invisible' => array(
        'select[name$="[drifter_float]"]' => array('value' => ''),
      ),
    ),
  );
  $settings_form['drifter_margin_bottom'] = array(
    '#type' => 'textfield',
    '#title' => t('Bottom margin'),
    '#default_value' => $settings['drifter_margin_bottom'],
    '#maxlength' => 7,
    '#size' => 6,
    '#states' => array(
      'invisible' => array(
        'select[name$="[drifter_float]"]' => array('value' => ''),
      ),
    ),
  );
}

/**
 * Implements hook_field_formatter_settings_summary_alter().
 */
function drifter_field_formatter_settings_summary_alter(&$summary, array $context) {
  $settings = $context['instance']['display'][$context['view_mode']]['settings'];

  if (!empty($summary)) {
    $summary .= '<br />';
  }
  if (!empty($settings['drifter_float'])) {
    $summary .= t('Float: @side', array('@side' => $settings['drifter_float']));
    $summary .= '<br />' . t('Side margin: @margin', array('@margin' => $settings['drifter_margin_side']));
    $summary .= '<br />' . t('Bottom margin: @margin', array('@margin' => $settings['drifter_margin_bottom']));
  }
  else {
    $summary .= t('Float: None');
  }
}

/**
 * Implements hook_preprocess_HOOK() for theme_field().
 */
function drifter_preprocess_field(&$variables) {
  $element = $variables['element'];
  $settings = field_formatter_settings_get_instance_display_settings($element['#entity_type'], $element['#field_name'], $element['#bundle'], $element['#view_mode']);

  if (!empty($settings['drifter_float'])) {
    $margin_side = ($settings['drifter_float'] == 'left') ? 'right' : 'left';
    $style = '
      .field-name-' . $variables['field_name_css'] . ' {
        float: ' . $settings['drifter_float'] . ';
        margin-' . $margin_side . ': ' . $settings['drifter_margin_side'] . ';
        margin-bottom: ' . $settings['drifter_margin_bottom'] . ';
      }
    ';
    drupal_add_css($style, 'inline');
  }
}

/**
 * Implements hook_preprocess_HOOK() for theme_views_view_field().
 */
function drifter_preprocess_views_view_field(&$variables) {
  $settings = !empty($variables['field']->options['settings']) ? $variables['field']->options['settings'] : array();
  $field_name = str_replace('_', '-', $variables['field']->field);

  if (!empty($settings['drifter_float'])) {
    $margin_side = ($settings['drifter_float'] == 'left') ? 'right' : 'left';
    $style = '
      .views-field-' . $field_name . ' {
        float: ' . $settings['drifter_float'] . ';
        margin-' . $margin_side . ': ' . $settings['drifter_margin_side'] . ';
        margin-bottom: ' . $settings['drifter_margin_bottom'] . ';
      }
    ';
    drupal_add_css($style, 'inline');
  }
}

