<?php
/**
 * @file
 * FedEx Address Validation installation and update handlers
 */

/**
 * Implements hook_requirements().
 */
function fedex_address_validation_requirements($phase) {
  // Only check in runtime and never from admin/config page.
  if ($phase != 'runtime' || current_path() == 'admin/config')  {
    return array();
  }

  $severity = REQUIREMENT_OK;

  // Make sure that the SoapClient API is available.
  if (!class_exists('SoapClient')) {
    $severity = REQUIREMENT_ERROR;
    $value[] = t('SoapClient missing');
  }

  // Make sure that the environment variables are set.
  $current_environment = variable_get('fedex_address_validation_environment', 'test');
  foreach (array('test', 'live') as $environment) {
    $missing = array();
    foreach (array('key', 'password', 'account', 'meter') as $var) {
      if (!variable_get("fedex_address_validation_${environment}_key")) {
        $missing[] = t('Missing environment @environment variable "$var"', array('@environment' => $environment, '@var' => $var));
      }
    }
    if ($missing && ($environment == $current_environment || $environment == 'live')) {
      if (count($missing) == 4) {
        $value[] = t('Not configured for @environment', array('@environment' => $environment));
      }
      else {
        $value[] = array_merge($value, $missing);
      }
      if ($environment == $current_environment) {
        $severity = REQUIREMENT_WARNING;
      }
    }
  }

  // If it's configured OK, try the service.
  if ($severity == REQUIREMENT_OK) {
    $addresses[] = array(
      'name_line' => 'Kurt Waldheim',
      'thoroughfare' => '760 United Nations Pl',
      'premise' => '',
      'locality' => 'NYC',
      'administrative_area' => 'NY',
      'postal_code' => '10017',
      'country' => 'US',
    );
    $response = fedex_address_validation_validate($addresses);
    if (isset($response['error'])) {
      $value[] = $response['error'];
      $severity = REQUIREMENT_WARNING;
    }
    else {
      try {
        if (!isset($response['AddressResults']->ProposedAddressDetails->Changes)) {
          $value[] = t('Unexpected response');
        }
      }
      catch (Exception $e) {
        $value[] = t('Unexpected response format');
        $severity = REQUIREMENT_WARNING;
      }
    }
  }

  // Return the access.
  if (empty($value)) {
    $value[] = t('Installed');
  }
  elseif ($severity == REQUIREMENT_OK) {
    $severity = REQUIREMENT_INFO;
  }
  $requirements['fedex_address_validation'] = array(
    'title' => t('FedEx Address Validation'),
    'value' => implode('; ', $value),
    'severity' => $severity,
  );
  return $requirements;
}
