<?php

/**
 * @file
 * Emphasis provides dynamic paragraph-specific anchor links.
 */

/**
 * Implements hook_menu().
 */
function emphasis_menu() {
  $items = array();

  $items['admin/config/user-interface/emphasis'] = array(
    'title' => 'Emphasis settings',
    'description' => 'Site-wide for the emphasis field formatter.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('emphasis_admin_settings_form'),
    'file' => 'emphasis.admin.inc',
    'access arguments' => array('administer site configuration'),
  );

  return $items;
}

/**
 * Implements hook_libraries_info().
 */
function emphasis_libraries_info() {
  $libraries['emphasis'] = array(
    'name' => 'Emphasis',
    'vendor url' => 'https://github.com/NYTimes/Emphasis',
    'download url' => 'https://github.com/NYTimes/Emphasis',
    'files' => array(
      'js' => array('js/emphasis.js'),
    ),
    'version callback' => 'emphasis_get_library_version',
  );

  return $libraries;
}

/**
 * Gets emphasis version for libraries API.
 */
function emphasis_get_library_version($libraries) {
  // The emphasis library does seem to include version information in any of its
  // files. Hardcoding 1.0 for now, since Libraries API requires a version.
  return '1.0';
}

/**
 * Retrieves an array of field formatters to which Emphasis may be applied.
 */
function emphasis_field_formatters() {
  static $formatters;

  if (isset($formatters)) {
    return $formatters;
  }

  $default_formatters = array(
    'text_default',
    'text_plain',
    'text_trimmed',
    'text_summary_or_trimmed',
  );

  $formatters = array_merge($default_formatters, module_invoke_all('emphasis_field_formatters'));
  drupal_alter('emphasis_field_formatters', $formatters);

  return $formatters;
}

/**
 * Implements hook_field_formatter_info_alter().
 */
function emphasis_field_formatter_info_alter(&$info) {
  $emphasis_formatter_types = emphasis_field_formatters();

  foreach ($emphasis_formatter_types as $emphasis_formatter_type) {
    $info[$emphasis_formatter_type]['settings']['emphasis'] = FALSE;
  }
}

/**
 * Implements hook_field_formatter_settings_form_alter().
 */
function emphasis_field_formatter_settings_form_alter(&$settings_form, $context) {
  $field = $context['field'];
  $display = $context['instance']['display'][$context['view_mode']];
  $settings = $display['settings'];

  $settings_form['emphasis'] = array(
    '#type' => 'checkbox',
    '#title' => t('Enable Emphasis'),
    '#description' => t('Emphasis JS library will be loaded when field is displayed.'),
    '#default_value' => $settings['emphasis'],
  );
}

/**
 * Implements function hook_field_formatter_settings_summary_alter().
 */
function emphasis_field_formatter_settings_summary_alter(&$summary, array $context) {
  $display = $context['instance']['display'][$context['view_mode']];
  $settings = $display['settings'];

  if (isset($settings['emphasis'])) {
    if ($settings['emphasis']) {
      $summary = t('Emphasis: enabled. ') . $summary;
    }
    else {
      $summary = t(' Emphasis: disabled. ') . $summary;
    }
  }
}

/**
 * Implements hook_field_display_alter().
 */
function emphasis_field_display_alter(&$display, $context) {
  if (!empty($display['settings']['emphasis'])) {
    emphasis_load();
  }
}

/**
 * Callback for emphasis theme function.
 */
function emphasis_load() {
  static $emphasis_loaded;

  if (!isset($emphasis_loaded) && libraries_load('emphasis')) {
    $json_settings = array(
      'emphasis' => array(
        'selector' => variable_get('emphasis_selector', '#article-content p'),
        'keyCode' => variable_get('emphasis_key_code', '16'),
        'keyCodeCount' => variable_get('emphasis_key_code_count', '2'),
        'scroll' => variable_get('emphasis_scroll', TRUE),
        'shareThis' => variable_get('emphasis_update_sharethis', TRUE),
        'updateAnchors' => variable_get('emphasis_update_anchors', TRUE),
        'updateOGMetaTags' => variable_get('emphasis_update_og_metatags', TRUE),
        'currentURL' => url(current_path(), array('absolute' => TRUE)),
      ),
    );
    drupal_add_js($json_settings, 'setting');
    drupal_add_js(drupal_get_path('module', 'emphasis') . '/emphasis.js');
    $emphasis_loaded = TRUE;
  }
  else {
    $emphasis_loaded = FALSE;
  }

  return $emphasis_loaded;
}
