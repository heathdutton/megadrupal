<?php

/**
 * @file
 * xache.module
 * Code for the Xache module.
 */

/**
 * Add HTTP header.
 */
function xache_add_header($tag) {
  $tags = &drupal_static(__FUNCTION__, array());
  $tags[$tag] = '';
}

/**
 * Add HTTP header to signal Varnish to remove cache for cetain pages.
 */
function xache_remove($tag) {
  drupal_add_http_header('Xache-Remove', $tag);
}

/**
 * Implements hook_entity_insert().
 */
function xache_entity_insert($entity, $type) {
  xache_remove($entity->type);
}

/**
 * Implements hook_entity_load().
 */
function xache_entity_load($entities, $type) {
  foreach ($entities as $entity) {
    if (isset($entity->type)) {
      xache_add_header($entity->type);
    }
  }
}

/**
 * Implements hook_entity_update().
 */
function xache_entity_update($entity, $type) {
  xache_remove($entity->type);
}

/**
 * Implements hook_page_alter().
 */
function xache_page_alter(&$page) {
  $tags = &drupal_static('xache_add_header', array());
  if (!empty($tags)) {
    drupal_add_http_header('Xache-Contains', implode(',', array_keys($tags)));
  }
}

/**
 * Implements hook_views_query_alter().
 */
function xache_views_query_alter(&$view, &$query) {
  $matches = array();
  preg_match('/node.type","value":\[(.+?)\]/', json_encode($query->where), $matches);
  if (isset($matches[1])) {
    $content_types = explode(',', str_replace('"', '', $matches[1]));
    foreach ($content_types as $content_type) {
      xache_add_header($content_type);
    }
  }
}
