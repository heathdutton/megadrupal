<?php

function tb_halloween_theme() {
  $items = array ();
  $items['tb_halloween_admin_settings'] = array(
    'render element' => 'form',
  );
  return $items;
}

/**
 * Implementation of hook_block_list().
 */
function tb_halloween_block_info() {
  $blocks = array();

  $blocks['tb_halloween_default'] = array(
    'info' => t('Halloween'),
    'cache' => DRUPAL_CACHE_GLOBAL,
  );

  return $blocks;
}

/**
 * Implementation of hook_block_view().
 */
function tb_halloween_block_view() {
  $block = array();
  $js = array();
  $js[] = 'Drupal.TBHalloween = Drupal.TBHalloween || {};';
  $js[] = 'Drupal.TBHalloween.tb_halloween_path = "' . drupal_get_path('module', 'tb_halloween') . '/";';
  $js[] = 'Drupal.TBHalloween.tb_halloween_items = {};';
  $js[] = 'Drupal.TBHalloween.items = Drupal.TBHalloween.items || {};';
  
  $items = tb_halloween_get_items();
  $thumbs = tb_halloween_get_thumbs();
  foreach ($items as $item) {
    $arr = get_object_vars($item);
    $arr['number_pumpkins'] = intval($arr['number_pumpkins']);
    $arr['image'] = tb_halloween_get_image($arr['pumpkin_image'], $arr['size']);
    if(!empty($arr['animation_area'])) {
      $parts = explode(",", $arr['animation_area']);
      if(count($parts) == 4) {
      	$arr['area_left'] = intval($parts[0]);
      	$arr['area_top'] = intval($parts[1]);
      	$arr['area_right'] = intval($parts[2]);
      	$arr['area_bottom'] = intval($parts[3]);
      }
      else {
      	$arr['animation_area'] = false;
      }
    }
    else {
      
    }
    $arr['flying_speed'] = intval($arr['flying_speed']);
    $arr['swing_speed'] = intval($arr['swing_speed']);
    $arr['delay_time'] = intval($arr['delay_time']);
    $arr['delaystart_time'] = intval($arr['delaystart_time']);
    $arr['start_frame'] = intval($arr['start_frame']);
    $arr['closable'] = intval($arr['closable']);
    $arr['width'] = $thumbs[$arr['pumpkin_image']]['size'][$arr['size']]['width'];
    $arr['height'] = $thumbs[$arr['pumpkin_image']]['size'][$arr['size']]['height'];
    $arr['frame'] = $thumbs[$arr['pumpkin_image']]['frame'];
    $preset = $arr['preset'];
    $custom_preset = $arr['custom_preset'];
    $t = $preset == 'custom_preset' ? $custom_preset : $preset;
    $parts = explode(",", $t);
    $arr['pos_array'] = array();
    for($i = 0; $i < count($parts); $i ++) {
      $arr['pos_array'][] = intval($parts[$i]);
    }
    $js[] = 'Drupal.TBHalloween.items[' . $item->id . '] = {}';
  	for ($i = 0; $i < $item->number_pumpkins; $i ++) {
      $js[] = 'Drupal.TBHalloween.items[' . $item->id . '][' . $i . '] = ' . json_encode($arr) . ";";
    }
  }
  drupal_add_js(implode("\n", $js), 'inline');
  $block['content'] = "";
  return $block;
}

/**
 * Implements hook_menu().
 */
function tb_halloween_menu() {
  $items ['admin/structure/tb_halloween'] = array (
    'title' => 'TB Halloween Setting', 
    'description' => t('A block added by the TB Halloween module to create animated images for your website\'s front-end. Provided by <a href="http://www.themebrain.com" target="_blank">themebrain.com</a>'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array ('tb_halloween_admin_settings'),
    'access arguments' => array('administer tb_halloween'),
    'file' => 'tb_halloween.admin.inc', 
  );
  $items ['admin/structure/tb_halloween/add'] = array (
    'title' => 'Add TB Halloween item', 
    'description' => t('Add TB Halloween item.'), 
    'page callback' => 'drupal_get_form', 
    'page arguments' => array ('tb_halloween_add_form'),
    'type' => MENU_LOCAL_ACTION,
    'access arguments' => array('administer tb_halloween'),
    'file' => 'tb_halloween.admin.inc', 
  );
  
  $items['admin/structure/tb_halloween/%tb_halloween_id/edit'] = array(
    'title' => 'Edit menu link',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tb_halloween_add_form', 3),
    'access arguments' => array('administer tb_halloween'),
    'file' => 'tb_halloween.admin.inc',
  );

  $items['admin/structure/tb_halloween/%tb_halloween_id/delete'] = array(
    'title' => 'Edit menu link',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('tb_halloween_confirm_delete', 3),
    'access arguments' => array('administer tb_halloween'),
    'file' => 'tb_halloween.admin.inc',
  );
  
  return $items;
}

/**
 * Implements hook_admin_paths().
 */
function tb_halloween_admin_paths() {
  $paths = array(
    'admin/structure/tb_halloween/*/edit' => TRUE,
    'admin/structure/tb_halloween/*/delete' => TRUE,
  );
  return $paths;
}

function tb_halloween_id_load($id) {
  return db_select('tb_halloween_items', 'i')->fields('i')->condition('id', $id)->execute()->fetchObject();
}


function tb_halloween_get_items() {
  return db_select('tb_halloween_items', 'i')->fields('i')->execute()->fetchAll();
}

function tb_halloween_get_thumbs() {
  return array(
    'pumpkin' => array(
      'thumb' => url(drupal_get_path('module', 'tb_halloween') . '/images/pumpkin-thumb.png'),
      'size' => array(
        'default' => array(
          'width' => 188,
          'height' => 129,
        ),
        'small' => array(
          'width' => 125,
          'height' => 86,
        ),
        'big' => array(
          'width' => 250,
          'height' => 172,
        ),
      ),
      'frame' => 17,
    ),
    'drupal' => array(
      'thumb' => url(drupal_get_path('module', 'tb_halloween') . '/images/drupal-pump-thumb.png'),
      'size' => array(
        'default' => array(
          'width' => 188,
          'height' => 129,
        ),
        'small' => array(
          'width' => 125,
          'height' => 86,
        ),
        'big' => array(
          'width' => 250,
          'height' => 172,
        ),
      ),
      'frame' => 34,
    ),
    'drupal-pump' => array(
      'thumb' => url(drupal_get_path('module', 'tb_halloween') . '/images/drupal-thumb.png'),
      'size' => array(
        'default' => array(
          'width' => 188,
          'height' => 129,
        ),
        'small' => array(
          'width' => 125,
          'height' => 86,
        ),
        'big' => array(
          'width' => 250,
          'height' => 172,
        ),
      ),
      'frame' => 17,
    ),
  );
}

function tb_halloween_number_pumpkins_options() {
  $options = array();
  for($i = 1; $i < 11; $i ++) {
  	$options[$i] = t("@i instance@s", array("@i" => $i, "@s" => ($i > 1) ? "s" : ""));
  }
  return $options;
}

function tb_halloween_animation_types_options() {
  $options = array(
    'random' => t("Random"),
    'preset' => t("Path"),
  );
  return $options;
}

function tb_halloween_sizes_options() {
  $options = array(
    'default' => t("Default"),
    'small' => t("Small"),
    'big' => t('Big'),
  );
  return $options;
}

function tb_halloween_presets_options() {
  $options = array(
    '300, 300, 100, 100, 1000, 100, 1000, 500, 100, 500' => t("Path A"),
    '300, 300, 1000, 100, 100, 100, 100, 500, 1000, 500' => t("Path B"),
    'custom_preset' => t("Custom path"),
  );
  return $options;
}


function tb_halloween_closable_options() {
  $options = array(
    0 => t("No"),
    1 => t("Yes - Temporary"),
    2 => t("Yes - Permanent"),
  );
  return $options;
}

function tb_halloween_get_image($key, $size) {
  if (!in_array($size, array('small', 'big', 'default'))) {
  	$size = 'default';
  }
  return url(drupal_get_path('module', 'tb_halloween') . '/images/' . $key . '-' . $size . '.png');
}

function tb_halloween_get_thumb($key, $size) {
  if (!in_array($size, array('small', 'big', 'default'))) {
  	$size = 'default';
  }
  return url(drupal_get_path('module', 'tb_halloween') . '/images/' . $key . '-thumb-' . $size . '.png');
}

function tb_halloween_get_flying_speed_options() {
  $options = array(
    3000 => t("Default"),
    4500 => t("Slow"),
    1500 => t("Fast"),
  );
  return $options;
}

function tb_halloween_get_swing_speed_options() {
  $options = array(
    40 => t("Default"),
    25 => t("Slow"),
    60 => t("Fast"),
  );
  return $options;
}



