<?php

/**
 * @file
 * Simple Facebook Publish Module for Drupal Sites.
 */

/**
 * Implements hook_simple_fb_scope_info().
 */
function simple_fb_publish_simple_fb_scope_info($scope) {
  $scope[] = 'publish_stream';
  return $scope;
}


/**
 * Implement hook_rules_action_info().

 * Declare any meta data about actions for Rules
 */
function simple_fb_publish_rules_action_info() {
  $actions = array(
    'simple_fb_publish_post_to_fb' => array(
      'label' => t('Post to Facebook'),
      'group' => t('Simple FB Connect'),
      'parameter' => array(
        'message' => array(
          'type' => 'text',
          'label' => t('The body of the FB post'),
        ),
        'link' => array(
          'type' => 'text',
          'label' => t('The link/url on the FB post'),
        ),
        'picture' => array(
          'type' => 'text',
          'label' => t('The picture for FB post'),
          'optional' => FALSE,
          'description' => t('**** IMPORTANT **** : Giving a Replacement Pattern like [node:field-image] will not work. '
              . 'Click on "SWITCH TO DATA SELECTION" below and navigate to the entity element containing the image url. '
              . 'For an image attached to a field, it will look like node:field-image:file:url'
              . 'Make sure to check watchdog logs for more information if you are having trouble configuring this parameter. '),
        ),
        'name' => array(
          'type' => 'text',
          'label' => t('The title for FB post link'),
        ),
        'caption' => array(
          'type' => 'text',
          'label' => t('The caption for FB post'),
        ),
        'description' => array(
          'type' => 'text',
          'label' => t('The link description for FB post'),
        ),
      ),
    ),
  );

  return $actions;
}

/**
 * The action function for simple_fb_publish_post_to_fb.
 */
function simple_fb_publish_post_to_fb($message, $link, $picture, $name, $caption, $description) {
  watchdog('picture', $picture);
  $facebook = facebook_client();
  $fb_user = $facebook->getUser();

  if ($fb_user) {
    $params = array(
      // this is the main access token (facebook profile)
      "message" => drupal_html_to_text($message),
      "link" => $link,
      "picture" => $picture,
      "name" => drupal_html_to_text($name),
      "caption" => $caption,
      "description" => drupal_html_to_text($description),
    );
    try {
      $ret = $facebook->api('/me/feed', 'POST', $params);
    } catch (Exception $e) {
      watchdog('Simple FB Publish', 'Error Writing to wall: @message', array('@message' => $e->getMessage()));
    }
  }
  else {
    watchdog('Simple FB Publish', 'Could not initialise FB user');
  }
}
