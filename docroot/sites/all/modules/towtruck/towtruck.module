<?php
/**
 * @file
 */
define('TowTruckMainJS', 'https://towtruck.mozillalabs.com/towtruck.js');
define('TowTruckEnableAnalytics', FALSE);
define('TowTruckAnalyticsCode', '');
define('TowTruckCloneClicks', FALSE);
define('TowTruckHubBase', 'https://hub.towtruck.mozillalabs.com');

/**
 * Implements hook_init().
 */
function towtruck_init() {
  towtruck_add_js();
}

function towtruck_add_js() {
  // Provide a gate so we only do this once.
  static $done = FALSE;
  if ($done) {
    return;
  }

  $settings = array(
    'TowTruck' => array(
      'TowTruckConfig_enableAnalytics' => variable_get('TowTruckConfig_enableAnalytics', TowTruckEnableAnalytics),
      'TowTruckConfig_analyticsCode' => variable_get('TowTruckConfig_analyticsCode', TowTruckAnalyticsCode),
      'TowTruckConfig_cloneClicks' => variable_get('TowTruckConfig_cloneClicks', TowTruckCloneClicks),
      'TowTruckConfig_hubBase' => variable_get('TowTruckConfig_hubBase', TowTruckHubBase)
    ),
  );

  drupal_add_js($settings, 'setting');
  drupal_add_js(variable_get('towtruck_main_js', TowTruckMainJS));
  drupal_add_js(drupal_get_path('module', 'towtruck') . '/js/towtruck.js');

  $done = TRUE;
}

/**
 * Implements hook_block_info().
 */
function towtruck_block_info() {
  $blocks = array();

  $blocks['towtruck'] = array(
    'info' => t('TowTruck'),
    'cache' => DRUPAL_CACHE_GLOBAL
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function towtruck_block_view($delta = '') {
  $block = array();

  switch ($delta) {
    case 'towtruck':
      $block['subject'] = t('TowTruck');
      $block['content'] = towtruct_block_content();
      break;
  }

  return $block;
}

/**
 * TowTruct block content
 */
function towtruct_block_content() {
  return '<button class="btn" onclick="TowTruck(this); return false;">Start TowTruck</button>';
}

/**
 * Implements hook_menu().
 */
function towtruck_menu() {
  $items = array();
  
  $items['admin/config/user-interface/towtruck'] = array(
    'title' => 'TowTruck',
    'description' => 'Adjust TowTruck settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('towtruck_admin_settings_form'),
    'access arguments' => array('administer site configuration'),
    'file' => 'towtruck.admin.inc',
    'file path' => drupal_get_path('module', 'towtruck') . '/includes'
  );
  
  return $items;
}


/**
 * Implements hook_admin_menu_output_build().
 */
function towtruck_admin_menu_output_build(&$content) {
  if (isset($content['icon'])) {
    $content['icon']['icon']['towtruck'] = array(
      '#title' => t('Start TowTruck'),
      '#access' => user_access('administer site configuration'),
      '#href' => '',
      '#options' => array(
        'attributes' => array('onclick' => 'TowTruck(this)'),
        'fragment' => 'start-towtruck',
      ),
    );
  }
}
