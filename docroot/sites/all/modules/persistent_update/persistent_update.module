<?php

/**
 * @file
 * Core functions for the Persistent Update API module.
 */

/**
 * Implements hook_batch_alter().
 */
function persistent_update_batch_alter(&$batch) {
  foreach ($batch['sets'] as $set_id => $set) {
    // If batch is generated by 'drush updb' or update.php, ensure that the
    // Persistent Update hooks are always run.
    if (isset($set['finished']) && in_array($set['finished'], array('drush_update_finished', 'update_finished'))) {
      foreach ($set['operations'] as $operation_id => $operation) {
        if ($operation[1][0] == 'persistent_update' && $operation[1][1] == 7000) {
          $batch['sets'][$set_id]['operations'][$operation_id][0] = 'persistent_update_update_7000';
        }
      }
    }
  }
}
