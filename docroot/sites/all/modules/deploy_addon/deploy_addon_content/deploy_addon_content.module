<?php
/**
 * @file
 * Code for the Deploy Add-on Content module.
 */

include_once 'deploy_addon_content.features.inc';

/**
 * Implements hook_menu().
 */
function deploy_addon_content_menu() {
  $items = array();

  $items['admin/config/content/deploy_addon/deploy_adhoc_plan'] = array(
    'title' => 'Create Ad Hoc Deploy Plan',
    'description' => 'Create an Ad Hoc Deployment Plan.',
    'page callback' => 'deploy_addon_content_adhoc_plan_page',
    'access arguments' => array('create deploy plan adhoc'),
    'type' => MENU_LOCAL_TASK,
    'file' => 'deploy_addon_content.admin.inc',
  );

  $items['user/%user/deploy_adhoc_plan'] = array(
    'title' => 'Ad Hoc Deploy Plan',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('deploy_addon_content_user_adhoc_plan_form', 1),
    'access callback' => 'deploy_addon_user_edit_access',
    'access arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
    'file' => 'deploy_addon_content.forms.inc',
  );

  return $items;
}

/**
 * Implements hook_user_login().
 */
function deploy_addon_content_user_login(&$edit, $account) {
  // Automatically set ad hoc plan if user setting enabled.
  if (!empty($account->data['deploy_adhoc_plan_auto_login']) &&
    deploy_plan_load($account->name)) {
    deploy_auto_plan_set_session($account->name);
  }
}

/**
 * Access callback for user settings.
 */
function deploy_addon_user_edit_access($account) {
  if (user_access('create deploy plan adhoc') && user_edit_access($account)) {
    return TRUE;
  }
  return FALSE;
}
