<?php

/**
 * @file
 * Provides an integration between Drupal and Karmacracy.
 */

define('KARMACRACY_WIDGET_VERSION', '1.3');

/**
 * Implements hook_help().
 */
function karmacracy_help($path, $arg) {
  switch ($path) {
    case 'admin/help#karmacracy':
      $output = '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The Karmacracy module allows you to insert Karmacracy links into your content and share your posts on Facebook and Twitter. Allows you to insert the Karmacracy Widget in your Drupal site in an easy way. For more information about Karmacracy, go to <a href="@karmacracy">the official site</a>.', array('@karmacracy' => 'http://www.karmacracy.com/')) . '</p>';
      $output .= '<h3>' . t('Uses') . '</h3>';
      $output .= '<dl>';
      $output .= '<dt>' . t('Karmacracy widget') . '</dt>';
      $output .= '<dd>' . t('Users with the <em>Administer site configuration</em> permission can enable and configure Karmacracy widget from the <a href="@karmacracy">Karmacracy administration</a> page, or alternately enable the <em>Karmacracy widget</em> block on the <a href="@blocks">Blocks administration</a> page.', array('@karmacracy' => url('admin/config/services/karmacracy'), '@blocks' => url('admin/structure/block'))) . '</dd>';
      $output .= '</dl>';
      return $output;
  }
}

/**
 * Implements hook_menu().
 */
function karmacracy_menu() {
  $items['admin/config/services/karmacracy'] = array(
    'title' => 'Karmacracy',
    'description' => 'Configure the site description, the number of items per feed and whether feeds should be titles/teasers/full-text.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('karmacracy_admin_settings'),
    'access arguments' => array('administer site configuration'),
    'file' => 'karmacracy.admin.inc',
  );
  return $items;
}

/**
 * Implements hook_theme().
 */
function karmacracy_theme() {
  return array(
    'karmacracy_widget_html' => array(
      'variables' => array('id' => NULL, 'url' => NULL, 'options' => array()),
    ),
  );
}

/**
 * Implements hook_block_info().
 */
function karmacracy_block_info() {
  $blocks['karmacracy'] = array(
    'info' => t('Karmacracy widget'),
    //'cache' => DRUPAL_CACHE_GLOBAL,
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function karmacracy_block_view($delta = '') {
  if ($node = menu_get_object()) {
    $id = $node->nid;
  }
  else {
    $id = 'ID';
  }
  $path = drupal_is_front_page() ? '<front>' : current_path();
  $url = url($path, array('absolute' => TRUE));
  $options = variable_get('karmacracy_widget_settings', karmacracy_widget_default());

  $data['subject'] = NULL;
  $data['content'] = theme('karmacracy_widget_html', array('id' => $id, 'url' => $url, 'options' => $options));
  return $data;
}

/**
 * Implements hook_node_view().
 */
function karmacracy_node_view($node, $view_mode) {
  if (variable_get('karmacracy_widget_active', 1)) {
    if ($view_mode == 'full') {
      $location = variable_get('karmacracy_widget_location', 'body');
      if (($location == 'body' || $location == 'beforebody') && empty($node->in_preview)) {
        $url = url('node/' . $node->nid, array('absolute' => TRUE));
        $options = variable_get('karmacracy_widget_settings', karmacracy_widget_default());
        $node->content['karmacracy_widget'] = array(
          '#markup' => theme('karmacracy_widget_html', array('id' => $node->nid, 'url' => $url, 'options' => $options)),
          '#weight' => $location == 'body' ? 10 : -10,
        );
      }
    }
  }
}

function theme_karmacracy_widget_html($variables) {
  $id = $variables['id'];
  $url = $variables['url'];
  $options = $variables['options'];
  $options += karmacracy_widget_default();

  $kcyjsurl = 'http://rodney.karmacracy.com/widget-'. KARMACRACY_WIDGET_VERSION . '/?id=' . $id;
  $kcyjsurl .= "&type=h";
  $kcyjsurl .= "&width=" . $options["width"];
  $kcyjsurl .= "&sc=" . $options["sc"];
  $kcyjsurl .= "&rb=" . $options["rb"];
  $kcyjsurl .= "&np=" . $options["np"];
  $kcyjsurl .= "&c1=" . ltrim($options["color1"], '#');
  $kcyjsurl .= "&c2=" . ltrim($options["color2"], '#');
  $kcyjsurl .= "&c3=" . ltrim($options["color3"], '#');
  $kcyjsurl .= "&c4=" . ltrim($options["color4"], '#');
  $kcyjsurl .= "&c5=" . ltrim($options["color5"], '#');
  $kcyjsurl .= "&c6=" . ltrim($options["color6"], '#');
  $kcyjsurl .= "&c7=" . ltrim($options["color7"], '#');
  $kcyjsurl .= "&c8=" . ltrim($options["color8"], '#');
  $kcyjsurl .= "&c9=" . ltrim($options["color9"], '#');
  $kcyjsurl .= "&url=" . $url;

  return "<div class=\"kcy_karmacracy_widget_h_$id\"></div><script defer=\"defer\" src=\"$kcyjsurl\"></script>";
}

function karmacracy_widget_default() {
  return array(
    'width' => '700',
    'sc' => 1,
    'rb' => 1,
    'np' => 0,
    'color1' => '#f2f2f2',
    'color2' => '#ffffff',
    'color3' => '#f2f2f2',
    'color4' => '#353535',
    'color5' => '#067dba',
    'color6' => '#ffffff',
    'color7' => '#353535',
    'color8' => '#AD1B25',
    'color9' => '#353535',
  );
}
