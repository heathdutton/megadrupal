<?php

/**
 * Implements hook_form_alter().
 */
function apachesolr_attachments_extra_form_alter(&$form, &$form_state, $form_id) {
	// Alter the bundle settings form.
	if ($form_id == 'apachesolr_attachments_entity_bundle_settings') {
	  // Get indexable bundles.
		$indexable = get_solr_indexable();
		// Go through each select element on the form and add a new option.
		foreach ($indexable as $bundle_name) {
			$form['apachesolr_attachments_entity_bundle_indexing_' . $bundle_name]['#options']['hide'] = t('Show only attachments');
		}
	}
}

/**
 * Implements hook_apachesolr_query_alter().
 */
function apachesolr_attachments_extra_apachesolr_query_alter($query) {
	// Get indexable bundles.
	$indexable = get_solr_indexable();
	// The array to hold any bundle names we want to exclude.
	$excluded = array();
	// Run through the bundles looking for the excluded ones.
	foreach ($indexable as $bundle_name) {
		// If the bundle has the option "hide" set.
		if (variable_get('apachesolr_attachments_entity_bundle_indexing_' . $bundle_name, 'seperate') == 'hide') {
			// Add it to the array.
			$excluded[] = $bundle_name;
		}
	}
	// Compare the two and return an array of node types we want to include.
	$included = array_diff($indexable, $excluded);
	// Build a new filter sub query.
	$filter = new SolrFilterSubQuery('OR');
	// Run through each bundle type.
	foreach ($included as $bundle) {
		// Add a filter for each of them.
    $filter->addFilter('bundle', $bundle);
	}
	// Add it to the actual query.
  $query->addFilterSubQuery($filter);
}

/**
 * This function returns an array of all indexable bundles.
 * The code is pretty much copied from apachesolr_attachments_entity_bundle_settings().
 */
function get_solr_indexable() {
	// Get the Solr environment ID.
	$env_id = apachesolr_default_environment();
	// An array to store all indexable bundles.
	$indexable = array();
	// Run through all entities.
	foreach (entity_get_info() as $entity_type => $entity_info) {
		// If they're indexable by Solr.
    if (!empty($entity_info['apachesolr']['indexable'])) {
			// Run through the entity bundles.
			foreach (apachesolr_get_index_bundles($env_id, $entity_type) as $key => $value) {
				// Add the value to the array.
				$indexable[] = $value;
			}
    }
  }
	return $indexable;
}
