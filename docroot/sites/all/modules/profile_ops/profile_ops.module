<?php

function profile_ops_help($path, $arg) {
  $output = ''; 
  switch ($path) {
    case "admin/help#profile_ops":
      $output = '<p>'.  t("Adds options to mass update profile fields directly from the user management page.") .'</p>';
      break;
  }
  return $output;
}

// Make the edit_profile page accessible to the system
function profile_ops_menu() {
  $items = array();

  $items['admin/user/user/edit_profile'] = array(
    'title' => 'Edit Profile: ',
    'page callback' => 'profile_ops_edit_profile_page',
    'access arguments' => array('access administration pages'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

// Gathers the profile field names from each category and 
// creates an option in the drop down for each one.
function profile_ops_user_operations($form_state = array()){
	
	$operations = array();
	$fields = array();
	foreach(profile_categories() as $data => $arr){
		$result = _profile_get_fields($arr['name']);
		
		while($field = db_fetch_object($result)){
			$args = array('args'=>array('field'=>$field));
				
			$operations['edit_'.$field->name] = 
				array(
			      'label' => t("Edit Profile -> ".$field->title),
			      'callback' => 'profile_ops_edit_profile',
			      'callback arguments'=> $args,			      	
			    );
		}
	}	
		
  return $operations;
}

// Pass on the accounts and callback arguments to the 
// edit_profile page.  If you know a better than using sessions,
// feel free to post it to the issues.
function profile_ops_edit_profile($accounts,$args=array()){
	$_SESSION['edit_profile']=array();
	$_SESSION['edit_profile']['accounts']=$accounts;
	$_SESSION['edit_profile']['args']=$args;
	
	drupal_goto('admin/user/user/edit_profile');	
}

function profile_ops_edit_profile_page(){	
	return drupal_get_form('profile_ops_edit_profile_form');
}

// Render the form
function theme_profile_ops_edit_profile_form($form){
  	$output = drupal_render($form);
  	return $output;
}


// Setup the form fields and redirect back to the user
// management page
function profile_ops_edit_profile_form($form_state){		
		
	$field = $_SESSION['edit_profile']['args']['field'];
	
	$form['profile_field'] = array(
	'#type' => $field->type, 
	'#title' => $field->title, 
	'#size' => 30, 
	'#maxlength' => 64, 
	'#description' => t('Enter the value for this field. Any current values will be overwritten.'),
	); 
	$form['#redirect']="admin/user/user";
	$form['submit'] = array('#type' => 'submit', '#value' => t('Save'));
	
	return $form;
}

// Process the submitted form
function profile_ops_edit_profile_form_submit($form, &$form_state) {
	
	// Could probably do some validation with session values,
	// but i'm lazy
	$accounts = $_SESSION['edit_profile']['accounts'];
	$field = $_SESSION['edit_profile']['args']['field'];
	$field_name = $field->name;
	$field_value = $form_state['values']['profile_field'];
	
	foreach ($accounts as $uid) {
	    $account = user_load(array('uid' => (int)$uid));
	    $edit_field = array($field_name=>$field_value);
	    profile_save_profile($edit_field,$account,$field->category);
	    drupal_set_message(t("<strong>$account->name</strong>: $field->title was updated to: ".$form_state['values']['profile_field']));
  	}
}
