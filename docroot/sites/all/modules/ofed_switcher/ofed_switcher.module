<?php

/**
 * @file
 * Module used to switch between admin and default interface with
 * the Openfed distribution.
 */

/**
 * Implements hook_block_info().
 */
function ofed_switcher_block_info() {
  $blocks = array();
  $blocks['ofed_switcher'] = array(
    'info' => t('Site/CMS Switcher'),
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function ofed_switcher_block_view($delta = '') {
  $block = array();
  switch ($delta) {
    case 'ofed_switcher':
      $block['subject'] = t('Site/CMS Switcher');
      $block['content'] = _ofed_switcher_contents();
      break;
  }
  return $block;
}

/**
 * Generate content for block view.
 */
function _ofed_switcher_contents() {
  drupal_add_css(drupal_get_path('module', 'ofed_switcher') . '/assets/styles/ofed_switcher.css');

  global $user;

  $user_info = '';
  $tool_links = array();

  if ($user->uid != 0) {
    $role_found = FALSE;
    foreach (variable_get('ofed_switcher_roles', array(2)) as $value) {
      if (array_key_exists($value, $user->roles)) {
        $role_found = TRUE;
      }
    }

    if ($role_found || $user->uid == 1) {
      if (variable_get('ofed_switcher_welcome', TRUE)) {
        $user_info = t('Welcome <strong>@user</strong>', array('@user' => $user->name));
      }
      if (user_access('access admin theme') && variable_get('ofed_switcher_goto', TRUE)) {

        if (arg(0) == 'admin' || arg(0) == 'cms' || path_is_admin(current_path())) {
          $tool_links[] = l(t('Go to Front'), '<front>');
        }
        else {
          $tool_links[] = l(t('Go to CMS'), 'cms/startpage');
        }
      }
      if (variable_get('ofed_switcher_profile', FALSE)) {
        $tool_links[] = l(t('My Profile'), 'users/' . $user->name);
      }
      if (variable_get('ofed_switcher_logout', TRUE)) {
        $tool_links[] = l(t('Logout'), 'user/logout');
      }
      return theme('ofed_switcher_block', array(
        'user_info' => $user_info,
        'user_links' => theme('item_list', array('items' => $tool_links)))
      );
    }
  }
  else {
    return '';
  }
}

/**
 * Implements hook_theme().
 */
function ofed_switcher_theme($existing, $type, $theme, $path) {
  return array(
    'ofed_switcher_block' => array(
      'variables' => array('user_info' => NULL, 'user_links' => NULL),
      'template' => 'templates/blocks/ofed_switcher_block_switcher',
    ),
    'ofed_dashboard_page' => array(
      'variables' => array('dashboard' => NULL),
      'template' => 'templates/pages/ofed_switcher_page_dashboard',
    ),
  );
}

/**
 * Implements hook_permission().
 */
function ofed_switcher_permission() {
  return array(
    'access ofed_switcher administration' => array(
      'title' => t('View Site/CMS Switcher administration page'),
    ),
    'access ofed_switcher content' => array(
      'title' => t('View Site/CMS Switcher content'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function ofed_switcher_menu() {
  $items['admin/config/administration/ofed_switcher'] = array(
    'title' => 'Site/CMS Switcher',
    'description' => 'Configure CMS Switcher settings.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('ofed_switcher_admin'),
    'access arguments' => array('access ofed_switcher content'),
    'type' => MENU_NORMAL_ITEM,
  );

  $items['cms/startpage'] = array(
    'title' => 'Start Page',
    'page callback' => 'ofed_switcher_dashboard',
    'page arguments' => array(''),
    'access arguments' => array('access ofed_switcher administration'),
    'type' => MENU_NORMAL_ITEM,
    'weight' => -50,
  );

  return $items;
}

/**
 * Configuration page of the switcher module.
 * @return mixed
 *   The admin form.
 */
function ofed_switcher_admin() {
  $form = array();

  $form['ofed_switcher_welcome'] = array(
    '#type' => 'checkbox',
    '#title' => t('Show Welcome user'),
    '#default_value' => variable_get('ofed_switcher_welcome', TRUE),
    '#description' => '',
  );
  $form['ofed_switcher_goto'] = array(
    '#type' => 'checkbox',
    '#title' => t('Show go to CMS/Front link (note that only user with <em>Access administration theme</em> permission can view the "go to CMS/Front" link)'),
    '#default_value' => variable_get('ofed_switcher_goto', TRUE),
    '#description' => '',
  );
  $form['ofed_switcher_profile'] = array(
    '#type' => 'checkbox',
    '#title' => t('Show profil link'),
    '#default_value' => variable_get('ofed_switcher_profile', FALSE),
    '#description' => '',
  );
  $form['ofed_switcher_logout'] = array(
    '#type' => 'checkbox',
    '#title' => t('Show logout link'),
    '#default_value' => variable_get('ofed_switcher_logout', TRUE),
    '#description' => '',
  );

  $roles = user_roles(TRUE);

  $form['ofed_switcher_roles'] = array(
    '#type' => 'checkboxes',
    '#title' => t('Roles'),
    '#default_value' => variable_get('ofed_switcher_roles', array(2)),
    '#options' => $roles,
    '#required' => TRUE,
    '#description' => t('Choose which role can see this block.<br />Note that only user with <em>Access administration theme</em> permission can view the CMS dashboard'),
  );

  return system_settings_form($form);
}

/**
 * Display the first page in the cms interface to manage content, user, block.
 * @return string
 *   The template content.
 */
function ofed_switcher_dashboard() {
  $dashboard = array();

  // MANAGE QUICK INFO.
  $dashboard['quick-info'] = theme('links__menu_quick_infos', array('links' => menu_navigation_links('menu-quick-infos')));

  // MANAGE CONTENT.
  $dashboard['content'] = array();
  foreach (node_type_get_names() as $content_key => $content_name) {
    $links = array();

    if (user_access('create ' . $content_key . ' content')) {
      $dashboard['content'][$content_name]['label'] = $content_name;
      $links['add'] = l(t('Add'), 'node/add/' . str_replace('_', '-', $content_key), array('html' => TRUE));
    }

    if (user_access('edit any ' . $content_key . ' content')) {
      $dashboard['content'][$content_name]['label'] = $content_name;

      // Links where we can't just simply add 's' at the end.
      $special_links = array(
        'ofed_address' => 'cms/addresses',
        'ofed_news' => 'cms/news',
        'ofed_photogallery' => 'cms/photo-galleries',
        'ofed_press' => 'cms/press',
        'ofed_team' => 'cms/team-members',
      );

      if (array_key_exists($content_key, $special_links)) {
        $links['show'] = l(t('Show'), $special_links[$content_key], array('html' => TRUE));
      }
      else {
        $key = $content_key;

        if (strpos($key, 'ofed') !== FALSE) {
          $key = substr($content_key, 5);
        }

        // We assume that the path to the cms views is
        // cms/<content_type_machine_name_with_s>.
        if (drupal_valid_path('cms/' . $key . 's')) {
          $links['show'] = l(t('Show'), 'cms/' . $key . 's', array('html' => TRUE));
        }
      }
    }

    if (!empty($links)) {
      $dashboard['content'][$content_name]['links'] = implode(' / ', $links);
    }
  }

  // MANAGE USER.
  if (user_access('administer users') || user_access('administer permissions')) {
    $dashboard['user'] = array();
    if (user_access('administer users')) {
      $dashboard['user'][t('Users')] = array(t('Add user') => 'admin/people/create');
    }
    if (user_access('administer permissions')) {
      $dashboard['user'][t('Roles')] = array(t('Add role') => 'admin/people/roles');
      $dashboard['user'][t('Permissions')] = array(t('Configure permissions') => 'admin/people/permissions');
    }
  }

  // MANAGE BLOCK.
  if (user_access('administer blocks')) {
    $dashboard['block'] = array();
    $dashboard['block'][t('Blocks')] = array(t('Add Block') => 'admin/structure/block/add');

    if (module_exists('menu_block')) {
      $dashboard['block'][t('Menu Blocks')] = array(t('Add Menu Block') => 'admin/structure/block/add-menu-block');
    }
    $dashboard['block'][t('Configuration')] = array(t('Configure block') => 'admin/structure/block');
  }

  return theme('ofed_dashboard_page', array('dashboard' => $dashboard));
}

/**
 * Implements hook_theme_registry_alter().
 */
function ofed_switcher_theme_registry_alter(&$theme_registry) {
  $mod_path = drupal_get_path('module', 'ofed_switcher');
  // Munge on a copy.
  $theme_registry_copy = $theme_registry;
  _theme_process_registry($theme_registry_copy, 'phptemplate', 'theme_engine', 'pow', $mod_path);
  $theme_registry += array_diff_key($theme_registry_copy, $theme_registry);
  $hooks = array('node');
  foreach ($hooks as $h) {
    _ofed_switcher_insert_after_first_element($theme_registry[$h]['theme paths'], $mod_path);
  }
}

/**
 * Helper function for re-ordering arrays (needed by theme_registry_alter).
 */
function _ofed_switcher_insert_after_first_element(&$a, $element) {
  if (is_array($a)) {
    $first_element = array_shift($a);
    array_unshift($a, $first_element, $element);
  }
}
