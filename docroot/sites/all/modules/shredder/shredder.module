<?php

/**
 * @file
 * Makes text-data in fields unreadable.
 */


/**
 * Implementation of hook_menu().
 */
function shredder_menu() {
  $items = array();

  $items['admin/config/content/shredder'] = array(
    'title' => 'Data shredder',
    'page callback' => 'shredder_form',
    'access arguments' => array('use data shredder'),
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}

/**
 * Implements hook_permission().
 */
function shredder_permission() {
  return array(
    'use data shredder' => array(
      'title' => t('Use Data Shredder'),
      'restrict access' => TRUE,
    ),
  );
}

/**
 * Page callback for admin/config/content/shredder.
 */
function shredder_form($step = NULL) {
  module_load_include('inc', 'shredder', 'shredder.admin');
  $form_info = array(
    'id' => 'erpal-shredder-form',
    'path' => "admin/config/content/shredder/%step",
    'show trail' => TRUE,
    'show back' => TRUE,
    'show return' => FALSE,
    'next callback' =>  'shredder_wizard_next',
    'finish callback' => 'shredder_wizard_finish',
    'order' => array(
      'step1' => t('Select Entity types'),
      'step2' => t('Select Bundles'),
      'step3' => t('Select Field types'),
      'step4' => t('Select Fields'),
      'step5' => t('Shredder data'),
    ),
    'forms' => array(
      'step1' => array(
        'form id' => 'shredder_step_1'
      ),
      'step2' => array(
        'form id' => 'shredder_step_2'
      ),
      'step3' => array(
        'form id' => 'shredder_step_3'
      ),
      'step4' => array(
        'form id' => 'shredder_step_4'
      ),
      'step5' => array(
        'form id' => 'shredder_step_5'
      ),
    ),
  );

  // Object caching.
  $object_id = 'shredder';
  if (empty($step)) {
    shredder_cache_clear($object_id);
  }

  $object = shredder_cache_get($object_id);
  $form_state = array(
    'object_id' => $object_id,
    'object' => &$object,
  );

  ctools_include('wizard');
  $form = ctools_wizard_multistep_form($form_info, $step, $form_state);
  $output = drupal_render($form);

  return $output;
}
