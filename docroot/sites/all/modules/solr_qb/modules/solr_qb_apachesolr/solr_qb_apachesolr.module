<?php
/**
 * @file
 * Main module file.
 */

/**
 * Implements hook_solr_qb_driver().
 */
function solr_qb_apachesolr_solr_qb_driver() {
  return array(
    'apachesolr' => array(
      'name' => t('Apachesolr'),
      'driver class' => 'SolrQbApachesolrDriver',
      'parameters callback' => 'solr_qb_apachesolr_get_parameters',
    ),
  );
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function solr_qb_apachesolr_form_solr_qb_settings_form_alter(&$form, &$form_state, $form_id) {
  $options = array();
  $environments = solr_qb_apachesolr_find_environments();
  foreach ($environments as $id => $environment) {
    $options[$id] = $environment['name'];
  }

  $default = variable_get('solr_qb_apachesolr_environment');
  if (!isset($environments[$default])) {
    $default = NULL;
  }

  $form['solr_qb_apachesolr'] = array(
    '#title' => t('Apachesolr'),
    '#type' => 'fieldset',
    '#states' => array(
      'visible' => array(
        ':input[name="solr_qb_driver"]' => array('value' => 'apachesolr'),
      ),
    ),
  );
  $form['solr_qb_apachesolr']['solr_qb_apachesolr_environment'] = array(
    '#type' => 'select',
    '#title' => t('Environment'),
    '#options' => $options,
    '#default_value' => $default,
  );
}

/**
 * Get environment.
 */
function solr_qb_apachesolr_get_parameters() {
  return variable_get('solr_qb_apachesolr_environment');
}

/**
 * Find Apachesolr environments.
 *
 * @param string $class
 *   Environment class.
 *
 * @return array
 *   Environments array.
 */
function solr_qb_apachesolr_find_environments($class = '') {
  $environments = apachesolr_load_all_environments();
  foreach ($environments as $id => $environment) {
    if ($environment['service_class'] != $class) {
      unset($environments[$id]);
    }
  }
  return $environments;
}
