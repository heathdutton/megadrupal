<?php
/**
 * @file
 * Main module file.
 */

/**
 * Implements hook_solr_qb_driver().
 */
function solr_qb_search_api_acquia_solr_qb_driver() {
  return array(
    'search_api_acquia' => array(
      'name' => t('Acquia Search (search_api_acquia)'),
      'driver class' => 'SolrQbSearchApiAcquiaDriver',
      'parameters callback' => 'solr_qb_search_api_acquia_get_parameters',
    ),
  );
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function solr_qb_search_api_acquia_form_solr_qb_settings_form_alter(&$form, &$form_state, $form_id) {
  $options = array();
  $servers = solr_qb_search_api_solr_find_servers('acquia_search_service');
  foreach ($servers as $server) {
    $options[$server->machine_name] = $server->name;
  }

  $default = variable_get('solr_qb_search_api_acquia_server');
  if (!isset($servers[$default])) {
    $default = NULL;
  }

  $form['solr_qb_search_api_acquia'] = array(
    '#title' => t('Acquia Search (Search API)'),
    '#type' => 'fieldset',
    '#states' => array(
      'visible' => array(
        ':input[name="solr_qb_driver"]' => array('value' => 'search_api_acquia'),
      ),
    ),
  );
  $form['solr_qb_search_api_acquia']['solr_qb_search_api_acquia_server'] = array(
    '#type' => 'select',
    '#title' => t('Server'),
    '#options' => $options,
    '#default_value' => $default,
  );
}

/**
 * Get server object.
 */
function solr_qb_search_api_acquia_get_parameters() {
  $server = NULL;
  if ($server_id = variable_get('solr_qb_search_api_acquia_server')) {
    $server = search_api_server_load($server_id);
  }
  return $server;
}
