<?php
/**
 * @file
 * Main module file.
 */

/**
 * Implements hook_solr_qb_driver().
 */
function solr_qb_search_api_solr_solr_qb_driver() {
  return array(
    'search_api_solr' => array(
      'name' => t('Search API Solr'),
      'driver class' => 'SolrQbSearchApiSolrDriver',
      'parameters callback' => 'solr_qb_search_api_solr_get_parameters',
    ),
  );
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function solr_qb_search_api_solr_form_solr_qb_settings_form_alter(&$form, &$form_state, $form_id) {
  $options = array();
  $servers = solr_qb_search_api_solr_find_servers();
  foreach ($servers as $server) {
    $options[$server->machine_name] = $server->name;
  }

  $default = variable_get('solr_qb_search_api_solr_server');
  if (!isset($servers[$default])) {
    $default = NULL;
  }

  $form['solr_qb_search_api_solr'] = array(
    '#title' => t('Search API Solr'),
    '#type' => 'fieldset',
    '#states' => array(
      'visible' => array(
        ':input[name="solr_qb_driver"]' => array('value' => 'search_api_solr'),
      ),
    ),
  );
  $form['solr_qb_search_api_solr']['solr_qb_search_api_solr_server'] = array(
    '#type' => 'select',
    '#title' => t('Server'),
    '#options' => $options,
    '#default_value' => $default,
  );
}

/**
 * Get server object.
 */
function solr_qb_search_api_solr_get_parameters() {
  $server = NULL;
  if ($server_id = variable_get('solr_qb_search_api_solr_server')) {
    $server = search_api_server_load($server_id);
  }
  return $server;
}

/**
 * Find Search API servers by used class.
 *
 * @param string $class
 *   Search API server class.
 *
 * @return array|\SearchApiServer[]
 *   Servers objects array.
 */
function solr_qb_search_api_solr_find_servers($class = 'search_api_solr_service') {
  $servers = array();
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'search_api_server')
    ->propertyCondition('class', $class);
  $result = $query->execute();
  if (isset($result['search_api_server'])) {
    $servers = search_api_server_load_multiple(array_keys($result['search_api_server']));
  }
  return $servers;
}
