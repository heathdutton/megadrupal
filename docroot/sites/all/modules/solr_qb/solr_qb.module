<?php
/**
 * @file
 * Main module file.
 */

/**
 * Implements hook_menu().
 */
function solr_qb_menu() {
  $items = array();
  $items['admin/config/development/solr_qb'] = array(
    'title' => 'Solr Query Builder',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('solr_qb_builder_form'),
    'access arguments' => array('access solr_qb'),
    'file' => 'includes/solr_qb.forms.inc',
  );
  $items['admin/config/development/solr_qb/builder'] = array(
    'title' => 'Builder',
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  $items['admin/config/development/solr_qb/custom'] = array(
    'title' => 'Custom Query',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('solr_qb_custom_form'),
    'access arguments' => array('access solr_qb'),
    'file' => 'includes/solr_qb.forms.inc',
    'type' => MENU_LOCAL_TASK,
  );
  $items['admin/config/development/solr_qb/settings'] = array(
    'title' => 'Settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('solr_qb_settings_form'),
    'access arguments' => array('access solr_qb'),
    'file' => 'includes/solr_qb.admin.inc',
    'type' => MENU_LOCAL_TASK,
  );
  return $items;
}

/**
 * Implements hook_permission().
 */
function solr_qb_permission() {
  $permission = array(
    'access solr_qb' => array(
      'title' => t('Access Solr Query Builder'),
    ),
  );
  return $permission;
}

/**
 * Implements hook_solr_qb_driver().
 */
function solr_qb_solr_qb_driver() {
  return array(
    'custom' => array(
      'name' => t('Custom Solr driver'),
      'driver class' => 'SolrQbCustomDriver',
      'parameters callback' => 'solr_qb_get_custom_parameters',
    ),
  );
}

/**
 * Attach connection file and return class name.
 */
function solr_qb_get_driver() {
  $driver = NULL;
  $connection_id = variable_get('solr_qb_driver', 'custom');

  foreach (module_implements('solr_qb_driver') as $module) {
    $items = call_user_func($module . '_solr_qb_driver');
    if (isset($items[$connection_id])) {
      $driver_class = $items[$connection_id]['driver class'];
      $params = NULL;
      if (isset($items[$connection_id]['parameters callback'])) {
        $params = call_user_func($items[$connection_id]['parameters callback']);
      }
      $driver = new $driver_class($params);
      break;
    }
  }

  return $driver;
}

/**
 * Get parameters for Solr QB Custom connection.
 */
function solr_qb_get_custom_parameters() {
  return variable_get('solr_qb_custom_settings');
}
