<?php
/**
 * @file
 * Provides an exporter for Webform to export directly to Google Drive.
 */

/**
 * Implements hook_menu().
 */
function webform_google_exporter_menu() {
  $items['webform/google-exporter'] = array(
    'title' => 'Webform Google Export',
    'page callback' => 'webform_google_exporter_oauth_callback',
    'access callback' => TRUE,
    'file' => 'includes/webform_google_exporter.pages.inc',
    'description' => 'OAuth callback to handle the token request from Google and then send the export to Google.',
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Access callback; Check if a user has results access to a particular node.
 */
function webform_google_exporter_oauth_access() {
  if (isset($_GET['nid']) && ($node = node_load($_GET['nid']))) {
    return webform_results_access($node);
  }
  else {
    return FALSE;
  }
}

/**
 * Implements hook_webform_exporters().
 *
 * Defines the exporters this module implements.
 *
 * @return
 *   An "array of arrays", keyed by content-types. The 'handler' slot
 *   should point to the PHP class implementing this flag.
 */
function webform_google_exporter_webform_exporters() {
  return array(
    'google' => array(
      'title' => t('Send to Google Drive (Google Docs)'),
      'description' => t('Open as a spreadsheet in Google Docs. Large data sets (<a href="https://support.google.com/drive/answer/37603?hl=en">more than 200 columns or 400,000 cells</a>) may not import into Google Docs correctly.'),
      'handler' => 'webform_google_exporter',
      'file' => drupal_get_path('module', 'webform_google_exporter') . '/includes/webform_google_exporter.php',
    ),
  );
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function webform_google_exporter_form_webform_admin_settings_alter(&$form, $form_state) {
  $form['webform_google_exporter'] = array(
    '#type' => 'fieldset',
    '#title' => t('Webform Google exporter'),
    '#collapsible' => TRUE,
    '#collapsed' => (bool) variable_get('webform_google_exporter_client_id', NULL),
    '#id' => 'google-exporter',
    '#weight' => 10,
  );
  $form['webform_google_exporter']['webform_google_exporter_client_id'] = array(
    '#type' => 'textfield',
    '#title' => t('Google client ID'),
    '#default_value' => variable_get('webform_google_exporter_client_id', NULL),
    '#description' => t('Enter your app\'s <a href="https://developers.google.com/drive/auth/web-server#create_a_client_id_and_client_secret">Google client key</a>. i.e. <code>012345678910.apps.googleusercontent.com</code>')
  );
  $form['webform_google_exporter']['webform_google_exporter_client_secret'] = array(
    '#type' => 'textfield',
    '#title' => t('Google client secret'),
    '#default_value' => variable_get('webform_google_exporter_client_secret', NULL),
    '#description' => t('Enter your app\'s <a href="https://developers.google.com/drive/auth/web-server#create_a_client_id_and_client_secret">Google client secret</a>. i.e. <code>z5faWiNe5rUokBNtBgBadcO7</code>')
  );
  $form['webform_google_exporter']['webform_google_exporter_redirect_uri'] = array(
    '#type' => 'markup',
    '#title' => t('Redirect URI'),
    '#markup' => '<code>' . url('webform/google-exporter', array('absolute' => TRUE)). '</code>',
    '#description' => t('Include this URL in the list of "Redirect URIs" in your Google App\'s settings. This URL <strong>must</strong> be publicly accessible for the Google export to work.'),
    '#theme_wrappers' => array('form_element'),
  );
}
