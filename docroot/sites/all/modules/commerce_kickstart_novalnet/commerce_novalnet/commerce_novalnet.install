<?php
/**
 * @file
 * Novalnet payment method module
 * This module is used for real time processing of
 * Novalnet transaction of customers.
 *
 * Copyright (c) Novalnet AG
 *
 * Released under the GNU General Public License
 * This free contribution made by request.
 * If you have found this script useful a small
 * recommendation as well as a comment on merchant form
 * would be greatly appreciated.
 *
 * Script : commerce_novalnet.install
 *
 */
/**
 * Implements hook_uninstall().
 *
 * @param none
 * @return none
 */
function commerce_novalnet_uninstall() {
    variable_del('novalnet_config');
    $delete_rule = db_delete('rules_config')
        ->condition('name', '%novalnet%', 'LIKE')
        ->execute();
}

/**
 * Implementation of hook_schema().
 *
 * @param none
 * @return array
 */
function commerce_novalnet_schema() {
    $schema = array();

    $schema['commerce_novalnet_invoice_trxn_detail'] = array(
        'description'   => 'Contains Invoice and Prepayment transaction bank account details',
        'fields'        => array(
            'id'              => array('type' => 'serial', 'length' => 11, 'not null' => TRUE),
            'order_no'        => array('type' => 'varchar', 'length' => 255, 'not null' => FALSE),
            'tid'             => array('type' => 'int', 'size' => 'big', 'unsigned' => TRUE, 'not null' => TRUE),
            'test_mode'       => array('type' => 'int', 'size' => 'tiny', 'length' => 1, 'not null' => FALSE, 'default' => 0),
            'account_holder'  => array('type' => 'varchar', 'length' => 150, 'not null' => FALSE),
            'account_number'  => array('type' => 'varchar', 'length' => 100, 'not null' => FALSE),
            'bank_code'       => array('type' => 'varchar', 'length' => 100, 'not null' => FALSE),
            'bank_name'       => array('type' => 'varchar', 'length' => 150, 'not null' => FALSE),
            'bank_city'       => array('type' => 'varchar', 'length' => 150, 'not null' => FALSE),
            'amount'          => array('type' => 'int', 'size' => 'big', 'not null' => TRUE),
            'currency'        => array('type' => 'char', 'length' => 4, 'not null' => TRUE),
            'bank_iban'       => array('type' => 'varchar', 'length' => 150, 'not null' => FALSE),
            'bank_bic'        => array('type' => 'varchar', 'length' => 100, 'not null' => FALSE),
            'due_date'        => array('type' => 'varchar', 'length' => 30, 'not null' => FALSE),
            'update_date'     => array('type' => 'int', 'not null' => TRUE),
        ),
        'primary key' => array('id'),
        'indexes' => array(
            'order_no'  => array('order_no'),
        ),
    );

    $schema['commerce_novalnet_transaction_detail'] = array(
        'description' => 'Novalnet transaction history',
        'fields' => array(
            'id'                => array('type' => 'serial', 'length' => 11, 'not null' => TRUE),
            'tid'               => array('type' => 'int', 'size' => 'big', 'unsigned' => TRUE, 'not null' => TRUE),
            'vendor_id'         => array('type' => 'int',  'unsigned' => TRUE, 'not null' => TRUE),
            'authcode'          => array('type' => 'varchar', 'length' => 150, 'not null' => TRUE),
            'tariff_id'         => array('type' => 'int',  'unsigned' => TRUE, 'not null' => TRUE),
            'product_id'        => array('type' => 'int',  'unsigned' => TRUE, 'not null' => TRUE),
            'subs_id'           => array('type' => 'varchar', 'length' => 11, 'not null' => TRUE),
            'payment_id'        => array('type' => 'int', 'unsigned' => TRUE, 'not null' => TRUE),
            'status'            => array('type' => 'varchar', 'length' => 9, 'not null' => TRUE),
            'payment_type'      => array('type' => 'varchar', 'length' => 50, 'not null' => TRUE),
            'amount'            => array('type' => 'int', 'unsigned' => TRUE, 'not null' => TRUE),
            'currency'          => array('type' => 'char', 'length' => 4, 'not null' => TRUE),
            'gateway_status'    => array('type' => 'varchar', 'length' => 9, 'not null' => TRUE),
            'test_mode'         => array('type' => 'int', 'size' => 'tiny',  'length' => 1, 'not null' => FALSE, 'default' => 0),
            'customer_id'       => array('type' => 'varchar', 'length' => 10, 'not null' => FALSE, 'default' => NULL),
            'order_no'          => array('type' => 'varchar', 'length' => 255, 'not null' => FALSE, 'default' => NULL),
            'is_affiliate'      => array('type' => 'int', 'size' => 'tiny',  'length' => 1, 'not null' => FALSE, 'default' => NULL),
            'update_date'       => array('type' => 'int', 'not null' => TRUE),
            'process_key'       => array('type' => 'varchar', 'length' => 255, 'not null' => FALSE, 'default' => NULL),
            'account_holder'    => array('type' => 'varchar', 'length' => 150, 'not null' => FALSE, 'default' => NULL),
            'org_total'         => array('type' => 'int', 'not null' => FALSE, 'default' => NULL),
            'refunded_amount'   => array('type' => 'int', 'not null' => FALSE, 'default' => NULL),
        ),
        'primary key' => array('id'),
        'indexes' => array(
            'order_no'  => array('order_no'),
            'tid'       => array('tid'),
            'customer_id'       => array('customer_id'),
        ),
    );
    $schema['commerce_novalnet_subscription_detail'] = array(
        'description' => 'Novalnet subscription transaction details',
        'fields'      => array(
            'id'                 => array('type' => 'serial', 'not null' => TRUE),
            'order_no'           => array('type' => 'varchar', 'length' => 255, 'not null' => FALSE),
            'tid'                => array('type' => 'int', 'size' => 'big', 'unsigned' => TRUE, 'not null' => TRUE),
            'subs_id'            => array('type' => 'varchar', 'length' => 11, 'not null' => TRUE),
            'signup_date'        => array('type' => 'int', 'not null' => FALSE),
            'termination_reason' => array('type' => 'varchar', 'length' => 255, 'not null' => FALSE),
            'termination_at'     => array('type' => 'int', 'not null' => FALSE),
            'update_date'        => array('type' => 'int', 'not null' => TRUE),
        ),
        'primary key' => array('id'),
        'indexes' => array(
            'order_no'  => array('order_no'),
            'tid'       => array('tid'),
        ),
    );
    $schema['commerce_novalnet_callback_history'] = array(
        'description' => 'Novalnet callback history',
        'fields' => array(
            'id'                => array('type' => 'serial', 'not null' => TRUE),
            'payment_type'      => array('type' => 'varchar', 'length' => 100, 'not null' => FALSE),
            'status'            => array('type' => 'varchar', 'length' => 20, 'not null' => FALSE),
            'order_no'          => array('type' => 'varchar', 'length' => 255, 'not null' => FALSE),
            'callback_tid'      => array('type' => 'int', 'size' => 'big', 'not null' => FALSE, 'default' => 0),
            'org_tid'           => array('type' => 'int', 'size' => 'big',  'unsigned' => TRUE, 'not null' => TRUE),
            'amount'            => array('type' => 'int', 'size' => 'big', 'unsigned' => TRUE, 'not null' => TRUE),
            'currency'          => array('type' => 'varchar', 'length' => 5, 'not null' => FALSE),
            'callback_date'     => array('type' => 'int', 'not null' => TRUE),
        ),
        'primary key' => array('id'),
        'indexes' => array(
            'order_no'  => array('order_no'),
            'org_tid'   => array('org_tid'),
        )
    );
    $schema['commerce_novalnet_affiliate_account'] = array(
        'description' => 'Novalnet Affiliate account details',
        'fields' => array(
            'id'                => array('type' => 'serial', 'not null' => TRUE),
            'vendor_id'         => array('type' => 'int', 'unsigned' => TRUE, 'not null' => TRUE),
            'authcode'          => array('type' => 'varchar', 'length' => 150, 'not null' => TRUE),
            'product_id'        => array('type' => 'int',  'unsigned' => TRUE, 'not null' => TRUE),
            'product_url'       => array('type' => 'varchar', 'length' => 255, 'not null' => FALSE),
            'activation_date'   => array('mysql_type' => 'DATETIME', 'not null' => TRUE),
            'aff_id'            => array('type' => 'int',  'unsigned' => TRUE, 'not null' => TRUE),
            'aff_authcode'      => array('type' => 'varchar', 'length' => 150, 'not null' => TRUE),
            'aff_accesskey'     => array('type' => 'varchar', 'length' => 150, 'not null' => TRUE),
            'update_date'       => array('type' => 'int', 'not null' => TRUE),
        ),
        'primary key' => array('id'),
        'indexes' => array(
            'aff_id'    => array('aff_id'),
        )
    );

  return $schema;
}
