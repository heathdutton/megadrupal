<?php
/**
 * Bad Performance Module.
 */

/**
 * Implements hook_menu().
 */
function bad_performance_menu() {
  $items = array();

  $items['admin/config/development/bad_performance'] = array(
    'title' => t('Bad Performance'),
    'description' => t('Configure how badly this site should perform.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bad_performance_admin_settings'),
    'file' => 'bad_performance.admin.inc',
    'access arguments' => array('administer site configuration'),
  );

  return $items;
}

/**
 * Implements hook_query_alter().
 *
 * Added database latency by inserting sleeps into all DB queries.
 * Mitigate this by making Drupal query the database less.
 */
function bad_performance_query_alter(QueryAlterableInterface $query) {
  $db_latency = variable_get('bad_performance_db_latency', 0);
  if ($db_latency > 0 and $db_latency < 1000) {
    $query->addExpression('SLEEP(' . $db_latency / 1000 . ')');
  }
}

/**
 * API Function to calculate a bunch of primes to waste cpu time.
 */
function bad_performance_burn_cpu($m = 5) {
   $m *= variable_get('bad_performance_cpu_burn_multiplier', 0);

   $i = time();
   for ($n = 0; $n < 10000 * $m; $n++) {
     $i = gmp_nextprime($n*time());
   } 
}

/**
 * Implements hook_boot().
 *
 * Of course the "bad performance" module needs to implement hook_boot().
 */
function bad_performance_boot() {
  bad_performance_burn_cpu();
}

/**
 * Implements hook_entity_load().
 *
 * Get slower and slower the more entities you try and load.
 */
function bad_performance_entity_load($entities, $type) {
  static $calls = 1;

  foreach ($entities as $entity) {
    bad_performance_burn_cpu($calls);
  }
}
