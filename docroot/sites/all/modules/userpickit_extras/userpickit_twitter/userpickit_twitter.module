<?php

/**
 * @file
 * Main file for User Pic Kit Twitter.
 */

/**
 * Implements hook_userpickit_info().
 */
function userpickit_twitter_userpickit_info() {
  $picture_types = array();

  $picture_types['twitter'] = array(
    'title' => t('Twitter'),
    'description' => t('Your Twitter avatar.'),
    'callback' => 'userpickit_twitter_userpickit_picture',
  );

  return $picture_types;
}

/**
 * Implements hook_userpickit_picture().
 */
function userpickit_twitter_userpickit_picture($picture_type, $account) {
  if (isset($account->twitter_accounts[0])) {
    $twitter_account = $account->twitter_accounts[0];
    if ($twitter_account instanceof TwitterUser) {
      $search = '_normal.';
      $replace = '.';
      $picture_url = $twitter_account->profile_image_url;
      // @see https://dev.twitter.com/docs/user-profile-images-and-banners
      $picture_url_original = str_replace($search, $replace, $picture_url);
      return array(
        'uri' => $picture_url_original,
        'message' => t('Picture from your Twitter account: @@screen_name', array(
          '@screen_name' => $twitter_account->screen_name,
        )),
      );
    }
  }

  if (user_access('add twitter accounts', $account) && $account->uid) {
    $message = t('!configure your Twitter account.', array(
      '!configure' => l(t('Configure'), 'user/' . $account->uid . '/edit/twitter'),
    ));
  }
  else {
    $message = t('You do not have permission to add a Twitter account.');
  }

  return array(
    'message' => $message,
  );
}

/**
 * Hook into Twitter account add form.
 *
 * Implements hook_form_BASE_FORM_ID_alter().
 */
function userpickit_twitter_form_twitter_account_form_alter(&$form, &$form_state, $form_id) {
  $form['#submit'][] = 'userpickit_twitter_twitter_account_add_submit';
}

/**
 * Form submission callback.
 *
 * @see userpickit_twitter_form_twitter_account_form_alter()
 */
function userpickit_twitter_twitter_account_add_submit(&$form, &$form_state) {
  if (!empty($form_state['values']['uid'])) {
    userpickit_cache_invalidate('twitter', $form_state['values']['uid']);
  }
}

/**
 * Hook into Twitter account edit/delete.
 *
 * Implements hook_form_BASE_FORM_ID_alter().
 */
function userpickit_twitter_form_twitter_account_list_form_alter(&$form, &$form_state, $form_id) {
  $form['#submit'][] = 'userpickit_twitter_twitter_account_edit_submit';
}

/**
 * Form submission callback.
 *
 * @see userpickit_twitter_form_twitter_account_list_form_alter()
 */
function userpickit_twitter_twitter_account_edit_submit(&$form, &$form_state) {
  $accounts = $form_state['values']['accounts'];
  foreach ($accounts as $account) {
    if (!empty($account['uid'])) {
      userpickit_cache_invalidate('twitter', $account['uid']);
    }
  }
}