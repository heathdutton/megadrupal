<?php

/**
 * @file
 * Main file for User Pic Kit Minecraft.
 */

module_load_include('inc', 'userpickit_minecraft', 'userpickit_minecraft.admin');

/**
 * Implements hook_userpickit_info().
 */
function userpickit_minecraft_userpickit_info() {
  $picture_types = array();

  $picture_types['minecraft'] = array(
    'title' => t('Minecraft'),
    'description' => t('The face of a Minecraft players skin.'),
    'callback' => 'userpickit_minecraft_userpickit_picture',
  );

  return $picture_types;
}

/**
 * Implements hook_userpickit_picture().
 */
function userpickit_minecraft_userpickit_picture($picture_type, $account) {
  return array(
    'uri' => 'http://minecraft.net/skin/EvilSeph.png',
    'message' => t('Face from your Minecraft player skin.'),
  );
}

/**
 * Implement hook_userpickit_cache_insert().
 */
function userpickit_minecraft_userpickit_cache_insert($cache) {
  userpickit_minecraft_userpickit_cache_update($cache);
}

/**
 * Implement hook_userpickit_cache_update().
 */
function userpickit_minecraft_userpickit_cache_update($cache) {
  if ($cache->type == 'minecraft') {
    if ($cache->fid && $file = file_load($cache->fid)) {
      if (file_valid_uri($file->uri)) {
        $face_x = 8;
        $face_y = 8;
        $face_w = 8;
        $face_h = 8;
        list($source_width, $source_height) = getimagesize($file->uri);
        if ($source_width == 64 && $source_height == 32) {
          $image_source = imagecreatefromstring(file_get_contents($file->uri));

          $image_face = imagecreatetruecolor($face_w, $face_h);
          imagecopy($image_face, $image_source, 0, 0, $face_x, $face_y, $face_w, $face_h);
  
          imagepng($image_face, drupal_realpath($file->uri));
        } 
      }
    }
  }
}