<?php
/**
 * @file
 * Contains core functions for the Render As API module.
 */

/**
 * Implmenets hook_element_info_alter().
 */
function renderas_api_element_info_alter(&$types) {
  dpm($types);
  foreach ($types as &$type) {
    $type['#pre_render'][] = 'renderas_api_element_pre_render';
    $type['#post_render'][] = 'renderas_api_element_post_render';
  }
}

/**
 * Pre render callback for elements.
 */
function renderas_api_element_pre_render($element) {
  if (isset($element['#renderas']) && is_array($element['#renderas'])) {
    global $user;
    $element['#renderas']['user'] = $user;

    // Log current user out of the system.
    drupal_session_regenerate();
    module_invoke_all('user_logout', $user);

    // Log new user into the system.
    $user = drupal_anonymous_user();
    if (!empty($element['#renderas']['uid'])) {
      $user = user_load($element['#renderas']['uid']);
    }
    if (!empty($element['#renderas']['roles']) && is_array($element['#renderas']['roles'])) {
      $user->roles = $element['#renderas']['roles'];
    }
    if (!empty($element['#renderas']['uid'])) {
      $edit = array();
      user_module_invoke('login', $edit, $user);
    }
  }
  return $element;
}

/**
 * Post render callback for elements.
 */
function renderas_api_element_post_render($children, $element) {
  if (isset($element['#renderas']) && is_array($element['#renderas'])) {
    global $user;

    // Log original user back into the system.
    drupal_session_regenerate();
    if (!empty($element['#renderas']['uid'])) {
      module_invoke_all('user_logout', $user);
    }
    $user = $element['#renderas']['user'];
    $edit = array();
    user_module_invoke('login', $edit, $user);
  }
  return $children;
}

/**
 * Renders an element as a specified user and/or role(s).
 *
 * @param $element
 *   The element to be rendered.
 *
 * @param $renderas
 *   The Render As options.
 *
 * @return
 *   The rendered element.
 *
 * @see drupal_render()
 */
function renderas(&$element, $renderas = array()) {
  return drupal_renderas($element, $renderas);
}

/**
 * Renders an element as a specified user and/or role(s).
 *
 * @param $element
 *   The element to be rendered.
 *
 * @param $renderas
 *   The Render As options.
 *
 * @return
 *   The rendered element.
 *
 * @see drupal_render()
 */
function drupal_renderas(&$element, $renderas = array()) {
  $element['#pre_render'][] = 'renderas_api_element_pre_render';
  $element['#post_render'][] = 'renderas_api_element_post_render';
  $element['#renderas'] = $renderas;
  return drupal_render($element);
}
