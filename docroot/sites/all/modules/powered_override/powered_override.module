<?php

/**
 * @file
 * Override "Powered by" block with your personal infos.
 *
 * Powered Override
 *
 * Drupal 7 version:
 * Written by Gianluca Agnocchetti (hiryu)
 */

define('POWERED_OVERRIDE_MODULE_TITLE', 'Powered Override');
define('POWERED_OVERRIDE_PATH_NAME', 'powered_override');

/**
 * Implements hook_menu().
 */
function powered_override_menu() {
  $items = array();

  $items['admin/config/system/' . POWERED_OVERRIDE_PATH_NAME] = array(
    'title' => POWERED_OVERRIDE_MODULE_TITLE,
    'description' => check_plain('Configure settings for ' . POWERED_OVERRIDE_MODULE_TITLE . '.'),
    'access arguments' => array('administer site configuration'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('powered_override_setup_form'),
  );
  return $items;
}

/**
 * Implements hook_form().
 */
function powered_override_setup_form($form_state) {
  $form['#submit'][] = 'powered_override_setup_form_submit';
  $text = variable_get('powered_override_setup_infos');

  $form['powered_override_setup']['powered_override_setup_infos'] = array(
    '#type' => 'text_format',
    '#title' => t('Text to show in "Powered By" block:'),
    '#default_value' => $text['value'],
    '#format' =>  $text['format'],
    '#required' => FALSE,
    '#rows' => 5,
  );
  $form['powered_override_setup']['powered_override_setup_submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save'),
  );
  return $form;
}

/**
 * Implements hook_submit().
 */
function powered_override_setup_form_submit($form, &$form_state) {
  if (empty($form_state['values']['powered_override_setup_infos']['value'])) {
    variable_del('powered_override_setup_infos');
    $msg = 'Text deleted.';
  }
  else {
    variable_set('powered_override_setup_infos', $form_state['values']['powered_override_setup_infos']);
    $msg = 'Text updated.';
  }
  drupal_set_message($msg, 'status');
}

/**
 * Implements hook_block_view_alter().
 */
function powered_override_block_view_alter(&$data, $block) {
  $text = variable_get('powered_override_setup_infos');
  if (!empty($text)) {
    if ($block->module == 'system' && $block->delta == 'powered-by') {
      $data['content'] = check_markup($text['value'], $text['format']);
    }
  }
}