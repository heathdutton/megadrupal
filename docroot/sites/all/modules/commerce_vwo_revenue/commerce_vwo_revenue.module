<?php
/**
 * Implements hook_commerce_checkout_router()
 *
 */
function commerce_vwo_revenue_commerce_checkout_router($order, $checkout_page) {
  // Add the javascript only when we are on the order complete page
  if ($checkout_page['page_id'] == 'complete') {
    $script = commerce_vwo_revenue_ecommerce_js($order);
    // Add the code to the footer.
    drupal_add_js($script, array('type' => 'inline', 'scope' => 'footer', 'preprocess' => FALSE));
  }

}

/**
 * Build the e-commerce JS passed to Visual Website Optimizer for revenue tracking.
 *
 * @param $order
 *   The fully loaded order object to get total amount from.
 * @return
 *   The JS that should be added to the page footer.
 */
function commerce_vwo_revenue_ecommerce_js($order) {
  if(!($order instanceof EntityMetadataWrapper)) {
    $order = entity_metadata_wrapper('commerce_order', $order);
  }
  $total = round($order->commerce_order_total->amount->value() / 100, 2);
  $script = 'var _vis_opt_revenue=' . $total . ';';
  $script .= 'window._vis_opt_queue = window._vis_opt_queue || [];';
  $script .= 'window._vis_opt_queue.push(function() {_vis_opt_revenue_conversion(_vis_opt_revenue)});';
  return $script;
}
