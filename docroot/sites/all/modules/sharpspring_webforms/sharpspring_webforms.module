<?php
/**
 * @file
 * Drupal Module: SharpSpring Webforms.
 *
 * Integrates webforms with the SharpSpring module.
 */

/**
 * Implements hook_help().
 */
function sharpspring_webforms_help($path, $arg) {
  switch ($path) {
    case 'admin/help#sharpspring_webforms':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('SharpSpring Webforms allows integration between Webform and <a href="@sharpspring">SharpSpring</a>, a marketing automation tool. The module adds a Javascript block to any designated Webform, sending submitted data to SharpSpring.', array('@sharpspring' => url('http://sharpspring.com'))) . '</p>';
      return $output;
  }
}

/**
 * Implements hook_menu().
 */
function sharpspring_webforms_menu() {
  $items['admin/config/system/sharpspring/webforms'] = array(
    'title' => 'Webforms',
    'description' => 'Configure SharpSpring Webform tracking.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('sharpspring_webforms_config_form'),
    'access arguments' => array('administer sharpspring'),
    'file' => 'sharpspring_webforms.admin.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 10,
  );

  return $items;
}

/**
 * Returns sharpspring endpoint data from the database.
 */
function _sharpspring_webforms_return_endpoint_values() {
  $endpoints = array();

  // Get list of all SharpSpring form endpoints.
  $ss_query = db_query('SELECT * FROM {sharpspring_webforms} ORDER BY nid ASC')
    ->fetchAll();

  foreach ($ss_query as $row) {
    if (!empty($row->nid)) {
      $endpoints[$row->nid] = $row;
    }
  }

  return $endpoints;
}

/**
 * Returns sharpspring endpoint data based on a passed webform node id.
 */
function sharpspring_webforms_return_endpoint_data_for_webform_id($webform_id) {
  $results = db_select('sharpspring_webforms', 'sw')
    ->fields('sw')
    ->condition('nid', $webform_id, '=')
    ->condition('status', NODE_PUBLISHED)
    ->execute()
    ->fetchAll();

  return $results;
}

/**
 * Implements hook_form_alter().
 *
 * Adds sharpspring tracking javascript to selected webforms.
 */
function sharpspring_webforms_form_alter(&$form, &$form_state, $form_id) {

  // From webform.module to determine if the form is a webform.
  if (strpos($form_id, 'webform_client_form_') === 0) {

    $has_added_form_js = &drupal_static('sharpspring_webform_has_added_js');

    // Grab the webform id.
    $webform_id = str_replace('webform_client_form_', '', $form_id);

    if (!empty($webform_id)) {
      $results = sharpspring_webforms_return_endpoint_data_for_webform_id($webform_id);

      foreach ($results as $result) {
        // Add js for each webform identified on the sharpspring config page.
        if (!empty($result->base_uri) && !empty($result->endpoint) && !empty($result->nid)) {
          if (empty($has_added_form_js)) {
            // We haven't added the sharpspring form js to the footer yet.
            $noform = "https://" . variable_get('sharpspring_domain') . "/client/noform.js?ver=1.0";
            drupal_add_js($noform, array(
              'scope' => 'footer',
              'preprocessed' => FALSE,
              'type' => 'external',
              'weight' => 3,
            ));

            $has_added_form_js = TRUE;
          }

          $base_uri = check_plain($result->base_uri);
          $endpoint = check_plain($result->endpoint);

          if (!empty($base_uri) && !empty($endpoint)) {
            $formjs = '<script type="text/javascript">';
            $formjs .= "var __ss_noform = __ss_noform || [];";
            $formjs .= "__ss_noform.push(['baseURI', '" . $base_uri . "']);";
            $formjs .= "__ss_noform.push(['endpoint', '" . $endpoint . "']);";
            // Target the specific webform form by #id.
            $formjs .= "__ss_noform.push(['form', '" . $form['#id'] . "']);";
            $formjs .= '</script>';

            $form['#suffix'] = $formjs;
          }

        }

      }

    }

  }

}
