<?php
/**
 * @file
 * Create (manually or scheduled) and restore backups of your Drupal MySQL
 * database using the Joyent Manta service
 */

/**
 * Implementation of hook_backup_migrate_destination_types().
 */
function backup_migrate_manta_backup_migrate_destination_types() {
  return array(
    'manta' => array(
      'description' => t('Save the backup files to a Joyent Manta server.'),
      'file' => drupal_get_path('module', 'backup_migrate_manta') . '/destinations.manta.inc',
      'class' => 'backup_migrate_destination_manta',
      'type_name' => 'Joyent Manta',
      'can_create' => TRUE,
    ),
  );
}

/**
 * Implements hook_libraries_info
 */
function backup_migrate_manta_libraries_info() {
  $libs = array();

  $libs['php-manta'] = array(
    'name' => 'PHP Manta Client Library',
    'vendor url' => 'http://git.octobang.com/php-manta',
    'download url' => 'http://git.octobang.com/php-manta',
    'version arguments' => array(
      'file' => 'php-manta.php',
      'pattern' => '/(php-manta)/',
    ),
    'files' => array(
      'php' => array('php-manta.php'),
    ),
  );

  return $libs;
}

/**
 * Generates a watchdog log entry during debugging; when debugging is disabled, nothing happens.
 *
 * Set the config variable backup_migrate_manta_debug = TRUE to generate log output
 */
function _backup_migrate_manta_dbg($msg, $vars = array(), $severity = WATCHDOG_DEBUG, $link = NULL) {
  if (variable_get('backup_migrate_manta_debug', FALSE)) {
    watchdog('backup_migrate_manta', (is_array($msg) || is_object($msg)) ? '<pre>' . print_r($msg, TRUE) . '</pre>' : $msg, $vars, $severity, $link);
    if (function_exists('dpm')) {
      dpm((is_array($msg) || is_object($msg)) ? $msg : t($msg, $vars));
    }
  }
}

/**
 * Generates a watchdog log entry during execution of module
 */
function _backup_migrate_manta_log($msg, $vars = array(), $severity = WATCHDOG_INFO, $link = NULL) {
  // Catch passed-in objects or arrays and dump them accordingly
  if (is_array($msg) || is_object($msg)) {
    $msg = print_r($msg, TRUE);
  }
  watchdog('backup_migrate_manta', $msg, $vars, $severity, $link);
}
