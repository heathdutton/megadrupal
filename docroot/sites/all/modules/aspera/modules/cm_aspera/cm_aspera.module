<?php
/**
 * @file 
 */
 
/**
 * Implements hook_permission().
 */
function cm_aspera_permission() {
  return array(
   'edit expected filename field' => array(
      'title' => '<em class="placeholder">Aspera</em>: Edit Expected Filename',
      'description' => t('Allows users see and edit field.  Without this permission users only see Aspera button or name of file.'))
  );
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function cm_aspera_form_cm_show_node_form_alter(&$form, &$form_state) {
    
  drupal_add_js(drupal_get_path('module', 'cm_aspera') . '/cm-aspera.js');
  drupal_add_css(drupal_get_path('module', 'cm_aspera') . '/cm-aspera.css');
  //dsm($form);
    
    
  if(!user_access('edit expected filename field')) {
    //$form['field_expected_filename'][LANGUAGE_NONE][0]['value']['#type'] = 'hidden';
    
    $css = '#edit-field-expected-filename-und-0-value { display: none }';
    
    $form['field_expected_filename'][LANGUAGE_NONE][0]['value']['#description'] = $form['field_expected_filename'][LANGUAGE_NONE][0]['value']['#default_value'];
    
    drupal_add_css($css, $option['type'] = 'inline');
  }
  
	//ARE WE LIMITTING BY IP?  IF SO, CHECK THIS USER'S IP
	if (variable_get('aspera_limit_ip_addresses', 0) && !aspera_allowed_ip_address(ip_address())) {
		return;
	}
  
  //IS THIS A NEW NODE?  
  if(empty($form['nid']['#value'])) {
    return;
  }
  
  //IS THERE ALREADY A FILENAME?
  if(isset($form['#node']->field_expected_filename[LANGUAGE_NONE][0]['value'])) {
    return;
  }
	//IF NOT, CARRY ON
	aspera_add_application_js();
  
  // $js = '(function($) {
//   $(document).ready(function() {
//   $("body").onload(function() {
//     initAsperaConnect();
//   });
//   });}(jQuery));';
// 
//   drupal_add_js($js, 'inline');
  
	$html = '
  <div id="aspera">
	<div id="connect_installer" style="display: none; align:center"></div>
	<div id="button_container" class="button_container"></div>
  <div id="aspera_status_message"></div>
  <div id="progress_meter" style="display: none"></div>
  <div id="transfer_spec" style="display: none"></div>
  </div>
	';
	
	$form['field_expected_filename'][LANGUAGE_NONE][0]['value']['#description'] = $html;
	  
//   $form['aspera_buttons'] = array(
//   '#markup' => $html
//   );
    
}
