#!usr/bin/perl

# to use this file as a post processing script
# 1) rename from pl.txt. to .pl 
# 2) place in the approriate directory for your Aspera install
# 3) replace [YOUR-DRUPAL_SITE] with you domain for $feedurl

use strict;
use warnings;

use XML::RSS::Parser;
use LWP;
use File::Copy;

#use Sys::Hostname;
#use Mail::Sendmail;
#use XML::Simple; 
#use MIME::Base64;

#comment out to test without aspera
use aspera::logger;               
use aspera::paths;

my $FILE          = $ENV{"FILE"};
my $TYPE          = $ENV{"TYPE"};
my $STARTSTOP     = $ENV{"STARTSTOP"};
my $STATE         = $ENV{"STATE"};

&writelog("File rename and move script: starting - $TYPE $STARTSTOP $FILE $STATE");

#enable to test without aspera
#my $FILE  = "testing123.mov";

# this is the absolue path of the files ending with /
my $pathtofile = '';

my $feedurl = "http://[YOUR-DRUPAL_SITE]/aspera-show-rss-lookup/$FILE";

my $ua=LWP::UserAgent->new;
my $response=$ua->get($feedurl);
my $rss=$response->content;

my $parser= new XML::RSS::Parser;
my $feed=$parser->parse_string($rss);

my $count = $feed->item_count;

foreach my $i ( $feed->query('//item') ) { 
  my $format = lc($i->query('description')->text_content);
  
  my $newname = $i->query('guid')->text_content . '-' . $FILE;
  move($pathtofile . $FILE, $pathtofile . $format .'watch/'. $newname);
  
  &writelog("File renamed to $newname and moved to the $format watch directory");
}

sub writelog {
  &AsperaLogger::writelog($_[0], "aspera-rss-lookup.pl");
}
