<?php
/**
 * @file
 * Drupal needs this blank file.
 */

function aspera_menu() {
   $items['admin/config/aspera'] =
     array(
           'title' => 'Aspera Settings',
           'description' => 'A page for setting Aspera settings',
           'page callback' => 'drupal_get_form',
           'page arguments' => array('aspera_settings_form'),
           'access callback' => 'user_access',
           'access arguments' => array('administer site configuration'),
           'type' => MENU_NORMAL_ITEM,
           );
   return $items;
}


function aspera_allowed_ip_address($ip_address) {
  $allowed_addresses = array();
  for ($i = 0; $i < 10; $i++) {
    $var_name = 'aspera_allowed_ip_address_'.$i;
    $address = variable_get($var_name);
    if ($address) {
      $allowed_addresses[] = $address;
    }
  }
  return in_array($ip_address, $allowed_addresses);
}

function aspera_add_application_js() {
  $server_name = variable_get('aspera_server_name');
  $user_name = variable_get('aspera_user_name');
  $password = variable_get('aspera_password');
  $ssh_port = variable_get('aspera_ssh_port');
  $fallback_port = variable_get('aspera_ssh_fallback_port');
  $allowed_extensions = variable_get('allowed_extensions', NULL);
  
  if ($allowed_extensions) {
		$allowed_extensions_formatted_for_js = str_replace('"', '', $allowed_extensions);
 
		$js = "
			var asperaOptions = {
					 allowMultipleSelection : false,
					 allowedFileTypes : [
																				{filter_name : \"Allowed file extensions\",extensions : [" . $allowed_extensions . "]}
					 ],
					 title : \"Select a file ending in " . $allowed_extensions_formatted_for_js . "\" 
			 };";
	} else {
	  $js = "
	  
	  var asperaOptions = {
					 allowMultipleSelection : false
			 };";
	}
      
     
   $js .= "  
    var setup = function () {
      
      this.asperaWeb = new AW.Connect({id:'aspera_web_transfers'});
      
      
     
           
      var uploadButton;
      uploadButton = document.createElement('input');
      uploadButton.type = 'button';
      uploadButton.value = 'Start Video Upload';
      uploadButton.className = 'upload_button';
      uploadButton.setAttribute('onclick', 'asperaWeb.showSelectFileDialog({success:fileControls.uploadFiles}, asperaOptions)');
      document.getElementById('button_container').appendChild(uploadButton);

      this.asperaWeb.initSession('SimpleUpload');
      this.asperaWeb.addEventListener('transfer', fileControls.handleTransferEvents);
    };
    
    fileControls = {};

    fileControls.handleTransferEvents = function (event, obj) {
      switch (event) {
      case 'transfer':
      document.getElementById('progress_meter').innerHTML = JSON.stringify(obj, null, 4);
      break; 
      }
    };

    fileControls.uploadFiles = function (pathArray) {

      document.getElementById('aspera_status_message').innerHTML = '<a href=\"#edit-actions\" style=\"color: green\">Your video upload has started. You must now save the Show form. Please scroll to the bottom of the page and click Save.</a>';
      
      transferSpec = {
        'paths': [],
        'remote_host': '".$server_name."',
        'remote_user': '".$user_name."',
        'remote_password': '".$password."',
        'direction': 'send',
        'resume' : 'sparse_checksum',
        'destination_root': '/',
        'ssh_port' : '".$ssh_port."',
        'http_fallback' : 'yes',
        'http_fallback_port' : '".$fallback_port."',
      };

      connectSettings = {
      'allow_dialogs': 'yes'
      };

      for (var i = 0, length = pathArray.length; i < length; i +=1) {
	  transferSpec.paths.push({'source':pathArray[i]}); 
      }

      if (transferSpec.paths.length === 0) {
	return;
      }
      document.getElementById('transfer_spec').innerHTML = JSON.stringify(transferSpec, null, '    ');
      asperaWeb.startTransfer(transferSpec, connectSettings);
    };
  ";

  drupal_add_js($js, 'inline');

  drupal_add_js(drupal_get_path('module', 'aspera') . '/asperaplugininstaller.js');

}


function aspera_settings_form() {
  $form['aspera_server_name'] = 
    array(
          '#type' => 'textfield',          
	  '#title' => t("Aspera Server Name"),
          '#default_value' => variable_get('aspera_server_name'),
	  '#description' => 'Enter the username for Aspera.',
	  );
  $form['aspera_user_name'] = 
    array(
          '#type' => 'textfield',          
	  '#title' => t("Aspera Username"),
          '#default_value' => variable_get('aspera_user_name'),
	  '#description' => 'Enter the username for Aspera.',
	  );
  $form['aspera_password'] = 
    array(
          '#type' => 'textfield',          
	  '#title' => t("Aspera Password"),
          '#default_value' => variable_get('aspera_password'),
	  '#description' => 'Enter the password for Aspera.',
	  );

  $form['aspera_ssh_port'] = 
    array(
          '#type' => 'textfield',          
	  '#title' => t("Aspera SSH Port"),
          '#default_value' => variable_get('aspera_ssh_port'),
	  '#description' => 'Enter the SSH Port for Aspera.',
	  );
  $form['aspera_ssh_fallback_port'] = 
    array(
          '#type' => 'textfield',          
	  '#title' => t("Aspera SSH Fallback Port"),
          '#default_value' => variable_get('aspera_ssh_fallback_port'),
	  '#description' => 'Enter the SSH Fallback Port for Aspera.',
	  );
	  
	  $form['allowed_extensions'] = 
    array(
          '#type' => 'textfield',          
	  '#title' => t("Allowed File Extensions"),
          '#default_value' => variable_get('allowed_extensions'),
	  '#description' => 'Enter a comma seperated list of extensions wrapped in quotes like "mov", "mpeg", "mp4"',
	  );
	  
	$ip_description = 'Your current IP is ' . ip_address();
	
	$form['aspera_ip'] = array(
    '#title' => t('Aserpa IP Access Configuration'),
    '#type' => 'fieldset',
    '#description' => $ip_description,
    '#collapsible' => TRUE,
    '#collapsed' => FALSE,
  );
  
  $form['aspera_ip']['aspera_limit_ip_addresses'] = array(
    '#type' => 'checkbox',
    '#title' => t('Limit Aserpa Access to Approved IP Addresses'),
    '#default_value' => variable_get('aspera_limit_ip_addresses', 0),
    '#description' => '',
  );
    
  $form['aspera_ip']['aspera_allowed_ip_address_1'] = 
    array(
          '#type' => 'textfield',          
	  '#title' => t("Aspera IP Address 1"),
          '#default_value' => variable_get('aspera_allowed_ip_address_1'),
	  '#description' => 'Enter an allowed IP Address for Aspera.',
	  );
	
  $form['aspera_ip']['aspera_allowed_ip_address_2'] = 
    array(
          '#type' => 'textfield',          
	  '#title' => t("Aspera IP Address 2"),
          '#default_value' => variable_get('aspera_allowed_ip_address_2'),
	  '#description' => 'Enter an allowed IP Address for Aspera.',
	  );
	  
  $form['aspera_ip']['aspera_allowed_ip_address_3'] = 
    array(
          '#type' => 'textfield',          
	  '#title' => t("Aspera IP Address 3"),
          '#default_value' => variable_get('aspera_allowed_ip_address_3'),
	  '#description' => 'Enter an allowed IP Address for Aspera.',
	  );
  $form['aspera_ip']['aspera_allowed_ip_address_4'] = 
    array(
          '#type' => 'textfield',          
	  '#title' => t("Aspera IP Address 4"),
          '#default_value' => variable_get('aspera_allowed_ip_address_4'),
	  '#description' => 'Enter an allowed IP Address for Aspera.',
	  );
  $form['aspera_ip']['aspera_allowed_ip_address_5'] = 
    array(
          '#type' => 'textfield',          
	  '#title' => t("Aspera IP Address 5"),
          '#default_value' => variable_get('aspera_allowed_ip_address_5'),
	  '#description' => 'Enter an allowed IP Address for Aspera.',
	  );
	  
	  

  return system_settings_form($form);
}     
