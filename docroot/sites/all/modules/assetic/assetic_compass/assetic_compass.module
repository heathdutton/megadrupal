<?php
/**
 * @file
 * Adds the Compass filter to the Assetic module.
 */

function assetic_compass_admin_form($form, &$form_state) {
  $form['#filter'] = assetic_filter_load('compass');
  $form_state['filter'] = 'compass';

  $form['compass_path'] = array(
    '#type' => 'textfield',
    '#title' => t('Compass path'),
    '#default_value' => $form['#filter']['settings']['compass_path'],
  );

  $form['ruby_path'] = array(
    '#type' => 'textfield',
    '#title' => t('Ruby path'),
    '#default_value' => $form['#filter']['settings']['ruby_path'],
  );

  $form['images_dir'] = array(
    '#type' => 'textfield',
    '#title' => t('Images directory'),
    '#default_value' => $form['#filter']['settings']['images_dir'],
  );

  return assetic_filter_settings_form($form);
}

/**
 * Implements hook_assetic_filters_info().
 */
function assetic_compass_assetic_filters_info() {
  return array(
    'compass' => array(
      'title' => 'Compass',
      'class' => 'Assetic\\Filter\\CompassFilter',
      'constructor callback' => 'assetic_compass_constructor_callback',
      'apply to' => '/.(sass|scss)$/',
      'admin' => 'assetic_compass_admin_form',
      'settings' => array(
        'compass_path' => '/usr/bin/compass',
        'ruby_path' => '/usr/bin/ruby',
        'images_dir' => 'images',
      ),
    ),
  );
}

function assetic_compass_constructor_callback($filter) {
  return array($filter['settings']['compass_path']);
}

/**
 * Implements hook_assetic_filter_instance_FILTER_ALIAS_alter()
 *
 * Since Assetic moves the code to a temporary directory we need to
 * tell Compass the appropriate locations for our images.
 *
 * We also need to tell Compass the HTTP Paths so it can build the
 * actual include paths for the generated images.
 */
function assetic_compass_assetic_filter_instance_compass_alter(&$filter, $context) {
  // Since the filters aren't theme specific we base all paths on the
  // default theme which will be the best choice for most people.
  $default_theme = variable_get('theme_default', NULL);
  $theme_path = drupal_get_path('theme', $default_theme);
  $images_dir = $context['info']['settings']['images_dir'];

  // Build the correct paths used by Compass
  $http_path = '/' . $theme_path;
  $http_images_path = '/' . implode('/', array($theme_path, $images_dir));
  $images_path = implode('/', array(DRUPAL_ROOT, $theme_path, $images_dir));

  // Set all values on the Compass filter
  $filter->setHttpPath($http_path);
  $filter->setHttpImagesPath($http_images_path);
  $filter->setHttpGeneratedImagesPath($http_images_path);
  $filter->setImagesDir($images_path);
  $filter->setGeneratedImagesPath($images_path);
}
