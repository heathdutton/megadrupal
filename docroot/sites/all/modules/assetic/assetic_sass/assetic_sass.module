<?php

use Assetic\Filter\Sass\ScssFilter;

/**
 * @file
 * Adds the SASS and SCSS filters to the Assetic module.
 */

function assetic_sass_admin_form_scss($form, &$form_state) {
  $form['#filter'] = assetic_filter_load('scss');
  $form_state['filter'] = 'scss';

  $form['sass_path'] = array(
    '#type' => 'textfield',
    '#title' => t('SASS path'),
    '#default_value' => $form['#filter']['settings']['sass_path'],
    '#description' => t('The path to the installed SASS binary.'),
  );

  $form['debug_info'] = array(
    '#type' => 'checkbox',
    '#title' => t('Debug info'),
    '#default_value' => $form['#filter']['settings']['debug_info'],
    '#description' => t('Turn on debug info on rendered stylesheets.'),
  );

  return assetic_filter_settings_form($form);
}

/**
 * Implements hook_assetic_filter_instance_scss_alter().
 */
function assetic_sass_assetic_filter_instance_scss_alter(ScssFilter $filter, $context) {
  $filter->setDebugInfo($context['info']['settings']['debug_info']);
}

/**
 * Implements hook_assetic_filters_info().
 */
function assetic_sass_assetic_filters_info() {
  return array(
    'sass' => array(
      'class' => 'Assetic\\Filter\\Sass\\SassFilter',
      'apply to' => '/.sass$/',
      'title' => 'SASS',
    ),
    'scss' => array(
      'class' => 'Assetic\\Filter\\Sass\\ScssFilter',
      'constructor callback' => 'assetic_sass_constructor_callback_scss',
      'apply to' => '/.scss$/',
      'title' => 'SCSS',
      'admin' => 'assetic_sass_admin_form_scss',
      'settings' => array(
        'sass_path' => '/usr/bin/sass',
        'debug_info' => FALSE,
      ),
    ),
  );
}

function assetic_sass_constructor_callback_scss($filter) {
  return array($filter['settings']['sass_path']);
}
