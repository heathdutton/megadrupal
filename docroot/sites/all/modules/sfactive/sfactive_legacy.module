<?php

/**
 * Implements hook_menu().
 */
function sfactive_legacy_menu() {
  $items['calendar/event_display_detail.php'] = array(
    'access callback' => TRUE,
    'page arguments' => array('event'),
    'page callback' => 'sfactive_legacy_redirect',
    'type' => MENU_CALLBACK,
  );
  $items['archives/archive_by_id.php'] = array(
    'access callback' => TRUE,
    'page arguments' => array('feature'),
    'page callback' => 'sfactive_legacy_redirect',
    'type' => MENU_CALLBACK,
  );
  return $items;
}

function sfactive_legacy_redirect($type, $id = NULL) {
  if ($type == 'event' && isset($_GET['event_id'])) {
    $id = $_GET['event_id'];
  }
  elseif ($type == 'feature' && isset($_GET['id'])) {
    $id = $_GET['id'];
  }
  if ($id = (int) $id) {
    if ($nid = db_query('SELECT nid FROM {sfactive_legacy} WHERE type = :type AND id = :id', array(':type' => $type, ':id' => $id))->fetchField()) {
      // Avoid using drupal_goto() so the redirect will be cached.
      drupal_add_http_header('Location', url('node/' . $nid, array('absolute' => TRUE)));
      drupal_add_http_header('Status', '301 Moved Permanently');
      echo '<!DOCTYPE html><title>301 Moved Permanently</title>';
      return NULL;
    }
  }
  return MENU_NOT_FOUND;
}
