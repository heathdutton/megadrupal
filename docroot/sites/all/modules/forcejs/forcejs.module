<?php
/**
 * @file
 * Removes the has_js cookie for anonymous users without an open session.
 */

/**
 * Implements hook_boot().
 */
function forcejs_boot() {
  if (!isset($_COOKIE[session_name()])) {
    if (variable_get('force_js', 'unset') === 'unset') {
      unset($_COOKIE['has_js']);
    }
    else {
      $_COOKIE['has_js'] = '1';
    }
  }
}

/**
 * Implements hook_js_alter().
 */
function forcejs_js_alter(&$javascript) {
  if (!isset($_COOKIE[session_name()]) && isset($javascript['misc/drupal.js'])) {
    $forcejs = drupal_get_path('module', 'forcejs') . '/forcejs.js';
    $javascript[$forcejs] = $javascript['misc/drupal.js'];
    $javascript[$forcejs]['data'] = $forcejs;
    $javascript[$forcejs]['weight']++;
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function forcejs_form_system_performance_settings_alter(&$form, &$form_state) {
  $form['force_js'] = array(
    '#type' => 'fieldset',
    '#title' => t('JavaScript cookie for anonymous users'),
    '#description' => t('The <em>Force JS</em> module removes the <code>has_js</code> cookie for anonymous users without an open session.'),
  );

  $form['force_js']['force_js'] = array(
    '#type' => 'radios',
    '#title' => t('Enforce cookie value'),
    '#default_value' => variable_get('force_js', 'unset'),
    '#options' => array(
      'unset' => t('Unset'),
      '1' => t('Enabled'),
    ),
    '#description' => t('Choose the value Drupal should internally assume for the <code>has_js</code> cookie when accessed by anonymous users without an open session.'),
  );
}
