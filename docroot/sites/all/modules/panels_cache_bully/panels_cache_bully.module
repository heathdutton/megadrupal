<?php

/**
 * @file
 * Module file for panels_cache_bully.
 */

/**
 * Implements hook_ctools_plugin_directory().
 */
function panels_cache_bully_ctools_plugin_directory($module, $plugin) {
  if ($module == 'panels' && $plugin = 'cache') {
    return "plugins/$plugin";
  }
}

/**
 * Implements hook_menu().
 */
function panels_cache_bully_menu() {
  // Safety: go away if CTools is not at an appropriate version.
  if (!defined('PANELS_REQUIRED_CTOOLS_API') || !module_invoke('ctools', 'api_version', PANELS_REQUIRED_CTOOLS_API)) {
    return array();
  }

  // Provide settings on the main panel UI.
  $items['admin/structure/panels/settings/panels-cache-bully'] = array(
    'title' => 'Panels cache bully',
    'description' => 'Change Panels cache bully settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('panels_cache_bully_settings_form'),
    'access arguments' => array('use panels caching features'),
    'file' => 'panels_cache_bully.admin.inc',
    'type' => MENU_LOCAL_TASK,
  );

  return $items;
}

/**
 * Implements hook_panels_pane_prerender().
 *
 * @final bully cache any pane without an explicit cache mechanism.
 *
 * Uses variable 'panels_cache_bully_cache_plugin' as configuration.
 */
function panels_cache_bully_panels_pane_prerender($pane) {

  // Set statics.
  static $default_cache_mechanism = 'panels_cache_bully_never_cache';


  // Never cache forms.
  if ($pane->type == 'form' || $pane->subtype == 'form') {
    return;
  }

  // Never cache blocks, trust block caching for that.
  if ($pane->type == 'block') {
    return;
  }


  // Load panels cache bully settings.
  $cache_bully_settings = &drupal_static(__FUNCTION__);
  if (!isset($cache_bully_settings)) {
    // Load installed cache plugins and the cache bully variable.
    $panels_cache_plugins = ctools_get_plugins('panels', 'cache');
    $plugin = variable_get('panels_cache_bully_cache_plugin', $default_cache_mechanism);

    // The plugin's default settings are used.
    $cache_bully_settings['method'] = $plugin;
    $cache_bully_settings['settings'] = $panels_cache_plugins[$plugin]['defaults'];
  }


  // Respect explicit pane-cache settings.
  if (!empty($pane->cache)) {

    // Case 1: pane cache method is set to 'panels_cache_bully_never_cache'.
    if ($default_cache_mechanism == $pane->cache['method']) {
      $pane->cache = array();
    }
    // Case 2: pane cache method is set to any other cache mechanism.
    else {
      return;
    }
  }
  // Case 3: pane cache method is not set and the default method is not
  // 'panels_cache_bully_never_cache'.
  elseif ($default_cache_mechanism != $cache_bully_settings['method']) {
    $pane->cache = $cache_bully_settings;
  }
}
