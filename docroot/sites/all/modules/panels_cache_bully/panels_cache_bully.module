<?php

/**
 * @file
 * Module file for panels_cache_bully.
 */

/**
 * Implements hook_ctools_plugin_directory().
 */
function panels_cache_bully_ctools_plugin_directory($module, $plugin) {
  if ($module == 'panels' && $plugin = 'cache') {
    return "plugins/$plugin";
  }
}

/**
 * Implements hook_menu().
 */
function panels_cache_bully_menu() {
  // Safety: go away if CTools is not at an appropriate version.
  if (!defined('PANELS_REQUIRED_CTOOLS_API') || !module_invoke('ctools', 'api_version', PANELS_REQUIRED_CTOOLS_API)) {
    return array();
  }

  // Provide settings on the main panel UI.
  $items['admin/structure/panels/settings/panels-cache-bully'] = array(
    'title' => 'Panels cache bully',
    'description' => 'Change Panels cache bully settings',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('panels_cache_bully_settings_form'),
    'access arguments' => array('use panels caching features'),
    'file' => 'panels_cache_bully.admin.inc',
    'type' => MENU_LOCAL_TASK,
  );

  return $items;
}

/**
 * Implements hook_panels_pane_prerender().
 *
 * @final bully cache on pane.
 *
 * Uses variable 'panels_cache_bully_cache_plugin' as configuration.
 */
function panels_cache_bully_panels_pane_prerender($pane) {

  // Respect explicit cache settings.
  if (!empty($pane->cache)) {
    if ('panels_cache_bully_never_cache' == $pane->cache['method']) {
      $pane->cache = array();
    }
    return;
  }

  // Never cache forms.
  if ($pane->type == 'form' || $pane->subtype == 'form') {
    return;
  }

  // Never cache blocks, trust block caching for that.
  if ($pane->type == 'block') {
    return;
  }

  // Load bully settings from system.
  $cache_bully_settings = &drupal_static(__FUNCTION__);
  if (!isset($cache_bully_settings)) {
    // simple, content, autocache, ...
    $plugin = variable_get('panels_cache_bully_cache_plugin', 'simple');
    $panels_cache_plugins = ctools_get_plugins('panels', 'cache');

    // Panel cache bully settings will be added on the Pane.
    $cache_bully_settings['method'] = $plugin;
    $cache_bully_settings['settings'] = $panels_cache_plugins[$plugin]['defaults'];
  }

  // Bully cache.
  $pane->cache = $cache_bully_settings;
}
