<?php

/**
 * @file
 * An input filter that adds css to the filtered text. This might be useful
 * for theming email.
 */

/**
 * Implements hook_filter_info().
 */
function add_css_filter_filter_info() {
  return array(
    'filter_add_css_filter' => array(
      'title' => t('Add CSS'),
      'description' => t('Add css inline or an external stylesheet. Useful when theming email.'),
      'process callback' => '_add_css_filter_process',
      'settings callback' => '_add_css_filter_filter_settings',
      'tips callback' => '_add_css_filter_filter_tips',
    ),
  );
}

/**
 * Implements hook_filter_FILTER_process().
 * @see add_css_filter_filter_info()
 */
function _add_css_filter_process($text, $filter, $format, $langcode, $cache, $cache_id) {
  if (empty($text)) {
    return '';
  }
  // Add inline css from settings, wrap it with <style> tags to be parsed.
  if (isset($filter->settings['inline_css']) && !empty($filter->settings['inline_css'])) {
    $text .= "<style>" . $filter->settings['inline_css'] . "</style>";
  }
  // Add external css from settings, wrap it with <style> tags to be parsed.
  if (isset($filter->settings['external_css']) && !empty($filter->settings['external_css'])) {
    // Extract the stylesheets, split line-by-line.
    $stylesheets = explode("\n", str_replace("\r", "", $filter->settings['external_css']));
    foreach ($stylesheets as $stylesheet) {
      $text .= "<style>" . file_get_contents($stylesheet) . "</style>";
    }
  }

  return $text;
}

/**
 * Implements hook_filter_FILTER_settings().
 * @see add_css_filter_filter_info()
 */
function _add_css_filter_filter_settings($form, &$form_state, $filter, $format, $defaults, $filters) {
  $filter->settings += $defaults;

  return array(
    'inline_css' => array(
      '#type' => 'textarea',
      '#title' => t('Inline CSS to be included.'),
      '#description' => t('Do not add &lt;style&gt; tags around it.'),
      '#default_value' => isset($filter->settings['inline_css']) ? $filter->settings['inline_css'] : "",
    ),
    'external_css' => array(
      '#type' => 'textarea',
      '#title' => t('Relative CSS paths to be included.'),
      '#description' => t('For example: sites/all/themes/zen_custom/css/mail.css'),
      '#default_value' => isset($filter->settings['external_css']) ? $filter->settings['external_css'] : "",
    ),
  );
}
