<?php
/**
 * @file
 * Installation.
 */

/**
 * Implement hook_schema().
 */
function giantbomb_schema() {
  $schema['giantbomb_types'] = array(
    'unique keys' => array(
      'id' => array('id', 'endpoint'),
    ),
    'description' => 'Giant Bomb content types.',
    'fields' => array(
      'id' => array(
        'description' => 'Giant Bomb type ID.',
        'type' => 'int',
        'not null' => TRUE,
      ),
      'endpoint' => array(
        'description' => 'Endpoint name.',
        'type' => 'varchar',
        'length' => '32',
        'not null' => FALSE,
        'default' => '',
      ),
      'title' => array(
        'description' => 'A title for this resource.',
        'type' => 'varchar',
        'length' => '32',
        'not null' => FALSE,
        'default' => '',
      ),
      'object' => array(
        'description' => 'The machine name of objects.',
        'type' => 'varchar',
        'length' => '32',
        'not null' => TRUE,
        'default' => '',
      ),
      'list' => array(
        'description' => 'The machine name lists.',
        'type' => 'varchar',
        'length' => '32',
        'not null' => TRUE,
        'default' => '',
      ),
      'entity_type' => array(
        'description' => 'The entity to associate this resource to.',
        'type' => 'varchar',
        'length' => '32',
        'not null' => FALSE,
        'default' => NULL,
      ),
      'bundle' => array(
        'description' => 'The bundle to associate this resource to.',
        'type' => 'varchar',
        'length' => '32',
        'not null' => FALSE,
        'default' => NULL,
      ),
      'update_frequency' => array(
        'description' => 'Seconds to wait before updating an object of this type again.',
        'type' => 'int',
        'not null' => TRUE,
        'default' => (60 * 60 * 24 * 7),
      ),
      'settings' => array(
        'description' => 'Serialized settings.',
        'type' => 'blob',
        'not null' => FALSE,
        'serialize' => TRUE,
        'size' => 'big',
      ),
    )
  );

  $schema['giantbomb_jobs'] = array(
    'description' => 'Schedule the automatic update of resources.',
    'fields' => array(
      'id' => array(
        'description' => 'Unique ID.',
        'type' => 'serial',
        'not null' => TRUE,
      ),
      'endpoint' => array(
        'description' => 'Endpoint name.',
        'type' => 'varchar',
        'length' => '32',
        'not null' => FALSE,
        'default' => '',
      ),
      'resource' => array(
        'description' => 'Resource type (list or object).',
        'type' => 'varchar',
        'length' => '32',
        'not null' => TRUE,
        'default' => '',
      ),
      'type' => array(
        'description' => 'The Giant Bomb type ID.',
        'type' => 'int',
        'not null' => FALSE, 
      ),
      'object_id' => array(
        'description' => 'The Giant Bomb object ID. Used for objects only.',
        'type' => 'int',
        'not null' => FALSE,
        'default' => NULL,
      ),
      'settings' => array(
        'description' => 'Serialized settings.',
        'type' => 'blob',
        'not null' => FALSE,
        'serialize' => TRUE,
        'size' => 'big',
      ),
      'updated' => array(
        'description' => 'Last time the job was processed.',
        'type' => 'int',
        'not null' => FALSE,
        'default' => NULL,
      ),
      'next_update' => array(
        'description' => 'The next time the job should be processed, as a minimum.',
        'type' => 'int',
        'not null' => FALSE,
        'default' => NULL,
      ),
      'update_frequency' => array(
        'description' => 'Seconds to wait until processing again.',
        'type' => 'int',
        'not null' => TRUE,
        'default' => (60 * 60 * 12),
      ),
      'active' => array(
        'type' => 'int',
        'size' => 'tiny',
        'not null' => TRUE,
        'default' => 0,
        'description' => 'Enable cron to execute this job.',
      ),
    ),
    'foreign keys' => array(
      'job_type' => array(
        'table' => 'giantbomb_types', 
        'columns' => array('type' => 'id'),
      ),
    ),
    'primary key' => array('id'),
  );

  $schema['giantbomb_files'] = array(
    'description' => 'Track the location of files downloaded from GiantBomb.',
    'fields' => array(
      'fid' => array(
        'description' => 'A file ID.',
        'type' => 'int',
        'not null' => TRUE,
      ),
      'endpoint' => array(
        'description' => 'Endpoint name.',
        'type' => 'varchar',
        'length' => '32',
        'not null' => FALSE,
        'default' => '',
      ),
      'type' => array(
        'description' => 'The Giant Bomb type ID.',
        'type' => 'int',
        'not null' => FALSE,
      ),
      'object_id' => array(
        'description' => 'The Giant Bomb object ID. Used for objects only.',
        'type' => 'int',
        'not null' => FALSE,
        'default' => NULL,
      ),
      'url' => array(
        'type' => 'varchar',
        'length' => 2048,
        'not null' => FALSE,
      ),
    ),
    'indexes' => array(
      'url' => array('url'),
      'object' => array('endpoint', 'type', 'object_id'),
    ),
    'foreign keys' => array(
      'file' => array(
        'table' => 'file_managed',
        'columns' => array('fid' => 'fid'),
      ),
    ),
    'primary key' => array('fid'),
  );

  return $schema;
}