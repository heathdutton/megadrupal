<?php

/*
 * @file
 * The main .module file for pass2pdf.
 */

/* 
 * Implements hook_form_FORM_ID_alter().
 */
function pass2pdf_form_user_register_form_alter(&$form, &$form_state, $form_id) {
  $captcha_type = db_select('captcha_points', 'c')
    ->fields('c', array(
      'captcha_type',
    ))
    ->condition('form_id', 'user_register_form')
    ->execute()
    ->fetchField();
  global $user;
  if ($user->uid == 0) {
    $form['pass2pdf_pass'] = array(
      '#type' => 'password_confirm',
      '#required' => TRUE,
      '#size' => 10,
    );
    $form['pass2pdf_first_name'] = array(
      '#type' => 'textfield',
      '#title' => t('First name'),
      '#size' => 20,
    );
    $form['pass2pdf_last_name'] = array(
      '#type' => 'textfield',
      '#title' => t('Last name'),
      '#size' => 20,
    );
    $form['pass2pdf_send_pass'] = array(
      '#type' => 'checkbox',
      '#title' => t('E-mail me my password'),
    );
    if ($captcha_type != 'default') {
      if (module_exists('captcha')) {
        $form['pass2pdf_captcha'] = array(
          '#type' => 'captcha',
        );
      }
    }
    $form['#submit'] = array('pass2pdf_create_user');
  }
}

/*
 * Function to create a user with the form values.
 */
function pass2pdf_create_user(&$form, &$form_state) {
  $account = new stdClass();
  $newUser = array(
    'is_new' => TRUE,
    'status' => TRUE,
    'name' => $form['account']['name']['#value'],
    'mail' => $form['account']['mail']['#value'],
    'pass' => $form['pass2pdf_pass']['#value']['pass1'],
    'first_name' => $form['pass2pdf_first_name']['#value'],
    'last_name' => $form['pass2pdf_last_name']['#value'],
  );
  user_save($account, $newUser);
  if ($form['pass2pdf_send_pass']['#value']) {
    pass2pdf_email_pdf_to_user($form);
  }
}

/*
 * Function to create the PDF.
 */
function pass2pdf_email_pdf_to_user($form) {
  global $user;
  $account = $user;
  $username = $form['account']['name']['#value'];
  require(libraries_get_path('fpdf') . '/fpdf.php');
  $pdf = new FPDF('P', 'cm', 'A4');
  $pdf->AddPage();
  $pdf->SetFont('Arial', 'B', 16);
  $pdf->Image(theme_get_setting('logo'));
  $pdf->Write(5, t('Hello @username, your password from @site-name is:@password', array('@username' => $username, '@site-name' => variable_get('site_name'), '@password' => $form['pass2pdf_pass']['#value']['pass1'])));
  $pdf->Output(drupal_realpath('public://') . '/' . $username . '.pdf');
  $params = array(
    'to' => $form['account']['mail']['#value'],
    'from' => variable_get('site_name') . "<" . variable_get('site_mail') . ">",
    'subject' => t('Your password from @site', array('@site' => variable_get('site_name'))),
    'body' => t('Hello !user. Please find your password in the attached PDF file.', array('!user' => $form['account']['name']['#value'])),
    'attachment' => array(
      'filecontent' => file_get_contents(drupal_realpath('public://') . '/'. $username . '.pdf'),
      'filemime' => 'application/pdf',
      'filename' => $username . '.pdf',
    ),
  );
  $message = drupal_mail('pass2pdf', 'key', $params['to'], user_preferred_language($user), $params, $params['from'], TRUE);
  if ($message) {
    drupal_set_message(t('You will shortly receive your password in an e-mail.'));
  }
}

/*
 * Function to send mail.
 * 
 * @param $key module key.
 * @param $message message to be e-mailed.
 * @param $params any additional parameters.
 */
function pass2pdf_mail($key, &$message, $params) {
  switch($key) {
    case 'key':
      $message['subject'] = $params['subject'];
      $message['body'][] = $params['body'];
      $message['params']['attachments'][] = $params['attachment'];
      break;
  }
}

/**
 * This function returns the path to a given library.
 *
 * @param $name name of the library
 *
 */
function pass2pdf_get_library($name) {
  if (function_exists('libraries_get_path')) {
    return libraries_get_path($name);
  }
  else {
    return 'sites/all/libraries/' . $name;
  }
}
