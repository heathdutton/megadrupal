<?php

/**
 * @file
 * Integrates RBK Money's payment service.
 */

/**
 * Define payment statuses
 */
define('UC_RBKMONEY_STATUS_PROCESS', 3);
define('UC_RBKMONEY_STATUS_SUCCESS', 5);
define('UC_RBKMONEY_IP_LIST', serialize(array('89.111.188.128', '195.122.9.148')));

/**
 * Implements hook_permission().
 */
function uc_rbkmoney_permission() {
  return array(
    'administer uc_rbkmoney' => array(
      'title' => t('Administer RBK Money'),
      'description' => t('Access the RBK Money administration page.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function uc_rbkmoney_menu() {
  $items['admin/store/settings/uc_rbkmoney'] = array(
    'title' => 'RBK Money',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('uc_rbkmoney_setup'),
    'access arguments' => array('administer uc_rbkmoney'),
    'type' => MENU_NORMAL_ITEM,
  );
  $items['uc_rbkmoney/response'] = array(
    'title' => 'Internal Data',
    'page callback' => 'uc_rbkmoney_done_payment',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['uc_rbkmoney/success'] = array(
    'title' => 'Internal Data',
    'page callback' => 'uc_rbkmoney_payment_end',
    'page arguments' => array('success'),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  $items['uc_rbkmoney/fail'] = array(
    'title' => 'Internal Data',
    'page callback' => 'uc_rbkmoney_payment_end',
    'page arguments' => array('fail'),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * Callback for settings page.
 */
function uc_rbkmoney_setup() {

  $form['uc_rbkmoney_help'] = array(
    '#markup' => t(l('RBK Money API link', 'http://www.rbkmoney.ru/manual', array('attributes' => array('target' => '_blank')))),
  );

  global $base_url;
  $form['uc_rbkmoney_responseURL'] = array(
    '#type' => 'textfield',
    '#title' => t('Response URL'),
    '#default_value' => $base_url . '/uc_rbkmoney/response',
    '#description' => t('For insertion into "Payment notification URL" field on !site settings page', array('!site' => l('RBK Money', 'http://www.rbkmoney.ru', array('attributes' => array('target' => '_blank'))))),
    '#required' => false,
  );
  $form['uc_rbkmoney_actionURL'] = array(
    '#type' => 'textfield',
    '#title' => t('Payment form action URL'),
    '#default_value' => variable_get('uc_rbkmoney_actionURL', 'https://rbkmoney.ru/acceptpurchase.aspx'),
    '#description' => t('Default: "!action"', array('!action' => url('https://rbkmoney.ru/acceptpurchase.aspx'))),
    '#required' => TRUE,
  );
  $form['uc_rbkmoney_eshopId'] = array(
    '#type' => 'textfield',
    '#title' => t('Site ID'),
    '#default_value' => variable_get('uc_rbkmoney_eshopId', ''),
    '#description' => t("Merchand ID of your site"),
    '#required' => TRUE,
  );
  $form['uc_rbkmoney_recipientCurrency'] = array(
    '#type' => 'select',
    '#title' => t('Payments currency'),
    '#options' => array('RUR' => 'RUR', 'USD' => 'USD', 'EUR' => 'EUR', 'UAH' => 'UAH'),
    '#default_value' => variable_get('uc_rbkmoney_recipientCurrency', 'RUR'),
    '#description' => t("Please, select payments currency"),
    '#required' => TRUE,
  );
  $form['uc_rbkmoney_secretKey'] = array(
    '#type' => 'textfield',
    '#title' => t('Secret key'),
    '#default_value' => variable_get('uc_rbkmoney_secretKey', ''),
    '#description' => t('Secret key, entered on !site settings page', array('!site' => l('RBK Money', 'http://www.rbkmoney.ru', array('attributes' => array('target' => '_blank'))))),
    '#required' => TRUE,
  );
  $form['uc_rbkmoney_log'] = array(
    '#type' => 'radios',
    '#title' => t("Save RBK Money's server responses in <a href='!dblog'>system log</a>", array('!dblog' => 'admin/reports/dblog')),
    '#options' => array(1 => t('Yes'), 0 => t('No')),
    '#default_value' => variable_get('uc_rbkmoney_log', 1),
  );
  $form['uc_rbkmoney_ip'] = array(
    '#type' => 'radios',
    '#title' => t('Process notifications only from allowed IP addresses'),
    '#options' => array(1 => t('Yes'), 0 => t('No')),
    '#default_value' => variable_get('uc_rbkmoney_ip', 0),
    '#description' => t('Allowed IP addresses: ') . implode(', ', unserialize(UC_RBKMONEY_IP_LIST)),
  );

  $form['advanced'] = array(
    '#type' => 'fieldset',
    '#title' => t('Advanced options'),
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
  );
  $form['advanced']['uc_rbkmoney_preference'] = array(
    '#type' => 'select',
    '#title' => t('Prefered payment method'),
    '#options' => array(
      'all' => t('All (default)'),
      'inner' => t('RBK Money wallet (inner)'),
      'bankcard' => t('Visa/MasterCard bank card (bankcard)'),
      'terminals' => t('Cash-in kiosks (terminals)'),
      'prepaidcard' => t('RBK Money prepaid card (prepaidcard)'),
      'postrus' => t('Russian Post (postrus)'),
      'mobilestores' => t('Mobile stores (mobilestores)'),
      'transfers' => t('Money transfer systems (transfers)'),
      'ibank' => t('Internet banking (ibank)'),
      'sberbank' => t('Bank payment (sberbank)'),
      'svyaznoy' => t('Svyaznoy salons (svyaznoy)'),
      'euroset' => t('Euroset salons (euroset)'),
      'contact' => t('Contact salons (contact)'),
      'mts' => t('MTS salons (mts)'),
      'uralsib' => t('Uralsib (uralsib)'),
      'handybank' => t('HandyBank (handybank)'),
      'ocean' => t('Ocean Bank (ocean)'),
      'ibankuralsib' => t('Uralsib internert bank (ibankuralsib)'),
    ),
    '#default_value' => variable_get('uc_rbkmoney_preference', 'all'),
    '#description' => t("Default payment method. Allow to skip payment method selection page"),
  );
  $form['advanced']['uc_rbkmoney_send_hash'] = array(
    '#type' => 'select',
    '#title' => t('Send hash with payment request'),
    '#options' => array(0 => 'off (default)', 1 => 'on'),
    '#default_value' => variable_get('uc_rbkmoney_send_hash', 0),
    '#description' => t("Send order hash in payment request. Option 'Check request form hash' must be checked on !site settings page", array('!site' => l('RBK Money', 'http://www.rbkmoney.ru', array('attributes' => array('target' => '_blank'))))),
  );
  $form['advanced']['uc_rbkmoney_recurring'] = array(
    '#type' => 'select',
    '#title' => t('Reccuring payment'),
    '#options' => array('false' => 'false (default)', 'true' => 'true'),
    '#default_value' => variable_get('uc_rbkmoney_recurring', 'false'),
    '#description' => t("Set reccuring payment mode"),
  );
  $form['advanced']['uc_rbkmoney_version'] = array(
    '#type' => 'select',
    '#title' => t('Protocol version'),
    '#options' => array(1 => '1 (default)', 2 => 2),
    '#default_value' => variable_get('uc_rbkmoney_version', 1),
    '#description' => t("Set protocol version"),
  );
  $form['advanced']['uc_rbkmoney_direct'] = array(
    '#type' => 'select',
    '#title' => t('Direct mode'),
    '#options' => array('false' => 'false (default)', 'true' => 'true'),
    '#default_value' => variable_get('uc_rbkmoney_direct', 'false'),
    '#description' => t("Set direct payment mode"),
  );
  $form['advanced']['uc_rbkmoney_language'] = array(
    '#type' => 'select',
    '#title' => t('Interface language'),
    '#options' => array('ru' => 'ru (default)', 'en' => 'en'),
    '#default_value' => variable_get('uc_rbkmoney_language', 'ru'),
    '#description' => t("Please, select interface language"),
  );

  return system_settings_form($form);
}

/**
 * Implements hook_uc_payment_method().
 */
function uc_rbkmoney_uc_payment_method() {
  $path = base_path() . drupal_get_path('module', 'uc_rbkmoney') . '/images/logo.gif';
  $img = theme('image', array('path' => $path, 'alt' => 'RBK Money', 'attributes' => array('class' => 'system_logo')));
  $title = t('RBK Money') . '<br />' . $img;
  $methods[] = array(
    'id' => 'rbkmoney',
    'name' => t('RBK Money'),
    'title' => $title,
    'desc' => t('RBK Money'),
    'weight' => 1,
    'callback' => 'uc_payment_method_rbkmoney',
    'checkout' => TRUE,
    'no_gateway' => TRUE,
  );
  return $methods;
}

/**
 * 	Implements hook_payment_method
 */
function uc_payment_method_rbkmoney() {
  return;
}

 /**
 * Implements hook_form_alter() for uc_cart_checkout_review_form().
 */
function uc_rbkmoney_form_alter(&$form, &$form_state, $form_id) {
  $order_id = isset($_SESSION['cart_order']) ? intval($_SESSION['cart_order']) : 0;
  if ($form_id == 'uc_cart_checkout_review_form' && $order_id > 0) {
    $order = uc_order_load($order_id);
    if ($order->payment_method == 'rbkmoney') {
      unset($form['actions']['submit']);
      $form['#prefix'] = '<table><tr><td>';
      $form['#suffix'] = '</td><td>' . drupal_render(drupal_get_form('uc_rbkmoney_submit_form', $order)) . '</td></tr></table>';
    }
  }
}

/**
 * Returns the description and subtotal of the products on an order.
 */
function _uc_rbkmoney_product_details($items) {
  $desc = '';
  if (!empty($items)) {
    foreach ($items as $item) {
      if (!empty($desc)) {
        $desc .= ', ';
      }
      $desc .= $item->qty . 'x ' . check_plain($item->title);
    }
  }
  return $desc;
}

/**
 * Payment request.
 */
function uc_rbkmoney_submit_form($form, &$form_state, $order) {
  $order = uc_order_load($_SESSION['cart_order']);
  $desc = _uc_rbkmoney_product_details($order->products);

  // Prevent more than 255 symbols of order description.
  if (drupal_strlen($desc) > 255) {
    $desc = t('Order number @num', array('@num' => $order->order_id));
  }

  $form['eshopId'] = array(
    '#type' => 'hidden',
    '#value' => variable_get('uc_rbkmoney_eshopId', ''),
  );
  $form['orderId'] = array(
    '#type' => 'hidden',
    '#value' => $order->order_id,
  );
  $form['serviceName'] = array(
    '#type' => 'hidden',
    '#value' => $desc,
  );
  $form['recipientAmount'] = array(
    '#type' => 'hidden',
    '#value' => $order->order_total,
  );
  $form['recipientCurrency'] = array(
    '#type' => 'hidden',
    '#value' => variable_get('uc_rbkmoney_recipientCurrency', 'RUR'),
  );

  if (variable_get('uc_rbkmoney_send_hash', 0) == 1) {
    $price = str_replace('.', ',', $order->order_total); // use comma as sum separator
    $string = variable_get('uc_rbkmoney_eshopId', '') . "::" . $price . "::" . variable_get('uc_rbkmoney_recipientCurrency', 'RUR') . "::" . $order->primary_email . "::" . $desc . "::" . $order->order_id . "::::" . variable_get('uc_rbkmoney_secretKey', '');
    $form['hash'] = array(
      '#type' => 'hidden',
      '#value' => md5($string),
    );
  }

  $recurring = variable_get('uc_rbkmoney_recurring', 'false');
  if ($recurring == 'true') {
    $form['recurring'] = array(
      '#type' => 'hidden',
      '#value' => $recurring,
    );
  }

  $version = variable_get('uc_rbkmoney_version', 1);
  if ($version == 2) {
    $form['version'] = array(
      '#type' => 'hidden',
      '#value' => $version,
    );
  }

  $direct = variable_get('uc_rbkmoney_direct', 'false');
  if ($direct == 'true') {
    $form['direct'] = array(
      '#type' => 'hidden',
      '#value' => $direct,
    );
  }

  $language = variable_get('uc_rbkmoney_language', 'ru');
  if ($language != 'ru') {
    $form['language'] = array(
      '#type' => 'hidden',
      '#value' => $language,
    );
  }

  $form['successUrl'] = array(
    '#type' => 'hidden',
    '#value' => url($GLOBALS['base_url'] . '/uc_rbkmoney/success'),
  );
  $form['failUrl'] = array(
    '#type' => 'hidden',
    '#value' => url($GLOBALS['base_url'] . '/uc_rbkmoney/fail'),
  );
  $pref = variable_get('uc_rbkmoney_preference', 'all');
  if ($pref != 'all') {
    $form['preference'] = array(
      '#type' => 'hidden',
      '#value' => $pref,
    );
  }
  $form['user_email'] = array(
    '#type' => 'hidden',
    '#value' => $order->primary_email,
  );
  $form['#action'] = variable_get('uc_rbkmoney_actionURL', 'https://rbkmoney.ru/acceptpurchase.aspx');
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Place your order'),
  );
  return $form;
}

/**
 * Callback for RBK Money server response
 */
function uc_rbkmoney_done_payment() {
  header("HTTP/1.0 200 OK");

/* Check for allowed IP */
  if (variable_get('uc_rbkmoney_ip', 0) == 1) {
    $allowed_ip = unserialize(UC_RBKMONEY_IP_LIST);
    if (!in_array($_SERVER['REMOTE_ADDR'], $allowed_ip)) {
      watchdog("uc_rbkmoney", t("Possible fraud. Error with remote IP address = %ip. The remote address of the script posting to this notify script does not match a valid RBK Money ip address"), array('%ip' => ip_address()), WATCHDOG_WARNING);
      exit();
    }
  }

  foreach ($_POST as $k => $v) {
    $response[$k] = $v;
  }

  if (variable_get('uc_rbkmoney_log', 1) == 1) {

    switch ($response['paymentStatus']) {
      case UC_RBKMONEY_STATUS_PROCESS:
        $status = 'processing';
        break;
      case UC_RBKMONEY_STATUS_SUCCESS:
        $status = 'success';
        break;
      default:
        break;
    }

    $log = var_export($response, TRUE);
    watchdog('uc_rbkmoney', "status: {$status}; data: <pre>%log</pre>", array('%log' => $log));
  }

  if (!empty($response['hash'])) {

    $order = uc_order_load($response['orderId']);

    $string = variable_get('uc_rbkmoney_eshopId', '') . '::' . $response['orderId'] . '::' . $response['serviceName'] . '::' . $response['eshopAccount'] . '::' . number_format($order->order_total, 2, '.', '') . '::' . variable_get('uc_rbkmoney_recipientCurrency', 'RUR') . '::' . $response['paymentStatus'] . '::' . $response['userName'] . '::' . $response['userEmail'] . '::' . $response['paymentData'] . '::' . variable_get('uc_rbkmoney_secretKey', '');
    $crc = md5($string);

    if ($response['hash'] == $crc) {
      switch ($response['paymentStatus']) {
        case UC_RBKMONEY_STATUS_PROCESS:
          uc_order_update_status($response['orderId'], 'processing');
          uc_order_comment_save($response['orderId'], $order->uid, t('RBK Money: payment processing'), $type = 'admin', $status = 1, $notify = FALSE);
          break;
        case UC_RBKMONEY_STATUS_SUCCESS:
          uc_payment_enter($response['orderId'], 'RBK Money', $order->order_total, $order->uid, NULL, NULL);
          uc_cart_complete_sale($order);
          uc_order_comment_save($response['orderId'], $order->uid, t('RBK Money: payment successful'), $type = 'admin', $status = 1, $notify = FALSE);
          break;
      }
    }
    elseif ($response['hash'] !== $crc) {
      uc_order_update_status($response['orderId'], 'canceled');
      uc_order_comment_save($response['orderId'], $order->uid, t('MD5 checksum fail, possible fraud. Order canceled'), $type = 'admin', $status = 1, $notify = FALSE);
      watchdog('uc_rbkmoney', 'MD5 checksum fail, possible fraud. Order canceled');
    }
  }
}

/**
 * Callback redirect from RBK Money site.
 */
function uc_rbkmoney_payment_end($arg) {
  switch ($arg) {
    case "success":
      if (isset($_SESSION['cart_order'])) {
        $_SESSION['uc_checkout'][$_SESSION['cart_order']]['do_complete'] = TRUE;
        drupal_goto('cart/checkout/complete');
      }
      break;
    case "fail":
      if (isset($_SESSION['cart_order'])) {
        unset($_SESSION['cart_order']);
        drupal_set_message(t("Your payment has been declined."));
        drupal_goto('cart');
      }
      break;
  }
  return;
}
