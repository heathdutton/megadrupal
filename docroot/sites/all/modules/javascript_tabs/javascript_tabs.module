<?php
/**
 * @file
 * The main javascript_tabs module file.
 *
 * Overrides the output of the 'tabs' key in $variables.
 */


/**
 * Implements hook_process_HOOK().
 */
function javascript_tabs_process_page(&$variables) {
  // If we have tabs then check which themes to display them on.
  if (isset($variables['tabs']) and !empty($variables['tabs']) and !empty($variables['tabs']['#primary'])) {
    $theme = '';
    if (path_is_admin(current_path())) {
      $theme = variable_get('admin_theme');
    }
    if (empty($theme)) {
      global $theme;
    }

    $themes = list_themes();
    $theme_visibility = variable_get('javascript_tabs_theme_visibility', array());

    if (in_array($theme, $theme_visibility)) {
      // If it's the right theme, check which pages to display them on.
      $visibility = variable_get('javascript_tabs_visibility', 0);
      $match_path = (drupal_match_path(drupal_get_path_alias($_GET['q']), variable_get('javascript_tabs_pages', '')) or drupal_match_path($_GET['q'], variable_get('javascript_tabs_pages', '')));

      if (($visibility == 0 and !$match_path) or ($visibility == 1 and $match_path)) {
        // Now add our wrapper divs and add css+js.
        drupal_add_js(drupal_get_path('module', 'javascript_tabs') . '/assets/javascript_tabs.js');
        drupal_add_css(drupal_get_path('module', 'javascript_tabs') . '/assets/javascript_tabs.css', 'module', 'all', FALSE);
        $variables['tabs'] = '<div id="javascript-tabs"><div id="javascript-tabs-rollover"></div>' . render($variables['tabs']) . '</div>';
        $variables['javascript_tabs_overridden'] = TRUE;
      }
    }
  }

  if (!isset($variables['javascript_tabs_overridden'])) {
    // Helper var for template.php.
    $variables['javascript_tabs_overridden'] = FALSE;
  }
}

/**
 * Implements hook_menu().
 */
function javascript_tabs_menu() {
  $items['admin/config/user-interface/javascript-tabs'] = array(
    'title'             => 'JavaScript Tabs',
    'description'       => 'Settings for the JavaScript tab replacement module.',
    'page callback'     => 'drupal_get_form',
    'page arguments'    => array('javascript_tabs_admin_settings'),
    'access arguments'  => array('administer site configuration'),
    'type'              => MENU_NORMAL_ITEM,
    'file'              => 'javascript_tabs.admin.inc',
  );

  return $items;
}
