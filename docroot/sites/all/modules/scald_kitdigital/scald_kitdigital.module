<?php

/**
 * @file
 * Defines a Kit Digital provider for Scald.
 */

/**
 * Implements hook_menu().
 */
function scald_kitdigital_menu() {
  $items = array();
  $items['admin/config/content/scald_kitdigital'] = array(
    'title'             => 'Scald Kitdigital',
    'weight'            => 70,
    'description'       => 'Configure kitdigital account',
    'page callback'     => 'drupal_get_form',
    'page arguments'    => array('scald_kitdigital_admin_form'),
    'access arguments'  => array('administer scald atoms'),
    'file'              => 'includes/scald_kitdigital.admin.inc',
    'type'              => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * Implements hook_scald_atom_providers().
 */
function scald_kitdigital_scald_atom_providers() {
  return array(
    'video' => 'Video hosted on KitDigital',
  );
}

/**
 * Implements hook_scald_add_form().
 */
function scald_kitdigital_scald_add_form(&$form, &$form_state) {
  $form['identifier'] = array(
    '#type' => 'textfield',
    '#title' => t('SIG video identifier'),
    '#default_value' => '',
  );
}

/**
 * Implements hook_scald_add_form_fill().
 */
function scald_kitdigital_scald_add_form_fill(&$atoms, $form, $form_state) {
  $atom = is_array($atoms) ? reset($atoms) : $atoms;

  // Get the identifier.
  $identifier = $form_state['values']['identifier'];
  $atom->base_id = $identifier;

  $app_key = variable_get('scald_kitdigital_appkey', '');

  // GET APP KEY.
  $appkey = drupal_http_request('http://api.kewego.com/app/getToken/?appKey=' . $app_key);
  $appkey = simplexml_load_string($appkey->data);

  $infos = drupal_http_request('http://api.kewego.com/video/getDetails/?appToken=' . $appkey->message->appToken . '&sig=' . $identifier);
  $infos = simplexml_load_string($infos->data);

  $atom->title = (string) $infos->message->title;

  // Prefill the author.
  $atom->scald_authors[LANGUAGE_NONE][0] = array(
    'tid' => 0,
    'taxonomy_term' => (object) (array('name' => (string) $infos->message->author)),
  );

  if (!isset($atom->data)) {
    $atom->data = array();
  }

  // Download a copy of the video thumbnail.
  // Makes possible to do manipulation with image styles presets.
  $thumb = drupal_http_request('http://api.kewego.com/video/getThumbnailsURL/?appToken=' . $appkey->message->appToken . '&sig=' . $identifier . '&size=&number=');
  $thumb = simplexml_load_string($thumb->data);

  $thumbnails = $thumb->message->thumbnails;
  $thumbnails = $thumbnails->image;

  foreach ($thumbnails as $thumbnail) {
    $thumb = (string) $thumbnail;
    break;
  }
  $dir = 'public://kitdigital';
  if (file_prepare_directory($dir, FILE_CREATE_DIRECTORY)) {
    $dest = $dir . '/' . $identifier . '.jpg';
    $file = file_save_data(file_get_contents($thumb), $dest);
    if ($file) {
      // Set the file status to temporary.
      $query = db_update('file_managed')
        ->condition('fid', $file->fid)
        ->fields(array('status' => 0))
        ->execute();

      $atom->scald_thumbnail[LANGUAGE_NONE][0] = (array) $file;
    }
  }
}

/**
 * Implements hook_scald_fetch().
 */
function scald_kitdigital_scald_fetch($atom, $type) {
  $file = $atom->scald_thumbnail[LANGUAGE_NONE][0]['uri'];
  if (file_exists($file)) {
    $atom->file_source = $atom->thumbnail_source = $file;
  }
}

/**
 * Implements hook_scald_prerender().
 */
function scald_kitdigital_scald_prerender($atom, $context, $options, $mode) {
  if ($mode == 'atom') {
    if ($context != 'sdl_library_item') {
      $atom->rendered->player = theme('scald_kitdigital_player',
        array(
          'vars' => array(
            'video_id'      => $atom->base_id,
            'video_width'   => ($atom->data['video_width'] ? $atom->data['video_width'] : 480),
            'video_height'  => ($atom->data['video_height'] ? $atom->data['video_height'] : 365),
            'thumbnail'     => $atom->rendered->thumbnail_source_url,
          ),
        )
      );
    }
  }
}

/**
 * Implements hook_theme().
 */
function scald_kitdigital_theme() {
  return array(
    'scald_kitdigital_player' => array(
      'variables' => array('vars' => NULL),
      'template' => 'scald_kitdigital_player',
    ),
  );
}
