<?php

/**
 * @file
 * DBLog selective cron module let you specify an different
 * numbers of entries for each type of watchdog entries.
 */
/*
 * Implements hook_menu().
 */
function dsc_menu() {
  $items = array();
  $items['admin/config/development/logging/dsc'] = array(
    'title' => 'DB log entries',
    'description' => 'Specify the number of watchdog entries to keep per type/level.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('dsc_admin_settings'),
    'access callback' => 'user_access',
    'access arguments' => array('administer site configuration'),
    'type' => MENU_NORMAL_ITEM,
    'file' => 'dsc.admin.inc',
  );
  return $items;
}

/*
 * Implements hook_cron().
 */

function dsc_cron() {
  module_load_include('admin.inc', 'dblog');
  $filters = dblog_filters();
  $settings = variable_get('dsc_settings', array('default' => 100));
  foreach ($filters['type']['options'] as $type_name => $type_label) {
    foreach ($filters['severity']['options'] as $severity_id => $severity_name) {
      $row_limit = !empty($settings[$type_name . '_' . $severity_name]) ? $settings[$type_name . '_' . $severity_name] : $settings['default'];
      // Query adapted from dblog_cron.
      if ($row_limit > 0) {
        $min_row = db_select('watchdog', 'w')
                ->fields('w', array('wid'))
                ->orderBy('wid', 'DESC')
                ->range($row_limit - 1, 1)
                ->condition('type', $type_name)
                ->condition('severity', $severity_id)
                ->execute()->fetchField();

        if ($min_row) {
          db_delete('watchdog')
              ->condition('wid', $min_row, '<')
              ->condition('type', $type_name)
              ->condition('severity', $severity_id)
              ->execute();
        }
      }
    }
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function dsc_form_system_logging_settings_alter(&$form, $form_state) {
  $form['dblog_row_limit']['#disabled'] = TRUE;
  $form['dblog_row_limit']['#description'] = t('This setting is overriden by DB log selective cron module. <a href="@settings">Go to configuration page.</a>.', array('@settings' => url('admin/config/development/logging/dsc')));
}
