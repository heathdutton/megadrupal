<?php
/**
* @file
* Install Zoho Sales IQ.
*
*/

/**
 * Implements hook_permission().
 */
function zoho_salesiq_permission() {
  // We set up permisssions to manage entity types, manage all entities and the
  // permissions for each individual entity
  $permissions = array(
    'administer zoho salesiq' => array(
      'title' => t('Administer Zoho SalesIQ'),
      'description' => t('Administer Zoho SalesIQ Settings'),
    ),  
    'access zoho salesiq' => array(
      'title' => t('Access Zoho SalesIQ'),
      'description' => t('Access Zoho SalesIQ Chat'),
    ),  
  );
  
  return $permissions;  
}

/**
 * Implements hook_init().
 */

function zoho_salesiq_init() {
  if (user_access('access zoho salesiq')) {
    $settings = variable_get('zoho_salesiq_settings');
    $embed = $settings['configuration']['embedcode'];
    if (zoho_salesiq_check_path($settings['visibility']['visibility'], $settings['visibility']['pages']) && zoho_salesiq_check_theme()) {
      drupal_add_js(sprintf('var $zoho= $zoho || {salesiq:{values:{},ready:function(){}}};var d=document;s=d.createElement("script");s.type="text/javascript";s.defer=true;s.src="https://salesiq.zoho.com/%s/float.ls?embedname=%s";t=d.getElementsByTagName("script")[0];t.parentNode.insertBefore(s,t);', $embed, $embed),
        array('type' => 'inline', 
            'scope' => 'footer', 
            'weight' => 5)
      );
      _zoho_salesiq_type($settings['configuration']['type'], $settings['configuration']['custom']);
      drupal_add_js(sprintf('jQuery("%s").click(function(){$zoho.salesiq.floatwindow.visible("show");});', $settings['configuration']['trigger']) ,
        array('type' => 'inline', 
            'scope' => 'footer', 
            'weight' => 7)
      );
    }
  }
}

/**
* Implementation of hook_menu().
*/
function zoho_salesiq_menu() {
  // Admin settings.
  $items['admin/config/services/zoho_salesiq'] = array(
    'title' => 'Zoho Sales IQ',
    'description' => 'Configures Zoho Sales IQ module',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('zoho_salesiq_settings'),
    'access arguments' => array('administer zoho salesiq'),
    'type' => MENU_LOCAL_TASK,
  );
  return $items;
}

function zoho_salesiq_check_path($visibility, $pages) {
  $pages = drupal_strtolower($pages);
  // Convert the Drupal path to lowercase
  $path = drupal_strtolower(drupal_get_path_alias($_GET['q']));
  // Compare the lowercase internal and lowercase path alias (if any).
  $page_match = drupal_match_path($path, $pages);
  if ($path != $_GET['q']) {
    $page_match = $page_match || drupal_match_path($_GET['q'], $pages);
  }
  // When $block->visibility has a value of 0 (BLOCK_VISIBILITY_NOTLISTED),
  // the block is displayed on all pages except those listed in $block->pages.
  // When set to 1 (BLOCK_VISIBILITY_LISTED), it is displayed only on those
  // pages listed in $block->pages.
  $page_match = !($visibility xor $page_match);
  return $page_match;
}

function zoho_salesiq_check_theme() {
  global $theme_key;
  $settings = variable_get('zoho_salesiq_settings');
  $visibility = $settings['theme']['visibility'];
  $theme_match = in_array($theme_key, $settings['theme']['themes']);
  $theme_match = !($visibility xor $theme_match);
  $visibility = $settings['theme']['visibility'];
  return $theme_match;
}

/**
 * Module settings form.
 */
function zoho_salesiq_settings($form, &$form_state) {
  $settings = variable_get('zoho_salesiq_settings');
  $themes = list_themes();
  $active_themes = array();
  foreach ($themes as $theme) {
    if ($theme->status) {
      $active_themes[$theme->name] = $theme->info['name'];
    }
  }
  $options['salesiq'] = array(
    '#type' => 'vertical_tabs',
  );
  // Per-path visibility.
  $options['configuration'] = array(
    '#type' => 'fieldset',
    '#title' => t('SalesIQ Configuration'),
    '#collapsible' => TRUE,
    '#collapsed' => FALSE,
    '#group' => 'salesiq'
  );
  $options['configuration']['embedcode'] = array(
    '#type' => 'textfield',
    '#title' => t('Embed Code'),
    '#size' => 30, 
    '#maxlength' => 30, 
    '#required' => TRUE,
    '#default_value' => $settings['configuration']['embedcode'],
    '#description' => t("The embed code generated by zoho for an specific chat widget. You can grab it here %website.", array('%website' => 'https://salesiq.zoho.com/<<youraccount>>/index#setting/embedchats')),
  );
  $options['configuration']['type'] = array(
    '#type' => 'select',
    '#title' => t('Widget Type'),
    '#options' => array(
       0 => t('Float Buttom'),
       1 => t('No Float Buttom, trigger activated'),
       2 => t('No Float Buttom, time trigger and trigger activated'),
       3 => t('Custom code'),
     ),
     '#default_value' => $settings['configuration']['type'],
     '#description' => t('Select predifined behaviours or set custom.'),
   );
  $options['configuration']['custom'] = array(
    '#type' => 'textarea',
    '#title' => 'Custom Configuration Code',
    '#default_value' => $settings['configuration']['custom'],
    '#description' => t("Zoho SalesIQ APIs are easy-to-use, quick-to-implement, designed to customize your Chat Widget based on your existing web presence and preferences. Learn more here %website.", array('%website' => 'https://www.zoho.com/salesiq/help/jsapi.html')),
  );
  $options['configuration']['trigger'] = array(
    '#type' => 'textfield',
    '#title' => t('CSS trigger for chat window'),
    '#size' => 30, 
    '#maxlength' => 30, 
    '#required' => TRUE,
    '#default_value' => $settings['configuration']['trigger'],
    '#description' => t("A valid CSS selector assigned to a DOM element that will activate chat onClick"),
  );
  $options['visibility'] = array(
    '#type' => 'fieldset',
    '#title' => t('Pages Visibility'),
    '#collapsible' => TRUE,
    '#collapsed' => FALSE,
    '#group' => 'salesiq'
  );
  $options['visibility']['visibility'] = array(
    '#type' => 'radios',
    '#title' => t('Activate on specific pages'),
    '#options' => array(
      0 => t('All pages except those listed'),
      1 => t('Only the listed pages'),
    ),
    '#default_value' => $settings['visibility']['visibility'],
  );
  $options['visibility']['pages'] = array(
    '#type' => 'textarea',
    '#title' => 'List of pages to activate',
    '#default_value' => $settings['visibility']['pages'],
    '#description' => t("Specify pages by using their paths. Enter one path per line. The '*' character is a wildcard. Example paths are %blog for the blog page and %blog-wildcard for every personal blog. %front is the front page.", array('%blog' => 'blog', '%blog-wildcard' => 'blog/*', '%front' => '<front>')),
  );
  // Per-path visibility.
  $options['theme'] = array(
    '#type' => 'fieldset',
    '#title' => t('Themes Visibility'),
    '#collapsible' => TRUE,
    '#collapsed' => FALSE,
    '#group' => 'salesiq'
  );
  $options['theme']['visibility'] = array(
    '#type' => 'radios',
    '#title' => t('Activate on specific themes'),
    '#options' => array(
      0 => t('All themes except those listed'),
      1 => t('Only the listed themes'),
    ),
    '#default_value' => $settings['theme']['visibility'],
  );
  $options['theme']['themes'] = array(
    '#type' => 'select',
    '#title' => 'List of themes where library will be loaded.',
    '#options' => $active_themes,
    '#multiple' => TRUE,
    '#default_value' => $settings['theme']['themes'],
    '#description' => t("Specify in which themes you wish the library to load."),
  );

  $options['#tree'] = TRUE;
  $form['zoho_salesiq_settings'] = $options;

  // Disable automatic defaults, which don't work with nested values.
  return system_settings_form($form, FALSE);
}

function _zoho_salesiq_type($type = 0, $custom = '') {
  switch ($type) {
    case 1:
      drupal_add_js('$zoho.salesiq.ready=function(){
        $zoho.salesiq.floatbutton.visible("hide");
        $zoho.salesiq.floatwindow.minimize(function()
          {
            $zoho.salesiq.floatbutton.visible("hide");
          });
        };',
        array('type' => 'inline', 
            'scope' => 'footer', 
            'weight' => 6)
      );
      break;
    case 2:
      $first = TRUE;
      if (isset($_SESSION['chat'])) {
        $first = FALSE;
        drupal_add_js('$zoho.salesiq.ready=function(){
          $zoho.salesiq.floatbutton.visible("hide");
          $zoho.salesiq.floatwindow.minimize(function()
            {
              $zoho.salesiq.floatbutton.visible("hide");
            });
          };',
          array('type' => 'inline', 
              'scope' => 'footer', 
              'weight' => 6)
        );
      } else {
        $_SESSION['chat'] = 1;
        drupal_add_js('$zoho.salesiq.ready=function(){
          $zoho.salesiq.floatbutton.visible("hide");
          $zoho.salesiq.floatwindow.visible("5");
          $zoho.salesiq.chat.complete(function(visitid,data)
            {
              $zoho.salesiq.floatbutton.visible("hide");
            });
          $zoho.salesiq.floatwindow.minimize(function()
            {
              $zoho.salesiq.floatbutton.visible("hide");
            });
          };',
          array('type' => 'inline', 
              'scope' => 'footer', 
              'weight' => 6)
        );
      }
      break;
    case 3:
      drupal_add_js($custom,
        array('type' => 'inline', 
            'scope' => 'footer', 
            'weight' => 6)
      );
      break;
    default:
      break;

  }
}