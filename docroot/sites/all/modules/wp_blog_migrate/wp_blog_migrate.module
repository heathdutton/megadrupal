<?php

/**
 * Implements hook_menu().
 */
function wp_blog_migrate_menu() {
  $items['admin/config/content/wp-blog-migrate'] = array(
    'title' => 'WP Blog Migrate',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('_wp_blog_migrate_admin_form'),
    'access arguments' => array('administer site configuration'),
  );

  return $items;
}

/**
 * Form constructor function for the admin form.
 */
function _wp_blog_migrate_admin_form($form, $form_state) {
  // Get all of the current content types.
  $types = node_type_get_types();
  foreach ($types as $type) {
    $content_types[$type->type] = $type->name;
  }
  $form['content_type'] = array(
    '#title' => t('Content type'),
    '#description' => t('The original content type containing your blog posts.'),
    '#type' => 'select',
    '#options' => $content_types,
  );

  // Get all available fields.
  $all_fields = field_info_fields();
  foreach (array_keys($all_fields) as $field) {
    $fields[$field] = $field;
  }
  // Sort the fields list, but keep the index intact.
  asort($fields);

  $form['tags'] = array(
    '#title' => t('Tags field'),
    '#description' => t('The original field containing your blog post tags.'),
    '#type' => 'select',
    '#options' => $fields,
  );

  $form['delete_content_type'] = array(
    '#title' => t('Delete content type'),
    '#description' => t('Check to delete the old blog post content type after import.'),
    '#type' => 'checkbox',
    '#default_value' => 1,
  );

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Go!'),
  );

  return $form;
}

/**
 * Form submission handler for _wp_blog_migrate_admin_form().
 *
 * @see _wp_blog_migrate_admin_form()
 */
function _wp_blog_migrate_admin_form_submit($form, $form_state) {
  $content_type = $form_state['values']['content_type'];
  $tags_field = $form_state['values']['tags'];

  // Mirror the WP blog content type settings with the original.
  $result = db_query("SELECT name FROM {variable} WHERE name LIKE '%" . $content_type . "%'");
  while ($variable = $result->fetchObject()) {
    $value = variable_get($variable->name);
    $new_variable_name = str_replace($content_type, 'wp_blog', $variable->name);
    variable_set($new_variable_name, $value);
  }

  // Find all nodes created using the original content type.
  $query = new EntityFieldQuery();
  $query->entityCondition('entity_type', 'node');
  $query->propertyCondition('type', $content_type);
  $results = $query->execute();

  if (isset($results['node'])) {
    // Load each node.
    $nodes = node_load_multiple(array_keys($results['node']));

    foreach ($nodes as $node) {
      // Change the content type.
      $node->type = 'wp_blog';

      // Change the tags field.
      $node->taxonomy_wp_blog_tags = $node->$tags_field;

      // Re-save the node.
      node_save($node);
    }
  }

  if ($form_state['values']['delete_content_type']) {
    node_type_delete($content_type);
  }
}
