<?php

/**
 * @file
 * SmartQueue module code.
 */

/**
 * Load a SmartQueue.
 *
 * @param int $qid
 *
 * @return SmartQueue
 */
function smartqueue_load($qid) {
  $queues = smartqueue_load_multiple(array($qid));
  return reset($queues);
}

/**
 * @param array $qids
 *   Queue IDs of the queues to load.
 *
 * @return array SmartQueue
 *   An array containing the loaded queues.
 */
function smartqueue_load_multiple($qids) {

  if (count($qids) > 1) {
    $placeholder = array_fill(0, count($qids), '?');
    $query = 'SELECT * FROM {smartqueue} WHERE qid IN (' . $placeholder . ')';
  } elseif (count($qids) == 1) {
    $query = 'SELECT * FROM {smartqueue} WHERE qid = ?';
  } else {
    return array();
  }

  $data = db_query($query, $qids)->fetchAllAssoc('qid');

  $queues = array();
  foreach ($qids as $qid) {
    if (!empty($data[$qid])) {
      $q = new $data[$qid]->class;
      $q->setRecord($data[$qid]);
      $queues[$qid] = $q;
    }
  }

  return $queues;
}

/**
 * Initiates a processing of a queue.
 */
function smartqueue_queue_process() {
  $p = new SmartQueueProcessorDefault();
  $p->process();
}
