<?php

/**
 * @file
 * Integrates Drupal Commerce with the UKMail shipping service.
 */

/**
 * Implements hook_commerce_shipping_method_info().
 */
function commerce_ukmail_commerce_shipping_method_info() {
  $shipping_methods = array();

  $shipping_methods['ukmail'] = array(
    'title' => t('UKMail'),
    'description' => t('UKMail delivery.'),
  );

  return $shipping_methods;
}

/**
 * Implements hook_commerce_shipping_service_info().
 */
function commerce_ukmail_commerce_shipping_service_info() {
  $shipping_services = array();

  $shipping_services['ukmail'] = array(
    'title' => t('UKMail'),
    'description' => t('UKMail delivery.'),
    'shipping_method' => 'ukmail',
    'callbacks' => array(
      'rate' => 'commerce_ukmail_rate',
    ),
  );

  return $shipping_services;
}

/**
 * Rate callback for the UKMail shipping service.
 */
function commerce_ukmail_rate($shipping_service, $order) {
  $order_wrapper = entity_metadata_wrapper('commerce_order', $order);
  $address = $order_wrapper->commerce_customer_shipping->commerce_customer_address;
  $country = $address->country->value();
  $postcode = $address->postal_code->value();

  // Find the zone for the postcode.
  $zone = (string) new CommerceUKMailZone($country, $postcode);

  // Find the price for the zone.
  $amount = _commerce_ukmail_get_amount($zone);

  return array(
    'amount' => $amount,
    'currency_code' => 'GBP',
  );
}

/**
 * Get the postcode cost for a zone.
 *
 * @param string $zone
 *   The zone to search for.
 *
 * @return string
 *   The amount in pence.
 */
function _commerce_ukmail_get_amount($zone) {
  // @todo: Make these amounts editable via the Rules UI?
  switch ($zone) {
    case 'B': // Scotland (excluding Highlands and Islands)
      $amount = 650;
      break;

    case 'C': // Scottish Highlands and Northern Ireland
      $amount = 1650;
      break;

    case 'D': // Scottish Islands, Isle of Man and Channel Islands
      $amount = 1750;
      break;

    case 'E': // Republic of Ireland
      $amount = 1850;
      break;

    default: // England and Wales
      $amount = 650;
      break;
  }

  return $amount;
}
