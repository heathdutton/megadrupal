<?php
/**
 * @file
 * Marketo Webform Integration
 */
define('MARKETO_WEBFORM_DELIMITER', ';');

/**
 * Implements hook_form_FORM_ID_alter for the webform component edit form.
 *
 * Provide fields to tag components for submission to Marketo.
 */
function marketo_webform_form_webform_component_edit_form_alter(&$form, &$form_state) {
  $form['extra']['marketo'] = array(
    '#type' => 'fieldset',
    '#title' => t('Marketo Munchkin Integration'),
    '#collapsible' => TRUE,
    '#collapsed' => FALSE,
  );

  $form['form_key']['#description'] .= ' <strong>' . t('If this field is to be submitted to Marketo, this must match the name of the corresponding field as defined in Marketo.') . '</strong>';
  $form['extra']['marketo']['marketo_submit'] = array(
    '#type' => 'checkbox',
    '#title' => t('Submit the value of this field to marketo.'),
    '#description' => t('When checked, the value of this field will be sent to Marketo when the form is submitted. The "Field Key" as specified above must match the name of the corresponding field as defined in Marketo.'),
    '#default_value' => !empty($form_state['build_info']['args'][1]['extra']['marketo']['marketo_submit']),
  );
  if ($form['type']['#value'] == 'email') {
    $form['extra']['marketo']['marketo_key'] = array(
      '#type' => 'checkbox',
      '#title' => t('Use this value as the Marketo Lead Key.'),
      '#description' => t('All data submitted to Marketo must be associated with an e-mail address (key) which identifies the lead. Check this box to use the value of this field as the key.'),
      '#states' => array(
        'visible' => array(
          '#edit-extra-marketo-marketo-submit' => array('checked' => TRUE),
        ),
      ),
      '#default_value' => !empty($form_state['build_info']['args'][1]['extra']['marketo']['marketo_key']),
    );
  }

  $form['#validate'][] = 'marketo_webform_component_validate';
}

/**
 * Validate handler for the webform_component_edit_form.
 */
 function marketo_webform_component_validate($form, &$form_state) {
   if (!empty($form_state['values']['extra']['marketo']['marketo_submit'])) {
     if (empty($form_state['values']['form_key'])) {
       form_set_error('form_key', t('You must specify a form key corresponding to the Marketo field name.'));
     }
   }
 }

/**
 * Implements hook_webform_submission_insert().
 *
 * Remember the tagged fields so they can be submitted to Marketo.
 */
function marketo_webform_webform_submission_insert($node, $submission) {
  // Loop through all components looking for those which are tagged for submission to marketo.
  $key = FALSE;
  $data = array();
  foreach ($node->webform['components'] as $delta => $component) {
    $name = trim($component['form_key']);
    if (!empty($name)) {
      if (!empty($component['extra']['marketo']['marketo_key'])) {
        $key = trim(reset($submission->data[$delta]['value']));
      }
      elseif (!empty($component['extra']['marketo']['marketo_submit'])) {
        $data[$name] = implode(MARKETO_WEBFORM_DELIMITER, $submission->data[$delta]['value']);
      }
    }
  }
  if ($key) {
    marketo_data($key, $data);
  }
}
