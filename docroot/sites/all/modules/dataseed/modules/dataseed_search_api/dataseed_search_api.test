<?php

/**
 * Class for testing Dataseed Search API web functionality.
 */
class DataseedSearchApiWebTest extends DrupalWebTestCase {

  protected $server_id;
  protected $index_id;

  public static function getInfo() {
    return array(
      'name' => 'Test Dataseed Search API integration',
      'description' => 'Tests functionality of Dataseed Search API indexes.',
      'group' => 'Dataseed',
    );
  }

  public function setUp() {
    parent::setUp('entity', 'search_api', 'search_api_test', 'dataseed_search_api');
  }

  public function testFramework() {
    $this->drupalLogin($this->drupalCreateUser(array('administer search_api')));
    $this->createServer();
    $this->createIndex();
  }

  protected function createServer() {
    // Test creating server fails without setting credentials
    $this->addServer();
    $this->assertText(t('Cannot create a Dataset server: Dataseed module is not configured yet.'));

    // Test creating server works after setting credentials
    $this->setCredentials();
    $this->addServer();
    $this->assertText(t('The server was successfully created.'));
    $found = strpos($this->getUrl(), 'admin/config/search/search_api/server/' . $this->server_id) !== FALSE;
    $this->assertTrue($found, 'Correct redirect.');
  }

  protected function createIndex() {
    $this->assertTrue(TRUE, 'TODO: Add createIndex test case');
  }

  private function setCredentials() {
    // TODO: Test the dataseed configuration form independently of this test case
    variable_set('dataseed_scheme', 'https');
    variable_set('dataseed_host', 'getdataseed.com');
    variable_set('dataseed_port', '80');
    variable_set('dataseed_path', '/');
    variable_set('dataseed_user', 'user');
    variable_set('dataseed_pass', 'pass');
  }

  private function addServer() {
    $this->server_id = 'dataseed_server';
    $values = array(
      'name' => 'Dataseed server',
      'machine_name' => $this->server_id,
      'enabled' => 1,
      'description' => 'A server used for testing the dataseed_search_api module.',
      'class' => DATASEED_SEARCH_API_SERVICE_ID,
    );
    $this->drupalPost('admin/config/search/search_api/add_server', $values, t('Create server'));
    $this->drupalPost(NULL, array(), t('Create server'));
  }

}
