<?php

/**
 * @file
 * Administer anonymous comments.
 *
 * Allows administrators to post and edit comments as anonymous users (that is,
 * not assigning to a user account) and also to post comments on nodes with
 * comments disabled.
 */

/**
 * Implements hook_node_load().
 */
function adminanoncomment_node_load($nodes, $types) {
  // Do nothing when editing the node; it would open it for everyone if saved.
  if (arg(0) == 'node' && arg(2) == 'edit') {
    return;
  }
  // Open commenting for all nodes if we have the special permission.
  if (user_access('administer anonymous comments')) {
    foreach ($nodes as $node) {
      $node->comment = COMMENT_NODE_OPEN;
    }
  }
}

/**
 * Implements hook_form_BASE_FORM_ID_alter().
 */
function adminanoncomment_form_comment_form_alter(&$form, $form_state) {
  if (user_access('administer anonymous comments')) {
    $account = $GLOBALS['user'];
    $comment = $form_state['comment'];
    $author = (!$comment->uid && $comment->name ? $comment->name : ($comment->cid ? $comment->registered_name : $account->name));
    $status = (isset($comment->status) ? $comment->status : COMMENT_PUBLISHED);
    $created = (isset($comment->created) ? $comment->created : time());
    $date = (!empty($comment->date) ? $comment->date : format_date($created, 'custom', 'Y-m-d H:i O'));
    unset($form['author']);
    $form['author'] = array(
      '#type' => 'fieldset',
      '#title' => t('Administration'),
      '#collapsible' => TRUE,
      '#collapsed' => FALSE,
      '#weight' => -2,
      '#description' => t('If you use the name of an existing user, <strong>the comment will become associated with that user</strong> instead of linking to any homepage provided.'),
    );
    $form['author']['name'] = array(
      '#type' => 'textfield',
      '#title' => t("Commenter's name"),
      '#default_value' => $author,
      '#maxlength' => 60,
      '#size' => 30,
    );

    // Add author e-mail and homepage fields depending on the current user.
    $form['author']['mail'] = array(
      '#type' => 'textfield',
      '#title' => t('E-mail'),
      '#default_value' => $comment->mail,
      '#maxlength' => 64,
      '#size' => 30,
      '#description' => t('The content of this field is kept private and will not be shown publicly.'),
    );
    $form['author']['homepage'] = array(
      '#type' => 'textfield',
      '#title' => t('Homepage'),
      '#default_value' => $comment->homepage,
      '#maxlength' => 255,
      '#size' => 30,
    );

    // Add administrative comment publishing options.
    $form['author']['date'] = array(
      '#type' => 'textfield',
      '#title' => t('Authored on'),
      '#default_value' => $date,
      '#maxlength' => 25,
      '#size' => 20,
    );
    $form['author']['status'] = array(
      '#type' => 'radios',
      '#title' => t('Status'),
      '#default_value' => $status,
      '#options' => array(
        COMMENT_PUBLISHED => t('Published'),
        COMMENT_NOT_PUBLISHED => t('Not published'),
      ),
    );
  }
}

/**
 * Implementation of hook_permission().
 */
function adminanoncomment_permission() {
  return array(
    'administer anonymous comments' => array(
      'title' => t('Administer anonymous comments')
    ),
  );
}
