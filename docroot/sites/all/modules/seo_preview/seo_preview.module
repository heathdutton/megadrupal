<?php

/**
 * Implements hook_init()
 */
function seo_preview_init() {
  if (_show_frontend_preview()) {
    $settings = _seo_preview_get_settings();
    drupal_add_js(array('seo_preview' => $settings), 'setting');
    drupal_add_js(drupal_get_path('module', 'seo_preview') .'/seo_preview.js');
    drupal_add_css(drupal_get_path('module', 'seo_preview') .'/seo_preview.css');
  }
}

/**
 * Implements hook_permission()
 */
function seo_preview_permission() {
  return array(
    'access seo preview' => array(
      'title' => t('Access SEO preview'),
      'description' => t('Allow users to access SEO preview'),
    ),
    'administer seo preview' => array(
      'title' => t('Administer SEO preview'),
      'description' => t('Allow users to administer SEO preview'),
    ),
  );
}

function _show_frontend_preview() {
  global $user;
  // Show preview only if user has permission
  if (!user_access('access seo preview')) return false;
  // Don't show preview in admin section
  if (arg(0) == 'admin') return false;
  // Don't show preview for node/add/ and node/*/edit paths
  if (arg(0) == 'node' AND (arg(1) == 'add' OR arg(2) == 'edit')) return false;
  return true;
}

/**
 * Implements hook_menu().
 */
function seo_preview_menu() {
  $items['admin/config/content/seo_preview'] = array(
    'title' => 'SEO Preview',
    'description' => 'Chose which features you would like enabled for SEO Preview',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('seo_preview_settings'),
    'access arguments' => array('administer seo preview'),
    'file' => 'seo_preview.admin.inc',
  );

  return $items;
}

/**
 * Return the settings with any defaults mapped over the top
 */
function _seo_preview_get_settings($default_only = FALSE) {
  $defaults = array(
    'minimize_by_default' => 0,
    'display_hints' => 1,
    'expand_on_warning' => 1,
  );

  if ($default_only) {
    return $defaults;
  }

  return variable_get('seo_preview_settings', array()) + $defaults;
}
