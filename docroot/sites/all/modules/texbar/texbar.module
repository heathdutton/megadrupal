<?php

/**
 * @file
 * TexBar module file
 */


/**
  * Implements hook_init() to add markitup related files to LaTeX Image Generator Files
  *
  */
function texbar_init() { 
  drupal_add_css(drupal_get_path('module', 'texbar') . '/texbar.css');
  drupal_add_css(variable_get('texbar_markitup', 'sites/all/libraries/markitup/markitup') . '/skins/simple/style.css');
  drupal_add_css(drupal_get_path('module', 'texbar') . '/sets/latex/latex-buttons.css');
  drupal_add_js(variable_get('texbar_markitup', 'sites/all/libraries/markitup/markitup') . '/jquery.markitup.js');
  drupal_add_js(drupal_get_path('module', 'texbar') . '/sets/latex/set.js');
  drupal_add_js(drupal_get_path('module', 'texbar') . '/texbar.js', array('scope' => 'footer'));
  drupal_add_js(array('texbar' => array('texbar_output' => variable_get('texbar_output', ''),'texbar_tag' => variable_get('texbar_tag'))), 'setting');
}

/**
 * Implements hook_menu().
 */
function texbar_menu() {
  $items['admin/config/media/texbar'] = array(
    'title' => 'TexBar',
    'description' => 'Control how texbars may be attached to content.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('texbar_admin_settings'),
    'access arguments' => array('administer site configuration'),
    'file' => 'texbar.admin.inc',
  );

  $items['texbar/post'] = array(
    'page callback' => 'texbar_post_tex',
    'page arguments' => array(0),
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );

  return $items;

}

function texbar_post_tex() {

  if (strlen($_POST['tex']) > variable_get('texbar_size', 0)) {
    echo "error";
    exit;
  }

  $output = $_POST['tex'];

  $output = str_replace('\\\\', '\\', $output);

  $output =  preg_replace_callback("/\\$\\$(.*?)\\$\\$/", 'my_urlencode', $output);

  $id = date("his");
  $fh = fopen($_SERVER['DOCUMENT_ROOT'] . base_path() . '/' . variable_get('texbar_output', NULL)  . '/' . "output$id.html", 'w+');
  fwrite($fh, '<html><body><p>' . $output . '</p></body></html>');
  fclose($fh);
  shell_exec(variable_get('texbar_html2ps', '/usr/bin/html2ps') . " -U " . $_SERVER['DOCUMENT_ROOT'] . base_path() . '/' . variable_get('texbar_output', NULL) . "/output$id.html > " . $_SERVER['DOCUMENT_ROOT'] . base_path(). '/' . variable_get('texbar_output', NULL). "/output$id.ps");
  shell_exec(variable_get('texbar_ps2pdf', '') . " " . $_SERVER['DOCUMENT_ROOT'] . base_path() . '/' . variable_get('texbar_output', NULL) . "/output$id.ps " . $_SERVER['DOCUMENT_ROOT'] . base_path(). '/' . variable_get('texbar_output', '') . "/output$id.pdf");

  $return['output'] = $id;
  echo json_encode($return);
}

function my_urlencode($a)
{
 return '<img src="' . variable_get('texbar_mimetex', 'http://www.example.com') . '?' . urlencode($a[0]) . '" />';
}

