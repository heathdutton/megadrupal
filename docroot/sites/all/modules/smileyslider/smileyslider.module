<?php

/**
 * @file
 *   Creates a "smiley slider" element type.
 */

/**
 * Implements hook_element_info().
 */
function smileyslider_element_info() {
  $types = array();
  $types['smileyslider'] = array(
    '#input' => TRUE, 
    '#multiple' => FALSE, 
    '#process' => array('form_process_select', 'ajax_process_form'), 
    '#theme' => 'smileyslider', 
    '#theme_wrappers' => array('form_element'),
  );
  return $types;
}

/**
 * Implements hook_theme().
 */
function smileyslider_theme() {
  return array(
    'smileyslider' => array(
      'render element' => 'element',
    ),
  );
}

/**
 * Implements hook_library().
 */
function smileyslider_library() {
  $path = drupal_get_path('module', 'smileyslider');
  return array(
    'smileyslider' => array(
      'title' => t('Smiley slider'),
      'website' => 'https://github.com/dglittle/smiley-slider',
      'version' => '0.0',
      'js' => array(
        $path . '/smiley-slider/smiley-slider.js' => array(),
        $path . '/smileyslider.js' => array(),
        array(
          'type' => 'setting',
          'data' => array(
            'smileyslider' => array(
              'image' => url($path . '/smiley-slider/smiley-slider.png', array('absolute' => TRUE)),
            ),
          ),
        ),
      ),
    ),
  );
}

/**
 * Themes a smiley slider.
 */
function theme_smileyslider($variables) {
  drupal_add_library('smileyslider', 'smileyslider');
  $classes = &$variables['element']['#attributes']['class'];
  if (!isset($classes)) {
    $classes = array();
  }
  if (!is_array($classes)) {
    $classes .= ' smiley-slider';
  }
  else {
    $classes[] = 'smiley-slider';
  }
  $range = isset($variables['element']['#range']) ? $variables['element']['#range'] : 10;
  if (isset($variables['element']['#options'])) {
    $variables['element']['#options'] += drupal_map_assoc(range(0, $range));
  }
  else {
    $variables['element']['#options'] = drupal_map_assoc(range(0, $range));
  }
  if (!isset($variables['element']['#default_value'])) {
    $variables['element']['#default_value'] = round($range / 2);
  }
  drupal_add_js(array('smileyslider' => array('range' => $range, 'default' => $variables['element']['#default_value'] / $range)), 'setting');
  return '<div class="slider"></div>' . theme('select', $variables);
}
