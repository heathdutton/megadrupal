<?php
/**
 * @file
 * This module implements the integration to Emediate banner system
 */

/**
 * Default setting for enabling of Emediate functionality
 */
define('EMEDIATE_ENABLED', TRUE);

// --------- HOOKS ---------
/**
 * Implements hook_menu().
 */
function emediate_menu() {
  $items = array();

  $items['admin/config/system/emediate'] = array(
    'title' => 'Emediate',
    'description' => 'Administration of Emediate settings and content units.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('emediate_settings_form'),
    'access arguments' => array('administer emediate'),
    'file' => 'emediate.admin.inc',
  );
  $items['admin/config/system/emediate/settings'] = array(
    'title' => 'Settings',
    'description' => 'General Emediate settings',
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  $items['admin/config/system/emediate/content-unit'] = array(
    'title' => 'Content units',
    'description' => 'Administration of Emediate content units.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('emediate_content_units_form'),
    'access arguments' => array('administer emediate'),
    'file' => 'emediate.admin.inc',
    'type' => MENU_LOCAL_TASK,
  );
  $items['admin/config/system/emediate/content-unit/delete/%emediate'] = array(
    'title' => 'Delete Emediate content unit',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('emediate_content_unit_delete', 6),
    'access arguments' => array('administer emediate'),
    'file' => 'emediate.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function emediate_permission() {
  return array(
    'administer emediate' => array(
      'title' => t('Administer Emediate'),
    ),
  );
}

/**
 * Implements hook_ctools_plugin_directory().
 *
 * Let the system know where our content_type plugins are.
 */
function emediate_ctools_plugin_directory($owner, $plugin_type) {
  if ($owner == 'ctools') {
    return 'plugins/' . $plugin_type;
  }
}

/**
 * Implements hook_theme().
 */
function emediate_theme($existing, $type, $theme, $path) {
  return array(
    'emediate_content_unit' => array(
      'arguments' => array('index' => NULL, 'content_unit' => NULL),
      'template'  => 'emediate-content-unit',
      'path' => drupal_get_path('module', 'emediate') . '/templates',
    ),
  );
}

/**
 * Implements hook_block_info().
 */
function emediate_block_info() {
  $blocks = array();
  $content_units = emediate_load_all();
  foreach ($content_units as $content_unit) {
    $blocks['emediate_content_unit:' . $content_unit->name] = array(
      'info' => t('Emediate content unit: @label', array('@label' => $content_unit->label)),
    );
  }
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function emediate_block_view($delta) {
  $name = preg_replace('/^emediate_content_unit:/', '', $delta);
  if ($name !== $delta) {
    $block['subject'] = '';
    $block['module'] = 'emediate';
    // Use $name here instead of $delta?
    $block['delta'] = $delta;

    $content_unit = emediate_load($name);
    $content_unit->iframe = FALSE;
    $content_unit->exclude_campaign = FALSE;
    if ($content_unit) {
      $block['content'] = _emediate_render_content_unit($content_unit);
    }
    else {
      $block['content'] = '<!-- Content unit ' . $name . ' not found -->';
    }
    return $block;
  }
}

// --------- "ENTITY" FUNCTIONS ---------
/**
 * Load an Emediate content unit.
 */
function emediate_load($name) {
  ctools_include('export');
  return ctools_export_crud_load('emediate_content_unit', $name);
}

/**
 * Load all Emediate content units.
 */
function emediate_load_all() {
  ctools_include('export');
  return ctools_export_crud_load_all('emediate_content_unit');
}

/**
 * Save an Emediate content unit.
 */
function emediate_save($content_unit) {
  ctools_include('export');
  $obj = ctools_export_crud_new('emediate_content_unit');
  foreach ($content_unit as $key => $value) {
    $obj->$key = $value;
  }
  ctools_export_crud_save('emediate_content_unit', $obj);
}

/**
 * Delete an Emediate content unit.
 */
function emediate_delete($content_unit) {
  ctools_include('export');
  return ctools_export_crud_delete('emediate_content_unit', $content_unit);
}

// ------ HELPER FUNCTIONS ------
/**
 * Initialize Emediate client-side functionality.
 *
 * Loaded on-demand.
 */
function _emediate_initialize() {
  static $has_run = FALSE;
  if ($has_run) {
    return;
  }
  $has_run = TRUE;

  $setting = array();
  $setting['content_units'] = array();

  if ($url = variable_get('emediate_external_js', NULL)) {
    drupal_add_js($url, 'external');
  }
  else {
    drupal_add_js(drupal_get_path('module', 'emediate') . '/js/EAS_tag.1.0.js');
  }

  // Initialize Emediate content units.
  drupal_add_js(drupal_get_path('module', 'emediate') . '/js/emediate.js');

  $query['encoding'] = 'utf-8';
  $setting['query'] = $query;

  drupal_alter('emediate_settings', $setting);
  drupal_add_js(array('emediate' => $setting), array('type' => 'setting'));
}

/**
 * Prepare and render Emediate content unit.
 */
function _emediate_render_content_unit($content_unit) {
  // Store settings.
  $setting = array();

  _emediate_initialize();

  $idx = &drupal_static('emediate_content_unit_delta', 0);
  // Store content unit in JS settings.
  $setting['emediate']['content_units'][$idx] = $content_unit;
  drupal_add_js($setting, array('type' => 'setting'));

  $content  = theme('emediate_content_unit', array('index' => $idx, 'content_unit' => $content_unit));

  // Increment global static variable 'emediate_content_unit_delta'.
  $idx++;

  return $content;
}
