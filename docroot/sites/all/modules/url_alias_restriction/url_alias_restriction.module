<?php

/**
 * @file
 * Makes pages inaccessible based on their URL alias.
 */

/**
 * Implments hook_menu().
 */
function url_alias_restriction_menu() {

  $items = array();

  $items['admin/config/search/url_alias_restriction'] = array(
    'title' => 'URL alias restriction',
    'description' => 'Define the url alias which triggers a restriction response and the type of response.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('url_alias_restriction_settings'),
    'access callback' => 'user_access',
    'access arguments' => array('administer url alias restriction'),
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function url_alias_restriction_permission() {
  return array(
    'administer url alias restriction' => array(
      'title' => t('Administer the settings of the URL alias restriction module for anonymous users.'),
      'restrict access' => TRUE,
    ),
  );
}

/**
 * Implements template_preprocess_page().
 */
function url_alias_restriction_preprocess_page(&$variables) {
  if (!user_is_logged_in()) {
    $alias = trim(drupal_get_path_alias());
    if ($alias) {
      $alias = explode('/', $alias);
      if (array_shift($alias) == variable_get('url_alias_restriction_element', 'restricted-access')) {
        drupal_add_http_header('Status', '404 Not Found');
        $fast_404_html = variable_get('404_fast_html', '<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML+RDFa 1.0//EN" "http://www.w3.org/MarkUp/DTD/xhtml-rdfa-1.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>404 Not Found</title></head><body><h1>Not Found</h1><p>The requested URL "@path" was not found on this server.</p></body></html>');
        // Replace @path in the variable with the page path.
        print strtr($fast_404_html, array('@path' => check_plain(request_uri())));
        exit;
      }
    }
  }
}

/**
 * Settings form.
 */
function url_alias_restriction_settings() {

  $form = array();

  $form['url_alias_restriction_element'] = array(
    '#title' => t('Path element which triggers a restricted / not found response.'),
    '#type' => 'textfield',
    '#description' => t('eg. "restricted-access" makes every content with URL aliases like "restricted-access/abcdefg" etc. unavailable. Please note, that this will also affect paths like node/1234 if the appropriate URL alias has been set for this node.'),
    '#default_value' => variable_get('url_alias_restriction_element', 'restricted-access'),
  );

  return system_settings_form($form);
}
