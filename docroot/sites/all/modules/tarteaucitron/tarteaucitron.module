<?php
/**
 * @file
 * Add the tarteaucitron.js service.
 */

/**
 * Implements hook_permission().
 */
function tarteaucitron_permission() {
  return array(
    'administer ferank' => array(
      'title' => t('Administer tarteaucitron.js'),
      'description' => t('Perform administration tasks for tarteaucitron.js.'),
      'restrict access' => TRUE,
    ),
  );
}

/**
 * Implements hook_menu().
 */
function tarteaucitron_menu() {
  $items = array();
  $items['admin/config/system/tarteaucitron'] = array(
    'title' => 'tarteaucitron.js',
    'description' => 'Add services on site . ',
    'page callback' => '_tarteaucitron_service',
    'access arguments' => array(
      'administer ferank',
    ),
  );
  return $items;
}

/**
 * Build the footer.
 */
function tarteaucitron_page_build(&$page) {
  if (!path_is_admin(current_path())) {
    $script = _tarteaucitron_output_js_code();
    $page['page_bottom']['tarteaucitron'] = array(
      '#type' => 'markup',
      '#markup' => $script,
    );
  }
}

/**
 * Put the Javascript to the footer.
 */
function _tarteaucitron_output_js_code() {
  $domain = $_SERVER['SERVER_NAME'];
  drupal_add_js('//opt-out.ferank.eu/tarteaucitron.js?domain=' . $domain . '&uuid=' . variable_get('tarteaucitronUUID', ''), array('type' => 'external', 'scope' => 'footer'));
}

/**
 * Post to opt-out.ferank.eu.
 */
function _tarteaucitron_post($query, $need_login = 1) {
  global $language;
  $query .= '&langWP=' . substr($language->language, 0, 2);
  if ($need_login == 1) {
    $query .= '&uuid=' . variable_get('tarteaucitronUUID', '') . '&token=' . variable_get('tarteaucitronToken', '') . '&website=' . $_SERVER['SERVER_NAME'];
  }
  $opts = array(
    'http' => array(
      'method'  => 'POST',
      'header'  => 'Content-type: application/x-www-form-urlencoded',
      'content' => $query,
    ),
  );
  $context = stream_context_create($opts);
  return file_get_contents('https://opt-out.ferank.eu/pro/wordpress/token.php', FALSE, $context);
}

/**
 * Services configuration.
 */
function _tarteaucitron_service() {
  $abo = 0;
  $abonnement = '';
  drupal_add_css(drupal_get_path('module', 'tarteaucitron') . '/css/admin.css');
  drupal_add_js(drupal_get_path('module', 'tarteaucitron') . '/js/admin.js');
  if (variable_get('tarteaucitronUUID', '') != '' OR variable_get('tarteaucitronToken', '') != '') {
    if (_tarteaucitron_post('check=1') == 0) {
      variable_set('tarteaucitronUUID', '');
      variable_set('tarteaucitronToken', '');
    }
  }

  if ($_POST) {
    if (isset($_POST['tarteaucitronEmail']) AND isset($_POST['tarteaucitronPass'])) {
      if ($_POST['tarteaucitronEmail'] != '' AND $_POST['tarteaucitronPass'] != '') {
        $result = _tarteaucitron_post('login=1&email=' . $_POST['tarteaucitronEmail'] . '&pass=' . $_POST['tarteaucitronPass'] . '&website=' . $_SERVER['SERVER_NAME'], 0);
        if ($result != '0') {
          $ret = explode('=', $result);
          variable_set('tarteaucitronUUID', $ret[0]);
          variable_set('tarteaucitronToken', $ret[1]);
        }
      }
    }
    elseif (isset($_POST['tarteaucitronLogout'])) {
      _tarteaucitron_post('remove=1');
      variable_set('tarteaucitronUUID', '');
      variable_set('tarteaucitronToken', '');
    }
    elseif (isset($_POST['tarteaucitron_send_services_static']) AND $_POST['wp_tarteaucitron__service'] != '') {
      $service = $_POST['wp_tarteaucitron__service'];
      $r = 'service=' . $service . '&configure_services=' . $_POST['wp_tarteaucitron__configure_services'] . '&';
      foreach ($_POST as $key => $val) {
        if (preg_match('#^wp_tarteaucitron__' . $service . '#', $key)) {
          $r .= preg_replace('#^wp_tarteaucitron__#', '', $key) . '=' . $val . '&';
        }
      }
      _tarteaucitron_post(trim($r, '&'));
    }
  }
  if (variable_get('tarteaucitronUUID', '') == '') {
    $html = '<div><h1>tarteaucitron.js</h1><form method="post" action=""><div class="tarteaucitronDiv" style="margin-bottom:25px;"><p><b><a href="https://opt-out.ferank.eu/pro/#paiement" target="_blank">' . t("Avant d'utiliser les services tarteaucitron, vous devez souscrire à un abonnement.") . '</a></b></p></div><h2 style="margin-bottom:20px">' . t('Connexion') . '</h2><div class="tarteaucitronDiv"><table><tr valign="top"><th scope="row">' . t('Email') . '</th><td><input type="text" name="tarteaucitronEmail" /></td></tr><tr valign="top"><th scope="row">' . t('Mot de passe') . '</th><td><input type="password" name="tarteaucitronPass" /></td></tr><tr valign="top"><th scope="row">&nbsp;</th><td><input type="submit" /></td></tr></table></div></form></div><style type="text/css">.tarteaucitronDiv{background:#FFF;padding: 10px;border: 1px solid #eee;border-bottom: 2px solid #ddd;max-width: 500px;}</style>';
  }
  else {
    $abo = _tarteaucitron_post('abonnement=1');

    if ($abo > time()) {
      $abonnement = '<strong style="color:darkgreen">' . t("Abonnement valide jusqu'au") . ' ' . date('d/m/Y H:i', $abo) . '</b>';
    }
    else {
      $abonnement = '<strong style="color:darkred">' . t('Abonnement expiré !') . ' <a target="_blank" href="https://opt-out.ferank.eu/pro/#paiement">' . t('Recharger') . '</a>';
    }

    $html = '<div><form method="post" action=""><input type="hidden" name="tarteaucitronLogout" /><div class="tarteaucitronDiv"><table style="margin:0 !important"><tr valign="top"><td>' . $abonnement . '</td></tr><tr valign="top"><td><input type="submit" value="' . t('Déconnexion') . '" style="margin: 0;padding: 5px;font-size: 12px;" /></td></tr></table></div></form><div class="tarteaucitronDiv" style="margin-bottom: 120px;max-width:600px;padding:20px;background:#fff;margin-top:20px">' . _tarteaucitron_post('getForm=1') . '</div></div><style type="text/css">.tarteaucitronDiv{background:#FFF;padding: 10px;border: 1px solid #eee;border-bottom: 2px solid #ddd;max-width: 500px;}</style>';
  }

  return $html;
}

/**
 * Implements hook_block_info().
 */
function tarteaucitron_block_info() {
  $blocks = array();
  for ($i = 1; $i < 15; $i++) {
    $blocks['service' . $i] = array(
      'info' => '[tarteaucitron.js] ' . variable_get('tarteaucitron_titre_service' . $i, 'Disponible'),
    );
  }
  return $blocks;
}

/**
 * Implements hook_block_configure().
 */
function tarteaucitron_block_configure($delta = '') {

  drupal_add_css(drupal_get_path('module', 'tarteaucitron') . '/css/admin.css');
  drupal_add_js(drupal_get_path('module', 'tarteaucitron') . '/js/admin.js');

  $form = array();
  $id_uniq = variable_get('tarteaucitron_id_' . $delta, 'wp_' . uniqid() . '-' . $delta);
  $image = variable_get('tarteaucitron_image_' . $delta, '000');
  $id_title = 'edit-title';
  $id_submit = 'tarteaucitron_idsubmit_' . uniqid();
  $content = _tarteaucitron_post('drupal=1&id_title=' . $id_title . '&id_submit=' . $id_submit . '&id=' . $id_uniq . '&getForm=2');
  $back_d = 'block';$back_f = 'block';
  if (variable_get('tarteaucitron_image_' . $delta, '') == '') {
    $back_d = 'none';
  }
  else {
    $back_f = 'none';
  }

  $form['id_uniq'] = array(
    '#prefix' => '<div style="display:' . $back_d . '" id="back_' . $id_uniq . '"><a style="display:' . $back_d . '" href="#" class="tarteaucitronSuppressMe" onclick="wp_tarteaucitron.deleteService(\'' . $id_uniq . '\');return false;">Supprimer et réinitialiser</a><br/><img id="img_' . $id_uniq . '" src="//opt-out.ferank.eu/img/services/' . $image . '.png" /></div><div id="front_' . $id_uniq . '" style="display:' . $back_f . '">' . $content . '</div>',
    '#weight' => 1,
    '#type' => 'hidden',
    '#title' => t('Choose a service'),
    '#default_value' => $id_uniq,
  );

  $form['image'] = array(
    '#weight' => 1,
    '#type' => 'hidden',
    '#title' => '',
    '#default_value' => $image,
    '#attributes' => array(
      'id' => 'input_img_' . $id_uniq,
    ),
  );

  $form['delete'] = array(
    '#weight' => 1,
    '#type' => 'hidden',
    '#title' => '',
    '#default_value' => '0',
    '#attributes' => array(
      'id' => 'delete_' . $id_uniq,
    ),
  );

  return $form;
}

/**
 * Implements hook_block_save().
 */
function tarteaucitron_block_save($delta = '', $edit = array()) {

  if ($edit['delete'] == '1') {
    variable_del('tarteaucitron_id_' . $delta);
    variable_del('tarteaucitron_titre_' . $delta);
    variable_del('tarteaucitron_image_' . $delta);
    _tarteaucitron_post('delete=1&data=' . $edit['id_uniq']);
  }
  else {
    $service = $_POST['wp_tarteaucitron__service'];
    $r = 'service=' . $service . '&configure_services=' . $_POST['wp_tarteaucitron__configure_services'] . '&';
    foreach ($_POST as $key => $val) {
      if (preg_match('#^wp_tarteaucitron__' . $service . '#', $key)) {
        $r .= preg_replace('#^wp_tarteaucitron__#', '', $key) . '=' . $val . '&';
      }
    }
    _tarteaucitron_post(trim($r, '&'));

    variable_set('tarteaucitron_id_' . $delta, $edit['id_uniq']);
    variable_set('tarteaucitron_titre_' . $delta, $edit['title']);
    variable_set('tarteaucitron_image_' . $delta, $edit['image']);
  }
}

/**
 * Implements hook_block_view().
 */
function tarteaucitron_block_view($delta = '') {
  $id_uniq = variable_get('tarteaucitron_id_' . $delta, '');
  $block = array();

  $content = '';
  if ($id_uniq != '') {
    $content = '<div id="' . $id_uniq . '"></div>';
  }

  $block['content'] = $content;

  return $block;
}
