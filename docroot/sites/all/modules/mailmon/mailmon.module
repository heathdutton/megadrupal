<?php

/**
 * Implements hook_mail_alter().
 */
function mailmon_mail_alter(&$message) {
  // We're not actually altering the $message, just using this as an
  // indicator that mail is being sent.
  $today = date('Y-m-d', REQUEST_TIME);
  $count = count(explode('@', $message['to'])) - 1;
  if (variable_get('mailmon_most_recent_date', NULL) != $today) {
    // Set the variable to today.
    variable_set('mailmon_most_recent_date', $today);
    // Confirm we really really don't have data for today. This query shouldn't run very often, so the performance seems OK.
    $day = db_select('mailmon', 'm');
    $day->addField('m', 'maildate');
    $day->condition('maildate', $today);
    $days = $day->execute()->fetchAll(PDO::FETCH_ASSOC);
    if (empty($days)) {
      // Insert a record for today.
      db_insert('mailmon')
        ->fields(array('maildate' => $today, 'mailcount' => $count))
        ->execute();
    }
    else {
      mailmon_update($count, $today);
    }
  }
  else {
    // Update.
    mailmon_update($count, $today);
  }
}

/**
 * Helper function to update an existing record.
 */
function mailmon_update($count, $today) {
  db_query("UPDATE {mailmon} SET mailcount = mailcount + :count WHERE maildate = :maildate", array('count' => $count, 'maildate' => $today));
}

/**
 * Implements hook_menu().
 */
function mailmon_menu() {
 $items['admin/config/development/mailmon'] = array(
   'title' => 'Mailmon',
   'type' => MENU_DEFAULT_LOCAL_TASK, //SEE mailmon.view
   'weight' => -10,
 );

 return $items;
}

/**
 * Implements hook_views_api().
 */
function mailmon_views_api() {
  return array(
    'api' => 3.0,
    'path' => drupal_get_path('module', 'mailmon') . '/views',
  );
}