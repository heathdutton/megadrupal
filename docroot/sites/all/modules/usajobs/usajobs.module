<?php

/**
 * @file
 * Display all current jobs.
 */

/**
 * Implements hook_theme().
 */
function usajobs_theme() {
  return array(
    'usajobs_item' => array(
      'variables' => array('item' => NULL),
      'template' => 'usajobs-item',
    ),
  );
}

/**
 * Implements hook_block_info().
 */
function usajobs_block_info() {
  $block['job-listing']['info'] = t('USAJobs listing');
  $block['job-listing']['cache'] = DRUPAL_CACHE_PER_PAGE;

  return $block;
}

/**
 * Implements hook_block_configure().
 */
function usajobs_block_configure($delta = '') {
  $form = array();

  if ($delta == 'job-listing') {
    $form['usajobs_organization_ids'] = array(
      '#type' => 'textfield',
      '#title' => t('Organization ID'),
      '#default_value' => variable_get('usajobs_organization_ids'),
      '#required' => TRUE,
      '#description' => t('Specifies which federal, state, or local agency to use as a filter.<br /><br /> For federal agencies, the ID is based on <a href="https://schemas.usajobs.gov/Enumerations/AgencySubElement.xml" target="_blank">USAJobs\' agency schema</a>. Two letter codes are used to span entire departments, while four letter codes are generally used for independent agencies or agencies within a department.<br /><br />
      For state and local agencies, a sample of the format follows. <br /><br />
      State of Virginia <strong>US-VA</strong><br />
      State of Virginia Department of Taxation <strong>US-VA:DEPT-TAX</strong><br />
      Fairfax County, VA <strong>US-VA:COUNTY-FAIRFAX</strong><br />
      Fairfax County Sheriff <strong>US-VA:COUNTY-FAIRFAX:SHERIFF</strong><br />
      City of Fairfax, VA <strong>US-VA:COUNTY-FAIRFAX:CITY-FAIRFAX</strong><br />
      '),
    );
  }

  return $form;
}

/**
 * Implements hook_block_save().
 */
function usajobs_block_save($delta = '', $edit = array()) {
  if ($delta == 'job-listing') {
    variable_set('usajobs_organization_ids', $edit['usajobs_organization_ids']);
  }
}

/**
 * Implements hook_block_view().
 *
 * Displays all current opening positions.
 */
function usajobs_block_view($delta = '') {
  $block = array();

  if ($delta == 'job-listing') {
    $block['subject'] = t('Current Opportunities');
    $block['content']['#markup'] = _usajobs_block_content();
    $block['content']['#attached'] = array(
      'css' => array(drupal_get_path('module', 'usajobs') . '/usajobs.css'),
      'group' => CSS_DEFAULT,
      'every_page' => FALSE,
      'preprocess' => TRUE,
    );
  }

  return $block;
}

/**
 * Fetch data and render with custom item template.
 *
 * @return string
 *   The rendered list of items for the block content.
 */
function _usajobs_block_content() {
  $output = '';

  // Get data.
  $jobs = usajobs_get_data(variable_get('usajobs_organization_ids'));

  if (empty($jobs)) {
    $output = t('No available positions at this time, please check back periodically.');
  }
  else {
    foreach ($jobs as $job) {
      $output .= theme('usajobs_item', array('item' => $job));
    }
  }

  $output = '<div id="usajobs">' . $output . '</div>';

  return $output;
}

/**
 * Processes variables for usajobs-item.tpl.php.
 *
 * @see usajobs-item.tpl.php
 */
function template_preprocess_usajobs_item(&$variables) {
  $item = $variables['item'];

  $variables['job_title'] = check_plain($item->position_title);
  $variables['job_url'] = check_url($item->url);
  $variables['job_organization'] = check_plain($item->organization_name);
  $variables['job_location'] = check_plain($item->locations[0]);
  $variables['job_salary_min'] = number_format($item->minimum, 2);
  $variables['job_salary_max'] = number_format($item->maximum, 2);

  $variables['job_start_date'] = '';
  if (isset($item->start_date)) {
    $variables['job_start_date'] = format_date(strtotime($item->start_date), 'custom', 'F d, Y');
  }

  $variables['job_end_date'] = '';
  if (isset($item->end_date)) {
    $variables['job_end_date'] = format_date(strtotime($item->end_date), 'custom', 'F d, Y');
  }

}

/**
 * Retrieve data from Government Jobs API.
 *
 * This API returns job openings across the federal government and
 * includes all current openings posted on USAJobs.gov that are open
 * to the public and located in the United States.
 * It also includes some state and local government jobs.
 *
 * http://search.digitalgov.gov/developer/jobs.html
 *
 * @param string $organization_ids
 *   A federal agency id.
 */
function usajobs_get_data($organization_ids) {

  // Connection string.
  $url = format_string('http://api.usa.gov/jobs/search.json?organization_ids=@organization_ids', array('@organization_ids' => $organization_ids));

  // Request data.
  $result = drupal_http_request($url);
  switch ($result->code) {
    case 200:
    case 301:
    case 302:
    case 304:
    case 307:
      return json_decode($result->data);

    default:
      drupal_set_message(t('Connection error "%error".', array('%error' => $result->code . ' ' . $result->error)), 'error');
  }

}
