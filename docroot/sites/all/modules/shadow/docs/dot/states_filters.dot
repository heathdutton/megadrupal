digraph {
  start -> tablename [ label="[a-z]" ]

  tablename -> tablename [ label="[a-z0-9_]" ]
  tablename -> dot [ label=".\nsave tablename\nignore" ]

  // "tablename" cannot go directly to "fieldname" since fieldnames have to start with a letter.
  dot -> fieldname [ label="[a-z]" ]

  fieldname -> fieldname [ label="[a-z0-9_]" ]
  fieldname -> start_value [ label=":\nsave fieldname\nignore" ]
  fieldname -> join_right_table [ label="=\nsave fieldname\nignore" ]

  join_right_table -> join_right_table [ label="[a-z0-9_]" ]
  join_right_table -> join_right_dot [ label=".\nsave right_table\nignore" ]

  join_right_dot -> join_right_field [ label="[a-z]" ]

  join_right_field -> join_right_field [ label="[a-z0-9_]" ]
  join_right_field -> join_separator [ label=",\nsave right_field\nignore" ]
  join_right_field -> join_cond_start [ label="[\nsave right_field\nignore" ]
  join_right_field -> join_optional [ label="*\nsave right_field" ]

  join_separator -> tablename [ label="[a-z]" ]

  join_optional -> join_separator [ label=",\nsave join_optional\nignore" ]

  join_cond_start -> join_cond_field [ label="[a-z]" ]

  join_cond_field -> join_cond_field [ label="[a-z0-9_]" ]
  join_cond_field -> join_cond_start_value [ label=":\nsave join_cond_field\nignore" ]

  join_cond_start_value -> join_cond_string [ label="'\nignore" ]
  join_cond_start_value -> join_cond_numeric [ label="[0-9\\.\\-]" ]

  join_cond_start_value_or_field -> join_cond_string [ label="'\nignore" ]
  join_cond_start_value_or_field -> join_cond_numeric [ label="[0-9\\.\\-]" ]
  join_cond_start_value_or_field -> join_cond_field [ label="[a-z]" ]

  join_cond_string -> join_cond_string [ label="[^\\\\\']" ]
  join_cond_string -> join_cond_backslashed [ label="\\\nignore" ]
  join_cond_string -> join_cond_after_value [ label="'\nsave join_cond_string\nignore" ]

  join_cond_backslashed -> join_cond_string

  join_cond_numeric -> join_cond_numeric [ label="[0-9\\.\\-]" ]
  join_cond_numeric -> join_cond_start_value_or_field [ label=",\nsave join_cond_numeric\nignore" ]
  join_cond_numeric -> join_cond_end [ label="]\nsave join_cond_numeric\nignore" ]

  join_cond_after_value -> join_cond_end [ label="]\nignore" ]
  join_cond_after_value -> join_cond_start_value_or_field [ label=",\nignore" ]

  join_cond_end -> join_optional [ label="*" ]
  join_cond_end -> join_separator [ label=",\nignore" ]

  start_value -> string [ label="'\nignore" ]
  start_value -> numeric [ label="[0-9\\.\\-]" ]

  string -> string [ label="[^\\\\\']" ]
  string -> backslashed [ label="\\\nignore" ]
  string -> after_value [ label="'\nsave string\nignore" ]

  backslashed -> string

  numeric -> numeric [ label="[0-9\\.\\-]" ]
  numeric -> after_value [ label=",\nsave numeric\nignore" ]
  numeric -> end [ label="save numeric" ]

  after_value -> end
  after_value -> start_value [ label=",\nignore" ]
}