<?php

/**
 * @file
 * Provides an field formatter for the save to drive button from google,
 * more information on https://developers.google.com/drive/savetodrive
 */

/**
 * Implements hook_field_formatter_info().
 */
function google_save_to_drive_field_formatter_info() {
  return array(
    'google_save_to_drive' => array(
      'label' => t('Google: Save to Drive'),
      'field types' => array('file'),
    ),
  );
}

/**
 * Implements hook_field_formatter_view().
 */
function google_save_to_drive_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  $element = array();
  $site_name = check_plain(variable_get('site_name'));
  
  foreach ($items as $delta => $item) {
    $file = (object) $item;
    $gdrive_button = '<div class="g-savetodrive"
       data-src="' . file_create_url($item['uri']) . '"
       data-filename="' . check_plain($file->filename) . '"
       data-sitename="' . $site_name. '">
      </div>';
    $element[$delta] = array('#markup' => theme('file_link', array('file' => $file)) . ' ' . $gdrive_button);
  }

  $element['#attached']['js'][] = 'https://apis.google.com/js/plusone.js';

  return $element;
}
