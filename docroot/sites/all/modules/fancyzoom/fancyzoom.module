<?php
/**
 * @file
 * Add automatic fancyzoom support to the site
 */

function _fancyzoom_version() {
  $ini = drupal_parse_info_file(drupal_get_path('module', 'fancyzoom') . '/fancyzoom.info');
  return isset($ini['version']) ? $ini['version'] : '7.x-1.x-dev';
}

/**
 * Implementation of hook_help().
 */
function fancyzoom_help($path, $arg) {
  if ($path == 'admin/config/media/fancyzoom') {
    return _fancyzoom_help();
  }
}

/**
 * Implementation of hook_permission().
 *
 * - Add a permission to administer fancyzoom
 */
function fancyzoom_permission() {
  return array(
    'administer fancyzoom' => array(
      'title' => t('Administer FancyZoom'),
      'description' => t('View and Edit FancyZoom global settings.')
    )
  );
}

/**
 * Implementation of hook_init().
 */
function fancyzoom_init() {
  _fancyzoom_add_js();
}

/**
 * Handy function to add our javascript
 *   - Include settings as part of the Drupal.settings object
 *   - Include FancyZoom javascripts in the page header
 */
function _fancyzoom_add_js() {
  if ($js = _fancyzoom_script_path()) {

    // get settings as an array
    $keys = array('zoomTime', 'zoomSteps', 'minBorder', 'includeFade', 'includeCaption', 'showClosebox', 'shadowColor', 'zoomImagesURI');
    $settings = array();
    foreach ($keys as $k) {
      $v = _fancyzoom_var($k);
      $settings[$k] = is_numeric($v) ? $v*1 : $v;
    }

    // precalculate a CSS string for RGBA
    $h = $settings['shadowColor'];
    if (strlen($h) == 4) $h = preg_replace('/#(.)(.)(.)/', '#\1\1\2\2\3\3', $h);
    for ($x=1; $x<6; $x+=2) $rgb[] = hexdec(substr($h, $x, 2));
    $settings['shadowSettings'] = '0px 5px 25px rgba(' . join(',', $rgb) . ',';

    // smart replace tokens in the images path
    global $base_path;
    $img = $settings['zoomImagesURI'];
    if (trim($img) == '') {
      $img = _fancyzoom_script_path() . '/images/zoom';
    }
    else {
      $img = str_replace('$t', path_to_theme(), str_replace('$m', drupal_get_path('module', 'fancyzoom'), $img));
    }
    $settings['zoomImagesURI'] = base_path() . $img;

    // expose settings as Drupal.settings.fancyzoom
    drupal_add_js(array('fancyzoom' => $settings), 'setting');

    // include the selected javascript
    list($dir, $min) = explode('-', variable_get('fancyzoom_scriptType', 'jquery-min') . '-');
    if ($min) $min = '.min';
    drupal_add_js("$js/js/$dir/FancyZoom$min.js");
  }
  elseif (user_access('administer fancyzoom')) {
    $args = array('!url' => l('FancyZoom Javascript', 'http://www.thinkyhead.com/design/fancyzoom', array('target' => '_blank')));
    drupal_set_message(t('<em>FancyZoom is not fully installed yet!<br/>Download and install the !url to complete the installation!</em>', $args), 'warning');
  }
}

/**
 * Implementation of hook_menu().
 *
 * - Add menu items for the fancyzoom admin page
 *
 */
function fancyzoom_menu() {
  $items['admin/config/media/fancyzoom'] = array(
    'title' => 'FancyZoom',
    'description' => 'Configure zooming images throughout the site.',
    'file' => 'fancyzoom_admin.inc',
    'page callback' => 'fancyzoom_settings',
    'access arguments' => array('administer fancyzoom')
  );
  return $items;
}

function _fancyzoom_script_path() {
  $paths = array(drupal_get_path('module', 'fancyzoom') . '/fancyzoom');
  if (function_exists('libraries_get_path')) {
    $paths[] = libraries_get_path('fancyzoom');
  }
  foreach ($paths as $path) {
    if (file_exists("$path/js/standard/FancyZoom.js")) {
      return $path;
    }
  }
  return FALSE;
}

function _fancyzoom_var($var=FALSE) {
  $defaults = array(
    'zoomTime' => 5,
    'zoomSteps' => 15,
    'minBorder' => 90,
    'includeFade' => 1,
    'includeCaption' => 1,
    'showClosebox' => 1,
    'shadowColor' => '#000000',
    'scriptType' => 'jquery-min',
    'zoomImagesURI' => ''
  );
  return $var ? variable_get("fancyzoom_$var", $defaults[$var]) : $defaults;
}
