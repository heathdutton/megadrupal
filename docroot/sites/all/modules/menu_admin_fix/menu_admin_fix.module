<?php

define("MENU_VERSION_ISSUE", 7.38);

/**
 * Implements hook_form_FORM_ID_alter
 */
function menu_admin_fix_form_menu_overview_form_alter(&$form, &$form_state) {
  global $user;
  $info = system_get_info('module', 'menu');
  if ($user->uid == 1 && $info['version'] > MENU_VERSION_ISSUE) {
    drupal_set_message(t("Menu module has been updated to version: @version If this version fixes this issue: https://www.drupal.org/node/1007746, you should disable the menu_admin_fix module.", array('@version' => $info['version'])));
  }
  $menu = $form['#menu'];

  // Get a list of all the mlids
  $sql = "SELECT mlid FROM {menu_links} ml WHERE ml.menu_name = :menu
    ORDER BY p1 ASC, p2 ASC, p3 ASC, p4 ASC, p5 ASC, p6 ASC, p7 ASC, p8 ASC, p9 ASC";
  $links = db_query($sql, array(':menu' => $menu['menu_name']))->fetchCol();

  // Get total mlids.
  $delta = count($links);
  // If there's less than 50 items, the normal menu stuff will run fine.
  if ($delta < 50) return;
  // Iterate over mlids and update weight's delta value
  foreach ($links as $link) {
    $mlid = $link['mlid'];
    $mlid_key = 'mlid:'  . $mlid;
    $form[$mlid_key]['weight']['#delta'] = $delta;
  }
}
