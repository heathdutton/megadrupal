<?php
/**
 * @file
 *   Xero Functional Test Cases
 */


/**
 * @class
 *   XeroWebTestCase
 */
class XeroWebTestCase extends DrupalWebTestCase {

  public function setUp() {
    $args = func_get_args();
    $modules = isset($args[0]) ? $args[0] : array();

    // Retrieve variables from the live database.
    $key = variable_get('xero_consumer_key', '');
    $secret = variable_get('xero_consumer_secret', '');
    $cert_path = variable_get('xero_cert_path', '');
    $key_path = variable_get('xero_key_path', '');

    $modules = array_merge(array('xero'), $modules);
    parent::setUp($modules);

    // Set the variables after setup when using the test database.
    $this->web_admin = $this->drupalCreateUser(array('administer site configuration', 'bypass node access', 'administer content types', 'access content'));
    $this->drupalLogin($this->web_admin);

    $edit = array(
      'xero_consumer_key' => $key,
      'xero_consumer_secret' => $secret,
      'xero_cert_path' => $cert_path,
      'xero_key_path' => $key_path,
    );
    $this->drupalPost('admin/config/services/xero', $edit, t('Save configuration'));

    $this->drupalLogout();
  }

}

/**
 * @class
 *   Xero Autocomplete Test Case
 */
class XeroAutocompleteTestCase extends XeroWebTestCase {

  static public function getInfo() {
    return array(
      'name' => t('Xero Autocomplete Paths Tests'),
      'description' => t('Test the autocomplete paths.'),
      'group' => t('Xero'),
    );
  }

  public function setUp() {
    parent::setUp();

    $this->web_user = $this->drupalCreateUser(array('access xero'));
  }

  /**
   * Assert that user has access to autocomplete contacts.
   */

  public function testAutocompleteContacts() {
    $this->drupalGet('xero/autocomplete/Contact');
    $this->assertResponse(403, t('Access denied for anonymous user at %path', array('%path' => 'xero/autocomplete/Contacts')));

    $this->drupalLogin($this->web_user);
    $this->drupalGet('xero/autocomplete/Contact');
    $content = $this->drupalGetContent();
    $this->assertEqual(array(), json_decode($content), t('An empty json object was returned.'));
    $this->verbose($content);
  }

  /**
   * Assert that user has access to autocomplete invoices.
   */
  public function testAutocompleteInvoices() {
    $this->drupalGet('xero/autocomplete/Invoice');
    $this->assertResponse(403, t('Access denied for anonymous user at %path', array('%path' => 'xero/autocomplete/Invoices')));

    $this->drupalLogin($this->web_user);
    $this->drupalGet('xero/autocomplete/Invoice');
    $content = $this->drupalGetContent();
    $this->assertEqual(array(), json_decode($content), t('An empty json object was returned.'));
    $this->verbose($content);
  }

}
