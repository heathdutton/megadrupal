<?php

/**
 * @file
 * picture_password.install
 *
 * Install and uninstall functions for the Kaje Picture Passwords module.
 */

module_load_include('inc', 'picture_password', 'picture_password.kaje');

/**
 * Implements hook_enable().
 */
function picture_password_enable() {
  drupal_set_message(st("Thank you for installing Kaje™ Picture Passwords. To complete the installation visit the <a href='@url_config'>configuration page</a>.", array(
    '@url_config' => url('admin/config/system/picture-password'))
  ));
}

/**
 * Implements hook_requirements().
 */
function picture_password_requirements($phase) {
  $requirements = array();
  // Is get_t() required for the runtime phase?
  $t = get_t();

  if ($phase == 'runtime') {
    if (!function_exists('curl_init')) {
      $requirements['picture_password_curl'] = array(
        'title' => $t('cURL'),
        'severity' => REQUIREMENT_ERROR,
        'description' => $t('Kaje™ Picture Passwords requires the cURL PHP library to be installed.'),
      );
    }
    $response = picture_password_kaje_call('status');
    $version = empty($response->version) ? '' : $t('Version @version', array('@version' => $response->version));
    $requirements['picture_password'] = array(
      'title' => $t('Kaje™ Picture Passwords'),
      'value' => empty($version) ? $response->msg : $response->msg . ' ' . $version,
      'severity' => $response->msg_code == 700 ? REQUIREMENT_OK : REQUIREMENT_INFO,
    );
  }
  return $requirements;
}

/**
 * Implements hook_schema().
 */
function picture_password_schema() {
  $schema['picture_password'] = array(
    'description' => 'Stores uids of the Kaje Picture Passwords service.',
    'fields' => array(
      'drupal_uid' => array(
        'description' => 'Drupal user id',
        'type'        => 'int',
        'unsigned'    => TRUE,
        'not null'    => TRUE,
        'default'     => 0,
      ),
      'kaje_uid' => array(
        'description' => 'Kaje user id',
        'type'        => 'varchar',
        'length'      => 64,
        'not null'    => TRUE,
      ),
      'flags' => array(
        'description' => 'Flags pertaining to Kaje',
        'type'        => 'int',
        'unsigned'    => TRUE,
        'not null'    => FALSE,
        'default'     => NULL,
      ),
    ),
    'primary key' => array('drupal_uid'),
  );
  return $schema;
}

/**
 * Implements hook_uninstall().
 */
function picture_password_uninstall() {
  variable_del('picture_password_rp_id');
  variable_del('picture_password_rp_secret');
  variable_del('picture_password_login_button_std_label');
  variable_del('picture_password_login_button_label');
  variable_del('picture_password_debug_users');
}
