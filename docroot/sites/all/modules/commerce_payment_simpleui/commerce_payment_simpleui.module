<?php

/**
 * @file
 * Commerce Payment Simple UI module file.
 */

/**
 * Implements hook_form_FORMID_alter().
 */
function commerce_payment_simpleui_form_rules_ui_edit_element_alter(&$form, &$form_state, $form_id) {
  global $user;

  // Only hide settings for other users then administrators.
  // @TODO: Add a configuration page where one can select for what roles
  // the simplified version is enabled.
  if ($user->uid == 1 || in_array('administrator', $user->roles)) {
    return;
  }

  // @TODO: Is there a better way to find out if we're on the right Action
  // element page?
  if (!empty($form['parameter']['payment_method'])) {
    // Hide the Order data selector from Rules.
    $form['parameter']['commerce_order']['#access'] = FALSE;
    // Add our custom submit handler to be able to fix the redirect.
    $form['#submit'][] = 'commerce_payment_simpleui_form_rules_ui_edit_element_submit';
    // Set the appropriate breadcrumb.
    $breadcrumb = array();
    $breadcrumb[] = l(t('Home'), '<front>');
    $breadcrumb[] = l(t('Admin'), 'admin');
    $breadcrumb[] = l(t('Store'), 'admin/commerce');
    $breadcrumb[] = l(t('Config'), 'admin/commerce/config');
    $breadcrumb[] = l(t('Payment Methods Simple UI'), 'admin/commerce/config/payment-methods-simple-ui');
    drupal_set_breadcrumb($breadcrumb);
  }
}

/**
 * Custom submit function for rules_ui_edit_element form.
 */
function commerce_payment_simpleui_form_rules_ui_edit_element_submit(&$form, &$form_state) {
  $form_state['redirect'] = 'admin/commerce/config/payment-methods-simple-ui';
}

/**
 * Implements hook_menu().
 */
function commerce_payment_simpleui_menu() {
  $items = array();
  $items['admin/commerce/config/payment-methods-simple-ui'] = array(
    'title' => 'Payment methods Simple UI',
    'page callback' => 'commerce_payment_simpleui_page',
    'access arguments' => array('administer payment methods'),
    'file' => 'commerce_payment_simpleui.admin.inc',
  );

  return $items;
}
