<?php
/**
 * @file
 * Hook implementations and API functions for the Anki module.
 */

/**
 * Implements hook_menu().
 */
function anki_menu() {
  $items = array();
  $items['admin/config/services/anki'] = array(
    'title' => 'Anki settings',
    'description' => 'Configure basic Anki settings like the URL to the AnkiServer.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('anki_settings_form'),
    'access arguments' => array('administer anki'),
    'file' => 'anki.admin.inc',
  );
  return $items;
}

/**
 * Implements hook_permission()
 */
function anki_permission() {
  return array(
    'administer anki' => array(
      'title' => t('Administer Anki settings'),
    ),
  );
}

/**
 * Implements hook_views_api().
 */
function anki_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'anki') . '/includes/views',
    'template path' => drupal_get_path('module', 'anki') . '/templates',
  );
}

/**
 * Get the currently configured base URL of the AnkiServer's REST API.
 *
 * @return string
 *   The base URL of the AnkiServer's REST API.
 */
function anki_server_base_url() {
  return variable_get('anki_server_base_url', 'http://127.0.0.1:27701/');
}

/**
 * Get an AnkiServerConnection object.
 *
 * @param string $anki_server_base_url
 *   (optional) The base URL of the AnkiServer's REST API. If not given,
 *   it will use the currently configured URL.
 *
 * @return AnkiServerConnection
 *   An AnkiServerConnection object.
 *
 * @see AnkiServerConnection
 */
function anki_server_connection($anki_server_base_url = NULL) {
  if (empty($anki_server_base_url)) {
    $anki_server_base_url = anki_server_base_url();
  }

  return new AnkiServerConnection($anki_server_base_url);
}

/**
 * Get an AnkiServerCollection by name.
 *
 * @param string $collection_name
 *   (optional) The name of the collection. If not given, we'll use the current
 *   user's UID.
 * @param string $anki_server_base_url
 *   (optional) The base URL of the AnkiServer's REST API. If not given,
 *   it will use the currently configured URL.
 *
 * @return AnkiServerCollection
 *   An AnkiServerConnection object.
 *
 * @see AnkiServerCollection
 */
function anki_server_collection($collection_name = NULL, $anki_server_base_url = NULL) {
  global $user;

  if (empty($collection_name)) {
    $collection_name = $user->uid;
  }

  if ($connection = anki_server_connection($anki_server_base_url)) {
    return $connection->getCollection((string)$collection_name);
  }
}
