<?php

/**
 * @file
 * Intershop password module.
 */

/**
 * Implements hook_form_alter().
 */
function intershop_password_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'user_admin_settings') {
    $fieldset = array(
      '#type'  => 'fieldset',
      '#title' => t('Intershop security'),
      '#description'   => t(
        '<p><strong>Support for Intershop password has been added.</strong></p>' .
        '<p>Note: At first connexion, user\'s password will be updated to match <a href="@url">Drupal guidelines</a> which follows stronger algorithm.<br/>' .
        'This means that progressively, Intershop passwords will be replaced by Drupal passwords.</p>',
        array('@url' => 'https://api.drupal.org/api/drupal/includes%21password.inc/function/user_hash_password/7')
      ),
    );

    if ($temp = _intershop_password_array_insert_after('personalization', $form, 'intershop', $fieldset)) {
      $form = $temp;
    }
  }
}

/*
 * Inserts a new key/value after the key in the array.
 *
 * @param $key
 *   The key to insert after.
 * @param $array
 *   An array to insert in to.
 * @param $new_key
 *   The key to insert.
 * @param $new_value
 *   An value to insert.
 *
 * @return
 *   The new array if the key exists, FALSE otherwise.
 *
 * @see array_insert_before()
 */
function _intershop_password_array_insert_after($key, array &$array, $new_key, $new_value) {
  if (array_key_exists($key, $array)) {
    $new = array();
    foreach ($array as $k => $value) {
      $new[$k] = $value;
      if ($k === $key) {
        $new[$new_key] = $new_value;
      }
    }

    return $new;
  }

  return FALSE;
}
