<?php

/**
 * @file
 * Functions used by other modules to utilize external links for help pages.
 */

/**
 * Implements hook_init().
 */
function externalhelp_init() {
  // Add the CSS necessary for the External Help icon. CSS shamelessly
  // <del>stolen</del> borrowed from Advanced Help. Thanks to the maintainers.
  drupal_add_css(drupal_get_path('module', 'externalhelp') . '/help-icon.css');
}

/**
 * Implements hook_help().
 */
function externalhelp_help($path, $arg) {
  if ($path == 'admin/help#externalhelp') {
    $output['header'] = array(
      '#markup' => t('The help for the External Help module is not stored here on your local site but, in fact, external. Use the links below to learn more. Feel free to help improving the online documentation!'),
    );
    $output['links'] = array(
      '#markup' => externalhelp_list('externalhelp'),
    );
    return render($output);
  }
}

/**
 * Provides the URL for a specified help topic and a specified module.
 *
 * @param $module
 *   The module name, responsible for this external help page.
 * @param $topic
 *   The relevant help topic, as listed in the module's help page list.
 * @param $icon
 *   If TRUE, the function will return a rendered help icon linking to the
 *   external page, rather than just a URL.
 *
 * @return
 *   A url to the required help page.
 */
function externalhelp_url($module, $topic, $icon = FALSE) {
  // Get any external help already loaded on this page reqeust, and return it.
  $externalhelp_url = &drupal_static(__FUNCTION__);
  if (isset($externalhelp_url[$module][$topic]['url'])) {
    return $icon ? externalhelp_icon($externalhelp_url[$module][$topic]['url'],
      $externalhelp_url[$module][$topic]['label'])
      : $externalhelp_url[$module][$topic]['url'];
  }

  // If no external help was cached for this topic, get it and return it.
  include_once drupal_get_path('module', $module) . "/$module.externalhelp.inc";
  $externalhelp_url[$module] = module_invoke($module, 'externalhelp');

  // Make sure that the topic is available before returning the url.
  if (isset($externalhelp_url[$module][$topic]['url'])) {
    return $icon ? externalhelp_icon($externalhelp_url[$module][$topic]['url'],
      $externalhelp_url[$module][$topic]['label'])
      : url($externalhelp_url[$module][$topic]['url']);
  }

  // If the topic *still* isn't available, something is wrong. Write to the
  // watchdog and return an empty string.
  watchdog('externalhelp', 'Failed to load external help URL for module @module and topic @topic.',
    array('@module' => $module, '@topic' => $topic), WATCHDOG_WARNING);
  return url('');
}

/**
 * Quick help function to create a linked help icon from a url.
 *
 * @param $path
 *   The path the help icon should link to.
 * @param $text
 *   Any text used for alt and title attributes.
 *
 * @return
 *   A rendered, linked help icon.
 */
function externalhelp_icon($path, $text) {
  $variables = array(
    'path' => $path,
    'options' => array(
      'html' => FALSE,
      'attributes' => array(
        'class' => 'externalhelp-icon',
        'alt' => $text,
        'title' => $text,
      ),
    ),
  );
  return theme('link', $variables);
}

/**
 * Provides a list of all external help pages defined by a module.
 *
 * @param $module
 *   The module listing external help pages.
 *
 * @return
 *   A string of rendered output, as expected on Drupal help pages.
 */
function externalhelp_list($module) {
  // Load the required list of external help pages.
  include_once drupal_get_path('module', $module) . "/$module.externalhelp.inc";
  $externalhelp_list = module_invoke($module, 'externalhelp');

  // Build the list of help pages as links.
  $link_list = array();
  foreach ($externalhelp_list as $topic) {
    $link_list[] = l($topic['label'], $topic['url']);
  }
  $output = array(
    '#markup' => theme('item_list', array('items' => $link_list)),
  );

  // Sorry for returning a string of output rather than a renderable array.
  // Apparently, this is how core wants it.
  return render($output);
}
