<?php

/**
 * @file
 *  The install and uninstall logic for the FreshBooks module.
 *
 * @author Guy Paddock (guy.paddock@redbottledesign.com)
 * @author Xavier L. (xavier@openconcept.ca)
 */
require_once('freshbooks.constants.inc');

/**
 * Implementation of hook_requirements().
 *
 * Makes sure that the FreshBooks-PHP library is installed properly, and that the user has configured the API URL
 * and token.
 */
function freshbooks_requirements($phase) {
  $requirements = array();

  /* Can't check requirements at install time because "Libraries API" might not
   * be available yet (it could be installed at the same time as this module).
   */
  if ($phase == 'runtime') {
    $libraryStatus = ($library = libraries_detect(FRESHBOOKS_LIBRARY_NAME)) && $library['installed'] == TRUE;

    $requirements['freshbooks_library'] = array(
      'title' => t('FreshBooks API library'),
      'value' => ($libraryStatus) ? t('Installed') : $library['error message'],
      'severity' => ($libraryStatus) ? REQUIREMENT_OK : REQUIREMENT_ERROR,
      'description' => ($libraryStatus) ? NULL :
        t('The FreshBooks-API library needs to be installed. Please see the <a href="@url">FreshBooks module documentation</a> for information on how to correct this.',
          // TODO: Update documentation URL
          array('@url' => 'http://www.drupal.org/project/freshbooks/')),
    );
  }

  $configStatus = (variable_get(FRESHBOOKS_VAR_DOMAIN, NULL) == NULL) || (variable_get(FRESHBOOKS_VAR_TOKEN, NULL) == NULL);

  $requirements['freshbooks_config'] = array(
    'title' => t('FreshBooks API configuration'),
    'value' => ($configStatus) ? t('Not configured properly') : t('Fully configured'),
    'severity' => ($configStatus) ? REQUIREMENT_WARNING : REQUIREMENT_OK,
    'description' => ($configStatus) ?
      t('The FreshBooks module requires the FreshBooks API domain and authorization token to be provided. They can be set from the !configPage.',
        array('!configPage' => l('FreshBooks settings page', FRESHBOOKS_PATH_SETTINGS)))
      : NULL,
  );


  return $requirements;
}

/**
 * Implementation of hook_uninstall().
 *
 * Cleans-up any settings variables that may have been set by the FreshBooks settings page.
 */
function freshbooks_uninstall() {
  variable_del(FRESHBOOKS_VAR_DOMAIN);
  variable_del(FRESHBOOKS_VAR_TOKEN);
}
