<?php
/**
 * @file
 * Modify views query preventing it from returning
 * the same result set within multiple runs.
 */

/**
 * Implements hook_views_api().
 */
function views_result_once_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'views_result_once') . '/includes',
  );
}

/**
 * Implements hook_views_query_alter().
 */
function views_result_once_views_query_alter(&$view, &$query) {
  $views_display_name = $view->name . ':' . $view->current_display;
  if (in_array($views_display_name, variable_get('views_result_once_views', array()))) {
    $join = new views_join();
    $join->construct('views_result_once', $view->base_table, $view->base_field, 'rid', array(
      array(
        'table' => 'views_result_once',
        'field' => 'view_name',
        'value' => $views_display_name,
      ),
      array(
        'table' => 'views_result_once',
        'field' => 'sid',
        'value' => 0,
      ),
    ));
    drupal_alter('views_result_once_join', $join, clone $view);
    $views_result_once_alias = $query->add_table('views_result_once', NULL, $join);
    $query->add_where(0, "{$views_result_once_alias}.rid");
  }
}

/**
 * Implements hook_views_post_execute().
 */
function views_result_once_views_post_execute(&$view) {
  $views_display_name = $view->name . ':' . $view->current_display;
  if (in_array($views_display_name, variable_get('views_result_once_views', array()))) {
    foreach ($view->result as $result) {
      $record = array(
        'rid' => $result->{$view->base_field},
        'sid' => 0,
        'view_name' => $views_display_name,
      );
      drupal_alter('views_result_once_record', $record, clone $view);
      db_merge('views_result_once')
        ->key($record)
        ->fields($record + array('created' => REQUEST_TIME))
        ->execute();
    }
  }
}

/**
 * Implements hook_menu().
 */
function views_result_once_menu() {
  $items = array();
  $items['admin/config/content/views-result-once'] = array(
    'title' => 'Views Once',
    'access arguments' => array('administer site configuration'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('views_result_once_page_admin'),
  );
  return $items;
}

/**
 * Admin page for views admin.
 */
function views_result_once_page_admin() {
  $form = array();
  $form['views_result_once_views'] = array(
    '#type' => 'select',
    '#multiple' => TRUE,
    '#size' => 15,
    '#options' => views_result_once_views_displays_names_get(),
    '#default_value' => variable_get('views_result_once_views', array()),
    '#title' => 'Views names',
    '#description' => t('Select which views to apply %views_result_once functionality.', array('%views_result_once' => 'Views Once')),
  );

  return system_settings_form($form);
}

/**
 * Generate list of View:Display names in appropriate format.
 */
function views_result_once_views_displays_names_get() {
  $views = views_get_all_views();
  $names = array();
  foreach ($views as $view) {
    foreach ($view->display as $display) {
      $names[$view->name . ':' . $display->id] = $view->human_name . ': ' . $display->display_title;
    }
  }
  return $names;
}
