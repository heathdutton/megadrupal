<?php

/**
 * Implements hook_element_info_alter().
 */
function refine_number_element_info_alter(&$types) {
  if (!empty($types['textfield']['#input'])) {
    $types['textfield']['#process'][] = '_refine_number_element_process';
  }
}

/**
 * Process element rules and filters.
 */
function _refine_number_element_process($element, &$form_state) {
  if (isset($element['#number_type'])) {
    if ($element['#number_type'] == 'integer' || $element['#number_type'] == 'decimal' || $element['#number_type'] == 'float') {
      $element_validate = empty($element['#element_validate']) ? array() : $element['#element_validate'];
     $element['#element_validate'] = array_merge(array('_refine_number_validate'), $element_validate);
    }
  }
  return $element;
}

function _refine_number_validate(&$element, &$form_state, $form) {
  $field = field_widget_field($element, $form_state);
  $decimal_separator = '';
  if (isset($field['settings']['decimal_separator'])) {
    $decimal_separator = $field['settings']['decimal_separator'];
  }
  $value = $element['#value'];
  $value = str_replace(',', '.', $value);
  $value = preg_replace('/[^-+0-9.]/u', '', $value);
  $last = strrpos($value, '.');
  if ($last !== FALSE) {
    $whole = str_replace('.', '', substr($value, 0, $last));
    $fraction = substr($value, $last + 1);
    if ($decimal_separator != '') {
      if ($whole == '') {
        $whole = '0';
      }
      if ($fraction == '') {
        $fraction = '0';
      }
    }
    $value = $whole . $decimal_separator . $fraction;
  }
  $element['#value'] = $value;
}
