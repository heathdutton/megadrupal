<?php
/**
 * @file
 * Installation function for XC Authentication module
 *
 * @copyright (c) 2010-2011 eXtensible Catalog Organization
 */

/**
 * Implements hook_intall().
 */
function xc_auth_install() {
  variable_set('xc_auth_override_usernames', 1);
  variable_set('xc_auth_truncate_long_usernames', 0);
  variable_set('xc_auth_authenticate_by_auth_type_perm', 0);
  variable_set('xc_auth_authenticate_by_method_perm', 0);
}

/**
 * Implements hook_uninstall().
 */
function xc_auth_uninstall() {
  variable_del('xc_auth_override_usernames');
  variable_del('xc_auth_truncate_long_usernames');
  variable_del('xc_auth_authenticate_by_auth_type_perm');
  variable_del('xc_auth_authenticate_by_method_perm');
}

/**
 * Implements hook_disable().
 */
function xc_auth_disable() {
  unset($_SESSION['xc_auth_user']);
}

/**
 * Implements hook_schema().
 */
function xc_auth_schema() {
  $schema['xc_auth_user'] = array(
    'fields' => array(
      'uid' => array(
        'type' => 'int',
        'description' => 'Drupal user primary identifier',
        'not null' => TRUE,
      ),
      'tid' => array(
        'type' => 'int',
        'description' => 'Authentication type primary identifier',
        'not null' => TRUE,
      ),
      'identity' => array(
        'type' => 'varchar',
        'description' => 'Drupal username and primary identifier for user',
        'length' => 128,
        'not null' => TRUE,
      ),
      'stored_values' => array(
        'type' => 'text',
        'description' => 'Array of values for credentials that are safe to store',
        'size' => 'medium',
        'not null' => TRUE,
      ),
    ),
    'unique keys' => array(
      'uid_tid' => array('uid', 'tid'),
      'tid_identity' => array('tid', 'identity'),
    ),
    'indexes' => array(
      'uid_identity' => array('uid', 'identity'),
      'tid_uid' => array('tid', 'uid'),
    ),
  );

  $schema['xc_auth_type'] = array(
    'fields' => array(
      'tid' => array(
        'type' => 'serial',
        'description' => 'Authentication type primary identifier',
        'not null' => TRUE,
      ),
      'method' => array(
        'type' => 'varchar',
        'description' => 'Authentication method used for this type of authentication',
        'length' => 32,
        'not null' => TRUE,
      ),
      'name' => array(
        'type' => 'varchar',
        'descriptoin' => 'Authentication method name',
        'length' => 128,
        'not null' => TRUE,
      ),
      'description' => array(
        'type' => 'text',
        'description' => 'Authentication method description',
        'not null' => TRUE,
      ),
      'data' => array(
        'type' => 'text',
        'description' => 'Additional authenitcation method-specific settings and variables',
        'size' => 'big',
        'not null' => TRUE,
      ),
      'reset_password_text' => array(
        'type' => 'text',
        'description' => 'Text or HTML to display in lost/forgotten password reset section of the login form',
        'size' => 'medium',
        'not null' => TRUE,
      ),
      'help_text' => array(
        'type' => 'text',
        'description' => 'Text or HTML to display in an additional help section of the login form',
        'size' => 'medium',
        'not null' => TRUE,
      ),
      'login_success_text' => array(
        'type' => 'text',
        'description' => 'Text or HTML to display when login information is successful',
        'size' => 'medium',
        'not null' => TRUE,
      ),
      'login_incorrect_text' => array(
        'type' => 'text',
        'description' => 'Text or HTML to display when login information is incorrect',
        'size' => 'medium',
        'not null' => TRUE,
      ),
      'login_failure_text' => array(
        'type' => 'text',
        'description' => 'Text or HTML to display when login has failed',
        'size' => 'medium',
        'not null' => TRUE,
      ),
      'roles' => array(
        'type' => 'text',
        'description' => 'Roles to assign to user upon successful initial registration',
        'size' => 'medium',
        'not null' => TRUE,
      ),
      'credentials' => array(
        'type' => 'text',
        'description' => 'Labels and descriptions for login form credentials',
        'size' => 'medium',
        'not null' => TRUE,
      ),
      'login_text' => array(
        'type' => 'varchar',
        'description' => 'Login form submit button text',
        'length' => 32,
        'not null' => TRUE,
      ),
      'logout_text' => array(
        'type' => 'varchar',
        'description' => 'Logout form submit button text',
        'length' => 32,
        'not null' => TRUE,
      ),
      'auto_load_values' => array(
        'type' => 'int',
        'description' => 'Whether to automatically load safe to store values of credentials',
        'default' => 1,
        'size' => 'tiny',
        'not null' => TRUE,
      ),
      'auto_create_account' => array(
        'type' => 'int',
        'description' => 'Whether to automatically create new accounts during a users first login',
        'default' => 1,
        'size' => 'tiny',
        'not null' => TRUE,
      ),
      'weight' => array(
        'type' => 'int',
        'description' => 'Weight of type - used in sorting.',
        'not null' => TRUE,
        'default' => 0,
        'size' => 'tiny',
      ),
    ),
    'primary key' => array('tid'),
    'indexes' => array(
      'method' => array('method'),
    ),
  );

  $schema['xc_auth_login_block'] = array(
    'fields' => array(
      'login_block_id' => array(
        'type' => 'serial',
        'description' => 'Login block primary identifier',
        'not null' => TRUE,
      ),
      'type' => array(
        'type' => 'varchar',
        'descriptoin' => 'Login block type',
        'length' => 128,
        'not null' => TRUE,
      ),
      'name' => array(
        'type' => 'varchar',
        'descriptoin' => 'Login block name',
        'length' => 128,
        'not null' => TRUE,
      ),
      'description' => array(
        'type' => 'text',
        'description' => 'Login block description',
        'not null' => TRUE,
      ),
      'url' => array(
        'type' => 'text',
        'description' => 'URL for login page',
        'size' => 'small',
        'not null' => TRUE,
      ),
      'data' => array(
        'type' => 'text',
        'description' => 'Additional login block-specific settings and variables',
        'size' => 'big',
        'not null' => TRUE,
      ),
    ),
    'primary key' => array('login_block_id'),
    'indexes' => array(
      'type' => array('type'),
    ),
  );

  return $schema;
}
