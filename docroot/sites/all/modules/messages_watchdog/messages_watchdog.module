<?php
/**
 * @file messages_watchdog.module
 * Logs all site messages via watchdog.
 */


/**
 * Implements hook_theme_registry_alter().
 *
 * This is used to provide a default callback function for theming keymatches.
 *
 * @see messages_watchdog_status_messages().
 */
function messages_watchdog_theme_registry_alter(&$theme_registry) {
  $theme_registry['status_messages']['function'] = 'messages_watchdog_status_messages';
}


/**
 * Logs all site messages via watchdog.
 *
 * Ignores messages beginning with Notice, Error, and Warning, since those are
 *   most likely already logged via watchdog.
 */
function messages_watchdog_status_messages($variables) {
  $display = $variables['display'];

  $severities = array(
    'warning' => WATCHDOG_WARNING,
    'status' => WATCHDOG_NOTICE,
    'error' => WATCHDOG_ERROR,
  );

  foreach (drupal_get_messages($display, FALSE) as $type => $messages) {
    foreach ($messages as $message) {
      if (preg_match('/^<em class="placeholder">(Notice|Error|Warning)<\/em>:/', $message) === 0) {
        $severity = isset($severities[$type]) ? $severities[$type] : WATCHDOG_NOTICE;
        watchdog('messages', $message, NULL, $severity);
      }
    }
  }

  return theme_status_messages($variables);
}
