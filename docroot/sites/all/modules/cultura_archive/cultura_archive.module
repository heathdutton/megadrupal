<?php

/**
 * @file
 * Cultura questionnaire creation and answer aggregation for students
 * participating in a Cultura Exchange.
 */

/**
 * Define a constant for Host school field.
 */
define('CULTURA_HOST_SCHOOL', 'cultura_host_school');

/**
 * Define a constant for the discussion answers field.
 */
define('CULTURA_GUEST_SCHOOL', 'cultura_guest_school');

/**
 * Define a constant for a Cultura schools vocabulary machine name.
 */
define('CULTURA_SCHOOLS', 'cultura_schools');

/**
 * Define a constant for a Cultura year vocabulary machine name.
 */
define('CULTURA_YEAR', 'cultura_year');

/**
 * Define a constant for a Cultura semester vocabulary machine name.
 */
define('CULTURA_SEMESTER', 'cultura_semester');

/**
 * Define a constant for the discussion's host school language.
 */
define('CULTURA_HOST_LANGUAGE', 'cultura_host_language');

/**
 * Define a constant for the discussion's host school language.
 */
define('CULTURA_GUEST_LANGUAGE', 'cultura_guest_language');

/**
 * Define a constant for the discussion's host school language.
 */
define('CULTURA_LANGUAGES', 'cultura_languages');

/**
 * Implements hook_views_api().
 */
function cultura_archive_views_api($module, $api) {
  if ($module == 'views' && $api == 'views_default') {
    return array('version' => 3);
  }
}

/**
 * Implements hook_views_data_alter().
 */
function cultura_archive_views_data_alter(&$data) {
  $taxonomy_term_fields = array(
    'cultura_host_school',
    'cultura_guest_school',
    'cultura_host_language',
    'cultura_guest_language',
    'cultura_semester',
    'cultura_year',
  );
  foreach ($taxonomy_term_fields as $field) {
    $data['field_data_' . $field][$field]['field']['handler'] = 'cultura_archive_views_handler_field_term_path';
  }
}

/**
 * Implements hook_node_view_alter().
 */
function cultura_archive_node_view_alter(&$build) {
  if ($build['#bundle'] == CULTURA_DISCUSSION_NODE_TYPE && $build['#view_mode'] == 'full') {
    $node = &$build['#node'];
    $year = cultura_archive_term($node, CULTURA_YEAR);
    $semester = cultura_archive_term($node, CULTURA_SEMESTER);
    $host = cultura_archive_term($node, CULTURA_HOST_SCHOOL);
    $guest = cultura_archive_term($node, CULTURA_GUEST_SCHOOL);
    $topic = cultura_archive_term($node, CULTURA_QUESTIONNAIRE_FIELD_QUESTION_TYPE);
    $breadcrumb = drupal_get_breadcrumb();
    $title = $node->title . ' | ';
    $breadcrumb[] = l('Cultura Exchanges', 'cultura-exchanges-archive');
    $path = 'cultura-exchanges';
    if ($year) {
      $path .= '/year/';
      $breadcrumb[] = cultura_archive_breadcrumb_link($year, $path);
      $title .= $year->name;
    }
    if ($semester) {
      $path .= '/semester/';
      $breadcrumb[] = cultura_archive_breadcrumb_link($semester, $path);
      $title .= ' ' . $semester->name;
    }
    if ($host) {
      $path .= '/host/';
      $breadcrumb[] = cultura_archive_breadcrumb_link($host, $path);
      $title .= ' ' . $host->name;
    }
    if ($guest) {
      $path .= '/guest/';
      $breadcrumb[] = cultura_archive_breadcrumb_link($guest, $path);
      $title .= '/' . $guest->name;
    }
    if ($topic) {
      $breadcrumb[] = l($topic->name, $path);
    }
    $title .= ' | Cultura';
    drupal_set_breadcrumb($breadcrumb);
    cultura_archive_page_title($title);
  }
}

/**
 * Implement hook_preprocess_html().
 */
function cultura_archive_preprocess_html(&$vars) {
  if (cultura_archive_page_title()) {
    $vars['head_title'] = cultura_archive_page_title();
  }
}

/**
 * Helper function to load the taxonomy term for a given field.
 */
function cultura_archive_term($node, $field) {
    $items = field_get_items('node', $node, $field);
    if ($items) {
      return taxonomy_term_load($items[0]['tid']);
    }
    else {
      return FALSE;
    }
}

/**
 * Helper function to make a link in the breadcrumb chain out of a term.
 */
function cultura_archive_breadcrumb_link($term, &$path) {
  module_load_include('inc', 'pathauto');
  $path .= pathauto_cleanstring($term->name);
  return l($term->name, $path);
}

/**
 * Simple setter and getter for page title within a single page load.
 */
function cultura_archive_page_title($new_title = '') {
  static $title;
  if ($new_title) {
    $title = $new_title;
  }
  return $title;
}
