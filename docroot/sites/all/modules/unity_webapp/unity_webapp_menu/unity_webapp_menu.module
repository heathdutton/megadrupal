<?php
/**
 * @file
 * Submodule which generates links for unity_hud from menu_tree_all_data.
 */

/**
 * Walk through menu_tree and find the links.
 *
 * @param object $tree
 *  Menutree to parse.
 *
 * @return array
 *  Array with links.
 */
function unity_webapp_menu_walk($tree, $parent=null) {
  if (empty($tree)) {
    return array();
  }
  $processedlink = array();
  foreach ($tree as $obj) {
    if ($obj['link'] && $obj['link']['link_title']) {
      if ($parent) {
        $link_title = $parent . "/" . $obj['link']['link_title'];
      }
      else {
        $link_title = $obj['link']['link_title'];
      }
      $processedlink['name'] = $link_title;
      $processedlink['href'] = "/" . url($obj['link']['href']);
      $links[] = $processedlink;
      if ($obj['below']) {
        $links = array_merge($links, unity_webapp_menu_walk($obj['below'],$link_title));
      }
    }
  }
  return $links;
}

/**
 * Add overlay to all links in links array
 *
 * @param object $links
 */
function unity_webapp_menu_add_overlay(&$links) {
  foreach ($links as &$link) {
    $link['href'] = ltrim($link['href'], "/");
    $link['href'] = '/#overlay=' . $link['href'];
  }
}

/**
 * Implements hook_unityapi_addlinks().
 *
 * @return array
 *  Array with links.
 */
function unity_webapp_menu_unity_webapp_addlinks() {
  // TOOD: decide if that permission should be checked here
  if (! user_access('access administration pages')) {
    return (array());
  }

  // Todo: evaluate more menus
  // dsm(menu_get_names());

  $links = array();
  $management_links = unity_webapp_menu_walk(menu_tree_all_data("management"));

  // As these links are all "management" they should be opened in overlay
  if (module_exists("overlay")) {
    unity_webapp_menu_add_overlay($management_links);
  }

  $user_links =  unity_webapp_menu_walk(menu_tree_all_data("user-menu"));
  $nav_links =  unity_webapp_menu_walk(menu_tree_all_data("navigation"));
  $main_links =  unity_webapp_menu_walk(menu_tree_all_data("main-menu"));
  $links = array_merge($nav_links, $management_links, $user_links, $main_links);
  return $links;
}
