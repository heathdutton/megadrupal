<?php
/**
 * @file
 * Defines Widget filter.
 */

/**
 * Implements hook_wysiwyg_include_directory().
 */
function wysiwyg_widget_wysiwyg_include_directory($type) {
  switch ($type) {
    case 'plugins':
      return $type;
  }
}

/**
 * Implements hook_filter_info().
 */
function wysiwyg_widget_filter_info() {
  return array(
    'widget_embed' => array(
      'title' => t('Widget embed'),
      'process callback' => '_wysiwyg_widget_embed_filter',
      // Needs to be after any filter that limits html tags.
      'weight' => 50,
    )
  );
}

/**
 * Callback for hook_filter_info().
 */
function _wysiwyg_widget_embed_filter($text, $filter, $format, $langcode, $cache, $cache_id) {
  return preg_replace_callback(
    '|<!--widget_embed:(.*?)-->|si',
    function ($matches) {
      return rawurldecode(($matches[1]));
    },
    $text
  );
}
