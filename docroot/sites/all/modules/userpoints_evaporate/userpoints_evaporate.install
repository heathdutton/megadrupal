<?php
/**
 * Implementation of hook_install()
 *
 * Add a term to the userpoints vocabulary.
 */
function userpoints_evaporate_install() {
  $vid = variable_get(USERPOINTS_CATEGORY_DEFAULT_VID, '');

  if (!empty($vid)) {
    $term = new stdClass();
    $term->vid = $vid;
    $term->name = 'Evaporate';
    $term->description = 'This term is assigned to transactions generated by the userpoints_evaporate module.';

    taxonomy_term_save($term);
    variable_set('userpoints_evaporate_tid', $term->tid);
  }
}

/**
 * Implementation of hook_uninstall()
 *
 * Cleanup the variables table.
 *
 * This does not drop the term that was added during install!
 */
function userpoints_evaporate_uninstall() {
  db_delete('variable')
    ->condition('name', 'userpoints_evaporate%', 'LIKE')
    ->execute();
}

/* Update 7001 is not required. */

/**
 * Update the combined per-user totals.
 */
function userpoints_evaporate_update_7002() {
  variable_del('userpoints_evaporate_vid');

  // Fix the points total as it is displayed on the user's points tab.
  db_query("UPDATE {userpoints_total} AS t SET points = (SELECT SUM(points) FROM {userpoints} AS u WHERE u.uid = t.uid)");
}

/**
 * Add a default OFF setting for nonegative on each userpoints category.
 */
function userpoints_evaporate_update_7003() {
  $terms = userpoints_get_categories();
  $settings = variable_get('userpoints_evaporate', array());

  foreach ($terms as $tid => $term) {
    $settings[$tid]['nonegative'] = FALSE;
  }

  // Store the update settings.
  variable_set('userpoints_evaporate', $settings);

  // Tell the user what we did.
  $translation = userpoints_translation();
  $translation['!module'] = l(st('Userpoints Evaporate settings'), 'admin/config/people/userpoints/evaporate');
  drupal_set_message(st('A new <em>No Negative</em> setting was added for each !points category. This setting defaults to FALSE, allowing !points totals to become negative. Please review your !module now.', $translation), 'warning');
}
