<?php
/**
 * @file
 * This file is the main module file for creating test skeleton.
 */

/**
 * Implements hook_help().
 */
function sn_simpletest_plus_help($path, $arg) {
  switch ($path) {
    case 'admin/help#sn_simpletest_plus_test':
      $output = '<p>' . t('The SN Add Simpletest module for adding simpletest in available modules') . '</p>';
      return $output;
  }
}

/**
 * Implements hook_permission().
 */
function sn_simpletest_plus_permission() {
  return array(
    'administer sn_simpletest_plus_test' => array(
      'title' => t('Administer SN Add Simple Test'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function sn_simpletest_plus_menu() {
  $items = array();

  $items['admin/config/system/add-simple-test/modules-list'] = array(
    'title' => 'Generate Test Case for Modules.',
    'description' => 'List of modules for adding simpletest.',
    'page callback' => 'sn_simpletest_plus_modules_selection',
    'access arguments' => array('administer sn_simpletest_plus_test'),
  );

  $items['admin/config/create-simpletest/%'] = array(
    'title' => 'Create Simpletest For Module',
    'description' => 'Create simpletest for selected module.',
    'page callback' => 'sn_simpletest_plus_for_modules',
    'page arguments' => array(3),
    'file' => 'sn_simpletest_plus_create_test.admin.inc',
    'access arguments' => array('administer sn_simpletest_plus_test'),
  );

  return $items;
}

/**
 * Table of module selection for test creation.
 */
function sn_simpletest_plus_modules_selection() {
  // Get the modules.
  $sql = "SELECT name, filename, type, status FROM {system} WHERE type='module' ORDER BY weight ASC, filename ASC";
  $result = db_query($sql);

  foreach ($result as $system) {
    $module_path = drupal_get_path('module', $system->name);
    $module_directory = is_dir($module_path) ? scandir($module_path) : '';
    if (isset($module_directory) && is_array($module_directory)) { 
      if (!in_array('tests', $module_directory)) {
        $system_links[$system->name] = $system->name;
      }
    }
  }

  asort($system_links);

  // Modules list for test creation.
  $module_name = array();
  foreach ($system_links as $key => $value) {
    $module_name[] = array('module' => $value, 'link' => l('Create Test Skeleton', 'admin/config/create-simpletest/' . $value));
  }

  $table = theme('table',
        array('header' => array('Module Name', 'Link'),
          'rows' => $module_name,
          'caption' => 'Module List'));

  return $table;
}

/**
 * Function for adding test file and updating info file.
 *
 * @param string $module_name
 *   Module name in string format.
 */
function sn_simpletest_plus_for_modules($module_name) {
  // Preparing modules.
  $module_abs_path = sn_simpletest_plus_module_abs_path($module_name);
  // Modifying .info file to read test cases.
  sn_simpletest_plus_edit_info_file($module_abs_path, $module_name);
  // Creating module.test file.
  sn_simpletest_plus_create_test_file($module_abs_path, $module_name);
}

/**
 * Function for getting absolute path for module.
 *
 * @param string $module_name
 *   Module name in string format.
 *
 * @return
 *   Root Directory
 */
function sn_simpletest_plus_module_abs_path($module_name) {
  $module_path = drupal_get_path('module', $module_name);
  // Preparing modules.
  return DRUPAL_ROOT . DIRECTORY_SEPARATOR . $module_path;
}
