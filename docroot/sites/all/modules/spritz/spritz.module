<?php

/**
 * @file spritz.module
 */

/**
 * Implements hook_menu().
 */
function spritz_menu() {
  $items = array();

  $items['admin/config/services/spritz'] = array(
    'title' => 'Spritz settings',
    'description' => t('Settings for interacting with the Spritz SDK'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('spritz_admin_form'),
    'access arguments' => array('administer site configuration'),
    'file' => 'spritz.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_field_formatter_info().
 */
function spritz_field_formatter_info() {
  return array(
    'spritz' => array(
      'label' => t('Spritz'),
      'field types' => array('text', 'text_long', 'text_with_summary'),
    ),
  );
}

/**
 * Implements hook_field_formatter_view().
 */
function spritz_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  $element = array();

  switch ($display['type']) {
    case 'spritz':
      foreach ($items as $delta => $item) {
        $element[$delta] = array(
          '#theme' => 'spritz',
          '#id' => $delta,
          '#content' => $item['value'],
        );
      }
      break;
  }

  return $element;
}

/**
 * Implements hook_theme().
 */
function spritz_theme() {
  return array(
    'spritz' => array(
      'variables' => array(
        'id' => NULL,
        'content' => NULL,
      ),
      'template' => 'spritz',
    ),
  );
}

/**
 * Returns HTML for the Spritz field formatter.
 */
function template_preprocess_spritz(&$variables) {
  // Add our stylesheet.
  drupal_add_css(drupal_get_path('module', 'spritz') . '/spritz.css');

  // Set our unique Spritz Client ID and required redirect URL for successful logins.
  $clientId = variable_get('spritz_client_id');
  $redirectUri = url(drupal_get_path('module', 'spritz') . '/includes/login_success.html', array('absolute' => TRUE));
  drupal_add_js("var SpritzSettings = { clientId: '$clientId', redirectUri: '$redirectUri' };", 'inline');

  // Include the Spritz Javascript SDK.
  drupal_add_js('http://sdk.spritzinc.com/js/1.0/js/spritz.min.js', 'external');

  // Ensure a unique ID is added to each spritzer on the page.
  $variables['id'] = 'spritzer' . $variables['id'];
}

