<?php

/**
 * @file
 * Expose the OSF Query Builder in OSF for Drupal
 */ 

function osf_querybuilder_menu() {
  $items = array();
     
  $items['osf/querybuilder'] = array(
    'page callback' => 'osf_querybuilder_main',
    'access arguments' => array('access osf query builder'),
    'type' => MENU_CALLBACK,
  );
  
  $items['osf/querybuilder/frame'] = array(
    'page callback' => 'osf_querybuilder_frame',
    'access arguments' => array('access osf query builder'),
    'type' => MENU_CALLBACK,
  );
  
  $items['osf/querybuilder/save/search/profile'] = array(
    'page callback' => 'osf_querybuilder_save_search_profile',
    'access arguments' => array('access osf query builder'),
    'type' => MENU_CALLBACK,
  );
  
  return($items); 
}

function osf_querybuilder_save_search_profile()
{
  $name = $_POST['name'];

  if(db_query('SELECT * FROM {osf_searchprofiles} WHERE name = :name LIMIT 1', array(':name' => $name))->fetchField())
  {
    header("HTTP/1.1 400 Bad Request");
    die('{
           "error": "'.t('A search profile with tha name already exists').'"
         }');    
  }
  else
  {
    db_insert('osf_searchprofiles')
          ->fields(array(
            'name' => $name,
            'description' => $name,
            'settings' => serialize(drupal_json_decode($_POST['json_profile'])),
          ))
          ->execute(); 
    
    die('{
           "success": "'.t('Search profile successfully saved').'"
         }');    
  }
}
 
/**
* implements hook_permission()
*/
function osf_querybuilder_permission()
{
  return array(
    'access osf query builder' => array(
      'title' => t('Access OSF Query Builder'),
      'description' => t('Enable a user to access the Query Builder. This is essential if the user wants to create Search Profiles'),
    )
  );
}

function osf_querybuilder_main() { 
  return('<iframe src="'.$base_url.'/osf/querybuilder/frame" width="1000px" height="3000px" frameborder="0"></iframe> ');
}


function osf_querybuilder_frame() { 
  global $base_url;
  
  $html = '<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
           <html>
             <head>';
  
  $html .= '<link rel="stylesheet" type="text/css" href="'.$base_url.'/'.drupal_get_path('module', 'osf_querybuilder') . '/css/qb.css">'."\n";  
  $html .= '<link rel="stylesheet" type="text/css" href="'.$base_url.'/'.drupal_get_path('module', 'osf_querybuilder') . '/css/jquery.multiselect.css">'."\n";  
  $html .= '<link rel="stylesheet" type="text/css" href="'.$base_url.'/'.drupal_get_path('module', 'osf_querybuilder') . '/css/jquery.multiselect.filter.css">'."\n";  
  $html .= '<link rel="stylesheet" type="text/css" href="'.$base_url.'/'.drupal_get_path('module', 'osf_querybuilder') . '/css/ui-lightness/jquery-ui-1.10.0.custom.min.css">'."\n";  
  $html .= '<link rel="stylesheet" type="text/css" href="'.$base_url.'/'.drupal_get_path('module', 'osf_querybuilder') . '/doc/css/style.css">'."\n";  
  $html .= '<link rel="stylesheet" type="text/css" href="'.$base_url.'/'.drupal_get_path('module', 'osf_querybuilder') . '/css/simplePagination.css">'."\n";  
  $html .= '<link rel="stylesheet" type="text/css" href="'.$base_url.'/'.drupal_get_path('module', 'osf_querybuilder') . '/css/prettify.css">'."\n";  

  $html .= '<script type="text/javascript" src="'.$base_url.'/'.drupal_get_path('module', 'osf_querybuilder') . '/js/jquery-1.9.0.js"></script>'."\n";
  $html .= '<script type="text/javascript" src="'.$base_url.'/'.drupal_get_path('module', 'osf_querybuilder') . '/js/jquery-ui-1.10.0.custom.min.js"></script>'."\n";
  $html .= '<script type="text/javascript" src="'.$base_url.'/'.drupal_get_path('module', 'osf_querybuilder') . '/js/qb.js"></script>'."\n";
  $html .= '<script type="text/javascript" src="'.$base_url.'/'.drupal_get_path('module', 'osf_querybuilder') . '/js/schema.js"></script>'."\n";
  $html .= '<script type="text/javascript" src="'.$base_url.'/'.drupal_get_path('module', 'osf_querybuilder') . '/js/resultset.js"></script>'."\n";
  $html .= '<script type="text/javascript" src="'.$base_url.'/'.drupal_get_path('module', 'osf_querybuilder') . '/js/ui.combobox.js"></script>'."\n";
  $html .= '<script type="text/javascript" src="'.$base_url.'/'.drupal_get_path('module', 'osf_querybuilder') . '/js/jquery.md5.js"></script>'."\n";
  $html .= '<script type="text/javascript" src="'.$base_url.'/'.drupal_get_path('module', 'osf_querybuilder') . '/js/jquery.multiselect.min.js"></script>'."\n";
  $html .= '<script type="text/javascript" src="'.$base_url.'/'.drupal_get_path('module', 'osf_querybuilder') . '/js/jquery.multiselect.filter.min.js"></script>'."\n";
  $html .= '<script type="text/javascript" src="'.$base_url.'/'.drupal_get_path('module', 'osf_querybuilder') . '/js/jquery.simplePagination.js"></script>'."\n";
  $html .= '<script type="text/javascript" src="'.$base_url.'/'.drupal_get_path('module', 'osf_querybuilder') . '/js/prettify.js"></script>'."\n";
  $html .= '<script type="text/javascript" src="'.$base_url.'/'.drupal_get_path('module', 'osf_querybuilder') . '/js/jquery.enhanced.cookie.js"></script>'."\n";

  $cacheFolder = variable_get("osf_OntologySettings_ontologies_ironjson_cache_folder", "/tmp/");
  
  $schemasToLoad = '';
  
  if($handle = opendir($cacheFolder)) 
  {
    while(false !== ($entry = readdir($handle))) 
    {
      if(substr($entry, -3) === '.js')
      {
        $file = str_replace($cacheFolder, '', $entry);
        
        $html .= '<script type="text/javascript" src="'.$base_url. str_replace('/usr/share/drupal', '', $cacheFolder) . $file.'"></script>'."\n";
        
        if($file != 'schema.js')
        {
          $schemasToLoad .= 'schemas.push('.str_replace('.js', '', $file).'_schema);'."\n";
        }
      }        
    }    
  }
  
  $namespacesToLoad = '';
  
  foreach(osf_entities_rdf_namespaces() as $prefix => $namespace)
  {
    $namespacesToLoad .= "'$prefix': '$namespace',\n";
  }
  
  $defaultEndpoint = current(osf_configure_get_default_endpoint());

  $html .= '<script>
      jQuery(function() {
      
        jQuery( "#accordion" ).accordion({
          collapsible: true,
          active: 0,
          heightStyle: "content"
        });
        
        jQuery("#search-button-top").button();
        jQuery("#clear-button-top").button();
        jQuery("#search-button-adv-section").button();
        jQuery("#clear-button-adv-section").button();
        jQuery("#search-button-restriction-section").button();
        jQuery("#clear-button-restriction-section").button();
        jQuery("#search-button-other-options-section").button();
        jQuery("#clear-button-other-options-section").button();
        jQuery("#search-button-phrase-section").button();
        jQuery("#clear-button-phrase-section").button();
        jQuery("#search-button-score-section").button();
        jQuery("#clear-button-score-section").button();
        jQuery("#search-button-query-code-section").button();
        jQuery("#clear-button-query-code-section").button();
        jQuery("#select-query-code-section").button();
        jQuery("#button-save-search-profile").button();

        jQuery( "#error-msg" ).dialog({ 
          autoOpen: false 
        });        
        
        var schemas = [];
        
        '.$schemasToLoad.'
        
        /** Exclude datasets from the QB */
        
        var excludeDatasets = []
        
        /** Define possible namespaces to use */
        var namespaces = {
          '.$namespacesToLoad.'
        };
        
        var options = {
          proxy: \''.$base_url.'/\',
          network: \''.$defaultEndpoint->uri.'\',
          schemas: schemas,
          exclude_datasets: excludeDatasets,
          namespaces: namespaces,
          project_path: \''.$base_url . "/" . drupal_get_path("module", "osf_querybuilder").'\'
        };
                              
        var qb = new QueryBuilder(options);

        /* Initialize the Search button */
        jQuery(\'#search-button-top\').click(function() {
          qb.search();
        })                                                                                       
        
        jQuery(\'#search-button-adv-section\').click(function() {
          qb.search();
        })                                                                                       
        
        jQuery(\'#search-button-restriction-section\').click(function() {
          qb.search();
        })                                                                                       
        
        jQuery(\'#search-button-score-section\').click(function() {
          qb.search();
        })                                                                                       
        
        jQuery(\'#search-button-query-code-section\').click(function() {
          qb.search();
        })                                                                                       
        
        jQuery(\'#search-button-phrase-section\').click(function() {
          qb.search();
        })                                                                                       
        
        jQuery(\'#search-button-other-options-section\').click(function() {
          qb.search();
        })                                       
        
        jQuery(\'#button-save-search-profile\').click(function() {
          qb.saveSearchProfile();
        })  
        
        jQuery(\'.nb-record-per-page\').hide();              
      });
      
      // http://stackoverflow.com/questions/985272/jquery-selecting-text-in-an-element-akin-to-highlighting-with-your-mouse
      function selectQuery(element) {
          var doc = document
              , text = doc.getElementById(element)
              , range, selection
          ;    
          if (doc.body.createTextRange) { //ms
              range = doc.body.createTextRange();
              range.moveToElementText(text);
              range.select();
          } else if (window.getSelection) { //all others
              selection = window.getSelection();        
              range = doc.createRange();
              range.selectNodeContents(text);
              selection.removeAllRanges();
              selection.addRange(range);
          }
      }      
    </script>';  
  
  
  $html .= '  </head>
              <body>';

  

 $html .= '       
    <table id="search-tools">
      <tr>
        <td id="search-tools-td-1">
          <input type="text" id="search-input" style="width: 100%">
        </td>
        <td id="search-tools-td-2">
          <input type="submit" id="search-button-top" value="'.t('Search').'">
        </td>
        <td id="search-tools-td-3">
          <input type="submit" id="clear-button-top" value="'.t('Clear').'">
        </td>
        <td id="search-tools-td-4">
          <img id="inference-icon" title="Disable inference" src="'.$base_url . "/" . drupal_get_path("module", "osf_querybuilder").'/css/ui-lightness/images/cog_delete.png" />
        </td>
        <td id="search-tools-td-5">
          <button id="help-search-button">'.t('Help').'</button>
          <div id="help-search-modal"></div>
        </td>
      </tr>
    </table>
     
    <select id="datasets" multiple="multiple"></select>
    <div id="datasets-progress"></div>
     
     
    <div id="accordion">
      <h3>'.t('Advanced Search').'</h3>
      <div id="advanced-search-section">
        <button id="help-advanced-search-button">'.t('Help').'</button>
        <div id="help-advanced-search-modal"></div>
        <p>

        </p>
        <table id="advanced-search-section-bottom-buttons">
          <tr>
            <td width="50%">
              <input type="submit" id="search-button-adv-section" value="'.t('Search').'">
            </td>
            <td width="50%">
              <input type="submit" id="clear-button-adv-section" value="'.t('Clear').'">
            </td>
          </tr>
        </table>    
      </div>
      <h3>'.t('Attributes Restrictions &amp; Boosting').'</h3>
      <div id="search-restrictions-section">
        <button id="help-search-restrictions-button">'.t('Help').'</button>
        <div id="help-search-restrictions-modal"></div>
        <p>
        </p>
        <table id="search-restrictions-bottom-buttons">
          <tr>
            <td width="50%">
              <input type="submit" id="search-button-restriction-section" value="'.t('Search').'">
            </td>
            <td width="50%">
              <input type="submit" id="clear-button-restriction-section" value="'.t('Clear').'">
            </td>
          </tr>
        </table>    
      </div>
      <h3>'.t('Values Boosting').'</h3>
      <div id="score-boosting-section">
        <button id="help-score-boosting-button">'.t('Help').'</button>
        <div id="help-score-boosting-modal"></div>
        <p>
        </p>
        <table id="score-boosting-section-bottom-buttons">
          <tr>
            <td width="50%">
              <input type="submit" id="search-button-score-section" value="'.t('Search').'">
            </td>
            <td width="50%">
              <input type="submit" id="clear-button-score-section" value="'.t('Clear').'">
            </td>
          </tr>
        </table>    
      </div>
      <h3>'.t('Operator Treatment').'</h3>
      <div id="other-options-section">
        <button id="help-other-options-button">'.t('Help').'</button>
        <div id="help-other-options-modal"></div>
        <p>
        </p>
        <table id="other-options-section-bottom-buttons">
          <tr>
            <td width="50%">
              <input type="submit" id="search-button-other-options-section" value="'.t('Search').'">
            </td>
            <td width="50%">
              <input type="submit" id="clear-button-other-options-section" value="'.t('Clear').'">
            </td>
          </tr>
        </table>    
      </div>    
      <h3>'.t('Phrase Treatment').'</h3>
      <div id="phrase-boosting-section">
        <button id="help-phrase-boosting-button">'.t('Help').'</button>
        <div id="help-phrase-boosting-modal"></div>
        <p>
        </p>
        <table id="phrase-boosting-section-bottom-buttons">
          <tr>
            <td width="50%">
              <input type="submit" id="search-button-phrase-section" value="'.t('Search').'">
            </td>
            <td width="50%">
              <input type="submit" id="clear-button-phrase-section" value="'.t('Clear').'">
            </td>
          </tr>
        </table>    
      </div>    
      <h3>'.t('Search Query Code').'</h3>
      <div id="search-query-code-section">
        <button id="help-search-query-code-button">'.t('Help').'</button>
        <div id="search-query-code-modal"></div>
        <h3>'.t('OSF-WS-PHP-API Code').'</h3>
        <pre id="phpCode" class="prettyprint lang-php ui-corner-all" style="width: 100%; overflow-x: scroll;"></pre>
        <h3>'.t('Query\'s JSON Serialized Object').'</h3>
        <pre id="jsonQuery" class="prettyprint lang-js ui-corner-all" style="width: 100%; overflow-x: scroll;"></pre>
        <table id="search-query-code-bottom-buttons">
          <tr>
            <td width="50%">
              <input type="submit" id="search-button-query-code-section" value="'.t('Search').'">
            </td>
            <td width="0%">
              <input type="submit" id="clear-button-query-code-section" value="'.t('Clear').'">
            </td>
            <td width="50%">
              <input type="button" id="select-query-code-section" value="Select Query" onclick="selectQuery(\'phpCode\');">
            </td>
          </tr>
        </table>    
       </div>  
      <h3>'.t('Search Profile').'</h3>
      <div id="search-profile-section">
        <button id="help-search-profile-button">'.t('Help').'</button>
        <div id="search-profile-modal"></div>
        <span>'.t('Name of the profile').'</span><input type="text" id="search-profile-name" class="search-profile-name" /><input type="button" id="button-save-search-profile" value="'.t('Save Search Profile').'">
       </div>     
      <h3>'.t('OSF for Drupal Search Settings').'</h3>
      <div id="search-settings-section">
        <button id="help-search-settings-button">'.t('Help').'</button>
        <div id="search-settings-modal"></div>
        <h3>'.t('OSF Search API Settings').'</h3>
        <h4>'.t('Attributes Restrictions &amp; Boosting').'</h4>
        <pre id="attributesRestrictionBoostingSettings" class="prettyprint ui-corner-all" style="width: 100%; overflow-x: scroll;"></pre>
        <h4>'.t('Phrase Treatment').'</h4>
        <pre id="phraseTreatmentSettings" class="prettyprint ui-corner-all" style="width: 100%; overflow-x: scroll;"></pre>
        <h4>'.t('Value Boosting').'</h4>
        <pre id="valueBoostingSettings" class="prettyprint ui-corner-all" style="width: 100%; overflow-x: scroll;"></pre>
      </div>    
    </div> 


    <div style="height: 30px; width: 100%">
      <button id="help-results-button">'.t('Help').'</button>
      <div id="help-results-modal"></div>
    </div>
    <div id="results-progress"></div>
    <div id="paginator-canvas">
      <div id="results-indicator"></div>
      <div id="paginator"></div>
      <div class="nb-record-per-page">
        <select id="nb-record-per-page-combo">
          <option value="5" selected="selected">5</option>
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
    </div>
    <div id="results"></div>
     
    <div id="error-msg" title="'.t('Error').'">
      <p>
        
      </p>
    </div> 
     
    <div id="browser-modal"></div>    
    
    ';

  $html .= '  </body>
            </html>';
  
  die($html);
}
