<?php

/**
 * @file
 * This is a module file having register contextual plugin.
 */

/**
 * Implements hook_ctools_plugin_directory().
 *
 * @param string $module
 *   $module takes the modulename.
 * @param string $plugin
 *   $plugin takes the plugin definition.
 */
function contextual_entity_list_ctools_plugin_directory($module, $plugin) {
  if ($module == 'ctools' && !empty($plugin)) {
    return "plugins/$plugin";
  }
}


/**
 * Implements hook_menu().
 */
function contextual_entity_list_menu() {
  $items['bundles'] = array(
    'page callback' => '_contextual_entity_list_entity_bundle',
    'type' => MENU_CALLBACK,
    'access arguments' => array('access bundle call'),
  );

  return $items;
}


/**
 * Ajax callback.
 */
function _contextual_entity_list_entity_bundle() {
  $commands = array();
  $entity = $_REQUEST['entity-type'];
  $options = '';
  $entity_options = _contextual_entity_list_entity_options($entity);
  foreach ($entity_options as $key => $value) {
    $options .= '<option value="' . check_plain($key) . '">' . filter_xss_admin($value) . '</option>';
  }
  $commands[] = ajax_command_invoke('#edit-bundle', 'html', array($options));
  print ajax_render($commands);
}

/**
 * Helper function.
 */
function _contextual_entity_list_entity_options($key) {
  $entity_type_parse = entity_get_info();
  $bundles = $entity_type_parse[$key]['bundles'];
  foreach ($bundles as $bundlekey => $bundle) {
    $bundleresult[$bundlekey] = $bundle['label'];
  }
  return $bundleresult;
}

/**
 * Implements hook_permission().
 */
function contextual_entity_list_permission() {
  return array(
    'access bundle call' => array(
      'title' => t('Access bundle call for ajax request'),
    ),
  );
}
