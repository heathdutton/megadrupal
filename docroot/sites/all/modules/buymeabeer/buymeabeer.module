<?php
/**
 * @file
 * Author: Ramiro GÃ³mez - http://www.ramiro.org
 * A Drupal module that allows donations via Paypal to buy beer.
 */

define('BMAB_ANCHOR_TEXT', t('If you liked this post, buy me a beer.'));
define('BMAB_LINK_TITLE_TEXT', t('Donate a beer or two via Paypal.'));

/**
 * Implementation of hook_menu().
 */
function buymeabeer_menu() {
  $items = array();
  $items['admin/content/buymeabeer'] = array(
    'title' => 'Buy Me a Beer',
    'description' => 'Enable the node types to display the buy me a beer link,
      set the paypal e-mail and the anchor text for the link.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('buymeabeer_admin_settings'),
    'access arguments' => array('administer site configuration'),
    'type' => MENU_NORMAL_ITEM
  );
  return $items;
}

/**
 * admin settings for the buymeabeer module
 */
function buymeabeer_admin_settings() {
  $form = array();
  $form['buymeabeer'] = array(
    '#type' => 'fieldset',
    '#title' => t('Buy Me a Beer settings'),
    '#collapsible' => TRUE,
    '#collapsed' => FALSE
  );

  $form['buymeabeer']['buymeabeer_paypal_mail'] = array(
    '#type' => 'textfield',
    '#title' => t('Paypal E-mail Addrees'),
    '#default_value' => variable_get('buymeabeer_paypal_mail', ''),
    '#size' => 60,
    '#maxlength' => 60,
    '#required' => TRUE,
    '#description' => t('Enter an e-mail address that is enabled to receive paypal payments.')
  );

  $form['buymeabeer']['buymeabeer_anchor_text'] = array(
    '#type' => 'textfield',
    '#title' => t('Anchor Text'),
    '#default_value' => variable_get('buymeabeer_anchor_text', BMAB_ANCHOR_TEXT),
    '#size' => 60,
    '#maxlength' => 60,
    '#description' => t('Enter the anchor text for the link.')
  );

  $form['buymeabeer']['buymeabeer_link_title_text'] = array(
    '#type' => 'textfield',
    '#title' => t('Link Title Text'),
    '#default_value' => variable_get('buymeabeer_link_title_text', BMAB_LINK_TITLE_TEXT),
    '#size' => 60,
    '#maxlength' => 60,
    '#description' => t('Enter the title text for the link. This is what is displayed as
      a tooltip when the cursor is moved over the link. This text is also used as the paypal
      donation identifier')
  );
  $form['buymeabeer']['buymeabeer_custom_button_id'] = array(
    '#type' => 'textfield',
    '#title' => t('Custom Paypal Button ID (Eg.: ABCDEF123456)'),
    '#default_value' => variable_get('buymeabeer_custom_button_id', ''),
    '#size' => 60,
    '#maxlength' => 255,
    '#description' => t('This is not required. You can fill in the email OR the button ID. The button ID gets priority')
  );
  $form['buymeabeer']['buymeabeer_teaser_full_view'] = array(
    '#type' => 'select',
    '#title' => t('Display in teaser and/or full view'),
    '#default_value' => variable_get('buymeabeer_teaser_full_view', 0),
    '#options' => array(0 => t('Full view'), 1 => t('Teaser'), 2 => t('Teasers and full view')),
    '#description' => t('When to display the link.'),
  );

  $form['buymeabeer']['buymeabeer_node_types'] = array(
    '#type' => 'checkboxes',
    '#title' => t('Node Types'),
    '#default_value' => variable_get('buymeabeer_node_types', array()),
    '#options' => node_type_get_names(),
    '#description' => t('Enable the node types to display the link for.')
  );

  $form['buymeabeer']['buymeabeer_weight'] = array(
    '#type' => 'select',
    '#title' => t('Weight'),
    '#default_value' => variable_get('buymeabeer_weight', 20),
    '#options' => drupal_map_assoc(range(-20, 20)),
    '#description' => t('Specifies the position of the link.
      A low weight, e.g. <strong>-20</strong> will display the link above the content
      and a high weight, e.g. <strong>20</strong> below the content.')
  );
  return system_settings_form($form);
}

/**
 * Implementation of hook_nodeapi().
 */
function buymeabeer_node_view($node, $view_mode, $langcode = NULL) {
  if (in_array($node->type, variable_get('buymeabeer_node_types', array()), TRUE)) {
    $display_link = FALSE;
    switch (variable_get('buymeabeer_teaser_full_view', 0)) {
      // display in full view only
      case 0:
        if ($view_mode == 'full') {
          $display_link = TRUE;
        }
        break;
      // display in teaser only
      case 1:
        if ($view_mode == 'teaser') {
          $display_link = TRUE;
        }
        break;
      // display in full view and teaser
      case 2:
        if ($view_mode == 'full' || $view_mode == 'teaser') {
          $display_link = TRUE;
        }
        break;
    }
    if ($display_link) {
      $node->content['buymeabeer_ad'] = buymeabeer_paypal_link();
      $node->content['buymeabeer_ad']['#weight'] = variable_get('buymeabeer_weight', 20);
    }
  }
}

/**
 * create the HTML for the donation link
 *
 * @return String themed donation link
 */
function buymeabeer_paypal_link() {
  $anchor_text = variable_get('buymeabeer_anchor_text', BMAB_ANCHOR_TEXT);
  $title_text = variable_get('buymeabeer_link_title_text', BMAB_LINK_TITLE_TEXT);
  $button_id = variable_get('buymeabeer_custom_button_id', '');
  $paypal_mail = variable_get('buymeabeer_paypal_mail', '');

  $href = "https://www.paypal.com/cgi-bin/webscr";
  if (empty($button_id)) {
    $query = array(
      'cmd' => '_xclick',
      'business' => $paypal_mail,
      'item_name' => $title_text,
    );
  }
  else {
    $query = array(
      'cmd' => '_s-xclick',
      'hosted_button_id' => $button_id,
    );
  }

  $link_args = array(
    'html' => TRUE,
    'absolute' => TRUE,
    'attributes' => array(
      'class' => 'buymeabeer-link',
      'title' => $title_text,
    ),
    'query' => $query,
  );
  $link = array(
    '#theme' => 'link',
    '#text' => $title_text,
    '#path' => $href,
    '#options' => $link_args,
    '#prefix' => '<div class="buymeabeer">',
    '#suffix' => '</div>',
  );
  return $link;
}