<?php
/**
 * @file
 * Adds the javascript snippet from cXense on your pages.
 */

/**
 * Implements hook_menu().
 */
function cxense_menu() {
  $items['admin/config/system/cxense'] = array(
    'title' => 'Cxense',
    'description' => t('Configuration for your cXense account.'),
    'file' => 'cxense.admin.inc',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('cxense_admin'),
    'access arguments' => array('administer site configuration'),
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * Implements hook_page_alter().
 *
 * Inserts JavaScript to the appropriate scope/region of the page.
 */
function cxense_page_alter(&$page) {
  $script_conf = "
    document.write('<div id=\"cX-root\" style=\"display:none\"></div>');
    var cX = cX || {}; cX.callQueue = cX.callQueue || [];
    cX.callQueue.push(['setSiteId', '" . variable_get('cxense_site_id') . "']);
    cX.callQueue.push(['sendPageViewEvent']);
  ";
  $script_code = "
    (function() { try { var scriptEl = document.createElement('script'); scriptEl.type = 'text/javascript'; scriptEl.async = 'async';
    scriptEl.src = ('https:' == document.location.protocol) ? 'https://scdn.cxense.com/cx.js' : 'http://cdn.cxense.com/cx.js';
    var targetEl = document.getElementsByTagName('script')[0]; targetEl.parentNode.insertBefore(scriptEl, targetEl); } catch (e) {};} ());
  ";

  drupal_add_js($script_conf, array(
    'scope' => 'footer',
    'type' => 'inline',
    'every_page' => TRUE,
    'weight' => 1,
  ));
  drupal_add_js($script_code, array(
    'scope' => 'footer',
    'type' => 'inline',
    'every_page' => TRUE,
    'weight' => 2,
  ));
}
