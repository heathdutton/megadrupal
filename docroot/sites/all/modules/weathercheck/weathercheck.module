<?php
/**
 * @file
 * Weather Check Module.
 */

/**
 * Implements hook_help().
 */
function weathercheck_help($path, $arg) {
  $output = '';
  switch ($path) {
    case 'admin/help#weathercheck':
      $output = t('Weather Check is a simple module that lets the user to create a block to display the weather condition at a particular location.');
  }
  return $output;
}

/**
 * Implements hook_page_build().
 */
function weathercheck_page_build(&$page) {
  $my_path = drupal_get_path('module', 'weathercheck');
  $page['content']['#attached']['js'][] = array(
    'type' => 'external',
    'data' => 'https://ajax.googleapis.com/ajax/libs/angularjs/1.0.7/angular.min.js',
  );
  $page['content']['#attached']['js'][] = array(
    'type' => 'external',
    'data' => 'http://maps.google.com/maps/api/js?sensor=false',
  );
  $page['content']['#attached']['css'][] = array(
    'type' => 'file',
    'data' => $my_path . '/css/weathercheck.css',
  );
  $page['content']['#attached']['js'][] = array(
    'type' => 'file',
    'data' => $my_path . '/js/weathercheck.js',
  );
  $page['content']['#attached']['js'][] = array(
    'type' => 'file',
    'data' => $my_path . '/js/AdminMap.js',
  );
  $wc_latlong = array(
    'wc_lat' => variable_get('weathercheck_latitude', '10.8'),
    'wc_long' => variable_get('weathercheck_longitude', '78.7'),
    'wc_disp' => explode(';', variable_get('weathercheck_disp_info', '1;1;1;0;0;0;0;0;0;0;0;')),
  );
  $page['content']['#attached']['js'][] = array(
    'type' => 'setting',
    'data' => array('wc_latlong' => $wc_latlong),
  );
}

/**
 * Implements hook_block_info().
 */
function weathercheck_block_info() {
  $blocks['weather'] = array(
    'info' => t('Weather Check'),
  );
  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function weathercheck_block_view($delta = '') {
  $block = array();
  switch ($delta) {
    case 'weather':
      $block['subject'] = t('Weather Check');
      $block['content'] = array(
        '#theme' => 'weather_status',
      );
      break;
  }
  return $block;
}

/**
 * Implements hook_theme().
 */
function weathercheck_theme() {
  return array(
    'weather_status' => array(
      'template' => 'weather-status',
      'variables' => array(),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function weathercheck_menu() {
  $menu['admin/config/weathercheck'] = array(
    'title' => 'Weather Check',
    'description' => 'Weather Check tools',
    'access arguments' => array(
      'administer site configuration',
    ),
    'position' => 'right',
  );

  $menu['admin/config/weathercheck/config'] = array(
    'title' => 'Weather check configuration',
    'description' => 'Configure the weather check module',
    'page callback' => 'drupal_get_form',
    'page arguments' => array(
      'weathercheck_form',
    ),
    'type' => MENU_NORMAL_ITEM,
    'access arguments' => array(
      'administer site configuration',
    ),
  );
  return $menu;
}

/**
 * Implements hook_form().
 */
function weathercheck_form($form, &$form_state) {
  $form['weathercheck_latitude'] = array(
    '#type' => 'textfield',
    '#element_validate' => array(
      'element_validate_number',
    ),
    '#title' => t('Latitude of desired location'),
    '#required' => TRUE,
    '#default_value' => variable_get('weathercheck_latitude', '10.8'),
    '#prefix' => t("
        <div>
            <p>Enter the details of the default desired location for your weather map.</p>
        </div>
        <div id='weathercheck_AdminMap'></div>
        "),
  );
  $form['weathercheck_longitude'] = array(
    '#type' => 'textfield',
    '#element_validate' => array(
      'element_validate_number',
    ),
    '#title' => t('Longitude of desired location'),
    '#required' => TRUE,
    '#default_value' => variable_get('weathercheck_longitude', '78.7'),
  );
  $options          = array();
  $options[1]["1"]  = "City Name";
  $options[1]["2"]  = "Country Code";
  $options[1]["3"]  = "Temperature";
  $options[1]["4"]  = "Minimum temperature";
  $options[1]["5"]  = "Maximum temperature";
  $options[1]["6"]  = "Cloud Description";
  $options[1]["7"]  = "Pressure";
  $options[1]["8"]  = "Humidity";
  $options[1]["9"]  = "Visibility level";
  $options[1]["10"] = "Wind speed";
  $options[1]["11"] = "Wind degree";
  $form['weathercheck_disp_select'] = array(
    '#title' => '',
    '#type' => 'checkboxes',
    '#description' => '',
    '#options' => $options[1],
    '#prefix' => t('<hr/><br/>Select all the required details for weather forecast:'),
    '#ajax' => array(
      'callback' => 'weathercheck_form_callback',
      'wrapper' => 'update-name-value',
    ),
    '#default_value' => variable_get('weathercheck_disp_select', array(
      "1",
      "2",
      "3",
    )),
  );
  $form['weathercheck_disp_info'] = array(
    '#type' => 'hidden',
    '#default_value' => variable_get('weathercheck_disp_info'),
    '#value' => (empty($form_state['values']['weathercheck_disp_select']) ? variable_get('weathercheck_disp_info') : ((empty($form_state['values']['weathercheck_disp_select'][1]) ? '0;' : '1;') . (empty($form_state['values']['weathercheck_disp_select'][2]) ? '0;' : '1;') . (empty($form_state['values']['weathercheck_disp_select'][3]) ? '0;' : '1;') . (empty($form_state['values']['weathercheck_disp_select'][4]) ? '0;' : '1;') . (empty($form_state['values']['weathercheck_disp_select'][5]) ? '0;' : '1;') . (empty($form_state['values']['weathercheck_disp_select'][6]) ? '0;' : '1;') . (empty($form_state['values']['weathercheck_disp_select'][7]) ? '0;' : '1;') . (empty($form_state['values']['weathercheck_disp_select'][8]) ? '0;' : '1;') . (empty($form_state['values']['weathercheck_disp_select'][9]) ? '0;' : '1;') . (empty($form_state['values']['weathercheck_disp_select'][10]) ? '0;' : '1;') . (empty($form_state['values']['weathercheck_disp_select'][11]) ? '0;' : '1;'))),
    '#prefix' => "<div id='update-name-value'>",
    '#suffix' => "</div>",
  );
  return system_settings_form($form);
}

/**
 * Callback function for AJAX.
 */
function weathercheck_form_callback($form, $form_state) {
  return $form['weathercheck_disp_info'];
}
