<?php
/**
 * @file
 * Enables site-wide keyword searching.
 */

/**
 * This module holds functions useful for rooting the nodes while search.
 * It works parallel to the search,
 * Enhancing search to add user experience to get his interests
 * On the bases of keywords he provided.
 * Please contribute!
 */

/**
 * Implements hook_help().
 */
function grassroot_interests_help($path) {
  switch ($path) {
    case 'admin/help#grassroot_interests':
      return t('Welcome to Grassroots. <p>As the name
      suggests get you the common interest out of specific
      keyword.</p><p>The GI Search menu module displays the extra
      panel at the top of the search showing the common term or url you wish to focus
      when a certain "keyword" is searched. This module is not dependent
      on search but it takes the argument passed in URL to match with the
      mannually entered keywords bind them with title having a URL or
      our choice within the site or some external URL.</p>'
      );
  }
}
/**
 * Implements hook_permission().
 */
function grassroot_interests_permission() {
  return array(
    'add search keywords' => array(
      'title' => t('Add Search Keywords'),
    ),
    'edit search keywords' => array(
      'title' => t('Edit Search Keywords'),
    ),
    'delete search keywords' => array(
      'title' => t('Delete Search Keywords'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function grassroot_interests_menu() {
  // Application link.
  $items['admin/grassroot-interests'] = array(
    'title' => 'GI - Search',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('grassroot_interests_add_keywords_form'),
    'description' => 'Enter search interest',
    'access arguments' => array('add search keywords'),
  );
  // The tab1 "settings" as base tab level 1 default.
  // Should be same as above item except the type value.
  $items['admin/grassroot-interests/add-keywords'] = array(
    'title' => 'Add Keywords',
    'description' => 'Add keywords for search pages.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('grassroot_interests_add_keywords_form'),
    'access arguments' => array('add search keywords'),
    'weight' => 1,
  );
  $items['admin/grassroot-interests/add-keywords/%grassroot_interests_keywords/edit'] = array(
    'title' => 'Edit Keywords',
    'description' => 'Edit keywords for search pages.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('grassroot_interests_add_keywords_form', 3),
    'access arguments' => array('edit search keywords'),
  );
  $items['admin/grassroot-interests/keywords/%/%'] = array(
    'title' => 'Delete Keywords',
    'description' => 'Delete keywords for search pages.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('grassroot_interests_keyword_confirm_delete', 3, 4),
    'access arguments' => array('delete search keywords'),
  );

  return $items;
}

/**
 * Implements hook_ctools_plugin_directory().
 */
function grassroot_interests_ctools_plugin_directory($module, $plugin) {
  if ($module == 'ctools' && !empty($plugin)) {
    return 'plugins/' . $plugin;
  }
}

/**
 * Returns the Keyword bindings
 * @param
 *      - url_id:  the unique identifier
 * @return
 *    Associative array for url_id having following parameter
 *    - title: String, helps to set the form title
 *    - kw_title: String
 *    - root_url: String, containg url
 *    - url_id: String, unique identifier
 *    - keywords: String, Containing keywords
 */
function grassroot_interests_keywords_load($url_id = NULL) {
  $result = db_select('grassroot_interests_path_keyword', 'ms')
    ->fields("ms", array('kid', 'keyword', 'kw_title', 'root_url', 'url_id'))
    ->condition('url_id', $url_id, '=')
    ->execute()
    ->fetchAll();

  foreach ($result as $id => $data) {
    $keyword[] = $data->keyword;
  }

  $result_array = array();
  $result_array['add_nkw_link'] = l(t('ADD NEW KEYWORD'), 'admin/grassroot-interests/add-keywords', array('attributes' => array('class' => 'kw-action-link')));
  $result_array['title'] = t('Edit Keywords');
  $result_array['kw_title'] = isset($result[0]->kw_title) ? $result[0]->kw_title : "";
  $result_array['root_url'] = isset($result[0]->root_url) ? $result[0]->root_url : "";
  $result_array['url_id'] = isset($result[0]->url_id) ? $result[0]->url_id : "";
  $result_array['keyword'] = implode("\n", $keyword);
  return $result_array;
}

/**
 * Implements hook_form().
 */
function grassroot_interests_add_keywords_form($form, &$form_state, $edit = array()) {
  $edit += array(
    'title' => t('Add Keywords'),
    'kw_title' => NULL,
    'root_url' => NULL,
    'url_id' => NULL,
    'keyword' => NULL,
  );
  $form = array();
  module_load_include('inc', 'grassroot_interests', '/includes/grassroot_interests');

  // We will have many fields with the same name.
  // So we need to be able to access the form hierarchically.
  $form['#tree'] = TRUE;
  $form['description'] = array(
    '#type' => 'item',
    '#title' => t('Add keywords to speciality'),
  );

  // Add keyword link on edit page
  $form['add_nkw_link'] = array(
    '#type' => 'markup',
    '#markup' => isset($edit['add_nkw_link']) ? $edit['add_nkw_link'] : "",
  );

  // Build the number of name fieldsets indicated by $form_state['num_names'].
  $form['name'] = array(
    '#type' => 'fieldset',
    '#title' => filter_xss($edit['title']),
    '#collapsible' => TRUE,
    '#collapsed' => FALSE,
  );

  $form['name']['first'] = array(
    '#type' => 'textfield',
    // Here filter_xss() can be added as per comment in.
    // http://drupal.org/node/1689300#comment-6289182.
    '#title' => t('Title'),
    '#description' => t("Enter Title to be displayed. (Only plain text)"),
    '#size' => 20,
    '#maxlength' => 20,
    '#required' => TRUE,
    '#default_value' => $edit['kw_title'],
  );

  $form['name']['last'] = array(
    '#type' => 'textfield',
    '#title' => t('URL'),
    '#description' => t('The path for this title. This can be an internal Drupal path such as node/add or an external URL such as http://drupal.org.'),
    '#required' => TRUE,
    '#default_value' => $edit['root_url'],
  );

  $form['name']['keywords'] = array(
    '#type' => 'textarea',
    '#title' => t("Keywords"),
    '#description' => t('Enter one keyword in one line. Note: Title is automatically added as a default keyword.'),
    '#default_value' => isset($edit['keyword']) ? $edit['keyword'] : "",
  );

  $form['url_id'] = array('#type' => 'hidden', '#value' => $edit['url_id']);

  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Submit',
  );

  $form['results'] = array(
    '#type' => 'markup',
    '#title' => t('Interest List'),
    '#markup' => grassroot_interests_search_interest_list(),
  );
  return $form;
}

/**
 * Submit callback for Add Keywords Form.
 */
function grassroot_interests_add_keywords_form_submit($form, &$form_state) {
  $post_data = array();
  $keyword_arr = array();
  $unique_array = array();

  $post_data = $form_state['values'];
  $keywords = $post_data['name']['first'] . "\n" . $post_data['name']['keywords'];
  $keyword_arr = explode(PHP_EOL, $keywords);
  $unique_array = array_unique(array_map('trim', $keyword_arr));

  $url_id = $post_data['url_id'];
  if (!empty($url_id)) {
    $num_deleted = db_delete('grassroot_interests_path_keyword')->condition('url_id', $url_id)->execute();
    $operation = 'Updated';
  }
  else {
    $url_id = uniqid("ms", TRUE);
    $operation = 'Added';
  }

  $values = array();
  foreach ($unique_array as $key) {
    if (trim($key) != "") {
      $values[] = array(
        'kw_title' => filter_xss($post_data['name']['first']),
        'root_url' => filter_xss($post_data['name']['last']),
        'keyword' => filter_xss(trim($key)),
        'url_id' => $url_id,
      );
    }
  }

  $query = db_insert('grassroot_interests_path_keyword')->fields(array(
    'kw_title',
    'root_url',
    'keyword',
    'url_id',
    )
  );
  foreach ($values as $record) {
    $query->values($record);
  }
  $query->execute();

  drupal_set_message(t("Keywords @operation.", array('@operation' => $operation)), "status");
  drupal_goto("admin/grassroot-interests/add-keywords");
}

/**
 * Form builder; Builds the confirmation form for deleting a keywords.
 *
 * @param $form
 * @param $form_state
 * @param $url_id
 */
function grassroot_interests_keyword_confirm_delete($form, &$form_state, $url_id, $kw_title) {
  $kw_title = urldecode($kw_title);

  $form = array();
  $form['url_id'] = array('#type' => 'value', '#value' => $url_id);
  $form['kw_title'] = array('#type' => 'value', '#value' => $kw_title);

  return confirm_form(
    $form,
    t('Are you sure you want to delete the %title block?', array('%title' => $kw_title)),
    'admin/grassroot-interests/add-keywords',
    t('This action cannot be undone.'),
    t('Delete'),
    t('Cancel'));
}
/**
 * Process grassroot_interests_keyword_confirm_delete form submissions.
 */
function grassroot_interests_keyword_confirm_delete_submit($form, &$form_state) {
  $url_id = $form_state['values']['url_id'];
  $kw_title = $form_state['values']['kw_title'];
  $num_deleted = db_delete('grassroot_interests_path_keyword')->condition('url_id', $url_id)->execute();
  drupal_set_message(check_plain($kw_title) . " deleted successfully.");
  $form_state['redirect'] = 'admin/grassroot-interests/add-keywords';
}

/**
 * Implements hook_theme().
 */
function grassroot_interests_theme() {
  return array(
    'devel_querylog' => array(
      'variables' => array('header' => array(), 'rows' => array()),
    ),
    'devel_querylog_row' => array(
      'variables' => array('row' => array()),
    ),
  );
}
