<?php

/**
 * @file Main module file for Image Styles by Themes module.
 */

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Alter all themes' settings forms.
 *
 * @param $form
 * @param $form_state
 * @param $form_id
 */
function image_styles_by_themes_form_system_theme_settings_alter(&$form, &$form_state, $form_id) {

  if ($form['var']['#value'] !== 'theme_settings') {
    $theme_key = substr($form['var']['#value'], 6, -9);
  }

  $themes = list_themes();
  if (!empty($theme_key) && isset($themes[$theme_key])) {
    $form['image_styles_by_themes'] = array(
      '#type' => 'fieldset',
      '#title' => t('Image styles'),
    );

    $form['image_styles_by_themes']['provides_image_styles'] = array(
      '#type' => 'checkbox',
      '#title' => t('Allow this theme to declare image styles'),
      '#description' => t('Warning, once image styles are in use on the site, disabling this theme may seriously break content. You should only tick this box if you know what you are doing.'),
      '#default_value' => theme_get_setting('provides_image_styles', $theme_key),
    );

    $form['image_styles_by_themes']['alters_image_styles'] = array(
      '#type' => 'checkbox',
      '#title' => t('Allow this theme to alter image styles'),
      '#description' => t('Allows this theme the opportunity to alter the configuration of default & user defined image styles.'),
      '#default_value' => theme_get_setting('alters_image_styles', $theme_key),
    );
  }
}

/**
 * Implements hook_image_default_styles().
 */
function image_styles_by_themes_image_default_styles() {

  $styles = array();

  // Defer to the implementation found in any theme configured to provide 'em.
  foreach (list_themes() as $theme_key => $theme_info) {
    if (theme_get_setting('provides_image_styles', $theme_key)) {
      $file = dirname($theme_info->filename) . '/' . $theme_key . '.image_styles.inc';
      if (file_exists($file)) {
        include_once DRUPAL_ROOT . '/' . $file;
        $function = $theme_key . '_theme_image_default_styles';
        if (function_exists($function)) {
          $result = $function();
          if (isset($result) && is_array($result)) {
            $styles = array_merge_recursive($styles, $result);
          }
          elseif (isset($result)) {
            $styles[] = $result;
          }
        }
      }
    }
  }

  return $styles;
}

/**
 * Implements hook_image_styles_alter().
 *
 * @param $styles
 */
function image_styles_by_themes_image_styles_alter(&$styles) {

  // Defer to implementations found in any theme configured to provide 'em.
  foreach (list_themes() as $theme_key => $theme_info) {
    if (theme_get_setting('alters_image_styles', $theme_key)) {
      $file = dirname($theme_info->filename) . '/' . $theme_key . '.image_styles.inc';
      if (file_exists($file)) {
        include_once DRUPAL_ROOT . '/' . $file;
        $function = $theme_key . '_theme_image_styles_alter';
        if (function_exists($function)) {
          $function($styles);
        }
      }
    }
  }
}