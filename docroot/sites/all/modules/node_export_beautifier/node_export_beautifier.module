<?php

/**
 * @file
 * Node Export Beautifier routines.
 */

/**
 * Implements hook_node_export_encode_alter().
 */
function node_export_beautifier_node_export_encode_alter(&$code_string, $nodes, $format) {

  $result = '';
  $istr = '  ';
  // See https://github.com/ryanuber/projects/blob/master/PHP/JSON/jsonpp.php
  // We are trying to handle PHP < 5.4 compatibility.
  $json = $code_string;
  for ($p = $q = $i = 0; isset($json[$p]); $p++) {
    $json[$p] == '"' && ($p > 0 ? $json[$p - 1] : '') != '\\' && $q = !$q;
    if (!$q && strchr(" \t\n", $json[$p])) {
      continue;
    }
    if (strchr('}]', $json[$p]) && !$q && $i--) {
      strchr('{[', $json[$p - 1]) || $result .= "\n" . str_repeat($istr, $i);
    }
    $result .= $json[$p];
    if (strchr(',{[', $json[$p]) && !$q) {
      $i += strchr('{[', $json[$p]) === FALSE ? 0 : 1;
      strchr('}]', $json[$p + 1]) || $result .= "\n" . str_repeat($istr, $i);
    }
  }

  $code_string = $result;
}
