<?php

/**
 * @file
 * Integrates Vagipe's webcam chat services and adds a Terms of Service form to the user registration page.
 */

/**
 * Implementation of hook_perm().
 */
function videochat_permission() {
    return array('access videochat' => array(
            'title' => t('Access video chat')
            ));
}

/**
 * Implementation of hook_block_info()
 */
function videochat_block_info() {
    $blocks['videochat'] = array(
        'info' => t('Video chat'),
        'cache' => DRUPAL_NO_CACHE,
    );
    return $blocks;
}

function videochat_admin($delta = '') {
    $form = array();
    $form['background_color'] = array(
        '#type' => 'textfield', 
        '#title' => t('Background color'), 
        '#default_value' => variable_get('background_color', "000044"),
        '#size' => 6,
        '#maxlength' => 6,
        '#description' => t("Hex code for the backtround gradient base color.")
       );
    $form['font_color'] = array(
        '#type' => 'textfield', 
        '#title' => t('Default font color'), 
        '#default_value' => variable_get('font_color', "cccccc"),
        '#size' => 6,
        '#maxlength' => 6,
        '#description' => t("Hex code for the preselected text color.")
       );
    $form['logo_image'] = array(
        '#type' => 'textfield', 
        '#title' => t('Logo Image'), 
        '#default_value' => variable_get('logo_image', ""),
        '#size' => 60,
        '#maxlength' => 200,
        '#description' => t("Optional URL to a logo image, i.e. http://my.site.com/logo.png. Recommended width is 50 pixel.")
       );
    $form['cam_image'] = array(
        '#type' => 'textfield', 
        '#title' => t('Cam Background Image'), 
        '#default_value' => variable_get('cam_image', "http://www.camamba.com/chatConfig/camBGext.jpg"),
        '#size' => 60,
        '#maxlength' => 200,
        '#description' => t("Optional URL to an image for the cam background, i.e. http://my.site.com/bg.png. Recommended size is 320x240.")
       );
    return system_settings_form($form);
}

/**
 * Implements hook_menu().
 */
function videochat_menu() {
    $items['videochat_set_cookies/%/%'] = array(
        'page callback' => 'videochat_set_cookies_callback',
        'page arguments' => array(1, 2),
        'type' => MENU_CALLBACK,
        'access arguments' => array('access videochat'),
    );
    $items['admin/config/user-interface/videochat'] = array(
        'title' => t('Video Chat Appearance'),
        'description' => t('Configure the video chat appearance'),
        'page callback' => 'drupal_get_form',
        'page arguments' => array('videochat_admin'),
        'access arguments' => array('access administration pages'),
        'type' => MENU_NORMAL_ITEM,
    );
    return $items;
}

function videochat_set_cookies_callback($gender, $age) {
    setcookie('videochat_gender', arg(1), time() + 86400, '/');
    setcookie('videochat_age', arg(2), time() + 86400, '/');
    return '';
}

/**
 * Implements hook_block_view().
 */
function videochat_block_view($delta = '') {
    switch ($delta) {
        case 'videochat':
            if (user_access('access videochat')) {
                //drupal_add_js('http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js', 'file');
                global $user;
                $vaglang = '';
                $vagage = isset($_COOKIE['videochat_age']) ? $_COOKIE['videochat_age'] : '99';
                $vaggender = isset($_COOKIE['videochat_gender']) ? $_COOKIE['videochat_gender'] : 'male';
                
/*
 * Create the chat block
 */
                $videochatblock = "
<script language='javascript'>
function openVideochat() {
	if (document.getElementById('CMBuser')) var user = document.getElementById('CMBuser').value;
	var lang = '".$vaglang."';
	if (document.getElementById('CMBgender')) var gender = document.getElementById('CMBgender').options[document.getElementById('CMBgender').selectedIndex].value;
	if (document.getElementById('CMBage')) var age = document.getElementById('CMBage').value;

	var roomid = window.location.hostname.replace(/www./, '');

	user = user.replace(/[\<\>]/g, '');
	age = age.replace(/[\<\>]/g, '');
	gender = gender.replace(/[\<\>]/g, '');

	var form = document.createElement('form');
	form.setAttribute('method', 'post');
	form.setAttribute('action', 'http://www.camamba.com/webcam_window_v4e.php');
	form.setAttribute('target', 'CamambaExt');

	var fUser = document.createElement('input');
	fUser.setAttribute('type', 'hidden');
	fUser.setAttribute('name', 'user');
	fUser.setAttribute('value', user);
	form.appendChild(fUser);

	var fLang = document.createElement('input');
	fLang.setAttribute('type', 'hidden');
	fLang.setAttribute('name', 'lang');
	fLang.setAttribute('value', lang);
	form.appendChild(fLang);

	var fAge = document.createElement('input');
	fAge.setAttribute('type', 'hidden');
	fAge.setAttribute('name', 'setage');
	fAge.setAttribute('value', age);
	form.appendChild(fAge);

	var fGender = document.createElement('input');
	fGender.setAttribute('type', 'hidden');
	fGender.setAttribute('name', 'setgender');
	fGender.setAttribute('value', gender);
	form.appendChild(fGender);

	var fRoom = document.createElement('input');
	fRoom.setAttribute('type', 'hidden');
	fRoom.setAttribute('name', 'setroom');
	fRoom.setAttribute('value', roomid);
	form.appendChild(fRoom);

        var fBgColor = document.createElement('input');
        fBgColor.setAttribute('type', 'hidden');
        fBgColor.setAttribute('name', 'themeBackground');
        fBgColor.setAttribute('value', '".variable_get('background_color', "000044")."');
        form.appendChild(fBgColor);

        var fFontColor = document.createElement('input');
        fFontColor.setAttribute('type', 'hidden');
        fFontColor.setAttribute('name', 'fontColor');
        fFontColor.setAttribute('value', '".variable_get('font_color', "cccccc")."');
        form.appendChild(fFontColor);
";
                if (variable_get('cam_image', ""))
                    $videochatblock .= "
        var fCam = document.createElement('input');
        fCam.setAttribute('type', 'hidden');
        fCam.setAttribute('name', 'camImage');
        fCam.setAttribute('value', '".variable_get('cam_image', "http://www.camamba.com/chatConfig/camBGext.jpg")."');
        form.appendChild(fCam);
";
                if (variable_get('logo_image', ""))
                    $videochatblock .= "
        var fLogo = document.createElement('input');
        fLogo.setAttribute('type', 'hidden');
        fLogo.setAttribute('name', 'logoImage');
        fLogo.setAttribute('value', '".variable_get('logo_image', "")."');
        form.appendChild(fLogo);
";
                if (user_access('administer'))
                    $videochatblock .= "
        var fAdm = document.createElement('input');
        fAdm.setAttribute('type', 'hidden');
        fAdm.setAttribute('name', 'adm');
        fAdm.setAttribute('value', document.getElementById('CMBAdmPwd').value);
        form.appendChild(fAdm);
";
                
                $videochatblock .= "
	document.body.appendChild(form);

	var h = screen.height - 100;
	var w = screen.width - 20;
	
	if (h>800) h = 800;
	if (w>1200) w=1200;
	
	camwindow = window.open('', 'CamambaExt','resizable,width='+w+',height='+h);

	form.submit();

	camwindow.focus();
}
</script>
";
                // User name - if user is not logged in, use Guest #### name.
                if (isset($user->roles[2]))
                    $videochatblock .= "
    <input type='hidden' name='CMBuser' id='CMBuser' value='" . $user->name . "'>";
                else
                    $videochatblock .= "
    <input name='CMBuser' type='hidden' id='CMBuser' size='50' maxlength='50' value='Guest ".rand(100, 999)."'>";

                $videochatblock .= "
    <div style='text-align: center;'>
        <div class='form-item' style=' font-size: 0.8em;'>
          <select id='CMBgender' name='CMBgender' class='form-select' style='font-size: 1em;'>
            <option value='male' " . ($vaggender == 'male' ? 'selected' : '') . ">Male</option>
            <option value='female' " . ($vaggender == 'female' ? 'selected' : '') . ">Female</option>
          </select>,
          age <input type='text' id='CMBage' name='CMBage' size='2' maxlength='2' class='form-text' value='" . $vagage . "' style='font-size: 1em;'>";
					 if(user_access('administer'))
						$videochatblock .= "					 
			 <br><span style='font-size: 0.9em;'>Moderator Password:</span><br>
				<input type='password' id='CMBAdmPwd' name='CMBAdmPwd' size='20' maxlength='30' class='form-text' style='font-size: 0.9em;'>";
					$videochatblock .= "					 						 					 
        </div>
        <input onClick=javascript:openVideochat() type='button' value='Enter Video Chat' class='form-submit' style='width: 90%;'><br>";
					 if(user_access('administer'))
						$videochatblock .= "					 
        <span style='font-size: 0.8em;'>
				The moderator password is optional<br>
				<a href='http://www.camamba.com/admin_create.php'>&raquo; Set up moderator access</a><br>
		  </span>";
					 else
						$videochatblock .= "					 
        <span style='font-size: 0.8em;'><a href='http://www.camamba.com/'>Webcam chat by Camamba</a></span>";
					$videochatblock .= "					 						 
    </div>
";
                $block = array();
                $block['subject'] = t('Video chat');
                $block['content'] = $videochatblock;
                return $block;
            }
    }
}

