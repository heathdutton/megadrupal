<?php

/**
 * @file File Table Formatter module.
 */

/**
 * Implements hook_field_formatter_info().
 */
function file_table_formatter_field_formatter_info() {
  return array(
    'file_table_formatter' => array(
      'label' => t('Display file contents as table'),
      'field types' => array('file'),
      'settings'  => array(
        'header' => FALSE,
        'datatables' => FALSE,
      ),
    ),
  );
}

/**
 * Implements hook_field_formatter_settings_form().
 */
function file_table_formatter_field_formatter_settings_form($field, $instance, $view_mode, $form, &$form_state) {
  $display = $instance['display'][$view_mode];
  $settings = $display['settings'];
  $element = array();

  $element['header'] = array(
    '#type'           => 'checkbox',
    '#title'          => t('Files include a header row'),
    '#description'    => t('If checked first row will be displayed formatted as a table header'),
    '#default_value'  => $settings['header'],
  );
  if (module_exists('datatables')) {
    $element['datatables'] = array(
      '#type'           => 'checkbox',
      '#title'          => t('Use javascript sortable data tables'),
      '#description'    => t('If checked, tables will be sortable by all columns.'),
      '#default_value'  => $settings['datatables'],
    );
  }
  return $element;
}

/**
 * Implements hook_field_formatter_settings_summary().
 */
function file_table_formatter_field_formatter_settings_summary($field, $instance, $view_mode) {
  $display = $instance['display'][$view_mode];
  $settings = $display['settings'];
  $summary = t('Files include a header row: @header', array(
    '@header' => empty($settings['header']) ? t('No') : t('Yes'),
  ));
  if (module_exists('datatables')) {
    $summary .= '<br /><br />' . t('Use javascript sortable data tables: @datatables', array(
      '@datatables' => empty($settings['datatables']) ? t('No') : t('Yes'),
    ));
  }
  return $summary;
}

/**
 * Implements hook_field_formatter_view().
 */
function file_table_formatter_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  $element = array();

  $includes_header = !empty($display['settings']['header']);
  foreach ($items as $delta => $item) {
    $table_data = file_table_formatter_get_table_data_from_file($item, $includes_header);
    $table_data['title'] = !empty($item['description']) ? $item['description'] : '';

    // Add additional info that may be helpful for alter implementations.
    $table_data['item'] = $item;
    $table_data['entity'] = $entity;
    $table_data['entity_type'] = $entity_type;
    $table_data['field'] = $field;
    $table_data['display'] = $display;
    $table_data['instance'] = $instance;
    $table_data['langcode'] = $langcode;

    drupal_alter('file_table_formatter', $table_data);

    if (!empty($table_data['header']) && !empty($table_data['rows'])) {
      $element[$delta]['#markup'] = theme('file_table_formatter_table', array('data' => $table_data, 'datatables' => $display['settings']['datatables']));
    }
    else {
      $element[$delta]['#markup'] = NULL;
    }

  }
  return $element;
}

function file_table_formatter_get_table_data_from_file($file, $includes_header = FALSE) {
  if (is_array($file)) {
    $file = (object) $file;
  }

  $data = array();
  $cached_data = cache_get('file_table_formatter:' . $file->fid);

  if ($cached_data === FALSE) {
    // Currently only supports CSV files
    if ($file->filemime == 'text/csv') {

      // Read the file
      $fhandle = fopen($file->uri, 'r');
      if (!empty($fhandle)) {
        $contents = file_get_contents(drupal_realpath($file->uri));
      }
      fclose($fhandle);

      if (!empty($contents)) {
        // Parse as CSV
        $data = str_getcsv($contents, "\n");
        foreach ($data as &$row) {
          $row = str_getcsv($row);
        }
      }
    }
    cache_set('file_table_formatter:' . $file->fid, $data);
  }
  else {
    $data = $cached_data->data;
  }

  $result = array(
    'header' => NULL,
    'rows' => NULL,
  );

  if (!empty($data)) {
    // Handle header.
    if ($includes_header) {
      $result['header'] = array_shift($data);
    }
    $result['rows'] = $data;
  }

  return $result;
}

/**
 * Implements hook_theme().
 */
function file_table_formatter_theme() {
  return array(
    'file_table_formatter_table' => array(
      'variables' => array('data' => NULL, 'datatables' => FALSE),
    )
  );
}

/**
 * Theme function for the file table formatter.
 *
 * @param $variables
 * @return string
 */
function theme_file_table_formatter_table($variables) {
  $output = '';

  // Reformat arrays for theme_table;
  $header = NULL;
  if (!empty($variables['data']['header'])) {
    foreach ($variables['data']['header'] as $col) {
      $header[] = array('data' => $col);
    }
  }

  $rows = array();
  if (!empty($variables['data']['rows'])) {
    foreach ($variables['data']['rows'] as $col) {
      $rows[] = array('data' => $col);
    }
  }

  if (!empty($rows) || !empty($header)) {
    if (!empty($variables['data']['title'])) {
      $output .= '<h2 class="file-table-title">' . check_plain($variables['data']['title']) . '</h2>';
    }
    if (!empty($variables['datatables']) && module_exists('datatables')) {
      $datatable_options = array(
        'bFilter' => FALSE,  // Disable filtering of data.
        'bInfo' => FALSE, // Disable table info.
        'aaSorting' => array(),  // Disable default sort.
        'bPaginate' => FALSE, // Disable pagination.
      );
      $output .= theme('datatable', array('header' => $header, 'rows' => $rows, 'attributes' => array('datatable_options' => $datatable_options)));
    }
    else {
      $output .= theme('table', array('header' => $header, 'rows' => $rows));
    }
  }

  return $output;
}
